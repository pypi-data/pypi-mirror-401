<!DOCTYPE html>
<html>
<head>
  <title>CAT: Create Annotation Project</title>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1.0">
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(180deg, #0a2540 0%, #0d3a5f 30%, #10446e 60%, #134e7d 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .navbar {
      position: absolute;
      top: 10px;
      left: 10px;
      right: 10px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 2000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar h1 {
      margin: 0;
      font-size: 18px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-links a {
      color: #667eea;
      text-decoration: none;
      margin-left: 20px;
      font-weight: 500;
      transition: color 0.3s;
    }
    .nav-links a:hover {
      color: #5568d3;
    }
    
    .content {
      padding: 30px;
    }
    
    /* Mode Selection */
    .mode-selection {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    .mode-card {
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
    }
    .mode-card:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    .mode-card.active {
      border-color: #667eea;
      background: #e9ecef;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .mode-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    /* Creator Section */
    .creator-section {
      display: none;
      animation: fadeIn 0.3s;
    }
    .creator-section.active {
      display: block;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Drop Zones */
    .drop-zone {
      border: 3px dashed #667eea;
      border-radius: 8px;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 20px;
      background: #f8f9fa;
    }
    .drop-zone:hover {
      background: #e9ecef;
      border-color: #5568d3;
    }
    .drop-zone.drag-over {
      background: #d1ecf1;
      border-color: #0c5460;
      transform: scale(1.02);
    }
    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: 10px;
    }
    
    /* File List */
    .file-list {
      margin: 20px 0;
    }
    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #667eea;
    }
    .file-info {
      flex: 1;
    }
    .file-name {
      font-weight: 600;
      color: #333;
      margin-bottom: 4px;
    }
    .file-path {
      font-size: 11px;
      color: #666;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }
    .file-type {
      display: inline-block;
      padding: 2px 8px;
      background: #667eea;
      color: white;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      margin-right: 10px;
    }
    .remove-btn {
      padding: 6px 12px;
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .remove-btn:hover {
      background: #c82333;
    }
    
    /* Form */
    .form-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
    }
    .form-section h3 {
      margin-top: 0;
      color: #667eea;
    }
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    .form-group label {
      margin-bottom: 5px;
      font-size: 12px;
      font-weight: 600;
      color: #555;
      text-transform: uppercase;
    }
    .form-group input,
    .form-group select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
    }
    .btn-primary {
      background: #667eea;
      color: white;
    }
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    .btn-success {
      background: #28a745;
      color: white;
    }
    .btn-success:hover {
      background: #218838;
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    /* Status */
    .status {
      padding: 15px;
      border-radius: 6px;
      margin: 20px 0;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    
    /* Preview */
    .preview-section {
      background: #2c2c2c;
      color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    .preview-section pre {
      margin: 0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }
    
    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #eee;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1>
      <span>ü™∏</span>
      <span>CAT: Project Creator</span>
    </h1>
    <div class="nav-links">
      <a href="/annotation_file_mode.html">Annotation Tool</a>
      <a href="/">Home</a>
    </div>
  </nav>
  
  <div class="container" style="margin-top: 70px;">
    <div class="content">
      <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="font-size: 32px; color: #333; margin-bottom: 10px;">üìÅ Create Annotation Project</h1>
        <p style="color: #666; font-size: 16px;">Build file-based coral annotation projects from your TIF files</p>
      </div>
      
      <!-- Mode Selection -->
      <div class="mode-selection">
        <div class="mode-card active" id="createMode" onclick="selectMode('create')">
          <div class="mode-icon">‚ú®</div>
          <h3>Create New Project</h3>
          <p>Drag & drop TIF files to create a new annotation project</p>
        </div>
        <div class="mode-card" id="loadMode" onclick="selectMode('load')">
          <div class="mode-icon">üìÇ</div>
          <h3>Load Existing Project</h3>
          <p>Upload an existing project.json to edit or continue</p>
        </div>
      </div>
      
      <!-- Create Mode -->
      <div id="createSection" class="creator-section active">
        <h2>üé® Build Your Project</h2>
        
        <!-- Base Path Input -->
        <div class="form-section" style="margin-bottom:20px;">
          <h3>üìÇ Set Base Folder Path</h3>
          <p style="font-size:13px; color:#666; margin-bottom:10px;">
            Enter the folder path where your TIF and shapefile files are located. File paths will be auto-completed using this base path.
          </p>
          <div style="display:flex; gap:10px; align-items:center;">
            <input type="text" 
                   id="basePath" 
                   placeholder="e.g., C:\Sites\2025\SE2503_MARI\GUA\GUA-2838\Products"
                   style="flex:1; padding:12px; border:2px solid #667eea; border-radius:6px; font-family:monospace; font-size:12px;">
            <button class="btn btn-primary" onclick="applyBasePath()" style="white-space:nowrap;">
              ‚úì Apply to All Files
            </button>
          </div>
        </div>
        
        <!-- TIF Files Drop Zone -->
        <div class="drop-zone" id="tifDropZone">
          <div class="drop-zone-icon">üó∫Ô∏è</div>
          <h3>Drop TIF Files Here</h3>
          <p>Orthomosaics, DEMs, or any GeoTIFF files</p>
          <input type="file" id="tifInput" accept=".tif,.tiff" multiple style="display:none;">
        </div>
        
        <div id="tifList" class="file-list"></div>
        
        <!-- Shapefile Drop Zone -->
        <div class="drop-zone" id="shapefileDropZone">
          <div class="drop-zone-icon">üìê</div>
          <h3>Drop Shapefiles (.shp) Here (Optional)</h3>
          <p>Site boundaries, transects, or other vector data</p>
          <input type="file" id="shapefileInput" accept=".shp,.shx,.dbf,.prj,.cpg" multiple style="display:none;">
        </div>
        
        <div id="shapefileList" class="file-list"></div>
        
        <!-- Annotations Import Zone -->
        <div class="drop-zone" id="annotationsDropZone">
          <div class="drop-zone-icon">üè∑Ô∏è</div>
          <h3>Import Existing Annotations (Optional)</h3>
          <p>Drop shapefile components (.shp, .shx, .dbf, .prj)</p>
          <input type="file" id="annotationsInput" accept=".json,.shp,.shx,.dbf,.prj,.cpg,.xml" multiple style="display:none;">
        </div>
        
        <div id="annotationsList" class="file-list"></div>
        
        <!-- Shapefile Import Mapping (Hidden until shapefile is loaded) -->
        <div id="shapefileMappingSection" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
          <h3 style="margin-top: 0; color: #667eea;">üìä Map Shapefile Columns</h3>
          <p style="font-size: 13px; color: #666; margin-bottom: 15px;">
            Match your shapefile columns to annotation fields. Required fields are marked with *.
          </p>
          
          <div style="background: #fffbeb; padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #f59e0b;">
            <button class="btn btn-primary" onclick="autoMapShapefileColumns()" style="padding: 6px 12px; font-size: 12px; margin-bottom: 8px;">
              ‚ö° Auto-Map Matching Columns
            </button>
            <p style="margin: 0; font-size: 12px; color: #92400e;">
              <strong>‚ÑπÔ∏è Tip:</strong> Unmapped fields will be left empty or use default values.
            </p>
          </div>
          
          <div id="shapefileMappingTable" style="margin-bottom: 15px; max-height: 300px; overflow-y: auto;">
            <!-- Dynamically populated -->
          </div>
          
          <div style="background: #f8f9fa; padding: 15px; border-radius: 6px; margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0; font-size: 14px;">Preview (First 5 Features)</h4>
            <div id="shapefilePreviewTable" style="overflow-x: auto; font-size: 12px;">
              <!-- Preview table -->
            </div>
          </div>
        </div>
        
        <!-- Project Metadata Form -->
        <div class="form-section">
          <h3>üìù Project Information</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>Project Name *</label>
              <input type="text" id="projectName" placeholder="e.g., GUA-2838 Coral Survey">
            </div>
            <div class="form-group">
              <label>Site Code *</label>
              <input type="text" id="siteCode" placeholder="e.g., GUA-2838">
            </div>
            <div class="form-group">
              <label>Cruise ID</label>
              <input type="text" id="cruiseId" placeholder="e.g., SE2503_MARI">
            </div>
            <div class="form-group">
              <label>Year</label>
              <input type="number" id="year" value="2025">
            </div>
            <div class="form-group">
              <label>Region</label>
              <input type="text" id="region" placeholder="e.g., GUA">
            </div>
            <div class="form-group">
              <label>Observer</label>
              <input type="text" id="observer" placeholder="Your name">
            </div>
          </div>
          <div class="form-group" style="margin-top:15px;">
            <label>Notes</label>
            <input type="text" id="notes" placeholder="Optional project notes">
          </div>
        </div>
        
        <div id="createStatus" class="status"></div>
        
        <!-- Preview Section -->
        <div id="previewSection" style="display:none;">
          <h3>üìÑ Project JSON Preview</h3>
          
          <!-- COG Status Info -->
          <div id="cogStatusInfo" style="margin-bottom: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
            <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 14px;">üîß COG File Status</h4>
            <div id="cogStatusDetails" style="font-size: 13px; color: #1e3a8a;"></div>
          </div>
          
          <div class="preview-section">
            <pre id="jsonPreview"></pre>
          </div>
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-primary" onclick="generatePreview()">üëÅÔ∏è Preview JSON</button>
          <button class="btn btn-success" onclick="saveProject()">üíæ Save Project File</button>
          <button class="btn btn-success" onclick="saveAndOpen()">üöÄ Save & Open in Viewer</button>
        </div>
      </div>
      
      <!-- Load Mode -->
      <div id="loadSection" class="creator-section">
        <h2>üìÇ Load Existing Project</h2>
        
        <div class="drop-zone" id="loadDropZone">
          <div class="drop-zone-icon">üìÑ</div>
          <h3>Drop project.json Here</h3>
          <p>Or click to browse</p>
          <input type="file" id="loadInput" accept=".json" style="display:none;">
        </div>
        
        <div id="loadStatus" class="status"></div>
        
        <div id="loadedPreview" style="display:none;">
          <h3>üìÑ Loaded Project</h3>
          <div class="preview-section">
            <pre id="loadedJsonPreview"></pre>
          </div>
          
          <div class="action-buttons">
            <button class="btn btn-primary" onclick="editLoadedProject()">‚úèÔ∏è Edit Project</button>
            <button class="btn btn-success" onclick="openInViewer()">üöÄ Open in Viewer</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // ========================================
    // STATE
    // ========================================
    let currentMode = 'create';
    let tifFiles = [];
    let shapefiles = [];
    let loadedProject = null;
    let importedAnnotations = null;
    let annotationsFileName = '';
    let shapefileImportData = null;
    let shapefileColumnMapping = {};
    
    // ========================================
    // MODE SELECTION
    // ========================================
    function selectMode(mode) {
      currentMode = mode;
      
      // Update cards
      document.getElementById('createMode').classList.toggle('active', mode === 'create');
      document.getElementById('loadMode').classList.toggle('active', mode === 'load');
      
      // Show/hide sections
      document.getElementById('createSection').classList.toggle('active', mode === 'create');
      document.getElementById('loadSection').classList.toggle('active', mode === 'load');
    }
    
    // ========================================
    // DROP ZONE SETUP
    // ========================================
    function setupDropZone(zoneId, inputId, callback) {
      const zone = document.getElementById(zoneId);
      const input = document.getElementById(inputId);
      
      zone.addEventListener('click', () => input.click());
      
      input.addEventListener('change', (e) => {
        callback(Array.from(e.target.files));
      });
      
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('drag-over');
      });
      
      zone.addEventListener('dragleave', () => {
        zone.classList.remove('drag-over');
      });
      
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('drag-over');
        callback(Array.from(e.dataTransfer.files));
      });
    }
    
    // Initialize drop zones
    document.addEventListener('DOMContentLoaded', () => {
      setupDropZone('tifDropZone', 'tifInput', addTifFiles);
      setupDropZone('shapefileDropZone', 'shapefileInput', addShapefiles);
      setupDropZone('annotationsDropZone', 'annotationsInput', loadAnnotationsFile);
      setupDropZone('loadDropZone', 'loadInput', loadProjectFile);
    });
    
    // ========================================
    // FILE MANAGEMENT
    // ========================================
    function addTifFiles(files) {
      const basePath = document.getElementById('basePath').value.trim();
      
      files.forEach(file => {
        if (file.name.match(/\.(tif|tiff)$/i)) {
          // Auto-complete path if base path is set
          let fullPath;
          if (basePath) {
            // Ensure base path ends with backslash
            const normalizedBase = basePath.endsWith('\\') ? basePath : basePath + '\\';
            fullPath = normalizedBase + file.name;
          } else {
            fullPath = file.path || `C:\\path\\to\\${file.name}`;
          }
          
          tifFiles.push({
            id: `tif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            name: file.name.replace(/\.(tif|tiff)$/i, ''),
            file: file,
            path: fullPath,
            type: file.name.toLowerCase().includes('dem') ? 'DEM' : 'Orthomosaic'
          });
        }
      });
      renderTifList();
    }
    
    function applyBasePath() {
      const basePath = document.getElementById('basePath').value.trim();
      
      if (!basePath) {
        alert('Please enter a base folder path first.');
        return;
      }
      
      // Normalize base path
      const normalizedBase = basePath.endsWith('\\') ? basePath : basePath + '\\';
      
      // Update all TIF paths
      tifFiles.forEach(tif => {
        tif.path = normalizedBase + tif.name + '.tif';
      });
      
      // Update all shapefile paths
      shapefiles.forEach(shp => {
        shp.path = normalizedBase + shp.name + '.shp';
      });
      
      renderTifList();
      renderShapefileList();
      
      alert(`‚úÖ Applied base path to ${tifFiles.length} TIF(s) and ${shapefiles.length} shapefile(s)`);
    }
    
    function addShapefiles(files) {
      const basePath = document.getElementById('basePath').value.trim();
      
      // Group shapefiles by base name
      const groups = {};
      files.forEach(file => {
        if (file.name.match(/\.(shp|shx|dbf|prj|cpg|sbn|sbx)$/i)) {
          const baseName = file.name.replace(/\.(shp|shx|dbf|prj|cpg|sbn|sbx)$/i, '');
          if (!groups[baseName]) {
            // Auto-complete path if base path is set
            let fullPath;
            if (basePath) {
              const normalizedBase = basePath.endsWith('\\') ? basePath : basePath + '\\';
              fullPath = normalizedBase + baseName + '.shp';
            } else {
              fullPath = file.path || `C:\\path\\to\\${baseName}.shp`;
            }
            
            groups[baseName] = {
              id: `shp_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
              name: baseName,
              files: [],
              path: fullPath
            };
          }
          groups[baseName].files.push(file);
        }
      });
      
      Object.values(groups).forEach(group => {
        // Only add if we have at least .shp file
        if (group.files.some(f => f.name.endsWith('.shp'))) {
          shapefiles.push(group);
        }
      });
      
      renderShapefileList();
    }
    
    function renderTifList() {
      const container = document.getElementById('tifList');
      if (tifFiles.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = tifFiles.map((tif, index) => `
        <div class="file-item">
          <div class="file-info">
            <span class="file-type">${tif.type}</span>
            <div class="file-name">${tif.name}</div>
            <input type="text" 
                   value="${tif.path}" 
                   onchange="updateTifPath(${index}, this.value)"
                   placeholder="Enter full path: C:\\Users\\...\\${tif.name}.tif"
                   style="width:100%; padding:4px; font-size:11px; font-family:monospace; margin-top:4px; border:1px solid #ddd; border-radius:3px;">
          </div>
          <button class="remove-btn" onclick="removeTif(${index})">‚ùå Remove</button>
        </div>
      `).join('');
    }
    
    function updateTifPath(index, newPath) {
      tifFiles[index].path = newPath;
    }
    
    function renderShapefileList() {
      const container = document.getElementById('shapefileList');
      if (shapefiles.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      container.innerHTML = shapefiles.map((shp, index) => `
        <div class="file-item">
          <div class="file-info">
            <span class="file-type">SHP</span>
            <div class="file-name">${shp.name} (${shp.files.length} files)</div>
            <input type="text" 
                   value="${shp.path}" 
                   onchange="updateShapefilePath(${index}, this.value)"
                   placeholder="Enter full path: C:\\Users\\...\\${shp.name}.shp"
                   style="width:100%; padding:4px; font-size:11px; font-family:monospace; margin-top:4px; border:1px solid #ddd; border-radius:3px;">
          </div>
          <button class="remove-btn" onclick="removeShapefile(${index})">‚ùå Remove</button>
        </div>
      `).join('');
    }
    
    function updateShapefilePath(index, newPath) {
      shapefiles[index].path = newPath;
    }
    
    function removeTif(index) {
      tifFiles.splice(index, 1);
      renderTifList();
    }
    
    function removeShapefile(index) {
      shapefiles.splice(index, 1);
      renderShapefileList();
    }
    
    // ========================================
    // ANNOTATIONS IMPORT
    // ========================================
    function loadAnnotationsFile(files) {
      if (files.length === 0) return;
      
      const fileArray = Array.from(files);
      
      // Check if JSON file
      const jsonFile = fileArray.find(f => f.name.toLowerCase().endsWith('.json'));
      if (jsonFile) {
        loadJSONAnnotations(jsonFile);
        return;
      }
      
      // Check if shapefile components
      const shpFile = fileArray.find(f => f.name.toLowerCase().endsWith('.shp'));
      if (shpFile) {
        loadShapefileAnnotations(fileArray);
        return;
      }
      
      showStatus('createStatus', 'error', '‚ùå Please upload a JSON file or shapefile components (.shp required)');
    }
    
    function loadJSONAnnotations(file) {
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          const data = JSON.parse(e.target.result);
          
          // Validate it's an annotations array
          if (!Array.isArray(data)) {
            showStatus('createStatus', 'error', '‚ùå Invalid format: Expected a JSON array of annotations');
            return;
          }
          
          importedAnnotations = data;
          annotationsFileName = file.name;
          shapefileImportData = null;
          
          // Hide shapefile mapping section
          document.getElementById('shapefileMappingSection').style.display = 'none';
          
          renderAnnotationsList();
          showStatus('createStatus', 'success', `‚úÖ Imported ${data.length} annotation(s) from ${file.name}`);
          
        } catch (error) {
          showStatus('createStatus', 'error', `‚ùå Invalid JSON file: ${error.message}`);
        }
      };
      
      reader.readAsText(file);
    }
    
    async function loadShapefileAnnotations(files) {
      const formData = new FormData();
      
      // Add all shapefile components to FormData
      const shpFile = files.find(f => f.name.toLowerCase().endsWith('.shp'));
      const shxFile = files.find(f => f.name.toLowerCase().endsWith('.shx'));
      const dbfFile = files.find(f => f.name.toLowerCase().endsWith('.dbf'));
      const prjFile = files.find(f => f.name.toLowerCase().endsWith('.prj'));
      const cpgFile = files.find(f => f.name.toLowerCase().endsWith('.cpg'));
      const xmlFile = files.find(f => f.name.toLowerCase().endsWith('.xml'));
      
      if (!shpFile) {
        showStatus('createStatus', 'error', '‚ùå No .shp file found. Please include the .shp file.');
        return;
      }
      
      // Append files to FormData
      formData.append('shp_file', shpFile);
      if (shxFile) formData.append('shx_file', shxFile);
      if (dbfFile) formData.append('dbf_file', dbfFile);
      if (prjFile) formData.append('prj_file', prjFile);
      if (cpgFile) formData.append('cpg_file', cpgFile);
      if (xmlFile) formData.append('xml_file', xmlFile);
      
      try {
        showStatus('createStatus', 'info', 'üì¶ Analyzing shapefile...');
        
        const response = await fetch('http://localhost:8000/api/annotations/import/preview-components', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
        
        shapefileImportData = await response.json();
        shapefileImportData.files = files; // Store the file array
        annotationsFileName = shpFile.name;
        importedAnnotations = null;
        
        // Auto-fill project metadata from shapefile preview data
        if (shapefileImportData.sample_features && shapefileImportData.sample_features.length > 0) {
          const firstFeature = shapefileImportData.sample_features[0];
          autoFillProjectMetadataFromShapefilePreview(firstFeature.properties);
        }
        
        // Show mapping section
        document.getElementById('shapefileMappingSection').style.display = 'block';
        populateShapefileMappingTable();
        populateShapefilePreviewTable();
        
        renderAnnotationsList();
        showStatus('createStatus', 'success', `‚úÖ Loaded shapefile with ${shapefileImportData.total_features} feature(s). Map columns below.`);
        
        // Scroll to mapping section
        document.getElementById('shapefileMappingSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        
      } catch (error) {
        console.error('Error loading shapefile:', error);
        showStatus('createStatus', 'error', `‚ùå Error analyzing shapefile: ${error.message}`);
      }
    }
    
    function renderAnnotationsList() {
      const container = document.getElementById('annotationsList');
      
      if (!importedAnnotations && !shapefileImportData) {
        container.innerHTML = '';
        return;
      }
      
      if (importedAnnotations) {
        // JSON import
        container.innerHTML = `
          <div class="file-item">
            <div class="file-info">
              <span class="file-type">JSON</span>
              <div class="file-name">${annotationsFileName}</div>
              <div class="file-path">${importedAnnotations.length} annotation(s) ready to import</div>
            </div>
            <button class="remove-btn" onclick="removeAnnotations()">‚ùå Remove</button>
          </div>
        `;
      } else if (shapefileImportData) {
        // Shapefile import - show which files were uploaded
        const fileExtensions = shapefileImportData.files.map(f => {
          const ext = f.name.split('.').pop().toUpperCase();
          return `<span style="display: inline-block; padding: 2px 6px; background: #667eea; color: white; border-radius: 3px; font-size: 10px; margin-right: 4px;">.${ext}</span>`;
        }).join('');
        
        container.innerHTML = `
          <div class="file-item">
            <div class="file-info">
              <span class="file-type">SHP</span>
              <div class="file-name">${annotationsFileName}</div>
              <div class="file-path">${shapefileImportData.total_features} feature(s) - Column mapping required</div>
              <div style="margin-top: 6px;">${fileExtensions}</div>
            </div>
            <button class="remove-btn" onclick="removeAnnotations()">‚ùå Remove</button>
          </div>
        `;
      }
    }
    
    function removeAnnotations() {
      importedAnnotations = null;
      shapefileImportData = null;
      annotationsFileName = '';
      shapefileColumnMapping = {};
      document.getElementById('shapefileMappingSection').style.display = 'none';
      renderAnnotationsList();
    }
    
    // Shapefile column mapping functions
    function populateShapefileMappingTable() {
      const container = document.getElementById('shapefileMappingTable');
      if (!shapefileImportData) return;
      
      const shpColumns = shapefileImportData.shapefile_columns;
      const annFields = shapefileImportData.annotation_fields;
      
      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 13px;">';
      html += '<thead><tr style="background: #f8f9fa;">';
      html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Shapefile Column</th>';
      html += '<th style="padding: 8px; text-align: center; border-bottom: 2px solid #ddd;">‚Üí</th>';
      html += '<th style="padding: 8px; text-align: left; border-bottom: 2px solid #ddd;">Annotation Field</th>';
      html += '</tr></thead><tbody>';
      
      shpColumns.forEach((col, idx) => {
        html += '<tr style="border-bottom: 1px solid #e0e0e0;">';
        html += `<td style="padding: 8px;"><strong>${col.name}</strong> <span style="color: #666; font-size: 11px;">(${col.type})</span></td>`;
        html += '<td style="padding: 8px; text-align: center;">‚Üí</td>';
        html += `<td style="padding: 8px;">`;
        html += `<select id="shpMapping_${idx}" class="shp-mapping-select" onchange="updateShapefileMapping()" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">`;
        html += '<option value="">-- Skip Column --</option>';
        
        annFields.forEach(field => {
          const requiredMark = field.required ? ' *' : '';
          html += `<option value="${field.name}">${field.name}${requiredMark} - ${field.description}</option>`;
        });
        
        html += '</select></td></tr>';
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // Initialize mapping
      updateShapefileMapping();
    }
    
    function updateShapefileMapping() {
      if (!shapefileImportData) return;
      
      const shpColumns = shapefileImportData.shapefile_columns;
      shapefileColumnMapping = {};
      
      shpColumns.forEach((col, idx) => {
        const select = document.getElementById(`shpMapping_${idx}`);
        if (select && select.value) {
          shapefileColumnMapping[col.name] = select.value;
        }
      });
      
      console.log('Updated shapefile column mapping:', shapefileColumnMapping);
    }
    
    function autoMapShapefileColumns() {
      if (!shapefileImportData) return;
      
      const shpColumns = shapefileImportData.shapefile_columns;
      const annFields = shapefileImportData.annotation_fields;
      let mappedCount = 0;
      
      shpColumns.forEach((col, idx) => {
        const select = document.getElementById(`shpMapping_${idx}`);
        if (!select) return;
        
        const colNameUpper = col.name.toUpperCase();
        
        // Try to find exact or close match
        for (const field of annFields) {
          const fieldNameUpper = field.name.toUpperCase();
          
          if (colNameUpper === fieldNameUpper || 
              colNameUpper === fieldNameUpper.replace('_', '') ||
              colNameUpper.replace('_', '') === fieldNameUpper ||
              (colNameUpper === 'OLD_DEAD' && fieldNameUpper === 'OLDDEAD') ||
              (colNameUpper === 'SHAPE_LENG' && fieldNameUpper === 'SHAPE_LENGTH') ||
              (colNameUpper === 'SPECIES' && fieldNameUpper === 'SPECIES_CODE') ||
              (colNameUpper === 'CODE' && fieldNameUpper === 'SPECIES_CODE')) {
            select.value = field.name;
            mappedCount++;
            break;
          }
        }
      });
      
      updateShapefileMapping();
      showStatus('createStatus', 'success', `‚ö° Auto-mapped ${mappedCount} columns`);
    }
    
    function autoFillProjectMetadataFromAnnotations(annotations) {
      if (!annotations || annotations.length === 0) return;
      
      // Get first annotation's properties
      const firstAnn = annotations[0].properties || annotations[0];
      
      console.log('üîÑ Auto-filling project metadata from annotations...');
      
      // Site -> Project Name and Site Code
      if (firstAnn.site) {
        const siteName = firstAnn.site.toString().trim();
        const projectNameField = document.getElementById('projectName');
        const siteCodeField = document.getElementById('siteCode');
        
        if (projectNameField && !projectNameField.value) {
          projectNameField.value = `${siteName} Coral Survey`;
          markFieldAsAutofilled(projectNameField);
          console.log('  ‚úì Project Name:', projectNameField.value);
        }
        
        if (siteCodeField && !siteCodeField.value) {
          siteCodeField.value = siteName;
          markFieldAsAutofilled(siteCodeField);
          console.log('  ‚úì Site Code:', siteCodeField.value);
        }
        
        // Region -> First 3 characters of site name
        const regionField = document.getElementById('region');
        if (regionField && !regionField.value && siteName.length >= 3) {
          regionField.value = siteName.substring(0, 3).toUpperCase();
          markFieldAsAutofilled(regionField);
          console.log('  ‚úì Region:', regionField.value);
        }
      }
      
      // Mission ID -> Cruise ID
      if (firstAnn.mission_id) {
        const cruiseField = document.getElementById('cruiseId');
        if (cruiseField && !cruiseField.value) {
          cruiseField.value = firstAnn.mission_id.toString().trim();
          markFieldAsAutofilled(cruiseField);
          console.log('  ‚úì Cruise ID:', cruiseField.value);
        }
      }
      
      // Observation Year -> Year
      if (firstAnn.obs_year) {
        const yearField = document.getElementById('year');
        if (yearField && !yearField.value) {
          yearField.value = firstAnn.obs_year.toString();
          markFieldAsAutofilled(yearField);
          console.log('  ‚úì Year:', yearField.value);
        }
      }
      
      // Analyst -> Observer
      if (firstAnn.analyst) {
        const observerField = document.getElementById('observer');
        if (observerField && !observerField.value) {
          observerField.value = firstAnn.analyst.toString().trim();
          markFieldAsAutofilled(observerField);
          console.log('  ‚úì Observer:', observerField.value);
        }
      }
      
      // Auto-generate notes
      const notesField = document.getElementById('notes');
      if (notesField && !notesField.value) {
        notesField.value = `Imported ${annotations.length} annotation(s) from shapefile`;
        markFieldAsAutofilled(notesField);
        console.log('  ‚úì Notes:', notesField.value);
      }
      
      showStatus('createStatus', 'info', `‚ÑπÔ∏è Auto-filled project metadata from ${annotations.length} imported annotation(s)`);
    }
    
    function markFieldAsAutofilled(field) {
      if (!field) return;
      field.style.background = 'linear-gradient(to right, #e0f2fe 0%, #ffffff 100%)';
      field.style.borderColor = '#3b82f6';
      field.style.transition = 'all 0.3s';
      
      // Add a small indicator
      const indicator = document.createElement('span');
      indicator.textContent = '‚ú®';
      indicator.style.cssText = 'position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 12px; opacity: 0.6;';
      
      if (field.parentElement.style.position !== 'relative') {
        field.parentElement.style.position = 'relative';
      }
      
      field.parentElement.appendChild(indicator);
      
      // Remove styling when user edits the field
      field.addEventListener('input', () => {
        field.style.background = '';
        field.style.borderColor = '';
        if (indicator.parentElement) {
          indicator.remove();
        }
      }, { once: true });
    }
    
    function autoFillProjectMetadataFromShapefilePreview(properties) {
      if (!properties) return;
      
      console.log('üîÑ Auto-filling project metadata from shapefile preview...');
      
      // Look for common field names (case-insensitive)
      const propKeys = Object.keys(properties);
      const findProp = (names) => {
        for (const name of names) {
          const key = propKeys.find(k => k.toUpperCase() === name.toUpperCase());
          if (key && properties[key]) return properties[key];
        }
        return null;
      };
      
      // Site -> Project Name and Site Code
      const site = findProp(['SITE', 'SITE_NAME', 'SITENAME', 'SITE_CODE']);
      if (site) {
        const siteName = site.toString().trim();
        const projectNameField = document.getElementById('projectName');
        const siteCodeField = document.getElementById('siteCode');
        
        if (projectNameField && !projectNameField.value) {
          projectNameField.value = `${siteName} Coral Survey`;
          markFieldAsAutofilled(projectNameField);
          console.log('  ‚úì Project Name:', projectNameField.value);
        }
        
        if (siteCodeField && !siteCodeField.value) {
          siteCodeField.value = siteName;
          markFieldAsAutofilled(siteCodeField);
          console.log('  ‚úì Site Code:', siteCodeField.value);
        }
        
        // Region -> First 3 characters of site name
        const regionField = document.getElementById('region');
        if (regionField && !regionField.value && siteName.length >= 3) {
          regionField.value = siteName.substring(0, 3).toUpperCase();
          markFieldAsAutofilled(regionField);
          console.log('  ‚úì Region:', regionField.value);
        }
      }
      
      // Mission ID -> Cruise ID
      const missionId = findProp(['MISSION_ID', 'MISSIONID', 'MISSION', 'CRUISE', 'CRUISE_ID', 'CRUISEID']);
      if (missionId) {
        const cruiseField = document.getElementById('cruiseId');
        if (cruiseField && !cruiseField.value) {
          cruiseField.value = missionId.toString().trim();
          markFieldAsAutofilled(cruiseField);
          console.log('  ‚úì Cruise ID:', cruiseField.value);
        }
      }
      
      // Observation Year -> Year
      const obsYear = findProp(['OBS_YEAR', 'OBSYEAR', 'YEAR', 'SURVEY_YEAR']);
      if (obsYear) {
        const yearField = document.getElementById('year');
        if (yearField && !yearField.value) {
          yearField.value = obsYear.toString();
          markFieldAsAutofilled(yearField);
          console.log('  ‚úì Year:', yearField.value);
        }
      }
      
      // Analyst -> Observer
      const analyst = findProp(['ANALYST', 'OBSERVER', 'ANNOTATOR', 'SURVEYOR']);
      if (analyst) {
        const observerField = document.getElementById('observer');
        if (observerField && !observerField.value) {
          observerField.value = analyst.toString().trim();
          markFieldAsAutofilled(observerField);
          console.log('  ‚úì Observer:', observerField.value);
        }
      }
      
      console.log('‚úÖ Project metadata auto-fill complete');
    }
    
    function populateShapefilePreviewTable() {
      const container = document.getElementById('shapefilePreviewTable');
      if (!shapefileImportData) return;
      
      const samples = shapefileImportData.sample_features;
      
      if (!samples || samples.length === 0) {
        container.innerHTML = '<p style="color: #999; margin: 0;">No sample features available</p>';
        return;
      }
      
      const firstSample = samples[0].properties;
      const keys = Object.keys(firstSample);
      
      let html = '<table style="width: 100%; border-collapse: collapse; font-size: 11px;">';
      html += '<thead><tr style="background: #f0f0f0;">';
      html += '<th style="padding: 6px; border: 1px solid #ddd;">Geometry</th>';
      keys.forEach(key => {
        html += `<th style="padding: 6px; border: 1px solid #ddd;">${key}</th>`;
      });
      html += '</tr></thead><tbody>';
      
      samples.forEach(sample => {
        html += '<tr>';
        html += `<td style="padding: 6px; border: 1px solid #ddd;">${sample.geometry_type || 'N/A'}</td>`;
        keys.forEach(key => {
          const value = sample.properties[key];
          html += `<td style="padding: 6px; border: 1px solid #ddd;">${value !== null && value !== undefined ? value : '<em style="color: #999;">null</em>'}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      html += `<p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">Showing ${samples.length} of ${shapefileImportData.total_features} features</p>`;
      
      container.innerHTML = html;
    }
    
    // Convert shapefile to annotations using mapping
    async function convertShapefileToAnnotations() {
      if (!shapefileImportData || !shapefileImportData.files) {
        console.error('No shapefile data to convert');
        return null;
      }
      
      if (Object.keys(shapefileColumnMapping).length === 0) {
        showStatus('createStatus', 'error', '‚ùå Please map at least one column before saving the project');
        return null;
      }
      
      const formData = new FormData();
      
      // Add all shapefile components
      const shpFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.shp'));
      const shxFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.shx'));
      const dbfFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.dbf'));
      const prjFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.prj'));
      const cpgFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.cpg'));
      const xmlFile = shapefileImportData.files.find(f => f.name.toLowerCase().endsWith('.xml'));
      
      if (shpFile) formData.append('shp_file', shpFile);
      if (shxFile) formData.append('shx_file', shxFile);
      if (dbfFile) formData.append('dbf_file', dbfFile);
      if (prjFile) formData.append('prj_file', prjFile);
      if (cpgFile) formData.append('cpg_file', cpgFile);
      if (xmlFile) formData.append('xml_file', xmlFile);
      
      formData.append('column_mapping', JSON.stringify(shapefileColumnMapping));
      formData.append('analyst', 'Unknown');
      formData.append('obs_year', new Date().getFullYear().toString());
      formData.append('mission_id', 'Unknown');
      formData.append('site_name', 'Unknown');
      formData.append('ortho_file', 'Unknown');
      
      try {
        showStatus('createStatus', 'info', 'üîÑ Converting shapefile to annotations...');
        
        const response = await fetch('http://localhost:8000/api/annotations/import/execute-components', {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.detail || `HTTP ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.annotations && result.annotations.length > 0) {
          console.log('‚úÖ Converted annotations:', result.annotations.length);
          console.log('üìã First annotation structure:', result.annotations[0]);
          console.log('üìã First annotation properties:', result.annotations[0].properties);
          
          // Auto-fill project metadata from first annotation
          autoFillProjectMetadataFromAnnotations(result.annotations);
          
          showStatus('createStatus', 'success', `‚úÖ Converted ${result.annotations.length} shapefile features to annotations`);
          return result.annotations;
        } else {
          showStatus('createStatus', 'error', '‚ùå No annotations were converted from the shapefile');
          return null;
        }
        
      } catch (error) {
        console.error('Error converting shapefile:', error);
        showStatus('createStatus', 'error', `‚ùå Error converting shapefile: ${error.message}`);
        return null;
      }
    }
    
    // ========================================
    // PROJECT GENERATION
    // ========================================
    function generateProjectObject() {
      const projectName = document.getElementById('projectName').value || 'Untitled Project';
      const siteCode = document.getElementById('siteCode').value || '';
      
      const projectNameSafe = projectName.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
      
      const projectData = {
        project_name: projectName,
        site: siteCode,
        cruise: document.getElementById('cruiseId').value || '',
        year: parseInt(document.getElementById('year').value) || new Date().getFullYear(),
        region: document.getElementById('region').value || '',
        created_date: new Date().toISOString().split('T')[0],
        annotations_file: `${projectNameSafe}_annotations.json`,
        tif_files: tifFiles.map(tif => ({
          id: tif.id,
          name: tif.name,
          tif_path: tif.path,
          cog_path: tif.path.replace(/\.(tif|tiff)$/i, '_cog.tif'),
          cog_created: false,
          bounds: null,
          epsg: null,
          tile_url: null,
          type: tif.type
        })),
        shapefiles: shapefiles.map(shp => ({
          id: shp.id,
          name: shp.name,
          shapefile_path: shp.path,
          file_count: shp.files.length
        })),
        metadata: {
          observer: document.getElementById('observer').value || '',
          institution: 'NOAA',
          notes: document.getElementById('notes').value || ''
        }
      };
      
      // Include imported annotations if available
      if (importedAnnotations && importedAnnotations.length > 0) {
        projectData.annotations = importedAnnotations;
        projectData.metadata.imported_annotations = {
          count: importedAnnotations.length,
          source_file: annotationsFileName,
          imported_date: new Date().toISOString()
        };
      }
      
      return projectData;
    }
    
    async function generatePreview() {
      if (tifFiles.length === 0) {
        showStatus('createStatus', 'error', '‚ùå Please add at least one TIF file');
        return;
      }
      
      // If shapefile import is pending, convert it first
      if (shapefileImportData && !importedAnnotations) {
        const convertedAnnotations = await convertShapefileToAnnotations();
        if (convertedAnnotations) {
          importedAnnotations = convertedAnnotations;
        } else {
          return; // Conversion failed
        }
      }
      
      const project = generateProjectObject();
      document.getElementById('jsonPreview').textContent = JSON.stringify(project, null, 2);
      
      // Show COG paths for each TIF
      let cogStatusHTML = '<p style="margin: 10px 0 5px 0; font-weight: 600;">';
      cogStatusHTML += `üìã When you load this project, the system will check for existing COG files in the base folder.<br>If not found, they will be automatically created.`;
      cogStatusHTML += '</p>';
      cogStatusHTML += '<ul style="margin: 5px 0; padding-left: 20px; font-size: 12px;">';
      
      project.tif_files.forEach(tif => {
        cogStatusHTML += `<li><strong>${tif.name}:</strong><br><code style="font-size: 11px; color: #1e40af;">${tif.cog_path}</code></li>`;
      });
      
      cogStatusHTML += '</ul>';
      
      // Show imported annotations info if available
      if (importedAnnotations && importedAnnotations.length > 0) {
        cogStatusHTML += '<p style="margin: 10px 0 5px 0; padding: 8px; background: #d1fae5; border-left: 4px solid #10b981; border-radius: 4px; font-size: 12px;">';
        cogStatusHTML += `üè∑Ô∏è <strong>Annotations:</strong> ${importedAnnotations.length} annotation(s) from "${annotationsFileName}" will be included in the project.`;
        cogStatusHTML += '</p>';
      }
      
      cogStatusHTML += '<p style="margin: 10px 0 0 0; padding: 8px; background: #dbeafe; border-radius: 4px; font-size: 12px;">';
      cogStatusHTML += 'üí° <strong>Tip:</strong> COG creation uses bilinear resampling and may take a few minutes for large files.';
      cogStatusHTML += '</p>';
      
      document.getElementById('cogStatusDetails').innerHTML = cogStatusHTML;
      document.getElementById('previewSection').style.display = 'block';
      document.getElementById('previewSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    async function saveProject() {
      if (tifFiles.length === 0) {
        showStatus('createStatus', 'error', '‚ùå Please add at least one TIF file');
        return;
      }
      
      // Validate paths
      const invalidTifPaths = tifFiles.filter(tif => tif.path.includes('C:\\path\\to\\'));
      const invalidShpPaths = shapefiles.filter(shp => shp.path.includes('C:\\path\\to\\'));
      
      if (invalidTifPaths.length > 0 || invalidShpPaths.length > 0) {
        showStatus('createStatus', 'error', 
          `‚ö†Ô∏è Please set a base folder path and click "Apply to All Files", or manually edit the file paths below.`
        );
        return;
      }
      
      // If shapefile import is pending, convert it first
      if (shapefileImportData && !importedAnnotations) {
        const convertedAnnotations = await convertShapefileToAnnotations();
        if (convertedAnnotations) {
          importedAnnotations = convertedAnnotations;
        } else {
          return; // Conversion failed
        }
      }
      
      const project = generateProjectObject();
      const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${project.project_name.replace(/[^a-z0-9]/gi, '_')}_project.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showStatus('createStatus', 'success', '‚úÖ Project file downloaded! You can now upload it to the annotation viewer.');
    }
    
    async function saveAndOpen() {
      if (tifFiles.length === 0) {
        showStatus('createStatus', 'error', '‚ùå Please add at least one TIF file');
        return;
      }
      
      // Validate paths
      const invalidTifPaths = tifFiles.filter(tif => tif.path.includes('C:\\path\\to\\'));
      const invalidShpPaths = shapefiles.filter(shp => shp.path.includes('C:\\path\\to\\'));
      
      if (invalidTifPaths.length > 0 || invalidShpPaths.length > 0) {
        showStatus('createStatus', 'error', 
          `‚ö†Ô∏è Please set a base folder path and click "Apply to All Files", or manually edit the file paths below.`
        );
        return;
      }
      
      // If shapefile import is pending, convert it first
      if (shapefileImportData && !importedAnnotations) {
        const convertedAnnotations = await convertShapefileToAnnotations();
        if (convertedAnnotations) {
          importedAnnotations = convertedAnnotations;
        } else {
          return; // Conversion failed
        }
      }
      
      const project = generateProjectObject();
      
      // Download the JSON file (same as saveProject)
      const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${project.project_name.replace(/[^a-z0-9]/gi, '_')}_project.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      // Save to localStorage temporarily for the viewer
      localStorage.setItem('annotationProject', JSON.stringify(project));
      
      // Show success message before redirecting
      showStatus('createStatus', 'success', '‚úÖ Project file downloaded! Opening viewer...');
      
      // Redirect to viewer after a short delay to ensure download starts
      setTimeout(() => {
        window.location.href = '/annotation_file_mode.html';
      }, 500);
    }
    
    // ========================================
    // LOAD MODE
    // ========================================
    function loadProjectFile(files) {
      if (files.length === 0) return;
      
      const file = files[0];
      const reader = new FileReader();
      
      reader.onload = (e) => {
        try {
          loadedProject = JSON.parse(e.target.result);
          document.getElementById('loadedJsonPreview').textContent = JSON.stringify(loadedProject, null, 2);
          document.getElementById('loadedPreview').style.display = 'block';
          showStatus('loadStatus', 'success', '‚úÖ Project loaded successfully!');
        } catch (error) {
          showStatus('loadStatus', 'error', `‚ùå Invalid JSON: ${error.message}`);
        }
      };
      
      reader.readAsText(file);
    }
    
    function editLoadedProject() {
      if (!loadedProject) return;
      
      // Switch to create mode and populate fields
      selectMode('create');
      
      document.getElementById('projectName').value = loadedProject.project_name || '';
      document.getElementById('siteCode').value = loadedProject.site || '';
      document.getElementById('cruiseId').value = loadedProject.cruise || '';
      document.getElementById('year').value = loadedProject.year || new Date().getFullYear();
      document.getElementById('region').value = loadedProject.region || '';
      document.getElementById('observer').value = loadedProject.metadata?.observer || '';
      document.getElementById('notes').value = loadedProject.metadata?.notes || '';
      
      // Note: Can't restore actual File objects, but show the paths
      showStatus('createStatus', 'info', '‚ÑπÔ∏è Project metadata loaded. File paths are preserved but files must be re-added for editing.');
    }
    
    function openInViewer() {
      if (!loadedProject) return;
      
      // Save to localStorage temporarily
      localStorage.setItem('annotationProject', JSON.stringify(loadedProject));
      
      // Redirect to viewer
      window.location.href = '/annotation_file_mode.html';
    }
    
    // ========================================
    // UTILITIES
    // ========================================
    function showStatus(elementId, type, message) {
      const element = document.getElementById(elementId);
      element.className = `status ${type}`;
      element.textContent = message;
      element.style.display = 'block';
      
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }
  </script>
</body>
</html>
