import{j as e}from"./@radix-Da0HZyg8.js";import{E as W}from"./Error-6iAuA6jd.js";import{K as ie,as as A,c as le,a6 as oe,b4 as ce,b7 as ue,b8 as de,b9 as he,ba as xe,bc as me,bb as ge,bd as fe,ak as pe,y as O,B as k,aw as K,a1 as je,a9 as ye,m as we,a2 as ve,a3 as be,a5 as Ne,aI as Se,aJ as Le,aK as ke,t as Ce,aL as Te,aM as Ee,aN as Ie,I as Me,aO as Pe,aP as Re,aQ as $e,aR as De,aB as U,F as I,H as M,G as P,J as R,ad as H,e as L,ay as J,aV as ze,a4 as Ae,aS as qe,be as _e}from"./index-5vBAbha7.js";import{j as Fe,b as $}from"./@tanstack-BRZ8pkCt.js";import{a as c,W as Qe}from"./@monaco-editor-xs6rrDBC.js";import{S as Be}from"./expand-full-BzNS_BcJ.js";import{S as Oe}from"./download-01-DVCWPSnn.js";import{S as Ke}from"./SearchField-f4ysuxbY.js";import{S as Ve}from"./alert-triangle-C7ryTF32.js";import{S as Ge}from"./check-DSoixTtU.js";import{a as We}from"./@react-router-BEwS6i40.js";function D({title:t,subtitle:s}){return e.jsx(ie,{icon:e.jsx(A,{className:"h-[120px] w-[120px] fill-neutral-300"}),children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"mb-2 text-display-xs font-semibold",children:t}),e.jsx("p",{className:"text-lg text-theme-text-secondary",children:s})]})})}const Ue=t=>c.createElement("svg",{viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",...t},c.createElement("path",{d:"M4 14H10M10 14V20M10 14L3 21M20 10H14M14 10V4M14 10L21 3",stroke:"currentColor",strokeWidth:2,strokeLinecap:"round",strokeLinejoin:"round"}));function He(t){if(!Array.isArray(t)||t.length===0)return[];const s=new Map;for(let l=0;l<t.length;l++){const n=t[l],a=(n.total_chunks??1)>1||n.chunk_index!=null?n.id?`id:${n.id}`:`k:${n.timestamp??""}|${n.level??""}|${n.module??""}|${n.filename??""}|${n.lineno??""}`:`single:${l}`,u=s.get(a);u?u.push(n):s.set(a,[n])}const r=[];return s.forEach(l=>{if(l.length===1&&(l[0].total_chunks??1)<=1&&l[0].chunk_index==null){r.push(l[0]);return}const n=l.slice().sort((a,u)=>(a.chunk_index??0)-(u.chunk_index??0)),i={...n[0]};i.message=n.map(a=>a.message??"").join(""),delete i.chunk_index,delete i.total_chunks,r.push(i)}),r}function Y(t){return He(t).map(r=>{const l=`[${X[r.level||20]}] [${r.timestamp}] ${r.message}`;return{...r,originalEntry:l}})}const X={0:"",10:"DEBUG",20:"INFO",30:"WARNING",40:"ERROR",50:"CRITICAL"},Je=t=>{switch(t){case 10:return"bg-neutral-400";case 20:return"bg-blue-500";case 30:return"bg-warning-500";case 40:return"bg-error-500";case 50:return"bg-error-700";default:return"bg-neutral-400"}},Ye=t=>ce(t).toLocaleString("sv-SE",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});function Xe({entry:t,searchTerm:s,isCurrentMatch:r,textWrapEnabled:l,highlightedMessage:n,className:i}){const{timestamp:a,level:u,message:g,originalEntry:w}=t,v=a?Ye(a):"",j=Je(u??void 0),o=x=>{if(!s)return x;const y=new RegExp(`(${s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`,"gi");return x.split(y).map((f,d)=>f.toLowerCase()===s.toLowerCase()?e.jsx("span",{className:`${r?"bg-warning-200 text-warning-900":"bg-warning-100 text-warning-800"} inline-block rounded-sm px-1`,children:f},d):f)};return e.jsxs("div",{className:le("group/copybutton flex w-full items-start space-x-3 border-b border-theme-border-minimal bg-theme-surface-primary px-4 py-1 font-mono text-text-sm font-normal transition-colors hover:bg-theme-surface-tertiary",i),children:[" ",e.jsxs("div",{className:"flex max-h-6 w-12 flex-shrink-0 items-center",children:[e.jsx("div",{className:`h-4 w-[2px] rounded-sm ${j} mr-2`}),e.jsx("span",{className:"text-xs text-theme-text-tertiary",children:X[u??20]})]}),e.jsx("div",{className:"w-[178px] flex-shrink-0 text-theme-text-secondary",children:v}),e.jsx("div",{className:`flex-1 text-theme-text-primary ${l?"min-w-0 whitespace-pre-wrap break-words":"whitespace-nowrap"}`,children:n||o(g)}),e.jsx("div",{className:"flex flex-shrink-0 items-center",children:e.jsx(oe,{copyText:w,copyTitle:"Copy log line"})})]})}const Ze=[{value:10,label:"Debug",icon:e.jsx(fe,{className:"size-3 shrink-0 fill-neutral-400"})},{value:20,label:"Info",icon:e.jsx(pe,{className:"size-3 shrink-0 fill-blue-500"})},{value:30,label:"Warning",icon:e.jsx(Ve,{className:"size-3 shrink-0 fill-warning-500"})},{value:40,label:"Error",icon:e.jsx(O,{className:"size-3 shrink-0 fill-error-500"})},{value:50,label:"Critical",icon:e.jsx(O,{className:"size-3 shrink-0 fill-error-700"})}],Z=c.forwardRef(({...t},s)=>e.jsxs(ue,{...t,children:[e.jsx(de,{ref:s,className:"h-7 w-full truncate border border-[#D0D5DD] bg-theme-surface-primary p-2 text-left text-text-md",children:e.jsx(he,{className:"data-[placeholder]:text-theme-text-secondary",placeholder:"Select a role..."})}),e.jsx(xe,{className:"",children:e.jsx(me,{viewportClassName:"max-h-[300px]",children:Ze.map((r,l)=>e.jsx(ge,{className:"rounded-sm p-2",value:r.value.toString(),children:e.jsxs("div",{className:"flex items-center gap-1",children:[r.icon,r.label]})},l))})})]}));Z.displayName="LogLevelSelect";function V({hasLogs:t,sourceSwitcher:s,onSearchChange:r,onReload:l,onCopyAll:n,onDownload:i,searchQuery:a="",currentMatchIndex:u=0,totalMatches:g=0,onPreviousMatch:w,onNextMatch:v,logLevel:j,setLogLevel:o}){return e.jsx(e.Fragment,{children:e.jsxs("div",{className:"flex items-end gap-2 bg-theme-surface-secondary",children:[s&&e.jsx("div",{children:s}),t&&e.jsxs("div",{className:"flex w-full flex-wrap items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"border-neutral-300",searchParams:{},inMemoryHandler:r,placeholder:"Search logs..."}),a&&e.jsxs("div",{className:"flex items-center gap-0.5",children:[e.jsx("span",{className:"text-sm whitespace-nowrap text-theme-text-secondary",children:g>0?`${u+1} of ${g}`:"No matches"}),e.jsx(k,{className:"aspect-square",size:"sm",emphasis:"minimal",onClick:w,disabled:g===0,title:"Previous match",children:e.jsx(K,{className:"h-4 w-4 shrink-0 rotate-90 fill-theme-text-tertiary"})}),e.jsx(k,{className:"aspect-square",size:"sm",emphasis:"minimal",onClick:v,disabled:g===0,title:"Next match",children:e.jsx(K,{className:"h-4 w-4 shrink-0 -rotate-90 fill-theme-text-tertiary"})})]}),e.jsx(Z,{value:j.toString(),onValueChange:x=>o(Number(x))})]}),e.jsx(je,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{icon:e.jsx(ye,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Reload logs",onClick:l}),e.jsx(z,{icon:e.jsx(we,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Copy all displayed logs",onClick:n}),e.jsx(z,{icon:e.jsx(Oe,{className:"h-4 w-4 fill-theme-text-primary"}),tooltip:"Download logs as file",onClick:i})]})})]})]})})}function z({icon:t,tooltip:s,onClick:r}){return e.jsxs(ve,{delayDuration:200,children:[e.jsx(be,{children:e.jsx(k,{size:"md",emphasis:"subtle",intent:"secondary",onClick:r,className:"flex aspect-square items-center justify-center bg-theme-surface-primary p-0",children:t})}),e.jsx(Ne,{children:s})]})}function et(t){const[s,r]=c.useState(""),[l,n]=c.useState(0),i=c.useMemo(()=>{const o=s.trim().toLowerCase();if(!o)return[];const x=[];return t.forEach((y,p)=>{const f=y.message.toLowerCase();let d=0,N=0;for(;d<f.length;){const m=f.indexOf(o,d);if(m===-1)break;x.push({logIndex:p,matchIndex:N++,startIndex:m,endIndex:m+o.length}),d=m+o.length}}),x},[t,s]),a=i.length,u=a===0?0:Math.min(l,a-1),g=c.useCallback(o=>{r(o),n(0)},[]),w=c.useCallback(()=>{if(a===0)return-1;const o=(u+1)%a;return n(o),o},[a,u]),v=c.useCallback(()=>{if(a===0)return-1;const o=(u-1+a)%a;return n(o),o},[a,u]),j=c.useCallback((o,x)=>{if(!s.trim())return o;const y=i.filter(d=>d.logIndex===x);if(y.length===0)return o;const p=[];let f=0;return y.forEach((d,N)=>{d.startIndex>f&&p.push(o.slice(f,d.startIndex));const T=i.findIndex(E=>E.logIndex===d.logIndex&&E.matchIndex===d.matchIndex)===u?"bg-warning-200 text-warning-900 inline-block rounded-sm px-1":"bg-warning-100 text-warning-800 inline-block rounded-sm px-1";p.push(Qe.createElement("span",{key:`${x}-${N}`,className:T},o.slice(d.startIndex,d.endIndex))),f=d.endIndex}),f<o.length&&p.push(o.slice(f)),p},[s,i,u]);return{searchQuery:s,setSearchQuery:g,matches:i,currentMatchIndex:u,totalMatches:a,goToNextMatch:w,goToPreviousMatch:v,highlightText:j}}function tt(t){const[s,r]=c.useState(20),l=c.useMemo(()=>t.filter(n=>n.level&&n.level>=s),[t,s]);return{selectedLogLevel:s,filteredLogs:l,setSelectedLogLevel:r}}function ee({logs:t,reloadLogs:s,fallbackMessage:r,sourceSwitcher:l}){const[n,i]=c.useState(!0),a=c.useRef(null),u=c.useRef(!1),{filteredLogs:g,setSelectedLogLevel:w,selectedLogLevel:v}=tt(t),{searchQuery:j,setSearchQuery:o,matches:x,currentMatchIndex:y,totalMatches:p,goToNextMatch:f,goToPreviousMatch:d,highlightText:N}=et(g),m=Fe({overscan:10,count:g.length,getScrollElement:()=>a.current,estimateSize:()=>32}),T=m.getVirtualItems(),E=t.length>0;c.useEffect(()=>{m.measure()},[n,m]),c.useEffect(()=>{u.current||g.length===0||(u.current=!0,m.scrollToIndex(g.length-1,{align:"end"}))},[g.length,m]);const q=c.useCallback(()=>{const h=f();h>=0&&x[h]&&m.scrollToIndex(x[h].logIndex,{align:"center"})},[f,x,m]),_=c.useCallback(()=>{const h=d();h>=0&&x[h]&&m.scrollToIndex(x[h].logIndex,{align:"center"})},[d,x,m]),F=()=>{const h=G(t);navigator.clipboard.writeText(h).catch(b=>{console.error("Failed to copy logs:",b)})},Q=()=>{const h=G(t),b=new Blob([h],{type:"text/plain"}),B=URL.createObjectURL(b),S=document.createElement("a");S.href=B,S.download=`logs-${new Date().toISOString().split("T")[0]}.txt`,document.body.appendChild(S),S.click(),document.body.removeChild(S),URL.revokeObjectURL(B)},ae=()=>{i(h=>!h)};return E?e.jsxs("div",{className:"flex flex-1 flex-col space-y-5",children:[e.jsx(V,{hasLogs:!0,sourceSwitcher:l,logLevel:v,setLogLevel:w,onSearchChange:o,onReload:s,onCopyAll:F,onDownload:Q,searchQuery:j,currentMatchIndex:y,totalMatches:p,onPreviousMatch:_,onNextMatch:q}),e.jsxs("div",{className:"flex flex-1 flex-col overflow-hidden",children:[e.jsxs("div",{className:"flex w-full min-w-[600px] space-x-3 bg-theme-surface-tertiary px-4 py-1 font-medium text-theme-text-secondary",children:[e.jsx("div",{className:"flex w-12 flex-shrink-0 items-center",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Type"})}),e.jsx("div",{className:"w-[178px] flex-shrink-0",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Time"})}),e.jsx("div",{className:"flex min-w-0 flex-1 items-center justify-between",children:e.jsx("span",{className:"text-text-sm font-semibold",children:"Event"})}),e.jsx("div",{className:"flex flex-shrink-0 items-center",children:e.jsx(k,{onClick:ae,size:"sm",emphasis:"subtle",intent:"secondary",className:"ml-2 h-5 w-5 rounded-sm bg-theme-surface-primary p-0.25",title:n?"Collapse text":"Expand text",children:n?e.jsx(Ue,{className:"h-4 w-4 shrink-0 text-theme-text-tertiary hover:text-theme-text-secondary"}):e.jsx(Be,{className:"h-4 w-4 shrink-0 fill-theme-text-tertiary hover:fill-theme-text-secondary"})})})]}),e.jsx("div",{ref:a,className:"flex-1 overflow-auto contain-strict",children:e.jsx("div",{style:{height:m.getTotalSize(),width:"100%",position:"relative"},children:e.jsx("div",{style:{position:"absolute",top:0,left:0,width:"fit-content",minWidth:"100%",transform:`translateY(${T[0]?.start??0}px)`},children:T.map(h=>{const b=g[h.index];return e.jsx("div",{"data-index":h.index,ref:m.measureElement,children:e.jsx(Xe,{entry:b,searchTerm:j,textWrapEnabled:n,highlightedMessage:N(b.message,h.index)})},h.key)})})})})]})]}):e.jsxs("div",{className:"flex flex-1 flex-col space-y-5",children:[e.jsx(V,{hasLogs:!1,sourceSwitcher:l,logLevel:v,setLogLevel:w,onSearchChange:o,onReload:s,onCopyAll:F,onDownload:Q,searchQuery:j,currentMatchIndex:y,totalMatches:p,onPreviousMatch:_,onNextMatch:q}),e.jsx("div",{className:"flex-1",children:r})]})}function G(t){return t.map(s=>s.originalEntry).join(`
`)}function te(){return e.jsx("section",{className:"flex h-[calc(100vh_-_270px)] items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center justify-center",children:[e.jsxs("div",{className:"relative mb-2 flex items-center justify-center",children:[e.jsx(Se,{className:"h-[120px] w-[120px]"}),e.jsx(st,{})]}),e.jsx("h2",{className:"my-3 text-center text-display-xs font-semibold",children:"Loading the Logs"}),e.jsxs("p",{className:"text-center text-text-lg text-theme-text-secondary",children:["It can take up to a few minutes. ",e.jsx("br",{})," Please wait while we fetch logs from the artifact store."]})]})})}function st(){return e.jsx("div",{className:"absolute rounded-rounded bg-primary-25 p-3",children:e.jsx(A,{className:"h-7 w-7 fill-primary-400"})})}function se({sources:t,selectedSource:s,setSelectedSource:r}){const[l,n]=c.useState(!1);return e.jsxs(Le,{modal:!0,open:l,onOpenChange:n,children:[e.jsx(ke,{asChild:!0,children:e.jsxs(k,{intent:"secondary",emphasis:"subtle",className:"flex items-center gap-0.5 bg-theme-surface-primary capitalize",size:"md",children:[s,e.jsx(Ce,{width:24,height:24,className:"fill-text-primary shrink-0"})]})}),e.jsx(Te,{className:"px-0",align:"start",children:e.jsxs(Ee,{defaultValue:s,className:"rounded-sharp",children:[e.jsx(Ie,{className:"m-0",placeholder:"Search sources...",children:e.jsx(Me,{className:"w-full",inputSize:"sm"})}),e.jsxs(Pe,{children:[e.jsx(Re,{children:"No source found."}),e.jsx($e,{className:"max-h-[300px] overflow-y-auto",children:t.map(i=>{const a=i.split("/").pop();return e.jsxs(De,{keywords:[a??""],className:"group capitalize data-[selected=true]:rounded-sharp",value:i,onSelect:()=>{r(i),n(!1)},children:[i===s?e.jsx(Ge,{width:16,height:16,className:"shrink-0 fill-theme-text-tertiary group-data-[selected=true]:fill-theme-text-brand"}):e.jsx(A,{width:16,height:16,className:"shrink-0 fill-theme-text-tertiary group-data-[selected=true]:fill-theme-text-brand"}),a]},i)})})]})]})})]})}function nt({runId:t,queries:s}){return["runs",t,"logs",s]}async function rt({runId:t,queries:s}){const r=U(s).toString(),l=P(R.runs.logs(t))+(r?`?${r}`:""),n=await I(l,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok){const i=await n.json().then(a=>Array.isArray(a.detail)?a.detail[1]:a.detail).catch(()=>`Error while fetching logs for run ${t}`);throw new M({status:n.status,statusText:n.statusText,message:i})}return n.json()}function at(t,s){return $({queryKey:nt(t),queryFn:()=>rt(t),...s})}function Et({runId:t}){const{data:s,isError:r,isPending:l}=H({runId:t});if(l)return e.jsx(L,{className:"h-[200px] w-full"});if(r)return e.jsx("p",{children:"Error loading logs"});const i=s.resources?.log_collection?.map(a=>a.body?.source).filter(a=>a!=null&&a!=null)??[];return i.length<1?e.jsx(D,{title:"This pipeline run has no logs",subtitle:"It looks like there are no logs associated with this pipeline run"}):e.jsx(it,{sources:i,runId:t})}function it({sources:t,runId:s}){const[r,l]=c.useState(t[0]),n=at({runId:s,queries:{source:r}}),i=c.useMemo(()=>n.data?Y(n.data):[],[n.data]);return n.isPending?e.jsx(te,{}):n.isError?e.jsx(W,{err:n.error}):e.jsx(ee,{fallbackMessage:e.jsx(D,{title:"This pipeline run has no logs",subtitle:"It looks like there are no logs associated with this pipeline run"}),sourceSwitcher:t.length>1?e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-text-sm text-theme-text-secondary",children:"Source"}),e.jsx(se,{sources:t,selectedSource:r,setSelectedSource:l})]}):void 0,logs:i,reloadLogs:()=>n.refetch()})}function lt({stepId:t}){return["steps",t]}async function ot({stepId:t}){const s=P(R.steps.detail(t)),r=await I(s,{method:"GET",headers:{"Content-Type":"application/json"}});if(r.status===404&&J(),!r.ok)throw new M({message:`Error while fetching step ${t}`,status:r.status,statusText:r.statusText});return r.json()}function ne(t,s){return $({queryKey:lt(t),queryFn:()=>ot(t),...s})}function ct(t,s){return["initializing","running"].includes(t)&&s==="failed"}function ut({stepId:t,queries:s}){return["logs",t,s]}async function dt({stepId:t,queries:s}){const r=U(s).toString(),l=P(R.steps.logs(t)+(r?`?${r}`:"")),n=await I(l,{method:"GET",headers:{"Content-Type":"application/json"}});if(!n.ok){const i=await n.json().then(a=>Array.isArray(a.detail)?a.detail[1]:a.detail).catch(()=>`Error while fetching logs for step ${t}`);throw new M({status:n.status,statusText:n.statusText,message:i})}return n.json()}function ht(t,s){return $({queryKey:ut(t),queryFn:()=>dt(t),...s})}function It({stepId:t}){const{data:s,isError:r,isPending:l}=ne({stepId:t});if(l)return e.jsx(L,{className:"h-[200px] w-full"});if(r)return e.jsx("p",{children:"Error loading logs"});const i=s.resources?.log_collection?.map(a=>a.body?.source).filter(a=>a!=null&&a!==void 0)??[];return i.length<1?e.jsx(D,{title:"This step has no logs",subtitle:"It looks like there are no logs associated with this step"}):e.jsx(xt,{sources:i,stepId:t})}function xt({sources:t,stepId:s}){const r=t.includes("step")?"step":t[0],[l,n]=c.useState(r),i=ht({stepId:s,queries:{source:l}}),a=c.useMemo(()=>i.data?Y(i.data):[],[i.data]);return i.isPending?e.jsx(te,{}):i.isError?e.jsx(W,{err:i.error}):e.jsx(ee,{fallbackMessage:e.jsx(D,{title:"This step has no logs",subtitle:"It looks like there are no logs associated with this step"}),sourceSwitcher:t.length>1?e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("span",{className:"text-text-sm text-theme-text-secondary",children:"Source"}),e.jsx(se,{sources:t,selectedSource:l,setSelectedSource:n})]}):void 0,logs:a,reloadLogs:()=>i.refetch()})}function Mt({stepId:t}){const{runId:s}=We(),r=ne({stepId:t}),l=H({runId:s});if(r.isPending||l.isPending)return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(L,{className:"size-5 shrink-0 rounded-sm"}),e.jsx(L,{className:"h-5 w-[150px]"}),e.jsx(L,{className:"h-4 w-[80px] rounded-rounded"})]});if(r.error||l.error)return null;const n=r.data.body?.status,i=l.data.body?.status,a=ct(n??"running",i??"running");return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx("div",{className:`rounded-sm p-0.5 ${a?"bg-blue-50":ze(n)}`,children:e.jsx(Ae,{status:a?"unknown":n,className:"h-4 w-4 shrink-0"})}),e.jsx("h2",{className:"text-display-xs font-semibold",children:r.data.name}),e.jsx(qe,{size:"sm",className:"capitalize",color:_e(a?"unknown":n),children:a?`Unknown - Last reported: ${n}`:n||"None"})]})}function re(t){return t.type==="step"}function mt(t){return t.type==="triggered_run"}function gt(t){return t.type==="artifact"}function C(t){return!t.id}function Pt(t){return t.filter(re).filter(s=>!C(s))}function Rt(t){return t.filter(gt).filter(s=>!C(s))}function $t(t){return t.filter(mt).filter(s=>!C(s))}function Dt(t){return t.filter(C)}function zt(t){return t.filter(C).filter(re)}function ft({runId:t}){return["runs",t,"dag"]}async function pt({runId:t}){const s=P(R.runs.dag(t)),r=await I(s,{method:"GET",headers:{"Content-Type":"application/json"}});if(r.status===404&&J(),!r.ok)throw new M({message:`Error while fetching pipeline run ${t}`,status:r.status,statusText:r.statusText});return r.json()}function At(t,s){return $({queryKey:ft(t),queryFn:()=>pt(t),...s})}export{D as E,Et as L,Mt as S,It as a,Pt as b,$t as c,Rt as d,Dt as e,zt as f,ct as g,At as h,re as i,ne as u};
