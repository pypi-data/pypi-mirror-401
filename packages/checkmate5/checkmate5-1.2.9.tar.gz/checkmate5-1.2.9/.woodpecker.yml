# .woodpecker.yml
labels:
  platform: linux/amd64

steps:
  # 1. BUILD STAGE
  build_package:
    image: python:3.13
    commands:
      - pip install --upgrade pip
      - pip install build
      - python -m build
    when:
      - event: [push, tag]
        branch: main

  # 2. PUBLISH STAGE (PyPI)
  publish_to_pypi:
    image: python:3.13
    environment:
      PYPI_TOKEN:
        from_secret: PYPI_TOKEN # Matches uppercase secret in UI
    commands:
      - pip install twine
      - export TWINE_USERNAME="__token__"
      - export TWINE_PASSWORD=$PYPI_TOKEN
      - python -m twine upload --verbose dist/*
    when:
      - event: tag

  # 3. DOCKER STAGE (Kaniko)
  docker_publish:
    image: plugins/kaniko
    settings:
      repo: tcosolutions/betterscan-worker-cli
      username:
        from_secret: DOCKERHUB_USERNAME # Matches uppercase secret in UI
      password:
        from_secret: DOCKERHUB_TOKEN    # Matches uppercase secret in UI
      tags: ${CI_COMMIT_TAG:-latest}
    when:
      - event: tag
      - event: push
        branch: main

  # 4. CLEANUP STAGE
  docker_hub_cleanup:
    image: alpine:latest
    environment:
      DOCKERHUB_USERNAME:
        from_secret: DOCKERHUB_USERNAME
      DOCKERHUB_TOKEN:
        from_secret: DOCKERHUB_TOKEN
    commands:
      - apk add --no-cache curl jq
      - |
        TOKEN=$(curl -s -H "Content-Type: application/json" -X POST \
          -d "{\"username\": \"$DOCKERHUB_USERNAME\", \"password\": \"$DOCKERHUB_TOKEN\"}" \
          https://hub.docker.com/v2/users/login/ | jq -r .token)
        if [ "$TOKEN" != "null" ] && [ -n "$TOKEN" ]; then 
          echo "Auth Success"; 
        else 
          echo "Auth Failed - check credentials"; 
          exit 1; 
        fi
    when:
      - event: cron