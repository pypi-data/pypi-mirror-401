if(typeof window.currentTasks==='undefined'){window.currentTasks=[]}
if(typeof window.activeTaskId==='undefined'){window.activeTaskId=null}
if(typeof window.taskCountdowns==='undefined'){window.taskCountdowns={}}
if(typeof window.tasksPollingTimer==='undefined'){window.tasksPollingTimer=null}
if(typeof window.taskTextareaContents==='undefined'){window.taskTextareaContents={}}
if(typeof window.taskOptionsStates==='undefined'){window.taskOptionsStates={}}
if(typeof window.taskImages==='undefined'){window.taskImages={}}
if(typeof window.pendingNewTaskCount==='undefined'){window.pendingNewTaskCount=0}
if(typeof window.newTaskHintTimer==='undefined'){window.newTaskHintTimer=null}
if(typeof window.serverTimeOffset==='undefined'){window.serverTimeOffset=0}
if(typeof window.taskDeadlines==='undefined'){window.taskDeadlines={}}
if(typeof window.feedbackPrompts==='undefined'){window.feedbackPrompts={resubmit_prompt:'è¯·ç«‹å³è°ƒç”¨ interactive_feedback å·¥å…·',prompt_suffix:'\nè¯·ç§¯æè°ƒç”¨ interactive_feedback å·¥å…·'}}
var currentTasks=window.currentTasks
var activeTaskId=window.activeTaskId
var taskCountdowns=window.taskCountdowns
var tasksPollingTimer=window.tasksPollingTimer
var taskTextareaContents=window.taskTextareaContents
var taskOptionsStates=window.taskOptionsStates
var taskImages=window.taskImages
var feedbackPrompts=window.feedbackPrompts
async function fetchFeedbackPromptsFresh(){try{const resp=await fetch('/api/get-feedback-prompts',{cache:'no-store'})
if(!resp.ok)throw new Error(`HTTP ${resp.status}`)
const data=await resp.json()
if(data&&data.status==='success'&&data.config){window.feedbackPrompts=data.config
feedbackPrompts=window.feedbackPrompts
if(data.meta&&data.meta.config_file){const el=document.getElementById('config-file-path')
if(el){el.value=data.meta.config_file}}
return window.feedbackPrompts}}catch(e){console.warn('è·å–åé¦ˆæç¤ºè¯­é…ç½®å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°é»˜è®¤å€¼:',e)}
return window.feedbackPrompts}
if(typeof window.remainingSeconds==='undefined'){window.remainingSeconds=0}
if(typeof window.countdownTimer==='undefined'){window.countdownTimer=null}
var remainingSeconds=window.remainingSeconds
var countdownTimer=window.countdownTimer
if(typeof window.updateCountdownDisplay!=='function'){window.updateCountdownDisplay=function(seconds){const countdownContainer=document.getElementById('countdown-container')
const countdownText=document.getElementById('countdown-text')
if(!countdownContainer||!countdownText)return
const displaySeconds=typeof seconds==='number'?seconds:window.remainingSeconds
if(displaySeconds>0){countdownText.textContent=`${displaySeconds}ç§’åè‡ªåŠ¨é‡æ–°è¯¢é—®`
countdownContainer.classList.remove('hidden')}else{countdownContainer.classList.add('hidden')}}}
var updateCountdownDisplay=window.updateCountdownDisplay
var TASKS_POLL_BASE_MS=2000
var TASKS_POLL_MAX_MS=30000
var tasksPollBackoffMs=TASKS_POLL_BASE_MS
var tasksPollAbortController=null
var tasksPollVisibilityHandlerInstalled=false
function getNextBackoffMs(currentMs){const next=Math.min(TASKS_POLL_MAX_MS,Math.round(currentMs*1.7))
const jitter=Math.round(next*0.1*Math.random())
return next+jitter}
async function fetchAndApplyTasks(reason){if(typeof document!=='undefined'&&document.hidden){return false}
if(isManualSwitching){return false}
try{if(tasksPollAbortController&&typeof tasksPollAbortController.abort==='function'){tasksPollAbortController.abort()}}catch(e){}
if(typeof AbortController!=='undefined'){tasksPollAbortController=new AbortController()}else{tasksPollAbortController=null}
const fetchOptions={cache:'no-store'}
if(tasksPollAbortController){fetchOptions.signal=tasksPollAbortController.signal}
try{const response=await fetch('/api/tasks',fetchOptions)
if(!response.ok){throw new Error(`HTTP ${response.status}`)}
const data=await response.json()
if(data.success){if(data.server_time){const localTime=Date.now()/1000
window.serverTimeOffset=data.server_time-localTime
if(Math.abs(window.serverTimeOffset)>1){console.log(`æœåŠ¡å™¨æ—¶é—´åç§»: ${window.serverTimeOffset.toFixed(2)}s`)}}
if(data.tasks){data.tasks.forEach(task=>{if(task.deadline){window.taskDeadlines[task.task_id]=task.deadline}
if(taskCountdowns&&taskCountdowns[task.task_id]&&task.status!=='completed'){if(typeof task.auto_resubmit_timeout==='number'){if(task.auto_resubmit_timeout<=0){try{if(taskCountdowns[task.task_id].timer){clearInterval(taskCountdowns[task.task_id].timer)}}catch(e){}
delete taskCountdowns[task.task_id]
delete window.taskDeadlines[task.task_id]}else{taskCountdowns[task.task_id].timeout=task.auto_resubmit_timeout}}
if(typeof task.remaining_time==='number'&&taskCountdowns[task.task_id]){taskCountdowns[task.task_id].remaining=task.remaining_time}}})}
updateTasksList(data.tasks)
updateTasksStats(data.stats)
if(reason){console.debug(`ä»»åŠ¡åˆ—è¡¨å·²æ›´æ–°: ${reason}`)}
return true}
return false}catch(error){if(error&&(error.name==='AbortError'||error.code===20)){return false}
console.error('è·å–ä»»åŠ¡åˆ—è¡¨å¤±è´¥:',error)
return false}finally{tasksPollAbortController=null}}
function scheduleNextTasksPoll(delayMs){if(tasksPollingTimer){clearTimeout(tasksPollingTimer)
tasksPollingTimer=null}
tasksPollingTimer=setTimeout(async()=>{const ok=await fetchAndApplyTasks('poll')
if(ok){tasksPollBackoffMs=TASKS_POLL_BASE_MS}else{tasksPollBackoffMs=getNextBackoffMs(tasksPollBackoffMs)}
scheduleNextTasksPoll(tasksPollBackoffMs)},Math.max(0,delayMs))}
function startTasksPolling(){if(typeof document!=='undefined'&&document.hidden){console.log('é¡µé¢ä¸å¯è§ï¼Œè·³è¿‡å¯åŠ¨ä»»åŠ¡è½®è¯¢')
return}
stopTasksPolling()
tasksPollBackoffMs=TASKS_POLL_BASE_MS
scheduleNextTasksPoll(0)
if(!tasksPollVisibilityHandlerInstalled&&typeof document!=='undefined'){tasksPollVisibilityHandlerInstalled=true
document.addEventListener('visibilitychange',()=>{if(document.hidden){stopTasksPolling()}else{startTasksPolling()}})
window.addEventListener('beforeunload',()=>{stopTasksPolling()})}
console.log('ä»»åŠ¡åˆ—è¡¨è½®è¯¢å·²å¯åŠ¨ï¼ˆæ²»ç†ï¼šä¸å¯è§æš‚åœ/æŒ‡æ•°é€€é¿/AbortControllerï¼‰')}
function stopTasksPolling(){if(tasksPollingTimer){clearTimeout(tasksPollingTimer)
tasksPollingTimer=null
console.log('ä»»åŠ¡åˆ—è¡¨è½®è¯¢å·²åœæ­¢')}
try{if(tasksPollAbortController&&typeof tasksPollAbortController.abort==='function'){tasksPollAbortController.abort()}}catch(e){}finally{tasksPollAbortController=null}}
let isManualSwitching=false
let manualSwitchingTimer=null
Object.defineProperty(window,'isManualSwitching',{get:()=>isManualSwitching,set:val=>{isManualSwitching=val},configurable:true})
function updateTasksList(tasks){const oldTaskIds=currentTasks.map(t=>t.task_id)
const newTaskIds=tasks.map(t=>t.task_id)
const addedTasks=newTaskIds.filter(id=>!oldTaskIds.includes(id))
if(addedTasks.length>0){console.log(`âœ¨ æ£€æµ‹åˆ° ${addedTasks.length} ä¸ªæ–°ä»»åŠ¡`)
if(activeTaskId){pendingNewTaskCount+=addedTasks.length
if(newTaskHintTimer){clearTimeout(newTaskHintTimer)}
newTaskHintTimer=setTimeout(()=>{if(pendingNewTaskCount>0){showNewTaskVisualHint(pendingNewTaskCount)
pendingNewTaskCount=0}
newTaskHintTimer=null},500)}
tasks.filter(t=>addedTasks.includes(t.task_id)).forEach(task=>{if(task.status!=='completed'&&!taskCountdowns[task.task_id]){const timeout=task.remaining_time??task.auto_resubmit_timeout??250
startTaskCountdown(task.task_id,timeout,task.auto_resubmit_timeout||250)
console.log(`å·²ä¸ºæ–°ä»»åŠ¡å¯åŠ¨å€’è®¡æ—¶: ${task.task_id}, å‰©ä½™ ${timeout}s`)}})}
const removedTasks=oldTaskIds.filter(id=>!newTaskIds.includes(id))
if(removedTasks.length>0){console.log(`ğŸ—‘ï¸ æ£€æµ‹åˆ° ${removedTasks.length} ä¸ªå·²åˆ é™¤ä»»åŠ¡`)
removedTasks.forEach(taskId=>{if(taskCountdowns[taskId]){clearInterval(taskCountdowns[taskId].timer)
delete taskCountdowns[taskId]
console.log(`âœ… å·²æ¸…ç†ä»»åŠ¡ ${taskId} çš„å€’è®¡æ—¶`)}
if(window.taskDeadlines[taskId]!==undefined){delete window.taskDeadlines[taskId]}
if(taskTextareaContents[taskId]!==undefined){delete taskTextareaContents[taskId]}
if(taskOptionsStates[taskId]!==undefined){delete taskOptionsStates[taskId]}
if(taskImages[taskId]!==undefined){delete taskImages[taskId]}})}
const hasActiveTasks=tasks.length>0&&tasks.some(t=>t.status!=='completed')
currentTasks=tasks
tasks.forEach(task=>{if(task.status==='completed')return
const total=typeof task.auto_resubmit_timeout==='number'?task.auto_resubmit_timeout:250
if(total<=0){if(taskCountdowns[task.task_id]){try{if(taskCountdowns[task.task_id].timer){clearInterval(taskCountdowns[task.task_id].timer)}}catch(e){}
delete taskCountdowns[task.task_id]}
return}
if(!taskCountdowns[task.task_id]){const remaining=task.remaining_time??total
startTaskCountdown(task.task_id,remaining,total)}})
const activeTask=tasks.find(t=>t.status==='active')
if(activeTask&&activeTask.task_id!==activeTaskId){const oldActiveTaskId=activeTaskId
activeTaskId=activeTask.task_id
console.log(`åŒæ­¥activeTaskId: ${oldActiveTaskId} -> ${activeTaskId}`)
updateCountdownRingColors(oldActiveTaskId,activeTaskId)}else if(!activeTaskId&&tasks.length>0){const firstIncompleteTask=tasks.find(t=>t.status!=='completed')
if(firstIncompleteTask){activeTaskId=firstIncompleteTask.task_id
console.log(`è‡ªåŠ¨è®¾ç½®ç¬¬ä¸€ä¸ªæœªå®Œæˆä»»åŠ¡ä¸ºactive: ${activeTaskId}`)}else{console.log('æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆï¼Œä¸è®¾ç½®activeTaskId')}}else if(tasks.length===0&&activeTaskId){console.log(`âœ… ä»»åŠ¡åˆ—è¡¨å·²æ¸…ç©ºï¼Œé‡ç½® activeTaskId: ${activeTaskId} -> null`)
activeTaskId=null}
const contentContainer=document.getElementById('content-container')
const noContentContainer=document.getElementById('no-content-container')
const isShowingNoContent=noContentContainer&&noContentContainer.style.display==='flex'
if(hasActiveTasks&&isShowingNoContent){console.log('ğŸš€ æœ‰ä»»åŠ¡ä½†æ˜¾ç¤ºæ— å†…å®¹é¡µé¢ï¼Œåˆ‡æ¢åˆ°å†…å®¹é¡µé¢')
if(typeof showContentPage==='function'){showContentPage()}}else if(!hasActiveTasks&&contentContainer&&contentContainer.style.display==='block'){console.log('ğŸ“­ æ— ä»»åŠ¡ä½†æ˜¾ç¤ºå†…å®¹é¡µé¢ï¼Œåˆ‡æ¢åˆ°æ— å†…å®¹é¡µé¢')
if(typeof showNoContentPage==='function'){showNoContentPage()}}
renderTaskTabs()
if(isManualSwitching){return}
if(activeTask&&activeTask.task_id===activeTaskId){loadTaskDetails(activeTaskId)}}
function updateTasksStats(stats){return}
function renderTaskTabs(){const tabsContainer=document.getElementById('task-tabs')
const container=document.getElementById('task-tabs-container')
if(!container||!tabsContainer){console.warn('æ ‡ç­¾æ å®¹å™¨æœªæ‰¾åˆ°ï¼Œå¯èƒ½DOMè¿˜æœªåŠ è½½å®Œæˆï¼Œå°†åœ¨100msåé‡è¯•')
setTimeout(()=>{const retryContainer=document.getElementById('task-tabs-container')
const retryTabsContainer=document.getElementById('task-tabs')
if(retryContainer&&retryTabsContainer){console.log('âœ… é‡è¯•æˆåŠŸï¼Œå¼€å§‹æ¸²æŸ“æ ‡ç­¾æ ')
renderTaskTabs()}else{console.error('âŒ é‡è¯•å¤±è´¥ï¼Œæ ‡ç­¾æ å®¹å™¨ä»ç„¶æœªæ‰¾åˆ°')}},100)
return}
const incompleteTasks=currentTasks.filter(task=>task.status!=='completed')
if(incompleteTasks.length===0){container.classList.add('hidden')
return}
container.classList.remove('hidden')
const existingTabs=tabsContainer.querySelectorAll('.task-tab')
const existingTaskIds=Array.from(existingTabs).map(tab=>tab.dataset.taskId)
const currentTaskIds=currentTasks.map(t=>t.task_id)
const incompleteTaskIds=incompleteTasks.map(t=>t.task_id)
const needsRebuild=existingTaskIds.length!==incompleteTaskIds.length||existingTaskIds.some((id,i)=>id!==incompleteTaskIds[i])
if(needsRebuild){tabsContainer.innerHTML=''
incompleteTasks.forEach(task=>{const tab=createTaskTab(task)
tabsContainer.appendChild(tab)})}else{existingTabs.forEach(tab=>{const taskId=tab.dataset.taskId
const isActive=taskId===activeTaskId
tab.classList.toggle('active',isActive)})}}
function createTaskTab(task){const tab=document.createElement('div')
tab.className='task-tab'
if(task.status==='active'){tab.classList.add('active')}
tab.dataset.taskId=task.task_id
const textSpan=document.createElement('span')
textSpan.className='task-tab-text'
const taskParts=task.task_id.split('-')
const lastPart=taskParts[taskParts.length-1]
const prefixParts=taskParts.slice(0,-1).join('-')
let displayName
if(prefixParts.length>12){displayName=`${prefixParts.substring(0, 11)}... ${lastPart}`}else{displayName=`${prefixParts} ${lastPart}`}
textSpan.textContent=displayName
textSpan.title=task.task_id
tab.appendChild(textSpan)
if(task.status!=='completed'){const countdownRing=document.createElement('div')
countdownRing.className='countdown-ring'
countdownRing.id=`countdown-${task.task_id}`
let remaining,total
if(taskCountdowns[task.task_id]){remaining=taskCountdowns[task.task_id].remaining
total=taskCountdowns[task.task_id].timeout||250}else{remaining=task.remaining_time??task.auto_resubmit_timeout??250
total=task.auto_resubmit_timeout||250}
const radius=9
const circumference=2*Math.PI*radius
const progress=remaining/total
const offset=circumference*(1-progress)
const isActive=task.task_id===activeTaskId
const strokeColor=isActive?'rgba(255, 255, 255, 0.9)':'rgba(139, 92, 246, 0.9)'
countdownRing.innerHTML=`
      <svg width="22" height="22" viewBox="0 0 22 22">
        <circle
          cx="11" cy="11" r="${radius}"
          stroke="${strokeColor}"
          stroke-width="3"
          fill="none"
          stroke-dasharray="${circumference}"
          stroke-dashoffset="${offset}"
          stroke-linecap="round"
        />
      </svg>
      <span class="countdown-number">${remaining}</span>
    `
countdownRing.title=`å‰©ä½™${remaining}ç§’`
tab.appendChild(countdownRing)}
tab.onclick=()=>switchTask(task.task_id)
return tab}
async function switchTask(taskId){if(activeTaskId){const textarea=document.getElementById('feedback-text')
if(textarea){taskTextareaContents[activeTaskId]=textarea.value
console.log(`âœ… å·²ä¿å­˜ä»»åŠ¡ ${activeTaskId} çš„ textarea å†…å®¹`)}
const optionsContainer=document.getElementById('options-container')
if(optionsContainer){const checkboxes=optionsContainer.querySelectorAll('input[type="checkbox"]')
const optionsStates=[]
checkboxes.forEach((checkbox,index)=>{optionsStates[index]=checkbox.checked})
taskOptionsStates[activeTaskId]=optionsStates
console.log(`âœ… å·²ä¿å­˜ä»»åŠ¡ ${activeTaskId} çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}
taskImages[activeTaskId]=selectedImages.map(img=>({...img}))
console.log(`âœ… å·²ä¿å­˜ä»»åŠ¡ ${activeTaskId} çš„å›¾ç‰‡åˆ—è¡¨ (${selectedImages.length} å¼ )`)}
isManualSwitching=true
window.dispatchEvent(new CustomEvent('taskSwitchStart',{detail:{taskId}}))
const oldActiveTaskId=activeTaskId
activeTaskId=taskId
renderTaskTabs()
updateCountdownRingColors(oldActiveTaskId,taskId)
const cachedTask=currentTasks.find(t=>t.task_id===taskId)
if(cachedTask&&cachedTask.prompt){console.log(`ğŸš€ ä½¿ç”¨ç¼“å­˜ä»»åŠ¡ä¿¡æ¯ç«‹å³æ›´æ–°å†…å®¹: ${taskId}`)
const taskIdContainer=document.getElementById('task-id-container')
const taskIdText=document.getElementById('task-id-text')
if(taskIdContainer&&taskIdText){if(cachedTask.task_id&&cachedTask.task_id.trim()){taskIdText.textContent=cachedTask.task_id
taskIdContainer.classList.remove('hidden')}else{taskIdContainer.classList.add('hidden')}}
updateDescriptionDisplay(cachedTask.prompt)
if(cachedTask.predefined_options){updateOptionsDisplay(cachedTask.predefined_options)}}
try{fetch(`/api/tasks/${taskId}/activate`,{method:'POST'}).then(res=>res.json()).then(data=>{if(!data.success){console.error('æ¿€æ´»ä»»åŠ¡å¤±è´¥:',data.error)}else{console.log(`âœ… ä»»åŠ¡å·²æ¿€æ´»: ${taskId}`)}}).catch(err=>console.error('æ¿€æ´»ä»»åŠ¡å¤±è´¥:',err))
loadTaskDetails(taskId).catch(err=>{console.warn('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥ï¼Œä½†UIå·²ä»ç¼“å­˜æ›´æ–°:',err)})}catch(error){console.error('åˆ‡æ¢ä»»åŠ¡å¤±è´¥:',error)}finally{if(manualSwitchingTimer){clearTimeout(manualSwitchingTimer)}
manualSwitchingTimer=setTimeout(()=>{isManualSwitching=false
manualSwitchingTimer=null
window.dispatchEvent(new CustomEvent('taskSwitchComplete',{detail:{taskId}}))
console.log('âœ… ä»»åŠ¡åˆ‡æ¢é”å®šå·²è§£é™¤ï¼Œå…è®¸è½®è¯¢æ¢å¤')},200)}}
function updateCountdownRingColors(oldActiveTaskId,newActiveTaskId){if(oldActiveTaskId){const oldRing=document.getElementById(`countdown-${oldActiveTaskId}`)
if(oldRing){const oldCircle=oldRing.querySelector('circle')
if(oldCircle){oldCircle.setAttribute('stroke','rgba(139, 92, 246, 0.9)')}}}
if(newActiveTaskId){const newRing=document.getElementById(`countdown-${newActiveTaskId}`)
if(newRing){const newCircle=newRing.querySelector('circle')
if(newCircle){newCircle.setAttribute('stroke','rgba(255, 255, 255, 0.9)')}}}}
async function loadTaskDetails(taskId){try{const response=await fetch(`/api/tasks/${taskId}`)
const data=await response.json()
if(taskId!==activeTaskId){console.log(`â­ï¸ è·³è¿‡è¿‡æœŸçš„ä»»åŠ¡è¯¦æƒ…: ${taskId}ï¼ˆå½“å‰æ´»åŠ¨: ${activeTaskId}ï¼‰`)
return}
if(data.success){const task=data.task
const taskIdContainer=document.getElementById('task-id-container')
const taskIdText=document.getElementById('task-id-text')
if(taskIdContainer&&taskIdText){if(task.task_id&&task.task_id.trim()){taskIdText.textContent=task.task_id
taskIdContainer.classList.remove('hidden')}else{taskIdContainer.classList.add('hidden')}}
updateDescriptionDisplay(task.prompt)
updateOptionsDisplay(task.predefined_options)
const textarea=document.getElementById('feedback-text')
if(textarea&&taskTextareaContents[taskId]!==undefined){textarea.value=taskTextareaContents[taskId]
console.log(`âœ… å·²æ¢å¤ä»»åŠ¡ ${taskId} çš„ textarea å†…å®¹`)}
if(taskImages[taskId]&&taskImages[taskId].length>0){selectedImages=taskImages[taskId].map(img=>({...img}))
const previewContainer=document.getElementById('image-previews')
if(previewContainer){previewContainer.innerHTML=''
selectedImages.forEach(imageItem=>{renderImagePreview(imageItem,false)})
updateImageCounter()
updateImagePreviewVisibility()}
console.log(`âœ… å·²æ¢å¤ä»»åŠ¡ ${taskId} çš„å›¾ç‰‡åˆ—è¡¨ (${selectedImages.length} å¼ )`)}
if(!taskCountdowns[task.task_id]){const remaining=task.remaining_time??task.auto_resubmit_timeout
const total=task.auto_resubmit_timeout
startTaskCountdown(task.task_id,remaining,total)
console.log(`é¦–æ¬¡å¯åŠ¨å€’è®¡æ—¶: ${taskId}, å‰©ä½™ ${remaining}s / æ€» ${total}s`)}else{console.log(`å€’è®¡æ—¶å·²å­˜åœ¨ï¼Œä¸é‡ç½®: ${taskId}`)}
console.log(`å·²åŠ è½½ä»»åŠ¡è¯¦æƒ…: ${taskId}`)}else{console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:',data.error)}}catch(error){console.error('åŠ è½½ä»»åŠ¡è¯¦æƒ…å¤±è´¥:',error)}}
async function updateDescriptionDisplay(prompt){const descriptionElement=document.getElementById('description')
if(!descriptionElement)return
try{let htmlContent=prompt
if(typeof marked!=='undefined'){try{htmlContent=marked.parse(prompt)}catch(e){console.warn('marked.js è§£æå¤±è´¥:',e)}}
descriptionElement.innerHTML=htmlContent
if(typeof Prism!=='undefined'){Prism.highlightAllUnder(descriptionElement)}
if(typeof processCodeBlocks==='function'){processCodeBlocks(descriptionElement)}
if(typeof processStrikethrough==='function'){processStrikethrough(descriptionElement)}
console.log('âœ… åŒæ­¥æ¸²æŸ“ Markdown å®Œæˆ')
const textContent=descriptionElement.textContent||''
if(window.loadMathJaxIfNeeded){window.loadMathJaxIfNeeded(descriptionElement,textContent)}else if(window.MathJax&&window.MathJax.typesetPromise){window.MathJax.typesetPromise([descriptionElement]).catch(err=>{console.warn('MathJax æ¸²æŸ“å¤±è´¥:',err)})}}catch(error){console.error('æ›´æ–°æè¿°å¤±è´¥:',error)
descriptionElement.textContent=prompt}}
function updateOptionsDisplay(options){const optionsContainer=document.getElementById('options-container')
if(!optionsContainer)return
let selectedStates={}
if(activeTaskId&&taskOptionsStates[activeTaskId]){selectedStates=taskOptionsStates[activeTaskId]
console.log(`âœ… å·²æ¢å¤ä»»åŠ¡ ${activeTaskId} çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}else{const existingCheckboxes=optionsContainer.querySelectorAll('input[type="checkbox"]')
existingCheckboxes.forEach(checkbox=>{selectedStates[checkbox.id]=checkbox.checked})}
optionsContainer.innerHTML=''
if(options&&options.length>0){options.forEach((option,index)=>{const optionDiv=document.createElement('div')
optionDiv.className='option-item'
const checkbox=document.createElement('input')
checkbox.type='checkbox'
checkbox.id=`option-${index}`
checkbox.value=option
const checkboxId=`option-${index}`
if(selectedStates[checkboxId]||selectedStates[index]){checkbox.checked=true}
const label=document.createElement('label')
label.htmlFor=`option-${index}`
label.textContent=option
optionDiv.appendChild(checkbox)
optionDiv.appendChild(label)
optionsContainer.appendChild(optionDiv)})
optionsContainer.classList.remove('hidden')
optionsContainer.classList.add('visible')
const separator=document.getElementById('separator')
if(separator){separator.classList.remove('hidden')
separator.classList.add('visible')}}else{optionsContainer.classList.add('hidden')
optionsContainer.classList.remove('visible')}}
async function closeTask(taskId){if(!confirm(`ç¡®å®šè¦å…³é—­ä»»åŠ¡ ${taskId} å—ï¼Ÿ`)){return}
try{if(taskCountdowns[taskId]){clearInterval(taskCountdowns[taskId].timer)
delete taskCountdowns[taskId]}
if(taskTextareaContents[taskId]!==undefined){delete taskTextareaContents[taskId]
console.log(`âœ… [å…³é—­ä»»åŠ¡] å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„ textarea å†…å®¹`)}
if(taskOptionsStates[taskId]!==undefined){delete taskOptionsStates[taskId]
console.log(`âœ… [å…³é—­ä»»åŠ¡] å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}
if(taskImages[taskId]!==undefined){delete taskImages[taskId]
console.log(`âœ… [å…³é—­ä»»åŠ¡] å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„å›¾ç‰‡åˆ—è¡¨`)}
currentTasks=currentTasks.filter(t=>t.task_id!==taskId)
renderTaskTabs()
if(activeTaskId===taskId&&currentTasks.length>0){switchTask(currentTasks[0].task_id)}
console.log(`å·²å…³é—­ä»»åŠ¡: ${taskId}`)}catch(error){console.error('å…³é—­ä»»åŠ¡å¤±è´¥:',error)}}
function startTaskCountdown(taskId,remaining,total=null){const timeout=total||remaining
if(taskCountdowns[taskId]&&taskCountdowns[taskId].timer){clearInterval(taskCountdowns[taskId].timer)}
taskCountdowns[taskId]={remaining:remaining,timeout:timeout,timer:null}
if(taskId===activeTaskId){updateCountdownDisplay(remaining)}
function calculateRemainingFromDeadline(){const deadline=window.taskDeadlines[taskId]
if(deadline){const adjustedNow=Date.now()/1000+(window.serverTimeOffset||0)
return Math.max(0,Math.floor(deadline-adjustedNow))}
return taskCountdowns[taskId].remaining-1}
taskCountdowns[taskId].timer=setInterval(()=>{const newRemaining=calculateRemainingFromDeadline()
taskCountdowns[taskId].remaining=newRemaining
const countdownRing=document.getElementById(`countdown-${taskId}`)
if(countdownRing){const remaining=taskCountdowns[taskId].remaining
const total=taskCountdowns[taskId].timeout||250
const progress=remaining/total
const radius=9
const circumference=2*Math.PI*radius
const offset=circumference*(1-progress)
const circle=countdownRing.querySelector('circle')
const numberSpan=countdownRing.querySelector('.countdown-number')
if(circle){circle.setAttribute('stroke-dashoffset',offset)}
if(numberSpan){numberSpan.textContent=remaining}
countdownRing.title=`å‰©ä½™${remaining}ç§’`}
if(taskId===activeTaskId){updateCountdownDisplay(taskCountdowns[taskId].remaining)}
if(taskCountdowns[taskId].remaining<=0){clearInterval(taskCountdowns[taskId].timer)
if(taskId===activeTaskId){autoSubmitTask(taskId)}else{if(!activeTaskId){console.log(`éæ¿€æ´»ä»»åŠ¡ ${taskId} è¶…æ—¶ï¼Œä¸”æ— æ´»åŠ¨ä»»åŠ¡ï¼Œè‡ªåŠ¨æäº¤`)
autoSubmitTask(taskId)}else{console.log(`ä»»åŠ¡ ${taskId} è¶…æ—¶ï¼Œä½†ç”¨æˆ·æ­£åœ¨å¤„ç†å…¶ä»–ä»»åŠ¡ ${activeTaskId}ï¼Œæš‚ä¸è‡ªåŠ¨æäº¤`)}}}},1000)
console.log(`å·²å¯åŠ¨ä»»åŠ¡å€’è®¡æ—¶: ${taskId}, å‰©ä½™ ${remaining}s / æ€» ${timeout}s`)}
function formatCountdown(seconds){if(seconds>60){return`${Math.floor(seconds / 60)}m`}
return`${seconds}s`}
async function autoSubmitTask(taskId){console.log(`ä»»åŠ¡ ${taskId} å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨æäº¤`)
const prompts=await fetchFeedbackPromptsFresh()
const defaultMessage=prompts&&prompts.resubmit_prompt?prompts.resubmit_prompt:'è¯·ç«‹å³è°ƒç”¨ interactive_feedback å·¥å…·'
await submitTaskFeedback(taskId,defaultMessage,[])}
async function submitTaskFeedback(taskId,feedbackText,selectedOptions){try{const formData=new FormData()
formData.append('feedback_text',feedbackText)
formData.append('selected_options',JSON.stringify(selectedOptions))
selectedImages.forEach((img,index)=>{if(img.file){formData.append(`image_${index}`,img.file)}})
const response=await fetch(`/api/tasks/${taskId}/submit`,{method:'POST',body:formData})
const data=await response.json()
if(data.success){console.log(`ä»»åŠ¡ ${taskId} æäº¤æˆåŠŸ`)
if(taskCountdowns[taskId]){clearInterval(taskCountdowns[taskId].timer)
delete taskCountdowns[taskId]}
if(taskTextareaContents[taskId]!==undefined){delete taskTextareaContents[taskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„ textarea å†…å®¹`)}
if(taskOptionsStates[taskId]!==undefined){delete taskOptionsStates[taskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„é€‰é¡¹å‹¾é€‰çŠ¶æ€`)}
if(taskImages[taskId]!==undefined){delete taskImages[taskId]
console.log(`âœ… å·²æ¸…é™¤ä»»åŠ¡ ${taskId} ä¿å­˜çš„å›¾ç‰‡åˆ—è¡¨`)}
setTimeout(async()=>{await refreshTasksList()
const nextTask=currentTasks.find(t=>t.task_id!==taskId&&t.status!=='completed')
if(nextTask){console.log(`ğŸ”„ è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡: ${nextTask.task_id}`)
switchTask(nextTask.task_id)}else{console.log(`âœ… æ‰€æœ‰ä»»åŠ¡å·²å®Œæˆ`)}},300)}else{console.error('æäº¤ä»»åŠ¡å¤±è´¥:',data.error)}}catch(error){console.error('æäº¤ä»»åŠ¡åé¦ˆå¤±è´¥:',error)}}
function showNewTaskVisualHint(count){const container=document.getElementById('task-tabs-container')
if(!container)return
const html=document.documentElement
const currentTheme=html.getAttribute('data-theme')
const isLightTheme=currentTheme==='light'
const createSvg=`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" style="flex-shrink: 0; margin-right: 10px;"><path d="M15.5117 1.99707C15.9213 2.0091 16.3438 2.13396 16.6768 2.46679C17.0278 2.81814 17.1209 3.26428 17.0801 3.68261C17.0404 4.08745 16.8765 4.49344 16.6787 4.85058C16.3934 5.36546 15.9941 5.85569 15.6348 6.20898C15.7682 6.41421 15.8912 6.66414 15.9551 6.9453C16.0804 7.4977 15.9714 8.13389 15.4043 8.70116C14.8566 9.24884 13.974 9.54823 13.1943 9.71679C12.7628 9.81003 12.3303 9.86698 11.9473 9.90233C12.0596 10.2558 12.0902 10.7051 11.8779 11.2012L11.8223 11.3203C11.5396 11.8854 11.0275 12.2035 10.4785 12.3965C9.93492 12.5875 9.29028 12.6792 8.65332 12.75C7.99579 12.8231 7.34376 12.8744 6.70117 12.9775C6.14371 13.067 5.63021 13.1903 5.18652 13.3818L5.00585 13.4658C4.53515 14.2245 4.13745 14.9658 3.80957 15.6465C4.43885 15.2764 5.1935 15 5.99999 15C6.27614 15 6.49999 15.2238 6.49999 15.5C6.49999 15.7761 6.27613 16 5.99999 16C5.35538 16 4.71132 16.2477 4.15039 16.6103C3.58861 16.9736 3.14957 17.427 2.91601 17.7773C2.91191 17.7835 2.90568 17.788 2.90136 17.7939C2.88821 17.8119 2.8746 17.8289 2.85937 17.8447C2.85117 17.8533 2.84268 17.8612 2.83398 17.8691C2.81803 17.8835 2.80174 17.897 2.78417 17.9092C2.774 17.9162 2.76353 17.9225 2.75292 17.9287C2.73854 17.9372 2.72412 17.9451 2.70898 17.9521C2.69079 17.9605 2.6723 17.9675 2.65332 17.9736C2.6417 17.9774 2.63005 17.9805 2.61816 17.9834C2.60263 17.9872 2.5871 17.9899 2.57128 17.9922C2.55312 17.9948 2.53511 17.9974 2.5166 17.998C2.50387 17.9985 2.49127 17.9976 2.47851 17.9971C2.45899 17.9962 2.43952 17.9954 2.41992 17.9922C2.40511 17.9898 2.39062 17.9862 2.37597 17.9824C2.36477 17.9795 2.35294 17.9783 2.34179 17.9746C2.33697 17.973 2.33286 17.9695 2.32812 17.9678C2.31042 17.9612 2.29351 17.953 2.27636 17.9443C2.26332 17.9378 2.25053 17.9314 2.23828 17.9238C2.23339 17.9208 2.22747 17.9192 2.22265 17.916C2.21414 17.9103 2.20726 17.9026 2.19921 17.8965C2.18396 17.8849 2.16896 17.8735 2.15527 17.8603C2.14518 17.8507 2.13609 17.8404 2.12695 17.8301C2.11463 17.8161 2.10244 17.8023 2.09179 17.7871C2.08368 17.7756 2.07736 17.7631 2.07031 17.751C2.06168 17.7362 2.05297 17.7216 2.04589 17.706C2.03868 17.6901 2.03283 17.6738 2.02734 17.6572C2.0228 17.6436 2.01801 17.6302 2.01464 17.6162C2.01117 17.6017 2.009 17.587 2.00683 17.5722C2.00411 17.5538 2.00161 17.5354 2.00097 17.5166C2.00054 17.5039 2.00141 17.4912 2.00195 17.4785C2.00279 17.459 2.00364 17.4395 2.00683 17.4199C2.00902 17.4064 2.01327 17.3933 2.0166 17.3799C2.01973 17.3673 2.02123 17.3543 2.02539 17.3418C2.41772 16.1648 3.18163 14.466 4.30468 12.7012C4.31908 12.5557 4.34007 12.3582 4.36914 12.1201C4.43379 11.5907 4.53836 10.8564 4.69921 10.0381C5.0174 8.41955 5.56814 6.39783 6.50585 4.9912L6.73242 4.66894C7.27701 3.93277 7.93079 3.30953 8.61035 2.85156C9.3797 2.33311 10.2221 2 11.001 2C11.7951 2.00025 12.3531 2.35795 12.7012 2.70605C12.7723 2.77723 12.8348 2.84998 12.8896 2.91796C13.2829 2.66884 13.7917 2.39502 14.3174 2.21191C14.6946 2.08056 15.1094 1.98537 15.5117 1.99707ZM17.04 15.5537C17.1486 15.3 17.4425 15.1818 17.6963 15.29C17.95 15.3986 18.0683 15.6925 17.96 15.9463C17.4827 17.0612 16.692 18 15.5 18C14.6309 17.9999 13.9764 17.5003 13.5 16.7978C13.0236 17.5003 12.3691 18 11.5 18C10.6309 17.9999 9.97639 17.5003 9.49999 16.7978C9.02359 17.5003 8.36911 18 7.49999 18C7.22391 17.9999 7 17.7761 6.99999 17.5C6.99999 17.2239 7.22391 17 7.49999 17C8.07039 17 8.6095 16.5593 9.04003 15.5537L9.07421 15.4873C9.16428 15.3412 9.32494 15.25 9.49999 15.25C9.70008 15.25 9.88121 15.3698 9.95996 15.5537L10.042 15.7353C10.4581 16.6125 10.9652 16.9999 11.5 17C12.0704 17 12.6095 16.5593 13.04 15.5537L13.0742 15.4873C13.1643 15.3412 13.3249 15.25 13.5 15.25C13.7001 15.25 13.8812 15.3698 13.96 15.5537L14.042 15.7353C14.4581 16.6125 14.9652 16.9999 15.5 17C16.0704 17 16.6095 16.5593 17.04 15.5537ZM15.4824 2.99707C15.247 2.99022 14.9608 3.04682 14.6465 3.15624C14.0173 3.37541 13.389 3.76516 13.0498 4.01953C12.9277 4.11112 12.7697 4.14131 12.6221 4.10253C12.4745 4.06357 12.3522 3.9591 12.291 3.81933V3.81835C12.2892 3.81468 12.2861 3.80833 12.2822 3.80078C12.272 3.78092 12.2541 3.7485 12.2295 3.70898C12.1794 3.62874 12.1011 3.52019 11.9941 3.41308C11.7831 3.2021 11.4662 3.00024 11.001 2.99999C10.4904 2.99999 9.84173 3.22729 9.16894 3.68066C8.58685 4.07297 8.01568 4.61599 7.5371 5.26269L7.33789 5.54589C6.51634 6.77827 5.99475 8.63369 5.68066 10.2314C5.63363 10.4707 5.5913 10.7025 5.55371 10.9238C7.03031 9.01824 8.94157 7.19047 11.2812 6.05077C11.5295 5.92989 11.8283 6.03301 11.9492 6.28124C12.0701 6.52949 11.967 6.82829 11.7187 6.94921C9.33153 8.11208 7.38648 10.0746 5.91406 12.1103C6.12313 12.0632 6.33385 12.0238 6.54296 11.9902C7.21709 11.8821 7.92723 11.8243 8.54296 11.7558C9.17886 11.6852 9.72123 11.6025 10.1465 11.4531C10.5662 11.3056 10.8063 11.1158 10.9277 10.873L10.9795 10.7549C11.0776 10.487 11.0316 10.2723 10.9609 10.1123C10.918 10.0155 10.8636 9.93595 10.8203 9.88183C10.7996 9.85598 10.7822 9.83638 10.7715 9.82518L10.7607 9.81542L10.7627 9.8164L10.7646 9.81835C10.6114 9.67972 10.5597 9.46044 10.6338 9.26757C10.7082 9.07475 10.8939 8.94726 11.1006 8.94726C11.5282 8.94719 12.26 8.8956 12.9834 8.73925C13.7297 8.5779 14.3654 8.32602 14.6973 7.99413C15.0087 7.68254 15.0327 7.40213 14.9795 7.16698C14.9332 6.96327 14.8204 6.77099 14.707 6.62792L14.5957 6.50195C14.4933 6.39957 14.4401 6.25769 14.4502 6.11327C14.4605 5.96888 14.5327 5.83599 14.6484 5.74902C14.9558 5.51849 15.4742 4.96086 15.8037 4.3662C15.9675 4.07048 16.0637 3.80137 16.085 3.58593C16.1047 3.38427 16.0578 3.26213 15.9697 3.17382C15.8631 3.06726 15.7102 3.00377 15.4824 2.99707Z" fill="#d97757"/></svg>`
const themeStyles=isLightTheme?{background:'linear-gradient(135deg, #faf9f5 0%, #f2f1ec 100%)',color:'#131314',border:'1px solid rgba(217, 119, 87, 0.4)',boxShadow:'0 8px 24px rgba(0, 0, 0, 0.12), 0 0 0 1px rgba(217, 119, 87, 0.15)'}:{background:'rgba(45, 45, 60, 0.95)',color:'rgba(245, 245, 247, 0.95)',border:'1px solid rgba(255, 255, 255, 0.08)',boxShadow:'0 8px 24px rgba(0, 0, 0, 0.35)'}
const hint=document.createElement('div')
hint.id='new-task-hint'
hint.style.cssText=`
    position: fixed;
    top: 20px;
    right: 20px;
    display: flex;
    align-items: center;
    background: ${themeStyles.background};
    color: ${themeStyles.color};
    padding: 14px 20px;
    border-radius: 12px;
    border: ${themeStyles.border};
    box-shadow: ${themeStyles.boxShadow};
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.02em;
    z-index: 10000;
    animation: slideInRight 0.3s cubic-bezier(0.34, 1.56, 0.64, 1), fadeOutUp 0.3s ease-in 2.7s forwards;
    pointer-events: none;
  `
hint.innerHTML=`${createSvg}<span>${count} ä¸ªæ–°ä»»åŠ¡å·²åˆ°è¾¾</span>`
document.body.appendChild(hint)
setTimeout(()=>{if(hint.parentNode){hint.parentNode.removeChild(hint)}},3000)
console.log(`æ˜¾ç¤ºæ–°ä»»åŠ¡è§†è§‰æç¤º: ${count} ä¸ªæ–°ä»»åŠ¡`)}
function showNewTaskNotification(count){showNewTaskVisualHint(count)
if(typeof notificationManager!=='undefined'){notificationManager.sendNotification('AI Intervention Agent',`æ”¶åˆ° ${count} ä¸ªæ–°ä»»åŠ¡`,{tag:'new-tasks',requireInteraction:false}).catch(error=>{console.warn('å‘é€æ–°ä»»åŠ¡é€šçŸ¥å¤±è´¥:',error)})}}
async function initMultiTaskSupport(){console.log('åˆå§‹åŒ–å¤šä»»åŠ¡æ”¯æŒ...')
await fetchFeedbackPromptsFresh()
await refreshTasksList()
startTasksPolling()
setInterval(()=>{if(typeof document!=='undefined'&&document.hidden){return}
if(!tasksPollingTimer){console.warn('âš ï¸ ä»»åŠ¡è½®è¯¢å·²åœæ­¢,è‡ªåŠ¨é‡æ–°å¯åŠ¨')
startTasksPolling()}},30000)
const textarea=document.getElementById('feedback-text')
if(textarea){textarea.addEventListener('input',()=>{if(activeTaskId){taskTextareaContents[activeTaskId]=textarea.value}})
console.log('âœ… å·²å¯ç”¨ textarea å®æ—¶ä¿å­˜')}
const optionsContainer=document.getElementById('options-container')
if(optionsContainer){optionsContainer.addEventListener('change',event=>{if(event.target.type==='checkbox'&&activeTaskId){const checkboxes=optionsContainer.querySelectorAll('input[type="checkbox"]')
const states={}
checkboxes.forEach(cb=>{states[cb.id]=cb.checked})
taskOptionsStates[activeTaskId]=states}})
console.log('âœ… å·²å¯ç”¨é€‰é¡¹çŠ¶æ€å®æ—¶ä¿å­˜')}
console.log('å¤šä»»åŠ¡æ”¯æŒåˆå§‹åŒ–å®Œæˆ (åŒ…å«è½®è¯¢å¥åº·æ£€æŸ¥å’Œå®æ—¶ä¿å­˜)')}
async function refreshTasksList(){const ok=await fetchAndApplyTasks('manual')
if(ok){tasksPollBackoffMs=TASKS_POLL_BASE_MS
console.log('ä»»åŠ¡åˆ—è¡¨å·²æ‰‹åŠ¨åˆ·æ–°')}
if(!tasksPollingTimer&&!(typeof document!=='undefined'&&document.hidden)){startTasksPolling()}}
if(typeof window!=='undefined'){window.multiTaskModule={startTasksPolling,stopTasksPolling,switchTask,closeTask,initMultiTaskSupport,refreshTasksList}
window.refreshTasksList=refreshTasksList}
if(typeof document!=='undefined'&&typeof document.addEventListener==='function'){document.addEventListener('DOMContentLoaded',()=>{fetchFeedbackPromptsFresh()})}