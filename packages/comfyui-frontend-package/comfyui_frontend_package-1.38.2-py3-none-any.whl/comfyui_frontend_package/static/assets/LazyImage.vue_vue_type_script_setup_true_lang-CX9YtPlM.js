var pe=Object.defineProperty;var m=(i,e)=>pe(i,"name",{value:e,configurable:!0});import{cT as j,a as C,c as W,_ as V,k as me,cz as fe,l as ge,h as K,s as ve,u as ae,d as se,m as he}from"./index-Bc79VbnU.js";import{b as re,E as B,a as be,a2 as I,dk as H,dl as q,j as F,d as u,a8 as p,m as ye,k as y,e as r,G as te,c as g,q as _,u as c,p as we,dE as _e,d4 as $e,z as k,w as R,dD as ke,fa as Me,r as x,A as D,F as Ue,f as ne,o as xe,bV as Se,d$ as Ce,Z as Fe,L as Ie,s as z,l as Ve,dT as Be,dN as Le,_ as je}from"./vendor-other-Dsj-QuOx.js";import{i as De,y as Ee,e as ie,a as Ae}from"./vendor-primevue-Cif--Rbw.js";import{b as de}from"./vendor-vue-DNQSPQQ2.js";function A(){const i=re({get supportsPreviewMetadata(){return C.getServerFeature("supports_preview_metadata")},get maxUploadSize(){return C.getServerFeature("max_upload_size")},get supportsManagerV4(){return C.getServerFeature("extension.manager.supports_v4")},get modelUploadButtonEnabled(){return j.value.model_upload_button_enabled??C.getServerFeature("model_upload_button_enabled",!1)},get assetDeletionEnabled(){return j.value.asset_deletion_enabled??C.getServerFeature("asset_deletion_enabled",!1)},get assetRenameEnabled(){return j.value.asset_rename_enabled??C.getServerFeature("asset_rename_enabled",!1)},get privateModelsEnabled(){return j.value.private_models_enabled??C.getServerFeature("private_models_enabled",!1)},get onboardingSurveyEnabled(){return j.value.onboarding_survey_enabled??C.getServerFeature("onboarding_survey_enabled",!0)},get huggingfaceModelImportEnabled(){return j.value.huggingface_model_import_enabled??C.getServerFeature("huggingface_model_import_enabled",!1)},get linearToggleEnabled(){return j.value.linear_toggle_enabled??C.getServerFeature("linear_toggle_enabled",!1)},get asyncModelUploadEnabled(){return j.value.async_model_upload_enabled??C.getServerFeature("async_model_upload_enabled",!1)}}),e=m((n,o)=>B(()=>C.getServerFeature(n,o)),"featureFlag");return{flags:be(i),featureFlag:e}}m(A,"useFeatureFlags");const ze={class:"flex items-center gap-2 text-sm"},Re={key:0,class:"text-base-foreground"},Te={key:1,class:"text-base-foreground"},Pe={class:"truncate"},We={key:0,class:"icon-[lucide--check] text-base-foreground"},He=I({inheritAttrs:!1,__name:"SingleSelect",props:H({label:{},options:{},listMaxHeight:{default:"28rem"},popoverMinWidth:{},popoverMaxWidth:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=q(i,"modelValue"),{t:n}=de(),o=m(l=>{if(l==null||!i.options)return i.label??"";const t=i.options.find(s=>s.value===l);return t?t.name:i.label??""},"getLabel"),a=B(()=>{if(!i.popoverMinWidth&&!i.popoverMaxWidth)return;const l=[];return i.popoverMinWidth&&l.push(`min-width: ${i.popoverMinWidth}`),i.popoverMaxWidth&&l.push(`max-width: ${i.popoverMaxWidth}`),l.join("; ")});return(l,t)=>(u(),F(p(De),ye({modelValue:e.value,"onUpdate:modelValue":t[0]||(t[0]=s=>e.value=s)},l.$attrs,{options:l.options,"option-label":"name","option-value":"value",unstyled:"",pt:{root:m(({props:s})=>({class:["h-10 relative inline-flex cursor-pointer select-none items-center","rounded-lg","bg-secondary-background text-base-foreground","border-[2.5px] border-solid border-transparent","transition-all duration-200 ease-in-out","focus-within:border-node-component-border",{"opacity-60 cursor-default":s.disabled}]}),"root"),label:{class:"flex-1 flex items-center whitespace-nowrap pl-4 py-2 outline-hidden"},dropdown:{class:"flex shrink-0 items-center justify-center px-3 py-2"},overlay:{class:p(W)("mt-2 p-2 rounded-lg","bg-base-background text-base-foreground","border border-solid border-border-default")},listContainer:m(()=>({style:`max-height: min(${l.listMaxHeight}, 50vh)`,class:"scrollbar-custom"}),"listContainer"),list:{class:"flex flex-col gap-0 p-0 m-0 list-none border-none text-sm"},option:m(({context:s})=>({class:p(W)("flex items-center justify-between gap-3 px-2 py-3 rounded","hover:bg-secondary-background-hover",s.focused&&"bg-secondary-background-hover",s.selected&&"bg-secondary-background-selected hover:bg-secondary-background-selected")}),"option"),optionLabel:{class:"truncate"},optionGroupLabel:{class:"px-3 py-2 text-xs uppercase tracking-wide text-muted-foreground"},emptyMessage:{class:"px-3 py-2 text-sm text-muted-foreground"}},"aria-label":l.label||p(n)("g.singleSelectDropdown"),role:"combobox","aria-expanded":!1,"aria-haspopup":"listbox",tabindex:0}),{value:y(s=>[r("div",ze,[we(l.$slots,"icon"),s.value!==null&&s.value!==void 0?(u(),g("span",Re,c(o(s.value)),1)):(u(),g("span",Te,c(l.label),1))])]),dropdownicon:y(()=>t[1]||(t[1]=[r("i",{class:"icon-[lucide--chevron-down] text-muted-foreground"},null,-1)])),option:y(({option:s,selected:d})=>[r("div",{class:"flex w-full items-center justify-between gap-3",style:te(a.value)},[r("span",Pe,c(s.name),1),d?(u(),g("i",We)):_("",!0)],4)]),_:3},16,["modelValue","options","pt","aria-label"]))}});function qe(i){const e={loras:"LoRA",ipadapter:"IP-Adapter",sams:"SAM",clip_vision:"CLIP Vision",animatediff_motion_lora:"AnimateDiff Motion LoRA",animatediff_models:"AnimateDiff Model",vae:"VAE",sam2:"SAM 2",controlnet:"ControlNet",gligen:"GLIGEN"};return e[i]?e[i]:i.split("_").map(n=>n.charAt(0).toUpperCase()+n.slice(1)).join(" ")}m(qe,"formatDisplayName");const Oe=["nlf"],ue=_e(()=>{const{state:i,isLoading:e,error:n,execute:o}=$e(async()=>(await C.getModelFolders()).filter(l=>!Oe.includes(l.name)).map(l=>({name:qe(l.name),value:l.name})).sort((l,t)=>l.name.localeCompare(t.name)),[],{immediate:!1,onError:m(a=>{console.error("Failed to fetch model types:",a)},"onError")});return{modelTypes:i,isLoading:e,error:n,fetchModelTypes:o}}),Ne={class:"flex flex-col gap-4 text-sm text-muted-foreground"},Ge={class:"flex flex-col gap-2"},Ke={class:"m-0"},Qe={class:"flex items-center gap-3 rounded-lg bg-secondary-background px-4 py-2"},Ye=["src","alt"],Ze={class:"m-0 min-w-0 flex-1 truncate text-base-foreground"},Je={class:"flex flex-col gap-2"},Xe={class:"flex items-center gap-2"},et={class:"text-muted-foreground"},tt=I({__name:"UploadModelConfirmation",props:H({metadata:{},previewImage:{}},{modelValue:{},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=q(i,"modelValue"),{modelTypes:n,isLoading:o}=ue();return(a,l)=>(u(),g("div",Ne,[r("div",Ge,[r("p",Ke,c(a.$t("assetBrowser.modelAssociatedWithLink")),1),r("div",Qe,[a.previewImage?(u(),g("img",{key:0,src:a.previewImage,alt:a.metadata?.filename||a.metadata?.name||"Model preview",class:"size-14 flex-shrink-0 rounded object-cover"},null,8,Ye)):_("",!0),r("p",Ze,c(a.metadata?.filename||a.metadata?.name),1)])]),r("div",Je,[r("div",Xe,[r("label",null,c(a.$t("assetBrowser.modelTypeSelectorLabel")),1),l[1]||(l[1]=r("i",{class:"icon-[lucide--circle-question-mark] text-muted-foreground"},null,-1)),r("span",et,c(a.$t("assetBrowser.notSureLeaveAsIs")),1)]),k(He,{modelValue:e.value,"onUpdate:modelValue":l[0]||(l[0]=t=>e.value=t),label:p(o)?a.$t("g.loading"):a.$t("assetBrowser.modelTypeSelectorPlaceholder"),options:p(n),disabled:p(o),"data-attr":"upload-model-step2-type-selector"},null,8,["modelValue","label","options","disabled"])])]))}}),at={class:"relative"},st=["aria-label","src"],le=I({__name:"VideoHelpDialog",props:H({videoUrl:{},ariaLabel:{default:"Help video"}},{modelValue:{type:Boolean,required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=q(i,"modelValue"),n=m(o=>{o.key==="Escape"&&(o.stopImmediatePropagation(),o.stopPropagation(),o.preventDefault(),e.value=!1)},"handleEscapeKey");return R(e,o=>{if(o){const a=ke(document,"keydown",n,{capture:!0});Me(a)}},{immediate:!0}),(o,a)=>(u(),F(p(Ee),{visible:e.value,"onUpdate:visible":a[1]||(a[1]=l=>e.value=l),modal:"",closable:!1,"close-on-escape":!1,"dismissable-mask":!0,pt:{root:{class:"video-help-dialog"},header:{class:"!hidden"},content:{class:"!p-0"},mask:{class:"!bg-black/70"}},style:{width:"90vw"}},{default:y(()=>[r("div",at,[k(V,{variant:"textonly",size:"icon",class:"absolute top-4 right-6 z-10","aria-label":o.$t("g.close"),onClick:a[0]||(a[0]=l=>e.value=!1)},{default:y(()=>a[2]||(a[2]=[r("i",{class:"pi pi-times text-sm"},null,-1)])),_:1},8,["aria-label"]),r("video",{autoplay:"",muted:"",loop:"","aria-label":o.ariaLabel,class:"w-full rounded-lg",src:o.videoUrl},c(o.$t("g.videoFailedToLoad")),9,st)])]),_:1},8,["visible"]))}}),ot={class:"flex justify-end gap-2 w-full"},lt={key:0,class:"mr-auto flex items-center gap-2"},rt={key:4},nt={key:0,class:"icon-[lucide--loader-circle] animate-spin"},it={key:0,class:"icon-[lucide--loader-circle] animate-spin"},dt=I({__name:"UploadModelFooter",props:{currentStep:{},isFetchingMetadata:{type:Boolean},isUploading:{type:Boolean},canFetchMetadata:{type:Boolean},canUploadModel:{type:Boolean},uploadStatus:{}},emits:["back","fetchMetadata","upload","close","importAnother"],setup(i,{emit:e}){const{flags:n}=A(),o=x(!1),a=x(!1),l=e;return(t,s)=>(u(),g("div",ot,[t.currentStep===1&&p(n).huggingfaceModelImportEnabled?(u(),g("div",lt,[s[11]||(s[11]=r("i",{class:"icon-[lucide--circle-question-mark] text-muted-foreground"},null,-1)),k(V,{variant:"muted-textonly",size:"sm","data-attr":"upload-model-step1-help-civitai",onClick:s[0]||(s[0]=d=>o.value=!0)},{default:y(()=>[D(c(t.$t("assetBrowser.providerCivitai")),1)]),_:1}),k(V,{variant:"muted-textonly",size:"sm","data-attr":"upload-model-step1-help-huggingface",onClick:s[1]||(s[1]=d=>a.value=!0)},{default:y(()=>[D(c(t.$t("assetBrowser.providerHuggingFace")),1)]),_:1})])):t.currentStep===1?(u(),F(V,{key:1,variant:"muted-textonly",size:"lg",class:"mr-auto underline","data-attr":"upload-model-step1-help-link",onClick:s[2]||(s[2]=d=>o.value=!0)},{default:y(()=>[s[12]||(s[12]=r("i",{class:"icon-[lucide--circle-question-mark]"},null,-1)),r("span",null,c(t.$t("assetBrowser.uploadModelHowDoIFindThis")),1)]),_:1})):_("",!0),t.currentStep===1?(u(),F(V,{key:2,variant:"muted-textonly",size:"lg","data-attr":"upload-model-step1-cancel-button",disabled:t.isFetchingMetadata||t.isUploading,onClick:s[3]||(s[3]=d=>l("close"))},{default:y(()=>[D(c(t.$t("g.cancel")),1)]),_:1},8,["disabled"])):_("",!0),t.currentStep!==1&&t.currentStep!==3?(u(),F(V,{key:3,variant:"muted-textonly",size:"lg","data-attr":`upload-model-step${t.currentStep}-back-button`,disabled:t.isFetchingMetadata||t.isUploading,onClick:s[4]||(s[4]=d=>l("back"))},{default:y(()=>[D(c(t.$t("g.back")),1)]),_:1},8,["data-attr","disabled"])):(u(),g("span",rt)),t.currentStep===1?(u(),F(V,{key:5,variant:"secondary",size:"lg","data-attr":"upload-model-step1-continue-button",disabled:!t.canFetchMetadata||t.isFetchingMetadata,onClick:s[5]||(s[5]=d=>l("fetchMetadata"))},{default:y(()=>[t.isFetchingMetadata?(u(),g("i",nt)):_("",!0),r("span",null,c(t.$t("g.continue")),1)]),_:1},8,["disabled"])):t.currentStep===2?(u(),F(V,{key:6,variant:"secondary",size:"lg","data-attr":"upload-model-step2-confirm-button",disabled:!t.canUploadModel||t.isUploading,onClick:s[6]||(s[6]=d=>l("upload"))},{default:y(()=>[t.isUploading?(u(),g("i",it)):_("",!0),r("span",null,c(t.$t("assetBrowser.upload")),1)]),_:1},8,["disabled"])):t.currentStep===3&&(t.uploadStatus==="success"||t.uploadStatus==="processing")?(u(),g(Ue,{key:7},[k(V,{variant:"muted-textonly",size:"lg","data-attr":"upload-model-step3-import-another-button",onClick:s[7]||(s[7]=d=>l("importAnother"))},{default:y(()=>[D(c(t.$t("assetBrowser.importAnother")),1)]),_:1}),k(V,{variant:"secondary",size:"lg","data-attr":"upload-model-step3-finish-button",onClick:s[8]||(s[8]=d=>l("close"))},{default:y(()=>[D(c(t.uploadStatus==="processing"?t.$t("g.close"):t.$t("assetBrowser.finish")),1)]),_:1})],64)):_("",!0),k(le,{modelValue:o.value,"onUpdate:modelValue":s[9]||(s[9]=d=>o.value=d),"video-url":"https://media.comfy.org/compressed_768/civitai_howto.webm","aria-label":t.$t("assetBrowser.uploadModelHelpVideo")},null,8,["modelValue","aria-label"]),k(le,{modelValue:a.value,"onUpdate:modelValue":s[10]||(s[10]=d=>a.value=d),"video-url":"https://media.comfy.org/byom/huggingfacehowto.mp4","aria-label":t.$t("assetBrowser.uploadModelHelpVideo")},null,8,["modelValue","aria-label"])]))}}),ut={class:"flex flex-1 flex-col gap-6 text-sm text-muted-foreground"},ct={key:0,class:"flex flex-col gap-2"},pt={class:"m-0 font-bold"},mt={class:"m-0"},ft={class:"flex flex-row items-center gap-3 rounded-lg bg-modal-card-background p-4"},gt=["src","alt"],vt={class:"flex min-w-0 flex-1 flex-col items-start justify-center gap-1"},ht={class:"m-0 w-full truncate text-base-foreground"},bt={class:"m-0 text-sm text-muted"},yt={key:1,class:"flex flex-col gap-2"},wt={class:"m-0 font-bold"},_t={class:"m-0"},$t={class:"flex flex-row items-center gap-3 rounded-lg bg-modal-card-background p-4"},kt=["src","alt"],Mt={class:"flex min-w-0 flex-1 flex-col items-start justify-center gap-1"},Ut={class:"m-0 w-full truncate text-base-foreground"},xt={class:"m-0 text-sm text-muted"},St={key:2,class:"flex flex-1 flex-col items-center justify-center gap-6"},Ct={class:"text-center"},Ft={class:"m-0 text-sm font-bold"},It={key:0,class:"text-sm text-muted mb-0"},Vt=I({__name:"UploadModelProgress",props:{result:{},error:{},metadata:{},modelType:{},previewImage:{}},setup(i){return(e,n)=>(u(),g("div",ut,[e.result==="processing"?(u(),g("div",ct,[r("p",pt,c(e.$t("assetBrowser.processingModel")),1),r("p",mt,c(e.$t("assetBrowser.processingModelDescription")),1),r("div",ft,[e.previewImage?(u(),g("img",{key:0,src:e.previewImage,alt:e.metadata?.filename||e.metadata?.name||"Model preview",class:"size-14 flex-shrink-0 rounded object-cover"},null,8,gt)):_("",!0),r("div",vt,[r("p",ht,c(e.metadata?.filename||e.metadata?.name),1),r("p",bt,c(e.modelType),1)])])])):e.result==="success"?(u(),g("div",yt,[r("p",wt,c(e.$t("assetBrowser.modelUploaded")),1),r("p",_t,c(e.$t("assetBrowser.findInLibrary",{type:e.modelType})),1),r("div",$t,[e.previewImage?(u(),g("img",{key:0,src:e.previewImage,alt:e.metadata?.filename||e.metadata?.name||"Model preview",class:"size-14 flex-shrink-0 rounded object-cover"},null,8,kt)):_("",!0),r("div",Mt,[r("p",Ut,c(e.metadata?.filename||e.metadata?.name),1),r("p",xt,c(e.modelType),1)])])])):e.result==="error"?(u(),g("div",St,[n[0]||(n[0]=r("i",{class:"icon-[lucide--x-circle] text-6xl text-error"},null,-1)),r("div",Ct,[r("p",Ft,c(e.$t("assetBrowser.uploadFailed")),1),e.error?(u(),g("p",It,c(e.error),1)):_("",!0)])])):_("",!0)]))}}),Q={type:"civitai",name:"Civitai",hostnames:["civitai.com"]},ce={type:"huggingface",name:"Hugging Face",hostnames:["huggingface.co"]};function oe(i,e){try{const n=new URL(i).hostname.toLowerCase();return e.hostnames.some(o=>n===o||n.endsWith(`.${o}`))}catch{return!1}}m(oe,"validateSourceUrl");const Bt={class:"flex flex-col justify-between h-full gap-6 text-sm"},Lt={class:"flex flex-col gap-6"},jt={class:"flex flex-col gap-2"},Dt={class:"m-0 text-foreground"},Et={class:"m-0"},At={class:"m-0 text-muted-foreground"},zt={class:"inline-flex items-center gap-1 flex-wrap mt-2"},Rt={class:"inline-flex items-center gap-1"},Tt=["alt"],Pt={class:"inline-flex items-center gap-1"},Wt=["alt"],Ht={class:"flex flex-col gap-2"},qt={class:"relative"},Ot={key:0,class:"icon-[lucide--circle-check-big] absolute top-1/2 right-3 size-5 -translate-y-1/2 text-green-500"},Nt={key:0,class:"text-sm text-error"},Gt={key:1,class:"text-foreground"},Kt={class:"font-bold italic"},Qt={class:"text-sm text-muted"},Yt="/assets/images/civitai.svg",Zt="https://civitai.com/models",Jt="/assets/images/hf-logo.svg",Xt="https://huggingface.co",ea=I({__name:"UploadModelUrlInput",props:{modelValue:{},error:{}},emits:["update:modelValue"],setup(i,{emit:e}){const{flags:n}=A(),o=i,a=e,l=B({get:m(()=>o.modelValue,"get"),set:m(d=>a("update:modelValue",d),"set")}),t=[Q,ce],s=B(()=>{const d=l.value.trim();return d?t.some(b=>oe(d,b)):!1});return(d,b)=>{const $=ne("i18n-t");return u(),g("div",Bt,[r("div",Lt,[r("div",jt,[r("p",Dt,c(d.$t("assetBrowser.uploadModelDescription1Generic")),1),r("div",Et,[r("p",At,c(d.$t("assetBrowser.uploadModelDescription2Generic")),1),r("span",zt,[r("span",Rt,[r("img",{src:Yt,alt:d.$t("assetBrowser.providerCivitai"),class:"w-4 h-4"},null,8,Tt),r("a",{href:Zt,target:"_blank",rel:"noopener noreferrer",class:"text-muted-foreground underline"},c(d.$t("assetBrowser.providerCivitai")),1),b[1]||(b[1]=r("span",null,",",-1))]),r("span",Pt,[r("img",{src:Jt,alt:d.$t("assetBrowser.providerHuggingFace"),class:"w-4 h-4"},null,8,Wt),r("a",{href:Xt,target:"_blank",rel:"noopener noreferrer",class:"text-muted-foreground underline"},c(d.$t("assetBrowser.providerHuggingFace")),1)])])])]),r("div",Ht,[r("div",qt,[k(p(ie),{modelValue:l.value,"onUpdate:modelValue":b[0]||(b[0]=v=>l.value=v),autofocus:"",placeholder:d.$t("assetBrowser.genericLinkPlaceholder"),class:"w-full border-0 bg-secondary-background p-4 pr-10","data-attr":"upload-model-step1-url-input"},null,8,["modelValue","placeholder"]),s.value?(u(),g("i",Ot)):_("",!0)]),d.error?(u(),g("p",Nt,c(d.error),1)):p(n).asyncModelUploadEnabled?_("",!0):(u(),g("p",Gt,[k($,{keypath:"assetBrowser.maxFileSize",tag:"span"},{size:y(()=>[r("span",Kt,c(d.$t("assetBrowser.maxFileSizeValue")),1)]),_:1})]))])]),r("div",Qt,c(d.$t("assetBrowser.uploadModelHelpFooterText")),1)])}}}),ta={class:"flex flex-col gap-6 text-sm text-muted-foreground"},aa={class:"flex flex-col gap-2"},sa={class:"m-0"},oa={class:"list-disc space-y-1 pl-5 mt-0"},la={href:"https://civitai.com/models",target:"_blank",class:"text-muted-foreground underline"},ra={key:0},na={class:"font-bold italic"},ia={class:"flex flex-col gap-2"},da={class:"font-bold italic"},ua={class:"relative"},ca={key:0,class:"icon-[lucide--circle-check-big] absolute top-1/2 right-3 size-5 -translate-y-1/2 text-green-500"},pa={key:0,class:"text-sm text-error"},ma={href:"https://civitai.com/models/10706/luisap-z-image-and-qwen-pixel-art-refiner?modelVersionId=2225295",target:"_blank",class:"text-muted-foreground underline"},fa=I({__name:"UploadModelUrlInputCivitai",props:H({error:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const{flags:e}=A(),n=q(i,"modelValue"),o=B(()=>{const a=n.value.trim();return a?oe(a,Q):!1});return(a,l)=>{const t=ne("i18n-t");return u(),g("div",ta,[r("div",aa,[r("p",sa,c(a.$t("assetBrowser.uploadModelDescription1")),1),r("ul",oa,[r("li",null,[k(t,{keypath:"assetBrowser.uploadModelDescription2",tag:"span"},{link:y(()=>[r("a",la,c(a.$t("assetBrowser.uploadModelDescription2Link")),1)]),_:1})]),p(e).asyncModelUploadEnabled?_("",!0):(u(),g("li",ra,[k(t,{keypath:"assetBrowser.uploadModelDescription3",tag:"span"},{size:y(()=>[r("span",na,c(a.$t("assetBrowser.maxFileSizeValue")),1)]),_:1})]))])]),r("div",ia,[k(t,{keypath:"assetBrowser.civitaiLinkLabel",tag:"label",class:"mb-0"},{download:y(()=>[r("span",da,c(a.$t("assetBrowser.civitaiLinkLabelDownload")),1)]),_:1}),r("div",ua,[k(p(ie),{modelValue:n.value,"onUpdate:modelValue":l[0]||(l[0]=s=>n.value=s),autofocus:"",placeholder:a.$t("assetBrowser.civitaiLinkPlaceholder"),class:"w-full border-0 bg-secondary-background p-4 pr-10","data-attr":"upload-model-step1-url-input"},null,8,["modelValue","placeholder"]),o.value?(u(),g("i",ca)):_("",!0)]),a.error?(u(),g("p",pa,c(a.error),1)):(u(),F(t,{key:1,keypath:"assetBrowser.civitaiLinkExample",tag:"p",class:"text-sm"},{example:y(()=>[r("strong",null,c(a.$t("assetBrowser.civitaiLinkExampleStrong")),1)]),link:y(()=>[r("a",ma,c(a.$t("assetBrowser.civitaiLinkExampleUrl")),1)]),_:1}))])])}}});function ga(i){const{t:e}=de(),n=me(),o=fe(),a=ge(),{flags:l}=A(),t=x(1),s=x(!1),d=x(!1),b=x(),$=x(""),v=x({url:"",name:"",tags:[]}),h=x(),M=l.huggingfaceModelImportEnabled?[Q,ce]:[Q],E=B(()=>{const U=v.value.url.trim();return U?M.find(w=>oe(U,w))??null:null});R(()=>v.value.url,()=>{$.value=""});const O=B(()=>v.value.url.trim().length>0),N=B(()=>!!h.value);async function Y(){if(!O.value)return;let U=v.value.url.trim();try{U=new URL(encodeURI(U)).toString()}catch{}if(v.value.url=U,!E.value){const f=M.map(S=>S.name).join(", ");$.value=e("assetBrowser.unsupportedUrlSource",{sources:f});return}s.value=!0;try{const f=await K.getAssetMetadata(v.value.url);if(f.filename)try{f.filename=decodeURIComponent(f.filename)}catch{}if(f.name)try{f.name=decodeURIComponent(f.name)}catch{}if(v.value.metadata=f,v.value.name=f.filename||f.name||"",v.value.previewImage=f.preview_image,f.tags&&f.tags.length>0){v.value.tags=f.tags;const S=f.tags.find(T=>i.value.some(P=>P.value===T));S&&(h.value=S)}t.value=2}catch(f){console.error("Failed to retrieve metadata:",f),$.value=f instanceof Error?f.message:ve("assetBrowser.uploadModelFailedToRetrieveMetadata","Failed to retrieve metadata. Please check the link and try again."),t.value=1}finally{s.value=!1}}m(Y,"fetchMetadata");async function Z(U){if(v.value.previewImage)try{const w=U.split(".")[0];let f="png";const S=v.value.previewImage.match(/^data:image\/([^;]+);/);return S&&(f=S[1]==="jpeg"?"jpg":S[1]),(await K.uploadAssetFromBase64({data:v.value.previewImage,name:`${w}_preview.${f}`,tags:["preview"]})).id}catch(w){console.error("Failed to upload preview image:",w);return}}m(Z,"uploadPreviewImage");async function G(){if(!h.value)return;const U=a.getAllNodeProviders(h.value);(await Promise.allSettled(U.map(f=>n.updateModelsForNodeType(f.nodeDef.name)))).forEach((f,S)=>{f.status==="rejected"&&console.error(`Failed to refresh ${U[S].nodeDef.name}:`,f.reason)})}m(G,"refreshModelCaches");async function J(){if(!N.value)return!1;const U=E.value;if(!U)return $.value=e("assetBrowser.noValidSourceDetected"),!1;d.value=!0;try{const w=h.value?["models",h.value]:["models"],f=v.value.metadata?.filename||v.value.metadata?.name||"model",S=await Z(f),T={source:U.type,source_url:v.value.url,model_type:h.value};if(l.asyncModelUploadEnabled){const P=await K.uploadAssetAsync({source_url:v.value.url,tags:w,user_metadata:T,preview_id:S});P.type==="async"&&P.task.status!=="completed"?(h.value&&o.trackDownload(P.task.task_id,h.value,f),b.value="processing"):(b.value="success",await G()),t.value=3}else await K.uploadAssetFromUrl({url:v.value.url,name:f,tags:w,user_metadata:T,preview_id:S}),b.value="success",await G(),t.value=3}catch(w){console.error("Failed to upload asset:",w),b.value="error",$.value=w instanceof Error?w.message:"Failed to upload model",t.value=3}finally{d.value=!1}return b.value!=="error"}m(J,"uploadModel");function X(){t.value>1&&(t.value=t.value-1)}m(X,"goToPreviousStep");function ee(){t.value=1,s.value=!1,d.value=!1,b.value=void 0,$.value="",v.value={url:"",name:"",tags:[]},h.value=void 0}return m(ee,"resetWizard"),{currentStep:t,isFetchingMetadata:s,isUploading:d,uploadStatus:b,uploadError:$,wizardData:v,selectedModelType:h,canFetchMetadata:O,canUploadModel:N,detectedSource:E,fetchMetadata:Y,uploadModel:J,goToPreviousStep:X,resetWizard:ee}}m(ga,"useUploadModelWizard");const va={class:"upload-model-dialog flex flex-col gap-6 border-t border-border-default p-4 pt-6"},ha={class:"min-h-0 flex-auto basis-0 overflow-y-auto"},ba=I({__name:"UploadModelDialog",emits:["upload-success"],setup(i,{emit:e}){const{flags:n}=A(),o=ae(),{modelTypes:a,fetchModelTypes:l}=ue(),t=e,{currentStep:s,isFetchingMetadata:d,isUploading:b,uploadStatus:$,uploadError:v,wizardData:h,selectedModelType:M,canFetchMetadata:E,canUploadModel:O,fetchMetadata:N,uploadModel:Y,goToPreviousStep:Z,resetWizard:G}=ga(a);async function J(){await N()}m(J,"handleFetchMetadata");async function X(){await Y()&&t("upload-success")}m(X,"handleUploadModel");function ee(){o.closeDialog({key:"upload-model"})}return m(ee,"handleClose"),xe(()=>{l()}),(U,w)=>(u(),g("div",va,[r("div",ha,[p(s)===1&&p(n).huggingfaceModelImportEnabled?(u(),F(ea,{key:0,modelValue:p(h).url,"onUpdate:modelValue":w[0]||(w[0]=f=>p(h).url=f),error:p(v)},null,8,["modelValue","error"])):p(s)===1?(u(),F(fa,{key:1,modelValue:p(h).url,"onUpdate:modelValue":w[1]||(w[1]=f=>p(h).url=f),error:p(v)},null,8,["modelValue","error"])):p(s)===2?(u(),F(tt,{key:2,modelValue:p(M),"onUpdate:modelValue":w[2]||(w[2]=f=>Se(M)?M.value=f:null),metadata:p(h).metadata,"preview-image":p(h).previewImage},null,8,["modelValue","metadata","preview-image"])):p(s)===3&&p($)!=null?(u(),F(Vt,{key:3,result:p($),error:p(v),metadata:p(h).metadata,"model-type":p(M),"preview-image":p(h).previewImage},null,8,["result","error","metadata","model-type","preview-image"])):_("",!0)]),k(dt,{class:"flex-shrink-0","current-step":p(s),"is-fetching-metadata":p(d),"is-uploading":p(b),"can-fetch-metadata":p(E),"can-upload-model":p(O),"upload-status":p($),onBack:p(Z),onFetchMetadata:J,onUpload:X,onClose:ee,onImportAnother:p(G)},null,8,["current-step","is-fetching-metadata","is-uploading","can-fetch-metadata","can-upload-model","upload-status","onBack","onImportAnother"])]))}}),ya=se(ba,[["__scopeId","data-v-f4fd265e"]]),wa=""+new URL("images/civitai.svg",import.meta.url).href,_a={class:"flex items-center gap-2 p-4 font-bold"},$a={key:0,src:wa,class:"size-4"},ka={class:"rounded-full bg-white px-1.5 py-0 text-xxs font-inter font-semibold uppercase text-black"},Ma=I({__name:"UploadModelDialogHeader",setup(i){const{flags:e}=A(),n=B(()=>e.huggingfaceModelImportEnabled?"assetBrowser.uploadModelGeneric":"assetBrowser.uploadModelFromCivitai");return(o,a)=>(u(),g("div",_a,[p(e).huggingfaceModelImportEnabled?_("",!0):(u(),g("img",$a)),r("span",null,c(o.$t(n.value)),1),r("span",ka,c(o.$t("g.beta")),1)]))}}),Ua={},xa={class:"flex flex-1 flex-col items-center justify-center text-base text-muted-foreground"},Sa={class:"m-0 max-w-md"};function Ca(i,e){return u(),g("div",xa,[r("p",Sa,c(i.$t("assetBrowser.upgradeFeatureDescription")),1)])}m(Ca,"_sfc_render$1");const Fa=se(Ua,[["render",Ca]]),Ia={class:"flex flex-wrap justify-end gap-2 w-full"},Va={href:"https://blog.comfy.org/p/comfy-cloud-new-features-and-pricing",target:"_blank",rel:"noopener noreferrer",class:"text-muted-foreground mr-auto underline flex items-center gap-2"},Ba=I({__name:"UploadModelUpgradeModalFooter",emits:["close","subscribe"],setup(i,{emit:e}){const n=e;return(o,a)=>(u(),g("div",Ia,[r("a",Va,[a[2]||(a[2]=r("i",{class:"icon-[lucide--external-link]"},null,-1)),r("span",null,c(o.$t("g.learnMore")),1)]),k(V,{variant:"textonly",onClick:a[0]||(a[0]=l=>n("close"))},{default:y(()=>[D(c(o.$t("g.close")),1)]),_:1}),k(V,{variant:"secondary",onClick:a[1]||(a[1]=l=>n("subscribe"))},{default:y(()=>[D(c(o.$t("subscription.required.subscribe")),1)]),_:1})]))}}),La={class:"flex flex-col justify-between gap-10 p-4 border-t border-border-default w-auto max-w-[min(500px,90vw)]"},ja=I({__name:"UploadModelUpgradeModal",setup(i){const e=ae(),{showSubscriptionDialog:n}=he();function o(){e.closeDialog({key:"upload-model-upgrade"})}m(o,"handleClose");function a(){n()}return m(a,"handleSubscribe"),(l,t)=>(u(),g("div",La,[k(Fa),k(Ba,{onClose:o,onSubscribe:a})]))}}),Da={},Ea={class:"flex items-center gap-2 p-4 font-bold"};function Aa(i,e){return u(),g("div",Ea,[r("span",null,c(i.$t("assetBrowser.upgradeToUnlockFeature")),1)])}m(Aa,"_sfc_render");const za=se(Da,[["render",Aa]]);function Xa(i){const e=ae(),{flags:n}=A(),o=B(()=>n.modelUploadButtonEnabled);function a(){n.privateModelsEnabled?e.showDialog({key:"upload-model",headerComponent:Ma,component:ya,props:{onUploadSuccess:m(async()=>{await i?.()},"onUploadSuccess")},dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0! overflow-y-hidden!"}}}):e.showDialog({key:"upload-model-upgrade",headerComponent:za,component:ja,dialogComponentProps:{pt:{header:"py-0! pl-0!",content:"p-0! overflow-y-hidden!"}}})}return m(a,"showUploadDialog"),{isUploadButtonEnabled:o,showUploadDialog:a}}m(Xa,"useModelUpload");const Ra=["placeholder","autofocus"],Ta=["aria-label"],es=I({__name:"FormSearchInput",props:H({searcher:{type:Function,default:m(async()=>{},"default")},updateKey:{},autofocus:{type:Boolean,default:!1},class:{}},{modelValue:{default:""},modelModifiers:{}}),emits:["update:modelValue"],setup(i){const e=q(i,"modelValue"),n=x(!1),o=Ce(e,250,{maxWait:1e3});R(e,t=>{n.value=t!==o.value});const a=Fe(()=>Ie(i.updateKey));R([o,a],(t,s,d)=>{let b=!1,$;d(()=>{b=!0,$?.()}),i.searcher(o.value,v=>$=v).catch(v=>{console.error("[SidePanelSearch] searcher failed",v)}).finally(()=>{b||(n.value=!1)})},{immediate:!0});function l(t){t.target.select()}return m(l,"handleFocus"),(t,s)=>(u(),g("label",{class:z(p(W)("group","bg-component-node-widget-background rounded-lg transition-all duration-150","flex-1 flex items-center","text-base-foreground border-0","focus-within:ring focus-within:ring-component-node-widget-background-highlighted/80",i.class))},[r("i",{class:z(p(W)("size-4 ml-2 shrink-0 transition-colors duration-150",n.value?"icon-[lucide--loader-circle] animate-spin":"icon-[lucide--search]",e.value?.trim()!==""?"text-base-foreground":"text-muted-foreground group-hover:text-base-foreground group-focus-within:text-base-foreground"))},null,2),Ve(r("input",{"onUpdate:modelValue":s[0]||(s[0]=d=>e.value=d),type:"text",class:"bg-transparent border-0 outline-0 ring-0 h-5 w-full my-1.5 mx-2",placeholder:t.$t("g.searchPlaceholder"),autofocus:t.autofocus,onFocus:l},null,40,Ra),[[Be,e.value]]),e.value.trim().length>0?(u(),g("button",{key:0,class:"text-muted-foreground hover:text-base-foreground bg-transparent shrink-0 border-0 outline-0 ring-0 p-0 m-0 pr-3 pl-1 flex items-center justify-center transition-all duration-150 hover:scale-108","aria-label":t.$t("g.clear"),onClick:s[1]||(s[1]=d=>e.value="")},[r("i",{class:z(p(W)("icon-[lucide--delete] size-4 cursor-pointer"))},null,2)],8,Ta)):_("",!0)],2))}}),Pa=""+new URL("images/default-template.png",import.meta.url).href;function Wa(i,e,n={}){const{immediate:o=!0,...a}=n,l=typeof window<"u"&&"IntersectionObserver"in window,t=x(!1);let s=null;const d=m(()=>{s&&(s.disconnect(),s=null)},"cleanup"),b=m(()=>{d(),!(!l||!i.value)&&(s=new IntersectionObserver(v=>{t.value=v.some(h=>h.isIntersecting),e(v,s)},a),s.observe(i.value))},"observe"),$=m(()=>{s&&i.value&&s.unobserve(i.value)},"unobserve");return o&&R(i,b,{immediate:!0,flush:"post"}),Le(d),{isSupported:l,isIntersecting:t,observe:b,unobserve:$,cleanup:d}}m(Wa,"useIntersectionObserver");class Ha{static{m(this,"MediaCacheService")}cache=re(new Map);maxSize;maxAge;cleanupInterval=null;urlRefCount=new Map;constructor(e={}){this.maxSize=e.maxSize??100,this.maxAge=e.maxAge??1800*1e3,this.startCleanupInterval()}startCleanupInterval(){this.cleanupInterval=window.setInterval(()=>{this.cleanup()},300*1e3)}cleanup(){const e=Date.now(),n=[];for(const[o,a]of Array.from(this.cache.entries()))e-a.lastAccessed>this.maxAge&&(a.objectUrl?(this.urlRefCount.get(a.objectUrl)||0)===0&&(URL.revokeObjectURL(a.objectUrl),this.urlRefCount.delete(a.objectUrl),n.push(o)):n.push(o));if(n.forEach(o=>this.cache.delete(o)),this.cache.size>this.maxSize){const o=Array.from(this.cache.entries());o.sort((t,s)=>t[1].lastAccessed-s[1].lastAccessed);let a=0;const l=this.cache.size-this.maxSize;for(const[t,s]of o){if(a>=l)break;s.objectUrl?(this.urlRefCount.get(s.objectUrl)||0)===0&&(URL.revokeObjectURL(s.objectUrl),this.urlRefCount.delete(s.objectUrl),this.cache.delete(t),a++):(this.cache.delete(t),a++)}}}async getCachedMedia(e){let n=this.cache.get(e);if(n)return n.lastAccessed=Date.now(),n;n={src:e,isLoading:!0,lastAccessed:Date.now()},this.cache.set(e,n);try{const o=await fetch(e,{cache:"force-cache"});if(!o.ok)throw new Error(`Failed to fetch: ${o.status}`);const a=await o.blob(),l=URL.createObjectURL(a),t={src:e,blob:a,objectUrl:l,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,t),t}catch(o){console.warn("Failed to cache media:",e,o);const a={src:e,error:!0,isLoading:!1,lastAccessed:Date.now()};return this.cache.set(e,a),a}}acquireUrl(e){const n=this.cache.get(e);if(n?.objectUrl){const o=this.urlRefCount.get(n.objectUrl)||0;return this.urlRefCount.set(n.objectUrl,o+1),n.objectUrl}}releaseUrl(e){const n=this.cache.get(e);if(n?.objectUrl){const o=(this.urlRefCount.get(n.objectUrl)||1)-1;o<=0?(URL.revokeObjectURL(n.objectUrl),this.urlRefCount.delete(n.objectUrl),this.cache.delete(e)):this.urlRefCount.set(n.objectUrl,o)}}clearCache(){for(const e of Array.from(this.cache.values()))e.objectUrl&&URL.revokeObjectURL(e.objectUrl);this.cache.clear(),this.urlRefCount.clear()}destroy(){this.cleanupInterval&&(clearInterval(this.cleanupInterval),this.cleanupInterval=null),this.clearCache()}}let L=null;function qa(i){return L||(L=new Ha(i)),{getCachedMedia:m(l=>L.getCachedMedia(l),"getCachedMedia"),clearCache:m(()=>L.clearCache(),"clearCache"),acquireUrl:m(l=>L.acquireUrl(l),"acquireUrl"),releaseUrl:m(l=>L.releaseUrl(l),"releaseUrl"),cache:L.cache}}m(qa,"useMediaCache");typeof window<"u"&&window.addEventListener("beforeunload",()=>{L&&L.destroy()});const Oa=["src","alt"],Na={key:2,class:"absolute inset-0 flex items-center justify-center"},Ga=["alt"],ts=I({__name:"LazyImage",props:{src:{},alt:{default:""},containerClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageClass:{type:[Array,Object,String,Number,null,Boolean],default:""},imageStyle:{},rootMargin:{default:"300px"}},setup(i){const e=x(null),n=x(!1),o=x(!1),a=x(!1),l=x(void 0),{getCachedMedia:t,acquireUrl:s,releaseUrl:d}=qa();Wa(e,h=>{const M=h[0];n.value=M?.isIntersecting??!1},{rootMargin:i.rootMargin,threshold:.1});const b=B(()=>n.value);R(b,async h=>{if(h&&i.src&&!l.value&&!a.value)try{const M=await t(i.src);if(M.error)a.value=!0;else if(M.objectUrl){const E=s(i.src);l.value=E||M.objectUrl}else l.value=i.src}catch(M){console.warn("Failed to load cached media:",M),l.value=i.src}else h||(l.value?.startsWith("blob:")&&d(i.src),o.value=!1,l.value=void 0,a.value=!1)},{immediate:!0});const $=m(()=>{o.value=!0,a.value=!1},"onImageLoad"),v=m(()=>{a.value=!0,o.value=!1},"onImageError");return je(()=>{l.value?.startsWith("blob:")&&d(i.src)}),(h,M)=>(u(),g("div",{ref_key:"containerRef",ref:e,class:z(["relative flex h-full w-full items-center justify-center overflow-hidden",h.containerClass])},[o.value?_("",!0):(u(),F(p(Ae),{key:0,width:"100%",height:"100%",class:"absolute inset-0"})),l.value?(u(),g("img",{key:1,src:l.value,alt:h.alt,draggable:"false",class:z(h.imageClass),style:te(h.imageStyle),onLoad:$,onError:v},null,46,Oa)):_("",!0),a.value?(u(),g("div",Na,[r("img",{src:Pa,alt:h.alt,draggable:"false",class:z(h.imageClass),style:te(h.imageStyle)},null,14,Ga)])):_("",!0)],2))}});export{He as _,Xa as a,es as b,Pa as c,ts as d,Wa as e,A as u};
//# sourceMappingURL=LazyImage.vue_vue_type_script_setup_true_lang-CX9YtPlM.js.map
