{% include './top_comment.jinja2' with context %}

{# Use ES module imports when module_type == 'es6', otherwise keep CommonJS requires #}
{% if module_type == 'es6' -%}
import path from 'path';
import { fileURLToPath } from 'url';

{% if '@vortex-ts-sdk/http-crawler' in packages_to_install -%}
import { HttpCrawler, pq } from '@vortex-ts-sdk/http-crawler';
import { VtxLogger } from '@vortex-ts-sdk/vtx-logger';
import {
    isTestEnvironment,
    sleep,
    getPodParams,
    isScalar,
    jsonDecode,
} from '@vortex-ts-sdk/core';
{% elif '@vortex-ts-registry/crawler-utils' in packages_to_install -%}
import {
    li,
    le,
    MyCrawlerHandler,
    MyQueue,
    jsonDecode,
    isTestEnvironment,
} from '@vortex-ts-registry/crawler-utils'
{%- endif %}

{% if '@vortex-ts-sdk/cache-handler' in packages_to_install -%}
import { CacheHandler } from '@vortex-ts-sdk/cache-handler'
{%- endif %}
{% if '@vortex-ts-registry/p-queue' in packages_to_install -%}
import PQueue from '@vortex-ts-registry/p-queue'
{%- endif %}

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

{% if '@vortex-ts-sdk/cache-handler' in packages_to_install -%}
const CACHE = new CacheHandler(path.parse(__dirname).name)
{%- endif %}

{% else -%}
const path = require('path');
{% if '@vortex-ts-sdk/http-crawler' in packages_to_install -%}
const { HttpCrawler, pq } = require('@vortex-ts-sdk/http-crawler');
const { VtxLogger } = require('@vortex-ts-sdk/vtx-logger');
const {
    isTestEnvironment,
    sleep,
    getPodParams,
    isScalar,
    jsonDecode,
} = require('@vortex-ts-sdk/core');
{% elif '@vortex-ts-registry/crawler-utils' in packages_to_install -%}
const {
    li,
    le,
    MyCrawlerHandler,
    MyQueue,
    jsonDecode,
    isTestEnvironment,
} = require('@vortex-ts-registry/crawler-utils')
{%- endif %}
{% if '@vortex-ts-sdk/cache-handler' in packages_to_install -%}
const { CacheHandler } = require('@vortex-ts-sdk/cache-handler')
{%- endif %}
{% if '@vortex-ts-registry/p-queue' in packages_to_install -%}
const { default: PQueue } = require('@vortex-ts-registry/p-queue')
{%- endif %}
{% if '@vortex-ts-sdk/cache-handler' in packages_to_install -%}
const CACHE = new CacheHandler(path.parse(__dirname).name)
{%- endif %}
{% endif %}

{% include './middle_part.js.jinja2' with context %}

const getAbsLink = (relativeURL, baseURL) =>
    relativeURL && relativeURL.trim() ? new URL(relativeURL, baseURL || DOMAIN_URL).toString() : relativeURL

async function newSession(httpHandler) {
    httpHandler.resetRequestConfig()
    httpHandler.setHeaders('Accept-Encoding', 'gzip, deflate');
    httpHandler.setHeaders('Accept', 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8');
    httpHandler.setHeaders('Accept-Language', 'en-US,en;q=0.5');
    httpHandler.setHeaders('Connection', 'keep-alive');
    httpHandler.setHeaders('Upgrade-Insecure-Requests', '1');
    httpHandler.setHeaders('User-Agent', 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/101.0.4951.67 Safari/537.36');
    await httpHandler.proxy.enable();
}

{% include './main_fn.js.jinja2' with context %}