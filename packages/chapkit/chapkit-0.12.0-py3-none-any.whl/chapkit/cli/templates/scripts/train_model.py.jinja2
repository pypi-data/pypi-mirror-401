#!/usr/bin/env python3
"""External training script for ML model training via ShellModelRunner.

This script demonstrates language-agnostic ML training by:
- Reading config from YAML (config.yml in workspace)
- Loading training data from CSV
- Training a simple model (calculating column means)
- Saving the model to disk (model.pickle in workspace)

Usage:
    python train_model.py --data data.csv --geo geo.json
"""

import argparse
import pickle
import sys

import pandas as pd
import yaml


def main() -> None:
    """Main training function."""
    parser = argparse.ArgumentParser(description="Train ML model from external script")
    parser.add_argument("--data", required=True, help="Path to training data CSV")
    parser.add_argument("--geo", default="", help="Path to GeoJSON file (optional)")

    args = parser.parse_args()

    try:
        # Load config (fixed path in workspace)
        with open("config.yml") as f:
            config = yaml.safe_load(f)

        print(f"Training with config: {config}", file=sys.stderr)

        # Load training data
        data = pd.read_csv(args.data)
        print(f"Loaded {len(data)} training samples", file=sys.stderr)

        # Simple model: compute mean of each numeric column
        # This is a minimal example - replace with your own ML logic
        numeric_data = data.select_dtypes(include=["number"])
        model = {
            "means": numeric_data.mean().to_dict(),
            "columns": list(numeric_data.columns),
        }

        print(f"Model trained with means: {model['means']}", file=sys.stderr)

        # Save model (fixed path in workspace)
        with open("model.pickle", "wb") as f:
            pickle.dump(model, f)

        print("Model saved to model.pickle", file=sys.stderr)
        print("SUCCESS: Training completed")

    except Exception as e:
        print(f"ERROR: Training failed: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
