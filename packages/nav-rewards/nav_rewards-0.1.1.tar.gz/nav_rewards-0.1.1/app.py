"""
App.py
This file will be auto-generated by code
"""
import re
import contextlib
from urllib.parse import urlparse
from aiohttp import hdrs, web
from aiohttp.web import middleware
from aiohttp.web_urldispatcher import SystemRoute
# Navconfig:
from navconfig import BASE_DIR
from navconfig.logging import logging
## Authentication
from navigator_auth import AuthHandler
##  Navigator
from navigator.handlers.types import AppHandler
from rewards.conf import (
    default_dsn,
    rabbitmq_dsn,
    ENABLE_EVENT_MANAGER,
    ENABLE_REWARDS,
    STATIC_DIR
)


@middleware
async def navigator_client(request, handler):
    host = None
    client = None
    hostname = None
    if isinstance(request.match_info.route, SystemRoute):  # eg. 404
        return await handler(request)
    # avoid authorization backend on excluded methods:
    if request.method == hdrs.METH_OPTIONS:
        return await handler(request)
    ## computar client basado en el referal.
    with contextlib.suppress(AttributeError, KeyError):
        host = request.headers.get("Origin") or request.headers.get("Referer")
    if host:
        domain = request.headers.get('Host')
        pattern = r"([\w.-]+)\." + re.escape(domain)
        url = urlparse(host)
        request['netloc'] = url.netloc
        try:
            domain_match = re.search(pattern, url.netloc)
            client = str(domain_match[1])
        except AttributeError:
            client = url.hostname.split(".")[0]
        hostname = url.hostname
    # getting client info:
    request["client"] = client
    request["hostname"] = hostname
    return await handler(request)


class Main(AppHandler):
    enable_static: bool = True
    staticdir: str = STATIC_DIR
    enable_pgpool: bool = True
    _middleware: list = [navigator_client]

    def configure(self):

        super(Main, self).configure()
        ### Auth System
        # create a new instance of Auth System
        auth = AuthHandler(secure_cookies=True)
        auth.setup(self.app)  # configure this Auth system into App.
        # Event Manager:
        if ENABLE_EVENT_MANAGER:
            from rewards.events import EventManager  # pylint: disable=C0415 # noqa
            evt = EventManager(dsn=rabbitmq_dsn)
            evt.setup(self.app)
        # Rewards Engine:
        if ENABLE_REWARDS:
            from rewards.engine import RewardsEngine  # pylint: disable=C0415 # noqa
            # Reward Engine:
            reward = RewardsEngine(
                app=self.app
            )
            # reward.add_storage(
            #     "file",
            #     path=BASE_DIR.joinpath(
            #         "my_rewards", "rewards.json"
            #     )
            # )
            # TODO: Fix clash between file and db storage
            reward.add_storage(
                "db",
                dsn=default_dsn
            )
            reward.setup(self.app)

    async def on_startup(self, app):
        """
        on_startup.
        description: Signal for customize the response when server is started
        """

    async def on_shutdown(self, app):
        """
        on_shutdown.
        description: Signal for customize the response when server is
        shutting down
        """
        pass
