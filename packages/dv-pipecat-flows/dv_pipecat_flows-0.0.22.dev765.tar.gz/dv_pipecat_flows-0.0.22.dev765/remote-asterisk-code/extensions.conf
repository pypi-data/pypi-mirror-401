; /etc/asterisk/extensions.conf  (minimal)

[general]
static=yes
writeprotect=no
clearglobalvars=no

[globals]
; MUST be a Twilio-owned/verified number you control:
OUTCALLERID=+18722858684
; Tabby caller ID for UAE numbers:
TABBYCALLERID=+971558976298
; Pipecat server for WebSocket connections:
PIPECAT_SERVER=cdefdda339e5.ngrok-free.app

[from-internal]
; UAE numbers (+971) via Tabby trunk (UDP) - remove + from destination
exten => _+971.,1,NoOp(Outbound to ${EXTEN} via Tabby UDP)
 same => n,Set(CALLERID(num)=${TABBYCALLERID})
 same => n,Set(DEST=${EXTEN:1})
 same => n,Dial(PJSIP/${DEST}@tabby_trunk,60)
 same => n,Hangup()

; Saudi Arabia numbers (+966) via Tabby trunk (UDP) - remove + from destination
exten => _+966.,1,NoOp(Outbound to ${EXTEN} via Tabby UDP)
 same => n,Set(CALLERID(num)=${TABBYCALLERID})
 same => n,Set(DEST=${EXTEN:1})
 same => n,Set(MIXMON_DIR=/tmp)
 same => n,MixMonitor(${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}-${DEST}.wav)
 same => n,Dial(PJSIP/${DEST}@tabby_trunk,60)
 same => n,Hangup()

; All other E.164 numbers via Twilio
exten => _+X.,1,NoOp(Outbound to ${EXTEN} via Twilio)
 same => n,Set(CALLERID(num)=${OUTCALLERID})
 same => n,Dial(PJSIP/${EXTEN}@twilio_trunk,60)
 same => n,Hangup()

; 10/11-digit convenience (US/CA). Comment out if not needed.
exten => _NXXNXXXXXX,1,Goto(from-internal,+1${EXTEN},1)
exten => _1NXXNXXXXXX,1,Goto(from-internal,+${EXTEN},1)

; Local echo test
exten => 600,1,Answer()
 same => n,Echo()
 same => n,Hangup()

exten => 700,1,Answer()
 same => n,NoOp(TEST -> ARI bot)
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/test-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Stasis(pipecat, test-${UNIQUEID})
 same => n,Hangup()

[from-pstn]
; If you later allow inbound from Twilio, send to a test/app here
exten => s,1,NoOp(Inbound from PSTN)
 same => n,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; Keep public/default empty to avoid surprises
[public]
exten => _.,1,Hangup()


[default]
include => from-internal

[from-external]
exten => s,1,NoOp(INBOUND -> ARI bot)
 same => n,Answer()
 same => n,Stasis(pipecat, inbound-${UNIQUEID})
 same => n,Hangup()


;=========================================================================
; PHASE 0: SUBROUTINE - CAPTURE DATA FROM THE B-LEG
;=========================================================================
[sub-capture-callid]
exten => s,1,NoOp(Capturing SIP Call-ID and Codec from PJSIP B-leg)
 same => n,Set(MASTER_CHANNEL(SIP_CALL_ID)=${CHANNEL(pjsip,call-id)})
 same => n,Set(MASTER_CHANNEL(SIP_CODEC)=${CHANNEL(audionativeformat)})
 same => n,Log(NOTICE,B-leg captured - Call-ID: ${CHANNEL(pjsip,call-id)} Codec: ${CHANNEL(audionativeformat)})
 same => n,Return()

;=========================================================================
; PHASE 1: OUTBOUND DIAL - INITIAL CALL PLACEMENT
;=========================================================================
[outbound-dial]
exten => _.,1,NoOp(Phase 1: Starting outbound call to ${EXTEN})

 ; Ensure variables are inherited (downward) by using double underscore __
 same => n,Set(__X_CALL_ID=${X_CALL_ID})
 same => n,Set(__X_CALLBACK_URL=${X_CALLBACK_URL})
 same => n,Set(__ACTUAL_ENDPOINT=${ACTUAL_ENDPOINT})

 same => n,Verbose(1,Outbound Dial Channel Id: ${CHANNEL})

 ; Dial the endpoint
 ; U(...) executes the subroutine on the B-leg upon answering
 ; ^${CHANNEL} passes the current A-leg's name as ARG1 to the subroutine
 same => n,Verbose(1, Dialing ${ACTUAL_ENDPOINT}...)
 same => n,Dial(${ACTUAL_ENDPOINT},300,U(sub-capture-callid))


 ; After dial completes, check status
 same => n,Verbose(1, Dial Finished - Status: ${DIALSTATUS}, Cause: ${HANGUPCAUSE})
 same => n,Goto(s-${DIALSTATUS},1)

; --- ANSWERED: Move to Phase 2 ---
exten => s-ANSWER,1,NoOp(Call Answered - Moving to WebSocket Phase)
 same => n,Goto(outbound-websocket,${X_CALL_ID},1)

; --- NOT ANSWERED: Handle Callbacks ---
exten => _s-.,1,NoOp(Call Not Answered - Status: ${DIALSTATUS})
 same => n,GotoIf($["${LEN(${X_CALLBACK_URL})}" = "0"]?end)

 ; Check for specific failure causes (17: Busy, 18: No Resp, 19: No Ans, 21: Reject)
 same => n,GotoIf($["${REGEX("^(17|18|19|21)$" ${HANGUPCAUSE})}" == "1"]?no_answer)
 
 ; Ignore normal clearing
 same => n,GotoIf($["${REGEX("^(16|31)$" ${HANGUPCAUSE})}" == "1"]?end)

 ; All other causes are errors
 same => n(error),System(curl -s -X POST -d "call_sid=${X_CALL_ID}&status=error" "${X_CALLBACK_URL}" > /dev/null 2>&1 &)
 same => n,Goto(end)

 same => n(no_answer),System(curl -s -X POST -d "call_sid=${X_CALL_ID}&status=no-answer" "${X_CALLBACK_URL}" > /dev/null 2>&1 &)

 same => n(end),Hangup()


;=========================================================================
; PHASE 2: WEBSOCKET BRIDGE - CONNECTING TO PIPECAT
;=========================================================================
[outbound-websocket]
exten => _.,1,NoOp(Phase 2: Bridging ${EXTEN} to WebSocket)

 ; 1. RETRIEVE the stashed Call-ID from the SHARED storage
 ;same => n,Set(WS_CALL_SID=${SHARED(__SIP_CALL_ID,${CHANNEL})})
 same => n,Set(WS_CALL_SID=${SIP_CALL_ID})
 
 same => n,Verbose(1,Master channel call id: ${MASTER_CHANNEL(SIP_CALL_ID)})

 ; 2. Fallback to UniqueID if the SIP Call-ID wasn't captured
 same => n,Set(WS_CALL_SID=${IF($[${LEN(${WS_CALL_SID})} > 0]?${WS_CALL_SID}:${CHANNEL(uniqueid)})})
 same => n,Verbose(1, Final WS_CALL_SID for Pipecat: ${WS_CALL_SID})

 ; 3. Detect Codec (Prioritize alaw/slin, fallback to ulaw)
 same => n,Set(NATIVE_CODEC=${SIP_CODEC})
 same => n,Log(NOTICE,Using SIP_CODEC from B-leg: ${SIP_CODEC})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Verbose(1, Negotiated Codec: ${WS_CODEC})
 same => n,Verbose(1,Websocket Dial Channel Id: ${CHANNEL})

 ; 4. Set Pipecat media endpoint (use channel variable or default)
 same => n,Set(WS_PIPECAT=${IF($[${LEN(${PIPECAT_MEDIA})} > 0]?${PIPECAT_MEDIA}:pipecat_media)})
 same => n,Log(NOTICE,Using Pipecat endpoint: ${WS_PIPECAT})
 
 ;same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/outbound-${X_CALL_ID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 ;same => n,MixMonitor(${MIXMON_FILE},b) 

 ; 5. Dial the WebSocket
 ; We URIEncode variables to ensure they are safe for the dial string
 same => n,Dial(WebSocket/${WS_PIPECAT}/c(${WS_CODEC})v(direction=outbound,call_id=${URIENCODE(${X_CALL_ID})},call_sid=${URIENCODE(${WS_CALL_SID})}),300)
 
 same => n,Verbose(1, WebSocket session closed.)
 same => n,Hangup()



[Ubona_RINGG]
; Inbound calls from Ubona - route to Pipecat
exten => _.,1,NoOp(Inbound call from Ubona - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_asia_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()

; Specific handler for the assigned DID 08045034002
exten => +918045034002,1,NoOp(Inbound call from Ubona DID +918045034002 - From: ${CALLERID(num)})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=+918045034002)
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_asia_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()


[PB_Fintech_RINGG]
; Inbound calls from PB_Fintech - route to WebSocket/Pipecat
; Supports agent_id via X-Agent-ID SIP header (REQUIRED for PB Fintech)
; Supports custom call_id via X-Call-ID SIP header (optional, falls back to UNIQUEID)
; Supports custom_vars via X-Custom-Vars SIP header (optional, format: key1=val1&key2=val2)
; To/From numbers are optional - agent_id is used for routing
exten => _.,1,NoOp(Inbound call from PB_Fintech - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(__PJSIP_CHANNEL_NAME=${CHANNEL})
 same => n,Set(AGENT_ID=${PJSIP_HEADER(read,X-Agent-ID)})
 same => n,Set(CUSTOM_CALL_ID=${PJSIP_HEADER(read,X-Call-ID)})
 same => n,Set(WS_PJSIP_CHANNEL=${UNIQUEID})
 same => n,Set(CUSTOM_VARS=${PJSIP_HEADER(read,X-Custom-Vars)})
 same => n,Set(__DST=${PJSIP_HEADER(read,X-ORIG-CHANNEL)})
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(WS_CALL_ID=${IF($["${CUSTOM_CALL_ID}" != ""]?${CUSTOM_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 ;same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})}),300)
 ;same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},agent_id=${URIENCODE(${AGENT_ID})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})}),300)
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},agent_id=${URIENCODE(${AGENT_ID})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})},pjsip_channel_name=${URIENCODE(${PJSIP_CHANNEL_NAME})}),300)
 same => n,Hangup()


; Generic transfer context used by Ringg bots
[ringg-transfer-generic]
; Mandatory: XFER_TARGET (set by bot via ARI) - the destination number/SIP URI
; Optional:  XFER_METHOD: native | dial | native_then_dial (default native)
;            XFER_DOMAIN: SIP domain for routing
;            XFER_TRUNK: PJSIP trunk name for outbound Dial
;            XFER_TIMEOUT: seconds (default 60)
;            XFER_CALLERID: override caller id on outbound
;
exten => s,1,NoOp(RINGG generic transfer: target=${XFER_TARGET} method=${XFER_METHOD} domain=${XFER_DOMAIN} trunk=${XFER_TRUNK})
 same => n,GotoIf($[${LEN(${XFER_TARGET})}=0]?missing)
 ; Defaults
 same => n,Set(METHOD=${IF($[${LEN(${XFER_METHOD})}>0]?${XFER_METHOD}:native)})
 same => n,Set(TIMEOUT=${IF($[${LEN(${XFER_TIMEOUT})}>0]?${XFER_TIMEOUT}:60)})
 same => n,Set(CALLERID(num)=${IF($[${LEN(${XFER_CALLERID})}>0]?${XFER_CALLERID}:${CALLERID(num)})})

 ; Try native transfer first if requested
 same => n,GotoIf($["${METHOD}"="native"]?do_native)
 same => n,GotoIf($["${METHOD}"="native_then_dial"]?do_native:do_dial)

 same => n(do_native),NoOp(Native transfer (REFER) to ${XFER_TARGET})
 ; Format as sip:target@domain if domain is provided
 same => n,GotoIf($[${LEN(${XFER_DOMAIN})}>0]?use_domain)
 same => n,GotoIf($[${LEN(${XFER_TRUNK})}>0]?use_trunk)
 same => n,Set(REFER_TARGET=${XFER_TARGET})
 same => n,Goto(do_transfer)
 same => n(use_domain),Set(REFER_TARGET=sip:${XFER_TARGET}@${XFER_DOMAIN})
 same => n,Goto(do_transfer)
 same => n(use_trunk),Set(REFER_TARGET=sip:${XFER_TARGET}@${XFER_TRUNK})
 same => n(do_transfer),NoOp(Formatted REFER target: ${REFER_TARGET})
 same => n,Transfer(${REFER_TARGET})
 same => n,NoOp(Native transfer returned; fallback if configured)
 same => n,GotoIf($["${METHOD}"="native"]?done:do_dial)

 ; Build endpoint and Dial fallback
 same => n(do_dial),NoOp(Outbound Dial to ${XFER_TARGET})
 same => n,Set(ENDPOINT=${IF($["${XFER_TARGET:0:4}"="sip:"]?PJSIP/${XFER_TARGET}:${IF($[${LEN(${XFER_TRUNK})}>0]?PJSIP/${XFER_TARGET}@${XFER_TRUNK}:${IF($[${LEN(${XFER_DOMAIN})}>0]?PJSIP/${XFER_TARGET}@${XFER_DOMAIN}:PJSIP/${XFER_TARGET})})})
 same => n,NoOp(Dial endpoint=${ENDPOINT} timeout=${TIMEOUT})
 same => n,Dial(${ENDPOINT},${TIMEOUT})
 same => n(done),Hangup()
 same => n(missing),NoOp(ERROR: XFER_TARGET missing)
 same => n,Hangup(88)

[pb-fintech-transfer]
exten => _X.,1,Goto(s,1)
exten => _+X.,1,Goto(s,1)

exten => s,1,NoOp(PB Fintech transfer handover)
 same => n,Set(__PB_DST=${IF($[${LEN(${DST})}>0]?${DST}:${XFER_TARGET})})
 same => n,Set(MESSAGE(body)={"event":"transfer","callid":"${UNIQUEID}","channel":"${CHANNEL}","dst":"${PB_DST}"})
 same => n,Set(__PB_TRUNK=${IF($[${LEN(${XFER_TRUNK})}>0]?${XFER_TRUNK}:PB_Fintech_RINGG)})
 same => n,NoOp(Sending PB Fintech transfer message to ${PB_TRUNK})
 same => n,Set(MESSAGE(from)=sip:asterisk@35.211.140.39)
 same => n,Set(MESSAGE(to)=sip:35.207.253.220)
 same => n,MessageSend(pjsip:${PB_TRUNK})
 same => n,GotoIf($["${MESSAGE_SEND_STATUS}"="SUCCESS"]?success:failed)
 same => n(success),NoOp(Message sent successfully)
 same => n,Wait(2)
 same => n,Hangup()
 same => n(failed),NoOp(Message send failed: ${MESSAGE_SEND_STATUS})
 same => n,Hangup()


[Deepijatel_RINGG]
; Inbound calls from Deepijatel - route to WebSocket/Pipecat
exten => _.,1,NoOp(Inbound call from Deepijatel - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()



[VOBIZ_RINGG]
; Inbound calls from VOBIZ - route to chan_websocket (v1)
exten => _.,1,NoOp(Inbound call from VOBIZ - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(__PJSIP_CHANNEL_NAME=${CHANNEL})
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 ; Try to get SIP Call-ID header, fallback to UNIQUEID
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(WS_PJSIP_CHANNEL=${UNIQUEID})
 same => n,Set(__CUSTOM_VARS=abc=xyz&foo=bar)
 ; Detect negotiated codec using subroutine
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 ;same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw})})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Verbose(1,Dialing WebSocket - call_id=${WS_CALL_ID} from=${WS_FROM} to=${WS_TO} codec=${WS_CODEC})
 ;same => n,Dial(WebSocket/pipecat_media/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})}),300)
 same => n,Dial(WebSocket/pipecat_media/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})},pjsip_channel_name=${URIENCODE(${PJSIP_CHANNEL_NAME})}),300)
 same => n,Verbose(1,WebSocket dial ended - Status: ${DIALSTATUS})
 same => n,Hangup()


[Twilio_RINGG]
; Inbound calls from Twilio - route to WebSocket/Pipecat
exten => _.,1,NoOp(Inbound call from Twilio - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()

[Plivo_RINGG]
; Inbound calls from Plivo - route to WebSocket/Pipecat
exten => _.,1,NoOp(Inbound call from Plivo - From: ${CALLERID(num)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=${EXTEN})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()


[Ameyo_RINGG]
; Inbound calls from Ameyo - route to WebSocket/Pipecat
; Ameyo sends caller ID with metadata: "00919990152080|d444-69139d35-vce-daf-3883"
; Extract phone number and strip "00" international prefix
exten => _.,1,NoOp(Inbound call from Ameyo - From: ${CALLERID(all)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(CALLER_WITH_META=${CALLERID(name)})
 same => n,Set(WS_PJSIP_CHANNEL=${UNIQUEID})
 same => n,Set(TEMP_FROM=${CUT(CALLER_WITH_META,|,1)})
 same => n,Set(AMEYO_METADATA=${CUT(CALLER_WITH_META,|,2)})
 same => n,Set(__CUSTOM_VARS=unique_id=${AMEYO_METADATA})
 ; Strip leading "00" then prepend '+'
 same => n,Set(WS_FROM=+${IF($["${TEMP_FROM:0:2}"="00"]?${TEMP_FROM:2}:${TEMP_FROM})})
 same => n,Set(WS_TO=+${IF($["${EXTEN:0:2}"="00"]?${EXTEN:2}:${EXTEN})})
 same => n,NoOp(Cleaned - From: ${WS_FROM}, To: ${WS_TO}, Metadata: ${AMEYO_METADATA})
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 ;same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${CUT(SIP_CALL_ID,@,1)}:${UNIQUEID})})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})},pjsip_channel=${URIENCODE(${WS_PJSIP_CHANNEL})}),300)
 same => n,Hangup()

[Groww_RINGG]
; Groww sends caller ID with metadata similar to Ameyo: "00919990152080|metadata"
; Extract phone number and strip "00" international prefix
exten => _.,1,NoOp(Inbound call from Groww - From: ${CALLERID(all)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(CALLER_WITH_META=${CALLERID(name)})
 same => n,Set(TEMP_FROM=${CUT(CALLER_WITH_META,|,1)})
 same => n,Set(GROWW_METADATA=${CUT(CALLER_WITH_META,|,2)})
 same => n,Set(__CUSTOM_VARS=unique_id=${GROWW_METADATA})
 ; Strip leading "00" then prepend '+'
 same => n,Set(WS_FROM=+${IF($["${TEMP_FROM:0:2}"="00"]?${TEMP_FROM:2}:${TEMP_FROM})})
 same => n,Set(WS_TO=+${IF($["${EXTEN:0:2}"="00"]?${EXTEN:2}:${EXTEN})})
 same => n,NoOp(Cleaned - From: ${WS_FROM}, To: ${WS_TO}, Metadata: ${GROWW_METADATA})
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()


[Active8_RINGG]
; Inbound calls from Active8/Gamma UK - DID: 01636554260
exten => _.,1,NoOp(Inbound call from Active8 - From: ${CALLERID(all)}, To: ${EXTEN})
 same => n,Answer()
 same => n,Set(MIXMON_FILE=/var/spool/asterisk/monitor/inbound-${CONTEXT}-${UNIQUEID}-${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}.wav)
 same => n,MixMonitor(${MIXMON_FILE},b)
 same => n,Set(SIP_CALL_ID=${PJSIP_HEADER(read,Call-ID)})
 same => n,Set(WS_CALL_ID=${IF($["${SIP_CALL_ID}" != ""]?${SIP_CALL_ID}:${UNIQUEID})})
 same => n,Set(WS_FROM=${CALLERID(num)})
 same => n,Set(WS_TO=+44${EXTEN:1})
 same => n,Set(NATIVE_CODEC=${CHANNEL(audionativeformat)})
 same => n,Set(WS_CODEC=${IF($[${REGEX("alaw" ${NATIVE_CODEC})}]?alaw:${IF($[${REGEX("slin" ${NATIVE_CODEC})}]?slin:ulaw)})})
 same => n,Dial(WebSocket/pipecat_media_us_prod/c(${WS_CODEC})v(direction=inbound,call_id=${URIENCODE(${WS_CALL_ID})},from_number=${URIENCODE(${WS_FROM})},to_number=${URIENCODE(${WS_TO})}),300)
 same => n,Hangup()