---
version: 2.1
commands:
  tox:
    description: "Run tox"
    parameters:
      env:
        type: string
    steps:
      - run:
          name: Install tox
          command: pip install tox
      - run:
          name: Run tests via tox
          # Piping through cat does less buffering of the output but can
          # consume the exit code
          command: tox -e << parameters.env >> | cat; test ${PIPESTATUS[0]} -eq 0
  coverage:
    description: "Upload coverage"
    steps:
      - run:
          name: Install Codecov client
          command: pip install codecov
      - run:
          name: Upload coverage
          command: codecov --tries 10 --required --disable search pycov gcov --root project --file .tox/coverage/py_coverage.xml
  pyenv:
    description: "Install python via pyenv"
    parameters:
      version:
        type: string
    steps:
      - run:
          name: Upgrade pyenv
          command: |
            sudo rm -rf /opt/circleci/.pyenv
            sudo bash -c 'curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | PYENV_ROOT=/opt/circleci/.pyenv bash'
            sudo chmod -R 777 /opt/circleci/.pyenv/
            pyenv install --list list
      - run:
          name: Use pyenv to install python
          command: |
            pyenv install -s << parameters.version >>
      - run:
          name: Use pyenv to set python version
          command: |
            pyenv versions
            pyenv global << parameters.version >>
jobs:
  py38:
    docker:
      - image: python:3.8-slim
    steps:
      - checkout
      - tox:
          env: py38
      - coverage
  py39:
    docker:
      - image: python:3.9-slim
    steps:
      - checkout
      - tox:
          env: py39
      - coverage
  py310:
    docker:
      - image: python:3.10-slim
    steps:
      - checkout
      - tox:
          env: py310
      - coverage
  py311:
    docker:
      - image: python:3.11-slim
    steps:
      - checkout
      - tox:
          env: py311
      - coverage
  py312:
    docker:
      - image: python:3.12-slim
    steps:
      - checkout
      - tox:
          env: py312
      - coverage
  py313:
    docker:
      - image: python:3.13-slim
    steps:
      - checkout
      - tox:
          env: py313
      - coverage
  py313t:
    machine:
      image: ubuntu-2204:current
    steps:
      - pyenv:
          version: "3.13t"
      - checkout
      - tox:
          env: py313t
      - coverage
  py314:
    docker:
      - image: python:3.14-slim
    steps:
      - checkout
      - tox:
          env: py314
      - coverage
  py314t:
    machine:
      image: ubuntu-2204:current
    steps:
      - pyenv:
          version: "3.14t"
      - checkout
      - tox:
          env: py314t
      - coverage
  pypy38:
    docker:
      - image: pypy:3.8
    steps:
      - checkout
      - tox:
          env: test-pypy38
      - coverage
  pypy39:
    docker:
      - image: pypy:3.9
    steps:
      - checkout
      - tox:
          env: test-pypy39
      - coverage
  pypy310:
    docker:
      - image: pypy:3.10
    steps:
      - checkout
      - tox:
          env: test-pypy310
      - coverage
  pypy311:
    docker:
      - image: pypy:3.11
    steps:
      - checkout
      - tox:
          env: test-pypy311
      - coverage
  lint_and_docs:
    docker:
      - image: python:3.8-slim
    steps:
      - checkout
      - tox:
          env: lint
  checkrelease:
    docker:
      - image: python:3.8-slim
    steps:
      - checkout:
          method: full
      - run:
          name: Install git
          command: apt-get update -yq && apt-get install -yq git
      - run:
          name: Install tox
          command: pip install tox setuptools_scm
      - run:
          name: Check version number
          command: python -c 'import sys, setuptools_scm; print(setuptools_scm.get_version().strip()); sys.exit(1 if setuptools_scm.get_version().strip()=="0.0.0" else 0)'
      - run:
          name: Run release command via tox
          # Piping through cat does less buffering of the output but can
          # consume the exit code
          command: tox -e checkrelease | cat; test ${PIPESTATUS[0]} -eq 0
  release:
    docker:
      - image: python:3.8-slim
    steps:
      - checkout:
          method: full
      - run:
          name: Install git
          command: apt-get update -yq && apt-get install -yq git
      - run:
          name: Install tox
          command: pip install tox setuptools_scm
      - run:
          name: Check version number
          command: python -c 'import sys, setuptools_scm; print(setuptools_scm.get_version().strip()); sys.exit(1 if setuptools_scm.get_version().strip()=="0.0.0" else 0)'
      - run:
          name: Run release command via tox
          # Piping through cat does less buffering of the output but can
          # consume the exit code
          command: tox -e release | cat; test ${PIPESTATUS[0]} -eq 0
workflows:
  version: 2
  ci:
    jobs:
      - py38:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py39:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py310:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py311:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py312:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py313:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py313t:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py314:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - py314t:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - pypy38:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - pypy39:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - pypy310:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - pypy311:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - lint_and_docs:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - checkrelease:
          requires:
            - py38
            - py39
            - py310
            - py311
            - py312
            - py313
            - py313t
            - py314
            - py314t
            - pypy38
            - pypy39
            - pypy310
            - pypy311
            - lint_and_docs
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore:
                - gh-pages
      - release:
          requires:
            - checkrelease
          filters:
            tags:
              only: /^v.*/
            branches:
              only: master
