# Apache configuration for api.osc.earth
# Location: /etc/apache2/sites-available/api.osc.earth.conf
#
# This configuration proxies requests to the OSA Docker containers:
#   /osa/     -> localhost:38528 (prod)
#   /osa-dev/ -> localhost:38529 (dev)

<VirtualHost *:80>
    ServerName api.osc.earth
    # Redirect to HTTPS
    RewriteEngine On
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName api.osc.earth

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/api.osc.earth/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.osc.earth/privkey.pem

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/api.osc.earth-error.log
    CustomLog ${APACHE_LOG_DIR}/api.osc.earth-access.log combined

    # ==========================================================================
    # PRODUCTION: OSA API Backend (port 38528)
    # ==========================================================================
    ProxyPass /osa/ http://localhost:38528/
    ProxyPassReverse /osa/ http://localhost:38528/

    # ==========================================================================
    # DEVELOPMENT: OSA Dev API Backend (port 38529)
    # ==========================================================================
    ProxyPass /osa-dev/ http://localhost:38529/
    ProxyPassReverse /osa-dev/ http://localhost:38529/

    # Proxy settings
    ProxyPreserveHost On
</VirtualHost>

# =============================================================================
# Setup Instructions
# =============================================================================
#
# 1. Copy this file to the server:
#    scp deploy/apache-api.osc.earth.conf user@hedtools.ucsd.edu:/tmp/
#
# 2. Move to Apache sites directory:
#    sudo mv /tmp/apache-api.osc.earth.conf /etc/apache2/sites-available/
#
# 3. Enable required modules:
#    sudo a2enmod proxy proxy_http ssl rewrite
#
# 4. Enable the site:
#    sudo a2ensite api.osc.earth.conf
#
# 5. Test Apache config:
#    sudo apache2ctl configtest
#
# 6. Reload Apache:
#    sudo systemctl reload apache2
#
# 7. Verify:
#    curl https://api.osc.earth/osa/health
#    curl https://api.osc.earth/osa-dev/health
