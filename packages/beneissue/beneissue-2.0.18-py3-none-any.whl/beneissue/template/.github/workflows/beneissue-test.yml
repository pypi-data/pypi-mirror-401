# beneissue - Test workflow for metrics integration
# Verifies Supabase connection when secrets are configured.
#
# Generated by: beneissue init
# Docs: https://github.com/opendataloader-project/beneissue

name: beneissue-test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test type to run'
        required: true
        type: choice
        options:
          - connection
          - policy
        default: 'connection'

permissions:
  contents: read

jobs:
  test-connection:
    # Test Supabase metrics connection
    if: inputs.test_type == 'connection'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: astral-sh/setup-uv@v4

      - name: Install beneissue
        run: uv pip install --system beneissue

      - name: Test Supabase connection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          python3 << 'EOF'
          import os
          import sys

          url = os.environ.get("SUPABASE_URL")
          key = os.environ.get("SUPABASE_SERVICE_KEY")

          if not url or not key:
              print("⚠️ SUPABASE_URL or SUPABASE_SERVICE_KEY not configured")
              print("   Metrics storage is disabled (this is optional)")
              print("   To enable: Settings → Secrets → Add SUPABASE_URL and SUPABASE_SERVICE_KEY")
              sys.exit(0)

          print("✓ SUPABASE_URL configured")
          print("✓ SUPABASE_SERVICE_KEY configured")

          # Test connection
          try:
              from supabase import create_client
              client = create_client(url, key)

              # Try to query (will fail if table doesn't exist, but connection works)
              result = client.table("workflow_runs").select("id").limit(1).execute()
              print(f"✓ Supabase connection successful")
              print(f"  Table 'workflow_runs' exists with {len(result.data)} sample row(s)")
          except Exception as e:
              if "relation" in str(e) and "does not exist" in str(e):
                  print("⚠️ Connection works but 'workflow_runs' table not found")
                  print("   Run the SQL setup script: scripts/sql/001_create_tables.sql")
                  sys.exit(1)
              else:
                  print(f"✗ Supabase connection failed: {e}")
                  sys.exit(1)
          EOF

  test-policy:
    # Run beneissue policy tests
    if: inputs.test_type == 'policy'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - uses: astral-sh/setup-uv@v4

      - name: Install beneissue
        run: uv pip install --system beneissue

      - name: Check for test cases
        id: check-cases
        run: |
          if [ -d ".claude/skills/beneissue/tests/cases" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "⚠️ Test cases directory not found: .claude/skills/beneissue/tests/cases"
            echo "   Skipping policy tests (no test cases configured)"
          fi

      - name: Run policy tests
        if: steps.check-cases.outputs.exists == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          if [ -z "$ANTHROPIC_API_KEY" ]; then
            echo "Running in dry-run mode (no API key)"
            beneissue test --dry-run
          else
            beneissue test
          fi
