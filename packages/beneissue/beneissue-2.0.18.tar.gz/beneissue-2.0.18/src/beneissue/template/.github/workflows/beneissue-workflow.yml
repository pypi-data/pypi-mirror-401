# beneissue - AI-powered GitHub issue automation
# Automatically triages, analyzes, and fixes issues using Claude AI.
#
# Generated by: beneissue init
# Docs: https://github.com/opendataloader-project/beneissue
# PyPI: https://pypi.org/project/beneissue/

name: beneissue

on:
  issues:
    types: [opened, reopened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      command:
        description: 'Command to run'
        required: true
        type: choice
        options:
          - triage
          - analyze
          - fix
          - run
        default: 'analyze'
      issue_number:
        description: 'Issue number to process'
        required: true
        type: number
      dry_run:
        description: 'Use mock LLM data (skip API calls)'
        required: false
        type: boolean
        default: false
      no_action:
        description: 'Skip GitHub actions (labels, comments, PR)'
        required: false
        type: boolean
        default: false

permissions:
  issues: write
  contents: write
  pull-requests: write

jobs:
  process-issue:
    # Run on new or reopened issues
    if: github.event_name == 'issues'
    runs-on: ubuntu-latest
    steps:
      - uses: opendataloader-project/beneissue@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          langchain-api-key: ${{ secrets.LANGCHAIN_API_KEY }}
          langchain-project: ${{ vars.LANGCHAIN_PROJECT }}
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-service-key: ${{ secrets.SUPABASE_SERVICE_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          command: run

  on-command:
    # Run on @beneissue commands in comments
    # Supported: @beneissue triage, @beneissue analyze, @beneissue fix, @beneissue run
    # Restricted to repository collaborators only
    if: |
      github.event_name == 'issue_comment' &&
      contains(github.event.comment.body, '@beneissue') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    runs-on: ubuntu-latest
    steps:
      - name: Parse command
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body || '';
            const validCommands = ['triage', 'analyze', 'fix', 'run', 'manual'];
            let command = 'run';

            for (const cmd of validCommands) {
              if (comment.includes(`@beneissue ${cmd}`)) {
                command = cmd;
                break;
              }
            }

            core.setOutput('command', command);

      - uses: opendataloader-project/beneissue@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          langchain-api-key: ${{ secrets.LANGCHAIN_API_KEY }}
          langchain-project: ${{ vars.LANGCHAIN_PROJECT }}
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-service-key: ${{ secrets.SUPABASE_SERVICE_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          command: ${{ steps.parse.outputs.command }}

  manual:
    # Run manually via workflow_dispatch
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: opendataloader-project/beneissue@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ inputs.dry_run && '' || secrets.ANTHROPIC_API_KEY }}
          langchain-api-key: ${{ secrets.LANGCHAIN_API_KEY }}
          langchain-project: ${{ vars.LANGCHAIN_PROJECT }}
          supabase-url: ${{ secrets.SUPABASE_URL }}
          supabase-service-key: ${{ secrets.SUPABASE_SERVICE_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY }}
          command: ${{ inputs.command }}
          issue-number: ${{ inputs.issue_number }}
        env:
          BENEISSUE_DRY_RUN: ${{ inputs.dry_run }}
          BENEISSUE_NO_ACTION: ${{ inputs.no_action }}
