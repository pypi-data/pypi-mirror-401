"""用户路由"""
from common.base_router import NO_AUTH, ApiRouter
from common.entity.base_response import BaseResponse
from common.entity.schemas.user import (
    LoginRequest,
    LoginResponse,
    UserCreateRequest,
    UserListResponse,
    UserResponse,
    UserUpdateRequest,
)
from common.utils import create_access_token, hash_password, verify_password
from fastapi import HTTPException, status
from models.user import User

# 默认所有路由需要认证
router = ApiRouter(prefix="/api/v1/user", tags=["user"])


@router.post("/login", response_model=BaseResponse[LoginResponse], dependencies=NO_AUTH)
async def login(request: LoginRequest):
    """用户登录"""
    users = await User.get_by_filter(username=request.username)
    if not users:
        raise HTTPException(status_code=401, detail="用户名或密码错误")

    user = users[0]
    if not verify_password(request.password, user.password_hash):
        raise HTTPException(status_code=401, detail="用户名或密码错误")

    access_token = create_access_token(data={"sub": str(user.id)})
    user_response = UserResponse(
        id=user.id,
        username=user.username,
        email=user.email,
        create_time=user.create_time
    )

    return BaseResponse(
        code=0,
        message="登录成功",
        data=LoginResponse(access_token=access_token, token_type="bearer", user=user_response)
    )


@router.post("", response_model=BaseResponse[UserResponse], dependencies=NO_AUTH)
async def create_user(request: UserCreateRequest):
    """创建用户"""
    if await User.get_by_filter(username=request.username):
        raise HTTPException(status_code=400, detail="用户名已存在")
    if await User.get_by_filter(email=request.email):
        raise HTTPException(status_code=400, detail="邮箱已存在")

    password_hash = hash_password(request.password)
    new_user = await User.create(
        username=request.username,
        email=request.email,
        password_hash=password_hash
    )

    user_response = UserResponse(
        id=new_user.id,
        username=new_user.username,
        email=new_user.email,
        create_time=new_user.create_time
    )

    return BaseResponse(code=0, message="创建用户成功", data=user_response)


@router.get("/list", response_model=BaseResponse[UserListResponse])
async def get_user_list(skip: int = 0, limit: int = 10):
    """获取用户列表"""
    users = await User.get_all(skip=skip, limit=limit)
    total = await User.count()

    user_responses = [
        UserResponse(id=u.id, username=u.username, email=u.email, create_time=u.create_time)
        for u in users
    ]

    return BaseResponse(
        code=0,
        message="获取用户列表成功",
        data=UserListResponse(total=total, items=user_responses)
    )


@router.get("/{user_id}", response_model=BaseResponse[UserResponse])
async def get_user(user_id: int):
    """获取单个用户"""
    user = await User.get_by_id(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="用户不存在")

    user_response = UserResponse(
        id=user.id,
        username=user.username,
        email=user.email,
        create_time=user.create_time
    )

    return BaseResponse(code=0, message="获取用户成功", data=user_response)


@router.put("/{user_id}", response_model=BaseResponse[UserResponse])
async def update_user(user_id: int, request: UserUpdateRequest):
    """更新用户"""
    user = await User.get_by_id(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="用户不存在")

    update_data = {}
    if request.username is not None:
        if await User.get_by_filter(username=request.username):
            raise HTTPException(status_code=400, detail="用户名已存在")
        update_data["username"] = request.username
    if request.email is not None:
        if await User.get_by_filter(email=request.email):
            raise HTTPException(status_code=400, detail="邮箱已存在")
        update_data["email"] = request.email
    if request.password is not None:
        update_data["password_hash"] = hash_password(request.password)

    if update_data:
        updated_user = await User.update_by_id(user_id, **update_data)
        user_response = UserResponse(
            id=updated_user.id,
            username=updated_user.username,
            email=updated_user.email,
            create_time=updated_user.create_time
        )
        return BaseResponse(code=0, message="更新用户成功", data=user_response)

    user_response = UserResponse(
        id=user.id,
        username=user.username,
        email=user.email,
        create_time=user.create_time
    )
    return BaseResponse(code=0, message="没有需要更新的字段", data=user_response)


@router.delete("/{user_id}", response_model=BaseResponse[dict])
async def delete_user(user_id: int):
    """删除用户"""
    user = await User.get_by_id(user_id)
    if not user:
        raise HTTPException(status_code=404, detail="用户不存在")

    deleted = await User.delete_by_id(user_id)
    if deleted:
        return BaseResponse(code=0, message="删除用户成功", data={"deleted": True})

    raise HTTPException(status_code=500, detail="删除用户失败")
