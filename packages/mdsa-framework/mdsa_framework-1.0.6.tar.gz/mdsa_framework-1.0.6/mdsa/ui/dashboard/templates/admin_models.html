<!DOCTYPE html>
<html>
<head>
    <title>MDSA Dashboard - Model Configuration</title>
    <link rel="stylesheet" href="/static/css/dashboard.css">
    <style>
        .config-section {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 25px;
            margin: 20px 0;
        }

        .config-section h2 {
            margin-top: 0;
            color: #2196F3;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 10px;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .config-item {
            display: flex;
            flex-direction: column;
        }

        .config-item label {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .config-item input,
        .config-item select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .config-item input:focus,
        .config-item select:focus {
            outline: none;
            border-color: #2196F3;
        }

        .config-item .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .domain-model-list {
            margin-top: 20px;
        }

        .domain-model-item {
            background: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .domain-model-item h4 {
            margin: 0 0 12px 0;
            color: #333;
        }

        .domain-model-item .model-selector {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .save-button {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .save-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .save-button:disabled {
            cursor: not-allowed;
        }

        .reset-button {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            margin-top: 20px;
            margin-left: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .reset-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
            min-width: 300px;
        }

        .notification.success {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-left: 4px solid #34D399;
        }

        .notification.error {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
            border-left: 4px solid #F87171;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .user-info {
            float: right;
            color: #666;
            font-size: 14px;
        }

        .logout-btn {
            background: #f44336;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 10px;
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196F3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .warning-box {
            background: #fff3e0;
            border-left: 4px solid #FF9800;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #E65100;
        }

        .model-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #1976D2;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Model Configuration</h1>
        <p>Configure orchestration and domain models</p>
        <div class="user-info">
            Logged in as: <strong>{{ user.name }}</strong>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div class="nav">
            <a href="/welcome">üè† Home</a>
            <a href="/admin/rag">üì§ RAG Management</a>
            <a href="/admin/models" class="active">üîß Model Configuration</a>
            <a href="/admin/tools">üõ†Ô∏è Tools</a>
            <a href="/domains">üéØ Domains</a>
            <a href="/admin/monitor">üìä Monitor</a>
        </div>

        <div class="warning-box">
            <strong>‚ö†Ô∏è Warning:</strong> Changes to model configuration require restarting the application to take effect. Make sure to save your configuration before restarting.
        </div>

        <!-- Orchestration Settings -->
        <div class="config-section">
            <h2>üéØ Orchestration Configuration</h2>
            <div class="info-box">
                The orchestrator uses TinyBERT for intent classification and Phi-2 for complex reasoning.
            </div>

            <div class="config-grid">
                <div class="config-item">
                    <label for="orchestratorModel">Orchestrator Model</label>
                    <select id="orchestratorModel">
                        <option value="google/bert_uncased_L-2_H-128_A-2" selected>TinyBERT (Default)</option>
                        <option value="prajjwal1/bert-tiny">BERT-Tiny</option>
                        <option value="prajjwal1/bert-mini">BERT-Mini</option>
                    </select>
                    <span class="help-text">Small model for fast intent classification</span>
                </div>

                <div class="config-item">
                    <label for="reasoningModel">Reasoning Model</label>
                    <input type="text" id="reasoningModel" value="{{ config.reasoning_model or 'microsoft/phi-2' }}">
                    <span class="help-text">Model for complex query analysis</span>
                </div>

                <div class="config-item">
                    <label for="complexityThreshold">Complexity Threshold</label>
                    <input type="number" id="complexityThreshold" min="0" max="1" step="0.01" value="{{ config.complexity_threshold or '0.2' }}">
                    <span class="help-text">Threshold for triggering reasoning (0.0-1.0)</span>
                </div>

                <div class="config-item">
                    <label for="enableReasoning">Enable Reasoning</label>
                    <select id="enableReasoning">
                        <option value="true" {{ 'selected' if config.enable_reasoning else '' }}>Enabled</option>
                        <option value="false" {{ 'selected' if not config.enable_reasoning else '' }}>Disabled</option>
                    </select>
                    <span class="help-text">Use Phi-2 for complex queries</span>
                </div>
            </div>
        </div>

        <!-- Domain Models -->
        <div class="config-section">
            <h2>ü§ñ Domain Model Configuration</h2>
            <div class="info-box">
                Each domain can use a different specialized model. Changes are saved to the configuration file.
            </div>

            <div id="domainModelList" class="domain-model-list">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>

        <!-- Available Models -->
        <div class="config-section">
            <h2>üì¶ Available Models</h2>
            <div class="config-grid">
                <div class="config-item">
                    <label>Available Models (from registered apps)</label>
                    <ul id="availableModelsList" style="font-size: 13px; color: #666; margin: 10px 0;">
                        <li>Loading models from registered apps...</li>
                    </ul>
                </div>

                <div class="config-item">
                    <label>Local Models</label>
                    <input type="text" id="customModel" placeholder="Add custom model name...">
                    <span class="help-text">E.g., llama3:8b, mistral:7b</span>
                </div>
            </div>
        </div>

        <div style="text-align: center;">
            <button class="save-button" onclick="saveConfiguration()">üíæ Save Configuration</button>
            <button class="reset-button" onclick="resetConfiguration()">üîÑ Reset to Defaults</button>
            <button class="save-button" onclick="reloadConfiguration()" style="background: #FF9800;">üîÑ Reload from File</button>
        </div>

        <div class="info-box" style="margin-top: 20px;">
            <strong>üí° Configuration Tips:</strong><br>
            ‚Ä¢ <strong>Save Configuration:</strong> Saves your changes to mdsa_config.json<br>
            ‚Ä¢ <strong>Reset to Defaults:</strong> Restores factory default settings<br>
            ‚Ä¢ <strong>Reload from File:</strong> Reloads domains from mdsa_config.json without restarting the dashboard (use this after manually editing the config file)
        </div>
    </div>

    <script>
        let currentConfig = {{ config_json | safe }};
        let domains = {{ domains_json | safe }};
        let availableModels = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableModels();
            loadDomainModels();
        });

        async function loadAvailableModels() {
            try {
                const response = await fetch('/api/models');
                if (response.ok) {
                    const data = await response.json();
                    availableModels = data.models || [];
                    renderAvailableModels();
                    // Re-render domain models with updated options
                    loadDomainModels();
                }
            } catch (error) {
                console.error('Error loading models:', error);
            }
        }

        function renderAvailableModels() {
            const container = document.getElementById('availableModelsList');
            if (!container) return;

            if (availableModels.length === 0) {
                container.innerHTML = '<li>No models found. Start your application to see models.</li>';
                return;
            }

            container.innerHTML = availableModels.map(m => {
                const name = m.model_name || m.name || m.model || m;
                const domain = m.domain_name || m.domain || '';
                const badge = domain ? `<span class="model-badge">${domain}</span>` : '';
                return `<li>${name} ${badge}</li>`;
            }).join('');
        }

        function loadDomainModels() {
            const container = document.getElementById('domainModelList');
            container.innerHTML = '';

            domains.forEach(domain => {
                const item = document.createElement('div');
                item.className = 'domain-model-item';
                item.innerHTML = `
                    <h4>${domain.domain_id}</h4>
                    <div class="model-selector">
                        <select id="domain-${domain.domain_id}" data-domain="${domain.domain_id}">
                            ${getModelOptions(domain.model || domain.model_name)}
                        </select>
                        <span style="color: #666; font-size: 13px;">Current: ${domain.model || domain.model_name || 'Not configured'}</span>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        function getModelOptions(currentModel) {
            // Build models list dynamically from fetched models + defaults
            let modelNames = availableModels.map(m => m.model_name || m.name || m.model || m);

            // Add default fallbacks if no models loaded
            if (modelNames.length === 0) {
                modelNames = [
                    'ollama://llama3.2:3b',
                    'ollama://mistral:7b',
                    'microsoft/phi-2'
                ];
            }

            // Add custom option
            modelNames.push('custom');

            // Remove duplicates
            modelNames = [...new Set(modelNames)];

            return modelNames.map(model => {
                const selected = model === currentModel ? 'selected' : '';
                const displayName = String(model).replace('ollama://', '');
                return `<option value="${model}" ${selected}>${displayName}</option>`;
            }).join('');
        }

        async function saveConfiguration() {
            const saveButton = document.querySelector('.save-button');
            const originalText = saveButton.innerHTML;

            // Show loading state
            saveButton.innerHTML = '‚è≥ Saving...';
            saveButton.disabled = true;
            saveButton.style.opacity = '0.7';

            const config = {
                orchestration: {
                    orchestrator_model: document.getElementById('orchestratorModel').value,
                    reasoning_model: document.getElementById('reasoningModel').value,
                    complexity_threshold: parseFloat(document.getElementById('complexityThreshold').value),
                    enable_reasoning: document.getElementById('enableReasoning').value === 'true'
                },
                domain_models: {}
            };

            // Collect domain model selections
            domains.forEach(domain => {
                const selector = document.getElementById(`domain-${domain.domain_id}`);
                if (selector) {
                    config.domain_models[domain.domain_id] = selector.value;
                }
            });

            try {
                const response = await fetch('/api/admin/models/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    saveButton.innerHTML = '‚úÖ Saved!';
                    showNotification('‚úÖ Configuration saved successfully! Reloading page...', 'success');
                    // Reload page to show updated values
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const error = await response.json();
                    saveButton.innerHTML = originalText;
                    saveButton.disabled = false;
                    saveButton.style.opacity = '1';
                    showNotification(`‚ùå Error saving configuration: ${error.detail}`, 'error');
                }
            } catch (error) {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
                saveButton.style.opacity = '1';
                showNotification('‚ùå Error saving configuration: ' + error.message, 'error');
            }
        }

        async function resetConfiguration() {
            if (!confirm('Are you sure you want to reset to default configuration?')) {
                return;
            }

            try {
                const response = await fetch('/api/admin/models/config/reset', {
                    method: 'POST'
                });

                if (response.ok) {
                    showNotification('Configuration reset to defaults', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification('Error resetting configuration', 'error');
                }
            } catch (error) {
                showNotification('Error resetting configuration', 'error');
            }
        }

        async function reloadConfiguration() {
            try {
                showNotification('Reloading configuration...', 'success');

                const response = await fetch('/api/admin/reload-config', {
                    method: 'POST',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(
                        `‚úÖ Configuration reloaded! ${result.domains_loaded} domains loaded from config file.`,
                        'success'
                    );
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showNotification(`‚ùå Error: ${result.detail || 'Failed to reload configuration'}`, 'error');
                }
            } catch (error) {
                showNotification(`‚ùå Error reloading configuration: ${error.message}`, 'error');
            }
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        async function logout() {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
    </script>
</body>
</html>
