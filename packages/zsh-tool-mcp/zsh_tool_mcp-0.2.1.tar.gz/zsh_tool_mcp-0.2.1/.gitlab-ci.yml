# GitLab CI: Sync releases to GitHub
# Triggers on tags, mirrors to ArkTechNWA/zsh-tool

stages:
  - sync

variables:
  GITHUB_REPO: "git@github.com:ArkTechNWA/zsh-tool.git"

sync-to-github:
  stage: sync
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_TAG
      when: always
    - if: $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
  before_script:
    - apk add --no-cache git openssh-client
    - mkdir -p ~/.ssh
    - echo "$GITHUB_DEPLOY_KEY" > ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.email "claude@arktechnwa.com"
    - git config --global user.name "Johnny5 CI"
  script:
    - git remote add github $GITHUB_REPO || git remote set-url github $GITHUB_REPO
    - git fetch --unshallow origin || true
    - git push github HEAD:refs/heads/master --force
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        git push github "$CI_COMMIT_TAG"
      fi
  tags:
    - docker
