#!/usr/bin/env python
# -*- coding: utf-8 -*-
"""
Complete Electromagnet Simulation Workflow

This script performs the complete simulation workflow:
1. Import yoke mesh from York_cubit.bdf (generated by Cubit)
2. Create racetrack coil
3. Combine coil + yoke into Radia model
4. Export Radia_model.vtk (geometry visualization)
5. Calculate magnetic field distribution
6. Export field_distribution.vtk (field data for ParaView)

Requirements:
- York_cubit.bdf (generated by Cubit from York.jou)
- nastran_mesh_import.py
- racetrack_coil_model.py
- yoke_model.py
"""

import os
import sys
import numpy as np

# Add Radia module path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../build/Release'))
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../src/python'))

import radia as rad
from nastran_mesh_import import create_radia_from_nastran

# Set Radia unit system to millimeters (default, but explicit for clarity)
rad.FldUnits('mm')

print("=" * 70)
print("ELECTROMAGNET SIMULATION WORKFLOW")
print("=" * 70)
print(f"Unit system: mm (millimeters)")

# ========================================================================
# Step 1: Import Yoke Mesh from Nastran
# ========================================================================
print("\n[Step 1/5] Importing yoke mesh from York.bdf...")

script_dir = os.path.dirname(__file__)
nastran_file = os.path.join(script_dir, 'York.bdf')

if not os.path.exists(nastran_file):
    print(f"[ERROR] Nastran file not found: {nastran_file}")
    print(f"  Please run Cubit with York.jou to generate York.bdf")
    sys.exit(1)

# Import mesh (soft iron, no initial magnetization)
yoke = create_radia_from_nastran(nastran_file, material={'magnetization': [0, 0, 0]},
                                   units='mm', combine=True, verbose=True)

# Apply soft iron material
yoke_mat = rad.MatSatIsoFrm([20000, 2], [0.1, 2], [0.1, 2])
rad.MatApl(yoke, yoke_mat)

# Set yoke color to cyan
rad.ObjDrwAtr(yoke, [0, 1, 1])  # RGB: cyan

print(f"  [OK] Yoke imported: ID={yoke}")

# ========================================================================
# Step 2: Create Racetrack Coil
# ========================================================================
print("\n[Step 2/5] Creating racetrack coil...")

coil = rad.ObjRaceTrk(
    [0, 131.25, 0],  # center (mm)
    [5, 40],         # lx_min, lx_max (mm)
    [50, 62.5],      # ly_min, ly_max (mm)
    105,             # height (mm)
    3,               # nseg
    -2000/105/35     # current density (A/mm^2): -2000A total
)

# Set coil color to red
rad.ObjDrwAtr(coil, [1, 0, 0])  # RGB: red

print(f"  [OK] Coil created: ID={coil}")
print(f"  Total current: -2000 A")

# ========================================================================
# Step 3: Combine into Radia Model
# ========================================================================
print("\n[Step 3/5] Combining coil + yoke...")

g = rad.ObjCnt([coil, yoke])
print(f"  [OK] Combined model: ID={g}")

# ========================================================================
# Step 4: Export Radia_model.vts (Field Distribution)
# ========================================================================
print("\n[Step 4/5] Exporting Radia_model.vts...")

# ========================================================================
# Step 5: Calculate and Export Field Distribution
# ========================================================================
print("\n[Step 5/5] Calculating magnetic field distribution...")

# Solve magnetostatics
print(f"  Solving magnetostatics...")
rad.Solve(g, 0.0001, 10000)
print(f"  [OK] Solution converged")

# Define field evaluation grid
# Combined geometry bbox: X[-40, 40], Y[-25, 193.8], Z[-52.5, 162.5] mm
# Add 50mm margin around geometry
x_range_bounds = [-90, 90]
y_range_bounds = [-75, 245]
z_range_bounds = [-105, 215]

# Export field distribution to VTS format
try:
    vts_path = os.path.join(script_dir, 'field_distribution.vts')
    rad.FldVTS(g, vts_path, x_range_bounds, y_range_bounds, z_range_bounds, 21, 31, 21, 1, 0, 1.0)
    print(f"  [OK] Field distribution exported to field_distribution.vts")
except Exception as e:
    print(f"  [WARNING] VTS export failed: {e}")

# ========================================================================
# Summary
# ========================================================================
print("\n" + "=" * 70)
print("SIMULATION COMPLETE")
print("=" * 70)
print(f"\nGenerated files:")
print(f"  1. field_distribution.vts - Magnetic field data (VTS format)")
print(f"\nVisualize with ParaView:")
print(f"  paraview field_distribution.vts")
print("=" * 70)
