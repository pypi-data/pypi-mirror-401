[tox]
envlist =
    tests
    linting
    coverage
    type_check
skip_missing_interpreters = True
skipsdist = True

[testenv]
commands = python -m pip install --upgrade pip

[testenv:tests]
deps =
    -r requirements.txt
    .[tests]
setenv = PYTHONPATH = {toxinidir}/src
commands = python -m pytest --basetemp={envtmpdir} {posargs}

[testenv:linting]
deps =
    {[testenv:tests]deps}
    .[linting]
setenv = PYTHONPATH = {toxinidir}/src
commands =
    pylint decidalo_client --ignore=_autogenerated.py
    pylint unittests --rcfile=unittests/.pylintrc

[testenv:type_check]
setenv = PYTHONPATH = {toxinidir}/src
deps =
    {[testenv:tests]deps}
    .[type_check]
commands =
    mypy --show-error-codes src/decidalo_client --strict --ignore-missing-imports
    mypy --show-error-codes unittests --strict --ignore-missing-imports

[testenv:spell_check]
setenv = PYTHONPATH = {toxinidir}/src
deps =
    -r requirements.txt
    .[spell_check]
commands =
    codespell --ignore-words=domain-specific-terms.txt --skip=_autogenerated.py src
    codespell --ignore-words=domain-specific-terms.txt README.md

[testenv:coverage]
changedir = unittests
deps =
    {[testenv:tests]deps}
    .[coverage]
setenv = PYTHONPATH = {toxinidir}/src
commands =
    coverage run -m pytest --basetemp={envtmpdir} {posargs}
    coverage html --omit .tox/*,unittests/*
    coverage report --fail-under 80 --omit .tox/*,unittests/*

[testenv:codegen]
deps =
    .[codegen]
    .[formatting]
setenv = PYTHONPATH = {toxinidir}/src
commands =
    datamodel-codegen --input openapi/v1/swagger.json --output src/decidalo_client/models/_autogenerated.py --input-file-type openapi --output-model-type pydantic_v2.BaseModel --target-python-version 3.11 --use-annotated --use-double-quotes --collapse-root-models --field-constraints --strict-nullable --use-standard-collections --enum-field-as-literal one
    black src/decidalo_client/models/_autogenerated.py
    isort src/decidalo_client/models/_autogenerated.py

[testenv:dev]
deps =
    {[testenv:tests]deps}
    {[testenv:linting]deps}
    {[testenv:type_check]deps}
    {[testenv:coverage]deps}
    {[testenv:spell_check]deps}
    .[formatting]
    .[dev]
    .[codegen]
commands =
    python -m pip install --upgrade pip
    pip install -r requirements.txt

[testenv:test_packaging]
skip_install = true
deps =
    .[packaging]
commands =
    python -m build
    twine check dist/*
