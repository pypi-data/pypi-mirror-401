# OpenAPI Sync Automation Workflow
# Issue #57 - Create OpenAPI sync automation
# Fetches and compares OpenAPI specs weekly, creates PR if changes detected
name: Sync OpenAPI Spec

on:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force update even if no changes detected'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-openapi:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install httpx pyyaml

      - name: Fetch latest OpenAPI spec
        id: fetch
        run: |
          python << 'EOF'
          import httpx
          import yaml
          import os
          import hashlib

          # DevRev public OpenAPI spec URL (adjust as needed)
          OPENAPI_URL = "https://api.devrev.ai/openapi.yaml"
          LOCAL_SPEC = "openapi-public.yaml"

          # Fetch latest spec
          try:
              response = httpx.get(OPENAPI_URL, timeout=60)
              response.raise_for_status()
              new_spec = response.text
              new_hash = hashlib.sha256(new_spec.encode()).hexdigest()
          except Exception as e:
              print(f"Warning: Could not fetch remote spec: {e}")
              print("Using existing spec for comparison")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write("changed=false\n")
                  f.write("error=fetch_failed\n")
              exit(0)

          # Compare with existing
          try:
              with open(LOCAL_SPEC, 'r') as f:
                  old_spec = f.read()
              old_hash = hashlib.sha256(old_spec.encode()).hexdigest()
          except FileNotFoundError:
              old_hash = ""

          changed = new_hash != old_hash

          # Write output
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changed={str(changed).lower()}\n")
              f.write(f"new_hash={new_hash[:8]}\n")
              f.write(f"old_hash={old_hash[:8]}\n")

          if changed:
              with open(LOCAL_SPEC, 'w') as f:
                  f.write(new_spec)
              print("OpenAPI spec updated")
          else:
              print("No changes detected")
          EOF

      - name: Generate change report
        if: steps.fetch.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        id: report
        run: |
          python << 'EOF'
          import yaml
          import os

          with open("openapi-public.yaml", 'r') as f:
              spec = yaml.safe_load(f)

          # Count endpoints
          paths = spec.get('paths', {})
          endpoint_count = sum(len(methods) for methods in paths.values())

          # Get version info
          info = spec.get('info', {})
          version = info.get('version', 'unknown')

          # Write summary
          summary = f"OpenAPI spec v{version} with {endpoint_count} endpoints"
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"summary={summary}\n")
              f.write(f"version={version}\n")
              f.write(f"endpoints={endpoint_count}\n")

          print(summary)
          EOF

      - name: Create Pull Request
        if: steps.fetch.outputs.changed == 'true' || github.event.inputs.force_update == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update OpenAPI spec (${{ steps.report.outputs.version }})"
          title: "chore: Update OpenAPI spec to ${{ steps.report.outputs.version }}"
          body: |
            ## OpenAPI Spec Update

            This PR was automatically generated by the OpenAPI sync workflow.

            ### Changes
            - **Version**: ${{ steps.report.outputs.version }}
            - **Endpoints**: ${{ steps.report.outputs.endpoints }}
            - **Previous hash**: ${{ steps.fetch.outputs.old_hash }}
            - **New hash**: ${{ steps.fetch.outputs.new_hash }}

            ### Next Steps
            1. Review the spec changes
            2. Run model generation if needed
            3. Update affected services

            ---
            Closes #57 (if this is the first sync)
          branch: chore/openapi-sync-${{ github.run_number }}
          labels: |
            automated
            openapi
            dependencies
          reviewers: mgmonteleone

