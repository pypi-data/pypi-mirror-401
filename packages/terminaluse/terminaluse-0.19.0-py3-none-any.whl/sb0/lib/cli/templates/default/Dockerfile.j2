# syntax=docker/dockerfile:1.3
#
# RUNTIME REQUIREMENTS for nsjail sandboxing:
#   docker run --cap-add=SYS_ADMIN --cap-add=SYS_PTRACE \
#     --security-opt seccomp=/path/to/seccomp-profile.json ...
# The seccomp profile is at: src/sb0/lib/sandbox/seccomp-profile.json
# See docs/SANDBOX_LIMITATIONS.md for details.
#
FROM python:3.12-slim
COPY --from=ghcr.io/astral-sh/uv:0.6.4 /uv /uvx /bin/

# Install system dependencies and nsjail build dependencies
RUN apt-get update && apt-get install -y \
    htop \
    vim \
    curl \
    tar \
    python3-dev \
    postgresql-client \
    build-essential \
    libpq-dev \
    gcc \
    cmake \
    netcat-openbsd \
    nodejs \
    npm \
    # nsjail build dependencies
    autoconf \
    automake \
    bison \
    flex \
    g++ \
    git \
    libprotobuf-dev \
    libnl-route-3-dev \
    libtool \
    make \
    pkg-config \
    protobuf-compiler \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Build and install nsjail for handler sandboxing (pinned to v3.4 for reproducible builds)
RUN git clone --branch 3.4 --depth 1 https://github.com/google/nsjail.git /tmp/nsjail \
    && cd /tmp/nsjail \
    && make \
    && cp nsjail /usr/local/bin/ \
    && rm -rf /tmp/nsjail

RUN uv pip install --system --upgrade pip setuptools wheel

ENV UV_HTTP_TIMEOUT=1000

# Copy just the requirements file to optimize caching
COPY {{ project_path_from_build_root }}/requirements.txt /app/{{ project_path_from_build_root }}/requirements.txt

WORKDIR /app/{{ project_path_from_build_root }}

# Install the required Python packages
RUN uv pip install --system -r requirements.txt

# Copy the project code
COPY {{ project_path_from_build_root }}/project /app/{{ project_path_from_build_root }}/project

# Set environment variables
ENV PYTHONPATH=/app

# Run the agent using uvicorn
CMD ["uvicorn", "project.acp:server", "--host", "0.0.0.0", "--port", "8000"]
