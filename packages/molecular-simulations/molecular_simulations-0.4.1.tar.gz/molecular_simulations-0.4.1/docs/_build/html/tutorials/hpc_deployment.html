<!DOCTYPE html>
<html class="no-js" lang="en" data-content_root="../">
<head>
    <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
        <title>HPC Deployment with Parsl &mdash; molecular-simulations 0.3.28 documentation</title>
    
    <link rel="stylesheet" type="text/css" href="../_static/dist/fontawesome.css" />
      <link rel="stylesheet" type="text/css" href="../_static/dist/theme.css?v=310cf088" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
            <link rel="index" title="Index" href="../genindex.html" />
            <link rel="search" title="Search" href="../search.html" />
            <link rel="top" title="molecular-simulations 0.3.28 documentation" href="#" />
            <link rel="up" title="Tutorials" href="index.html" />
            <link rel="next" title="Analysis Workflows" href="analysis_workflows.html" />
            <link rel="prev" title="Protein-Ligand Systems" href="ligand_systems.html" />
    </head>
<body>
    <script type="text/javascript" src="../_static/dist/blocking.js"></script>
    <header class="container-fluid bg-primary">
        <a class="btn btn-sm btn-light skip-to-content-link" href="#main">Skip to content</a>
        <div class="container-fluid">
            <div class="navbar navbar-expand-lg navbar-dark font-weight-bold">
                    <a href="../index.html"
                        title="Wagtail"
                        class="logo navbar-brand"
                    >
                        <img src="../_static/img/wagtail-logo-circle.svg" width="45" height="59" alt="Wagtail"
                            class="logo-img"
                        />
                        molecular-simulations
                    </a>
                
                
                    <div class="collapse navbar-collapse justify-content-end">
                        <ul class="navbar-nav">
                            
                                
                                
                                <li class="nav-item"><a class="nav-link"  href="/index">Documentation</a></li>
                            
                        </ul>
                    </div>
                
                <button class="navbar-toggler btn btn-primary d-lg-none" type="button" data-toggle="collapse" data-target="#collapseSidebar" aria-expanded="false" aria-controls="collapseExample">
                    <span class="navbar-toggler-icon"></span>
                    <span class="sr-only">menu</span>
                </button>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row">
            <aside class="col-12 col-lg-3 sidebar-container">
                <div id="collapseSidebar" class="collapse sticky-top d-lg-block pt-5 pr-lg-4">
<div id="searchbox" class="searchbox mb-6 px-1" role="search">
    <form id="search-form" action="../search.html" autocomplete="off" method="get" role="search">
        <div class="input-group">
            <div class="input-group-prepend">
                <div class="input-group-text border-right-0 bg-white py-3 pl-3 pr-2"><span class="fas fa-search"></span></div>
            </div>
            <input class="form-control py-3 pr-3 pl-1 h-100 border-left-0" type="search" name="q" placeholder="Search documentation" aria-label="Search documentation" id="searchinput" />
        </div>
        <input type="hidden" name="check_keywords" value="yes" />
        <input type="hidden" name="area" value="default" />
    </form>
</div><div class="site-toc">
    <nav class="toc mt-3" aria-label="Main menu">
        <p class="caption" role="heading"><span class="caption-text">User Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="basic_simulation.html">Basic Protein Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="ligand_systems.html">Protein-Ligand Systems</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">HPC Deployment with Parsl</a></li>
<li class="toctree-l2"><a class="reference internal" href="analysis_workflows.html">Analysis Workflows</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api/overview.html">API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/modules.html">molecular_simulations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../api/molecular_simulations.html">molecular_simulations package</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../api/molecular_simulations.analysis.html">molecular_simulations.analysis package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.autocluster.html">molecular_simulations.analysis.autocluster module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.constant_pH_analysis.html">molecular_simulations.analysis.constant_pH_analysis module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.cov_ppi.html">molecular_simulations.analysis.cov_ppi module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.fingerprinter.html">molecular_simulations.analysis.fingerprinter module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.interaction_energy.html">molecular_simulations.analysis.interaction_energy module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.ipSAE.html">molecular_simulations.analysis.ipSAE module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.sasa.html">molecular_simulations.analysis.sasa module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.analysis.utils.html">molecular_simulations.analysis.utils module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/molecular_simulations.build.html">molecular_simulations.build package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.build.build_amber.html">molecular_simulations.build.build_amber module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.build.build_calvados.html">molecular_simulations.build.build_calvados module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.build.build_interface.html">molecular_simulations.build.build_interface module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.build.build_ligand.html">molecular_simulations.build.build_ligand module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/molecular_simulations.simulate.html">molecular_simulations.simulate package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.simulate.free_energy.html">molecular_simulations.simulate.free_energy module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.simulate.mmpbsa.html">molecular_simulations.simulate.mmpbsa module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.simulate.multires_simulator.html">molecular_simulations.simulate.multires_simulator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.simulate.omm_simulator.html">molecular_simulations.simulate.omm_simulator module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.simulate.reporters.html">molecular_simulations.simulate.reporters module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/molecular_simulations.utils.html">molecular_simulations.utils package</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.utils.amber_utils.html">molecular_simulations.utils.amber_utils module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.utils.mda_utils.html">molecular_simulations.utils.mda_utils module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api/molecular_simulations.utils.parsl_settings.html">molecular_simulations.utils.parsl_settings module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api/molecular_simulations.logging_config.html">molecular_simulations.logging_config module</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../contributing.html">Contributing</a></li>
</ul>

    </nav>
    <template data-toggle-item-template>
        <button class="btn btn-sm btn-link toctree-expand" type="button">
            <span class="sr-only">Toggle menu contents</span>
        </button>
    </template>
</div>
                    <div class="d-lg-none border-bottom">
                        
                    </div>
                </div>
            </aside>
            <div class="col-12 col-lg-9 pt-5">
                <header class="row align-items-baseline">
                    <div class="col">
                        <nav aria-label="breadcrumb">
    <ol class="breadcrumb m-0 p-0 bg-transparent">
        <li class="breadcrumb-item"><a href="../index.html">Docs</a></li>
            <li class="breadcrumb-item"><a href="index.html">Tutorials</a></li>
        <li class="breadcrumb-item active" aria-current="page">HPC Deployment with Parsl</li>
    </ol>
</nav>
                    </div>
                    <div class="col-sm-12 col-lg-auto mt-3 mt-lg-3">
                        <noscript>
                            <p>JavaScript is required to toggle light/dark mode..</p>
                        </noscript>
                        <button id="wagtail-theme" class="btn btn-sm btn-light text-decoration-none" type="button">
                            <span class="dark-only"><i class="fas fa-sun"></i> Light mode</span>
                            <span class="light-only"><i class="fas fa-moon"></i> Dark mode</span>
                        </button>
    <a class="btn btn-sm btn-light text-decoration-none" href="https://github.com/wagtail/sphinx_wagtail_theme/blob/main/docs/tutorials/hpc_deployment.rst" rel="nofollow">
        <span class="btn-icon"><span class="fab fa-github"></span></span>
        <span class="btn-text">Edit on GitHub</span>
    </a>
    <a class="btn btn-sm btn-light text-decoration-none" href="../_sources/tutorials/hpc_deployment.rst.txt" rel="nofollow">
        <span class="btn-icon"><span class="fas fa-code"></span></span>
        <span class="btn-text">View source</span>
    </a>
                        
                    </div>
                </header>
                <div class="row" >
                    <div class="col-12">
                        <hr class="w-100 my-4">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-lg-9 order-last order-lg-first rst-content">
                        <main role="main" id="main">
    <section id="hpc-deployment-with-parsl">
<h1>HPC Deployment with Parsl<a class="headerlink" href="#hpc-deployment-with-parsl" title="Link to this heading">¶</a></h1>
<p>This tutorial covers deploying simulations on high-performance computing clusters
using Parsl for workflow management.</p>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>molecular-simulations integrates with <a class="reference external" href="https://parsl.readthedocs.io/">Parsl</a> to
enable:</p>
<ul class="simple">
<li><p>Running multiple simulation replicas in parallel</p></li>
<li><p>Automatic job submission to PBS/SLURM schedulers</p></li>
<li><p>GPU allocation across nodes</p></li>
<li><p>Fault tolerance and checkpointing</p></li>
</ul>
</section>
<section id="configuration-files">
<h2>Configuration Files<a class="headerlink" href="#configuration-files" title="Link to this heading">¶</a></h2>
<p>Create a YAML configuration file for your cluster:</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">parsl_config.yaml</span><a class="headerlink" href="#id1" title="Link to this code">¶</a></div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="c1"># Local workstation with multiple GPUs</span>
<span class="nt">executor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ThreadPoolExecutor</span>
<span class="nt">max_workers</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">4</span>

<span class="c1"># PBS cluster example</span>
<span class="c1"># executor: HighThroughputExecutor</span>
<span class="c1"># provider: PBSProProvider</span>
<span class="c1"># account: &quot;myproject&quot;</span>
<span class="c1"># queue: &quot;prod&quot;</span>
<span class="c1"># walltime: &quot;24:00:00&quot;</span>
<span class="c1"># nodes_per_block: 1</span>
<span class="c1"># available_accelerators: 4</span>
</pre></div>
</div>
</div>
</section>
<section id="using-localsettings">
<h2>Using LocalSettings<a class="headerlink" href="#using-localsettings" title="Link to this heading">¶</a></h2>
<p>For local workstations or simple clusters:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">parsl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">molecular_simulations.simulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">LocalSettings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>

<span class="c1"># Load configuration</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">LocalSettings</span><span class="o">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="s2">&quot;parsl_config.yaml&quot;</span><span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">config_factory</span><span class="p">(</span><span class="s2">&quot;/path/to/run_dir&quot;</span><span class="p">)</span>
<span class="n">parsl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

<span class="c1"># Define the simulation app</span>
<span class="nd">@parsl</span><span class="o">.</span><span class="n">python_app</span>
<span class="k">def</span><span class="w"> </span><span class="nf">run_md</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25_000_000</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">molecular_simulations.simulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">Simulator</span>
    <span class="n">Simulator</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">prod_steps</span><span class="o">=</span><span class="n">steps</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">path</span>

<span class="c1"># Submit jobs for all replicas</span>
<span class="n">replica_dirs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;replica_*&quot;</span><span class="p">))</span>
<span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">run_md</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">p</span><span class="p">))</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">replica_dirs</span><span class="p">]</span>

<span class="c1"># Wait for completion</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="si">}</span><span class="s2"> simulations&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="using-polarissettings">
<h2>Using PolarisSettings<a class="headerlink" href="#using-polarissettings" title="Link to this heading">¶</a></h2>
<p>For ALCF Polaris supercomputer:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">molecular_simulations.simulate</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolarisSettings</span>

<span class="n">settings</span> <span class="o">=</span> <span class="n">PolarisSettings</span><span class="p">(</span>
    <span class="n">account</span><span class="o">=</span><span class="s2">&quot;myproject&quot;</span><span class="p">,</span>
    <span class="n">queue</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span><span class="p">,</span>
    <span class="n">walltime</span><span class="o">=</span><span class="s2">&quot;12:00:00&quot;</span><span class="p">,</span>
    <span class="n">nodes_per_block</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">worker_init</span><span class="o">=</span><span class="s2">&quot;module load cudatoolkit; source activate molsim&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">config_factory</span><span class="p">(</span><span class="s2">&quot;/path/to/run_dir&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="best-practices">
<h2>Best Practices<a class="headerlink" href="#best-practices" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt><strong>Organize replica directories</strong></dt><dd><p>Use a consistent naming scheme like <code class="docutils literal notranslate"><span class="pre">replica_001/</span></code>, <code class="docutils literal notranslate"><span class="pre">replica_002/</span></code>, etc.</p>
</dd>
<dt><strong>Set appropriate walltime</strong></dt><dd><p>Estimate based on system size and simulation length. Add buffer for
equilibration and I/O. Ensure you do not ask for more than allowed
on your resource as this will crash Parsl with no discernable error.</p>
</dd>
<dt><strong>Use checkpointing</strong></dt><dd><p>For long simulations, configure periodic checkpoint saving to enable
restart from failures.</p>
</dd>
</dl>
</section>
<section id="troubleshooting">
<h2>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Link to this heading">¶</a></h2>
<dl class="simple">
<dt><strong>Jobs fail immediately</strong></dt><dd><p>Check that the worker_init script correctly loads all required modules
and activates the conda/virtual environment. Ensure paths are either
correct if relative or absolute. Remember that the <cite>run_dir</cite> arg for the
config factory is where Parsl will sit in the job, meaning paths are relative
to this location.</p>
</dd>
<dt><strong>OpenBLAS threading errors</strong></dt><dd><p>Set <code class="docutils literal notranslate"><span class="pre">OMP_NUM_THREADS=1</span></code> in worker_init to avoid conflicts with MMPBSA’s
internal threading.</p>
</dd>
<dt><strong>Errors do not propagate into runtime logs</strong></dt><dd><p>Check in the Parsl output logs. Sometimes errors appear in the <cite>parsl.log</cite>,
but more often you will need to look at the error stream located at
<cite>00*/submit_scripts/parsl.*.sh.err</cite>. Most python tracebacks end up here.</p>
</dd>
<dt><strong>I have tried everything and now I hate Parsl</strong></dt><dd><p>Yes, Parsl can be challenging to debug at times. My best advice if all else
fails is to try running the code in serial to see what bugs arise. Nearly
every time I am convinced Parsl is to blame, it is actually just a bug in
the code, an unstable system, etc.</p>
</dd>
</dl>
</section>
</section>

</main>
                        <nav aria-label="Page navigation" class="py-4 my-5 clearfix font-weight-bold border-top">
    <a class="float-left" href="ligand_systems.html" title="Previous">
        <span aria-hidden="true">←&nbsp;</span>Protein-Ligand Systems
    </a>
    <a class="float-right" href="analysis_workflows.html" title="Next">
        Analysis Workflows <span aria-hidden="true">&nbsp;→</span>
    </a>
</nav>
                    </div>
                    
                    <nav class="col-12 col-lg-3 pb-4">
                        <div class="sticky-top toc page-toc" aria-labelledby="page-toc-heading">
                            <p class="font-weight-bold" id="page-toc-heading">Page contents</p>
                            <ul>
<li><a class="reference internal" href="#">HPC Deployment with Parsl</a><ul>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#configuration-files">Configuration Files</a></li>
<li><a class="reference internal" href="#using-localsettings">Using LocalSettings</a></li>
<li><a class="reference internal" href="#using-polarissettings">Using PolarisSettings</a></li>
<li><a class="reference internal" href="#best-practices">Best Practices</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
</ul>

                        </div>
                    </nav>
                    
                </div>
            </div>
        </div>
    </div>
    <footer class="container-fluid bg-primary text-light">
        <div class="container">
            <div class="row">
        <div class="col p-4">
            
                <nav aria-label="Footer">
                    <ul class="nav justify-content-center mb-2">
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/features/">Features</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/about-wagtail/"> About Wagtail</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/services/"> Services</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/blog/"> Blog</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/packages/"> Packages</a></li>
                        
                            
                            
                            <li class="nav-item"><a class="nav-link text-light"  href="https://wagtail.org/developers/"> Developers</a></li>
                        
                    </ul>
                </nav>
            
            <div class="text-center">
                    &copy; Copyright 2025, Matt Sinclair
            </div>
        </div>
    </div>
        </div>
    </footer>
        <script src="../_static/documentation_options.js?v=11b5e5c7"></script>
        <script src="../_static/doctools.js?v=9bcbadda"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
        <script src="../_static/copybutton.js?v=fd10adb8"></script>
        <script type="text/javascript" src="../_static/dist/theme.js"></script>
        <script type="text/javascript" src="../_static/dist/vendor.js"></script>
        <script type="text/javascript" src="../_static/searchtools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript">
            document.addEventListener('DOMContentLoaded', function() { Search.loadIndex("../searchindex.js"); });
        </script>
        <script type="text/javascript" id="searchindexloader"></script>
    </body>
</html>