"use strict";(self.webpackChunkjupyterlab_chat_extension=self.webpackChunkjupyterlab_chat_extension||[]).push([[515],{5515:(e,t,a)=>{a.r(t),a.d(t,{default:()=>$});var n=a(5063),o=a(9674),r=a(9389),i=a(489),s=a(14),c=a(6261),d=a(6469),l=a(8581),h=a(3083),m=a(428),u=a(2787),g=a(8490),p=a(2570),y=a(2840),C=a(7262),v=a(5878);const f={id:"jupyterlab-chat-extension:chatCommandRegistry",description:"The chat command registry used by the jupyterlab-chat-extension.",autoStart:!0,provides:o.IChatCommandRegistry,activate:e=>new o.ChatCommandRegistry};class I{constructor(){this.id="jupyter-chat:emoji-commands",this._slash_commands=[{name:":heart:",replaceWith:"â¤",providerId:this.id,description:"Emoji",icon:"â¤"},{name:":smile:",replaceWith:"ðŸ™‚",providerId:this.id,description:"Emoji",icon:"ðŸ™‚"},{name:":thinking:",replaceWith:"ðŸ¤”",providerId:this.id,description:"Emoji",icon:"ðŸ¤”"},{name:":cool:",replaceWith:"ðŸ˜Ž",providerId:this.id,description:"Emoji",icon:"ðŸ˜Ž"}],this._regex=/^:\w*:?/}async listCommandCompletions(e){var t,a;const n=null===(a=null===(t=e.currentWord)||void 0===t?void 0:t.match(this._regex))||void 0===a?void 0:a[0];return n?this._slash_commands.filter((e=>e.name.startsWith(n))):[]}async onSubmit(e){}}const w={id:"jupyterlab-chat-extension:emojiCommandsPlugin",description:"Plugin which adds emoji commands to the chat.",autoStart:!0,requires:[o.IChatCommandRegistry],activate:(e,t)=>{t.addProvider(new I)}};var b=a(3345),x=a.n(b);const M={id:"jupyterlab-chat-extension:mentionCommandsPlugin",description:"Plugin which adds user mention commands.",autoStart:!0,requires:[o.IChatCommandRegistry],activate:(e,t)=>{t.addProvider(new T)}};class T{constructor(){this.id="jupyter-chat:mention-commands",this._regex=/@([\w-]*)/g}async listCommandCompletions(e){var t,a;const{currentWord:n}=e;if(!n)return[];const o=null===(a=null===(t=Array.from(n.matchAll(this._regex)))||void 0===t?void 0:t[0])||void 0===a?void 0:a[1];if(null==o)return[];const r=this._getExistingMentions(e);return Array.from(this._getUsers(e)).filter((e=>e[0].toLowerCase().startsWith(o.toLowerCase()))).filter((e=>!r.has(e[0]))).map((e=>({name:"@"+e[0],providerId:this.id,icon:e[1].icon,spaceOnAccept:!0})))}_getExistingMentions(e){var t;const a=null===(t=e.value)||void 0===t?void 0:t.matchAll(this._regex),n=new Set;for(const e of a){const t=null==e?void 0:e[1];t&&n.add(t)}return n}async onSubmit(e){var t;const a=e.value.matchAll(this._regex);for(const n of a){const a=null==n?void 0:n[1];if(!a)continue;const o=this._getUsers(e).get(a);o&&(null===(t=e.addMention)||void 0===t||t.call(e,o.user))}}_getUsers(e){const t=new Map;if(!e.chatContext)return t;const{user:a,users:n}=e.chatContext;return n.forEach((e=>{a&&e.username===a.username||(e.mention_name?t.set(e.mention_name,{user:e,icon:x().createElement(o.Avatar,{user:e})}):console.error(`No 'mention_name' property for user '${e.username}'. This user is being omitted from 'MentionCommandProvider._getUsers()'.`))})),t}}const R="Chat",D="jupyterlab-chat-extension:factory";async function P(e,t,a,n){const o=e.docRegistry.getModelFactory("Chat");if(!a&&!(a=await e.commands.execute(v.CommandIDs.createChat,{inSidePanel:!0})))return{};const r=await e.serviceManager.contents.get(a),i=t.sharedModelFactory.createNew({path:r.path,format:r.format,contentType:v.chatFileType.contentType,collaborative:!0}),s=o.createNew({sharedModel:i});return s.name=r.path,{model:s,displayName:(0,v.getDisplayName)(r.path,n)}}const W={id:"jupyterlab-chat-extension:attachmentOpener",description:"The attachment opener registry.",autoStart:!0,provides:o.IAttachmentOpenerRegistry,activate:e=>{const t=new o.AttachmentOpenerRegistry;return t.set("file",(t=>{e.commands.execute("docmanager:open",{path:t.value})})),t.set("notebook",(t=>{e.commands.execute("docmanager:open",{path:t.value})})),t}},F={id:"jupyterlab-chat-extension:widget-config",description:"Chat widget configuration.",autoStart:!0,optional:[r.ICollaborativeContentProvider,g.ISettingRegistry],provides:v.IWidgetConfig,activate:(e,t,a)=>{const n=new v.WidgetConfig({});function o(a){const o=n.config.defaultDirectory,r=a.get("defaultDirectory").composite;t&&o&&o!==r&&e.serviceManager.contents.get(o).then((t=>{0===t.content.length&&e.serviceManager.contents.delete(o).catch((e=>{}))})).catch((()=>{}));let i=Promise.resolve(null);t&&r&&o!==r&&(i=e.serviceManager.contents.get(r,{content:!1}).catch((async()=>e.serviceManager.contents.newUntitled({type:"directory"}).then((async t=>e.serviceManager.contents.rename(t.path,r).catch((a=>{throw e.serviceManager.contents.delete(t.path),new Error(a)})))).catch((e=>{throw new Error(e)}))))),i.then((()=>{n.config={sendWithShiftEnter:a.get("sendWithShiftEnter").composite,stackMessages:a.get("stackMessages").composite,unreadNotifications:a.get("unreadNotifications").composite,enableCodeToolbar:a.get("enableCodeToolbar").composite,sendTypingNotification:a.get("sendTypingNotification").composite,showDeleted:a.get("showDeleted").composite,defaultDirectory:r}}))}return a&&Promise.all([e.restored,a.load(D)]).then((([,e])=>{o(e),e.changed.connect(o)})).catch((e=>{console.error(`Something went wrong when reading the settings.\n${e}`)})),n}},S={id:D,description:"Document factories for chat.",autoStart:!0,requires:[u.IRenderMimeRegistry,v.IWidgetConfig],optional:[v.IActiveCellManagerToken,o.IAttachmentOpenerRegistry,o.IChatCommandRegistry,r.ICollaborativeContentProvider,l.IDefaultFileBrowser,o.IInputToolbarRegistryFactory,o.IMessageFooterRegistry,v.ISelectionWatcherToken,g.ISettingRegistry,s.IThemeManager,s.IToolbarWidgetRegistry,p.ITranslator,v.IWelcomeMessage],provides:v.IChatFactory,activate:(e,t,a,n,o,r,i,c,d,l,h,m,u,g,y,C)=>{const f=null!=y?y:p.nullTranslator;let I;if(m&&g&&(I=(0,s.createToolbarFactory)(g,m,R,D,f)),e.docRegistry.addFileType(v.chatFileType),i){const e=()=>v.YChat.create();i.sharedModelFactory.registerDocumentFactory("chat",e)}e.serviceManager.ready.then((()=>{const t=e.serviceManager.user.identity,o=new v.LabChatModelFactory({user:t,widgetConfig:a,commands:e.commands,activeCellManager:n,selectionWatcher:h,documentManager:null==c?void 0:c.model.manager});e.docRegistry.addModelFactory(o)})).catch((e=>console.error("The jupyterlab chat model factory is not initialized",e)));const w=new v.ChatWidgetFactory({name:R,label:"Chat",modelName:"chat",fileTypes:["chat"],defaultFor:["chat"],themeManager:u,rmRegistry:t,toolbarFactory:I,translator:f,chatCommandRegistry:r,attachmentOpenerRegistry:o,inputToolbarFactory:d,messageFooterRegistry:l,welcomeMessage:C});return e.docRegistry.addWidgetFactory(w),w}},E={id:"jupyterlab-chat-extension:tracker",description:"The chat widget tracker",autoStart:!0,provides:o.IChatTracker,requires:[v.IChatFactory],optional:[v.IChatPanel,i.ILayoutRestorer],activate:(e,t,a,n)=>{const o=new s.WidgetTracker({namespace:"chat"});if(t.widgetCreated.connect(((t,a)=>{a.context.pathChanged.connect((()=>{o.save(a)})),o.add(a),a.model.unreadChanged.connect((()=>e.commands.notifyCommandChanged(v.CommandIDs.markAsRead)))})),null==a||a.sectionAdded.connect(((e,t)=>{o.add(t.widget)})),n){const t=new C.PromiseDelegate,a=()=>{e.commands.hasCommand(v.CommandIDs.openChat)&&(t.resolve(),e.commands.commandChanged.disconnect(a))};e.commands.commandChanged.connect(a),n.restore(o,{command:v.CommandIDs.openChat,args:e=>{var t;return{filepath:null!==(t=e.model.name)&&void 0!==t?t:"",inSidePanel:"sidebar"===e.area,startup:!0}},name:e=>{var t;return`${null!==(t=e.area)&&void 0!==t?t:"main"}:${e.model.name}`},when:t.promise})}return o}},j={id:"jupyterlab-chat-extension:commands",description:"The commands to create or open a chat.",autoStart:!0,requires:[r.ICollaborativeContentProvider,v.IWidgetConfig,o.IChatTracker],optional:[v.IChatPanel,s.ICommandPalette,l.IDefaultFileBrowser,h.ILauncher],activate:(e,t,a,r,i,c,l,h)=>{const{commands:m}=e;m.addCommand(v.CommandIDs.createChat,{label:e=>e.isPalette?"Create a new chat":"Chat",caption:"Create a chat",icon:e=>e.isPalette?void 0:o.chatIcon,execute:async t=>{var n,o,r,i;const c=null!==(n=t.inSidePanel)&&void 0!==n&&n,h=t.path;let m=null!==(o=t.name)&&void 0!==o?o:null,u="";if(m||(m=(await s.InputDialog.getText({label:"Name",placeholder:"untitled",title:"Create a new chat"})).value),null===m)return;if(m)if(u=m.endsWith(v.chatFileType.extensions[0])?m:`${m}${v.chatFileType.extensions[0]}`,void 0!==h)u=d.PathExt.join(h,u);else if(c){const e=null!==(r=a.config.defaultDirectory)&&void 0!==r?r:"";u=d.PathExt.join(e,u)}else{const e=null!==(i=null==l?void 0:l.model.path)&&void 0!==i?i:"";u=d.PathExt.join(e,u)}let g=!0;if(u?await e.serviceManager.contents.get(u,{content:!1}).catch((()=>{g=!1})):g=!1,!g){let t=await e.serviceManager.contents.newUntitled({type:"file",ext:v.chatFileType.extensions[0]});if(u&&(t=await e.serviceManager.contents.rename(t.path,u)),!t)return void(0,s.showErrorMessage)("Error creating a chat","An error occurred while creating the chat");u=t.path}return u}}),m.addCommand(v.CommandIDs.createAndOpen,{label:e=>e.isPalette?"Create a new chat":"Chat",caption:"Create a chat and open it",icon:e=>e.isPalette?void 0:o.chatIcon,execute:async e=>{var t;const a=null!==(t=e.inSidePanel)&&void 0!==t&&t,n=await m.execute(v.CommandIDs.createChat,e);return m.hasCommand(v.CommandIDs.openChat)?m.execute(v.CommandIDs.openChat,{filepath:n,inSidePanel:a}):m.execute("docmanager:open",{path:`${n}`,factory:R})}}),m.addCommand(v.CommandIDs.markAsRead,{caption:"Mark chat as read",icon:o.readIcon,isEnabled:()=>null!==r.currentWidget&&r.currentWidget===e.shell.currentWidget&&r.currentWidget.model.unreadMessages.length>0,execute:async t=>{const a=e.shell.currentWidget;a&&a instanceof v.LabChatPanel&&Array.from(e.shell.widgets("main")).includes(a)?a.model.unreadMessages=[]:console.error(`The command '${v.CommandIDs.markAsRead}' should be executed from the toolbar button only`)}}),r.currentChanged.connect((()=>{m.notifyCommandChanged(v.CommandIDs.markAsRead)})),e.serviceManager.ready.then((()=>{m.addCommand(v.CommandIDs.openChat,{label:"Open a chat",execute:async a=>{var o,r,c,d,l;const h=null!==(o=a.inSidePanel)&&void 0!==o&&o,u=null!==(r=a.startup)&&void 0!==r&&r;let g=null!==(c=a.filepath)&&void 0!==c?c:null;if(null===g&&(g=(await s.InputDialog.getText({label:"File path",placeholder:"/path/to/the/chat/file",title:"Path of the chat"})).value),!g)return!1;let p=!0;if(await e.serviceManager.contents.get(g,{content:!1}).catch((()=>{p=!1})),!p)return u?console.warn(`Chat file '${g}' not found during startup restoration`):(0,s.showErrorMessage)("Error opening chat",`'${g}' is not a valid path`),!1;if(!h||!i)return m.execute("docmanager:open",{path:`${g}`,factory:R});{if(e.shell instanceof n.NotebookShell){const t=e.shell;(null===(l=null===(d=t.leftHandler)||void 0===d?void 0:d.currentWidget)||void 0===l?void 0:l.id)===i.id&&t.leftHandler.isVisible||t.activateById(i.id)}else e.shell.activateById(i.id);if(i.openIfExists(g))return!0;const a=await P(e,t,g);i.addChat(a)}return!1}}),c&&c.addItem({category:"Chat",command:v.CommandIDs.openChat})})).catch((e=>console.error("The command to open a chat is not initialized\n",e))),m.addCommand(v.CommandIDs.renameChat,{label:"Rename chat",execute:async t=>{const a=t.oldPath;let n=t.newPath;if(!a)return(0,s.showErrorMessage)("Error renaming chat","Missing old path"),!1;if(!n){const e=await s.InputDialog.getText({title:"Rename Chat",text:d.PathExt.basename(a).replace(/\.chat$/,""),placeholder:"new-name"});if(!e.button.accept)return!1;n=e.value}if(!n)return!1;n.endsWith(v.chatFileType.extensions[0])||(n=`${n}${v.chatFileType.extensions[0]}`);try{return await e.serviceManager.contents.rename(a,n),!0}catch(e){console.error("Error renaming chat",e),(0,s.showErrorMessage)("Error renaming chat",`${e}`)}return!1}}),m.addCommand(v.CommandIDs.focusInput,{caption:"Focus the input of the current chat widget",isEnabled:()=>null!==r.currentWidget,execute:()=>{const t=r.currentWidget;t&&(t instanceof o.ChatWidget&&i?(e.shell.activateById(i.id),i.openIfExists(t.model.name)):e.shell.activateById(t.id),t.model.input.focus())}}),c&&(c.addItem({category:"Chat",command:v.CommandIDs.createAndOpen,args:{isPalette:!0}}),c.addItem({category:"Chat",command:v.CommandIDs.renameChat})),h&&h.add({command:v.CommandIDs.createAndOpen,category:"Other"})}},k={id:"jupyterlab-chat-extension:chat-panel",description:"The chat panel widget.",autoStart:!0,provides:v.IChatPanel,requires:[v.IWidgetConfig,r.ICollaborativeContentProvider,u.IRenderMimeRegistry],optional:[o.IAttachmentOpenerRegistry,o.IChatCommandRegistry,o.IInputToolbarRegistryFactory,i.ILayoutRestorer,o.IMessageFooterRegistry,s.IThemeManager,v.IWelcomeMessage],activate:(e,t,a,n,r,i,s,c,d,l,h)=>{const{commands:m,serviceManager:u}=e,g=v.chatFileType.extensions[0],p=new o.MultiChatPanel({rmRegistry:n,themeManager:l,getChatNames:async()=>{var e;const a=await u.contents.get(null!==(e=t.config.defaultDirectory)&&void 0!==e?e:""),n={};for(const e of a.content)"file"===e.type&&e.name.endsWith(g)&&(n[e.name.replace(g,"")]=e.path);return n},createModel:async n=>P(e,a,n,t.config.defaultDirectory),openInMain:e=>m.execute(v.CommandIDs.openChat,{filepath:e}),renameChat:(e,t)=>m.execute(v.CommandIDs.renameChat,{oldPath:e,newPath:t}),chatCommandRegistry:i,attachmentOpenerRegistry:r,inputToolbarFactory:s,messageFooterRegistry:d,welcomeMessage:h});return p.id="JupyterlabChat:sidepanel",t.configChanged.connect(((e,t)=>{void 0!==t.defaultDirectory&&(p.updateChatList(),p.sections.forEach((e=>{e.displayName=(0,v.getDisplayName)(e.model.name,t.defaultDirectory)})))})),u.contents.fileChanged.connect(((e,a)=>{var n,o,r;if("delete"===a.type&&(p.updateChatList(),null===(n=p.sections.find((e=>{var t;return e.model.name===(null===(t=a.oldValue)||void 0===t?void 0:t.path)})))||void 0===n||n.dispose()),["new","rename"].includes(a.type)&&(null===(r=null===(o=a.newValue)||void 0===o?void 0:o.path)||void 0===r?void 0:r.endsWith(v.chatFileType.extensions[0]))){p.updateChatList();const e=p.sections.find((e=>{var t;return e.model.name===(null===(t=a.oldValue)||void 0===t?void 0:t.path)}));e&&(e.displayName=(0,v.getDisplayName)(a.newValue.path,t.config.defaultDirectory))}})),e.shell.add(p,"left",{rank:2e3}),c&&c.add(p,"jupyter-chat"),m.addCommand(v.CommandIDs.moveToSide,{label:"Move the chat to the side panel",caption:"Move the chat to the side panel",icon:y.launchIcon,isEnabled:()=>m.hasCommand(v.CommandIDs.openChat),execute:async()=>{const t=e.shell.currentWidget;if(!(t&&t instanceof v.LabChatPanel&&Array.from(e.shell.widgets("main")).includes(t)))return void console.error(`The command '${v.CommandIDs.moveToSide}' should be executed from the toolbar button only`);const a=t.context.path.split(":").pop();m.execute(v.CommandIDs.openChat,{filepath:a,inSidePanel:!0}),t.dispose()}}),p}},A={id:"jupyterlab-chat-extension:activeCellManager",description:"The active cell manager plugin.",autoStart:!0,requires:[m.INotebookTracker],provides:v.IActiveCellManagerToken,activate:(e,t)=>new o.ActiveCellManager({tracker:t,shell:e.shell})},_={id:"jupyterlab-chat-extension:selectionWatcher",description:"The selection watcher plugin.",autoStart:!0,provides:v.ISelectionWatcherToken,optional:[c.IEditorLanguageRegistry],activate:(e,t)=>new o.SelectionWatcher({shell:e.shell,languages:t})},N={id:"jupyterlab-chat-extension:inputToolbarFactory",description:"The input toolbar registry plugin.",autoStart:!0,provides:o.IInputToolbarRegistryFactory,activate:e=>({create:()=>o.InputToolbarRegistry.defaultToolbarRegistry()})},$=[A,W,F,j,f,k,E,S,{id:"jupyterlab-chat/footerRegistry",description:"The footer registry plugin.",autoStart:!0,provides:o.IMessageFooterRegistry,activate:e=>new o.MessageFooterRegistry},N,_,w,M]}}]);