from __future__ import annotations

from dataclasses import dataclass
from enum import StrEnum
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from datetime import datetime
    from pathlib import Path

    from pydantic import JsonValue


class AgentType(StrEnum):
    """Supported coding agent types."""

    CLAUDE_CODE = "claude_code"
    OPENCODE = "opencode"
    PI = "pi"


@dataclass
class _BaseMessage:
    """A normalized message in a coding agent session."""

    created_at: datetime


@dataclass
class UserMessage(_BaseMessage):
    """A user-submitted message."""

    content: str


@dataclass
class AssistantMessage(_BaseMessage):
    """An assistant response generated by a model."""

    model: str
    is_thinking: bool
    content: str


@dataclass
class ToolUseMessage(_BaseMessage):
    """A tool invocation request from the assistant."""

    model: str
    tool_id: str
    tool_name: str
    parameters: dict[str, JsonValue]


@dataclass
class ToolResultMessage(_BaseMessage):
    """The result returned from a tool execution."""

    tool_id: str
    result: dict[str, JsonValue]


@dataclass
class AttachmentMessage(_BaseMessage):
    """A user-submitted file attachment."""

    media_type: str
    data: str
    filename: str | None = None


Message = UserMessage | AssistantMessage | ToolUseMessage | ToolResultMessage | AttachmentMessage


@dataclass
class Session:
    """A normalized coding agent session."""

    id: str
    agent: AgentType
    workspace: Path
    git_branch: str | None
    parent_session_id: str | None = None
