#!/usr/bin/env python3
# cli.py
# ABOUTME: CLI tool for managing Gemini API keys in .env file
# Provides commands to add, remove, list, and test API keys

import os
import sys
import argparse
from pathlib import Path
from typing import Optional


def find_env_file() -> Path:
    """Find .env file in current directory or create path for new one."""
    current_dir = Path.cwd()
    env_file = current_dir / ".env"
    return env_file


def read_env_file(env_file: Path) -> dict[str, str]:
    """Read .env file and return dict of key=value pairs."""
    if not env_file.exists():
        return {}

    env_vars = {}
    with open(env_file, "r") as f:
        for line in f:
            line = line.strip()
            if line and not line.startswith("#") and "=" in line:
                key, value = line.split("=", 1)
                env_vars[key.strip()] = value.strip()

    return env_vars


def write_env_file(env_file: Path, env_vars: dict[str, str]):
    """Write env_vars dict to .env file."""
    with open(env_file, "w") as f:
        f.write("# Gemini API Keys - Generated by geminiparallel CLI\n")
        f.write("# DO NOT commit this file to version control!\n\n")

        # Write all GEMINI_API_KEY_* variables in order
        gemini_keys = {
            k: v for k, v in env_vars.items() if k.startswith("GEMINI_API_KEY_")
        }
        other_vars = {
            k: v for k, v in env_vars.items() if not k.startswith("GEMINI_API_KEY_")
        }

        # Sort GEMINI keys by number
        sorted_keys = sorted(
            gemini_keys.items(),
            key=lambda x: int(x[0].split("_")[-1])
            if x[0].split("_")[-1].isdigit()
            else 0,
        )

        for key, value in sorted_keys:
            f.write(f"{key}={value}\n")

        if other_vars:
            f.write("\n# Other environment variables\n")
            for key, value in other_vars.items():
                f.write(f"{key}={value}\n")


def get_next_key_number(env_vars: dict[str, str]) -> int:
    """Get next available GEMINI_API_KEY_N number."""
    existing_numbers = []
    for key in env_vars.keys():
        if key.startswith("GEMINI_API_KEY_"):
            suffix = key.replace("GEMINI_API_KEY_", "")
            if suffix.isdigit():
                existing_numbers.append(int(suffix))

    if not existing_numbers:
        return 1

    return max(existing_numbers) + 1


def mask_key(api_key: str) -> str:
    """Mask API key for display (show only last 4 chars)."""
    if len(api_key) <= 8:
        return "****"
    return f"{'*' * (len(api_key) - 4)}...{api_key[-4:]}"


def cmd_init(args):
    """Initialize .env file."""
    env_file = find_env_file()

    if env_file.exists():
        response = input(
            f"âš ï¸  .env file already exists at {env_file}\nOverwrite? (y/N): "
        )
        if response.lower() != "y":
            print("âŒ Cancelled")
            return

    write_env_file(env_file, {})
    print(f"âœ… Initialized empty .env file at {env_file}")
    print(f"\nNext steps:")
    print(f"  1. Add your first API key: geminiparallel add YOUR_API_KEY")
    print(f"  2. Test your keys: geminiparallel test")


def cmd_add(args):
    """Add a new API key."""
    env_file = find_env_file()

    if not env_file.exists():
        print(f"âŒ No .env file found at {env_file}")
        print(f"   Run 'geminiparallel init' first")
        return

    api_key = args.key

    if not api_key:
        print("âŒ No API key provided")
        print("   Usage: geminiparallel add YOUR_API_KEY")
        return

    # Basic validation
    if len(api_key) < 20:
        print("âŒ Invalid API key (too short)")
        return

    env_vars = read_env_file(env_file)

    # Check if key already exists
    for key, value in env_vars.items():
        if value == api_key:
            print(f"âš ï¸  This key already exists as {key}")
            return

    # Add new key
    key_number = get_next_key_number(env_vars)
    key_name = f"GEMINI_API_KEY_{key_number}"
    env_vars[key_name] = api_key

    write_env_file(env_file, env_vars)
    print(f"âœ… Added new API key as {key_name}")
    print(f"   Key: {mask_key(api_key)}")
    print(
        f"\nTotal keys: {sum(1 for k in env_vars if k.startswith('GEMINI_API_KEY_'))}"
    )


def cmd_remove(args):
    """Remove an API key."""
    env_file = find_env_file()

    if not env_file.exists():
        print(f"âŒ No .env file found at {env_file}")
        return

    env_vars = read_env_file(env_file)
    key_to_remove = args.key_name

    if key_to_remove not in env_vars:
        print(f"âŒ Key '{key_to_remove}' not found in .env file")
        print(f"\nAvailable keys:")
        for key in env_vars:
            if key.startswith("GEMINI_API_KEY_"):
                print(f"  - {key}")
        return

    # Confirm deletion
    masked = mask_key(env_vars[key_to_remove])
    response = input(f"âš ï¸  Remove {key_to_remove} ({masked})? (y/N): ")

    if response.lower() != "y":
        print("âŒ Cancelled")
        return

    del env_vars[key_to_remove]
    write_env_file(env_file, env_vars)
    print(f"âœ… Removed {key_to_remove}")
    print(
        f"\nRemaining keys: {sum(1 for k in env_vars if k.startswith('GEMINI_API_KEY_'))}"
    )


def cmd_list(args):
    """List all API keys (masked)."""
    env_file = find_env_file()

    if not env_file.exists():
        print(f"âŒ No .env file found at {env_file}")
        print(f"   Run 'geminiparallel init' first")
        return

    env_vars = read_env_file(env_file)
    gemini_keys = {k: v for k, v in env_vars.items() if k.startswith("GEMINI_API_KEY_")}

    if not gemini_keys:
        print("ðŸ“ No API keys found in .env file")
        print("\nAdd your first key with: geminiparallel add YOUR_API_KEY")
        return

    print(f"ðŸ“ API Keys in {env_file}:\n")

    # Sort by number
    sorted_keys = sorted(
        gemini_keys.items(),
        key=lambda x: int(x[0].split("_")[-1]) if x[0].split("_")[-1].isdigit() else 0,
    )

    for key_name, key_value in sorted_keys:
        masked = mask_key(key_value)
        print(f"  {key_name}: {masked}")

    print(f"\nTotal: {len(gemini_keys)} key(s)")


def cmd_test(args):
    """Test API keys by making a simple API call."""
    # Lazy import to avoid dependency issues
    try:
        from google import genai
    except ImportError:
        print("âŒ google-genai library not installed")
        print("   Install with: pip install google-genai")
        return

    env_file = find_env_file()

    if not env_file.exists():
        print(f"âŒ No .env file found at {env_file}")
        return

    env_vars = read_env_file(env_file)
    gemini_keys = {k: v for k, v in env_vars.items() if k.startswith("GEMINI_API_KEY_")}

    if not gemini_keys:
        print("âŒ No API keys found in .env file")
        return

    print(f"ðŸ§ª Testing {len(gemini_keys)} API key(s)...\n")

    # Sort by number
    sorted_keys = sorted(
        gemini_keys.items(),
        key=lambda x: int(x[0].split("_")[-1]) if x[0].split("_")[-1].isdigit() else 0,
    )

    valid_count = 0
    invalid_count = 0

    for key_name, key_value in sorted_keys:
        masked = mask_key(key_value)
        print(f"Testing {key_name} ({masked})... ", end="", flush=True)

        try:
            # Try to initialize client
            client = genai.Client(api_key=key_value)

            # Try a simple API call (list models)
            models = client.models.list()

            print("âœ… Valid")
            valid_count += 1
        except Exception as e:
            print(f"âŒ Invalid - {str(e)[:50]}")
            invalid_count += 1

    print(f"\nðŸ“Š Results:")
    print(f"  âœ… Valid: {valid_count}")
    print(f"  âŒ Invalid: {invalid_count}")
    print(f"  ðŸ“ Total: {len(gemini_keys)}")


def main():
    """Main CLI entry point."""
    parser = argparse.ArgumentParser(
        prog="geminiparallel",
        description="Manage Gemini API keys for gemini-parallel library",
        epilog="For more information, visit: https://github.com/your-repo",
    )

    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # init command
    parser_init = subparsers.add_parser("init", help="Initialize .env file")
    parser_init.set_defaults(func=cmd_init)

    # add command
    parser_add = subparsers.add_parser("add", help="Add a new API key")
    parser_add.add_argument("key", help="API key to add")
    parser_add.set_defaults(func=cmd_add)

    # remove command
    parser_remove = subparsers.add_parser("remove", help="Remove an API key")
    parser_remove.add_argument(
        "key_name", help="Key name to remove (e.g., GEMINI_API_KEY_1)"
    )
    parser_remove.set_defaults(func=cmd_remove)

    # list command
    parser_list = subparsers.add_parser("list", help="List all API keys (masked)")
    parser_list.set_defaults(func=cmd_list)

    # test command
    parser_test = subparsers.add_parser("test", help="Test all API keys")
    parser_test.set_defaults(func=cmd_test)

    args = parser.parse_args()

    if not args.command:
        parser.print_help()
        return

    args.func(args)


if __name__ == "__main__":
    main()
