name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write
  pull-requests: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Generate GitHub App Token
        uses: actions/create-github-app-token@v2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Set Git Bot Identity
        id: git-bot
        run: |
          # Get GitHub App details
          APP_SLUG="${{ steps.app-token.outputs.app-slug }}"
          USER_ID=$(gh api "/users/${APP_SLUG}[bot]" --jq .id)

          # Construct bot identity
          BOT_NAME="${APP_SLUG}[bot]"
          BOT_EMAIL="${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"

          # Export for use in subsequent steps
          echo "name=${BOT_NAME}" >> "$GITHUB_OUTPUT"
          echo "email=${BOT_EMAIL}" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true
          token: ${{ steps.app-token.outputs.token }}
          # Make sure the value of GITHUB_TOKEN will not be persisted in repo's config
          persist-credentials: false
      - name: Configure git for GitHub App
        run: |
          # Set git identity from bot outputs
          BOT_NAME="${{ steps.git-bot.outputs.name }}"
          BOT_EMAIL="${{ steps.git-bot.outputs.email }}"

          # Configure global git identity
          git config --global user.name "${BOT_NAME}"
          git config --global user.email "${BOT_EMAIL}"

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Semantic Release
        id: semantic-release
        uses: cycjimmy/semantic-release-action@v6
        with:
          extra_plugins: |
            @semantic-release/changelog
            conventional-changelog-conventionalcommits
        env:
          # GitHub authentication
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Commit changelog via GitHub API
        if: steps.semantic-release.outputs.new_release_published == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const fs = require('fs');
            const version = '${{ steps.semantic-release.outputs.new_release_version }}';
            const filePath = 'CHANGELOG.md';
            const message = `chore(release): ${version} [skip ci]`;

            console.log('Committing CHANGELOG.md via GitHub Contents API...');

            // Read file content
            const content = fs.readFileSync(filePath, 'utf8');
            const contentBase64 = Buffer.from(content).toString('base64');

            // Get current file SHA
            const { data: currentFile } = await github.rest.repos.getContent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: filePath,
              ref: 'main'
            });

            console.log(`Current file SHA: ${currentFile.sha.substring(0, 7)}`);

            // Commit via GitHub Contents API (creates verified commit!)
            const { data: result } = await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: filePath,
              message: message,
              content: contentBase64,
              sha: currentFile.sha,
              branch: 'main'
            });

            console.log('✓ Changelog committed via GitHub API');
            console.log(`  Commit SHA: ${result.commit.sha.substring(0, 7)}`);
            console.log(`  Author: ${result.commit.author.name}`);
            console.log(`  Committer: ${result.commit.committer.name}`);
            console.log(`  Verified: ${result.commit.verification.verified ? '✓' : '✗'}`)
