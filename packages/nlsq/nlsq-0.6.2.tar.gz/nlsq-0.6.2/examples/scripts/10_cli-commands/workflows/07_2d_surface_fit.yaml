# ==============================================================================
# 07_2d_surface_fit.yaml - 2D Surface Fitting
# ==============================================================================
# Demonstrates fitting 2D surface data (image data, beam profiles).
#
# Usage:
#   nlsq fit workflows/07_2d_surface_fit.yaml
#
# 2D Fitting Mode:
#   - xdata shape: (2, n_points) where xdata[0]=x, xdata[1]=y
#   - ydata shape: (n_points,) containing z values
#   - Enabled when data.columns.z is specified
#
# Model signature for 2D: def model(xy, *params)
#   where xy[0] = x coordinates, xy[1] = y coordinates
# ==============================================================================

metadata:
  workflow_name: "2d_surface_fit"
  description: "2D Gaussian surface fitting for beam profile analysis"
  version: "1.0"

# ==============================================================================
# DATA CONFIGURATION - 2D MODE
# ==============================================================================
data:
  dataset_id: "surface_2d_001"
  input_file: "data/surface_2d.txt"
  format: "ascii"

  # 2D Mode: Specify z column to enable surface fitting
  # x, y become coordinates; z becomes the dependent variable
  columns:
    x: 0              # First coordinate (column 0)
    y: 1              # Second coordinate (column 1)
    z: 2              # Dependent variable (column 2) - ENABLES 2D MODE
    sigma: 3          # Uncertainties on z (column 3)

  ascii:
    delimiter: null   # Any whitespace
    comment_char: "#"
    skip_header: 3    # Skip header lines

# ==============================================================================
# MODEL CONFIGURATION - 2D MODEL
# ==============================================================================
model:
  type: "custom"
  path: "models/physics_models.py"

  # Use 2D Gaussian model: gaussian_2d(xy, amplitude, x0, y0, sigma_x, sigma_y, offset)
  function: "gaussian_2d"

  model_id: "gaussian_2d_surface"

# ==============================================================================
# FITTING CONFIGURATION
# ==============================================================================
fitting:
  # Initial parameter guess: [amplitude, x0, y0, sigma_x, sigma_y, offset]
  p0: [80.0, 0.0, 0.0, 1.0, 1.0, 5.0]

  # Parameter bounds
  bounds:
    lower: [0.0, -3.0, -3.0, 0.1, 0.1, 0.0]
    upper: [200.0, 3.0, 3.0, 5.0, 5.0, 50.0]

  termination:
    ftol: 1.0e-8
    xtol: 1.0e-8
    gtol: 1.0e-8
    max_iterations: 200

# ==============================================================================
# EXPORT CONFIGURATION
# ==============================================================================
export:
  results_file: "output/07_2d_surface_fit_results.json"

  include:
    parameters: true
    covariance: true
    uncertainties: true
    statistics: true
    convergence_info: true

# ==============================================================================
# VISUALIZATION CONFIGURATION
# ==============================================================================
# Note: 2D surface fitting visualization shows projected 1D slices.
# Full 3D surface plots require custom visualization scripts.
# Style: "publication" with colorblind-safe palette.

visualization:
  enabled: true
  output_dir: "output/figures"
  filename_prefix: "07_2d_surface"
  formats: ["png", "pdf"]
  dpi: 300
  figure_size: [7.0, 5.25]        # Double-column width
  style: "publication"
  layout: "combined"

  font:
    family: "serif"
    size: 10
    math_fontset: "cm"

  main_plot:
    title: null
    x_label: "Position"
    y_label: "Intensity (counts)"
    show_grid: true
    grid_alpha: 0.3

    data:
      marker: "."                 # Small dots for dense 2D data
      size: 5
      alpha: 0.5
      label: "Surface Data"
      show_errorbars: false       # Too many points for error bars

    fit:
      linewidth: 1.5
      linestyle: "-"
      label: "2D Gaussian Fit"
      n_points: 500

    confidence_band:
      enabled: true
      level: 0.95
      alpha: 0.2

    legend:
      enabled: true
      location: "upper right"
      frameon: true

    annotation:
      enabled: true
      show_r_squared: true
      show_rmse: true
      show_chi_squared: true
      location: "upper left"
      fontsize: 9
      box_alpha: 0.8

  residuals_plot:
    enabled: true
    type: "scatter"
    x_label: "Data Point Index"
    y_label: "Residual"
    show_zero_line: true
    marker: "."
    size: 3
    alpha: 0.5

    std_bands:
      enabled: true
      levels: [1, 2]
      colors: ["#e8f4e8", "#d4e9d4"]
      alpha: 0.5

  histogram:
    enabled: true
    bins: 30                      # More bins for large dataset
    show_normal_fit: true
    alpha: 0.7
    edgecolor: "white"
    title: "2D Fit Residual Distribution"

  active_scheme: "colorblind"
