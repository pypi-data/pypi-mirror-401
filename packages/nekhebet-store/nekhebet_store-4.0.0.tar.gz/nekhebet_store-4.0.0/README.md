# Nekhebet Store
**Append-Only Cryptographically Verifiable Event Storage**

![MIT License](https://img.shields.io/badge/license-MIT-blue.svg)
![Python](https://img.shields.io/badge/python-3.11+-blue)
![PostgreSQL](https://img.shields.io/badge/PostgreSQL-16+-blue)
![LMDB](https://img.shields.io/badge/LMDB-1.4+-orange)
![nekhebet-core](https://img.shields.io/badge/depends-on%20nekhebet--core%204.0+-9cf)

## üî∫ –û–±–∑–æ—Ä

**Nekhebet Store** ‚Äî —ç—Ç–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ, —Å—Ç—Ä–æ–≥–æ append-only —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è **–∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ–º—ã—Ö —Å–æ–±—ã—Ç–∏–π** Nekhebet.

–û–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

- –∞—Ç–æ–º–∞—Ä–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤ (`SignedEnvelope`)
- **idempotency** –ø–æ `content_hash` (payload SHA-256)
- **replay protection** –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ `(key_id, nonce)`
- –±—ã—Å—Ç—Ä—É—é –≤—ã–±–æ—Ä–∫—É –ø–æ `event_id` –∏ `content_hash`
- –≥–∏–±—Ä–∏–¥–Ω—ã–π —Ä–µ–∂–∏–º **PostgreSQL + LMDB** –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏

Store **–Ω–µ –¥–æ–≤–µ—Ä—è–µ—Ç** –Ω–∏–∫–∞–∫–∏–º –¥–∞–Ω–Ω—ã–º, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –ø—Ä–æ—à–ª–∏ –ø–æ–ª–Ω—É—é –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –≤ `nekhebet-core`.  
–í—Å—ë, —á—Ç–æ –ø–æ–ø–∞–ª–æ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ ‚Äî **–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–∫–∞–∑—É–µ–º–æ –ø–æ–¥–ª–∏–Ω–Ω–æ**.

## üî∫ –ö–ª—é—á–µ–≤–æ–π –∏–Ω–≤–∞—Ä–∏–∞–Ω—Ç

> –•—Ä–∞–Ω–∏–ª–∏—â–µ **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –∏ –Ω–µ —É–¥–∞–ª—è–µ—Ç —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è.  
> –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ ‚Äî **—Ä–µplay protection** (–æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤).

## üî∫ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

```
Ingest / Verification (nekhebet-core)
           ‚Üì
   HybridEventRepository
      /               \
PostgreSQL           LMDB
(metadata +          (full opaque
 replay guard)       SignedEnvelope blobs)
```

- **PostgreSQL** ‚Äî **–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫**:
  - replay protection
  - –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (id, type, issued_at, source, content_hash)
  - –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ –ø–æ–∏—Å–∫–∞

- **LMDB** ‚Äî **–±—ã—Å—Ç—Ä—ã–π mmap-–¥–æ—Å—Ç—É–ø**:
  - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤
  - O(1) —á—Ç–µ–Ω–∏–µ –ø–æ content_hash
  - zero-copy –∏—Ç–µ—Ä–∞—Ü–∏—è

- **HybridEventRepository** ‚Äî –ª–æ–≥–∏—á–µ—Å–∫–∏ –∞—Ç–æ–º–∞—Ä–Ω—ã–π —Å–ª–æ–π:
  - –°–Ω–∞—á–∞–ª–∞ –ø–∏—à–µ—Ç –≤ PostgreSQL (–∫—Ä–∏—Ç–∏—á–Ω–æ)
  - –¢–æ–ª—å–∫–æ –ø–æ—Ç–æ–º –≤ LMDB (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)

## üî∫ –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å–ø–æ—Å–æ–±
pip install nekhebet-store
```

```bash
# –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
pip install git+https://github.com/nekhebet/nekhebet-store.git@main
```

```bash
# –î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–æ–≤
git clone https://github.com/nekhebet/nekhebet-store.git
cd nekhebet-store
pip install -e ".[dev]"
```

–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
- `nekhebet-core>=4.0.0`
- `psycopg2-binary>=2.9` ‚Äî PostgreSQL
- `lmdb>=1.4.1` ‚Äî LMDB

–¢—Ä–µ–±—É–µ—Ç—Å—è **Python 3.10+**.

## üî∫ –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```python
from psycopg2 import connect
from nekhebet_store import HybridEventRepository
from nekhebet_core import verify_envelope

# PostgreSQL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
pg_conn = connect(
    dbname="nekhebet",
    user="postgres",
    password="",
    host="localhost",
    port=5432
)

# –ü—É—Ç—å –∫ LMDB (–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å)
lmdb_path = "/var/lib/nekhebet/lmdb"

repo = HybridEventRepository(pg_conn, lmdb_path)

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
repo.save(signed_envelope)  # –∞—Ç–æ–º–∞—Ä–Ω–æ: PG ‚Üí LMDB

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ event_id
envelope = repo.get("550e8400-e29b-41d4-a716-446655440000")

# –ü—Ä–æ–≤–µ—Ä–∫–∞ (–≤—Å–µ–≥–¥–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)
result = verify_envelope(envelope)
assert result.valid

# –ó–∞–∫—Ä—ã—Ç–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
repo.close()
```

## üî∫ –û—Å–Ω–æ–≤–Ω—ã–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- **`pg_repository.py`** ‚Äî PostgreSQL (–∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å + replay guard)
- **`lmdb_repository.py`** ‚Äî LMDB (–±—ã—Å—Ç—Ä–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω—ã—Ö –∫–æ–Ω–≤–µ—Ä—Ç–æ–≤)
- **`hybrid_repository.py`** ‚Äî –≥–∏–±—Ä–∏–¥–Ω—ã–π —Å–ª–æ–π (–ª–æ–≥–∏—á–µ—Å–∫–∞—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å)
- **`schema.sql`** ‚Äî –ø–æ–ª–Ω–∞—è —Å—Ö–µ–º–∞ PostgreSQL (append-only, replay guard)

## üî∫ –ò–Ω–≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

1. **Append-only** ‚Äî –Ω–µ—Ç UPDATE/DELETE –Ω–∞ `events`
2. **Idempotency** ‚Äî –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ `content_hash` –æ—Ç–∫–ª–æ–Ω—è—é—Ç—Å—è
3. **Replay protection** ‚Äî `(key_id, nonce)` —É–Ω–∏–∫–∞–ª–µ–Ω –Ω–∞–≤—Å–µ–≥–¥–∞
4. **Zero-trust** ‚Äî Store –Ω–µ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å—å, –ø–æ–ª–∞–≥–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –Ω–∞ `nekhebet-core`
5. **–ì–∏–±—Ä–∏–¥–Ω–∞—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å** ‚Äî PG –≤—Å–µ–≥–¥–∞ –ø–∏—à–µ—Ç—Å—è –ø–µ—Ä–≤—ã–º
6. **–ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å** ‚Äî –µ—Å–ª–∏ PG —É—Å–ø–µ—Ö ‚Üí LMDB –¥–æ–ª–∂–µ–Ω —Ç–æ–∂–µ —É—Å–ø–µ—Ç—å (–∏–Ω–∞—á–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞)

## üî∫ –û—á–∏—Å—Ç–∫–∞ replay guard

```sql
-- –ü—Ä–∏–º–µ—Ä: PostgreSQL
DELETE FROM replay_guard
WHERE issued_at < now() - interval '7 days';

-- LMDB (—á–µ—Ä–µ–∑ API)
repo.lmdb.cleanup_replay_guard(older_than_iso="2025-01-01T00:00:00Z")
```

## üî∫ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## üî∫ –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**Nekhebet Store** ‚Äî —ç—Ç–æ –≤—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ–µ, —Å—Ç—Ä–æ–≥–æ append-only —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –∫–æ—Ç–æ—Ä–æ–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç:

> –ö–∞–∂–¥–æ–µ –∑–∞–ø–∏—Å–∞–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ ‚Äî **–º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–∫–∞–∑—É–µ–º–æ –ø–æ–¥–ª–∏–Ω–Ω–æ**, —É–Ω–∏–∫–∞–ª—å–Ω–æ –∏ –Ω–µ–∏–∑–º–µ–Ω–Ω–æ.

PostgreSQL –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫—É, LMDB ‚Äî –º–æ–ª–Ω–∏–µ–Ω–æ—Å–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ –ø–æ–ª–Ω—ã–º –∫–æ–Ω–≤–µ—Ä—Ç–∞–º, –∞ –≥–∏–±—Ä–∏–¥–Ω—ã–π —Å–ª–æ–π ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –±–µ–∑ –ø–æ—Ç–µ—Ä–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–µ –ø–æ–ø–∞–ª–æ –≤ Store ‚Äî –æ–Ω–æ **–Ω–∞–≤—Å–µ–≥–¥–∞** –ø–æ–¥–ª–∏–Ω–Ω–æ–µ.  
