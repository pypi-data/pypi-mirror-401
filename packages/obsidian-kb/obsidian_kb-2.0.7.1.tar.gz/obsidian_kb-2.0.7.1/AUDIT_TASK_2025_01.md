# Задача для Claude Code: Комплексный аудит obsidian-kb и актуализация Roadmap

## Контекст

obsidian-kb v1.0.1 — MCP-сервер для семантического поиска по Obsidian vault'ам. Проект работает, но есть критические проблемы с производительностью и качеством, блокирующие продуктивное использование.

## Текущие проблемы (от пользователя)

### 1. Медленный поиск
- Поисковые запросы выполняются неприемлемо долго
- Нужно измерить реальные latency и найти bottlenecks

### 2. Нерелевантные результаты
- Поиск возвращает не то, что ожидается
- Нужно понять, почему: проблема в intent detection, ranking, или самих данных

### 3. Неконтролируемая индексация
- Периодически запускается `index_documents` без явного запроса пользователя
- Найти, кто и что триггерит эти запуски
- Всё управление (кроме автоматических обновлений конкретных изменённых/новых файлов) должно быть инициировано пользователем явно

## Стратегическая цель

**Миграция на архитектуру SQLite + LanceDB**, где:
- **LanceDB** — только для векторов (chunks с embeddings)
- **SQLite** — для всего остального (документы, свойства, теги, связи, кэш)

Причина: в LanceDB плохо работают условия фильтрации, двухэтапные запросы через SQLite будут быстрее и качественнее.

## Задачи аудита

### Часть 1: Диагностика текущих проблем

#### 1.1 Аудит производительности поиска
- [ ] Измерить latency для разных типов запросов (vector, FTS, hybrid, filter-only)
- [ ] Профилировать `search_vault` end-to-end, найти bottlenecks
- [ ] Проверить, какие индексы существуют в LanceDB и используются ли они
- [ ] Оценить влияние размера vault на производительность

#### 1.2 Аудит качества поиска
- [ ] Протестировать intent detection на реальных запросах
- [ ] Проверить, как работает ranking (similarity scores, их распределение)
- [ ] Найти примеры нерелевантных результатов и понять причину
- [ ] Оценить качество chunking (размеры чанков, overlap)

#### 1.3 Аудит автоматической индексации
- [ ] Найти ВСЕ места, где вызывается `index_documents` или аналоги
- [ ] Определить триггеры: file watcher, background jobs, scheduled tasks
- [ ] Документировать текущую логику автоиндексации
- [ ] Предложить, как сделать её полностью контролируемой пользователем

### Часть 2: Архитектурный аудит

#### 2.1 Текущая схема данных
- [ ] Задокументировать фактическую структуру таблиц LanceDB
- [ ] Найти, где хранятся метаданные (documents, properties, tags, links)
- [ ] Определить, есть ли уже SQLite и для чего используется
- [ ] Составить ER-диаграмму текущего состояния

#### 2.2 Сравнение с целевой архитектурой
Целевая схема в файле `roadmap/obsidian-kb-erd-v2.1.mermaid`.

- [ ] Сравнить текущую схему с целевой
- [ ] Определить gap и объём работ по миграции
- [ ] Оценить риски миграции (потеря данных, breaking changes)

### Часть 3: Code Quality & Technical Debt

#### 3.1 Инвентаризация кодовой базы
- [ ] Актуальна ли структура файлов в README/ARCHITECTURE?
- [ ] Есть ли мёртвый код, неиспользуемые модули?
- [ ] Соответствует ли код заявленным паттернам (DI, Protocol, слои)?

#### 3.2 Тесты и покрытие
- [ ] Проверить реальное покрытие тестами критических модулей
- [ ] Есть ли тесты на производительность?
- [ ] Работают ли все 1026+ тестов?

### Часть 4: Актуализация Roadmap

#### 4.1 Ревизия существующего roadmap
Текущий roadmap в `roadmap/obsidian-kb-roadmap-consolidated.md`.

- [ ] Какие пункты из Release 2.0 уже частично реализованы?
- [ ] Какие пункты устарели или неактуальны?
- [ ] Что нужно добавить с учётом найденных проблем?

#### 4.2 Приоритизация
На основе аудита предложить пересмотренный план:
- [ ] P0 (блокеры) — что чинить немедленно
- [ ] P1 (критично) — что делать в Release 2.0
- [ ] P2 (важно) — что отложить на 2.1+

## Deliverables

### 1. Отчёт об аудите (AUDIT_REPORT.md)
```markdown
# Отчёт об аудите obsidian-kb

## Executive Summary
[Краткие выводы: 3-5 пунктов]

## Проблема 1: Медленный поиск
### Измерения
[Конкретные цифры latency]
### Root cause
[Почему медленно]
### Рекомендации
[Что делать]

## Проблема 2: Нерелевантные результаты
...

## Проблема 3: Неконтролируемая индексация
### Найденные триггеры
[Список мест в коде]
### Рекомендации
...

## Архитектурный gap
### Текущая схема vs Целевая
[Диаграмма или таблица сравнения]
### План миграции
...

## Technical Debt
[Список с приоритетами]
```

### 2. Актуализированный Roadmap (ROADMAP_v2_REVISED.md)
```markdown
# obsidian-kb Roadmap v2.0 (Revised)

## Изменения относительно предыдущей версии
[Что добавлено/убрано/переприоритизировано]

## Immediate Fixes (до Release 2.0)
[P0 баги и quick wins]

## Release 2.0 — Storage Layer (пересмотренный)
[Актуализированные фазы с учётом аудита]

## Release 2.1+
[Обновлённый план]
```

### 3. Исправления P0 (опционально)
Если в процессе аудита найдутся простые исправления для критических багов — можно сразу сделать PR.

## Ключевые файлы для анализа

```
# Entry points
src/obsidian_kb/mcp_server.py          # MCP tools, search_vault
src/obsidian_kb/service_container.py   # DI, сервисы

# Search
src/obsidian_kb/search/                # SearchService, strategies
src/obsidian_kb/services/              # Extended Query Layer

# Storage
src/obsidian_kb/storage/               # Repositories, indexing
src/obsidian_kb/lance_db.py            # LanceDB facade

# Background jobs
src/obsidian_kb/storage/indexing/      # BackgroundJobQueue, etc.

# Существующая документация
ARCHITECTURE.md
DATABASE_SCHEMA.md
roadmap/obsidian-kb-roadmap-consolidated.md
SEARCH_AUDIT_TASK.md                   # Детальный чеклист для аудита поиска
```

## Методология

1. **Начни с воспроизведения проблем** — запусти тестовые запросы, убедись что проблемы существуют
2. **Измеряй, не предполагай** — конкретные цифры latency, примеры нерелевантных результатов
3. **Следуй по коду** — от entry point до результата, документируй flow
4. **Сравнивай с целевым состоянием** — gap analysis относительно архитектуры v2.1
5. **Приоритизируй по impact** — что даст максимальный эффект при минимальных усилиях

## Ограничения

- Не делай breaking changes без согласования
- Не начинай миграцию на SQLite — только аудит и план
- Фокус на диагностике и рекомендациях, а не на немедленном рефакторинге

---

**Ожидаемое время:** 4-6 часов
**Результат:** Чёткое понимание текущего состояния + actionable план развития
