# Руководство по тестированию производительности поиска v5

**Версия:** 1.0  
**Дата:** 2025-01-21  
**Цель:** Измерить время ответа (P50, P95, P99) для разных типов поиска  
**Целевой P95:** <400 мс

---

## Цели тестирования

1. Измерить производительность document-level поиска
2. Измерить производительность chunk-level поиска (vector, fts, hybrid)
3. Проверить соответствие целевым метрикам (P95 <400 мс)
4. Выявить узкие места производительности

---

## Подготовка

1. Убедитесь, что у вас есть проиндексированный vault с тестовыми данными
2. Убедитесь, что у вас установлены все зависимости проекта
3. Проверьте, что Ollama работает (для генерации embeddings)

---

## Автоматизированное тестирование

### Запуск скрипта

```bash
cd /Users/mdemyanov/CursorProjects/obsidian-kb
python tests/test_performance_v5.py <vault_name> [iterations]
```

**Параметры:**
- `vault_name` — имя vault'а для тестирования (обязательно)
- `iterations` — количество итераций для каждого запроса (по умолчанию: 10)

**Пример:**
```bash
python tests/test_performance_v5.py test_vault 10
```

### Что делает скрипт

1. **Инициализация сервисов** — создаёт ServiceContainer и загружает все необходимые сервисы
2. **Разогрев** — выполняет несколько тестовых запросов для "прогрева" системы
3. **Тест 1: Document-level поиск** — измеряет производительность поиска по метаданным
4. **Тест 2: Chunk-level vector поиск** — измеряет семантический поиск
5. **Тест 3: Chunk-level FTS поиск** — измеряет полнотекстовый поиск
6. **Тест 4: Chunk-level hybrid поиск** — измеряет гибридный поиск
7. **Генерация отчётов** — создаёт JSON и Markdown отчёты

### Результаты

Скрипт создаёт два файла:

1. **`tests/performance_test_results.json`** — детальные результаты в JSON формате
2. **`tests/performance_test_results.md`** — отчёт в Markdown для чтения

---

## Интерпретация результатов

### Метрики

- **P50 (медиана)** — 50% запросов выполняются быстрее этого значения
- **P95** — 95% запросов выполняются быстрее этого значения (целевая метрика)
- **P99** — 99% запросов выполняются быстрее этого значения
- **Среднее** — среднее арифметическое время выполнения
- **Мин/Макс** — минимальное и максимальное время выполнения

### Целевые значения

| Метрика | Целевое значение | Статус |
|---------|-------------------|--------|
| P95 (document-level) | <400 мс | ⏳ Измерение |
| P95 (chunk-level vector) | <400 мс | ⏳ Измерение |
| P95 (chunk-level fts) | <400 мс | ⏳ Измерение |
| P95 (chunk-level hybrid) | <400 мс | ⏳ Измерение |

### Оценка результатов

✅ **Хорошо**, если:
- P95 < 400 мс для всех типов поиска
- P50 < 200 мс
- Нет выбросов (P99 не сильно отличается от P95)

⚠️ **Требует внимания**, если:
- P95 > 400 мс для какого-либо типа поиска
- Большая разница между P50 и P95 (>200 мс)
- P99 значительно превышает P95 (>100 мс)

❌ **Проблема**, если:
- P95 > 600 мс
- Среднее время > 500 мс
- Большое количество выбросов

---

## Ручное тестирование

Если вы хотите протестировать производительность вручную через Claude Desktop:

### Шаг 1: Document-level поиск

Выполните несколько запросов с фильтрами:

```
Выполни поиск в vault [имя] с запросом: tags:python
Выполни поиск в vault [имя] с запросом: type:note
Выполни поиск в vault [имя] с запросом: tags:meeting tags:important
```

Запишите время выполнения из ответа (поле `execution_time_ms`).

### Шаг 2: Chunk-level поиск

Выполните семантические запросы:

```
Выполни поиск в vault [имя] с запросом: Python async programming
Выполни поиск в vault [имя] с запросом: database optimization techniques
```

Запишите время выполнения.

### Шаг 3: Анализ результатов

Подсчитайте:
- Среднее время выполнения
- Медиану (P50)
- 95-й перцентиль (P95)
- 99-й перцентиль (P99)

---

## Устранение проблем производительности

### Если P95 > 400 мс

1. **Проверьте Ollama** — убедитесь, что сервер работает быстро
2. **Проверьте размер vault'а** — большие vault'ы могут работать медленнее
3. **Проверьте индексы** — убедитесь, что индексы созданы и актуальны
4. **Проверьте сеть** — если Ollama на удалённом сервере, проверьте задержку

### Если document-level поиск медленный

- Проверьте количество документов в vault'е
- Проверьте сложность фильтров
- Убедитесь, что индексы на таблице documents созданы

### Если chunk-level поиск медленный

- Проверьте размер векторных индексов
- Проверьте количество чанков в vault'е
- Убедитесь, что используется правильная модель embedding

---

## Сравнение с предыдущей версией

Для сравнения с реализацией v4 можно запустить старый скрипт:

```bash
python scripts/measure_performance.py
```

Сравните результаты и убедитесь, что нет регрессий.

---

## Отчёт о проблемах

Если обнаружены проблемы производительности:

1. Задокументируйте результаты тестирования
2. Укажите тип поиска с проблемой
3. Предоставьте метрики (P50, P95, P99)
4. Опишите окружение (размер vault'а, модель embedding, и т.д.)
5. Создайте issue в репозитории

---

## Контакты

При возникновении вопросов обращайтесь к разработчикам проекта.

