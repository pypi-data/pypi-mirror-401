# Руководство по тестированию размера ответа поиска v5

**Версия:** 1.0  
**Дата:** 2025-01-21  
**Цель:** Измерить размер ответа для разных типов запросов  
**Целевой размер:** ~1KB/doc для metadata-only запросов (вместо ~2KB/чанк)

---

## Цели тестирования

1. Измерить размер ответа для metadata-only запросов (document-level)
2. Измерить размер ответа для semantic запросов (chunk-level)
3. Измерить размер ответа для hybrid запросов (chunk-level)
4. Проверить соответствие целевым метрикам (<1KB/doc для metadata-only)
5. Сравнить размеры между document-level и chunk-level подходами

---

## Подготовка

1. Убедитесь, что у вас есть проиндексированный vault с тестовыми данными
2. Убедитесь, что у вас установлены все зависимости проекта
3. Проверьте, что Ollama работает (для генерации embeddings)

---

## Автоматизированное тестирование

### Запуск скрипта

```bash
cd /Users/mdemyanov/CursorProjects/obsidian-kb
python tests/test_response_size.py <vault_name>
```

**Параметры:**
- `vault_name` — имя vault'а для тестирования (обязательно)

**Пример:**
```bash
python tests/test_response_size.py test_vault
```

### Что делает скрипт

1. **Инициализация сервисов** — создаёт ServiceContainer и загружает все необходимые сервисы
2. **Тест 1: Metadata-only запросы** — измеряет размер ответа для document-level поиска
3. **Тест 2: Semantic запросы** — измеряет размер ответа для chunk-level vector поиска
4. **Тест 3: Hybrid запросы** — измеряет размер ответа для chunk-level hybrid поиска
5. **Генерация отчётов** — создаёт JSON и Markdown отчёты

### Результаты

Скрипт создаёт два файла:

1. **`tests/response_size_test_results.json`** — детальные результаты в JSON формате
2. **`tests/response_size_test_results.md`** — отчёт в Markdown для чтения

---

## Интерпретация результатов

### Метрики

- **Средний размер (байт/док)** — средний размер ответа на один документ
- **Медиана** — медианный размер ответа
- **Мин/Макс** — минимальный и максимальный размер

### Целевые значения

| Тип запроса | Целевой размер | Статус |
|-------------|----------------|--------|
| Metadata-only (Markdown) | <1024 байт/док | ⏳ Измерение |
| Metadata-only (JSON) | <1024 байт/док | ⏳ Измерение |
| Semantic (Markdown) | Приемлемый | ⏳ Измерение |
| Hybrid (Markdown) | Приемлемый | ⏳ Измерение |

### Оценка результатов

✅ **Хорошо**, если:
- Metadata-only запросы: <1024 байт/док (1KB)
- Document-level меньше chunk-level на 30-50%
- Размер приемлем для использования в MCP

⚠️ **Требует внимания**, если:
- Metadata-only запросы: 1024-2048 байт/док
- Разница между document-level и chunk-level <20%

❌ **Проблема**, если:
- Metadata-only запросы: >2048 байт/док (2KB)
- Размер ответа слишком большой для MCP контекста

---

## Ручное тестирование

Если вы хотите протестировать размер ответа вручную:

### Шаг 1: Metadata-only запрос

Выполните запрос с фильтрами:

```
Выполни поиск в vault [имя] с запросом: tags:python
```

Сохраните ответ и измерьте его размер:

```python
response_text = "..."  # Ответ от системы
size_bytes = len(response_text.encode("utf-8"))
size_kb = size_bytes / 1024
print(f"Размер ответа: {size_bytes} байт ({size_kb:.2f} KB)")
```

### Шаг 2: Semantic запрос

Выполните семантический запрос:

```
Выполни поиск в vault [имя] с запросом: Python async programming
```

Измерьте размер ответа и сравните с metadata-only запросом.

---

## Оптимизация размера ответа

### Если размер слишком большой

1. **Проверьте include_content** — убедитесь, что для metadata-only запросов `include_content=False`
2. **Проверьте snippet** — snippet должен быть ограничен (например, 200-500 символов)
3. **Проверьте количество результатов** — ограничьте `limit` до разумного значения (10-20)
4. **Проверьте форматирование** — убедитесь, что formatter не добавляет лишние данные

### Рекомендации

- **Metadata-only запросы:** `include_content=False`, `limit=10-20`
- **Semantic запросы:** `include_content=True`, `snippet_max_length=500`, `limit=10`
- **Hybrid запросы:** аналогично semantic запросам

---

## Сравнение с предыдущей версией

Для сравнения с реализацией v4 можно измерить размер ответа старой версии:

1. Запустите поиск через старый API
2. Измерьте размер ответа
3. Сравните с результатами v5

**Ожидаемое улучшение:**
- Metadata-only запросы: уменьшение на 30-50% (с ~2KB/чанк до ~1KB/док)
- Semantic запросы: аналогичный или немного больший размер (из-за группировки)

---

## Отчёт о проблемах

Если обнаружены проблемы с размером ответа:

1. Задокументируйте результаты тестирования
2. Укажите тип запроса с проблемой
3. Предоставьте метрики (средний размер, медиана)
4. Опишите окружение (размер vault'а, количество результатов)
5. Создайте issue в репозитории

---

## Контакты

При возникновении вопросов обращайтесь к разработчикам проекта.

