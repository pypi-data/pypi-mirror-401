#!/bin/bash

# Script to build and run the {{ agent_name }} locally in Docker

set -e  # Exit on error

# Color codes for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Create .env from .env.example if it doesn't exist
if [ ! -f .env ]; then
    if [ -f .env.example ]; then
        echo -e "${BLUE}üìã Creating .env from .env.example...${NC}"
        cp .env.example .env
        echo -e "${GREEN}‚úÖ Created .env file${NC}"
    else
        echo -e "${RED}‚ùå No .env.example file found${NC}"
        exit 1
    fi
else
    echo -e "${GREEN}‚úÖ .env file already exists${NC}"
fi

# Populate missing secrets from runtime environment or main repo .env
populate_secrets() {
    echo -e "${BLUE}üîç Populating secrets from runtime environment...${NC}"
    
    # List of secret env vars to populate (prioritize runtime env, fallback to repo .env)
    secret_vars=("OPENAI_API_KEY" "ANTHROPIC_API_KEY" "GOOGLE_API_KEY" "AGENTOPS_API_KEY")
    
    for var in "${secret_vars[@]}"; do
        # Check if variable is missing or commented out in local .env
        if ! grep -q "^${var}=" .env 2>/dev/null; then
            # First try to get value from current runtime environment
            value="${!var:-}"
            
            # If not in runtime env, try to find main repo .env file
            if [ -z "$value" ]; then
                local repo_env=""
                if [ -f "../../../../.env" ]; then
                    repo_env="../../../../.env"
                elif [ -f "../../../.env" ]; then
                    repo_env="../../../.env"
                elif [ -f "../../.env" ]; then
                    repo_env="../../.env"
                fi
                
                if [ -n "$repo_env" ] && [ -f "$repo_env" ]; then
                    value=$(grep "^${var}=" "$repo_env" 2>/dev/null | cut -d'=' -f2-)
                fi
            fi
            
            # If we found a value (from either source), add it to .env
            if [ -n "$value" ]; then
                echo -e "${GREEN}  ‚úÖ Adding ${var}${NC}"
                # Replace commented placeholder with actual value
                sed -i.bak "s|^# ${var}=.*|${var}=${value}|" .env
            else
                echo -e "${YELLOW}  ‚ö†Ô∏è  ${var} not found in runtime env or repo .env${NC}"
            fi
        else
            echo -e "${GREEN}  ‚úÖ ${var} already set in .env${NC}"
        fi
    done
}

# Load environment variables from .env
echo -e "${BLUE}üìã Loading environment variables from .env file...${NC}"

# Populate secrets before loading (from runtime env or repo .env)
populate_secrets

set -a  # Export all variables
source .env
set +a  # Stop exporting

# Configuration with defaults
IMAGE_NAME="{{ agent_id }}"
CONTAINER_NAME="{{ agent_id }}-local"
HOST_PORT=${PORT:-8000}
CONTAINER_PORT=${PORT:-8000}

echo -e "${BLUE}üöÄ Building and running {{ agent_name }}...${NC}"
echo -e "${BLUE}   Using port: ${HOST_PORT}${NC}"
echo

# Check if Docker is installed
if ! command -v docker &> /dev/null; then
    echo -e "${RED}‚ùå Docker is not installed. Please install Docker first.${NC}"
    exit 1
fi

# Stop and remove existing container if it exists
if docker ps -a | grep -q $CONTAINER_NAME; then
    echo -e "${YELLOW}üõë Stopping existing container...${NC}"
    docker stop $CONTAINER_NAME >/dev/null 2>&1 || true
    docker rm $CONTAINER_NAME >/dev/null 2>&1 || true
fi

#  Temporarily modify pyproject.toml to use /tmp/IATP for Docker build (if in development mode)
# Check for local IATP path
IATP_PATH=""
for possible_iatp in "../../../../IATP" "../../../IATP" "../../IATP"; do
    if [ -d "$possible_iatp" ] && [ -f "$possible_iatp/pyproject.toml" ]; then
        IATP_PATH="$possible_iatp"
        break
    fi
done

if [ -n "$IATP_PATH" ]; then
    echo -e "${BLUE}üì¶ Found local IATP at: $IATP_PATH${NC}"
    echo -e "${BLUE}üîß Preparing for local IATP build...${NC}"
    
    # Backup pyproject.toml
    cp pyproject.toml pyproject.toml.backup
    
    # Modify to use /tmp/IATP (Docker internal path)
    sed -i.tmp 's|"traia-iatp>=0\.1[^"]*"|"traia-iatp @ file:///tmp/IATP"|g' pyproject.toml
    rm -f pyproject.toml.tmp
    echo -e "${GREEN}‚úÖ pyproject.toml configured for local IATP build${NC}"
fi

# Build the Docker image
echo -e "${BLUE}üî® Building Docker image...${NC}"

# Check if pyproject.toml uses local IATP path (for local development)
if grep -q "file:///tmp/IATP" pyproject.toml 2>/dev/null; then
    # Extract IATP path from pyproject.toml
    IATP_PATH_FROM_TOML=$(grep "file://" pyproject.toml | sed -E 's|.*file://([^"]+).*|\1|' | head -1)
    
    # If path is /tmp/IATP (Docker path), find the actual local IATP path
    if [ "$IATP_PATH_FROM_TOML" = "/tmp/IATP" ] || [ ! -d "$IATP_PATH_FROM_TOML" ]; then
        # Try to find local IATP path (common locations)
        if [ -d "/Users/eitanlavi/workspace/traia/IATP" ]; then
            IATP_PATH="/Users/eitanlavi/workspace/traia/IATP"
        elif [ -d "$(dirname $(pwd))/IATP" ]; then
            IATP_PATH="$(dirname $(pwd))/IATP"
        elif [ -d "$HOME/workspace/traia/IATP" ]; then
            IATP_PATH="$HOME/workspace/traia/IATP"
        elif [ -n "$LOCAL_IATP_PATH" ] && [ -d "$LOCAL_IATP_PATH" ]; then
            IATP_PATH="$LOCAL_IATP_PATH"
        else
            IATP_PATH=""
        fi
    else
        IATP_PATH="$IATP_PATH_FROM_TOML"
    fi
    
    if [ -n "$IATP_PATH" ] && [ -d "$IATP_PATH" ]; then
        echo -e "${BLUE}üì¶ Using local IATP package: $IATP_PATH${NC}"
        # Copy IATP into build context for Docker (exclude .venv to save space!)
        mkdir -p .docker-iatp
        
        # Use rsync if available (much better), otherwise cp with find
        if command -v rsync &> /dev/null; then
            rsync -a --exclude='.venv' --exclude='__pycache__' --exclude='.git' --exclude='build' --exclude='dist' --exclude='*.egg-info' "$IATP_PATH/" .docker-iatp/IATP/
            echo -e "${BLUE}   Copied IATP to build context (excluded .venv, ${GREEN}saved ~900MB${BLUE})${NC}"
        else
            # Fallback: use cp but warn about size
            cp -r "$IATP_PATH" .docker-iatp/IATP
            echo -e "${YELLOW}   ‚ö†Ô∏è  rsync not found, copied full IATP (install rsync to save ~900MB)${NC}"
        fi
    else
        echo -e "${YELLOW}‚ö†Ô∏è  Local IATP path not found: $IATP_PATH_FROM_TOML${NC}"
        echo -e "${YELLOW}   Docker build will use published package${NC}"
    fi
fi

docker build -t $IMAGE_NAME .

# Cleanup .docker-iatp after build
rm -rf .docker-iatp

# Restore original pyproject.toml if we modified it
if [ -f pyproject.toml.backup ]; then
    mv pyproject.toml.backup pyproject.toml
    echo -e "${BLUE}üîÑ Restored original pyproject.toml${NC}"
fi

# Run the container
echo -e "${BLUE}üèÉ Starting container...${NC}"
docker run -d \
    --name $CONTAINER_NAME \
    -p $HOST_PORT:$CONTAINER_PORT \
    --env-file .env \
    -e DEBUG_PROTOCOL=${DEBUG_PROTOCOL:-false} \
    $IMAGE_NAME

# Wait for the server to start
echo -e "${YELLOW}‚è≥ Waiting for server to start...${NC}"
sleep 3

# Check if container is running
if ! docker ps | grep -q $CONTAINER_NAME; then
    echo -e "${RED}‚ùå Container failed to start. Checking logs:${NC}"
    docker logs $CONTAINER_NAME
    exit 1
fi

# Get container info
CONTAINER_ID=$(docker ps -q -f name=$CONTAINER_NAME)

# Output connection information
echo
echo -e "${GREEN}‚úÖ {{ agent_name }} is running!${NC}"
echo
echo -e "${BLUE}üìç Connection Information:${NC}"
echo -e "   A2A Endpoint:     ${GREEN}http://localhost:${HOST_PORT}/a2a${NC}"
echo -e "   Agent Info:       ${GREEN}http://localhost:${HOST_PORT}/.well-known/agent-card.json${NC}"
echo -e "   Container Name:   ${GREEN}${CONTAINER_NAME}${NC}"
echo -e "   Container ID:     ${GREEN}${CONTAINER_ID:0:12}${NC}"
echo
echo -e "${BLUE}üìù Useful commands:${NC}"
echo -e "   View logs:        ${YELLOW}docker logs -f ${CONTAINER_NAME}${NC}"
echo -e "   Stop server:      ${YELLOW}docker stop ${CONTAINER_NAME}${NC}"
echo -e "   Remove container: ${YELLOW}docker rm ${CONTAINER_NAME}${NC}"
echo -e "   Shell access:     ${YELLOW}docker exec -it ${CONTAINER_NAME} /bin/bash${NC}"
echo

# Check if the server is responding
echo -e "${YELLOW}üîç Checking server health...${NC}"
if curl -s -o /dev/null -w "%{http_code}" "http://localhost:${HOST_PORT}/.well-known/agent-card.json" | grep -q "200"; then
    echo -e "${GREEN}‚úÖ Server is healthy!${NC}"
    
    # Get and display agency info
    echo
    echo -e "${BLUE}üìã Agency Information:${NC}"
    curl -s "http://localhost:${HOST_PORT}/.well-known/agent-card.json" | python -m json.tool || echo "Could not fetch agency info"
else
    echo -e "${YELLOW}‚ö†Ô∏è  Server may still be starting up. Check logs with: docker logs -f ${CONTAINER_NAME}${NC}"
fi 