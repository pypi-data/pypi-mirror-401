name: Publish to test PyPI

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to release from"
        required: true
        default: "main"

jobs:
  pypi:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.branch }}

      - name: Fetch all tags
        run: git fetch --tags --force

      - name: Detect latest stable version
        run: |
          latest_tag=$(git tag --list --sort=-v:refname | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1)

          if [ -z "$latest_tag" ]; then
            echo "No stable tags found. Using fallback 0.1.0"
            base="0.1.0"
          else
            echo "Latest stable tag detected: $latest_tag"
            base="$latest_tag"
          fi

          echo "BASE_VERSION=$base" >> $GITHUB_ENV
          echo "Using base version: $base"

      - name: Upgrade packaging stack
        run: |
          python -m pip install --upgrade pip
          pip install --upgrade setuptools wheel setuptools_scm build twine pkginfo readme-renderer requests

      - name: Compute next dev version
        run: |
          python <<'EOF'
          import os, re, requests

          base = os.environ["BASE_VERSION"]
          pkg = "lexsi-sdk"

          url = f"https://test.pypi.org/pypi/{pkg}/json"

          try:
              data = requests.get(url, timeout=10).json()
              versions = data.get("releases", {}).keys()
          except Exception:
              print("No existing TestPyPI project found. Starting dev counter at 1.")
              versions = []

          pattern = re.compile(rf"^{re.escape(base)}\.dev(\d+)$")

          dev_nums = [
              int(m.group(1))
              for v in versions
              if (m := pattern.match(v))
          ]

          next_dev = max(dev_nums, default=0) + 1
          final_version = f"{base}.dev{next_dev}"

          print("Next dev version:", final_version)

          with open(os.environ["GITHUB_ENV"], "a") as f:
              f.write(f"SETUPTOOLS_SCM_PRETEND_VERSION={final_version}\n")

          EOF

      - name: Build package
        env:
          XAI_ENV: testing
        run: |
          rm -rf build dist *.egg-info
          python -m build
          twine check dist/*

      - name: Publish package to Test PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.TEST_PYPI_API_TOKEN }}
        run: |
          python -m twine upload --repository-url https://test.pypi.org/legacy/ dist/*
