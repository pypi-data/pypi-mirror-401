<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title }}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: white;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h1 {
      text-align: center;
      padding: 1rem;
      font-size: 1.5rem;
      color: #333;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    #map-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    svg {
      width: 100%;
      height: 100%;
    }
    .country {
      stroke: #fff;
      stroke-width: 0.5;
      cursor: pointer;
      transition: stroke 0.1s, stroke-width 0.1s;
    }
    .country:hover {
      stroke: #555;
      stroke-width: 1;
    }
    .tooltip {
      position: fixed;
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 14px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.15s;
      z-index: 1000;
      max-width: 200px;
    }
    .tooltip.visible {
      opacity: 1;
    }
    .tooltip-country {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .tooltip-count {
      color: #ccc;
    }
    .tooltip-authors {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-size: 12px;
    }
    .legend {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      padding: 12px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 12px;
    }
    .legend-title {
      font-weight: 600;
      margin-bottom: 8px;
    }
    .legend-scale {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-bar {
      width: 120px;
      height: 12px;
      border-radius: 2px;
    }
    .legend-list {
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 8px;
    }
    .legend-item {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      padding: 2px 0;
    }
    .legend-item-count {
      color: #666;
    }
    .toggle-container {
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 100;
    }
    .toggle {
      display: inline-flex;
      background: rgba(0,0,0,0.06);
      border-radius: 4px;
      padding: 2px;
    }
    .toggle-btn {
      padding: 4px 10px;
      border: none;
      background: transparent;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      color: #888;
      transition: all 0.15s;
    }
    .toggle-btn.active {
      background: white;
      color: #555;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .toggle-btn:hover:not(.active) {
      color: #555;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.2rem; padding: 0.75rem; }
      .legend { bottom: 10px; right: 10px; padding: 8px; font-size: 11px; }
      .legend-bar { width: 80px; }
      .toggle-container { top: 8px; right: 8px; }
      .toggle-btn { padding: 3px 8px; font-size: 10px; }
    }
  </style>
</head>
<body>
  {% if map_title %}<h1>{{ map_title }}</h1>{% endif %}
  {% if has_book_data %}
  <div class="toggle-container">
    <div class="toggle">
      <button class="toggle-btn{% if default_view == 'authors' %} active{% endif %}" data-mode="authors" title="Count unique authors per country">Authors</button>
      <button class="toggle-btn{% if default_view == 'books' %} active{% endif %}" data-mode="books" title="Count total books per country">Books</button>
    </div>
  </div>
  {% endif %}
  <div id="map-container"></div>
  <div class="tooltip" id="tooltip">
    <div class="tooltip-country"></div>
    <div class="tooltip-count"></div>
    <div class="tooltip-authors"></div>
  </div>
  {% if show_legend %}
  <div class="legend">
    <div class="legend-title" id="legend-title"></div>
    <div class="legend-scale">
      <span>1</span>
      <div class="legend-bar" id="legend-bar"></div>
      <span id="legend-max"></span>
    </div>
    {% if top_n %}<div class="legend-list" id="legend-list"></div>{% endif %}
  </div>
  {% endif %}
  <script>{{ d3_js | safe }}</script>
  <script>{{ topojson_js | safe }}</script>
  <script>
    const topoData = {{ topojson_data | safe }};
    const authorCounts = {{ author_counts | safe }};
    const bookCounts = {{ book_counts | safe }};
    const hasBookData = {{ has_book_data | tojson }};
    const colorScaleName = {{ color_scale | safe }};
    const authorsByCountry = {{ authors_by_country | tojson }};

    let currentMode = "{{ default_view }}";
    let currentCounts = currentMode === "books" ? bookCounts : authorCounts;
    let currentLabel = currentMode === "books" ? "book" : "author";

    const countryNameMap = {
      "United States": "United States of America",
      "Czech Republic": "Czechia",
      "Dominican Republic": "Dominican Rep.",
      "Ivory Coast": "CÃ´te d'Ivoire",
      "Central African Republic": "Central African Rep.",
      "Equatorial Guinea": "Eq. Guinea",
      "North Macedonia": "Macedonia",
      "Bosnia and Herzegovina": "Bosnia and Herz.",
      "Swaziland": "eSwatini",
      "South Sudan": "S. Sudan",
      "Congo": "Dem. Rep. Congo",
      "Trinidad and Tobago": "Trinidad and Tobago"
    };

    const topoToDisplayName = {};
    Object.entries(countryNameMap).forEach(([display, topo]) => {
      topoToDisplayName[topo] = display;
    });

    function getDataByTopoName(counts) {
      const data = {};
      Object.entries(counts).forEach(([name, count]) => {
        const topoName = countryNameMap[name] || name;
        data[topoName] = count;
      });
      return data;
    }

    let dataByTopoName = getDataByTopoName(currentCounts);
    let maxCount = Math.max(...Object.values(currentCounts), 1);

    const container = document.getElementById('map-container');
    const width = container.clientWidth;
    const height = container.clientHeight;

    const countries = topojson.feature(topoData, topoData.objects.countries);

    const svg = d3.select('#map-container')
      .append('svg')
      .attr('viewBox', `0 0 ${width} ${height}`)
      .attr('preserveAspectRatio', 'xMidYMid meet');

    const projection = d3.geoNaturalEarth1()
      .fitSize([width, height], countries);

    const path = d3.geoPath().projection(projection);

    let color = d3.scaleSequentialLog()
      .domain([1, maxCount])
      .interpolator(d3[colorScaleName] || d3.interpolateReds);

    svg.selectAll('.country')
      .data(countries.features)
      .enter()
      .append('path')
      .attr('class', 'country')
      .attr('d', path)
      .attr('fill', d => {
        const name = d.properties.name;
        const count = dataByTopoName[name] || 0;
        return count > 0 ? color(count) : '#e0e0e0';
      })
      .on('mouseover', showTooltip)
      .on('mousemove', moveTooltip)
      .on('mouseout', hideTooltip)
      .on('touchstart', showTooltip, { passive: true })
      .on('touchend', hideTooltip, { passive: true });

    const tooltip = document.getElementById('tooltip');
    const tooltipCountry = tooltip.querySelector('.tooltip-country');
    const tooltipCount = tooltip.querySelector('.tooltip-count');
    const tooltipAuthors = tooltip.querySelector('.tooltip-authors');

    function showTooltip(event, d) {
      const topoName = d.properties.name;
      const displayName = topoToDisplayName[topoName] || topoName;
      const count = dataByTopoName[topoName] || 0;

      tooltipCountry.textContent = displayName;
      tooltipCount.textContent = count > 0 ? `${count} ${currentLabel}${count !== 1 ? 's' : ''}` : `No ${currentLabel}s`;

      const authors = authorsByCountry[displayName] || [];
      tooltipAuthors.innerHTML = authors.map(a => `<div>${a}</div>`).join('');

      tooltip.classList.add('visible');
      moveTooltip(event);
    }

    function moveTooltip(event) {
      const e = event.touches ? event.touches[0] : event;
      const x = e.clientX;
      const y = e.clientY;

      const rect = tooltip.getBoundingClientRect();
      const left = Math.min(x + 10, window.innerWidth - rect.width - 10);
      const top = Math.min(y + 10, window.innerHeight - rect.height - 10);

      tooltip.style.left = left + 'px';
      tooltip.style.top = top + 'px';
    }

    function hideTooltip() {
      tooltip.classList.remove('visible');
    }

    function switchMode(mode) {
      if (mode === currentMode) return;
      currentMode = mode;
      currentCounts = mode === "books" ? bookCounts : authorCounts;
      currentLabel = mode === "books" ? "book" : "author";
      dataByTopoName = getDataByTopoName(currentCounts);
      maxCount = Math.max(...Object.values(currentCounts), 1);

      color = d3.scaleSequentialLog()
        .domain([1, maxCount])
        .interpolator(d3[colorScaleName] || d3.interpolateReds);

      svg.selectAll('.country')
        .transition()
        .duration(300)
        .attr('fill', d => {
          const name = d.properties.name;
          const count = dataByTopoName[name] || 0;
          return count > 0 ? color(count) : '#e0e0e0';
        });

      document.querySelectorAll('.toggle-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });

      {% if show_legend %}
      updateLegend();
      {% endif %}
    }

    {% if has_book_data %}
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      btn.addEventListener('click', () => switchMode(btn.dataset.mode));
    });
    {% endif %}

    {% if show_legend %}
    const legendTitle = document.getElementById('legend-title');
    const legendBar = document.getElementById('legend-bar');
    const legendMax = document.getElementById('legend-max');
    {% if top_n %}const legendList = document.getElementById('legend-list');{% endif %}

    function updateLegend() {
      legendTitle.textContent = currentLabel.charAt(0).toUpperCase() + currentLabel.slice(1) + 's';
      legendMax.textContent = maxCount;

      const gradientStops = [];
      for (let i = 0; i <= 10; i++) {
        gradientStops.push(color(Math.max(1, Math.pow(maxCount, i / 10))));
      }
      legendBar.style.background = `linear-gradient(to right, ${gradientStops.join(', ')})`;
      {% if top_n %}
      const topN = Object.entries(currentCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, {{ top_n }});
      legendList.innerHTML = topN.map(([country, count]) =>
        `<div class="legend-item"><span>${country}</span><span class="legend-item-count">${count}</span></div>`
      ).join('');
      {% endif %}
    }
    updateLegend();
    {% endif %}

    window.addEventListener('resize', () => {
      const newWidth = container.clientWidth;
      const newHeight = container.clientHeight;
      projection.fitSize([newWidth, newHeight], countries);
      svg.attr('viewBox', `0 0 ${newWidth} ${newHeight}`);
      svg.selectAll('.country').attr('d', path);
    });
  </script>
</body>
</html>
