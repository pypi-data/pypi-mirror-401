# Интеграция с агентами через MCP

obsidian-kb работает как MCP (Model Context Protocol) сервер, предоставляя агентам (Claude Desktop, Cursor и др.) доступ к семантическому поиску по вашим Obsidian vault'ам.

**Версия 0.2.6+** включает улучшения:
- **Схема базы данных v4** с нормализованной структурой (4 таблицы: documents, chunks, document_properties, metadata)
- Модель `nomic-embed-text` (768 измерений, контекст до 8000 токенов) для обработки длинных документов
- **Двухэтапные запросы** для эффективной фильтрации по свойствам документов
- Улучшенная нормализация запросов (стоп-слова, синонимы, автоматическое расширение)
- Группировка результатов по файлам с дедупликацией для лучшего UX
- Расширенные метрики качества поиска (пустые результаты, средняя релевантность)
- **Автоматическое создание FTS индекса** при поиске (версия 0.2.6+)

> **Важно:** После обновления до версии 0.2.0+ необходимо переиндексировать все vault'ы для использования схемы v4. См. раздел "Миграция на схему v4" ниже.

## Быстрая настройка

### 1. Установите obsidian-kb

См. [INSTALLATION.md](INSTALLATION.md)

### 2. Настройте Claude Desktop

```bash
# Применить конфигурацию автоматически
obsidian-kb claude-config --apply

# Перезапустите Claude Desktop
```

Команда автоматически:
- Определит путь к проекту
- Найдёт путь к `uv` или Python
- Создаст или обновит конфигурацию Claude Desktop
- Сохранит существующие MCP серверы (если есть)

### 3. Проверьте работу

После перезапуска Claude Desktop агент получит доступ к инструментам поиска. Попросите агента найти что-то в ваших заметках:

```
Найди информацию о Python async в моих заметках
```

## Ручная настройка

Если автоматическая настройка не работает, настройте вручную:

### Для установленного пакета

Добавьте в конфигурацию Claude Desktop (`~/Library/Application Support/Claude/claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "obsidian-kb": {
      "command": "/path/to/python",
      "args": [
        "-m",
        "obsidian_kb.mcp_server"
      ]
    }
  }
}
```

Найдите путь к Python:
```bash
which python3
# или
which python
```

### Для режима разработки

```json
{
  "mcpServers": {
    "obsidian-kb": {
      "command": "/path/to/uv",
      "args": [
        "run",
        "--project",
        "/path/to/obsidian-kb",
        "python",
        "-m",
        "obsidian_kb.mcp_server"
      ]
    }
  }
}
```

Найдите путь к uv:
```bash
which uv
```

## Доступные инструменты для агента

### Поиск

**`search_vault(vault_name, query, limit=10, search_type="hybrid")`**

Поиск в одном vault'е с поддержкой расширенных фильтров.

Примеры:
```
search_vault("my-vault", "Python async programming")
search_vault("my-vault", "Python tags:python async", limit=5)
search_vault("my-vault", "created:>2024-01-01 type:протокол")
```

**`search_multi_vault(vault_names, query, limit=10)`**

Поиск по нескольким vault'ам одновременно.

Примеры:
```
search_multi_vault(["vault1", "vault2"], "Python async")
search_multi_vault(["tech-notes", "projects"], "tags:python created:>2024-01-01")
```

### Управление vault'ами

**`list_vaults()`** — список всех проиндексированных vault'ов со статистикой

**`vault_stats(vault_name)`** — детальная статистика vault'а

**`index_vault(vault_name, vault_path)`** — инкрементальное индексирование (legacy)

**`reindex_vault(vault_name, vault_path=None)`** — полная переиндексация (legacy)

**`delete_vault(vault_name)`** — удалить vault из индекса

### Управление индексацией (Phase 4) ✨

**`index_documents(vault_name, paths=None, force=False, enrichment="contextual", background=True)`**

Индексация документов в vault с поддержкой различных стратегий обогащения.

- `paths`: Список путей для индексации (None = все изменённые)
- `force`: Принудительная переиндексация даже без изменений
- `enrichment`: Уровень обогащения (none, contextual, full)
- `background`: Запустить в фоне (True) или синхронно (False)

Примеры:
```
index_documents("my-vault")
index_documents("my-vault", paths=["file1.md", "file2.md"], force=True)
index_documents("my-vault", enrichment="full", background=False)
```

**`reindex_vault(vault_name, confirm=False, enrichment="contextual")`**

Полная переиндексация vault'а. ⚠️ Требует подтверждения (`confirm=True`).

Примеры:
```
reindex_vault("my-vault", confirm=True)
reindex_vault("my-vault", confirm=True, enrichment="full")
```

**`index_status(vault_name=None, job_id=None)`**

Статус индексации для vault'а или конкретной задачи.

Примеры:
```
index_status(vault_name="my-vault")  # Все активные задачи
index_status(job_id="job_123")  # Конкретная задача
```

**`preview_chunks(vault_name, file_path, strategy="auto")`**

Превью разбиения документа на чанки (без сохранения). Полезно для понимания как будет разбит документ.

- `strategy`: Стратегия chunking (auto, headers, semantic, fixed)

Примеры:
```
preview_chunks("my-vault", "file.md", strategy="auto")
preview_chunks("my-vault", "file.md", strategy="headers")
```

**`enrich_document(vault_name, file_path, enrichment_type="all")`**

Обогащение конкретного документа.

- `enrichment_type`: Тип обогащения (context, summary, all)

Примеры:
```
enrich_document("my-vault", "file.md", enrichment_type="context")
enrich_document("my-vault", "file.md", enrichment_type="summary")
enrich_document("my-vault", "file.md", enrichment_type="all")
```

### Управление конфигурацией

**`add_vault_to_config(vault_path, vault_name=None, auto_index=True)`**

Добавить vault в конфигурацию. Если `auto_index=True`, vault автоматически проиндексируется.

**`check_vault_in_config(vault_path=None, vault_name=None)`**

Проверить, есть ли vault в конфигурации.

**`list_configured_vaults()`**

Список всех настроенных vault'ов из конфигурации с их статусом.

### Диагностика

**`system_health()`** — полная диагностика системы

**`get_metrics(days=7, limit=10, vault_name=None)`** — расширенные метрики использования системы

Возвращает:
- Общее количество запросов и среднее время выполнения
- Распределение по типам поиска (vector, fts, hybrid, links)
- Популярные запросы и vault'ы
- **Количество и процент пустых результатов**
- **Средняя релевантность результатов**
- **Список запросов без результатов** (для анализа проблемных запросов)

## Особенности работы с агентами

### Нормализация запросов

obsidian-kb автоматически нормализует запросы для улучшения точности поиска:

1. **Удаление служебных слов агентов**: "найди", "find", "show me", "что написано про" и т.д.
2. **Приведение к lowercase**: для консистентности поиска
3. **Удаление стоп-слов**: убираются распространённые слова (русские и английские), которые не несут смысловой нагрузки
4. **Расширение синонимами**: автоматическое добавление синонимов для улучшения recall (например, "проблема" → "ошибка", "баг", "issue")

Примеры нормализации:
- `"Найди информацию про производительность"` → `"информация производительность"`
- `"проблема с системой"` → `"проблема система ошибка баг"`
- `"Python async programming"` → `"python async programming"`

### Кэширование

Система использует многоуровневое кэширование для ускорения работы:

1. **Кэш запросов агентов**: LRU кэш для результатов поиска (до 100 запросов)
2. **Кэш embeddings**: кэширование embeddings для популярных запросов
3. **Кэш embeddings файлов**: кэширование embeddings для неизменённых файлов при индексации

Это особенно полезно, когда агент делает несколько похожих запросов или при повторной индексации.

### Оптимизация для RAG

Результаты поиска оптимизированы для использования в RAG (Retrieval-Augmented Generation):

- **Топ-K результаты максимально релевантны**: используется re-ranking и feature-based ranking
- **Группировка по файлам**: результаты группируются по файлам, показывается лучший результат на файл с указанием количества совпадений
- **Дедупликация**: убираются дубликаты из одного файла, показывается разнообразие источников
- **Достаточно контекста**: результаты содержат превью контента (300 символов)
- **Удобный формат**: результаты в markdown формате, удобном для парсинга агентом

### Расширенные фильтры

Агент может использовать расширенные фильтры в запросах:

- **Теги**: `tags:python async`
- **Даты**: `created:>2024-01-01`, `modified:<2024-12-31`
- **Тип документа**: `type:протокол`
- **Связанные заметки**: `links:note-name`
- **Комбинации**: `Python tags:python created:>2024-01-01 type:guide`

> **Подробнее:** См. [ADVANCED_SEARCH.md](ADVANCED_SEARCH.md) и [USAGE.md](USAGE.md)

## Настройка оптимизации для агентов

Для лучшей работы с агентами рекомендуется включить оптимизацию поиска (включено по умолчанию):

```bash
export OBSIDIAN_KB_ENABLE_SEARCH_OPTIMIZER=true
export OBSIDIAN_KB_ENABLE_RERANK=true
export OBSIDIAN_KB_ENABLE_FEATURE_RANKING=true
export OBSIDIAN_KB_ADAPTIVE_ALPHA=true
```

**Новые возможности в версии 0.2.6+:**
- **Схема базы данных v4** с нормализованной структурой для лучшей производительности
- **Двухэтапные запросы** для эффективной фильтрации по свойствам документов (типы, произвольные свойства из frontmatter)
- Используется модель `nomic-embed-text` (768 измерений, контекст до 8000 токенов) для обработки длинных документов
- Улучшенная нормализация запросов с поддержкой стоп-слов и синонимов
- Группировка результатов по файлам для лучшего UX
- Расширенные метрики качества поиска
- **Автоматическое создание FTS индекса** при первом поиске

> **Подробнее:** См. [SEARCH_OPTIMIZATION.md](SEARCH_OPTIMIZATION.md)

## Отладка

### Проверка конфигурации

```bash
# Показать конфигурацию для Claude Desktop
obsidian-kb claude-config

# Показать в JSON формате
obsidian-kb claude-config --json
```

### Проверка работы MCP сервера

```bash
# Запустить MCP сервер вручную (для отладки)
obsidian-kb serve
```

### Проверка статуса системы

```bash
# Полная диагностика
obsidian-kb doctor

# Проверка конкретного компонента
obsidian-kb doctor --check ollama
```

## Решение проблем

Если агент не видит инструменты:

1. Проверьте конфигурацию Claude Desktop
2. Убедитесь, что MCP сервер запущен
3. Проверьте логи Claude Desktop
4. Запустите `obsidian-kb doctor` для диагностики

> **Подробнее:** См. [TROUBLESHOOTING.md](TROUBLESHOOTING.md)

## Примеры использования MCP инструментов

### Базовые сценарии поиска

#### 1. Простой поиск информации

**Запрос пользователя:**
```
Найди информацию о Python async в моих заметках
```

**Что делает агент:**
```python
search_vault("my-vault", "Python async")
```

**Результат:** Агент получает релевантные заметки о Python async, сгруппированные по файлам, и может использовать их для ответа.

**Формат результатов:**
- Результаты группируются по файлам (один результат на файл)
- Показывается количество совпадений в файле, если их несколько
- Отображаются все секции с совпадениями
- Превью контента (300 символов) для контекста

#### 2. Поиск с ограничением количества результатов

**Запрос пользователя:**
```
Покажи 5 лучших заметок про тестирование
```

**Что делает агент:**
```python
search_vault("my-vault", "тестирование", limit=5)
```

**Почему эффективно:** Ограничение `limit` ускоряет поиск и даёт только самые релевантные результаты.

#### 3. Поиск по нескольким vault'ам

**Запрос пользователя:**
```
Найди информацию о проекте X во всех моих vault'ах
```

**Что делает агент:**
```python
# Сначала получает список vault'ов
vaults = list_vaults()
# Затем ищет во всех
search_multi_vault(["work-notes", "personal", "projects"], "проект X")
```

**Почему эффективно:** Один запрос вместо нескольких, результаты объединяются и сортируются по релевантности.

### Расширенные фильтры для точного поиска

#### 4. Поиск по тегам

**Запрос пользователя:**
```
Покажи заметки с тегом #python про асинхронное программирование
```

**Что делает агент:**
```python
search_vault("my-vault", "асинхронное программирование tags:python")
```

**Почему эффективно:** Фильтр по тегам сужает область поиска, улучшая точность.

#### 5. Поиск по датам создания

**Запрос пользователя:**
```
Найди протоколы встреч за последний месяц
```

**Что делает агент:**
```python
from datetime import datetime, timedelta
last_month = (datetime.now() - timedelta(days=30)).strftime("%Y-%m-%d")
search_vault("my-vault", f"created:>{last_month} type:протокол")
```

**Почему эффективно:** Фильтр по датам исключает устаревшие документы.

#### 6. Поиск по датам модификации

**Запрос пользователя:**
```
Покажи заметки, которые я обновлял на этой неделе
```

**Что делает агент:**
```python
from datetime import datetime, timedelta
week_ago = (datetime.now() - timedelta(days=7)).strftime("%Y-%m-%d")
search_vault("my-vault", f"modified:>{week_ago}")
```

#### 7. Поиск по типу документа

**Запрос пользователя:**
```
Найди все договоры в моих заметках
```

**Что делает агент:**
```python
search_vault("my-vault", "type:договор")
```

**Примечание:** Тип документа определяется из frontmatter (`type: договор`).

#### 8. Поиск по связанным заметкам (wikilinks)

**Запрос пользователя:**
```
Найди заметки, связанные с проектом "Flask App"
```

**Что делает агент:**
```python
search_vault("my-vault", "links:Flask App")
```

**Почему эффективно:** Находит заметки, которые ссылаются на указанную заметку через `[[Flask App]]`.

#### 9. Комбинированные фильтры

**Запрос пользователя:**
```
Найди заметки про Python с тегом #async, созданные в 2024 году, связанные с проектом Flask
```

**Что делает агент:**
```python
search_vault(
    "my-vault", 
    "Python tags:async created:>2024-01-01 created:<2024-12-31 links:Flask"
)
```

**Почему эффективно:** Комбинация фильтров даёт очень точные результаты.

### Эффективные паттерны работы с агентами

#### 10. Многоэтапный поиск (уточнение запроса)

**Сценарий:** Агент сначала делает широкий поиск, затем уточняет.

**Шаг 1 - широкий поиск:**
```python
results = search_vault("my-vault", "Python", limit=20)
```

**Шаг 2 - уточнение по результатам:**
```python
# Агент анализирует результаты и делает более точный запрос
results = search_vault("my-vault", "Python async asyncio", limit=10)
```

**Почему эффективно:** Первый запрос даёт обзор, второй - точные результаты.

#### 11. Поиск с проверкой статистики

**Сценарий:** Агент сначала проверяет, что vault проиндексирован.

```python
# Проверка статистики
stats = vault_stats("my-vault")
# Если vault пустой, агент может предложить проиндексировать
if stats.chunk_count == 0:
    # Предложить индексацию
    pass
else:
    # Выполнить поиск
    results = search_vault("my-vault", "query")
```

#### 12. Использование метрик для оптимизации

**Сценарий:** Агент анализирует популярные запросы для понимания паттернов.

```python
# Получить метрики за последний месяц
metrics = get_metrics(days=30, limit=20)
# Агент может использовать эту информацию для улучшения запросов
```

### Работа с несколькими vault'ами

#### 13. Поиск в специфичных vault'ах

**Запрос пользователя:**
```
Найди информацию о проекте X в рабочих заметках и проектах
```

**Что делает агент:**
```python
search_multi_vault(["work-notes", "projects"], "проект X")
```

#### 14. Поиск с разными лимитами для разных vault'ов

**Сценарий:** Агент может делать отдельные запросы для разных vault'ов с разными лимитами.

```python
# Больше результатов из основного vault'а
results_main = search_vault("main-vault", "query", limit=20)
# Меньше из дополнительных
results_other = search_vault("other-vault", "query", limit=5)
```

### Управление индексацией через агента

#### 15. Автоматическое добавление vault'а

**Запрос пользователя:**
```
Добавь текущую директорию в obsidian-kb и проиндексируй
```

**Что делает агент:**
```python
# Определяет текущую директорию (зависит от контекста)
current_path = "/path/to/current/directory"
add_vault_to_config(current_path, auto_index=True)
```

#### 16. Проверка статуса индексации

**Запрос пользователя:**
```
Проверь, проиндексирован ли мой vault "work-notes"
```

**Что делает агент:**
```python
# Проверка через список vault'ов
vaults = list_vaults()
# Или через статистику
try:
    stats = vault_stats("work-notes")
    # Vault проиндексирован
except:
    # Vault не найден
    pass
```

### Диагностика и мониторинг

#### 17. Проверка здоровья системы

**Запрос пользователя:**
```
Проверь, всё ли работает с obsidian-kb
```

**Что делает агент:**
```python
health = system_health()
# Агент анализирует результаты и сообщает о проблемах
```

#### 18. Анализ использования

**Запрос пользователя:**
```
Какие запросы я делал чаще всего?
```

**Что делает агент:**
```python
metrics = get_metrics(days=30, limit=20)
# Агент показывает популярные запросы из metrics.popular_queries
```

### Оптимизация для RAG (Retrieval-Augmented Generation)

#### 19. Получение контекста для ответа

**Сценарий:** Агент ищет информацию для генерации ответа.

```python
# Широкий поиск для контекста
context_results = search_vault("my-vault", "Python async", limit=10)
# Агент использует результаты для генерации ответа с контекстом
```

**Почему эффективно:** Результаты содержат достаточно контекста для понимания.

#### 20. Многоэтапный поиск для сложных вопросов

**Сценарий:** Агент разбивает сложный вопрос на подзапросы.

```python
# Вопрос: "Как использовать async в Python и Flask?"
# Агент делает два запроса:
python_async = search_vault("my-vault", "Python async", limit=5)
flask_async = search_vault("my-vault", "Flask async", limit=5)
# Затем синтезирует ответ из обоих результатов
```

### Советы по эффективности

1. **Используйте фильтры** — они значительно улучшают точность поиска
2. **Ограничивайте количество результатов** — `limit=5-10` обычно достаточно
3. **Проверяйте статистику** — перед поиском убедитесь, что vault проиндексирован
4. **Используйте multi-vault поиск** — когда нужно искать в нескольких vault'ах
5. **Комбинируйте фильтры** — для максимальной точности
6. **Делайте уточняющие запросы** — если первый запрос дал слишком много результатов

## Миграция на схему v4

**Версия 0.2.0+** использует новую схему базы данных v4 с нормализованной структурой. После обновления необходимо переиндексировать все vault'ы:

```bash
# Переиндексация одного vault'а
obsidian-kb reindex --vault "my-vault" --force

# Переиндексация всех vault'ов
obsidian-kb index-all
```

**Что изменилось:**
- Старая схема v3 (одна таблица) заменена на нормализованную схему v4 (4 таблицы)
- Типы документов теперь хранятся в таблице `document_properties` вместо денормализованных полей
- Поиск по типам документов использует двухэтапный запрос для лучшей производительности
- FTS индекс создается автоматически при первом поиске

**Преимущества v4:**
- Лучшая производительность при фильтрации по свойствам документов
- Масштабируемость для больших vault'ов
- Поддержка произвольных свойств из frontmatter без изменения схемы
- Эффективные индексы на свойствах документов

> **Подробнее:** См. [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md) и [V4_ARCHITECTURE_CHANGES.md](V4_ARCHITECTURE_CHANGES.md)

## Следующие шаги

- **Рекомендации по эффективной работе:** [BEST_PRACTICES.md](BEST_PRACTICES.md)
- **Часто задаваемые вопросы:** [FAQ.md](FAQ.md)
- **Оптимизация поиска:** [SEARCH_OPTIMIZATION.md](SEARCH_OPTIMIZATION.md)
- **Расширенный поиск:** [ADVANCED_SEARCH.md](ADVANCED_SEARCH.md)
- **Решение проблем:** [TROUBLESHOOTING.md](TROUBLESHOOTING.md)
- **Схема базы данных v4:** [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md)

