# File Organization Rules

This project has a clear separation between **generated code** (read-only) and
**editable code** (can be modified). Understanding this distinction is critical to avoid
breaking the codebase.

## Quick Reference

| Category          | Action            | Files                                                |
| ----------------- | ----------------- | ---------------------------------------------------- |
| âœ… **Editable**   | Can modify freely | Custom client, tests, scripts, docs, config          |
| ğŸš« **Generated**  | **DO NOT EDIT**   | API endpoints, models, base client, type definitions |
| ğŸ”„ **Regenerate** | Use script        | `uv run poe regenerate-client` (2+ minutes)          |

______________________________________________________________________

## Generated Files (DO NOT EDIT)

These files are automatically generated from the OpenAPI specification
(`docs/katana-openapi.yaml`). **Any manual edits will be overwritten** during
regeneration.

### Generated API Endpoint Modules

```
katana_public_api_client/api/**/*.py
```

**76+ endpoint modules** organized by resource:

- `product/` - Product, variant, and material endpoints
- `sales_order/` - Sales order management
- `purchase_order/` - Purchase order management
- `manufacturing_order/` - Manufacturing operations
- `stock_adjustment/` - Inventory adjustments
- `customer/`, `supplier/` - Business relations
- `location/`, `webhook/` - Configuration
- And many more...

**Example:**

```python
# DO NOT EDIT THIS FILE
# katana_public_api_client/api/product/get_all_products.py

from typing import Any, Dict, Optional, Union
# ... generated code ...
```

### Generated Data Models

```
katana_public_api_client/models/**/*.py
```

**150+ fully-typed data models** for:

- Request parameters
- Response bodies
- Nested objects
- Enum types
- Error responses

**Example:**

```python
# DO NOT EDIT THIS FILE
# katana_public_api_client/models/product.py

from typing import Optional
from attrs import define
# ... generated code ...
```

### Generated Base Client

```
katana_public_api_client/client.py
```

Contains:

- `Client` - Unauthenticated base client
- `AuthenticatedClient` - Base client with authentication

**Do not modify** - Use `KatanaClient` instead (see Editable Files section).

### Generated Type Definitions

```
katana_public_api_client/client_types.py
```

Type definitions for:

- `Response[T]` - Generic response wrapper
- `UNSET` - Sentinel for optional parameters
- `Unset` - Type for sentinel
- `File` - File upload type

**Note:** Renamed from `types.py` to avoid conflicts with Python's `types` module.

### Generated Error Classes

```
katana_public_api_client/errors.py
```

Exception types:

- `UnexpectedStatus` - HTTP error responses
- Base error classes

### Generated Marker File

```
katana_public_api_client/py.typed
```

PEP 561 type marker for mypy compatibility.

______________________________________________________________________

## Editable Files (Can Modify)

These files are **not generated** and can be edited freely.

### Custom Client Implementation

```
katana_public_api_client/katana_client.py
```

**The enhanced client with transport-layer resilience:**

- `KatanaClient` - Wrapper around `AuthenticatedClient`
- `ResilientAsyncTransport` - Custom httpx transport with:
  - Automatic retries (429, 502, 503, 504)
  - Rate limiting with exponential backoff
  - Transparent pagination
  - Retry-After header support

**This is the main entry point** - use this instead of the generated base client.

### Logging Configuration

```
katana_public_api_client/log_setup.py
```

Centralized logging setup for the package.

### Tests

```
tests/**/*.py
```

All test files:

- `tests/unit/` - Fast unit tests
- `tests/integration/` - API integration tests
- `tests/test_*.py` - Test modules

**Add tests freely** for new features or bug fixes.

### Scripts

```
scripts/**/*.py
```

Development automation scripts:

- `scripts/regenerate_client.py` - Client regeneration
- Other utility scripts

### Documentation

```
docs/**/*.md
```

Project documentation:

- User guides
- Architecture Decision Records (ADRs)
- API documentation
- Contributing guidelines

### Configuration Files

```
pyproject.toml           # Package metadata, dependencies, tool config
uv.lock                  # Dependency lockfile
.env                     # Environment variables (not in git)
.env.example             # Environment template
.pre-commit-config*.yaml # Pre-commit hooks
.github/**               # GitHub workflows, Copilot agents
```

______________________________________________________________________

## Package Structure

```
katana-openapi-client/                    # Monorepo root
â”œâ”€â”€ pyproject.toml                        # âœ… EDITABLE - Package metadata
â”œâ”€â”€ uv.lock                               # âœ… EDITABLE - Dependency lock
â”œâ”€â”€ .env.example                          # âœ… EDITABLE - Environment template
â”œâ”€â”€ README.md                             # âœ… EDITABLE - Project overview
â”œâ”€â”€ CLAUDE.md                             # âœ… EDITABLE - AI agent instructions
â”‚
â”œâ”€â”€ katana_public_api_client/             # Client package
â”‚   â”œâ”€â”€ __init__.py                       # ğŸš« GENERATED - Package exports
â”‚   â”œâ”€â”€ katana_client.py                  # âœ… EDITABLE - Custom client
â”‚   â”œâ”€â”€ log_setup.py                      # âœ… EDITABLE - Logging config
â”‚   â”œâ”€â”€ client.py                         # ğŸš« GENERATED - Base client
â”‚   â”œâ”€â”€ client_types.py                   # ğŸš« GENERATED - Type definitions
â”‚   â”œâ”€â”€ errors.py                         # ğŸš« GENERATED - Error classes
â”‚   â”œâ”€â”€ py.typed                          # ğŸš« GENERATED - Type marker
â”‚   â”œâ”€â”€ api/                              # ğŸš« GENERATED - All endpoints
â”‚   â”‚   â”œâ”€â”€ product/
â”‚   â”‚   â”œâ”€â”€ sales_order/
â”‚   â”‚   â”œâ”€â”€ purchase_order/
â”‚   â”‚   â””â”€â”€ ... (76+ endpoint modules)
â”‚   â””â”€â”€ models/                           # ğŸš« GENERATED - All models
â”‚       â”œâ”€â”€ product.py
â”‚       â”œâ”€â”€ sales_order.py
â”‚       â””â”€â”€ ... (150+ model files)
â”‚
â”œâ”€â”€ tests/                                # âœ… EDITABLE - All tests
â”‚   â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ integration/
â”‚   â””â”€â”€ conftest.py
â”‚
â”œâ”€â”€ scripts/                              # âœ… EDITABLE - Dev scripts
â”‚   â””â”€â”€ regenerate_client.py
â”‚
â”œâ”€â”€ docs/                                 # âœ… EDITABLE - Documentation
â”‚   â”œâ”€â”€ katana-openapi.yaml               # âœ… EDITABLE - OpenAPI spec
â”‚   â”œâ”€â”€ adr/                              # Architecture decisions
â”‚   â””â”€â”€ *.md                              # User guides
â”‚
â”œâ”€â”€ katana_mcp_server/                    # âœ… EDITABLE - MCP server package
â”‚   â””â”€â”€ ... (separate package)
â”‚
â””â”€â”€ .github/                              # âœ… EDITABLE - GitHub config
    â”œâ”€â”€ workflows/                        # CI/CD workflows
    â””â”€â”€ copilot/                          # Copilot agent definitions
```

______________________________________________________________________

## Client Regeneration Process

When you need to regenerate the client (e.g., after OpenAPI spec changes):

### 1. Validate OpenAPI Spec

```bash
uv run poe validate-openapi
```

Validates `docs/katana-openapi.yaml` with:

- openapi-spec-validator
- Redocly CLI

### 2. Regenerate Client

```bash
uv run poe regenerate-client  # Takes 2+ minutes, NEVER CANCEL
```

**What it does:**

1. Validates OpenAPI spec
1. Generates client using `openapi-python-client` (npx)
1. Auto-fixes code with `ruff check --fix --unsafe-fixes` (6,589+ fixes)
1. Moves generated code to `katana_public_api_client/`
1. Runs final tests and formatting

**Key points:**

- Takes 2+ minutes - set timeout to 60+ minutes
- Auto-fixes 6,589+ lint issues automatically
- No manual patches needed
- Preserves editable files (`katana_client.py`, `log_setup.py`)

### 3. Verify Regeneration

```bash
uv run poe test          # Run tests
uv run poe check         # Full validation
```

______________________________________________________________________

## Import Path Conventions

### âœ… Correct Imports

**For generated API endpoints:**

```python
# Import from flattened structure (no .generated)
from katana_public_api_client.api.product import get_all_products
from katana_public_api_client.api.sales_order import create_sales_order
```

**For generated models:**

```python
from katana_public_api_client.models import Product, SalesOrder
```

**For client types:**

```python
# Use client_types NOT types (avoid stdlib conflict)
from katana_public_api_client.client_types import Response, UNSET
```

**For custom client:**

```python
from katana_public_api_client import KatanaClient
```

### âŒ Incorrect Imports

```python
# DON'T - .generated subdirectory doesn't exist
from katana_public_api_client.generated.api.product import get_all_products

# DON'T - Use client_types instead
from katana_public_api_client.types import Response

# DON'T - Use KatanaClient instead
from katana_public_api_client.client import AuthenticatedClient
```

______________________________________________________________________

## Common Pitfalls

### 1. Editing Generated Files âŒ

**Problem:**

```python
# Editing katana_public_api_client/api/product/get_all_products.py
def get_all_products(client, limit=100):  # Manual change
    # ... modified code ...
```

**Solution:** Extend functionality in `katana_client.py` or create wrapper functions in
editable files.

### 2. Forgetting Regeneration Overwrites âŒ

**Problem:**

- Make manual edits to generated files
- Run `uv run poe regenerate-client`
- **All changes lost!**

**Solution:** Never edit generated files. If you need changes, either:

1. Update the OpenAPI spec (`docs/katana-openapi.yaml`)
1. Add custom logic in `katana_client.py`
1. Create helper functions in editable files

### 3. Using Wrong Import Paths âŒ

**Problem:**

```python
from katana_public_api_client.types import Response  # Conflicts with stdlib
```

**Solution:**

```python
from katana_public_api_client.client_types import Response  # Correct
```

### 4. Modifying Dependencies Without Regeneration âŒ

**Problem:**

- Update `openapi-python-client` version
- Don't regenerate client
- Generated code incompatible

**Solution:** Always regenerate client after updating code generation dependencies.

______________________________________________________________________

## Architecture: Transport-Layer Resilience

### Key Pattern

Instead of wrapping 76+ API methods individually, resilience is implemented at the
**httpx transport layer**:

```python
# This gives ALL API calls:
# - Automatic retries (429, 502, 503, 504)
# - Rate limiting with exponential backoff
# - Transparent pagination
# - Retry-After header support

async with KatanaClient() as client:
    # All these automatically get resilience:
    await get_all_products.asyncio_detailed(client=client)
    await create_sales_order.asyncio_detailed(client=client)
    await get_stock_level.asyncio_detailed(client=client)
```

**Why this matters for file organization:**

- Generated API files remain untouched
- Custom behavior in `katana_client.py` only
- Clean separation of concerns
- Easy to regenerate without losing features

See
[ADR-001: Transport-Layer Resilience](../../../docs/adr/0001-transport-layer-resilience.md)
for details.

______________________________________________________________________

## Summary

**Remember:**

- ğŸš« **NEVER edit** `api/**/*.py` or `models/**/*.py`
- âœ… **Always use** `katana_client.py` for custom client logic
- ğŸ”„ **Regenerate with** `uv run poe regenerate-client` (2+ min)
- ğŸ“¦ **Import from** `client_types` not `types`
- ğŸ¯ **Use** `KatanaClient` not base `AuthenticatedClient`

When in doubt, check if a file is in the "DO NOT EDIT" list above!
