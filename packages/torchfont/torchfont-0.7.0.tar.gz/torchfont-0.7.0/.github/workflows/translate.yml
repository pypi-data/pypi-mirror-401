name: Translate

on:
  push:
    branches:
      - "main"
    paths:
      - "docs/source/**/*.rst"
      - "torchfont/**"
      - "CONTRIBUTING.rst"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  translate:
    runs-on: "ubuntu-latest"

    env:
      OPENAI_API_KEY: "${{ secrets.OPENAI_API_KEY }}"
      GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
      LANGUAGES: "ja"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v6

      - name: Sync dependencies (docs group)
        run: uv sync --group docs

      - name: Build gettext catalogs (.pot)
        run: uv run sphinx-build -b gettext docs/source docs/build/gettext

      - name: Prepare translation branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B codex-translation-update origin/main

      - name: Merge gettext into .po files
        run: uv run sphinx-intl update -p docs/build/gettext -d docs/locale -l "$LANGUAGES"

      - name: Translate with Codex
        id: codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: "${{ secrets.OPENAI_API_KEY }}"
          prompt: |
            You are a professional translator for Sphinx documentation in the gettext (.po) format.
            Your task is to translate the `msgid` entries that have empty `msgstr` ("") in the provided .po files.
            Preserve Sphinx roles (e.g. :ref:, :class:, etc.), inline code marked with double backticks, and variable placeholders.
            Return only the updated content for the `msgstr` entries.
            Directory to process: docs/locale/${{ env.LANGUAGES }}/LC_MESSAGES

      - name: Commit translation updates and create or update PR
        run: |
          git add docs/locale/**/*.po
          if git diff --cached --quiet; then
            echo "No translation updates detected after Codex. Skipping commit and PR creation."
            exit 0
          fi

          git commit -m "Update translations via Codex" -m "Co-authored-by: Codex <codex-bot@users.noreply.github.com>"
          git push -f origin codex-translation-update

          pr_number=$(gh pr list --head codex-translation-update --base main --json number --jq '.[0].number')
          if [ -n "$pr_number" ]; then
            echo "PR #$pr_number already exists. Skipping creation."
            exit 0
          fi

          gh pr create \
            --base main \
            --head codex-translation-update \
            --title "Update translations via Codex" \
            --body "This PR updates gettext translation files automatically using Codex Actions."
