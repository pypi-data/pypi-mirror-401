# Product Roadmap ADRI Standard with Divergence Metadata
# 
# This example demonstrates best practices for using divergence metadata
# to enable intelligent workflow replay validation.

contracts:
  id: product-roadmap-divergence-v1
  name: Product Roadmap Standard with Divergence Metadata
  version: 1.0.0
  description: |
    Product roadmap standard demonstrating divergence metadata usage.
    Shows how to distinguish deterministic fields from AI-generated fields.
  author: Data Platform Team
  created: "2025-01-10"
  tags:
    - product-management
    - roadmap
    - divergence-metadata
    - workflow-validation

requirements:
  dimension_requirements:
    validity:
      weight: 5
      minimum_score: 85
      field_requirements:
        # ========================================
        # USER INPUT FIELDS
        # No divergence metadata needed - these are data entry fields
        # ========================================
        
        ITEM_ID:
          type: string
          nullable: false
          description: Unique identifier for roadmap item
          pattern: "^ITEM-[0-9]{6}$"
        
        TITLE:
          type: string
          nullable: false
          description: Item title
          min_length: 5
          max_length: 200
        
        DESCRIPTION:
          type: string
          nullable: false
          description: Detailed description of the roadmap item
          min_length: 20
          max_length: 2000
        
        OWNER_NAME:
          type: string
          nullable: false
          description: Name of the item owner
          min_length: 2
          max_length: 100
        
        TARGET_DATE:
          type: date
          nullable: false
          description: Target completion date
        
        # ========================================
        # DETERMINISTIC FIELDS
        # These use lookup tables or explicit rules
        # Marked with deterministic=true for strict checking
        # ========================================
        
        HEALTH_SCORE:
          type: integer
          nullable: false
          deterministic: true
          description: |
            Overall health score (1-5 scale).
            Calculated from lookup table based on multiple factors.
            Should be identical across replays with same inputs.
            Strict divergence checking applies (0-5% threshold).
          min_value: 1
          max_value: 5
        
        RISK_LEVEL:
          type: string
          nullable: false
          deterministic: true
          description: |
            Risk assessment level derived from conditional business rules.
            Calculation is deterministic based on health score and other factors.
            Expected to be identical in replay scenarios.
        
        STATUS_CODE:
          type: string
          nullable: false
          deterministic: true
          description: |
            Status code derived from explicit rules.
            Maps current state to standard status code.
        
        PRIORITY_SCORE:
          type: integer
          nullable: false
          deterministic: true
          description: |
            Calculated priority score using weighted formula:
            (business_value * 0.4) + (urgency * 0.3) + (effort * 0.3)
            Deterministic calculation, should match exactly in replays.
          min_value: 0
          max_value: 100
        
        DAYS_SINCE_LAST_UPDATE:
          type: integer
          nullable: false
          deterministic: true
          description: |
            Calculated as current_date - last_update_date.
            Deterministic for a given snapshot date.
          min_value: 0
        
        # ========================================
        # AI-GENERATED FIELDS
        # These are produced by LLMs and vary naturally
        # Marked with ai_generated=true to skip/relax checking
        # ========================================
        
        AI_STATUS_SUMMARY:
          type: string
          nullable: false
          ai_generated: true
          deterministic: false
          description: |
            AI-generated executive summary of current status.
            Generated by GPT-4 with temperature > 0.
            Expected to vary between runs - this is acceptable.
            Divergence checking should be skipped for this field.
          min_length: 50
          max_length: 500
        
        AI_RISK_RATIONALE:
          type: string
          nullable: true
          ai_generated: true
          deterministic: false
          description: |
            AI-generated explanation of risk factors.
            LLM analyzes multiple signals and provides reasoning.
            Non-deterministic output is expected and acceptable.
          min_length: 30
          max_length: 1000
        
        AI_RECOMMENDED_ACTIONS:
          type: string
          nullable: true
          ai_generated: true
          deterministic: false
          description: |
            AI-generated list of recommended next steps.
            Based on LLM analysis of current state and blockers.
            Natural variation expected due to model sampling.
          min_length: 50
          max_length: 800
        
        AI_STAKEHOLDER_SUMMARY:
          type: string
          nullable: true
          ai_generated: true
          deterministic: false
          description: |
            AI-generated summary for stakeholder communication.
            Tailored messaging based on GPT-4 analysis.
            Variation is expected and does not indicate issues.
          max_length: 300
        
        # ========================================
        # MIXED DETERMINISTIC/NON-DETERMINISTIC
        # Some fields may have both aspects
        # ========================================
        
        FORECAST_COMPLETION_DATE:
          type: date
          nullable: true
          deterministic: false
          description: |
            Forecasted completion date using ML model.
            Model has inherent uncertainty, not fully deterministic.
            Uses relaxed divergence threshold (15-20%).
        
        CONFIDENCE_SCORE:
          type: float
          nullable: true
          deterministic: false
          description: |
            Confidence score for forecast (0.0 to 1.0).
            Based on statistical model with some randomness.
          min_value: 0.0
          max_value: 1.0
    
    completeness:
      weight: 4
      minimum_score: 90
      field_requirements:
        # All completeness checks for required fields
        ITEM_ID:
          nullable: false
        TITLE:
          nullable: false
        HEALTH_SCORE:
          nullable: false
        AI_STATUS_SUMMARY:
          nullable: false
          ai_generated: true
          deterministic: false
    
    consistency:
      weight: 3
      minimum_score: 95
      field_requirements:
        # Ensure status code consistency
        STATUS_CODE:
          nullable: false
          deterministic: true
    
    freshness:
      weight: 2
      minimum_score: 80
      field_requirements:
        DAYS_SINCE_LAST_UPDATE:
          # Freshness tracking field
          nullable: false
          deterministic: true

  overall_minimum: 85

# Metadata for workflow integration
metadata:
  divergence_policy:
    description: |
      This standard uses divergence metadata to enable intelligent replay validation.
      
      Deterministic fields (health_score, risk_level, priority_score, etc.):
        - Use strict divergence threshold (<5%)
        - Variations indicate potential bugs
        - Should be investigated immediately
      
      AI-generated fields (ai_status_summary, ai_risk_rationale, etc.):
        - Skip divergence checking OR use very relaxed threshold (>20%)
        - Variations are expected and acceptable
        - Focus on semantic similarity, not exact match
      
      Unspecified fields:
        - Use moderate threshold (~10%)
        - Standard workflow validation applies
  
  workflow_compatibility:
    - workflow-runner
    - airflow-adri-plugin
    - prefect-adri-integration
  
  version_history:
    - version: 1.0.0
      date: "2025-01-10"
      changes: "Initial version with divergence metadata"
      author: "Data Platform Team"
