---
description: {{ step_description }}
{% if hooks %}
hooks:
{% for event_name, event_hooks in hooks.items() %}
  {{ event_name }}:
    - hooks:
{% for hook in event_hooks %}
{% if hook.type == "script" %}
        - type: command
          command: ".deepwork/jobs/{{ job_name }}/{{ hook.path }}"
{% else %}
        - type: prompt
          prompt: |
{% if event_name == "Stop" %}
            You must evaluate whether Claude has met all the below quality criteria for the request.

            ## Quality Criteria

            {{ hook.content | indent(12) }}

            ## Instructions

            Review the conversation and determine if ALL quality criteria above have been satisfied.
            Look for evidence that each criterion has been addressed.

            If the agent has included `<promise>✓ Quality Criteria Met</promise>` in their response AND
            all criteria appear to be met, respond with: {"ok": true}

            If criteria are NOT met AND the promise tag is missing, respond with:
            {"ok": false, "reason": "Continue working. [specific feedback on what's wrong]"}
{% else %}
            {{ hook.content | indent(12) }}
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}
---

# {{ job_name }}.{{ step_id }}

{% if is_standalone %}
**Standalone command** in the **{{ job_name }}** job - can be run anytime
{% else %}
**Step {{ step_number }} of {{ total_steps }}** in the **{{ job_name }}** workflow
{% endif %}

**Summary**: {{ job_summary }}

{% if job_description %}
## Job Overview

{{ job_description }}
{% endif %}

{% if dependencies %}
## Prerequisites

This step requires completion of the following step(s):
{% for dep in dependencies %}
- `/{{ job_name }}.{{ dep }}`
{% endfor %}

Please ensure these steps have been completed before proceeding.
{% endif %}

## Instructions

{{ instructions_content }}

{% if user_inputs or file_inputs %}
## Inputs

{% if user_inputs %}
### User Parameters

Please gather the following information from the user:
{% for input in user_inputs %}
- **{{ input.name }}**: {{ input.description }}
{% endfor %}
{% endif %}

{% if file_inputs %}
### Required Files

This step requires the following files from previous steps:
{% for input in file_inputs %}
- `{{ input.file }}` (from step `{{ input.from_step }}`)
{% endfor %}

Make sure to read and use these files as context for this step.
{% endif %}
{% endif %}

## Work Branch Management

All work for this job should be done on a dedicated work branch:

1. **Check current branch**:
   - If already on a work branch for this job (format: `deepwork/{{ job_name }}-[instance]-[date]`), continue using it
   - If on main/master, create a new work branch

2. **Create work branch** (if needed):
   ```bash
   git checkout -b deepwork/{{ job_name }}-[instance]-$(date +%Y%m%d)
   ```
   Replace `[instance]` with a descriptive identifier (e.g., `acme`, `q1-launch`, etc.)

## Output Requirements

{% if outputs %}
Create the following output(s):
{% for output in outputs %}
- `{{ output }}`{% if output.endswith('/') %} (directory){% endif %}
{% endfor %}

Ensure all outputs are:
- Well-formatted and complete
- Ready for review or use by subsequent steps
{% else %}
No specific files are output by this command.
{% endif %}

{% if stop_hooks %}
## Quality Validation Loop

This step uses an iterative quality validation loop. After completing your work, stop hook(s) will evaluate whether the outputs meet quality criteria. If criteria are not met, you will be prompted to continue refining.

{% for hook in stop_hooks %}
{% if hook.type == "script" %}
**Validation Script**: `.deepwork/jobs/{{ job_name }}/{{ hook.path }}`

The validation script will be executed automatically when you attempt to complete this step.
{% else %}
### Quality Criteria{% if stop_hooks | length > 1 %} ({{ loop.index }}){% endif %}

{{ hook.content }}
{% endif %}
{% endfor %}

### Completion Promise

To signal that all quality criteria have been met, include this tag in your final response:

```
<promise>✓ Quality Criteria Met</promise>
```

**Important**: Only include this promise tag when you have verified that ALL quality criteria above are satisfied. The validation loop will continue until this promise is detected.

{% endif %}
## Completion

After completing this step:

1. **Verify outputs**: Confirm all required files have been created

2. **Inform the user**:
{% if is_standalone %}
   - The {{ step_id }} command is complete
{% if outputs %}
   - Outputs created: {{ outputs | join(', ') }}
{% endif %}
   - This command can be run again anytime to make further changes
{% else %}
   - Step {{ step_number }} of {{ total_steps }} is complete
{% if outputs %}
   - Outputs created: {{ outputs | join(', ') }}
{% endif %}
   {% if next_step %}
   - Ready to proceed to next step: `/{{ job_name }}.{{ next_step }}`
   {% else %}
   - This is the final step - the job is complete!
   {% endif %}
{% endif %}

{% if is_standalone %}
## Command Complete

This is a standalone command that can be run anytime. The outputs are ready for use.

Consider:
- Reviewing the outputs
- Running `deepwork sync` if job definitions were changed
- Re-running this command later if further changes are needed
{% elif next_step %}
## Next Step

To continue the workflow, run:
```
/{{ job_name }}.{{ next_step }}
```
{% else %}
## Workflow Complete

This is the final step in the {{ job_name }} workflow. All outputs should now be complete and ready for review.

Consider:
- Reviewing all work products
- Creating a pull request to merge the work branch
- Documenting any insights or learnings
{% endif %}

---

## Context Files

- Job definition: `.deepwork/jobs/{{ job_name }}/job.yml`
- Step instructions: `.deepwork/jobs/{{ job_name }}/{{ instructions_file }}`
