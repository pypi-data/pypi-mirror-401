# Apache static site configuration for {{ domain }}
# Generated by WASM

<VirtualHost *:80>
    ServerName {{ domain }}
    ServerAdmin webmaster@{{ domain }}

{% if ssl %}
    # Redirect HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName {{ domain }}
    ServerAdmin webmaster@{{ domain }}

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ ssl_certificate | default('/etc/letsencrypt/live/' + domain + '/fullchain.pem') }}
    SSLCertificateKeyFile {{ ssl_certificate_key | default('/etc/letsencrypt/live/' + domain + '/privkey.pem') }}
    
    # SSL Settings
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

{% endif %}
    # Document root
    DocumentRoot {{ static_dir | default(app_path) }}

    # Logging
    ErrorLog ${APACHE_LOG_DIR}/{{ domain }}.error.log
    CustomLog ${APACHE_LOG_DIR}/{{ domain }}.access.log combined

    # Directory options
    <Directory {{ static_dir | default(app_path) }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
        
        # SPA support - rewrite to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"

    # Cache static assets
    <FilesMatch "\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
    </FilesMatch>

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml
    </IfModule>
</VirtualHost>
