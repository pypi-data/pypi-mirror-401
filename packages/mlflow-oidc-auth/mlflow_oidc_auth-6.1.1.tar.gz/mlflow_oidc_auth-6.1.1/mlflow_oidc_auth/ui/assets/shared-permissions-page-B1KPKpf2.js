import{r as e,t}from"./jsx-runtime-DAs1UGHr.js";import{t as n}from"./react-DxF41JXl.js";import{n as r,s as i}from"./chunk-EPOLDU6W-CNaCjKeI.js";import{E as a,a as o,b as s,f as c,i as l,j as u,t as d}from"./use-api-BAbm8GVs.js";import{n as f}from"./use-user-BydImGZB.js";import{o as p}from"./user-service-Cq_o-JT5.js";import{t as m}from"./page-container-DV9_twon.js";import{_ as h,b as g,c as _,d as v,f as y,l as b,s as x,u as S,y as C}from"./entity-service-D6-I4F0h.js";import{t as w}from"./use-all-experiments-2M5Vv300.js";import{i as T,n as E,r as D,t as O}from"./search-input-DVDKmJAY.js";import{t as k}from"./icon-button-8v1zbWfj.js";import{n as A,r as j,t as M}from"./use-toast-CpnYXdO8.js";import{n as ee,r as N,t as P}from"./grant-permission-modal-Du7KzdTv.js";import{i as F,n as I,r as L,t as R}from"./use-user-prompt-permissions-XTSblT8y.js";import{t as te}from"./use-all-models-ByKExnMB.js";import{t as z}from"./use-all-prompts-CDSoqi-1.js";var B=e(n(),1),V=e(t(),1);const H=({checked:e,onChange:t,label:n,className:r=``,labelClassName:i=``,disabled:a=!1})=>(0,V.jsxs)(`div`,{className:`flex items-center gap-2 ${a?`opacity-50 cursor-not-allowed`:`cursor-pointer`} ${r}`,onClick:()=>!a&&t(!e),children:[(0,V.jsxs)(`div`,{role:`switch`,"aria-checked":e,tabIndex:a?-1:0,onKeyDown:n=>{!a&&(n.key===`Enter`||n.key===` `)&&(n.preventDefault(),t(!e))},className:`w-[55px] h-[26px] rounded-full relative transition-colors duration-200 ease-in-out border border-transparent ${e?`bg-btn-primary dark:bg-btn-primary-dark`:`bg-gray-200 dark:bg-gray-700`}`,children:[(0,V.jsx)(`span`,{className:`absolute left-1.5 top-1/2 -translate-y-1/2 text-[10px] font-bold text-btn-primary-text dark:text-btn-primary-text-dark transition-opacity duration-200 pointer-events-none ${e?`opacity-100`:`opacity-0`}`,children:`ON`}),(0,V.jsx)(`span`,{className:`absolute right-1.5 top-1/2 -translate-y-1/2 text-[10px] font-bold text-gray-500 dark:text-gray-300 transition-opacity duration-200 pointer-events-none ${e?`opacity-0`:`opacity-100`}`,children:`OFF`}),(0,V.jsx)(`div`,{className:`absolute top-[2px] left-[2px] w-5 h-5 rounded-full bg-white shadow-sm transition-transform duration-200 ease-in-out z-10 ${e?`translate-x-[29px]`:`translate-x-0`}`})]}),n&&(0,V.jsx)(`span`,{className:`text-sm font-medium select-none ${i?``:`text-btn-primary-text dark:text-btn-primary-text-dark`} ${i}`,children:n})]});function U({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e?p(e,t):Promise.reject(Error(`Username is required`)),[e]));return{user:t,isLoading:n,error:r,refetch:i}}function W({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):_(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function G({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):y(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function K({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):v(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}const q=({type:e,entityKind:t,entityName:n})=>{let{showToast:r}=M(),[i,d]=(0,B.useState)(!1),[f,p]=(0,B.useState)(null),[m,h]=(0,B.useState)(!1),[g,_]=(0,B.useState)(!1),{searchTerm:v,submittedTerm:y,handleInputChange:b,handleSearchSubmit:x,handleClearSearch:S}=T(),C=L({username:t===`user`?n:null}),A=I({username:t===`user`?n:null}),j=R({username:t===`user`?n:null}),N=W({groupName:t===`group`?n:null}),F=G({groupName:t===`group`?n:null}),H=K({groupName:t===`group`?n:null}),{isLoading:U,error:q,refresh:J,permissions:Y}=t===`user`?{experiments:C,models:A,prompts:j}[e]:{experiments:N,models:F,prompts:H}[e],{allExperiments:X}=w(),{allModels:Z}=te(),{allPrompts:ne}=z(),Q=(()=>{if(e===`experiments`){let e=new Set(Y.map(e=>e.id));return(X||[]).filter(t=>!e.has(t.id)).map(e=>({label:e.name,value:e.id}))}let t=new Set(Y.map(e=>e.name));return e===`models`?(Z||[]).filter(e=>!t.has(e.name)).map(e=>e.name):e===`prompts`?(ne||[]).filter(e=>!t.has(e.name)).map(e=>e.name):[]})(),re=e=>{p(e),d(!0)},$=()=>{d(!1),p(null)},ie=async i=>{if(!(!n||!f)){h(!0);try{let a=``,s=`id`in f?String(f.id):f.name;e===`experiments`?a=t===`user`?o.USER_EXPERIMENT_PERMISSION(n,s):o.GROUP_EXPERIMENT_PERMISSION(n,s):e===`models`?a=t===`user`?o.USER_MODEL_PERMISSION(n,s):o.GROUP_MODEL_PERMISSION(n,s):e===`prompts`&&(a=t===`user`?o.USER_PROMPT_PERMISSION(n,s):o.GROUP_PROMPT_PERMISSION(n,s));let c=(t===`user`?f.kind===`user`||f.kind===`service-account`:f.kind===`group`)?`PATCH`:`POST`;await l(a,{method:c,body:JSON.stringify({permission:i})}),r(`Permission for ${f.name} has been updated.`,`success`),J(),$()}catch{r(`Failed to update permission. Please try again.`,`error`)}finally{h(!1)}}},ae=async(t,i)=>{if(n){h(!0);try{let a=``;e===`experiments`?a=o.GROUP_EXPERIMENT_PERMISSION(n,t):e===`models`?a=o.GROUP_MODEL_PERMISSION(n,t):e===`prompts`&&(a=o.GROUP_PROMPT_PERMISSION(n,t)),await l(a,{method:`POST`,body:JSON.stringify({permission:i})}),r(`Permission for ${e===`experiments`&&X?.find(e=>e.id===t)?.name||t} has been granted.`,`success`),J(),_(!1)}catch{r(`Failed to grant permission. Please try again.`,`error`)}finally{h(!1)}}},oe=async i=>{if(n)try{let a=``,s=`id`in i?i.id:i.name;e===`experiments`?a=t===`user`?o.USER_EXPERIMENT_PERMISSION(n,s):o.GROUP_EXPERIMENT_PERMISSION(n,s):e===`models`?a=t===`user`?o.USER_MODEL_PERMISSION(n,s):o.GROUP_MODEL_PERMISSION(n,s):e===`prompts`&&(a=t===`user`?o.USER_PROMPT_PERMISSION(n,s):o.GROUP_PROMPT_PERMISSION(n,s)),await l(a,{method:`DELETE`}),r(`Permission for ${i.name} has been removed.`,`success`),J()}catch{r(`Failed to remove permission. Please try again.`,`error`)}},se=[{header:`Name`,render:e=>e.name},{header:`Permission`,render:e=>e.permission},{header:`Kind`,render:e=>e.kind},{header:`Actions`,render:e=>{let n=e.kind===`fallback`,r=t===`user`?e.kind===`user`||e.kind===`service-account`:e.kind===`group`,i=!r||n;return(0,V.jsxs)(`div`,{className:`flex space-x-2`,children:[(0,V.jsx)(k,{icon:i?s:c,title:i?`Add permission`:`Edit permission`,onClick:()=>re(e)}),(0,V.jsx)(k,{icon:a,title:`Remove permission`,onClick:()=>{oe(e)},disabled:!r})]})},className:`w-24`}],ce=Y.filter(e=>e.name.toLowerCase().includes(y.toLowerCase()));return(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(E,{isLoading:U,loadingText:`Loading permissions...`,error:q,onRetry:J}),!U&&!q&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsxs)(`div`,{className:`mt-2 mb-3 flex items-center gap-6`,children:[(0,V.jsx)(O,{value:v,onInputChange:b,onSubmit:x,onClear:S,placeholder:`Search ${e}...`}),t===`group`&&(0,V.jsxs)(u,{variant:`secondary`,onClick:()=>_(!0),disabled:Q.length===0,icon:s,className:`whitespace-nowrap h-8 mb-1 mt-2`,children:[`Add `,e===`experiments`?`experiment`:e===`models`?`model`:`prompt`]})]}),(0,V.jsx)(D,{mode:`object`,data:ce,columns:se,searchTerm:y})]}),(0,V.jsx)(ee,{isOpen:i,onClose:$,onSave:ie,item:f,username:n,type:e,isLoading:m}),(0,V.jsx)(P,{isOpen:g,onClose:()=>_(!1),onSave:(e,t)=>ae(e,t),title:`Grant ${e===`experiments`?`experiment`:e===`models`?`model`:`prompt`} permissions for ${n}`,label:e===`experiments`?`Experiment`:e===`models`?`Model`:`Prompt`,options:Q,isLoading:m})]})};var J=[`READ`,`EDIT`,`MANAGE`,`NO_PERMISSIONS`];const Y=({isOpen:e,onClose:t,onSave:n,isLoading:r=!1})=>{let[i,a]=(0,B.useState)(``),[o,s]=(0,B.useState)(100),[c,l]=(0,B.useState)(`READ`),[d,f]=(0,B.useState)({});if((0,B.useEffect)(()=>{e&&(a(``),s(100),l(`READ`),f({}))},[e]),!e)return null;let p=async()=>{let e={},t=!1;try{new RegExp(i)}catch{e.regex=`Invalid regular expression. Please enter a valid Python regex.`,t=!0}o===void 0||isNaN(o)?(e.priority=`Priority is required.`,t=!0):(!Number.isInteger(o)||o<0)&&(e.priority=`Priority must be a non-negative integer.`,t=!0),f(e),!t&&await n(i,c,o)};return(0,V.jsxs)(j,{isOpen:e,onClose:t,title:`Add New Regex Rule`,children:[(0,V.jsx)(A,{id:`regex-input`,label:`Regex*`,type:`text`,value:i,onChange:e=>{a(e.target.value),d.regex&&f({...d,regex:void 0})},required:!0,placeholder:`Enter Python Regex e.g. (^test_.*)`,error:d.regex,containerClassName:`mb-4`,reserveErrorSpace:!0}),(0,V.jsx)(A,{id:`priority-input`,label:`Priority*`,type:`number`,value:isNaN(o)?``:o,onChange:e=>{s(parseInt(e.target.value,10)),d.priority&&f({...d,priority:void 0})},required:!0,step:`1`,min:`0`,error:d.priority,containerClassName:`mb-4`,reserveErrorSpace:!0}),(0,V.jsx)(N,{id:`permission-level`,label:`Permissions*`,value:c,onChange:e=>l(e.target.value),required:!0,options:J.map(e=>({label:e,value:e})),containerClassName:`mb-4`}),(0,V.jsxs)(`div`,{className:`flex justify-end space-x-3`,children:[(0,V.jsx)(u,{onClick:t,variant:`ghost`,disabled:r,children:`Cancel`}),(0,V.jsx)(u,{onClick:()=>{p()},variant:`primary`,disabled:r,children:r?`Saving...`:`Save`})]})]})};function X({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):h(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function Z({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):C(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function ne({username:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):g(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function Q({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):x(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function re({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):b(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}function $({groupName:e}){let{data:t,isLoading:n,error:r,refetch:i}=d((0,B.useCallback)(t=>e===null?Promise.resolve([]):S(e,t),[e]));return{permissions:t??[],isLoading:n,error:r,refresh:i}}const ie=({type:e,entityKind:t,entityName:n})=>{let{showToast:r}=M(),[i,d]=(0,B.useState)(!1),[f,p]=(0,B.useState)(!1),[m,h]=(0,B.useState)(null),[g,_]=(0,B.useState)(!1),{searchTerm:v,submittedTerm:y,handleInputChange:b,handleSearchSubmit:x,handleClearSearch:S}=T(),C=X({username:t===`user`?n:null}),w=Z({username:t===`user`?n:null}),A=ne({username:t===`user`?n:null}),j=Q({groupName:t===`group`?n:null}),N=re({groupName:t===`group`?n:null}),P=$({groupName:t===`group`?n:null}),{isLoading:F,error:I,refresh:L,permissions:R}=t===`user`?{experiments:C,models:w,prompts:A}[e]:{experiments:j,models:N,prompts:P}[e],te=e=>{h(e),d(!0)},z=()=>{d(!1),h(null)},H=async(i,a,s)=>{if(!(!n||!m)){_(!0);try{let c=``,u=String(m.id);e===`experiments`?c=t===`user`?o.USER_EXPERIMENT_PATTERN_PERMISSION(n,u):o.GROUP_EXPERIMENT_PATTERN_PERMISSION(n,u):e===`models`?c=t===`user`?o.USER_MODEL_PATTERN_PERMISSION(n,u):o.GROUP_MODEL_PATTERN_PERMISSION(n,u):e===`prompts`&&(c=t===`user`?o.USER_PROMPT_PATTERN_PERMISSION(n,u):o.GROUP_PROMPT_PATTERN_PERMISSION(n,u)),await l(c,{method:`PATCH`,body:JSON.stringify({regex:a??m.regex,priority:s??m.priority,permission:i})}),r(`Permission for ${a??m.regex} has been updated.`,`success`),L(),z()}catch{r(`Failed to update permission. Please try again.`,`error`)}finally{_(!1)}}},U=async(i,a,s)=>{if(n){_(!0);try{let c=``;e===`experiments`?c=t===`user`?o.USER_EXPERIMENT_PATTERN_PERMISSIONS(n):o.GROUP_EXPERIMENT_PATTERN_PERMISSIONS(n):e===`models`?c=t===`user`?o.USER_MODEL_PATTERN_PERMISSIONS(n):o.GROUP_MODEL_PATTERN_PERMISSIONS(n):e===`prompts`&&(c=t===`user`?o.USER_PROMPT_PATTERN_PERMISSIONS(n):o.GROUP_PROMPT_PATTERN_PERMISSIONS(n)),await l(c,{method:`POST`,body:JSON.stringify({regex:i,permission:a,priority:s})}),r(`Regex rule "${i}" has been added.`,`success`),L(),p(!1)}catch{r(`Failed to add regex rule. Please try again.`,`error`)}finally{_(!1)}}},W=async i=>{if(n)try{let a=``,s=String(i.id);e===`experiments`?a=t===`user`?o.USER_EXPERIMENT_PATTERN_PERMISSION(n,s):o.GROUP_EXPERIMENT_PATTERN_PERMISSION(n,s):e===`models`?a=t===`user`?o.USER_MODEL_PATTERN_PERMISSION(n,s):o.GROUP_MODEL_PATTERN_PERMISSION(n,s):e===`prompts`&&(a=t===`user`?o.USER_PROMPT_PATTERN_PERMISSION(n,s):o.GROUP_PROMPT_PATTERN_PERMISSION(n,s)),await l(a,{method:`DELETE`}),r(`Regex rule has been removed.`,`success`),L()}catch{r(`Failed to remove permission. Please try again.`,`error`)}},G=[{header:`Regex Pattern`,render:e=>e.regex},{header:`Permission`,render:e=>e.permission},{header:`Priority`,render:e=>e.priority},{header:`Actions`,render:e=>(0,V.jsxs)(`div`,{className:`flex space-x-2`,children:[(0,V.jsx)(k,{icon:c,title:`Edit pattern permission`,onClick:()=>te(e)}),(0,V.jsx)(k,{icon:a,title:`Remove pattern permission`,onClick:()=>{W(e)}})]}),className:`w-24`}],K=R.filter(e=>e.regex?.toLowerCase().includes(y.toLowerCase()));return(0,V.jsxs)(V.Fragment,{children:[(0,V.jsx)(E,{isLoading:F,loadingText:`Loading permissions...`,error:I,onRetry:L}),!F&&!I&&(0,V.jsxs)(V.Fragment,{children:[(0,V.jsxs)(`div`,{className:`mt-2 mb-3 flex items-center gap-6`,children:[(0,V.jsx)(O,{value:v,onInputChange:b,onSubmit:x,onClear:S,placeholder:`Search ${e}...`}),(0,V.jsx)(u,{variant:`secondary`,onClick:()=>p(!0),icon:s,className:`whitespace-nowrap h-8 mb-1 mt-2`,children:`Add Regex`})]}),(0,V.jsx)(D,{mode:`object`,data:K,columns:G,searchTerm:y})]}),(0,V.jsx)(ee,{isOpen:i,onClose:z,onSave:H,item:m,username:n,type:e,isLoading:g}),(0,V.jsx)(Y,{isOpen:f,onClose:()=>p(!1),onSave:U,isLoading:g})]})},ae=({type:e,baseRoute:t,entityKind:n})=>{let{username:a,groupName:o}=i(),s=(n===`user`?a:o)||null,{currentUser:c}=f(),{user:l,refetch:u}=U({username:n===`user`&&c?.is_admin?s:null}),[d,p]=(0,B.useState)(!1);return s?(0,V.jsxs)(m,{title:d?`Regex Permissions for ${s}`:`Permissions for ${s}`,children:[(0,V.jsx)(`div`,{className:`flex items-end gap-6`,children:n===`user`&&c?.is_admin&&(0,V.jsx)(F,{username:s,passwordExpiration:l?.password_expiration,onTokenGenerated:u})}),(0,V.jsxs)(`div`,{className:`flex justify-between items-center border-b border-btn-secondary-border dark:border-btn-secondary-border-dark mb-3`,children:[(0,V.jsx)(`div`,{className:`flex space-x-4`,children:[{id:`experiments`,label:`Experiments`},{id:`models`,label:`Models`},{id:`prompts`,label:`Prompts`}].map(n=>(0,V.jsx)(r,{to:`${t}/${s}/${n.id}`,className:`py-2 px-4 border-b-2 font-medium text-sm transition-colors duration-200 ${e===n.id?`border-btn-primary text-btn-primary dark:border-btn-primary-dark dark:text-btn-primary-dark`:`border-transparent text-text-primary dark:text-text-primary-dark hover:text-text-primary-hover dark:hover:text-text-primary-hover-dark hover:border-btn-secondary-border dark:hover:border-btn-secondary-border-dark`}`,children:n.label},n.id))}),c?.is_admin&&(0,V.jsx)(H,{checked:d,onChange:p,label:`Regex Mode`,className:`mr-5`,labelClassName:`py-2 px-2 font-medium text-sm transition-colors duration-200 ${d?`text-btn-primary dark:text-btn-primary-dark`:`text-text-primary hover:text-text-primary-hover dark:hover:text-text-primary-hover-dark hover:border-btn-secondary-border dark:hover:border-btn-secondary-border-dark`}`})]}),d?(0,V.jsx)(ie,{type:e,entityKind:n,entityName:s}):(0,V.jsx)(q,{type:e,entityKind:n,entityName:s})]}):(0,V.jsx)(m,{title:`Error`,children:(0,V.jsxs)(`div`,{className:`p-4 text-red-500`,children:[n===`user`?`Username`:`Group name`,` is required.`]})})};export{ae as t};