import{r as e,t}from"./jsx-runtime-DAs1UGHr.js";import{t as n}from"./react-DxF41JXl.js";import{E as r,a as i,f as a,i as o,j as s}from"./use-api-BAbm8GVs.js";import{i as c,n as l,r as u,t as d}from"./search-input-DVDKmJAY.js";import{t as f}from"./icon-button-8v1zbWfj.js";import{t as p}from"./use-toast-CpnYXdO8.js";import{n as m,t as h}from"./grant-permission-modal-Du7KzdTv.js";import{t as g}from"./use-all-users-DZm-oESG.js";import{t as _}from"./use-all-accounts-C7-hDCIu.js";import{t as v}from"./use-all-groups-B9CScfsT.js";var y=e(n(),1);function b({resourceId:e,resourceType:t,refresh:n}){let{showToast:r}=p(),[a,s]=(0,y.useState)(!1),[c,l]=(0,y.useState)(null),[u,d]=(0,y.useState)(!1);return{isModalOpen:a,editingItem:c,isSaving:u,handleEditClick:(0,y.useCallback)(e=>{l({name:e.name,permission:e.permission,kind:e.kind}),s(!0)},[]),handleSavePermission:(0,y.useCallback)(async a=>{if(c){d(!0);try{let u=``;t===`experiments`?u=c.kind===`group`?i.GROUP_EXPERIMENT_PERMISSION(c.name,e):i.USER_EXPERIMENT_PERMISSION(c.name,e):t===`models`?u=c.kind===`group`?i.GROUP_MODEL_PERMISSION(c.name,e):i.USER_MODEL_PERMISSION(c.name,e):t===`prompts`&&(u=c.kind===`group`?i.GROUP_PROMPT_PERMISSION(c.name,e):i.USER_PROMPT_PERMISSION(c.name,e)),await o(u,{method:`PATCH`,body:JSON.stringify({permission:a})}),r(`Permission for ${c.name} has been updated.`,`success`),n(),s(!1),l(null)}catch{r(`Failed to update permission. Please try again.`,`error`)}finally{d(!1)}}},[c,e,t,n,r]),handleRemovePermission:(0,y.useCallback)(async a=>{try{let s=``;t===`experiments`?s=a.kind===`group`?i.GROUP_EXPERIMENT_PERMISSION(a.name,e):i.USER_EXPERIMENT_PERMISSION(a.name,e):t===`models`?s=a.kind===`group`?i.GROUP_MODEL_PERMISSION(a.name,e):i.USER_MODEL_PERMISSION(a.name,e):t===`prompts`&&(s=a.kind===`group`?i.GROUP_PROMPT_PERMISSION(a.name,e):i.USER_PROMPT_PERMISSION(a.name,e)),await o(s,{method:`DELETE`}),r(`Permission for ${a.name} has been removed.`,`success`),n()}catch{r(`Failed to remove permission. Please try again.`,`error`)}},[e,t,n,r]),handleModalClose:(0,y.useCallback)(()=>{s(!1),l(null)},[]),handleGrantPermission:(0,y.useCallback)(async(a,s,c=`user`)=>{d(!0);try{let l=``;return t===`experiments`?l=c===`group`?i.GROUP_EXPERIMENT_PERMISSION(a,e):i.USER_EXPERIMENT_PERMISSION(a,e):t===`models`?l=c===`group`?i.GROUP_MODEL_PERMISSION(a,e):i.USER_MODEL_PERMISSION(a,e):t===`prompts`&&(l=c===`group`?i.GROUP_PROMPT_PERMISSION(a,e):i.USER_PROMPT_PERMISSION(a,e)),await o(l,{method:`POST`,body:JSON.stringify({permission:s})}),r(`Permission for ${a} has been granted.`,`success`),n(),!0}catch{return r(`Failed to grant permission. Please try again.`,`error`),!1}finally{d(!1)}},[e,t,n,r])}}var x=e(t(),1);function S({resourceId:e,resourceName:t,resourceType:n,permissions:i,isLoading:o,error:p,refresh:S}){let{isModalOpen:C,editingItem:w,isSaving:T,handleEditClick:E,handleSavePermission:D,handleRemovePermission:O,handleModalClose:k,handleGrantPermission:A}=b({resourceId:e,resourceType:n,refresh:S}),{allUsers:j}=g(),{allServiceAccounts:M}=_(),{allGroups:N}=v(),[P,F]=(0,y.useState)(!1),[I,L]=(0,y.useState)(!1),[R,z]=(0,y.useState)(!1),B=new Set(i.map(e=>e.name)),V=(j||[]).filter(e=>!B.has(e)),H=(M||[]).filter(e=>!B.has(e)),U=(N||[]).filter(e=>!B.has(e)),{searchTerm:W,submittedTerm:G,handleInputChange:K,handleSearchSubmit:q,handleClearSearch:J}=c(),Y=i.filter(e=>e.name.toLowerCase().includes(G.toLowerCase()));return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(l,{isLoading:o,loadingText:`Loading permissions list...`,error:p,onRetry:S}),!o&&!p&&(0,x.jsxs)(x.Fragment,{children:[(0,x.jsxs)(`div`,{className:`flex items-center space-x-2 mb-4`,children:[(0,x.jsx)(s,{variant:`secondary`,onClick:()=>F(!0),disabled:V.length===0,title:V.length===0?`All users already have permissions`:`Add user permission`,children:`+ Add`}),(0,x.jsx)(s,{variant:`secondary`,onClick:()=>L(!0),disabled:H.length===0,title:H.length===0?`All service accounts already have permissions`:`Add service account permission`,children:`+ Add Service Account`}),(0,x.jsx)(s,{variant:`secondary`,onClick:()=>z(!0),disabled:U.length===0,title:U.length===0?`All groups already have permissions`:`Add group permission`,children:`+ Add Group`})]}),(0,x.jsx)(`div`,{className:`mb-2`,children:(0,x.jsx)(d,{value:W,onInputChange:K,onSubmit:q,onClear:J,placeholder:`Search permissions...`})}),(0,x.jsx)(u,{mode:`object`,data:Y,columns:[{header:`Name`,render:e=>e.name},{header:`Permission`,render:e=>e.permission},{header:`Kind`,render:e=>e.kind},{header:`Actions`,render:e=>(0,x.jsxs)(`div`,{className:`flex space-x-2`,children:[(0,x.jsx)(f,{icon:a,title:`Edit permission`,onClick:()=>E(e)}),(0,x.jsx)(f,{icon:r,title:`Remove permission`,onClick:()=>void O(e)})]}),className:`w-24`}],searchTerm:G})]}),(0,x.jsx)(m,{isOpen:C,onClose:k,onSave:D,item:w,username:w?.name||``,resourceId:e,type:n,isLoading:T}),(0,x.jsx)(h,{isOpen:P,onClose:()=>F(!1),onSave:async(e,t)=>{await A(e,t)&&F(!1)},title:`Grant user permissions for ${t}`,label:`User`,options:V,isLoading:T}),(0,x.jsx)(h,{isOpen:I,onClose:()=>L(!1),onSave:async(e,t)=>{await A(e,t)&&L(!1)},title:`Grant service account permissions for ${t}`,label:`Service account`,options:H,isLoading:T}),(0,x.jsx)(h,{isOpen:R,onClose:()=>z(!1),onSave:async(e,t)=>{await A(e,t,`group`)&&z(!1)},title:`Grant group permissions for ${t}`,label:`Group`,options:U,isLoading:T})]})}export{S as t};