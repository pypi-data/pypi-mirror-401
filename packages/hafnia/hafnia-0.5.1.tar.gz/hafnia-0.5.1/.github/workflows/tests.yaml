name: Python Tests

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      python-version-file:
        required: true
        type: string
jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      max-parallel: 1
      matrix:
        os: [ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v6.0.1
      - uses: actions/setup-python@v6.1.0
        with:
          python-version-file: ${{ inputs.python-version-file }}
      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: 0.6.8
      - name: Install the project
        run: uv sync --group dev
      - name: Mount secrets config
        shell: bash
        env:
          HAFNIA_CONFIG: ${{ secrets.HAFNIA_CONFIG }}
        run: |
          mkdir -p ~/.hafnia
          echo "$HAFNIA_CONFIG" | jq . > ~/.hafnia/config.json
      - name: Check hafnia configuration by download
        run: uv run hafnia dataset download mnist --force
      - name: Run tests
        run: uv run pytest tests 

