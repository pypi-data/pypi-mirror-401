name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Install dependencies
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -e .
          uv pip install duckdb pyarrow

      - name: Start Milvus
        run: |
          # Download and start Milvus standalone
          curl -sfL https://raw.githubusercontent.com/milvus-io/milvus/master/scripts/standalone_embed.sh -o standalone_embed.sh
          bash standalone_embed.sh start

      - name: Wait for Milvus
        run: |
          echo "Waiting for Milvus to be ready..."
          for i in {1..60}; do
            if curl -s http://localhost:9091/healthz | grep -q "OK"; then
              echo "Milvus is ready!"
              exit 0
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done
          echo "Milvus failed to start"
          exit 1

      - name: Run tests
        env:
          MILVUS_URI: http://localhost:19530
        run: |
          source .venv/bin/activate
          chmod +x scripts/test_all.sh
          ./scripts/test_all.sh

      - name: Stop Milvus
        if: always()
        run: |
          bash standalone_embed.sh stop || true
