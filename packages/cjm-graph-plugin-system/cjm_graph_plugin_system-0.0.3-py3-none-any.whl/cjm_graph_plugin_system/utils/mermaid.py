"""Convert GraphContext objects to Mermaid.js diagram strings for visualization"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../../nbs/utils/mermaid.ipynb.

# %% auto 0
__all__ = ['context_to_mermaid']

# %% ../../nbs/utils/mermaid.ipynb 3
from typing import Optional, Dict

from ..core import GraphContext

# %% ../../nbs/utils/mermaid.ipynb 5
def context_to_mermaid(
    ctx: GraphContext,  # The GraphContext to visualize
    direction: str = "TD",  # Diagram direction: "TD" (top-down) or "LR" (left-right)
    node_color_map: Optional[Dict[str, str]] = None  # Map of node labels to CSS colors
) -> str:  # Mermaid.js diagram string
    """Convert a GraphContext into a Mermaid.js diagram string."""
    lines = [f"graph {direction}"]
    
    # Build node ID -> safe Mermaid ID mapping
    valid_ids = {n.id for n in ctx.nodes}
    id_to_mermaid = {n.id: f"N{i}" for i, n in enumerate(ctx.nodes)}
    
    # Generate node definitions
    for node in ctx.nodes:
        safe_id = id_to_mermaid[node.id]
        
        # Use 'name' or 'title' property for display, fallback to label
        display_text = node.properties.get('name', node.properties.get('title', node.label))
        display_text = str(display_text).replace('"', "'")
        
        lines.append(f'    {safe_id}["{display_text}"]')
        
        # Apply styling based on label
        if node_color_map and node.label in node_color_map:
            lines.append(f'    style {safe_id} fill:{node_color_map[node.label]}')
    
    # Generate edge definitions
    for edge in ctx.edges:
        if edge.source_id in valid_ids and edge.target_id in valid_ids:
            src_mermaid = id_to_mermaid[edge.source_id]
            tgt_mermaid = id_to_mermaid[edge.target_id]
            lines.append(f'    {src_mermaid} -->|{edge.relation_type}| {tgt_mermaid}')
    
    return "\n".join(lines)
