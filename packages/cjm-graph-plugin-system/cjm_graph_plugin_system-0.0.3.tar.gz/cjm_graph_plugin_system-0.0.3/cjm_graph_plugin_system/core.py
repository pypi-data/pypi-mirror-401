"""DTOs for Context Graph operations with FileBackedDTO support for zero-copy transfer"""

# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/core.ipynb.

# %% auto 0
__all__ = ['SourceRef', 'GraphNode', 'GraphEdge', 'GraphContext', 'GraphQuery']

# %% ../nbs/core.ipynb 3
import json
import tempfile
from dataclasses import dataclass, field, asdict
from pathlib import Path
from typing import Any, Dict, List, Optional

from cjm_plugin_system.core.interface import FileBackedDTO

# %% ../nbs/core.ipynb 5
@dataclass
class SourceRef:
    """A pointer to external data in another plugin's domain."""
    plugin_name: str  # e.g., "cjm-transcription-plugin-voxtral-hf"
    table_name: str   # e.g., "transcriptions"
    row_id: str       # e.g., "b0ceddd3-..." (typically a job_id)
    segment_slice: Optional[str] = None  # Optional slice: "char:0-500" or "timestamp:00:10-00:20"

    def to_dict(self) -> Dict[str, Any]:  # Dictionary representation for JSON serialization
        """Convert to dictionary."""
        return asdict(self)

# %% ../nbs/core.ipynb 9
@dataclass
class GraphNode:
    """Represents an entity in the Context Graph."""
    id: str           # UUID
    label: str        # e.g., "Person", "Concept", "Correction"
    properties: Dict[str, Any] = field(default_factory=dict)  # Arbitrary metadata
    sources: List[SourceRef] = field(default_factory=list)    # Links to external plugins

    def to_dict(self) -> Dict[str, Any]:  # Dictionary representation for JSON serialization
        """Convert to dictionary with nested sources."""
        return {
            "id": self.id,
            "label": self.label,
            "properties": self.properties,
            "sources": [s.to_dict() for s in self.sources]
        }

# %% ../nbs/core.ipynb 13
@dataclass
class GraphEdge:
    """Represents a relationship between two nodes."""
    id: str            # UUID
    source_id: str     # Origin node UUID
    target_id: str     # Destination node UUID
    relation_type: str # e.g., "MENTIONS", "CORRECTS", "AUTHORED_BY"
    properties: Dict[str, Any] = field(default_factory=dict)  # Arbitrary metadata

    def to_dict(self) -> Dict[str, Any]:  # Dictionary representation for JSON serialization
        """Convert to dictionary."""
        return asdict(self)

# %% ../nbs/core.ipynb 16
@dataclass
class GraphContext:
    """Container for graph query results (a subgraph)."""
    nodes: List[GraphNode]    # Nodes in the subgraph
    edges: List[GraphEdge]    # Edges in the subgraph
    metadata: Dict[str, Any] = field(default_factory=dict)  # Query metadata, stats, etc.

    def to_temp_file(self) -> str:  # Absolute path to temporary JSON file
        """Save graph data to a temp file for zero-copy transfer."""
        tmp = tempfile.NamedTemporaryFile(suffix=".json", delete=False, mode='w')
        
        data = {
            "nodes": [n.to_dict() for n in self.nodes],
            "edges": [e.to_dict() for e in self.edges],
            "metadata": self.metadata
        }
        
        json.dump(data, tmp)
        tmp.close()
        return str(Path(tmp.name).absolute())

    def to_dict(self) -> Dict[str, Any]:  # Dictionary representation for JSON serialization
        """Convert to dictionary."""
        return {
            "nodes": [n.to_dict() for n in self.nodes],
            "edges": [e.to_dict() for e in self.edges],
            "metadata": self.metadata
        }

    @classmethod
    def from_file(
        cls,
        filepath: str  # Path to JSON file
    ) -> "GraphContext":  # Reconstructed GraphContext
        """Load graph context from a JSON file."""
        with open(filepath, 'r') as f:
            data = json.load(f)

        nodes = []
        for n_data in data.get('nodes', []):
            sources = [SourceRef(**s) for s in n_data.get('sources', [])]
            nodes.append(GraphNode(
                id=n_data['id'],
                label=n_data['label'],
                properties=n_data.get('properties', {}),
                sources=sources
            ))

        edges = [GraphEdge(**e) for e in data.get('edges', [])]
        return cls(nodes=nodes, edges=edges, metadata=data.get('metadata', {}))

    @classmethod
    def from_dict(
        cls,
        data: Dict[str, Any]  # Dictionary with nodes, edges, metadata
    ) -> "GraphContext":  # Reconstructed GraphContext
        """Load graph context from a dictionary."""
        nodes = []
        for n_data in data.get('nodes', []):
            sources = [SourceRef(**s) for s in n_data.get('sources', [])]
            nodes.append(GraphNode(
                id=n_data['id'],
                label=n_data['label'],
                properties=n_data.get('properties', {}),
                sources=sources
            ))

        edges = [GraphEdge(**e) for e in data.get('edges', [])]
        return cls(nodes=nodes, edges=edges, metadata=data.get('metadata', {}))

# %% ../nbs/core.ipynb 21
@dataclass
class GraphQuery:
    """A standardized query object for graph operations."""
    query: str  # Raw query string (SQL, Cypher, etc.)
    parameters: Dict[str, Any] = field(default_factory=dict)  # Query parameters
    limit: int = 100   # Max results to return
    depth: int = 1     # Traversal depth for neighborhood queries

    def to_dict(self) -> Dict[str, Any]:  # Dictionary representation for JSON serialization
        """Convert to dictionary."""
        return asdict(self)
