# v3.13 åˆ° v3.14 è¿ç§»æŒ‡å—

> **çŠ¶æ€**: ğŸ“ è‰æ¡ˆ
> **é€‚ç”¨ç‰ˆæœ¬**: v3.13.x â†’ v3.14.0

---

## æ¦‚è¿°

v3.14.0 æ˜¯ä¸€æ¬¡é‡å¤§æ¶æ„å‡çº§ï¼Œä¸»è¦å˜æ›´ï¼š

1. **ä¸­é—´ä»¶é‡æ„**: `Interceptor` â†’ `Middleware`ï¼ˆæ´‹è‘±æ¨¡å‹ï¼‰
2. **ç›®å½•é‡ç»„**: å››å±‚æ¶æ„ + æ¨ªåˆ‡å…³æ³¨ç‚¹
3. **å¼‚æ­¥ä¼˜å…ˆ**: `HttpClient` é»˜è®¤å¼‚æ­¥
4. **å¯è§‚æµ‹æ€§èåˆ**: ç»Ÿä¸€ `Telemetry` æŠ½è±¡
5. **æ’ä»¶ç³»ç»Ÿåˆ†ç¦»**: `infrastructure/plugins/` + `plugins/`

æœ¬æŒ‡å—å¸®åŠ©ä½ å¹³æ»‘è¿ç§»ç°æœ‰ä»£ç ã€‚

---

## æ¶æ„å±‚çº§å˜æ›´

v3.14.0 é‡‡ç”¨å››å±‚æ¶æ„ + æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼š

| å±‚çº§ | ç›®å½• | è¯´æ˜ |
|------|------|------|
| **Layer 0** | `core/` | æ ¸å¿ƒæŠ½è±¡ï¼ˆmiddlewareã€contextã€eventsã€protocolsï¼‰- æ— ç¬¬ä¸‰æ–¹ä¾èµ– |
| **Layer 1** | `infrastructure/` | åŸºç¡€è®¾æ–½ï¼ˆconfigã€providersã€runtimeã€bootstrapã€telemetryã€pluginsï¼‰ |
| **Layer 2** | `capabilities/` | èƒ½åŠ›å±‚ï¼ˆclientsã€databasesã€messengersã€storagesã€driversï¼‰ |
| **Layer 3** | `testing/` + `cli/` | æ¥å£å±‚ï¼ˆå¹¶è¡Œï¼‰ |
| **æ¨ªåˆ‡** | `plugins/` | æ’ä»¶å®ç°ï¼ˆä¸åœ¨å±‚çº§ä¸­ï¼‰ |

---

## 1. å¯¼å…¥è·¯å¾„å˜æ›´

### 1.1 HTTP å®¢æˆ·ç«¯

```python
# v3.x
from df_test_framework.clients.http.rest.httpx.client import HttpClient
from df_test_framework.clients.http.rest.httpx.async_client import AsyncHttpClient

# v3.14.0ï¼ˆèƒ½åŠ›å±‚ç§»åŠ¨åˆ° capabilities/ ç›®å½•ï¼‰
from df_test_framework.capabilities.clients.http import HttpClient
# æˆ–é¡¶å±‚å¯¼å…¥ï¼ˆæ¨èï¼‰
from df_test_framework import HttpClient

# æ³¨æ„ï¼šv3.14.0 HttpClient é»˜è®¤å¼‚æ­¥ï¼Œæ— éœ€å•ç‹¬çš„ AsyncHttpClient
```

### 1.2 æ‹¦æˆªå™¨/ä¸­é—´ä»¶

```python
# v3.x
from df_test_framework.clients.http.interceptors.auth.bearer_token import BearerTokenInterceptor
from df_test_framework.clients.http.interceptors.signature.interceptor import SignatureInterceptor

# v3.14.0ï¼ˆinterceptors é‡å‘½åä¸º middlewareï¼‰
from df_test_framework.capabilities.clients.http.middleware import BearerTokenMiddleware, SignatureMiddleware
```

### 1.3 æ•°æ®åº“

```python
# v3.x
from df_test_framework.databases import Database, UnitOfWork, BaseRepository
from df_test_framework.databases.uow import UnitOfWork

# v3.14.0
from df_test_framework.capabilities.databases import Database, UnitOfWork, BaseRepository
```

### 1.4 æ¶ˆæ¯é˜Ÿåˆ—

```python
# v3.x
from df_test_framework.messengers.queue.kafka import KafkaProducer, KafkaConsumer

# v3.14.0
from df_test_framework.capabilities.messengers.queue.kafka import KafkaProducer, KafkaConsumer
```

### 1.5 å­˜å‚¨

```python
# v3.x
from df_test_framework.storages.object.s3 import S3Client
from df_test_framework.storages.object.oss import OSSClient

# v3.14.0
from df_test_framework.capabilities.storages.object.s3 import S3Client
from df_test_framework.capabilities.storages.object.oss import OSSClient
```

### 1.6 åŸºç¡€è®¾æ–½

```python
# v3.x
from df_test_framework.infrastructure.config import FrameworkSettings
from df_test_framework.infrastructure.runtime import RuntimeContext
from df_test_framework.infrastructure.tracing import TracingManager
from df_test_framework.infrastructure.metrics import MetricsManager

# v3.14.0ï¼ˆinfrastructure æ‰©å±•èŒè´£ï¼ŒLayer 1ï¼‰
from df_test_framework.infrastructure.config import FrameworkSettings
from df_test_framework.infrastructure.runtime import RuntimeContext
from df_test_framework.infrastructure.telemetry import Telemetry  # èåˆ Tracing + Metrics + Logging

# æˆ–ä½¿ç”¨æ¥å£ï¼ˆä¾èµ–åè½¬ï¼‰
from df_test_framework.core.protocols.telemetry import ITelemetry
```

### 1.7 æ’ä»¶ç³»ç»Ÿ

```python
# v3.x
from df_test_framework.extensions.core.hooks import HookSpecs
from df_test_framework.extensions.core.manager import ExtensionManager
from df_test_framework.extensions.builtin.monitoring import MonitoringPlugin

# v3.14.0ï¼ˆæ’ä»¶ç³»ç»Ÿä¸‰å±‚åˆ†ç¦»ï¼‰
# æ¥å£å®šä¹‰ï¼ˆcore - çº¯æŠ½è±¡ï¼‰
from df_test_framework.core.protocols.plugin import IPluginManager

# å…·ä½“å®ç°ï¼ˆinfrastructure - ä¾èµ– pluggyï¼‰
from df_test_framework.infrastructure.plugins import PluggyPluginManager
from df_test_framework.infrastructure.plugins.hooks import HookSpecs, hookimpl  # HookSpecs å•ä¸€æ•°æ®æº

# æ’ä»¶å®ç°ï¼ˆplugins - æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼‰
from df_test_framework.plugins.builtin.monitoring import MonitoringPlugin
```

### 1.8 å¼‚å¸¸

```python
# v3.x
from df_test_framework.common.exceptions import FrameworkError, HttpError

# v3.14.0
from df_test_framework.core import FrameworkError, HttpError
```

---

## 2. æ‹¦æˆªå™¨ â†’ ä¸­é—´ä»¶

### 2.1 æ¦‚å¿µå˜æ›´

| v3.x Interceptor | v3.14.0 Middleware |
|------------------|-----------------|
| `before_request()` + `after_response()` åˆ†ç¦» | ç»Ÿä¸€ `__call__(request, call_next)` |
| çŠ¶æ€éœ€é€šè¿‡ `context` ä¼ é€’ | åŒä¸€ä½œç”¨åŸŸç›´æ¥å…±äº«å˜é‡ |
| åŒæ­¥ä¸ºä¸» | å¼‚æ­¥åŸç”Ÿ |

### 2.2 ä»£ç è¿ç§»

#### ç®€å•æ‹¦æˆªå™¨

```python
# v3.x
class AddHeaderInterceptor(BaseInterceptor):
    def __init__(self, key: str, value: str):
        self.key = key
        self.value = value

    def before_request(self, request):
        return request.with_header(self.key, self.value)

# v3.14.0 æ–¹å¼ä¸€ï¼šç»§æ‰¿ SyncMiddleware
from df_test_framework.core.middleware import SyncMiddleware

class AddHeaderMiddleware(SyncMiddleware):
    def __init__(self, key: str, value: str):
        super().__init__()
        self.key = key
        self.value = value

    def before(self, request):
        return request.with_header(self.key, self.value)

# v3.14.0 æ–¹å¼äºŒï¼šå‡½æ•°å¼
from df_test_framework.core.middleware import middleware

@middleware(priority=100)
async def add_header(request, call_next):
    request = request.with_header("X-Custom", "value")
    return await call_next(request)
```

#### éœ€è¦çŠ¶æ€å…±äº«çš„æ‹¦æˆªå™¨

```python
# v3.xï¼ˆç¹ççš„ context ä¼ é€’ï¼‰
class TimingInterceptor(BaseInterceptor):
    def before_request(self, request):
        return request.with_context("_timing_start", time.monotonic())

    def after_response(self, response):
        start = response.context.get("_timing_start")
        if start:
            duration = time.monotonic() - start
            logger.info(f"Duration: {duration:.3f}s")
        return response

# v3.14.0ï¼ˆè‡ªç„¶çš„ä½œç”¨åŸŸå…±äº«ï¼‰
from df_test_framework.core.middleware import BaseMiddleware

class TimingMiddleware(BaseMiddleware):
    async def __call__(self, request, call_next):
        start = time.monotonic()  # ç›´æ¥å®šä¹‰

        response = await call_next(request)

        duration = time.monotonic() - start  # ç›´æ¥è®¿é—®
        logger.info(f"Duration: {duration:.3f}s")
        return response
```

#### å¸¦é‡è¯•é€»è¾‘çš„æ‹¦æˆªå™¨

```python
# v3.xï¼ˆéœ€è¦ç‰¹æ®Šå¤„ç†ï¼‰
class RetryInterceptor(BaseInterceptor):
    # å®ç°è¾ƒå¤æ‚ï¼Œéœ€è¦å¤–éƒ¨æ§åˆ¶é‡è¯•

# v3.14.0ï¼ˆæ´‹è‘±æ¨¡å‹å¤©ç„¶æ”¯æŒï¼‰
class RetryMiddleware(BaseMiddleware):
    def __init__(self, max_attempts: int = 3):
        super().__init__(priority=5)  # ä¼˜å…ˆçº§é«˜ï¼Œå…ˆæ‰§è¡Œ
        self.max_attempts = max_attempts

    async def __call__(self, request, call_next):
        for attempt in range(self.max_attempts):
            try:
                response = await call_next(request)
                if response.status_code < 500:
                    return response
            except Exception:
                if attempt == self.max_attempts - 1:
                    raise
            await asyncio.sleep(2 ** attempt)
        return response
```

### 2.3 ä¼˜å…ˆçº§è¯´æ˜

| v3.x | v3.14.0 | è¯´æ˜ |
|------|------|------|
| `priority` æ•°å­—è¶Šå¤§è¶Šå…ˆæ‰§è¡Œ | `priority` æ•°å­—è¶Šå°è¶Šå…ˆæ‰§è¡Œ | ä¸æ´‹è‘±æ¨¡å‹ä¸€è‡´ |

```python
# v3.x æ‰§è¡Œé¡ºåºï¼šLogging(100) â†’ Auth(50) â†’ Signature(10)
# v3.14.0 æ‰§è¡Œé¡ºåºï¼šSignature(10) â†’ Auth(50) â†’ Logging(100)

# è¿ç§»æ—¶éœ€è¦è°ƒæ•´ä¼˜å…ˆçº§å€¼
# v3.x priority=10 â†’ v3.14.0 priority=100
# v3.x priority=100 â†’ v3.14.0 priority=10
```

---

## 3. HttpClient å˜æ›´

### 3.1 åŒæ­¥ vs å¼‚æ­¥

```python
# v3.xï¼šåŒæ­¥å’Œå¼‚æ­¥åˆ†å¼€
from df_test_framework.clients.http import HttpClient, AsyncHttpClient

client = HttpClient("https://api.example.com")
response = client.get("/users")  # åŒæ­¥

async_client = AsyncHttpClient("https://api.example.com")
response = await async_client.get("/users")  # å¼‚æ­¥

# v3.14.0ï¼šé»˜è®¤å¼‚æ­¥ï¼Œæä¾›åŒæ­¥åŒ…è£…
from df_test_framework.http import HttpClient

client = HttpClient("https://api.example.com")

# å¼‚æ­¥è°ƒç”¨ï¼ˆæ¨èï¼‰
async with client:
    response = await client.get("/users")

# åŒæ­¥è°ƒç”¨ï¼ˆä¾¿æ·æ–¹æ³•ï¼‰
response = client.get_sync("/users")
```

### 3.2 é…ç½®ä¸­é—´ä»¶

```python
# v3.x
client = HttpClient(
    base_url="https://api.example.com",
    interceptors=[
        SignatureInterceptor(secret="xxx"),
        BearerTokenInterceptor(token="yyy"),
    ]
)

# v3.14.0
client = HttpClient(
    base_url="https://api.example.com",
    middlewares=[
        SignatureMiddleware(secret="xxx"),
        BearerTokenMiddleware(token="yyy"),
    ]
)

# æˆ–é“¾å¼è°ƒç”¨
client = (
    HttpClient("https://api.example.com")
    .use(SignatureMiddleware(secret="xxx"))
    .use(BearerTokenMiddleware(token="yyy"))
)
```

### 3.3 pytest ä¸­ä½¿ç”¨

```python
# v3.x
def test_api(http_client):
    response = http_client.get("/users")
    assert response.status_code == 200

# v3.14.0ï¼ˆå¼‚æ­¥æµ‹è¯•ï¼‰
@pytest.mark.asyncio
async def test_api(http_client):
    response = await http_client.get("/users")
    assert response.status_code == 200

# æˆ–ä½¿ç”¨åŒæ­¥åŒ…è£…
def test_api_sync(http_client):
    response = http_client.get_sync("/users")
    assert response.status_code == 200
```

---

## 4. å¯è§‚æµ‹æ€§å˜æ›´

### 4.1 Tracing + Metrics + Logging â†’ Telemetry

```python
# v3.xï¼šåˆ†æ•£çš„å¯è§‚æµ‹æ€§
from df_test_framework.infrastructure.tracing import TracingManager
from df_test_framework.infrastructure.metrics import MetricsManager
from df_test_framework.infrastructure.logging import setup_logger

tracer = TracingManager(...)
metrics = MetricsManager(...)
logger = setup_logger(...)

# éœ€è¦åˆ†åˆ«ä½¿ç”¨
with tracer.start_span("operation"):
    metrics.increment_counter("operation.count")
    logger.info("Starting operation")
    ...

# v3.14.0ï¼šç»Ÿä¸€çš„ Telemetry
from df_test_framework.core.telemetry import Telemetry

telemetry = Telemetry(tracer, meter, logger)

# ä¸€æ¬¡è°ƒç”¨ï¼Œä¸‰ä»½æ•°æ®
async with telemetry.span("operation", {"key": "value"}):
    ...  # è‡ªåŠ¨è®°å½• Span + Histogram + Log
```

### 4.2 HTTP è¿½è¸ªæ‹¦æˆªå™¨

```python
# v3.x
from df_test_framework.infrastructure.tracing.interceptors import TracingInterceptor

client = HttpClient(
    interceptors=[TracingInterceptor(tracer)]
)

# v3.14.0ï¼ˆè‡ªåŠ¨é›†æˆï¼‰
client = HttpClient(
    base_url="https://api.example.com",
    telemetry=telemetry,  # è‡ªåŠ¨æ·»åŠ  TelemetryMiddleware
)
```

---

## 5. UnitOfWork å˜æ›´

### 5.1 åŸºæœ¬ä½¿ç”¨

```python
# v3.x
with UnitOfWork(session_factory) as uow:
    user = uow.users.find_by_id(1)
    uow.commit()

# v3.14.0ï¼ˆå¼‚æ­¥ï¼‰
async with UnitOfWork(session_factory) as uow:
    user = uow.users.find_by_id(1)
    await uow.commit()
```

### 5.2 å¯è§‚æµ‹æ€§é›†æˆ

```python
# v3.14.0 è‡ªåŠ¨é›†æˆ Telemetry å’Œ EventBus
uow = UnitOfWork(
    session_factory=db.session_factory,
    repository_package="app.repositories",
    telemetry=telemetry,
    event_bus=event_bus,
)
```

---

## 6. äº‹ä»¶æ€»çº¿ï¼ˆæ–°å¢ï¼‰

v3.14.0 æ–°å¢äº‹ä»¶æ€»çº¿ï¼Œç”¨äºè§£è€¦ç»„ä»¶é€šä¿¡ï¼š

```python
from df_test_framework.core.events import EventBus, HttpRequestEndEvent

# åˆ›å»ºäº‹ä»¶æ€»çº¿
bus = EventBus()

# è®¢é˜…äº‹ä»¶
@bus.on(HttpRequestEndEvent)
async def log_request(event: HttpRequestEndEvent):
    print(f"{event.method} {event.url} -> {event.status_code}")

# åœ¨æ‰©å±•ä¸­ä½¿ç”¨
class MyPlugin:
    def df_event_handlers(self, event_bus):
        @event_bus.on(HttpRequestEndEvent)
        async def handle(event):
            ...
```

---

## 7. é…ç½®å˜æ›´

### 7.1 é…ç½®è·¯å¾„

```yaml
# v3.x .env
HTTP__BASE_URL=https://api.example.com
HTTP__TIMEOUT=30
HTTP__INTERCEPTORS__0__TYPE=signature
HTTP__INTERCEPTORS__0__SECRET=xxx

# v3.14.0 .env
HTTP__BASE_URL=https://api.example.com
HTTP__TIMEOUT=30
HTTP__MIDDLEWARES__0__TYPE=signature
HTTP__MIDDLEWARES__0__SECRET=xxx
```

### 7.2 é¥æµ‹é…ç½®ï¼ˆæ–°å¢ï¼‰

```yaml
# v3.14.0 .env
TELEMETRY__ENABLED=true
TELEMETRY__SERVICE_NAME=my-test-service
TELEMETRY__EXPORTER=otlp
TELEMETRY__OTLP_ENDPOINT=http://localhost:4317
```

---

## 8. æµ‹è¯•è¿ç§»

### 8.1 å¼‚æ­¥æµ‹è¯•

```python
# ç¡®ä¿å®‰è£… pytest-asyncio
# pyproject.toml
[tool.pytest.ini_options]
asyncio_mode = "auto"

# æµ‹è¯•ä»£ç 
@pytest.mark.asyncio
async def test_api(http_client):
    response = await http_client.get("/users")
    assert response.status_code == 200
```

### 8.2 fixture å˜æ›´

```python
# v3.x fixture ç­¾å
@pytest.fixture
def http_client(runtime) -> HttpClient:
    ...

# v3.14.0 fixture ç­¾åï¼ˆå¼‚æ­¥ï¼‰
@pytest.fixture
async def http_client(runtime, telemetry, event_bus) -> AsyncGenerator[HttpClient, None]:
    async with HttpClient(...) as client:
        yield client
```

---

## 9. å¿«é€Ÿè¿ç§»æ£€æŸ¥æ¸…å•

### å¿…é¡»å˜æ›´

- [ ] æ›´æ–°å¯¼å…¥è·¯å¾„ï¼ˆèƒ½åŠ›å±‚ï¼š`clients/` â†’ `capabilities/clients/`ï¼‰
- [ ] `Interceptor` â†’ `Middleware` é‡å‘½å
- [ ] è°ƒæ•´ä¸­é—´ä»¶ä¼˜å…ˆçº§å€¼ï¼ˆåè½¬ï¼‰
- [ ] å¼‚æ­¥æµ‹è¯•æ·»åŠ  `@pytest.mark.asyncio`
- [ ] `client.get()` â†’ `await client.get()` æˆ– `client.get_sync()`
- [ ] `extensions/` â†’ `plugins/`ï¼ˆæ’ä»¶å®ç°ï¼‰
- [ ] `extensions/core/` â†’ `core/plugins/`ï¼ˆæ’ä»¶ç³»ç»Ÿæ ¸å¿ƒï¼‰

### æ¨èå˜æ›´

- [ ] ä½¿ç”¨ç»Ÿä¸€ `Telemetry` æ›¿ä»£åˆ†æ•£çš„ Tracing/Metrics
- [ ] é›†æˆ `EventBus` è§£è€¦ç»„ä»¶
- [ ] ä½¿ç”¨æ´‹è‘±æ¨¡å‹é‡å†™å¤æ‚æ‹¦æˆªå™¨
- [ ] ä½¿ç”¨ `core/protocols/` å®šä¹‰æ¥å£

### é…ç½®å˜æ›´

- [ ] `INTERCEPTORS` â†’ `MIDDLEWARES`
- [ ] æ–°å¢ `TELEMETRY__*` é…ç½®

---

## 10. å¸¸è§é—®é¢˜

### Q1: æ˜¯å¦æä¾›å…¼å®¹å±‚ï¼Ÿ

A: ä¸æä¾›ã€‚v3.14.0 æ˜¯æ¶æ„é‡æ„ï¼Œå»ºè®®å®Œæ•´è¿ç§»ã€‚æ—§ä»£ç å¯ä»¥é€šè¿‡ `_compat.py` ä¸´æ—¶å¯¼å…¥ï¼Œä½†ä¼šæœ‰ deprecation warningã€‚

### Q2: åŒæ­¥ä»£ç å¦‚ä½•è¿ç§»ï¼Ÿ

A: ä½¿ç”¨ `_sync` åç¼€æ–¹æ³•ï¼š

```python
# åŒæ­¥è°ƒç”¨
response = client.get_sync("/users")
response = client.post_sync("/orders", json={...})
```

### Q3: è‡ªå®šä¹‰æ‹¦æˆªå™¨å¦‚ä½•è¿ç§»ï¼Ÿ

A: å‚è€ƒç¬¬ 2 èŠ‚ï¼Œå°† `before_request`/`after_response` åˆå¹¶åˆ° `__call__` æ–¹æ³•ã€‚

### Q4: pytest fixture å¦‚ä½•å¤„ç†å¼‚æ­¥ï¼Ÿ

A: ä½¿ç”¨ `pytest-asyncio` å¹¶é…ç½® `asyncio_mode = "auto"`ã€‚

---

## 11. è·å–å¸®åŠ©

- é—®é¢˜åé¦ˆ: [GitHub Issues](https://github.com/your-org/df-test-framework/issues)
- æ–‡æ¡£: [docs/](../README.md)
- æ¶æ„è®¾è®¡: [V3.14_ENTERPRISE_PLATFORM_DESIGN.md](../architecture/V3.14_ENTERPRISE_PLATFORM_DESIGN.md)
