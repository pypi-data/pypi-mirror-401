# v3.2 â†’ v3.3.0 è¿ç§»æŒ‡å—

> **æ›´æ–°æ—¶é—´**: 2025-11-06
> **ç›®æ ‡ç‰ˆæœ¬**: v3.3.0
> **é€‚ç”¨èŒƒå›´**: ä»v3.2æˆ–æ›´æ—©ç‰ˆæœ¬è¿ç§»åˆ°v3.3.0

---

## ğŸ“‹ æ¦‚è¿°

v3.3.0å¯¹æ‹¦æˆªå™¨æ¶æ„è¿›è¡Œäº†å®Œæ•´é‡æ„,ä¸»è¦å˜æ›´åŒ…æ‹¬:

1. **BaseAPIèŒè´£ç®€åŒ–** - æ‹¦æˆªå™¨ç»Ÿä¸€ç”±HttpClientç®¡ç†
2. **æ ‡å‡†å‘½åè§„èŒƒ** - å»é™¤ä¸šåŠ¡è€¦åˆ(AdminAuth â†’ BearerToken)
3. **é€šç”¨åè®®å±‚** - æ”¯æŒHTTP/Database/Redisç­‰å¤šç§åœºæ™¯
4. **é…ç½®ç±»é‡å‘½å** - BearerTokenInterceptorConfigæ›¿ä»£AdminAuthInterceptorConfig
5. **å¯¼å…¥è·¯å¾„å˜æ›´** - ä»auth/è¿ç§»åˆ°interceptors/

**âš ï¸ Breaking Changes**: v3.3.0ä¸å‘åå…¼å®¹v3.2åŠæ›´æ—©ç‰ˆæœ¬

---

## ğŸ”„ è¿ç§»æ­¥éª¤

### Step 1: æ›´æ–°BaseAPIåˆå§‹åŒ–

#### Before (v3.2)
```python
from df_test_framework.clients.http.rest.httpx import HttpClient, BaseAPI
from df_test_framework.clients.http.auth.signature import SignatureInterceptor

# âŒ æ—§æ–¹å¼ - åœ¨BaseAPIå±‚é…ç½®æ‹¦æˆªå™¨
client = HttpClient(base_url="http://api.example.com")
signature_interceptor = SignatureInterceptor(algorithm="md5", secret="my_secret")

class MyAPI(BaseAPI):
    pass

api = MyAPI(client, request_interceptors=[signature_interceptor])
```

#### After (v3.3.0)

**æ–¹å¼1: é…ç½®æ–‡ä»¶ (æ¨è)**
```python
from df_test_framework import FrameworkSettings, HTTPConfig
from df_test_framework.infrastructure.config.schema import SignatureInterceptorConfig

# âœ… æ–°æ–¹å¼ - é…ç½®æ–‡ä»¶å®šä¹‰æ‹¦æˆªå™¨
settings = FrameworkSettings(
    http=HTTPConfig(
        base_url="http://api.example.com",
        interceptors=[
            SignatureInterceptorConfig(
                type="signature",
                algorithm="md5",
                secret="my_secret"
            )
        ]
    )
)

client = HttpClient(base_url=settings.http.base_url, config=settings.http)
api = MyAPI(client)  # âœ… ä¸å†éœ€è¦æ‹¦æˆªå™¨å‚æ•°
```

**æ–¹å¼2: ç¼–ç¨‹å¼æ·»åŠ **
```python
from df_test_framework.clients.http.rest.httpx import HttpClient
from df_test_framework.clients.http.interceptors import SignatureInterceptor

# âœ… æ–°æ–¹å¼ - åœ¨HttpClientå±‚æ·»åŠ æ‹¦æˆªå™¨
client = HttpClient(base_url="http://api.example.com")
client.use(SignatureInterceptor(algorithm="md5", secret="my_secret"))
api = MyAPI(client)
```

---

### Step 2: æ›´æ–°é…ç½®ç±»

#### Before (v3.2)
```python
from df_test_framework.infrastructure.config.schema import (
    AdminAuthInterceptorConfig,  # âŒ æ—§åç§°
    SignatureInterceptorConfig,
)

settings = FrameworkSettings(
    http=HTTPConfig(
        interceptors=[
            AdminAuthInterceptorConfig(
                type="admin_auth",  # âŒ æ—§ç±»å‹
                username="admin",   # âŒ æ—§å­—æ®µ
                password="admin123",  # âŒ æ—§å­—æ®µ
                login_url="/admin/login"
            )
        ]
    )
)
```

#### After (v3.3.0)
```python
from df_test_framework.infrastructure.config.schema import (
    BearerTokenInterceptorConfig,  # âœ… æ–°åç§°
    SignatureInterceptorConfig,
)

settings = FrameworkSettings(
    http=HTTPConfig(
        interceptors=[
            BearerTokenInterceptorConfig(
                type="bearer_token",  # âœ… æ–°ç±»å‹
                token_source="login",  # âœ… æ–°å­—æ®µ
                login_credentials={"username": "admin", "password": "admin123"},  # âœ… å­—å…¸æ ¼å¼
                login_url="/admin/login"
            )
        ]
    )
)
```

---

### Step 3: æ›´æ–°å¯¼å…¥è·¯å¾„

#### Before (v3.2)
```python
# âŒ æ—§è·¯å¾„ - clients/http/auth/
from df_test_framework.clients.http.auth.signature import SignatureInterceptor
from df_test_framework.clients.http.auth.token import AdminAuthInterceptor
from df_test_framework.clients.http.auth.interceptors.factory import InterceptorFactory
```

#### After (v3.3.0)
```python
# âœ… æ–°è·¯å¾„ - clients/http/interceptors/
from df_test_framework.clients.http.interceptors import (
    SignatureInterceptor,
    BearerTokenInterceptor,  # æ³¨æ„é‡å‘½å
    LoggingInterceptor,
    InterceptorFactory,
)

# æˆ–å¯¼å…¥ç­¾åç­–ç•¥
from df_test_framework.clients.http.interceptors.signature import (
    MD5SortedValuesStrategy,
    SHA256SortedValuesStrategy,
    HMACSignatureStrategy,
)
```

---

### Step 4: æ›´æ–°è‡ªå®šä¹‰æ‹¦æˆªå™¨

#### Before (v3.2)
```python
from df_test_framework.clients.http.rest.httpx.base_api import (
    RequestInterceptor,  # âŒ æ—§Protocol
)

class MyInterceptor(RequestInterceptor):
    def intercept(self, method: str, url: str, **kwargs) -> dict:
        kwargs.setdefault("headers", {})
        kwargs["headers"]["X-Custom"] = "value"
        return kwargs
```

#### After (v3.3.0)
```python
from df_test_framework.clients.http.core.interceptor import BaseInterceptor
from df_test_framework.clients.http.core import Request

# âœ… ä½¿ç”¨BaseInterceptor + ä¸å¯å˜Requestå¯¹è±¡
class MyInterceptor(BaseInterceptor):
    def __init__(self, custom_value: str, priority: int = 100):
        super().__init__(name="MyInterceptor", priority=priority)
        self.custom_value = custom_value

    def before_request(self, request: Request) -> Request:
        # è¿”å›æ–°çš„Requestå¯¹è±¡(ä¸å¯å˜)
        return request.with_header("X-Custom", self.custom_value)
```

---

## ğŸ“ å¿«é€Ÿæ£€æŸ¥æ¸…å•

### ä»£ç æ£€æŸ¥
- [ ] æ£€æŸ¥æ‰€æœ‰`BaseAPI.__init__`è°ƒç”¨,ç§»é™¤`request_interceptors`å’Œ`response_interceptors`å‚æ•°
- [ ] æœç´¢`AdminAuthInterceptor`,æ›¿æ¢ä¸º`BearerTokenInterceptor`
- [ ] æœç´¢`AdminAuthInterceptorConfig`,æ›¿æ¢ä¸º`BearerTokenInterceptorConfig`
- [ ] æœç´¢`type="admin_auth"`,æ›¿æ¢ä¸º`type="bearer_token"`
- [ ] æœç´¢`username`/`password`å­—æ®µ,æ”¹ä¸º`login_credentials`å­—å…¸
- [ ] æœç´¢`from df_test_framework.clients.http.auth`,æ›¿æ¢ä¸º`.http.interceptors`
- [ ] æ£€æŸ¥è‡ªå®šä¹‰æ‹¦æˆªå™¨,ç¡®ä¿ç»§æ‰¿`BaseInterceptor`å¹¶ä½¿ç”¨ä¸å¯å˜`Request`å¯¹è±¡

### é…ç½®æ£€æŸ¥
- [ ] æ›´æ–°`settings.py`ä¸­çš„æ‹¦æˆªå™¨é…ç½®
- [ ] ç¡®ä¿æ‰€æœ‰æ‹¦æˆªå™¨é…ç½®ä½¿ç”¨æ–°çš„ç±»åå’Œå­—æ®µ
- [ ] æµ‹è¯•æ‹¦æˆªå™¨é…ç½®æ˜¯å¦æ­£ç¡®åŠ è½½

### æµ‹è¯•æ£€æŸ¥
- [ ] è¿è¡Œæ‰€æœ‰æµ‹è¯•,ç¡®ä¿æ— å¯¼å…¥é”™è¯¯
- [ ] æ£€æŸ¥æµ‹è¯•ä¸­çš„Mockå¯¹è±¡,ç¡®ä¿ä¸æ–°APIä¸€è‡´
- [ ] éªŒè¯æ‹¦æˆªå™¨åŠŸèƒ½æ­£å¸¸å·¥ä½œ

---

## ğŸ” å¸¸è§é—®é¢˜

### Q1: BaseAPI.__init__æŠ¥é”™"unexpected keyword argument 'request_interceptors'"

**åŸå› **: v3.3.0ä¸å†æ”¯æŒåœ¨BaseAPIå±‚é…ç½®æ‹¦æˆªå™¨

**è§£å†³æ–¹æ¡ˆ**:
```python
# âŒ æ—§ä»£ç 
api = MyAPI(http_client, request_interceptors=[...])

# âœ… æ–¹å¼1: é…ç½®æ–‡ä»¶
settings = FrameworkSettings(http=HTTPConfig(interceptors=[...]))
client = HttpClient(config=settings.http)
api = MyAPI(client)

# âœ… æ–¹å¼2: HttpClient.use()
client = HttpClient(...)
client.use(SignatureInterceptor(...))
api = MyAPI(client)
```

---

### Q2: å¯¼å…¥é”™è¯¯"No module named 'df_test_framework.clients.http.auth'"

**åŸå› **: auth/ç›®å½•å·²é‡å‘½åä¸ºinterceptors/

**è§£å†³æ–¹æ¡ˆ**:
```python
# âŒ æ—§å¯¼å…¥
from df_test_framework.clients.http.auth.signature import SignatureInterceptor

# âœ… æ–°å¯¼å…¥
from df_test_framework.clients.http.interceptors import SignatureInterceptor
```

---

### Q3: AdminAuthInterceptorConfigä¸å­˜åœ¨

**åŸå› **: å·²é‡å‘½åä¸ºBearerTokenInterceptorConfig

**è§£å†³æ–¹æ¡ˆ**:
```python
# âŒ æ—§é…ç½®
AdminAuthInterceptorConfig(
    type="admin_auth",
    username="admin",
    password="admin123"
)

# âœ… æ–°é…ç½®
BearerTokenInterceptorConfig(
    type="bearer_token",
    token_source="login",
    login_credentials={"username": "admin", "password": "admin123"}
)
```

---

### Q4: å¦‚ä½•åœ¨ä¸åŒAPIä½¿ç”¨ä¸åŒçš„æ‹¦æˆªå™¨?

**æ–¹æ¡ˆ1: åˆ›å»ºå¤šä¸ªHttpClientå®ä¾‹ (æ¨è)**
```python
# Admin APIä¸“ç”¨å®¢æˆ·ç«¯
admin_client = HttpClient(base_url="...", config=settings.admin_http)
admin_api = AdminAPI(admin_client)

# Master APIä¸“ç”¨å®¢æˆ·ç«¯
master_client = HttpClient(base_url="...", config=settings.master_http)
master_api = MasterAPI(master_client)
```

**æ–¹æ¡ˆ2: ä½¿ç”¨è·¯å¾„åŒ¹é…**
```python
settings = FrameworkSettings(
    http=HTTPConfig(
        interceptors=[
            SignatureInterceptorConfig(
                include_paths=["/master/**"],  # åªå¯¹masterè·¯å¾„ç­¾å
            ),
            BearerTokenInterceptorConfig(
                include_paths=["/admin/**"],  # åªå¯¹adminè·¯å¾„è®¤è¯
            )
        ]
    )
)
```

---

## ğŸ“Š APIå¯¹ç…§è¡¨

### é…ç½®ç±»

| v3.2 | v3.3.0 | è¯´æ˜ |
|------|--------|------|
| `AdminAuthInterceptorConfig` | `BearerTokenInterceptorConfig` | ç±»åæ ‡å‡†åŒ– |
| `type="admin_auth"` | `type="bearer_token"` | ç±»å‹æ ‡è¯†æ ‡å‡†åŒ– |
| `username: str` | `login_credentials: Dict` | æ›´é€šç”¨çš„å­—æ®µ |
| `password: str` | `login_credentials: Dict` | æ›´é€šç”¨çš„å­—æ®µ |

### æ‹¦æˆªå™¨ç±»

| v3.2 | v3.3.0 | è¯´æ˜ |
|------|--------|------|
| `AdminAuthInterceptor` | `BearerTokenInterceptor` | ç±»åæ ‡å‡†åŒ– |
| BaseAPIä¸­çš„`AuthTokenInterceptor` | ä½¿ç”¨æ–°çš„`BearerTokenInterceptor` | ç»Ÿä¸€å®ç° |
| BaseAPIä¸­çš„`LoggingInterceptor` | ä½¿ç”¨æ–°çš„`LoggingInterceptor` | ç»Ÿä¸€å®ç° |

### å¯¼å…¥è·¯å¾„

| v3.2 | v3.3.0 |
|------|--------|
| `clients.http.auth.signature` | `clients.http.interceptors.signature` |
| `clients.http.auth.token` | `clients.http.interceptors.auth` |
| `clients.http.auth.interceptors.factory` | `clients.http.interceptors.factory` |

### BaseAPI API

| v3.2 | v3.3.0 | è¯´æ˜ |
|------|--------|------|
| `__init__(http_client, request_interceptors, response_interceptors)` | `__init__(http_client)` | åªæ¥å—http_client |
| `add_request_interceptor()` | âŒ å·²åˆ é™¤ | ä½¿ç”¨`HttpClient.use()`æ›¿ä»£ |
| `add_response_interceptor()` | âŒ å·²åˆ é™¤ | ä½¿ç”¨`HttpClient.use()`æ›¿ä»£ |
| `_apply_request_interceptors()` | âŒ å·²åˆ é™¤ | æ‹¦æˆªå™¨åœ¨HttpClientæ‰§è¡Œ |
| `_apply_response_interceptors()` | âŒ å·²åˆ é™¤ | æ‹¦æˆªå™¨åœ¨HttpClientæ‰§è¡Œ |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [CHANGELOG.md](../../CHANGELOG.md) - v3.3.0å®Œæ•´å˜æ›´æ—¥å¿—
- [INTERCEPTOR_ARCHITECTURE.md](../INTERCEPTOR_ARCHITECTURE.md) - æ‹¦æˆªå™¨æ¶æ„è®¾è®¡æ–‡æ¡£
- [INTERCEPTOR_ARCHITECTURE_VERIFICATION.md](../INTERCEPTOR_ARCHITECTURE_VERIFICATION.md) - æ¶æ„éªŒè¯æŠ¥å‘Š
- [V3_ARCHITECTURE.md](../architecture/V3_ARCHITECTURE.md) - v3æ ¸å¿ƒæ¶æ„è®¾è®¡

---

## ğŸ’¬ è·å–å¸®åŠ©

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜:

1. **æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹**: `tests/test_interceptors_config.py` - å®Œæ•´çš„æ‹¦æˆªå™¨ä½¿ç”¨ç¤ºä¾‹
2. **æŸ¥çœ‹æ¶æ„æ–‡æ¡£**: `docs/INTERCEPTOR_ARCHITECTURE.md` - è¯¦ç»†çš„è®¾è®¡è¯´æ˜
3. **æäº¤Issue**: GitHub Issues - æŠ¥å‘Šè¿ç§»ä¸­é‡åˆ°çš„é—®é¢˜

---

**åˆ›å»ºæ—¶é—´**: 2025-11-06
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**é€‚ç”¨ç‰ˆæœ¬**: v3.3.0
