# v3.3 â†’ v3.4 è¿ç§»æŒ‡å—

> **å‘å¸ƒæ—¥æœŸ**: 2025-11-06
> **ç‰ˆæœ¬**: v3.3.x â†’ v3.4.0
> **ç±»å‹**: é‡å¤§é‡æ„ï¼ˆä¸å‘åå…¼å®¹ï¼‰

---

## ğŸ“Š å˜æ›´æ¦‚è§ˆ

v3.4.0æ˜¯ä¸€ä¸ª**å…¨æ–°è®¾è®¡ç‰ˆæœ¬**ï¼Œæ ¸å¿ƒç†å¿µæ˜¯**çº¯Pydanticå£°æ˜å¼é…ç½® + ä¸šåŠ¡é…ç½®åˆ†ç¦»**ã€‚

### âœ… æ ¸å¿ƒç‰¹æ€§

1. **è·¯å¾„è‡ªåŠ¨æ ‡å‡†åŒ–** - InterceptorConfigè‡ªåŠ¨å¤„ç†å‰å¯¼æ–œæ 
2. **login_urlè‡ªåŠ¨æ’é™¤** - BearerTokenInterceptorConfigè‡ªåŠ¨é˜²æ­¢æ— é™é€’å½’
3. **ä¸šåŠ¡é…ç½®åˆ†ç¦»** - AuthConfigç‹¬ç«‹å‡ºæ¥ï¼ŒèŒè´£æ¸…æ™°
4. **ç»„åˆæ¨¡å¼** - åœ¨ProjectSettingsä¸­ç»„åˆæ¡†æ¶å’Œä¸šåŠ¡é…ç½®
5. **Pydanticå­—æ®µç»§æ‰¿ä¿®å¤** - FrameworkSettingså­—æ®µæ”¹ä¸ºOptional

### âš ï¸ é‡å¤§å˜æ›´

- âŒ **ä¸å‘åå…¼å®¹** - v3.4.0æ˜¯å…¨æ–°è®¾è®¡ï¼Œéœ€è¦æŒ‰æœ¬æŒ‡å—è¿ç§»
- âŒ **ç§»é™¤æ‰€æœ‰å…¼å®¹ä»£ç ** - æ¸…ç†æ‰€æœ‰v2/v3.0-v3.3çš„å…¼å®¹æ€§ä»£ç 
- âœ… **å¿…é¡»è¿ç§»** - æ–°è®¾è®¡æ›´ç®€æ´ã€æ›´ç¬¦åˆç°ä»£æµ‹è¯•æ¡†æ¶æ¨¡å¼

---

## ğŸ¯ æ¨èçš„è¿ç§»æ­¥éª¤

### Step 1: åˆ›å»ºAuthConfigï¼ˆæ¨èï¼‰

**Why**: è®¤è¯é…ç½®æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å…³æ³¨ç‚¹ï¼Œåº”è¯¥ä»BusinessConfigä¸­æå–å‡ºæ¥ã€‚

```python
from pydantic import BaseModel, Field

class AuthConfig(BaseModel):
    """è®¤è¯é…ç½® - ä¸šåŠ¡çº§åˆ«"""

    # ç­¾åè®¤è¯é…ç½®
    signature_secret: str = Field(description="APIç­¾åå¯†é’¥")
    signature_algorithm: str = Field(default="md5", description="ç­¾åç®—æ³•")
    signature_header: str = Field(default="X-Sign", description="ç­¾åHeaderåç§°")

    # Bearer Tokenè®¤è¯é…ç½®
    admin_username: str = Field(description="ç®¡ç†å‘˜ç”¨æˆ·å")
    admin_password: str = Field(description="ç®¡ç†å‘˜å¯†ç ")
    admin_login_url: str = Field(default="/admin/auth/login", description="ç™»å½•æ¥å£")
    admin_token_path: str = Field(default="data.token", description="Tokenå­—æ®µè·¯å¾„")
```

---

### Step 2: æ›´æ–°BusinessConfig

**Before (v3.3)**:
```python
class BusinessConfig(BaseSettings):
    # è®¤è¯é…ç½®å’Œæµ‹è¯•æ•°æ®æ··åœ¨ä¸€èµ·
    app_secret: str
    admin_username: str
    admin_password: str
    test_user_id: str
    test_template_id: str
```

**After (v3.4)**:
```python
class BusinessConfig(BaseSettings):
    """ä¸šåŠ¡é…ç½® - æ¸…æ™°åˆ†å±‚"""

    # è®¤è¯é…ç½®ç‹¬ç«‹
    auth: AuthConfig = Field(default_factory=AuthConfig, description="è®¤è¯é…ç½®")

    # æµ‹è¯•æ•°æ®é…ç½®
    test_user_id: str = Field(default="test_user_001", description="æµ‹è¯•ç”¨æˆ·ID")
    test_template_id: str = Field(default="TMPL_001", description="æµ‹è¯•æ¨¡æ¿ID")

    model_config = SettingsConfigDict(
        env_prefix="BUSINESS_",
        env_file=".env",
    )
```

---

### Step 3: åœ¨ProjectSettingsä¸­ç»„åˆ

**Before (v3.3) - ç›´æ¥é…ç½®æ‹¦æˆªå™¨**:
```python
class ProjectSettings(FrameworkSettings):
    def __init__(self, **data):
        if 'http' not in data:
            data['http'] = HTTPConfig(
                base_url=os.getenv("APP_HTTP__BASE_URL"),
                interceptors=[
                    SignatureInterceptorConfig(
                        type="signature",
                        secret=os.getenv("BUSINESS_APP_SECRET"),
                        include_paths=["master/**"],  # âš ï¸ æ— å‰å¯¼æ–œæ 
                    ),
                    BearerTokenInterceptorConfig(
                        type="bearer_token",
                        login_url="/admin/auth/login",
                        username=os.getenv("ADMIN_USER"),
                        password=os.getenv("ADMIN_PASS"),
                        include_paths=["admin/**"],
                        exclude_paths=["admin/auth/login"],  # âš ï¸ æ‰‹åŠ¨æ’é™¤
                    ),
                ]
            )
        super().__init__(**data)
```

**After (v3.4) - ä½¿ç”¨ç»„åˆæ¨¡å¼**:
```python
from pydantic import model_validator

class ProjectSettings(FrameworkSettings):
    """é¡¹ç›®é…ç½® - é›†æˆå±‚"""

    # ä¸šåŠ¡é…ç½®
    business: BusinessConfig = Field(default_factory=BusinessConfig)

    @model_validator(mode='after')
    def setup_http_interceptors(self) -> 'ProjectSettings':
        """ç»„åˆæ¡†æ¶å’Œä¸šåŠ¡é…ç½®

        ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œ:
        1. æ¡†æ¶å±‚(HTTPConfig)ä¸çŸ¥é“ä¸šåŠ¡è§„åˆ™
        2. ä¸šåŠ¡å±‚(BusinessConfig)ä¸ä¾èµ–æ¡†æ¶
        3. é›†æˆå±‚(ProjectSettings)è´Ÿè´£"ç¿»è¯‘"

        ç¬¦åˆç°ä»£æ¡†æ¶æ¨¡å¼:
        - Pytest: conftest.pyç»„åˆfixtures
        - Spring: @BeforeEachç»„è£…é…ç½®
        - Playwright: setup.tsç»„åˆconfig
        """
        if not self.http.interceptors:
            auth = self.business.auth

            self.http.interceptors = [
                # ç­¾åæ‹¦æˆªå™¨
                SignatureInterceptorConfig(
                    type="signature",
                    priority=10,
                    algorithm=auth.signature_algorithm,
                    secret=auth.signature_secret,
                    header_name=auth.signature_header,
                    include_paths=["/master/**", "/h5/**"],  # âœ… è‡ªåŠ¨æ ‡å‡†åŒ–
                    exclude_paths=["/health", "/actuator/**"],
                ),
                # Bearer Tokenæ‹¦æˆªå™¨
                BearerTokenInterceptorConfig(
                    type="bearer_token",
                    priority=20,
                    token_source="login",
                    login_url=auth.admin_login_url,  # âœ… è‡ªåŠ¨æ’é™¤
                    login_credentials={
                        "username": auth.admin_username,
                        "password": auth.admin_password,
                    },
                    token_field_path=auth.admin_token_path,
                    include_paths=["/admin/**"],
                ),
            ]

        return self
```

---

### Step 4: æ›´æ–°ç¯å¢ƒå˜é‡ï¼ˆæ¨èï¼‰

**Before (v3.3)**:
```bash
BUSINESS_APP_SECRET=xxx
BUSINESS_ADMIN_USERNAME=admin
BUSINESS_ADMIN_PASSWORD=admin123
```

**After (v3.4) - æ›´æ¸…æ™°çš„å±‚çº§**:
```bash
BUSINESS_AUTH__SIGNATURE_SECRET=xxx
BUSINESS_AUTH__ADMIN_USERNAME=admin
BUSINESS_AUTH__ADMIN_PASSWORD=admin123
BUSINESS_TEST_USER_ID=test_user_001
```

**ä¼˜åŠ¿**: ç¯å¢ƒå˜é‡åç§°æ›´ç›´è§‚ï¼Œä¸€çœ‹å°±çŸ¥é“æ˜¯è®¤è¯é…ç½®ã€‚

---

## âœ… æ–°ç‰¹æ€§è¯¦è§£

### 1. è·¯å¾„è‡ªåŠ¨æ ‡å‡†åŒ–

**Before (v3.3)**:
```python
include_paths=["master/**"]  # âœ… å·¥ä½œ
include_paths=["/master/**"]  # âŒ ä¸åŒ¹é…ï¼
```

**After (v3.4)**:
```python
include_paths=["/master/**"]  # âœ… å·¥ä½œï¼ˆæ¨èï¼‰
include_paths=["master/**"]   # âœ… ä¹Ÿå·¥ä½œ
```

**å®ç°**: `InterceptorConfig.normalize_paths()` validatorè‡ªåŠ¨æ ‡å‡†åŒ–è·¯å¾„ã€‚

---

### 2. login_urlè‡ªåŠ¨æ’é™¤

**Before (v3.3)**:
```python
BearerTokenInterceptorConfig(
    login_url="/admin/auth/login",
    include_paths=["admin/**"],
    exclude_paths=["admin/auth/login"],  # âš ï¸ å¿…é¡»æ‰‹åŠ¨æ’é™¤
)
```

**After (v3.4)**:
```python
BearerTokenInterceptorConfig(
    login_url="/admin/auth/login",
    include_paths=["admin/**"],
    # âœ… login_urlè‡ªåŠ¨æ·»åŠ åˆ°exclude_paths
)
```

**å®ç°**: `BearerTokenInterceptorConfig.validate_and_auto_exclude_login_url()` validatorè‡ªåŠ¨æ’é™¤ã€‚

---

### 3. ä¸šåŠ¡é…ç½®åˆ†ç¦»

**è®¾è®¡ç†å¿µ**:
- `HTTPConfig`: åªå…³å¿ƒHTTPä¼ è¾“ï¼ˆtimeout, retry, è¿æ¥æ± ï¼‰
- `AuthConfig`: åªå…³å¿ƒè®¤è¯æ•°æ®ï¼ˆå¯†é’¥ã€è´¦å·ï¼‰
- `ProjectSettings`: ç»„åˆä¸¤è€…

**é…ç½®ç»“æ„**:
```python
ProjectSettings
â”œâ”€â”€ http: HTTPConfig (æ¡†æ¶å±‚)
â”‚   â”œâ”€â”€ base_url
â”‚   â”œâ”€â”€ timeout
â”‚   â””â”€â”€ interceptors: []  # ç©ºï¼Œç”±setup_http_interceptorså¡«å……
â””â”€â”€ business: BusinessConfig (ä¸šåŠ¡å±‚)
    â”œâ”€â”€ auth: AuthConfig
    â”‚   â”œâ”€â”€ signature_secret
    â”‚   â””â”€â”€ admin_username
    â””â”€â”€ test_user_id
```

---

### 4. Pydanticå­—æ®µç»§æ‰¿ä¿®å¤

**é—®é¢˜**: å­ç±»çš„Fieldæ— æ³•è¦†ç›–çˆ¶ç±»çš„Field

**ä¿®å¤**: FrameworkSettingsçš„å­—æ®µæ”¹ä¸ºOptional
```python
class FrameworkSettings(BaseSettings):
    http: Optional[HTTPConfig] = Field(default_factory=HTTPConfig)
    db: Optional[DatabaseConfig] = Field(default_factory=DatabaseConfig)
    # ...
```

**å¥½å¤„**: å­ç±»å¯ä»¥ä½¿ç”¨`@model_validator`è‡ªå®šä¹‰é…ç½®ã€‚

---

## ğŸ§ª éªŒè¯è¿ç§»

### 1. è¿è¡Œç°æœ‰æµ‹è¯•

```bash
# v3.4ä¸å‘åå…¼å®¹ï¼Œéœ€è¦å…ˆå®Œæˆè¿ç§»å†è¿è¡Œæµ‹è¯•
pytest tests/
```

### 2. éªŒè¯é…ç½®åŠ è½½

```python
from your_project.config.settings import ProjectSettings

settings = ProjectSettings()

# éªŒè¯AuthConfig
print(f"Authé…ç½®: {settings.business.auth}")
print(f"ç­¾åå¯†é’¥: {settings.business.auth.signature_secret}")

# éªŒè¯æ‹¦æˆªå™¨
print(f"æ‹¦æˆªå™¨æ•°é‡: {len(settings.http.interceptors)}")
for interceptor in settings.http.interceptors:
    print(f"  - {interceptor.type}: {interceptor.include_paths}")

# éªŒè¯åºåˆ—åŒ–
config_dict = settings.model_dump()
print(f"å¯åºåˆ—åŒ–: {len(config_dict) > 0}")
```

### 3. éªŒè¯è·¯å¾„æ ‡å‡†åŒ–

```python
# æµ‹è¯•å‰å¯¼æ–œæ æ”¯æŒ
settings = ProjectSettings(
    business=BusinessConfig(
        auth=AuthConfig(signature_secret="test")
    )
)

# æ‹¦æˆªå™¨è·¯å¾„åº”è¯¥è‡ªåŠ¨æ ‡å‡†åŒ–ä¸º /master/**
assert settings.http.interceptors[0].include_paths[0] == "/master/**"
```

---

## ğŸ“š å®Œæ•´ç¤ºä¾‹

å‚è€ƒé¡¹ç›®: `gift-card-test`

```python
# src/gift_card_test/config/settings.py

from pydantic import BaseModel, Field, model_validator
from pydantic_settings import BaseSettings, SettingsConfigDict
from df_test_framework import FrameworkSettings
from df_test_framework.infrastructure.config import (
    SignatureInterceptorConfig,
    BearerTokenInterceptorConfig,
)

class AuthConfig(BaseModel):
    """è®¤è¯é…ç½®"""
    signature_secret: str = Field(default="default_secret")
    signature_algorithm: str = Field(default="md5")
    admin_username: str = Field(default="admin")
    admin_password: str = Field(default="admin123")
    admin_login_url: str = Field(default="/admin/auth/login")

class BusinessConfig(BaseSettings):
    """ä¸šåŠ¡é…ç½®"""
    auth: AuthConfig = Field(default_factory=AuthConfig)
    test_user_id: str = Field(default="test_user_001")

    model_config = SettingsConfigDict(
        env_prefix="BUSINESS_",
        env_file=".env",
    )

class GiftCardSettings(FrameworkSettings):
    """é¡¹ç›®é…ç½®"""
    business: BusinessConfig = Field(default_factory=BusinessConfig)

    @model_validator(mode='after')
    def setup_http_interceptors(self):
        if not self.http.interceptors:
            auth = self.business.auth
            self.http.interceptors = [
                SignatureInterceptorConfig(
                    type="signature",
                    priority=10,
                    secret=auth.signature_secret,
                    algorithm=auth.signature_algorithm,
                    include_paths=["/master/**", "/h5/**"],
                ),
                BearerTokenInterceptorConfig(
                    type="bearer_token",
                    priority=20,
                    token_source="login",
                    login_url=auth.admin_login_url,
                    login_credentials={
                        "username": auth.admin_username,
                        "password": auth.admin_password,
                    },
                    include_paths=["/admin/**"],
                ),
            ]
        return self
```

---

## ğŸ¯ è¿ç§»æ£€æŸ¥æ¸…å•

- [ ] åˆ›å»º`AuthConfig`ç±»
- [ ] æ›´æ–°`BusinessConfig`åŒ…å«`auth: AuthConfig`
- [ ] åœ¨`ProjectSettings`ä¸­æ·»åŠ `@model_validator(mode='after')`
- [ ] åœ¨validatorä¸­è®¾ç½®`http.interceptors`
- [ ] æ›´æ–°ç¯å¢ƒå˜é‡å‘½åï¼ˆå¯é€‰ï¼‰
- [ ] è¿è¡Œæµ‹è¯•éªŒè¯
- [ ] æ£€æŸ¥æ—¥å¿—ç¡®è®¤æ‹¦æˆªå™¨åŠ è½½

---

## ğŸ“– å‚è€ƒæ–‡æ¡£

- **æœ€ä½³å®è·µ**: `docs/INTERCEPTOR_CONFIG_BEST_PRACTICES.md`
- **æ¶æ„è®¾è®¡**: `docs/architecture/V3_ARCHITECTURE.md`
- **å®Œæ•´ç¤ºä¾‹**: `gift-card-test/src/gift_card_test/config/settings.py`

---

## ğŸ“ æ€»ç»“

v3.4.0çš„æ ¸å¿ƒç†å¿µ:

1. **çº¯Pydantic** - å£°æ˜å¼é…ç½®ï¼Œç±»å‹å®‰å…¨ï¼Œå¯åºåˆ—åŒ–
2. **ä¸šåŠ¡é…ç½®åˆ†ç¦»** - AuthConfigç‹¬ç«‹ï¼ŒèŒè´£æ¸…æ™°
3. **ç»„åˆæ¨¡å¼** - åœ¨ProjectSettingsä¸­ç»„åˆæ¡†æ¶å’Œä¸šåŠ¡
4. **ç¬¦åˆç°ä»£æ¡†æ¶** - Pytest/Spring/Playwrightæ¨¡å¼
5. **ç§»é™¤æ‰€æœ‰å…¼å®¹ä»£ç ** - æ›´ç®€æ´çš„ä»£ç åº“

**è¿ç§»æ—¶é—´**: 15-30åˆ†é’Ÿ
**å‘åå…¼å®¹**: âŒ ä¸å…¼å®¹ï¼ˆå…¨æ–°è®¾è®¡ï¼‰
**æ¨èå‡çº§**: â­â­â­â­â­
