# Deep-Thinking MCP 思考流程可视化

> **补充文档**: 与 WORKFLOW_MECHANISM.md 配合阅读
> **目的**: 通过图表直观展示思考步骤推进机制

---

## 一、核心交互模式

### 1.1 三方协作图

```
┌────────────────────────────────────────────────────────────────────────────┐
│                            用户问题                                      │
│                    "分析2026年全球黄金价格"                              │
└───────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         Claude AI (决策中心)                               │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │  1. 分析问题复杂度                                                    │ │
│  │     - 简单问题 → 2-3步                                               │ │
│  │     - 中等问题 → 5-8步                                               │ │
│  │     - 复杂问题 → 10+步                                              │ │
│  │     - 超复杂问题 → 使用 needsMoreThoughts 扩展                      │ │
│  ├──────────────────────────────────────────────────────────────────────┤ │
│  │  2. 决定思考策略                                                      │ │
│  │     - 自由思考模式 → 完全自主决定                                     │ │
│  │     - 模板引导模式 → 使用 apply_template 参考框架                    │ │
│  ├──────────────────────────────────────────────────────────────────────┤ │
│  │  3. 执行思考步骤                                                      │ │
│  │     - 调用 sequential_thinking 工具                                   │ │
│  │     - 每次调用传入当前思考内容                                         │ │
│  │     - 决定 nextThoughtNeeded (true/false)                            │ │
│  ├──────────────────────────────────────────────────────────────────────┤ │
│  │  4. 动态调整                                                          │ │
│  │     - 发现思考不足 → needsMoreThoughts=true                          │ │
│  │     - 总步数自动 +10，上限 1000                                       │ │
│  ├──────────────────────────────────────────────────────────────────────┤ │
│  │  5. 判断完成                                                          │ │
│  │     - nextThoughtNeeded=false → 标记完成                               │ │
│  │     - 生成最终答案                                                    │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                    Deep-Thinking MCP (工具提供者)                         │
│                                                                            │
│  ┌──────────────────────────────────────────────────────────────────────┐ │
│  │  提供的工具:                                                            │ │
│  │  • sequential_thinking  - 执行单步思考                                 │ │
│  │  • create_session       - 创建思考容器                                  │ │
│  │  • get_session          - 查看会话内容                                  │ │
│  │  • resume_session       - 断点续传                                      │ │
│  │  • apply_template       - 应用思考模板                                  │ │
│  │  • update_session_status - 更新状态                                     │ │
│  │  • visualize_session    - 可视化展示                                   │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                                                            │
│  ❌ 不做的事:                                                               │
│  • 不决定使用多少思考步骤                                                   │
│  • 不判断问题复杂度                                                         │
│  • 不干预 AI 的决策                                                         │
└───────────────────────────────────┬────────────────────────────────────────┘
                                    │
                                    ▼
┌────────────────────────────────────────────────────────────────────────────┐
│                         存储层 (持久化)                                   │
│                                                                            │
│  ./Deep-Thinking-MCP/sessions/{session_id}.json                           │
│  {                                                                        │
│    "session_id": "9408db80-...",                                           │
│    "name": "2026年黄金价格分析",                                            │
│    "thoughts": [                                                           │
│      {"thought_number": 1, "content": "宏观经济..."},                       │
│      {"thought_number": 2, "content": "地缘政治..."},                       │
│      ... (共8个思考步骤)                                                    │
│    ]                                                                       │
│  }                                                                        │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、思考步骤推进的时序图

### 2.1 标准流程（8步思考）

```
时间轴 ────────────────────────────────────────────────────────────────►

用户: "分析2026年黄金价格"
  │
  ▼
AI: 分析问题 → 决定使用8步思考
  │
  ├─────────────────────────────────────────────────────────┐
  │                                                          │
  │  Step 1:宏观经济分析                                     │
  │  ├─ AI: sequential_thinking(                             │
  │  │     thought="分析宏观经济因素...",                    │
  │  │     thoughtNumber=1,                                  │
  │  │     totalThoughts=8,                                  │
  │  │     nextThoughtNeeded=true                            │
  │  │   )                                                   │
  │  └─ MCP: 保存到文件                                      │
  │                                                          │
  │  Step 2:地缘政治分析                                     │
  │  ├─ AI: sequential_thinking(                             │
  │  │     thought="分析地缘政治...",                        │
  │  │     thoughtNumber=2,                                  │
  │  │     nextThoughtNeeded=true                            │
  │  │   )                                                   │
  │  └─ MCP: 保存到文件                                      │
  │                                                          │
  │  ... (Step 3-7)                                          │
  │                                                          │
  │  Step 8:综合结论                                          │
  │  ├─ AI: sequential_thinking(                             │
  │  │     thought="综合以上分析...",                        │
  │  │     thoughtNumber=8,                                  │
  │  │     nextThoughtNeeded=false  ✅ 完成                  │
  │  │   )                                                   │
  │  └─ MCP: 标记会话为 completed                            │
  │                                                          │
  └─────────────────────────────────────────────────────────┘
  │
  ▼
AI: 生成最终答案 (整合8步思考内容)
```

### 2.2 动态扩展示例

```
原计划: 5步思考
实际需要: 12步

Step 1-4: 按计划进行
  │
  ▼
Step 5: 发现新的分析维度
  ├─ AI: sequential_thinking(
  │     thought="发现还需要考虑市场因素...",
  │     thoughtNumber=5,
  │     totalThoughts=5,
  │     needsMoreThoughts=true  🔑 请求扩展
  │   )
  │
  ▼
MCP: 自动调整 totalThoughts: 5 → 15
  │
  ▼
Step 6-15: 继续深入分析
  │
  ▼
Step 12: AI 认为已经充分
  └─ nextThoughtNeeded=false ✅
```

---

## 三、不同复杂度问题的处理模式

### 3.1 简单问题（2-3步）

```
┌─────────────────────────────────────────────────────────────┐
│  用户: "如何反转Python字符串?"                              │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  AI 判断: 简单问题 → totalThoughts=2                       │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────┴──────────────────┐
        │                                     │
        ▼                                     ▼
┌───────────────┐                    ┌───────────────┐
│ Step 1:       │                    │ Step 2:       │
│ 介绍多种方法   │                    │ 推荐最佳方案   │
└───────────────┘                    └───────────────┘
        │                                     │
        └──────────────────┬──────────────────┘
                           ▼
                ┌───────────────────────┐
                │ 生成完整答案 (2步)    │
                └───────────────────────┘
```

### 3.2 中等问题（5-8步）

```
┌─────────────────────────────────────────────────────────────┐
│  用户: "比较React和Vue的优劣"                               │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  AI 判断: 中等问题 → totalThoughts=6                       │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────┬──────────┬──────────┬──────────┐
        ▼          ▼          ▼          ▼          ▼
┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐  ┌─────┐
│Step│  │Step│  │Step│  │Step│  │Step│  │Step│
│ 1  │  │ 2  │  │ 3  │  │ 4  │  │ 5  │  │ 6  │
│理解│  │对比│  │生态│  │性能│  │学习│  │建议│
└─────┘  └─────┘  └─────┘  └─────┘  └─────┘  └─────┘
        │          │          │          │          │
        └──────────┴──────────┴──────────┴──────────┘
                           ▼
                ┌───────────────────────┐
                │  生成完整答案 (6步)   │
                └───────────────────────┘
```

### 3.3 复杂问题（10+步，可能动态扩展）

```
┌─────────────────────────────────────────────────────────────┐
│  用户: "设计一个高可用分布式系统架构"                       │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│  AI 判断: 复杂问题 → totalThoughts=15                      │
└─────────────────────────────────────────────────────────────┘
                           │
        ┌──────────────────────────────────────────────┐
        │                                             │
        ▼                                             ▼
┌───────────────┐                              ┌───────────────┐
│ Step 1-10:   │                              │ Step 11:     │
│ 基础架构设计  │                              │ 发现需要考虑 │
│              │                              │ 容灾备份     │
└───────────────┘                              │ needsMoreTh-│
                                               │ oughts=true  │
                                               └───────────────┘
                                                       │
                                                       ▼
                                        ┌───────────────────────────┐
                                        │ totalThoughts: 15 → 25   │
                                        │ (自动扩展 +10步)           │
                                        └───────────────────────────┘
                                                       │
        ┌──────────────────────────────────────────────────┤
        │                                                  ▼
        ▼                                        ┌───────────────┐
┌───────────────┐                              │ Step 12-20:  │
│ Step 11-15:   │                              │ 深入分析     │
│ 继续设计      │                              │ 容灾、监控... │
└───────────────┘                              └───────────────┘
        │                                                  │
        │                                                  ▼
        │                                        ┌───────────────┐
        │                                        │ Step 21:      │
        │                                        │ 再次发现需要 │
        │                                        │ 考虑安全     │
        │                                        │ needsMoreTh- │
        │                                        │ oughts=true  │
        │                                        └───────────────┘
        │                                                  │
        │                                                  ▼
        │                                        ┌───────────────────────────┐
        │                                        │ totalThoughts: 25 → 35   │
        │                                        └───────────────────────────┘
        │                                                  │
        ▼                                                  ▼
┌───────────────┐                              ┌───────────────┐
│ Step 16-25:   │                              │ Step 26-35:   │
│ 深入设计      │                              │ 继续深入     │
└───────────────┘                              └───────────────┘
        │                                                  │
        └──────────────────────────────────────────────────┘
                                                           │
                                                           ▼
                                                ┌───────────────────────────┐
                                                │ Step 30:                   │
                                                │ 认为已经充分               │
                                                │ nextThoughtNeeded=false ✅│
                                                └───────────────────────────┘
```

---

## 四、参数决策树

### 4.1 AI 如何决定参数

```
用户提问
    │
    ▼
┌─────────────────────────────────────┐
│  问题复杂度分析                      │
└──────────────┬──────────────────────┘
               │
     ┌─────────┼─────────┬─────────┐
     │         │         │         │
     ▼         ▼         ▼         ▼
  简单问题    中等问题    复杂问题   超复杂问题
  (定义清晰)  (需多维度)  (需深入)  (不确定)
     │         │         │         │
     ▼         ▼         ▼         ▼
totalThoughts totalThoughts totalThoughts totalThoughts
   = 2-3       = 5-8       = 10-15    = 5-10
                                   │
                                   ▼
                          ┌─────────────────────┐
                          │ 开始思考后动态调整  │
                          │ needsMoreThoughts  │
                          └─────────────────────┘
```

### 4.2 nextThoughtNeeded 决策流程

```
当前思考步骤完成
    │
    ▼
┌─────────────────────────────────────────┐
│  问题: 是否需要继续思考?                │
└────────────┬────────────────────────────┘
             │
    ┌────────┼────────┐
    │        │        │
    ▼        ▼        ▼
  已完成   需继续   不确定
    │        │        │
    │        ▼        ▼
    │   继续下一步  评估中
    │        │        │
    │        ▼        ▼
    │   nextThought-  nextThought-
    │   Needed=true  Needed=true
    │                 (继续观察)
    ▼
nextThought-
Needed=false
(标记完成)
```

---

## 五、数据流转图

### 5.1 单次 sequential_thinking 调用

```
┌─────────────────────────────────────────────────────────────┐
│ 1. AI 调用工具                                                │
│                                                              │
│  sequential_thinking(                                       │
│    thought="分析宏观经济因素...",                             │
│    thoughtNumber=1,                                          │
│    totalThoughts=8,                                          │
│    session_id="9408db80-...",                                │
│    nextThoughtNeeded=True                                    │
│  )                                                           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 2. Deep-Thinking MCP 处理                                     │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 2.1 获取或创建会话                                     │ │
│  │     manager = get_storage_manager()                   │ │
│  │     session = manager.get_session(session_id)          │ │
│  │     if not exists: create_session()                    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 2.2 处理 needsMoreThoughts (如果需要)                  │ │
│  │     if needsMoreThoughts:                              │ │
│  │         new_total = min(totalThoughts + 10, 1000)     │ │
│  │         记录调整历史到 metadata                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 2.3 创建 Thought 对象                                  │ │
│  │     thought_obj = Thought(                             │ │
│  │         thought_number=1,                              │ │
│  │         content="分析宏观经济因素...",                  │ │
│  │         type="regular",                                │ │
│  │         timestamp=now()                                │ │
│  │     )                                                  │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 2.4 添加到会话                                          │ │
│  │     session.add_thought(thought_obj)                   │ │
│  │     manager.update_session(session)                    │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ 2.5 构建返回结果                                        │ │
│  │     result = f"## 思考步骤 1/8\n\n..."               │ │
│  │     if nextThoughtNeeded:                             │ │
│  │         result += "➡️ 继续下一步思考..."              │ │
│  │     else:                                             │ │
│  │         result += "✅ 思考完成！"                     │ │
│  │         session.mark_completed()                      │ │
│  └────────────────────────────────────────────────────────┘ │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 3. 持久化到文件                                               │
│                                                              │
│  ./Deep-Thinking-MCP/sessions/9408db80-...json              │
│  {                                                           │
│    "session_id": "9408db80-...",                             │
│    "thoughts": [                                            │
│      {                                                       │
│        "thought_number": 1,                                 │
│        "content": "分析宏观经济因素...",                     │
│        "timestamp": "2026-01-01T08:11:40Z"                   │
│      }                                                       │
│    ]                                                        │
│  }                                                           │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│ 4. 返回结果给 AI                                             │
│                                                              │
│  "## 思考步骤 1/8                                           │
│                                                              │
│  **类型**: 常规思考 💭                                         │
│                                                              │
│  分析宏观经济因素...                                         │
│                                                              │
│  ---                                                         │
│  **会话信息**:                                               │
│  - 会话ID: 9408db80-...                                     │
│  - 总思考数: 1                                               │
│  - 预计总数: 8                                               │
│                                                              │
│  ➡️ 继续下一步思考..."                                        │
└─────────────────────────────────────────────────────────────┘
                           │
                           ▼
                    AI 根据返回结果继续下一步
```

---

## 六、状态机图

### 6.1 思考会话状态转换

```
                    ┌─────────────┐
                    │   created   │ (创建时)
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │    active   │ ◄──────────────┐
                    │  (进行中)    │                │
                    └──────┬──────┘                │
                           │                         │
          ┌────────────────┼────────────────┐         │
          │                │                │         │
          │                │                │         │
    ┌─────▼─────┐    ┌─────▼─────┐    ┌─────▼─────┐ │
    │添加思考   │    │查看会话   │    │恢复会话   │ │
    │(continue) │    │(get)     │    │(resume)  │ │
    │           │    │           │    │           │ │
    │nextThought-│    │           │    │           │ │
    │Needed=true│    │           │    │           │ │
    └─────┬─────┘    └───────────┘    └───────────┘ │
          │                                         │
          │                ┌─────────────────┐ │
          │                │ nextThoughtNeeded=│ │
          │                │ false           │ │
          │                └────────┬────────┘ │
          │                         │          │
          ▼                         ▼          │
    ┌─────────────┐         ┌─────────────┐   │
    │  completed  │         │  completed  │   │
    │  (已完成)   │         │  (已完成)   │◄──┘
    └──────┬──────┘         └─────────────┘
           │
           │ (手动操作)
           ▼
    ┌─────────────┐
    │  archived   │ (归档)
    └─────────────┘
```

---

## 七、思考类型可视化

### 7.1 三种思考类型

```
常规思考 (Regular):
┌───┐   ┌───┐   ┌───┐   ┌───┐
│ 1 │ → │ 2 │ → │ 3 │ → │ 4 │
└───┘   └───┘   └───┘   └───┘


修订思考 (Revision):
┌───┐   ┌───┐   ┌───┐   ┌───┐
│ 1 │ → │ 2 │ → │ 3 │ → │ 4 │
└───┘   └───┘   └───┘   └───┘
                    ↑
              ┌───────┘
         ┌────┴─────┐
         │  2' (修订)│
         └──────────┘


分支思考 (Branch):
┌───┐   ┌───┐   ┌─────────┐
│ 1 │ → │ 2 │ → │ 3 (分支)│
└───┘   └───┘   └────┬────┘
                    │
         ┌────────────┴────────────┐
         │                         │
    ┌────▼────┐              ┌─────▼─────┐
    │Branch A │              │ Branch B  │
    │3-A → 4-A│              │3-B → 4-B │
    └─────────┘              └──────────┘
```

---

## 八、总结图

### 8.1 核心机制

```
┌─────────────────────────────────────────────────────────────────┐
│                                                               │
│   用户提问                                                    │
│       │                                                       │
│       ▼                                                       │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  Claude AI (智能决策)                              │    │
│   │                                                     │    │
│   │  • 分析问题复杂度                                   │    │
│   │  • 决定 totalThoughts                              │    │
│   │  • 生成每步思考内容                                 │    │
│   │  • 判断 nextThoughtNeeded                          │    │
│   │  • 需要时设置 needsMoreThoughts                     │    │
│   │                                                     │    │
│   └──────────────────────┬──────────────────────────────┘    │
│                          │                                    │
│                          ▼                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  Deep-Thinking MCP (工具支持)                      │    │
│   │                                                     │    │
│   │  • sequential_thinking 工具                         │    │
│   │  • 会话管理 (创建/查询/更新)                        │    │
│   │  • 数据持久化 (JSON文件存储)                        │    │
│   │  • 状态管理 (active/completed/archived)              │    │
│   │                                                     │    │
│   └──────────────────────┬──────────────────────────────┘    │
│                          │                                    │
│                          ▼                                    │
│   ┌─────────────────────────────────────────────────────┐    │
│   │  本地存储                                             │    │
│   │                                                     │    │
│   │  ./.Deep-Thinking-MCP/sessions/*.json               │    │
│   │                                                     │    │
│   └─────────────────────────────────────────────────────┘    │
│                                                               │
│   返回完整答案给用户                                            │
│                                                               │
└───────────────────────────────────────────────────────────────┘
```

### 8.2 关键要点

```
┌─────────────────────────────────────────────────────────────┐
│  关键认知                                                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  1. AI 完全自主                                                │
│     ✓ Claude AI 决定使用多少思考步骤                           │
│     ✓ Deep-Thinking MCP 不干预决策                              │
│                                                               │
│  2. 参数由 AI 控制                                             │
│     ✓ totalThoughts: AI 根据问题复杂度估算                       │
│     ✓ nextThoughtNeeded: AI 决定是否继续                         │
│     ✓ needsMoreThoughts: AI 按需扩展                            │
│                                                               │
│  3. 动态调整能力                                               │
│     ✓ 发现步数不够 → needsMoreThoughts=true                    │
│     ✓ 自动 +10 步，上限 1000 步                                 │
│                                                               │
│  4. 数据持久化                                                 │
│     ✓ 每步自动保存                                             │
│     ✓ 支持断点续传                                             │
│     ✓ 会话独立管理                                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

> **文档说明**: 本文档通过图表直观展示 Deep-Thinking MCP 的思考流程，建议与 WORKFLOW_MECHANISM.md 配合阅读。
