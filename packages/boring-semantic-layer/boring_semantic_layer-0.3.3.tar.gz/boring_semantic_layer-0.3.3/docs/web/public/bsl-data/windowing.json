{
  "markdown": "# Window Functions\n\nPerform calculations across ordered rows using window functions like running totals, moving averages, rank, lag/lead, and more. Window functions operate on query results after aggregation, enabling powerful comparative and analytical operations.\n\n## Overview\n\nWindow functions allow you to:\n\n- **Compare rows**: Calculate differences between current and previous rows (lag/lead)\n- **Running calculations**: Compute cumulative sums and running averages\n- **Ranking**: Assign ranks, row numbers, and percentiles\n- **Moving windows**: Calculate metrics over sliding time windows\n\n<note type=\"info\">\nWindow functions in BSL are applied using Ibis window operations on aggregated results. They execute logically after the aggregation stage.\n</note>\n\n## Setup\n\nCreate a synthetic sales dataset with daily revenue data:\n\n```setup_data\nimport ibis\nfrom ibis import _\nfrom datetime import datetime, timedelta\nimport random\n\n# Create daily sales data spanning 90 days\nstart_date = datetime(2024, 1, 1)\ndates = [start_date + timedelta(days=i) for i in range(90)]\n\n# Generate synthetic revenue with upward trend and weekly patterns\nrandom.seed(42)\n\nrevenue_values = []\nfor i, date in enumerate(dates):\n    # Base trend: increasing over time\n    base = 1000 + (i * 10)\n\n    # Weekly pattern: weekends have higher sales\n    weekday_multiplier = 1.3 if date.weekday() >= 5 else 1.0\n\n    # Random variation\n    noise = random.uniform(-100, 100)\n\n    revenue = base * weekday_multiplier + noise\n    revenue_values.append(round(revenue, 2))\n\n# Create table\nsales_data = ibis.memtable({\n    \"sale_date\": dates,\n    \"revenue\": revenue_values,\n    \"product_category\": [\"Electronics\" if i % 3 == 0 else \"Clothing\" if i % 3 == 1 else \"Home\" for i in range(90)],\n})\n```\n\n<collapsedcodeblock code-block=\"setup_data\" title=\"Setup: Create Daily Sales Data\"></collapsedcodeblock>\n\n```setup_st\nfrom boring_semantic_layer import to_semantic_table\n\n# Create semantic table with measures\nsales_st = to_semantic_table(\n    sales_data,\n    name=\"daily_sales\"\n).with_measures(\n    total_revenue=lambda t: t.revenue.sum(),\n    avg_revenue=lambda t: t.revenue.mean(),\n    sale_count=lambda t: t.count(),\n)\n```\n\n<collapsedcodeblock code-block=\"setup_st\" title=\"Setup: Define Semantic Table\"></collapsedcodeblock>\n\n## Lag and Lead: Comparing to Previous/Next Rows\n\nCalculate period-over-period changes by comparing current values to previous rows:\n\n```query_lag_lead\nfrom ibis import _\n\n# Aggregate daily revenue\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# Add window functions for lag/lead\nresult = daily_revenue.mutate(\n    prev_day_revenue=_.total_revenue.lag(),\n    next_day_revenue=_.total_revenue.lead(),\n    day_over_day_change=_.total_revenue - _.total_revenue.lag(),\n    pct_change=((_.total_revenue - _.total_revenue.lag()) / _.total_revenue.lag() * 100).round(2)\n).limit(10)\n```\n\n<bslquery code-block=\"query_lag_lead\"></bslquery>\n\n<note type=\"info\">\n`lag()` accesses the previous row's value, while `lead()` accesses the next row's value. The first row's lag and last row's lead will be null.\n</note>\n\n## Running Totals: Cumulative Calculations\n\nCompute running sums to track cumulative metrics over time:\n\n```query_running_total\nfrom ibis import _\n\n# Daily revenue with cumulative total\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# Calculate cumulative sum and running average\nwindow_unbounded = ibis.window(rows=(None, 0), order_by=\"sale_date\")\n\nresult = daily_revenue.mutate(\n    cumulative_revenue=_.total_revenue.cumsum(),\n    days_count=lambda t: t.count().over(window_unbounded),\n    avg_daily_so_far=lambda t: (t.cumulative_revenue / t.days_count).round(2)\n).limit(10)\n```\n\n<bslquery code-block=\"query_running_total\"></bslquery>\n\n## Moving Averages: Sliding Window Calculations\n\nCalculate metrics over a rolling window of rows:\n\n```query_moving_average\nfrom ibis import _\n\n# Daily revenue\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# 7-day moving average\nwindow_7d = ibis.window(rows=(-6, 0), order_by=\"sale_date\")\n\nresult = daily_revenue.mutate(\n    ma_7day=_.total_revenue.mean().over(window_7d).round(2),\n    ma_7day_sum=_.total_revenue.sum().over(window_7d).round(2),\n).limit(10)\n```\n\n<bslquery code-block=\"query_moving_average\"></bslquery>\n\n<note type=\"info\">\nThe window specification `rows=(-6, 0)` means \"6 rows before the current row through the current row\" (7 total rows). The moving average smooths out daily volatility.\n</note>\n\n## Ranking: Assign Positions\n\nRank rows based on values:\n\n```query_ranking\nfrom ibis import _\n\n# Aggregate by product category\ncategory_revenue = (\n    sales_st\n    .group_by(\"product_category\")\n    .aggregate(\"total_revenue\", \"sale_count\")\n    .order_by(_.total_revenue.desc())\n)\n\n# Add rank columns\nresult = category_revenue.mutate(\n    rank=ibis.rank().over(ibis.window(order_by=_.total_revenue.desc())),\n    dense_rank=ibis.dense_rank().over(ibis.window(order_by=_.total_revenue.desc())),\n    row_number=ibis.row_number().over(ibis.window(order_by=_.total_revenue.desc())),\n)\n```\n\n<bslquery code-block=\"query_ranking\"></bslquery>\n\n<note type=\"info\">\n`row_number()` assigns unique sequential numbers, `rank()` assigns the same rank to ties (skipping next ranks), and `dense_rank()` assigns the same rank to ties without gaps.\n</note>\n\n## Week-over-Week Comparison\n\nCompare metrics across weekly periods:\n\n```query_week_over_week\nfrom ibis import _\n\n# Aggregate by week\nweekly_revenue = (\n    sales_st\n    .mutate(week_start=_.sale_date.truncate(\"W\"))\n    .group_by(\"week_start\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"week_start\")\n)\n\n# Calculate week-over-week changes\nresult = weekly_revenue.mutate(\n    prev_week_revenue=_.total_revenue.lag(),\n    wow_change=_.total_revenue - _.total_revenue.lag(),\n    wow_pct_change=((_.total_revenue - _.total_revenue.lag()) / _.total_revenue.lag() * 100).round(2)\n).limit(10)\n```\n\n<bslquery code-block=\"query_week_over_week\"></bslquery>\n\n## Percent of Running Total\n\nCalculate each row's contribution to the cumulative total:\n\n```query_pct_running\nfrom ibis import _\n\n# Top 10 days by revenue\ntop_days = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(_.total_revenue.desc())\n    .limit(10)\n)\n\n# Calculate cumulative percentage\nresult = top_days.mutate(\n    cumulative_revenue=_.total_revenue.cumsum(),\n    total_top10=_.total_revenue.sum(),\n    pct_of_top10=(_.total_revenue.cumsum() / _.total_revenue.sum() * 100).round(2)\n)\n```\n\n<bslquery code-block=\"query_pct_running\"></bslquery>\n\n## Moving Window with Filters\n\nCombine window functions with filtering for focused analysis:\n\n```query_window_filter\nfrom ibis import _\n\n# Focus on weekends only\nweekend_revenue = (\n    sales_st\n    .mutate(is_weekend=_.sale_date.day_of_week.index().isin([5, 6]))\n    .filter(_.is_weekend)\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# 3-weekend moving average\nwindow_3 = ibis.window(rows=(-2, 0), order_by=\"sale_date\")\n\nresult = weekend_revenue.mutate(\n    ma_3weekend=_.total_revenue.mean().over(window_3).round(2),\n    prev_weekend=_.total_revenue.lag(),\n    weekend_change=_.total_revenue - _.total_revenue.lag()\n).limit(10)\n```\n\n<bslquery code-block=\"query_window_filter\"></bslquery>\n\n## Key Takeaways\n\n- **Window functions operate after aggregation**: They work on query results, not raw data\n- **Order matters**: Most window functions require `order_by()` for meaningful results\n- **Flexible windows**: Define windows by rows (`rows=(n, m)`) or ranges\n- **Common patterns**:\n  - `lag()/lead()` for period-over-period comparisons\n  - `cumsum()` for running totals\n  - `.over(window)` for moving averages\n  - `rank()`, `row_number()` for ranking\n- **Combine with filters**: Focus window calculations on specific subsets\n\n## Next Steps\n\n- Explore [Percentage of Total](/advanced/percentage-total) for ratio calculations\n- Learn about [Nested Subtotals](/advanced/nested-subtotals) for hierarchical aggregations and complex data structures\n",
  "queries": {
    "setup_data": {
      "code": "import ibis\nfrom ibis import _\nfrom datetime import datetime, timedelta\nimport random\n\n# Create daily sales data spanning 90 days\nstart_date = datetime(2024, 1, 1)\ndates = [start_date + timedelta(days=i) for i in range(90)]\n\n# Generate synthetic revenue with upward trend and weekly patterns\nrandom.seed(42)\n\nrevenue_values = []\nfor i, date in enumerate(dates):\n    # Base trend: increasing over time\n    base = 1000 + (i * 10)\n\n    # Weekly pattern: weekends have higher sales\n    weekday_multiplier = 1.3 if date.weekday() >= 5 else 1.0\n\n    # Random variation\n    noise = random.uniform(-100, 100)\n\n    revenue = base * weekday_multiplier + noise\n    revenue_values.append(round(revenue, 2))\n\n# Create table\nsales_data = ibis.memtable({\n    \"sale_date\": dates,\n    \"revenue\": revenue_values,\n    \"product_category\": [\"Electronics\" if i % 3 == 0 else \"Clothing\" if i % 3 == 1 else \"Home\" for i in range(90)],\n})",
      "sql": "Error generating SQL: Table.sql() missing 1 required positional argument: 'query'",
      "plan": "InMemoryTable\n  data:\n    PandasDataFrameProxy:\n          sale_date  revenue product_category\n      0  2024-01-01  1027.89      Electronics\n      1  2024-01-02   915.00         Clothing\n      2  2024-01-03   975.01             Home\n      3  2024-01-04   974.64      Electronics\n      4  2024-01-05  1087.29         Clothing\n      ..        ...      ...              ...\n      85 2024-03-26  1793.86         Clothing\n      86 2024-03-27  1959.51             Home\n      87 2024-03-28  1871.91      Electronics\n      88 2024-03-29  1798.18         Clothing\n      89 2024-03-30  2366.42             Home\n\n      [90 rows x 3 columns]",
      "table": {
        "columns": [
          "sale_date",
          "revenue",
          "product_category"
        ],
        "data": [
          [
            "2024-01-01",
            1027.89,
            "Electronics"
          ],
          [
            "2024-01-02",
            915.0,
            "Clothing"
          ],
          [
            "2024-01-03",
            975.01,
            "Home"
          ],
          [
            "2024-01-04",
            974.64,
            "Electronics"
          ],
          [
            "2024-01-05",
            1087.29,
            "Clothing"
          ],
          [
            "2024-01-06",
            1400.34,
            "Home"
          ],
          [
            "2024-01-07",
            1456.44,
            "Electronics"
          ],
          [
            "2024-01-08",
            987.39,
            "Clothing"
          ],
          [
            "2024-01-09",
            1064.38,
            "Home"
          ],
          [
            "2024-01-10",
            995.96,
            "Electronics"
          ],
          [
            "2024-01-11",
            1043.73,
            "Clothing"
          ],
          [
            "2024-01-12",
            1111.07,
            "Home"
          ],
          [
            "2024-01-13",
            1361.31,
            "Electronics"
          ],
          [
            "2024-01-14",
            1408.77,
            "Clothing"
          ],
          [
            "2024-01-15",
            1169.98,
            "Home"
          ],
          [
            "2024-01-16",
            1158.99,
            "Electronics"
          ],
          [
            "2024-01-17",
            1104.09,
            "Clothing"
          ],
          [
            "2024-01-18",
            1187.85,
            "Home"
          ],
          [
            "2024-01-19",
            1241.89,
            "Electronics"
          ],
          [
            "2024-01-20",
            1448.3,
            "Clothing"
          ],
          [
            "2024-01-21",
            1621.16,
            "Home"
          ],
          [
            "2024-01-22",
            1249.63,
            "Electronics"
          ],
          [
            "2024-01-23",
            1188.05,
            "Clothing"
          ],
          [
            "2024-01-24",
            1161.1,
            "Home"
          ],
          [
            "2024-01-25",
            1331.44,
            "Electronics"
          ],
          [
            "2024-01-26",
            1217.32,
            "Clothing"
          ],
          [
            "2024-01-27",
            1556.55,
            "Home"
          ],
          [
            "2024-01-28",
            1570.34,
            "Electronics"
          ],
          [
            "2024-01-29",
            1349.5,
            "Clothing"
          ],
          [
            "2024-01-30",
            1310.75,
            "Home"
          ],
          [
            "2024-01-31",
            1361.43,
            "Electronics"
          ],
          [
            "2024-02-01",
            1355.95,
            "Clothing"
          ],
          [
            "2024-02-02",
            1327.25,
            "Home"
          ],
          [
            "2024-02-03",
            1823.62,
            "Electronics"
          ],
          [
            "2024-02-04",
            1717.71,
            "Clothing"
          ],
          [
            "2024-02-05",
            1360.41,
            "Home"
          ],
          [
            "2024-02-06",
            1425.88,
            "Electronics"
          ],
          [
            "2024-02-07",
            1393.7,
            "Clothing"
          ],
          [
            "2024-02-08",
            1452.34,
            "Home"
          ],
          [
            "2024-02-09",
            1405.47,
            "Electronics"
          ],
          [
            "2024-02-10",
            1860.91,
            "Clothing"
          ],
          [
            "2024-02-11",
            1742.16,
            "Home"
          ],
          [
            "2024-02-12",
            1365.58,
            "Electronics"
          ],
          [
            "2024-02-13",
            1387.88,
            "Clothing"
          ],
          [
            "2024-02-14",
            1355.96,
            "Home"
          ],
          [
            "2024-02-15",
            1396.56,
            "Electronics"
          ],
          [
            "2024-02-16",
            1380.2,
            "Clothing"
          ],
          [
            "2024-02-17",
            1866.59,
            "Home"
          ],
          [
            "2024-02-18",
            1951.14,
            "Electronics"
          ],
          [
            "2024-02-19",
            1462.97,
            "Clothing"
          ],
          [
            "2024-02-20",
            1474.04,
            "Home"
          ],
          [
            "2024-02-21",
            1451.9,
            "Electronics"
          ],
          [
            "2024-02-22",
            1473.4,
            "Clothing"
          ],
          [
            "2024-02-23",
            1617.33,
            "Home"
          ],
          [
            "2024-02-24",
            2031.61,
            "Electronics"
          ],
          [
            "2024-02-25",
            2036.83,
            "Clothing"
          ],
          [
            "2024-02-26",
            1494.23,
            "Home"
          ],
          [
            "2024-02-27",
            1615.83,
            "Electronics"
          ],
          [
            "2024-02-28",
            1512.68,
            "Clothing"
          ],
          [
            "2024-02-29",
            1565.89,
            "Home"
          ],
          [
            "2024-03-01",
            1697.9,
            "Electronics"
          ],
          [
            "2024-03-02",
            2121.0,
            "Clothing"
          ],
          [
            "2024-03-03",
            2117.39,
            "Home"
          ],
          [
            "2024-03-04",
            1666.92,
            "Electronics"
          ],
          [
            "2024-03-05",
            1708.57,
            "Clothing"
          ],
          [
            "2024-03-06",
            1705.2,
            "Home"
          ],
          [
            "2024-03-07",
            1605.81,
            "Electronics"
          ],
          [
            "2024-03-08",
            1576.42,
            "Clothing"
          ],
          [
            "2024-03-09",
            2147.09,
            "Home"
          ],
          [
            "2024-03-10",
            2150.55,
            "Electronics"
          ],
          [
            "2024-03-11",
            1642.2,
            "Clothing"
          ],
          [
            "2024-03-12",
            1798.58,
            "Home"
          ],
          [
            "2024-03-13",
            1795.27,
            "Electronics"
          ],
          [
            "2024-03-14",
            1692.94,
            "Clothing"
          ],
          [
            "2024-03-15",
            1771.09,
            "Home"
          ],
          [
            "2024-03-16",
            2254.13,
            "Electronics"
          ],
          [
            "2024-03-17",
            2370.91,
            "Clothing"
          ],
          [
            "2024-03-18",
            1761.77,
            "Home"
          ],
          [
            "2024-03-19",
            1732.98,
            "Electronics"
          ],
          [
            "2024-03-20",
            1739.33,
            "Clothing"
          ],
          [
            "2024-03-21",
            1812.27,
            "Home"
          ],
          [
            "2024-03-22",
            1762.55,
            "Electronics"
          ],
          [
            "2024-03-23",
            2382.92,
            "Clothing"
          ],
          [
            "2024-03-24",
            2458.56,
            "Home"
          ],
          [
            "2024-03-25",
            1819.88,
            "Electronics"
          ],
          [
            "2024-03-26",
            1793.86,
            "Clothing"
          ],
          [
            "2024-03-27",
            1959.51,
            "Home"
          ],
          [
            "2024-03-28",
            1871.91,
            "Electronics"
          ],
          [
            "2024-03-29",
            1798.18,
            "Clothing"
          ],
          [
            "2024-03-30",
            2366.42,
            "Home"
          ]
        ]
      }
    },
    "setup_st": {
      "code": "from boring_semantic_layer import to_semantic_table\n\n# Create semantic table with measures\nsales_st = to_semantic_table(\n    sales_data,\n    name=\"daily_sales\"\n).with_measures(\n    total_revenue=lambda t: t.revenue.sum(),\n    avg_revenue=lambda t: t.revenue.mean(),\n    sale_count=lambda t: t.count(),\n)",
      "sql": "SELECT\n  *\nFROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\"",
      "plan": "\u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m",
      "table": {
        "columns": [
          "sale_date",
          "revenue",
          "product_category"
        ],
        "data": [
          [
            "2024-01-01",
            1027.89,
            "Electronics"
          ],
          [
            "2024-01-02",
            915.0,
            "Clothing"
          ],
          [
            "2024-01-03",
            975.01,
            "Home"
          ],
          [
            "2024-01-04",
            974.64,
            "Electronics"
          ],
          [
            "2024-01-05",
            1087.29,
            "Clothing"
          ],
          [
            "2024-01-06",
            1400.34,
            "Home"
          ],
          [
            "2024-01-07",
            1456.44,
            "Electronics"
          ],
          [
            "2024-01-08",
            987.39,
            "Clothing"
          ],
          [
            "2024-01-09",
            1064.38,
            "Home"
          ],
          [
            "2024-01-10",
            995.96,
            "Electronics"
          ],
          [
            "2024-01-11",
            1043.73,
            "Clothing"
          ],
          [
            "2024-01-12",
            1111.07,
            "Home"
          ],
          [
            "2024-01-13",
            1361.31,
            "Electronics"
          ],
          [
            "2024-01-14",
            1408.77,
            "Clothing"
          ],
          [
            "2024-01-15",
            1169.98,
            "Home"
          ],
          [
            "2024-01-16",
            1158.99,
            "Electronics"
          ],
          [
            "2024-01-17",
            1104.09,
            "Clothing"
          ],
          [
            "2024-01-18",
            1187.85,
            "Home"
          ],
          [
            "2024-01-19",
            1241.89,
            "Electronics"
          ],
          [
            "2024-01-20",
            1448.3,
            "Clothing"
          ],
          [
            "2024-01-21",
            1621.16,
            "Home"
          ],
          [
            "2024-01-22",
            1249.63,
            "Electronics"
          ],
          [
            "2024-01-23",
            1188.05,
            "Clothing"
          ],
          [
            "2024-01-24",
            1161.1,
            "Home"
          ],
          [
            "2024-01-25",
            1331.44,
            "Electronics"
          ],
          [
            "2024-01-26",
            1217.32,
            "Clothing"
          ],
          [
            "2024-01-27",
            1556.55,
            "Home"
          ],
          [
            "2024-01-28",
            1570.34,
            "Electronics"
          ],
          [
            "2024-01-29",
            1349.5,
            "Clothing"
          ],
          [
            "2024-01-30",
            1310.75,
            "Home"
          ],
          [
            "2024-01-31",
            1361.43,
            "Electronics"
          ],
          [
            "2024-02-01",
            1355.95,
            "Clothing"
          ],
          [
            "2024-02-02",
            1327.25,
            "Home"
          ],
          [
            "2024-02-03",
            1823.62,
            "Electronics"
          ],
          [
            "2024-02-04",
            1717.71,
            "Clothing"
          ],
          [
            "2024-02-05",
            1360.41,
            "Home"
          ],
          [
            "2024-02-06",
            1425.88,
            "Electronics"
          ],
          [
            "2024-02-07",
            1393.7,
            "Clothing"
          ],
          [
            "2024-02-08",
            1452.34,
            "Home"
          ],
          [
            "2024-02-09",
            1405.47,
            "Electronics"
          ],
          [
            "2024-02-10",
            1860.91,
            "Clothing"
          ],
          [
            "2024-02-11",
            1742.16,
            "Home"
          ],
          [
            "2024-02-12",
            1365.58,
            "Electronics"
          ],
          [
            "2024-02-13",
            1387.88,
            "Clothing"
          ],
          [
            "2024-02-14",
            1355.96,
            "Home"
          ],
          [
            "2024-02-15",
            1396.56,
            "Electronics"
          ],
          [
            "2024-02-16",
            1380.2,
            "Clothing"
          ],
          [
            "2024-02-17",
            1866.59,
            "Home"
          ],
          [
            "2024-02-18",
            1951.14,
            "Electronics"
          ],
          [
            "2024-02-19",
            1462.97,
            "Clothing"
          ],
          [
            "2024-02-20",
            1474.04,
            "Home"
          ],
          [
            "2024-02-21",
            1451.9,
            "Electronics"
          ],
          [
            "2024-02-22",
            1473.4,
            "Clothing"
          ],
          [
            "2024-02-23",
            1617.33,
            "Home"
          ],
          [
            "2024-02-24",
            2031.61,
            "Electronics"
          ],
          [
            "2024-02-25",
            2036.83,
            "Clothing"
          ],
          [
            "2024-02-26",
            1494.23,
            "Home"
          ],
          [
            "2024-02-27",
            1615.83,
            "Electronics"
          ],
          [
            "2024-02-28",
            1512.68,
            "Clothing"
          ],
          [
            "2024-02-29",
            1565.89,
            "Home"
          ],
          [
            "2024-03-01",
            1697.9,
            "Electronics"
          ],
          [
            "2024-03-02",
            2121.0,
            "Clothing"
          ],
          [
            "2024-03-03",
            2117.39,
            "Home"
          ],
          [
            "2024-03-04",
            1666.92,
            "Electronics"
          ],
          [
            "2024-03-05",
            1708.57,
            "Clothing"
          ],
          [
            "2024-03-06",
            1705.2,
            "Home"
          ],
          [
            "2024-03-07",
            1605.81,
            "Electronics"
          ],
          [
            "2024-03-08",
            1576.42,
            "Clothing"
          ],
          [
            "2024-03-09",
            2147.09,
            "Home"
          ],
          [
            "2024-03-10",
            2150.55,
            "Electronics"
          ],
          [
            "2024-03-11",
            1642.2,
            "Clothing"
          ],
          [
            "2024-03-12",
            1798.58,
            "Home"
          ],
          [
            "2024-03-13",
            1795.27,
            "Electronics"
          ],
          [
            "2024-03-14",
            1692.94,
            "Clothing"
          ],
          [
            "2024-03-15",
            1771.09,
            "Home"
          ],
          [
            "2024-03-16",
            2254.13,
            "Electronics"
          ],
          [
            "2024-03-17",
            2370.91,
            "Clothing"
          ],
          [
            "2024-03-18",
            1761.77,
            "Home"
          ],
          [
            "2024-03-19",
            1732.98,
            "Electronics"
          ],
          [
            "2024-03-20",
            1739.33,
            "Clothing"
          ],
          [
            "2024-03-21",
            1812.27,
            "Home"
          ],
          [
            "2024-03-22",
            1762.55,
            "Electronics"
          ],
          [
            "2024-03-23",
            2382.92,
            "Clothing"
          ],
          [
            "2024-03-24",
            2458.56,
            "Home"
          ],
          [
            "2024-03-25",
            1819.88,
            "Electronics"
          ],
          [
            "2024-03-26",
            1793.86,
            "Clothing"
          ],
          [
            "2024-03-27",
            1959.51,
            "Home"
          ],
          [
            "2024-03-28",
            1871.91,
            "Electronics"
          ],
          [
            "2024-03-29",
            1798.18,
            "Clothing"
          ],
          [
            "2024-03-30",
            2366.42,
            "Home"
          ]
        ]
      }
    },
    "query_lag_lead": {
      "code": "from ibis import _\n\n# Aggregate daily revenue\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# Add window functions for lag/lead\nresult = daily_revenue.mutate(\n    prev_day_revenue=_.total_revenue.lag(),\n    next_day_revenue=_.total_revenue.lead(),\n    day_over_day_change=_.total_revenue - _.total_revenue.lag(),\n    pct_change=((_.total_revenue - _.total_revenue.lag()) / _.total_revenue.lag() * 100).round(2)\n).limit(10)",
      "sql": "SELECT\n  \"t5\".\"sale_date\",\n  \"t5\".\"total_revenue\",\n  \"t5\".\"prev_day_revenue\",\n  \"t5\".\"next_day_revenue\",\n  \"t5\".\"day_over_day_change\",\n  CAST(ROUND(\n    (\n      (\n        \"t5\".\"total_revenue\" - LAG(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\n      ) / LAG(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\n    ) * 100,\n    2\n  ) AS DOUBLE) AS \"pct_change\"\nFROM (\n  SELECT\n    \"t4\".\"sale_date\",\n    \"t4\".\"total_revenue\",\n    \"t4\".\"prev_day_revenue\",\n    \"t4\".\"next_day_revenue\",\n    \"t4\".\"total_revenue\" - LAG(\"t4\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"day_over_day_change\"\n  FROM (\n    SELECT\n      \"t3\".\"sale_date\",\n      \"t3\".\"total_revenue\",\n      \"t3\".\"prev_day_revenue\",\n      LEAD(\"t3\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"next_day_revenue\"\n    FROM (\n      SELECT\n        \"t2\".\"sale_date\",\n        \"t2\".\"total_revenue\",\n        LAG(\"t2\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"prev_day_revenue\"\n      FROM (\n        SELECT\n          *\n        FROM (\n          SELECT\n            \"t0\".\"sale_date\",\n            SUM(\"t0\".\"revenue\") AS \"total_revenue\"\n          FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n          GROUP BY\n            1\n        ) AS \"t1\"\n        ORDER BY\n          \"t1\".\"sale_date\" ASC\n      ) AS \"t2\"\n    ) AS \"t3\"\n  ) AS \"t4\"\n) AS \"t5\"\nLIMIT 10",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr0\u001b[0m]\n  keys:\n    \u001b[36msale_date\u001b[0m\n\nr2 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr1\u001b[0m]\n  groups:\n    \u001b[36msale_date\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr3 := OrderBy[r2]\n  sort_keys:\n    sale_date\n\nr4 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr3\u001b[0m]\n  new_columns:\n    prev_day_revenue\n    next_day_revenue\n    day_over_day_change\n    ... and 1 more\n\nLimit[r4]\n  n:\n    10",
      "table": {
        "columns": [
          "sale_date",
          "total_revenue",
          "prev_day_revenue",
          "next_day_revenue",
          "day_over_day_change",
          "pct_change"
        ],
        "data": [
          [
            "2024-01-01",
            1027.89,
            null,
            915.0,
            null,
            null
          ],
          [
            "2024-01-02",
            915.0,
            1027.89,
            975.01,
            -112.8900000000001,
            -10.98
          ],
          [
            "2024-01-03",
            975.01,
            915.0,
            974.64,
            60.00999999999999,
            6.56
          ],
          [
            "2024-01-04",
            974.64,
            975.01,
            1087.29,
            -0.37000000000000455,
            -0.04
          ],
          [
            "2024-01-05",
            1087.29,
            974.64,
            1400.34,
            112.64999999999998,
            11.56
          ],
          [
            "2024-01-06",
            1400.34,
            1087.29,
            1456.44,
            313.04999999999995,
            28.79
          ],
          [
            "2024-01-07",
            1456.44,
            1400.34,
            987.39,
            56.100000000000136,
            4.01
          ],
          [
            "2024-01-08",
            987.39,
            1456.44,
            1064.38,
            -469.05000000000007,
            -32.21
          ],
          [
            "2024-01-09",
            1064.38,
            987.39,
            995.96,
            76.99000000000012,
            7.8
          ],
          [
            "2024-01-10",
            995.96,
            1064.38,
            1043.73,
            -68.42000000000007,
            -6.43
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-b619f08e03be30f67dc36f4dbc7ad04c"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "sale_date",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "sale_date",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "prev_day_revenue",
                "next_day_revenue",
                "day_over_day_change",
                "pct_change"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-b619f08e03be30f67dc36f4dbc7ad04c": [
              {
                "sale_date": "2024-01-01T00:00:00",
                "total_revenue": 1027.89,
                "prev_day_revenue": null,
                "next_day_revenue": 915.0,
                "day_over_day_change": null,
                "pct_change": null
              },
              {
                "sale_date": "2024-01-02T00:00:00",
                "total_revenue": 915.0,
                "prev_day_revenue": 1027.89,
                "next_day_revenue": 975.01,
                "day_over_day_change": -112.8900000000001,
                "pct_change": -10.98
              },
              {
                "sale_date": "2024-01-03T00:00:00",
                "total_revenue": 975.01,
                "prev_day_revenue": 915.0,
                "next_day_revenue": 974.64,
                "day_over_day_change": 60.00999999999999,
                "pct_change": 6.56
              },
              {
                "sale_date": "2024-01-04T00:00:00",
                "total_revenue": 974.64,
                "prev_day_revenue": 975.01,
                "next_day_revenue": 1087.29,
                "day_over_day_change": -0.37000000000000455,
                "pct_change": -0.04
              },
              {
                "sale_date": "2024-01-05T00:00:00",
                "total_revenue": 1087.29,
                "prev_day_revenue": 974.64,
                "next_day_revenue": 1400.34,
                "day_over_day_change": 112.64999999999998,
                "pct_change": 11.56
              },
              {
                "sale_date": "2024-01-06T00:00:00",
                "total_revenue": 1400.34,
                "prev_day_revenue": 1087.29,
                "next_day_revenue": 1456.44,
                "day_over_day_change": 313.04999999999995,
                "pct_change": 28.79
              },
              {
                "sale_date": "2024-01-07T00:00:00",
                "total_revenue": 1456.44,
                "prev_day_revenue": 1400.34,
                "next_day_revenue": 987.39,
                "day_over_day_change": 56.100000000000136,
                "pct_change": 4.01
              },
              {
                "sale_date": "2024-01-08T00:00:00",
                "total_revenue": 987.39,
                "prev_day_revenue": 1456.44,
                "next_day_revenue": 1064.38,
                "day_over_day_change": -469.05000000000007,
                "pct_change": -32.21
              },
              {
                "sale_date": "2024-01-09T00:00:00",
                "total_revenue": 1064.38,
                "prev_day_revenue": 987.39,
                "next_day_revenue": 995.96,
                "day_over_day_change": 76.99000000000012,
                "pct_change": 7.8
              },
              {
                "sale_date": "2024-01-10T00:00:00",
                "total_revenue": 995.96,
                "prev_day_revenue": 1064.38,
                "next_day_revenue": 1043.73,
                "day_over_day_change": -68.42000000000007,
                "pct_change": -6.43
              }
            ]
          }
        }
      }
    },
    "query_running_total": {
      "code": "from ibis import _\n\n# Daily revenue with cumulative total\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# Calculate cumulative sum and running average\nwindow_unbounded = ibis.window(rows=(None, 0), order_by=\"sale_date\")\n\nresult = daily_revenue.mutate(\n    cumulative_revenue=_.total_revenue.cumsum(),\n    days_count=lambda t: t.count().over(window_unbounded),\n    avg_daily_so_far=lambda t: (t.cumulative_revenue / t.days_count).round(2)\n).limit(10)",
      "sql": "SELECT\n  \"t4\".\"sale_date\",\n  \"t4\".\"total_revenue\",\n  \"t4\".\"cumulative_revenue\",\n  \"t4\".\"days_count\",\n  CAST(ROUND(\"t4\".\"cumulative_revenue\" / \"t4\".\"days_count\", 2) AS DOUBLE) AS \"avg_daily_so_far\"\nFROM (\n  SELECT\n    \"t3\".\"sale_date\",\n    \"t3\".\"total_revenue\",\n    \"t3\".\"cumulative_revenue\",\n    COUNT(*) OVER (ORDER BY \"t3\".\"sale_date\" ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS \"days_count\"\n  FROM (\n    SELECT\n      \"t2\".\"sale_date\",\n      \"t2\".\"total_revenue\",\n      SUM(\"t2\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS \"cumulative_revenue\"\n    FROM (\n      SELECT\n        *\n      FROM (\n        SELECT\n          \"t0\".\"sale_date\",\n          SUM(\"t0\".\"revenue\") AS \"total_revenue\"\n        FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n        GROUP BY\n          1\n      ) AS \"t1\"\n      ORDER BY\n        \"t1\".\"sale_date\" ASC\n    ) AS \"t2\"\n  ) AS \"t3\"\n) AS \"t4\"\nLIMIT 10",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr0\u001b[0m]\n  keys:\n    \u001b[36msale_date\u001b[0m\n\nr2 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr1\u001b[0m]\n  groups:\n    \u001b[36msale_date\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr3 := OrderBy[r2]\n  sort_keys:\n    sale_date\n\nr4 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr3\u001b[0m]\n  new_columns:\n    cumulative_revenue\n    days_count\n    avg_daily_so_far\n\nLimit[r4]\n  n:\n    10",
      "table": {
        "columns": [
          "sale_date",
          "total_revenue",
          "cumulative_revenue",
          "days_count",
          "avg_daily_so_far"
        ],
        "data": [
          [
            "2024-01-01",
            1027.89,
            1027.89,
            1,
            1027.89
          ],
          [
            "2024-01-02",
            915.0,
            1942.89,
            2,
            971.45
          ],
          [
            "2024-01-03",
            975.01,
            2917.9,
            3,
            972.63
          ],
          [
            "2024-01-04",
            974.64,
            3892.54,
            4,
            973.14
          ],
          [
            "2024-01-05",
            1087.29,
            4979.83,
            5,
            995.97
          ],
          [
            "2024-01-06",
            1400.34,
            6380.17,
            6,
            1063.36
          ],
          [
            "2024-01-07",
            1456.44,
            7836.610000000001,
            7,
            1119.52
          ],
          [
            "2024-01-08",
            987.39,
            8824.0,
            8,
            1103.0
          ],
          [
            "2024-01-09",
            1064.38,
            9888.380000000001,
            9,
            1098.71
          ],
          [
            "2024-01-10",
            995.96,
            10884.34,
            10,
            1088.43
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-a2cc16edd36913d4a5a93620f23591a2"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "sale_date",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "sale_date",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "cumulative_revenue",
                "days_count",
                "avg_daily_so_far"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-a2cc16edd36913d4a5a93620f23591a2": [
              {
                "sale_date": "2024-01-01T00:00:00",
                "total_revenue": 1027.89,
                "cumulative_revenue": 1027.89,
                "days_count": 1,
                "avg_daily_so_far": 1027.89
              },
              {
                "sale_date": "2024-01-02T00:00:00",
                "total_revenue": 915.0,
                "cumulative_revenue": 1942.89,
                "days_count": 2,
                "avg_daily_so_far": 971.45
              },
              {
                "sale_date": "2024-01-03T00:00:00",
                "total_revenue": 975.01,
                "cumulative_revenue": 2917.9,
                "days_count": 3,
                "avg_daily_so_far": 972.63
              },
              {
                "sale_date": "2024-01-04T00:00:00",
                "total_revenue": 974.64,
                "cumulative_revenue": 3892.54,
                "days_count": 4,
                "avg_daily_so_far": 973.14
              },
              {
                "sale_date": "2024-01-05T00:00:00",
                "total_revenue": 1087.29,
                "cumulative_revenue": 4979.83,
                "days_count": 5,
                "avg_daily_so_far": 995.97
              },
              {
                "sale_date": "2024-01-06T00:00:00",
                "total_revenue": 1400.34,
                "cumulative_revenue": 6380.17,
                "days_count": 6,
                "avg_daily_so_far": 1063.36
              },
              {
                "sale_date": "2024-01-07T00:00:00",
                "total_revenue": 1456.44,
                "cumulative_revenue": 7836.610000000001,
                "days_count": 7,
                "avg_daily_so_far": 1119.52
              },
              {
                "sale_date": "2024-01-08T00:00:00",
                "total_revenue": 987.39,
                "cumulative_revenue": 8824.0,
                "days_count": 8,
                "avg_daily_so_far": 1103.0
              },
              {
                "sale_date": "2024-01-09T00:00:00",
                "total_revenue": 1064.38,
                "cumulative_revenue": 9888.380000000001,
                "days_count": 9,
                "avg_daily_so_far": 1098.71
              },
              {
                "sale_date": "2024-01-10T00:00:00",
                "total_revenue": 995.96,
                "cumulative_revenue": 10884.34,
                "days_count": 10,
                "avg_daily_so_far": 1088.43
              }
            ]
          }
        }
      }
    },
    "query_moving_average": {
      "code": "from ibis import _\n\n# Daily revenue\ndaily_revenue = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# 7-day moving average\nwindow_7d = ibis.window(rows=(-6, 0), order_by=\"sale_date\")\n\nresult = daily_revenue.mutate(\n    ma_7day=_.total_revenue.mean().over(window_7d).round(2),\n    ma_7day_sum=_.total_revenue.sum().over(window_7d).round(2),\n).limit(10)",
      "sql": "SELECT\n  \"t3\".\"sale_date\",\n  \"t3\".\"total_revenue\",\n  \"t3\".\"ma_7day\",\n  CAST(ROUND(\n    SUM(\"t3\".\"total_revenue\") OVER (ORDER BY \"t3\".\"sale_date\" ASC ROWS BETWEEN 6 preceding AND CURRENT ROW),\n    2\n  ) AS DOUBLE) AS \"ma_7day_sum\"\nFROM (\n  SELECT\n    \"t2\".\"sale_date\",\n    \"t2\".\"total_revenue\",\n    CAST(ROUND(\n      AVG(\"t2\".\"total_revenue\") OVER (ORDER BY \"t2\".\"sale_date\" ASC ROWS BETWEEN 6 preceding AND CURRENT ROW),\n      2\n    ) AS DOUBLE) AS \"ma_7day\"\n  FROM (\n    SELECT\n      *\n    FROM (\n      SELECT\n        \"t0\".\"sale_date\",\n        SUM(\"t0\".\"revenue\") AS \"total_revenue\"\n      FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n      GROUP BY\n        1\n    ) AS \"t1\"\n    ORDER BY\n      \"t1\".\"sale_date\" ASC\n  ) AS \"t2\"\n) AS \"t3\"\nLIMIT 10",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr0\u001b[0m]\n  keys:\n    \u001b[36msale_date\u001b[0m\n\nr2 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr1\u001b[0m]\n  groups:\n    \u001b[36msale_date\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr3 := OrderBy[r2]\n  sort_keys:\n    sale_date\n\nr4 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr3\u001b[0m]\n  new_columns:\n    ma_7day\n    ma_7day_sum\n\nLimit[r4]\n  n:\n    10",
      "table": {
        "columns": [
          "sale_date",
          "total_revenue",
          "ma_7day",
          "ma_7day_sum"
        ],
        "data": [
          [
            "2024-01-01",
            1027.89,
            1027.89,
            1027.89
          ],
          [
            "2024-01-02",
            915.0,
            971.45,
            1942.89
          ],
          [
            "2024-01-03",
            975.01,
            972.63,
            2917.9
          ],
          [
            "2024-01-04",
            974.64,
            973.14,
            3892.54
          ],
          [
            "2024-01-05",
            1087.29,
            995.97,
            4979.83
          ],
          [
            "2024-01-06",
            1400.34,
            1063.36,
            6380.17
          ],
          [
            "2024-01-07",
            1456.44,
            1119.52,
            7836.61
          ],
          [
            "2024-01-08",
            987.39,
            1113.73,
            7796.11
          ],
          [
            "2024-01-09",
            1064.38,
            1135.07,
            7945.49
          ],
          [
            "2024-01-10",
            995.96,
            1138.06,
            7966.44
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-3d114133558af670c07d20a7e60639fa"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "sale_date",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "sale_date",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "ma_7day",
                "ma_7day_sum"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-3d114133558af670c07d20a7e60639fa": [
              {
                "sale_date": "2024-01-01T00:00:00",
                "total_revenue": 1027.89,
                "ma_7day": 1027.89,
                "ma_7day_sum": 1027.89
              },
              {
                "sale_date": "2024-01-02T00:00:00",
                "total_revenue": 915.0,
                "ma_7day": 971.45,
                "ma_7day_sum": 1942.89
              },
              {
                "sale_date": "2024-01-03T00:00:00",
                "total_revenue": 975.01,
                "ma_7day": 972.63,
                "ma_7day_sum": 2917.9
              },
              {
                "sale_date": "2024-01-04T00:00:00",
                "total_revenue": 974.64,
                "ma_7day": 973.14,
                "ma_7day_sum": 3892.54
              },
              {
                "sale_date": "2024-01-05T00:00:00",
                "total_revenue": 1087.29,
                "ma_7day": 995.97,
                "ma_7day_sum": 4979.83
              },
              {
                "sale_date": "2024-01-06T00:00:00",
                "total_revenue": 1400.34,
                "ma_7day": 1063.36,
                "ma_7day_sum": 6380.17
              },
              {
                "sale_date": "2024-01-07T00:00:00",
                "total_revenue": 1456.44,
                "ma_7day": 1119.52,
                "ma_7day_sum": 7836.61
              },
              {
                "sale_date": "2024-01-08T00:00:00",
                "total_revenue": 987.39,
                "ma_7day": 1113.73,
                "ma_7day_sum": 7796.11
              },
              {
                "sale_date": "2024-01-09T00:00:00",
                "total_revenue": 1064.38,
                "ma_7day": 1135.07,
                "ma_7day_sum": 7945.49
              },
              {
                "sale_date": "2024-01-10T00:00:00",
                "total_revenue": 995.96,
                "ma_7day": 1138.06,
                "ma_7day_sum": 7966.44
              }
            ]
          }
        }
      }
    },
    "query_ranking": {
      "code": "from ibis import _\n\n# Aggregate by product category\ncategory_revenue = (\n    sales_st\n    .group_by(\"product_category\")\n    .aggregate(\"total_revenue\", \"sale_count\")\n    .order_by(_.total_revenue.desc())\n)\n\n# Add rank columns\nresult = category_revenue.mutate(\n    rank=ibis.rank().over(ibis.window(order_by=_.total_revenue.desc())),\n    dense_rank=ibis.dense_rank().over(ibis.window(order_by=_.total_revenue.desc())),\n    row_number=ibis.row_number().over(ibis.window(order_by=_.total_revenue.desc())),\n)",
      "sql": "SELECT\n  \"t4\".\"product_category\",\n  \"t4\".\"total_revenue\",\n  \"t4\".\"sale_count\",\n  \"t4\".\"rank\",\n  \"t4\".\"dense_rank\",\n  ROW_NUMBER() OVER (ORDER BY \"t4\".\"total_revenue\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) - 1 AS \"row_number\"\nFROM (\n  SELECT\n    \"t3\".\"product_category\",\n    \"t3\".\"total_revenue\",\n    \"t3\".\"sale_count\",\n    \"t3\".\"rank\",\n    DENSE_RANK() OVER (ORDER BY \"t3\".\"total_revenue\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) - 1 AS \"dense_rank\"\n  FROM (\n    SELECT\n      \"t2\".\"product_category\",\n      \"t2\".\"total_revenue\",\n      \"t2\".\"sale_count\",\n      RANK() OVER (ORDER BY \"t2\".\"total_revenue\" DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) - 1 AS \"rank\"\n    FROM (\n      SELECT\n        *\n      FROM (\n        SELECT\n          \"t0\".\"product_category\",\n          SUM(\"t0\".\"revenue\") AS \"total_revenue\",\n          COUNT(*) AS \"sale_count\"\n        FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n        GROUP BY\n          1\n      ) AS \"t1\"\n      ORDER BY\n        \"t1\".\"total_revenue\" DESC\n    ) AS \"t2\"\n  ) AS \"t3\"\n) AS \"t4\"",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr0\u001b[0m]\n  keys:\n    \u001b[36mproduct_category\u001b[0m\n\nr2 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr1\u001b[0m]\n  groups:\n    \u001b[36mproduct_category\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n    \u001b[35msale_count\u001b[0m\n\nr3 := OrderBy[r2]\n  sort_keys:\n    _CallableWrapper(_fn=_.total_revenue.desc())\n\n\u001b[1;32mMutate\u001b[0m[\u001b[93mr3\u001b[0m]\n  new_columns:\n    rank\n    dense_rank\n    row_number",
      "table": {
        "columns": [
          "product_category",
          "total_revenue",
          "sale_count",
          "rank",
          "dense_rank",
          "row_number"
        ],
        "data": [
          [
            "Home",
            47712.26999999998,
            30,
            0,
            0,
            0
          ],
          [
            "Electronics",
            46555.450000000004,
            30,
            1,
            1,
            1
          ],
          [
            "Clothing",
            46158.00000000001,
            30,
            2,
            2,
            2
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-a4c4adb65d2cd90d069cb567d81f4f29"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "product_category",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "product_category",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "sale_count",
                "rank",
                "dense_rank",
                "row_number"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-a4c4adb65d2cd90d069cb567d81f4f29": [
              {
                "product_category": "Home",
                "total_revenue": 47712.26999999998,
                "sale_count": 30,
                "rank": 0,
                "dense_rank": 0,
                "row_number": 0
              },
              {
                "product_category": "Electronics",
                "total_revenue": 46555.450000000004,
                "sale_count": 30,
                "rank": 1,
                "dense_rank": 1,
                "row_number": 1
              },
              {
                "product_category": "Clothing",
                "total_revenue": 46158.00000000001,
                "sale_count": 30,
                "rank": 2,
                "dense_rank": 2,
                "row_number": 2
              }
            ]
          }
        }
      }
    },
    "query_week_over_week": {
      "code": "from ibis import _\n\n# Aggregate by week\nweekly_revenue = (\n    sales_st\n    .mutate(week_start=_.sale_date.truncate(\"W\"))\n    .group_by(\"week_start\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"week_start\")\n)\n\n# Calculate week-over-week changes\nresult = weekly_revenue.mutate(\n    prev_week_revenue=_.total_revenue.lag(),\n    wow_change=_.total_revenue - _.total_revenue.lag(),\n    wow_pct_change=((_.total_revenue - _.total_revenue.lag()) / _.total_revenue.lag() * 100).round(2)\n).limit(10)",
      "sql": "SELECT\n  \"t5\".\"week_start\",\n  \"t5\".\"total_revenue\",\n  \"t5\".\"prev_week_revenue\",\n  \"t5\".\"wow_change\",\n  CAST(ROUND(\n    (\n      (\n        \"t5\".\"total_revenue\" - LAG(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\n      ) / LAG(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\n    ) * 100,\n    2\n  ) AS DOUBLE) AS \"wow_pct_change\"\nFROM (\n  SELECT\n    \"t4\".\"week_start\",\n    \"t4\".\"total_revenue\",\n    \"t4\".\"prev_week_revenue\",\n    \"t4\".\"total_revenue\" - LAG(\"t4\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"wow_change\"\n  FROM (\n    SELECT\n      \"t3\".\"week_start\",\n      \"t3\".\"total_revenue\",\n      LAG(\"t3\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"prev_week_revenue\"\n    FROM (\n      SELECT\n        *\n      FROM (\n        SELECT\n          \"t1\".\"week_start\",\n          SUM(\"t1\".\"revenue\") AS \"total_revenue\"\n        FROM (\n          SELECT\n            \"t0\".\"sale_date\",\n            \"t0\".\"revenue\",\n            \"t0\".\"product_category\",\n            DATE_TRUNC('WEEK', \"t0\".\"sale_date\") AS \"week_start\"\n          FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n        ) AS \"t1\"\n        GROUP BY\n          1\n      ) AS \"t2\"\n      ORDER BY\n        \"t2\".\"week_start\" ASC\n    ) AS \"t3\"\n  ) AS \"t4\"\n) AS \"t5\"\nLIMIT 10",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr0\u001b[0m]\n  new_columns:\n    week_start\n\nr2 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr1\u001b[0m]\n  keys:\n    \u001b[36mweek_start\u001b[0m\n\nr3 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr2\u001b[0m]\n  groups:\n    \u001b[36mweek_start\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr4 := OrderBy[r3]\n  sort_keys:\n    week_start\n\nr5 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr4\u001b[0m]\n  new_columns:\n    prev_week_revenue\n    wow_change\n    wow_pct_change\n\nLimit[r5]\n  n:\n    10",
      "table": {
        "columns": [
          "week_start",
          "total_revenue",
          "prev_week_revenue",
          "wow_change",
          "wow_pct_change"
        ],
        "data": [
          [
            "2024-01-01",
            7836.610000000001,
            null,
            null,
            null
          ],
          [
            "2024-01-08",
            7972.610000000001,
            7836.610000000001,
            136.0,
            1.74
          ],
          [
            "2024-01-15",
            8932.26,
            7972.610000000001,
            959.6499999999996,
            12.04
          ],
          [
            "2024-01-22",
            9274.43,
            8932.26,
            342.1700000000001,
            3.83
          ],
          [
            "2024-01-29",
            10246.21,
            9274.43,
            971.7799999999988,
            10.48
          ],
          [
            "2024-02-05",
            10640.87,
            10246.21,
            394.6600000000017,
            3.85
          ],
          [
            "2024-02-12",
            10703.909999999998,
            10640.87,
            63.039999999997235,
            0.59
          ],
          [
            "2024-02-19",
            11548.08,
            10703.909999999998,
            844.1700000000019,
            7.89
          ],
          [
            "2024-02-26",
            12124.92,
            11548.08,
            576.8400000000001,
            5.0
          ],
          [
            "2024-03-04",
            12560.560000000001,
            12124.92,
            435.64000000000124,
            3.59
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-d1c41b4c07d5b0728e9592f009a61a2e"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "week_start",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "week_start",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "prev_week_revenue",
                "wow_change",
                "wow_pct_change"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-d1c41b4c07d5b0728e9592f009a61a2e": [
              {
                "week_start": "2024-01-01T00:00:00",
                "total_revenue": 7836.610000000001,
                "prev_week_revenue": null,
                "wow_change": null,
                "wow_pct_change": null
              },
              {
                "week_start": "2024-01-08T00:00:00",
                "total_revenue": 7972.610000000001,
                "prev_week_revenue": 7836.610000000001,
                "wow_change": 136.0,
                "wow_pct_change": 1.74
              },
              {
                "week_start": "2024-01-15T00:00:00",
                "total_revenue": 8932.26,
                "prev_week_revenue": 7972.610000000001,
                "wow_change": 959.6499999999996,
                "wow_pct_change": 12.04
              },
              {
                "week_start": "2024-01-22T00:00:00",
                "total_revenue": 9274.43,
                "prev_week_revenue": 8932.26,
                "wow_change": 342.1700000000001,
                "wow_pct_change": 3.83
              },
              {
                "week_start": "2024-01-29T00:00:00",
                "total_revenue": 10246.21,
                "prev_week_revenue": 9274.43,
                "wow_change": 971.7799999999988,
                "wow_pct_change": 10.48
              },
              {
                "week_start": "2024-02-05T00:00:00",
                "total_revenue": 10640.87,
                "prev_week_revenue": 10246.21,
                "wow_change": 394.6600000000017,
                "wow_pct_change": 3.85
              },
              {
                "week_start": "2024-02-12T00:00:00",
                "total_revenue": 10703.909999999998,
                "prev_week_revenue": 10640.87,
                "wow_change": 63.039999999997235,
                "wow_pct_change": 0.59
              },
              {
                "week_start": "2024-02-19T00:00:00",
                "total_revenue": 11548.08,
                "prev_week_revenue": 10703.909999999998,
                "wow_change": 844.1700000000019,
                "wow_pct_change": 7.89
              },
              {
                "week_start": "2024-02-26T00:00:00",
                "total_revenue": 12124.92,
                "prev_week_revenue": 11548.08,
                "wow_change": 576.8400000000001,
                "wow_pct_change": 5.0
              },
              {
                "week_start": "2024-03-04T00:00:00",
                "total_revenue": 12560.560000000001,
                "prev_week_revenue": 12124.92,
                "wow_change": 435.64000000000124,
                "wow_pct_change": 3.59
              }
            ]
          }
        }
      }
    },
    "query_pct_running": {
      "code": "from ibis import _\n\n# Top 10 days by revenue\ntop_days = (\n    sales_st\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(_.total_revenue.desc())\n    .limit(10)\n)\n\n# Calculate cumulative percentage\nresult = top_days.mutate(\n    cumulative_revenue=_.total_revenue.cumsum(),\n    total_top10=_.total_revenue.sum(),\n    pct_of_top10=(_.total_revenue.cumsum() / _.total_revenue.sum() * 100).round(2)\n)",
      "sql": "SELECT\n  \"t5\".\"sale_date\",\n  \"t5\".\"total_revenue\",\n  \"t5\".\"cumulative_revenue\",\n  \"t5\".\"total_top10\",\n  CAST(ROUND(\n    (\n      SUM(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) / SUM(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING)\n    ) * 100,\n    2\n  ) AS DOUBLE) AS \"pct_of_top10\"\nFROM (\n  SELECT\n    \"t4\".\"sale_date\",\n    \"t4\".\"total_revenue\",\n    \"t4\".\"cumulative_revenue\",\n    SUM(\"t4\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"total_top10\"\n  FROM (\n    SELECT\n      \"t3\".\"sale_date\",\n      \"t3\".\"total_revenue\",\n      SUM(\"t3\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) AS \"cumulative_revenue\"\n    FROM (\n      SELECT\n        *\n      FROM (\n        SELECT\n          \"t0\".\"sale_date\",\n          SUM(\"t0\".\"revenue\") AS \"total_revenue\"\n        FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n        GROUP BY\n          1\n      ) AS \"t1\"\n      ORDER BY\n        \"t1\".\"total_revenue\" DESC\n      LIMIT 10\n    ) AS \"t3\"\n  ) AS \"t4\"\n) AS \"t5\"",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr0\u001b[0m]\n  keys:\n    \u001b[36msale_date\u001b[0m\n\nr2 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr1\u001b[0m]\n  groups:\n    \u001b[36msale_date\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr3 := OrderBy[r2]\n  sort_keys:\n    _CallableWrapper(_fn=_.total_revenue.desc())\n\nr4 := Limit[r3]\n  n:\n    10\n\n\u001b[1;32mMutate\u001b[0m[\u001b[93mr4\u001b[0m]\n  new_columns:\n    cumulative_revenue\n    total_top10\n    pct_of_top10",
      "table": {
        "columns": [
          "sale_date",
          "total_revenue",
          "cumulative_revenue",
          "total_top10",
          "pct_of_top10"
        ],
        "data": [
          [
            "2024-03-24",
            2458.56,
            2458.56,
            22405.799999999996,
            10.97
          ],
          [
            "2024-03-23",
            2382.92,
            4841.48,
            22405.799999999996,
            21.61
          ],
          [
            "2024-03-17",
            2370.91,
            7212.389999999999,
            22405.799999999996,
            32.19
          ],
          [
            "2024-03-30",
            2366.42,
            9578.81,
            22405.799999999996,
            42.75
          ],
          [
            "2024-03-16",
            2254.13,
            11832.939999999999,
            22405.799999999996,
            52.81
          ],
          [
            "2024-03-10",
            2150.55,
            13983.489999999998,
            22405.799999999996,
            62.41
          ],
          [
            "2024-03-09",
            2147.09,
            16130.579999999998,
            22405.799999999996,
            71.99
          ],
          [
            "2024-03-02",
            2121.0,
            18251.579999999998,
            22405.799999999996,
            81.46
          ],
          [
            "2024-03-03",
            2117.39,
            20368.969999999998,
            22405.799999999996,
            90.91
          ],
          [
            "2024-02-25",
            2036.83,
            22405.799999999996,
            22405.799999999996,
            100.0
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-4e10490126c921900dbc4926650b8fb4"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "sale_date",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "sale_date",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "cumulative_revenue",
                "total_top10",
                "pct_of_top10"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-4e10490126c921900dbc4926650b8fb4": [
              {
                "sale_date": "2024-03-24T00:00:00",
                "total_revenue": 2458.56,
                "cumulative_revenue": 2458.56,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 10.97
              },
              {
                "sale_date": "2024-03-23T00:00:00",
                "total_revenue": 2382.92,
                "cumulative_revenue": 4841.48,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 21.61
              },
              {
                "sale_date": "2024-03-17T00:00:00",
                "total_revenue": 2370.91,
                "cumulative_revenue": 7212.389999999999,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 32.19
              },
              {
                "sale_date": "2024-03-30T00:00:00",
                "total_revenue": 2366.42,
                "cumulative_revenue": 9578.81,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 42.75
              },
              {
                "sale_date": "2024-03-16T00:00:00",
                "total_revenue": 2254.13,
                "cumulative_revenue": 11832.939999999999,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 52.81
              },
              {
                "sale_date": "2024-03-10T00:00:00",
                "total_revenue": 2150.55,
                "cumulative_revenue": 13983.489999999998,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 62.41
              },
              {
                "sale_date": "2024-03-09T00:00:00",
                "total_revenue": 2147.09,
                "cumulative_revenue": 16130.579999999998,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 71.99
              },
              {
                "sale_date": "2024-03-02T00:00:00",
                "total_revenue": 2121.0,
                "cumulative_revenue": 18251.579999999998,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 81.46
              },
              {
                "sale_date": "2024-03-03T00:00:00",
                "total_revenue": 2117.39,
                "cumulative_revenue": 20368.969999999998,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 90.91
              },
              {
                "sale_date": "2024-02-25T00:00:00",
                "total_revenue": 2036.83,
                "cumulative_revenue": 22405.799999999996,
                "total_top10": 22405.799999999996,
                "pct_of_top10": 100.0
              }
            ]
          }
        }
      }
    },
    "query_window_filter": {
      "code": "from ibis import _\n\n# Focus on weekends only\nweekend_revenue = (\n    sales_st\n    .mutate(is_weekend=_.sale_date.day_of_week.index().isin([5, 6]))\n    .filter(_.is_weekend)\n    .group_by(\"sale_date\")\n    .aggregate(\"total_revenue\")\n    .order_by(\"sale_date\")\n)\n\n# 3-weekend moving average\nwindow_3 = ibis.window(rows=(-2, 0), order_by=\"sale_date\")\n\nresult = weekend_revenue.mutate(\n    ma_3weekend=_.total_revenue.mean().over(window_3).round(2),\n    prev_weekend=_.total_revenue.lag(),\n    weekend_change=_.total_revenue - _.total_revenue.lag()\n).limit(10)",
      "sql": "SELECT\n  \"t5\".\"sale_date\",\n  \"t5\".\"total_revenue\",\n  \"t5\".\"ma_3weekend\",\n  \"t5\".\"prev_weekend\",\n  \"t5\".\"total_revenue\" - LAG(\"t5\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"weekend_change\"\nFROM (\n  SELECT\n    \"t4\".\"sale_date\",\n    \"t4\".\"total_revenue\",\n    \"t4\".\"ma_3weekend\",\n    LAG(\"t4\".\"total_revenue\") OVER (ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS \"prev_weekend\"\n  FROM (\n    SELECT\n      \"t3\".\"sale_date\",\n      \"t3\".\"total_revenue\",\n      CAST(ROUND(\n        AVG(\"t3\".\"total_revenue\") OVER (ORDER BY \"t3\".\"sale_date\" ASC ROWS BETWEEN 2 preceding AND CURRENT ROW),\n        2\n      ) AS DOUBLE) AS \"ma_3weekend\"\n    FROM (\n      SELECT\n        *\n      FROM (\n        SELECT\n          \"t1\".\"sale_date\",\n          SUM(\"t1\".\"revenue\") AS \"total_revenue\"\n        FROM (\n          SELECT\n            \"t0\".\"sale_date\",\n            \"t0\".\"revenue\",\n            \"t0\".\"product_category\",\n            (\n              DAYOFWEEK(\"t0\".\"sale_date\") + 6\n            ) % 7 IN (5, 6) AS \"is_weekend\"\n          FROM \"ibis_pandas_memtable_g7ieny4ajvf75fksipajfeahi4\" AS \"t0\"\n          WHERE\n            (\n              DAYOFWEEK(\"t0\".\"sale_date\") + 6\n            ) % 7 IN (5, 6)\n        ) AS \"t1\"\n        GROUP BY\n          1\n      ) AS \"t2\"\n      ORDER BY\n        \"t2\".\"sale_date\" ASC\n    ) AS \"t3\"\n  ) AS \"t4\"\n) AS \"t5\"\nLIMIT 10",
      "plan": "r0 := \u001b[1;34mSemanticTable\u001b[0m: \u001b[1;34mdaily_sales\u001b[0m\n  \u001b[35mtotal_revenue [measure]\u001b[0m\n  \u001b[35mavg_revenue [measure]\u001b[0m\n  \u001b[35msale_count [measure]\u001b[0m\n\nr1 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr0\u001b[0m]\n  new_columns:\n    is_weekend\n\nr2 := \u001b[1;32mFilter\u001b[0m[\u001b[93mr1\u001b[0m]\n  predicate:\n    <predicate>\n\nr3 := \u001b[1;32mGroupBy\u001b[0m[\u001b[93mr2\u001b[0m]\n  keys:\n    \u001b[36msale_date\u001b[0m\n\nr4 := \u001b[1;32mAggregate\u001b[0m[\u001b[93mr3\u001b[0m]\n  groups:\n    \u001b[36msale_date\u001b[0m\n  metrics:\n    \u001b[35mtotal_revenue\u001b[0m\n\nr5 := OrderBy[r4]\n  sort_keys:\n    sale_date\n\nr6 := \u001b[1;32mMutate\u001b[0m[\u001b[93mr5\u001b[0m]\n  new_columns:\n    ma_3weekend\n    prev_weekend\n    weekend_change\n\nLimit[r6]\n  n:\n    10",
      "table": {
        "columns": [
          "sale_date",
          "total_revenue",
          "ma_3weekend",
          "prev_weekend",
          "weekend_change"
        ],
        "data": [
          [
            "2024-01-06",
            1400.34,
            1400.34,
            null,
            null
          ],
          [
            "2024-01-07",
            1456.44,
            1428.39,
            1400.34,
            56.100000000000136
          ],
          [
            "2024-01-13",
            1361.31,
            1406.03,
            1456.44,
            -95.13000000000011
          ],
          [
            "2024-01-14",
            1408.77,
            1408.84,
            1361.31,
            47.460000000000036
          ],
          [
            "2024-01-20",
            1448.3,
            1406.13,
            1408.77,
            39.52999999999997
          ],
          [
            "2024-01-21",
            1621.16,
            1492.74,
            1448.3,
            172.86000000000013
          ],
          [
            "2024-01-27",
            1556.55,
            1542.0,
            1621.16,
            -64.61000000000013
          ],
          [
            "2024-01-28",
            1570.34,
            1582.68,
            1556.55,
            13.789999999999964
          ],
          [
            "2024-02-03",
            1823.62,
            1650.17,
            1570.34,
            253.27999999999997
          ],
          [
            "2024-02-04",
            1717.71,
            1703.89,
            1823.62,
            -105.90999999999985
          ]
        ]
      },
      "chart": {
        "type": "vega",
        "spec": {
          "config": {
            "view": {
              "continuousWidth": 300,
              "continuousHeight": 300
            }
          },
          "data": {
            "name": "data-3a819d33c9eacd7e65be7b4ec0b9932b"
          },
          "mark": {
            "type": "bar"
          },
          "encoding": {
            "color": {
              "field": "measure",
              "type": "nominal"
            },
            "tooltip": [
              {
                "field": "sale_date",
                "type": "nominal"
              },
              {
                "field": "measure",
                "type": "nominal"
              },
              {
                "field": "value",
                "type": "quantitative"
              }
            ],
            "x": {
              "field": "sale_date",
              "sort": null,
              "type": "ordinal"
            },
            "xOffset": {
              "field": "measure"
            },
            "y": {
              "field": "value",
              "type": "quantitative"
            }
          },
          "height": 400,
          "transform": [
            {
              "fold": [
                "total_revenue",
                "ma_3weekend",
                "prev_weekend",
                "weekend_change"
              ],
              "as": [
                "measure",
                "value"
              ]
            }
          ],
          "width": 700,
          "$schema": "https://vega.github.io/schema/vega-lite/v5.20.1.json",
          "datasets": {
            "data-3a819d33c9eacd7e65be7b4ec0b9932b": [
              {
                "sale_date": "2024-01-06T00:00:00",
                "total_revenue": 1400.34,
                "ma_3weekend": 1400.34,
                "prev_weekend": null,
                "weekend_change": null
              },
              {
                "sale_date": "2024-01-07T00:00:00",
                "total_revenue": 1456.44,
                "ma_3weekend": 1428.39,
                "prev_weekend": 1400.34,
                "weekend_change": 56.100000000000136
              },
              {
                "sale_date": "2024-01-13T00:00:00",
                "total_revenue": 1361.31,
                "ma_3weekend": 1406.03,
                "prev_weekend": 1456.44,
                "weekend_change": -95.13000000000011
              },
              {
                "sale_date": "2024-01-14T00:00:00",
                "total_revenue": 1408.77,
                "ma_3weekend": 1408.84,
                "prev_weekend": 1361.31,
                "weekend_change": 47.460000000000036
              },
              {
                "sale_date": "2024-01-20T00:00:00",
                "total_revenue": 1448.3,
                "ma_3weekend": 1406.13,
                "prev_weekend": 1408.77,
                "weekend_change": 39.52999999999997
              },
              {
                "sale_date": "2024-01-21T00:00:00",
                "total_revenue": 1621.16,
                "ma_3weekend": 1492.74,
                "prev_weekend": 1448.3,
                "weekend_change": 172.86000000000013
              },
              {
                "sale_date": "2024-01-27T00:00:00",
                "total_revenue": 1556.55,
                "ma_3weekend": 1542.0,
                "prev_weekend": 1621.16,
                "weekend_change": -64.61000000000013
              },
              {
                "sale_date": "2024-01-28T00:00:00",
                "total_revenue": 1570.34,
                "ma_3weekend": 1582.68,
                "prev_weekend": 1556.55,
                "weekend_change": 13.789999999999964
              },
              {
                "sale_date": "2024-02-03T00:00:00",
                "total_revenue": 1823.62,
                "ma_3weekend": 1650.17,
                "prev_weekend": 1570.34,
                "weekend_change": 253.27999999999997
              },
              {
                "sale_date": "2024-02-04T00:00:00",
                "total_revenue": 1717.71,
                "ma_3weekend": 1703.89,
                "prev_weekend": 1823.62,
                "weekend_change": -105.90999999999985
              }
            ]
          }
        }
      }
    }
  },
  "files": {}
}
