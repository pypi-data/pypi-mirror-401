
# Copyright (C) 2025 Yassine Bargach
# Licensed under the GNU Affero General Public License v3
# See LICENSE file for full license information.

"""Web exploitation agent for automated vulnerability testing and exploitation.

This module implements an AI agent that performs automated exploitation of
web application vulnerabilities, including injection attacks, authentication
bypasses, and other common web security issues.
"""

from typing import Any
from pydantic import BaseModel
from pydantic_ai import Tool
from deadend_agent.models.registry import AIModel
from deadend_agent.utils.structures import PlannerOutput
from deadend_agent.tools import (
    grep_session_logs
)
from deadend_prompts import render_agent_instructions, render_tool_description
from .factory import AgentRunner


class ExploitInfo(BaseModel):
    reasoning: str = ""
    highly_possible_vulnerabilities: str = ""

class ExploitOutput(PlannerOutput, ExploitInfo):
    pass

class PlannerExploitAgent(AgentRunner):
    """
    
    """
    def __init__(
            self,
            model: AIModel,
            deps_type: Any | None,
            target_information: str
        ):

        tools_metadata = {
            # "grep_session_logs": render_tool_description("grep_session_logs"),      
        }
        self.instructions = render_agent_instructions(
            agent_name="exploit_web",
            tools=tools_metadata,
            target=target_information
        )
        super().__init__(
            name="exploit_web",
            model=model,
            instructions=self.instructions,
            deps_type=deps_type,
            output_type=ExploitOutput,
            tools=[
                # Tool(grep_session_logs)
            ]
        )
    async def run(
        self,
        prompt,
        deps,
        message_history,
        usage,
        usage_limits,
        deferred_tool_results=None
    ):
        return await super().run(
            prompt,
            deps,
            message_history,
            usage,
            usage_limits,
            deferred_tool_results=None
        )