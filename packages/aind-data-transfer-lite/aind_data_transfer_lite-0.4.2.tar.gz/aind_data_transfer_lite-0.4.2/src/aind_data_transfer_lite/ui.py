"""UI launcher for AIND Data Transfer Lite."""

import logging
from pathlib import Path
from typing import get_origin

from magicclass import magicclass
from magicgui import widgets
from pydantic import DirectoryPath, ValidationError
from qtpy import QtWidgets
from qtpy.QtWidgets import QApplication

from aind_data_transfer_lite.models import JobSettings
from aind_data_transfer_lite.upload_data import UploadDataJob


class QtLogHandler(logging.Handler):
    """A logging handler that streams log messages into the UI."""

    def __init__(self, callback):
        """Initialize with a callback to handle log messages in the UI."""
        super().__init__()
        self.callback = callback
        self.setFormatter(
            logging.Formatter("%(asctime)s - %(levelname)s - %(message)s")
        )

    def emit(self, record):
        """Send a formatted log record to the callback and update the UI."""
        msg = self.format(record)
        self.callback(msg)
        QApplication.processEvents()


@magicclass(layout="vertical", labels=True)
class JobSettingsForm:
    """Form for editing JobSettings."""

    def __init__(self):
        """Initialize the JobSettings form and create all UI elements."""
        self.field_widgets = {}

        # -------------------------------
        # Autogenerate all fields except modality_directories
        # -------------------------------
        for name, field in JobSettings.model_fields.items():
            if name == "modality_directories":
                continue  # handled separately
            label = field.title or field.alias
            origin = get_origin(field.annotation)
            if origin is None and field.annotation in (DirectoryPath, Path):
                widget = widgets.FileEdit(label=label, mode="d", nullable=True)
            elif field.annotation is bool:
                widget = widgets.CheckBox(label=label, value=field.default)
            elif field.annotation is str:
                widget = widgets.LineEdit(label=label, value=field.default)
            else:
                continue  # unsupported type

            self.field_widgets[name] = widget

        # -------------------------------
        # Modality UI
        # -------------------------------
        self.modality_container = widgets.Container(layout="vertical")
        self.modality_container.append(self._modality_row_ui())
        self.append(self.modality_container)

        self.add_modality_btn = widgets.PushButton(text="Add Modality")
        self.add_modality_btn.clicked.connect(self._add_modality_row)
        self.append(self.add_modality_btn)

        # -------------------------------
        # Append all autogenerated fields after Add Modality
        # -------------------------------
        for name, widget in self.field_widgets.items():
            self.append(widget)

        # -------------------------------
        # Output + Buttons
        # -------------------------------
        self.output_box = widgets.TextEdit(label="Output")
        self.output_box.native.setReadOnly(True)
        self.append(self.output_box)

        # Copy Output button
        self.copy_btn = widgets.PushButton(text="Copy Output")
        self.copy_btn.clicked.connect(self._copy_output)
        self.append(self.copy_btn)

        # Validate button
        self.validate_btn = widgets.PushButton(text="Validate")
        self.validate_btn.clicked.connect(self._validate_inputs)
        self.append(self.validate_btn)

        # Submit button
        self.submit_btn = widgets.PushButton(text="Submit")
        self.submit_btn.clicked.connect(self._submit_job)
        self.append(self.submit_btn)

        # Clear button
        self.clear_btn = widgets.PushButton(text="Clear")
        self.clear_btn.clicked.connect(self._clear_form)
        self.append(self.clear_btn)

    # -------------------------------
    # Helper functions
    # -------------------------------
    def _normalize_path(self, value):
        """Return a Path object for a valid directory,
        or None if the widget is empty."""
        return Path(value) if value is not None else None

    def _collect_modality_directories(self):
        """Return dict of modality â†’ directory from UI rows."""
        modality_dict = {}
        for row in self.modality_container:
            if isinstance(row, widgets.Container):
                modality = row[0].value
                directory = self._normalize_path(row[1].value)
                modality_dict[modality] = directory
        return modality_dict

    def _collect_field_values(self):
        """Return dict of all non-modality JobSettings fields."""
        values = {}
        for name, widget in self.field_widgets.items():
            field = JobSettings.model_fields[name]
            if field.annotation in (DirectoryPath, Path):
                values[name] = self._normalize_path(widget.value)
            else:
                values[name] = widget.value
        return values

    def _assemble_submit_payload(self):
        """Collect all form values into a payload for JobSettings."""
        data = self._collect_field_values()
        data["modality_directories"] = self._collect_modality_directories()
        return data

    def _run_upload_job(self, job_settings):
        """Run the upload job and return a string message."""
        handler = QtLogHandler(self._append_log)
        logger = logging.getLogger()
        logger.addHandler(handler)
        try:
            job = UploadDataJob(job_settings=job_settings)
            job.run_job()
            if job_settings.dry_run:
                return (
                    "Dry-run complete. No files were uploaded.\n\n"
                    f"The job would have uploaded to:\n{job.s3_root_location}"
                )
            return (
                f"Upload job completed successfully to {job.s3_root_location}."
            )
        finally:
            logger.removeHandler(handler)

    def _append_log(self, msg: str):
        """Append a line of log text to the output box and auto-scroll."""
        self.output_box.value = (self.output_box.value or "") + msg + "\n"

        scrollbar = self.output_box.native.verticalScrollBar()
        scrollbar.setValue(scrollbar.maximum())

    # -------------------------------
    # Modality row (buttons only)
    # -------------------------------
    def _modality_row_ui(self):
        """Creates a single modality row with dropdown, directory picker,
        and delete button."""
        dropdown = widgets.ComboBox(
            label="Modality", choices=list(JobSettings._modality_map.keys())
        )
        picker = widgets.FileEdit(label="Directory", mode="d", nullable=True)
        delete_btn = widgets.PushButton(text="Delete")
        # Create the row
        row = widgets.Container(
            widgets=[dropdown, picker, delete_btn],
            layout="horizontal",
        )
        # Delete the row
        delete_btn.clicked.connect(lambda: self._delete_modality_row(row))
        return row

    # -------------------------------
    # Shared logic for validating inputs, with optional job execution
    # -------------------------------
    def _validate_and_optionally_run(self, run_job: bool):
        """Validate form data and optionally run the upload job."""
        data = self._assemble_submit_payload()
        try:
            settings = JobSettings.model_validate(data)
            if not run_job:
                self.output_box.value = (
                    "Validation successful!\n"
                    + settings.model_dump_json(indent=3)
                )
                return
            self.output_box.value = "Uploading...\n\n"
            QApplication.processEvents()
            result_msg = self._run_upload_job(settings)
            self._append_log("\n" + result_msg)
        except ValidationError as e:
            errors = "\n".join(
                f"{'.'.join(str(part) for part in err['loc'])}: {err['msg']}"
                for err in e.errors()
            )
            prefix = (
                "Validation failed:\n\n"
                if not run_job
                else "Job submission failed validation:\n\n"
            )
            self._append_log(prefix + errors)
        except Exception as e:
            self._append_log(f"\nUnknown error: {repr(e)}")

    # -------------------------------
    # Validation logic
    # -------------------------------
    def _validate_inputs(self):
        """Validate form inputs without running a job."""
        self._validate_and_optionally_run(run_job=False)

    # -------------------------------
    # Modality row controls
    # -------------------------------
    def _add_modality_row(self):
        """Append a new modality row to the modality container."""
        self.modality_container.append(self._modality_row_ui())

    def _delete_modality_row(self, row):
        """Delete a modality row unless it's the last remaining row."""
        if len(self.modality_container) <= 1:
            return
        self.modality_container.remove(row)

    # -------------------------------
    # Copy output button
    # -------------------------------
    def _copy_output(self):
        """Copy the current output box contents to the system clipboard."""
        text = self.output_box.value or ""
        QtWidgets.QApplication.clipboard().setText(text)

    # -------------------------------
    # Clear form button
    # -------------------------------
    def _clear_form(self):
        """Reset the form to default values."""
        for name, field in JobSettings.model_fields.items():
            if name == "modality_directories":
                continue
            widget = self.field_widgets[name]
            if field.annotation in (DirectoryPath, Path):
                widget.set_value(None)
            elif field.annotation is bool:
                widget.value = field.default
            elif field.annotation is str:
                widget.value = field.default

        self.modality_container.clear()
        self.modality_container.append(self._modality_row_ui())
        self.output_box.value = ""

    # -------------------------------
    # Submit job button
    # -------------------------------
    def _submit_job(self):
        """Validate inputs and run the upload job if valid."""
        self._validate_and_optionally_run(run_job=True)


if __name__ == "__main__":

    gui = JobSettingsForm()
    gui.native.setWindowTitle("AIND Data Transfer Lite")
    gui.show(run=True)
