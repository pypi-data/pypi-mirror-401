#generated by GLM4.7
import turtleGL,math,random,turtle

camera = turtleGL.camera()
camera.camera_position = [0,400,0]
camera.to_target([0,0,0])
camera.camera_focal = 300
camera.type = 1
camera.rend = 1

class Player:
    def __init__(self):
        self.x = 0
        self.y = -200
        self.width = 40
        self.height = 50
        self.speed = 8
    
    def move_left(self):
        if self.x > -250:
            self.x -= self.speed
    
    def move_right(self):
        if self.x < 250:
            self.x += self.speed
    
    def get_faces(self):
        return [
            [[[20 + self.x, 0, 0 + self.y], [-20 + self.x, 0, 0 + self.y], [-20 + self.x, 0, -30 + self.y], [20 + self.x, 0, -30 + self.y]], "#00AAFF"],
            [[[0 + self.x, 0, 25 + self.y], [-20 + self.x, 0, 0 + self.y], [20 + self.x, 0, 0 + self.y]], "#00AAFF"],
            [[[-20 + self.x, 0, 0 + self.y], [-20 + self.x, 0, -30 + self.y], [-40 + self.x, 0, -40 + self.y]], "#0088CC"],
            [[[20 + self.x, 0, 0 + self.y], [40 + self.x, 0, -40 + self.y], [20 + self.x, 0, -30 + self.y]], "#0088CC"]
        ]

class Enemy:
    def __init__(self):
        self.x = random.randint(-200, 200)
        self.y = 300
        self.speed = random.randint(2, 4)
        self.width = 40
        self.height = 40
        self.active = True
    
    def update(self):
        self.y -= self.speed
        if self.y < -350:
            self.active = False
    
    def get_faces(self):
        return [
            [[[20 + self.x, 0, 20 + self.y], [-20 + self.x, 0, 20 + self.y], [-20 + self.x, 0, -20 + self.y], [20 + self.x, 0, -20 + self.y]], "#FF4444"],
            [[[0 + self.x, 0, 30 + self.y], [-20 + self.x, 0, 20 + self.y], [20 + self.x, 0, 20 + self.y]], "#FF6666"],
            [[[-20 + self.x, 0, -20 + self.y], [0 + self.x, 0, -30 + self.y], [20 + self.x, 0, -20 + self.y]], "#FF6666"]
        ]

class Bullet:
    def __init__(self, x, y):
        self.x = x
        self.y = y
        self.speed = 15
        self.width = 8
        self.height = 20
        self.active = True
    
    def update(self):
        self.y += self.speed
        if self.y > 350:
            self.active = False
    
    def get_faces(self):
        return [
            [[[4 + self.x, 0, 10 + self.y], [-4 + self.x, 0, 10 + self.y], [-4 + self.x, 0, -10 + self.y], [4 + self.x, 0, -10 + self.y]], "#FFFF00"]
        ]

class Game:
    def __init__(self):
        self.reset()
    
    def reset(self):
        self.player = Player()
        self.enemies = []
        self.bullets = []
        self.score = 0
        self.game_over = False
        self.spawn_timer = 0
        self.spawn_interval = 100
        self.frame_count = 0
        self.invulnerable_time = 300
    
    def spawn_enemy(self):
        if self.frame_count < self.invulnerable_time:
            return
        
        self.spawn_timer += 1
        if self.spawn_timer >= self.spawn_interval:
            self.enemies.append(Enemy())
            self.spawn_timer = 0
            if self.spawn_interval > 40:
                self.spawn_interval -= 1
    
    def check_collision(self, obj1, obj2):
        dx = abs(obj1.x - obj2.x)
        dy = abs(obj1.y - obj2.y)
        return dx < (obj1.width + obj2.width) / 2 and dy < (obj1.height + obj2.height) / 2
    
    def update(self):
        if self.game_over:
            return
        
        self.frame_count += 1
        self.spawn_enemy()
        
        for enemy in self.enemies:
            enemy.update()
            if self.frame_count >= self.invulnerable_time and self.check_collision(self.player, enemy):
                self.game_over = True
        
        for bullet in self.bullets:
            bullet.update()
            for enemy in self.enemies:
                if enemy.active and bullet.active and self.check_collision(bullet, enemy):
                    enemy.active = False
                    bullet.active = False
                    self.score += 10
        
        self.enemies = [e for e in self.enemies if e.active]
        self.bullets = [b for b in self.bullets if b.active]

game = Game()
keys_pressed = {'left': False, 'right': False}

def on_press_left():
    keys_pressed['left'] = True

def on_release_left():
    keys_pressed['left'] = False

def on_press_right():
    keys_pressed['right'] = True

def on_release_right():
    keys_pressed['right'] = False

def shoot():
    if not game.game_over:
        game.bullets.append(Bullet(game.player.x, game.player.y + 20))

def on_press_escape():
    raise turtle.Terminator

def reset_game():
    game.reset()

turtle.onkeypress(on_press_left, 'Right')
turtle.onkeyrelease(on_release_left, 'Right')
turtle.onkeypress(on_press_right, 'Left')
turtle.onkeyrelease(on_release_right, 'Left')
turtle.onkeypress(shoot, 'space')
turtle.onkeypress(on_press_escape, 'Escape')
turtle.onkeypress(reset_game, 'r')
turtle.listen()

try:
    while True:
        if keys_pressed['left']:
            game.player.move_left()
        if keys_pressed['right']:
            game.player.move_right()
        
        game.update()
        
        camera.clear()
        
        faces = []
        
        for face in game.player.get_faces():
            faces.append(face)
        
        for enemy in game.enemies:
            for face in enemy.get_faces():
                faces.append(face)
        
        for bullet in game.bullets:
            for face in bullet.get_faces():
                faces.append(face)
        
        scene = turtleGL.scene()
        scene.face = faces
        scene.line = []

        for face in scene.face:
            camera.drawface(face)

        camera.write([-280, 0, 250], f'得分: {game.score}', font=("Arial", 16, "bold"))
        camera.draw_axis(5)
        if game.frame_count < game.invulnerable_time:
            remaining = (game.invulnerable_time - game.frame_count) // 60
            camera.write([-150, 0, 200], f'无敌时间: {remaining}秒', font=("Arial", 14, "bold"))
        
        if game.game_over:
            camera.write([-100, 0, 0], '游戏结束!', font=("Arial", 30, "bold"))
            camera.write([-120, 0, -50], f'最终得分: {game.score}', font=("Arial", 20, "bold"))
            camera.write([-150, 0, -100], '按ESC退出', font=("Arial", 16, "bold"))
        
        camera.update()
except turtle.Terminator:
    pass
except KeyboardInterrupt:
    pass
