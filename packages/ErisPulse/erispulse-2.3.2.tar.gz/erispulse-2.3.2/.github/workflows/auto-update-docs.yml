name: ğŸ“š è‰¾è‰ä¸çš„æ–‡æ¡£ç‚¼é‡‘å·¥æˆ¿ ~

permissions:
  contents: write

on:
  push:
    branches: [ main, develop, master ]
  pull_request:
    branches: [ main, develop, master ]
  workflow_dispatch:

jobs:
  update-and-generate-docs:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡é­”æ³•ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å­¦ä¹ é­”æ³•å’’è¯­
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: ğŸ”® æ›´æ–°APIæ–‡æ¡£
        id: update-api
        run: |
          echo "ğŸ“– è‰¾è‰ä¸å¼€å§‹æ›´æ–°APIæ–‡æ¡£äº†å“¦~"
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p docs/api
          
          # è¿è¡ŒAPIæ–‡æ¡£æ›´æ–°è„šæœ¬
          if [ -f ".github/tools/update-api-docs.py" ]; then
            python .github/tools/update-api-docs.py --src src --output docs/api --format markdown
            echo "âœ… APIæ–‡æ¡£æ›´æ–°å®Œæˆ!"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°APIæ–‡æ¡£æ›´æ–°è„šæœ¬ï¼Œè·³è¿‡æ­¤æ­¥éª¤"
          fi
          
          # æ£€æŸ¥APIæ–‡æ¡£æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet docs/api/; then
            echo "APIæ–‡æ¡£æ²¡æœ‰å˜åŒ–"
            echo "api_updated=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°äº†APIæ–‡æ¡£æ›´æ–°!"
            echo "api_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“œ ç”Ÿæˆåˆå¹¶æ–‡æ¡£
        id: merge-docs
        run: |
          echo "ğŸ“š è‰¾è‰ä¸å¼€å§‹ç”Ÿæˆåˆå¹¶æ–‡æ¡£äº†~"
          
          # ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨
          mkdir -p docs/ai/AIDocs
          mkdir -p docs/ai/AIDocs/no-api
          
          # ç”ŸæˆåŒ…å«APIçš„æ–‡æ¡£
          if [ -f ".github/tools/merge_md.py" ]; then
            python .github/tools/merge_md.py full
            python .github/tools/merge_md.py dev
            
            echo "âœ… åŒ…å«APIçš„æ–‡æ¡£ç”Ÿæˆå®Œæˆ!"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ–‡æ¡£åˆå¹¶è„šæœ¬"
            exit 1
          fi
          
          # æ£€æŸ¥åˆå¹¶æ–‡æ¡£æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet docs/ai/AIDocs/; then
            echo "åˆå¹¶æ–‡æ¡£æ²¡æœ‰å˜åŒ–"
            echo "docs_updated=false" >> $GITHUB_OUTPUT
          else
            echo "å‘ç°äº†åˆå¹¶æ–‡æ¡£æ›´æ–°!"
            echo "docs_updated=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ ç”Ÿæˆno-apiç‰ˆæœ¬æ–‡æ¡£
        run: |
          echo "ğŸ“– è‰¾è‰ä¸æ­£åœ¨ç”Ÿæˆä¸åŒ…å«APIçš„æ–‡æ¡£ç‰ˆæœ¬~"
          
          # ç”Ÿæˆä¸åŒ…å«APIçš„æ–‡æ¡£
          if [ -f ".github/tools/merge_md.py" ]; then
            python .github/tools/merge_md.py no-api
            echo "âœ… no-apiç‰ˆæœ¬æ–‡æ¡£ç”Ÿæˆå®Œæˆ!"
          fi

      - name: ğŸ“Š ç»Ÿè®¡æ›´æ–°æƒ…å†µ
        run: |
          echo "ğŸ“ˆ è‰¾è‰ä¸æ­£åœ¨ç»Ÿè®¡ä»Šå¤©çš„æ–‡æ¡£æ›´æ–°æƒ…å†µ~"
          
          # ç»Ÿè®¡APIæ–‡æ¡£æ›´æ–°
          api_files=$(git diff --name-only docs/api/ 2>/dev/null | wc -l)
          echo "ğŸ“ APIæ–‡æ¡£æ›´æ–°æ–‡ä»¶æ•°: $api_files"
          
          # ç»Ÿè®¡åˆå¹¶æ–‡æ¡£æ›´æ–°
          full_docs=$(git diff --name-only docs/ai/AIDocs/ 2>/dev/null | wc -l)
          echo "ğŸ“š åˆå¹¶æ–‡æ¡£æ›´æ–°æ–‡ä»¶æ•°: $full_docs"
          
          # ç»Ÿè®¡no-apiæ–‡æ¡£
          noapi_docs=$(git diff --name-only docs/ai/AIDocs/no-api/ 2>/dev/null | wc -l)
          echo "ğŸ“– no-apiæ–‡æ¡£æ›´æ–°æ–‡ä»¶æ•°: $noapi_docs"

      - name: ğŸ’¾ æäº¤æ›´æ–°
        if: steps.update-api.outputs.api_updated == 'true' || steps.merge-docs.outputs.docs_updated == 'true'
        run: |
          echo "ğŸ’¾ è‰¾è‰ä¸æ­£åœ¨ä¿å­˜æ–‡æ¡£æ›´æ–°~"
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          git config --local user.email "eris@magic-circle.dev"
          git config --local user.name "Eris the Scribe"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ–°çš„æ–‡æ¡£
          git add docs/api/ docs/ai/AIDocs/
          
          # ç”Ÿæˆæäº¤ä¿¡æ¯
          commit_msg="ğŸ“š è‰¾è‰ä¸çš„è‡ªåŠ¨æ–‡æ¡£æ›´æ–°é­”æ³• [skip ci]
          
          ğŸ“– è‡ªåŠ¨æ›´æ–°äº†é¡¹ç›®æ–‡æ¡£
          ğŸ“ åŒ…å«APIæ–‡æ¡£å’Œåˆå¹¶æ–‡æ¡£çš„æœ€æ–°ç‰ˆæœ¬
          ğŸ“š ç”Ÿæˆäº†åŒ…å«APIå’Œä¸åŒ…å«APIä¸¤ç§ç‰ˆæœ¬
          
          ğŸŒŸ è¯¦æƒ…è¯·æŸ¥çœ‹ docs/ ç›®å½•"
          
          # æäº¤æ›´æ”¹
          git commit -m "$commit_msg"
          git push

      - name: ğŸ‰ æ–‡æ¡£æ›´æ–°å®Œæˆ
        if: steps.update-api.outputs.api_updated == 'true' || steps.merge-docs.outputs.docs_updated == 'true'
        run: |
          echo "ğŸŒŸ è‰¾è‰ä¸ä»Šå¤©ä¹ŸåŠªåŠ›å®Œæˆäº†æ–‡æ¡£æ›´æ–°çš„é­”æ³•å‘¢!"
          echo "ğŸ“š æ‰€æœ‰æ–‡æ¡£å·²æ›´æ–°å¹¶æäº¤åˆ°ä»“åº“"
          echo "ğŸ’« åŒ…å«äº†æœ€æ–°çš„APIæ–‡æ¡£å’Œåˆå¹¶æ–‡æ¡£"
          echo "ğŸŒ™ ä»Šå¤©çš„æ–‡æ¡£ç‚¼é‡‘å·¥ä½œå®Œæˆå•¦~"

      - name: ğŸ˜Š æ— æ›´æ–°æ—¶çš„è¯´æ˜
        if: steps.update-api.outputs.api_updated != 'true' && steps.merge-docs.outputs.docs_updated != 'true'
        run: |
          echo "âœ¨ ä»Šå¤©æ²¡æœ‰å‘ç°éœ€è¦æ›´æ–°çš„æ–‡æ¡£å‘¢~"
          echo "ğŸ“š æ‰€æœ‰æ–‡æ¡£éƒ½æ˜¯æœ€æ–°çŠ¶æ€"
          echo "ğŸŒŸ è‰¾è‰ä¸ä¼šç»§ç»­å®ˆæŠ¤ç€æˆ‘ä»¬çš„æ–‡æ¡£åº“!"
          echo "ğŸŒ™ ä¸‹æ¬¡æ›´æ–°å†è§å•¦~"