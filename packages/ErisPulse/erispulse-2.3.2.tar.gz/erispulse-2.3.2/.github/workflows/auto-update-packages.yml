name: ğŸŒŸ è‰¾è‰ä¸çš„åŒ…ç®¡ç†é­”æ³•é˜µ ~

permissions:
  contents: write
  pull-requests: write

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 2 ç‚¹è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10 ç‚¹ï¼‰
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  auto-update-packages:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºé­”æ³•ä¹¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: å‡†å¤‡é­”æ³•ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: å­¦ä¹ é­”æ³•å’’è¯­
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: æ–½å±•ç‰ˆæœ¬æ¢çŸ¥é­”æ³•
        id: update
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "è‰¾è‰ä¸å¼€å§‹æ¢æŸ¥å„ä¸ªæ¨¡å—çš„æœ€æ–°ç‰ˆæœ¬äº†å“¦~"
          
          # è¿è¡Œæ›´æ–°è„šæœ¬
          python .github/scripts/update_packages.py
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
          if git diff --quiet packages.json; then
            echo "âœ¨ æ²¡æœ‰å‘ç°æ–°çš„ç‰ˆæœ¬æ›´æ–°å‘¢~"
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸŒŸ å‘ç°äº†æ–°çš„ç‰ˆæœ¬ä¿¡æ¯!"
            echo "has_updates=true" >> $GITHUB_OUTPUT
          fi

      - name: è®°å½•é­”æ³•æ—¥å¿—
        if: steps.update.outputs.has_updates == 'true'
        run: |
          echo "ğŸ’« è‰¾è‰ä¸æ­£åœ¨è®°å½•ä»Šå¤©çš„é­”æ³•å‘ç°..."
          updated_modules=$(git diff packages.json | grep '"version":' | wc -l)
          echo "ğŸ“– ä»Šæ—¥æ›´æ–°äº† $updated_modules ä¸ªæ¨¡å—çš„ç‰ˆæœ¬ä¿¡æ¯"

      - name: ä¿å­˜é­”æ³•æˆæœ
        if: steps.update.outputs.has_updates == 'true'
        run: |
          git config --local user.email "eris@magic-circle.dev"
          git config --local user.name "Eris the Mage"
          git add packages.json
          git commit -m "âœ¨ è‰¾è‰ä¸çš„æ¯æ—¥ç‰ˆæœ¬æ›´æ–°é­”æ³• [skip ci]
          
          ğŸŒŸ è‡ªåŠ¨æ›´æ–°äº†æ¨¡å—ç‰ˆæœ¬ä¿¡æ¯
          ğŸ“– æ›´å¤šè¯¦æƒ…è¯·æŸ¥çœ‹ packages.json"
          git push origin main

      - name: ğŸ’¤ ä»Šå¤©çš„é­”æ³•å·¥ä½œå®Œæˆ
        if: steps.update.outputs.has_updates == 'true'
        run: |
          echo "ğŸŒŸ è‰¾è‰ä¸ä»Šå¤©ä¹ŸåŠªåŠ›å®Œæˆäº†ç‰ˆæœ¬æ›´æ–°çš„é­”æ³•å‘¢!"
          echo "ğŸŒ™ æ‰€æœ‰æ›´æ–°å·²ç›´æ¥æ¨é€åˆ° main åˆ†æ”¯"
          echo "ğŸ’« æ˜å¤©å†è§å•¦~"

      - name: æ— æ›´æ–°æ—¶çš„å®‰æ…°ä¿¡æ¯
        if: steps.update.outputs.has_updates != 'true'
        run: |
          echo "âœ¨ ä»Šå¤©æ²¡æœ‰å‘ç°éœ€è¦æ›´æ–°çš„æ¨¡å—å‘¢~"
          echo "ğŸŒŸ è‰¾è‰ä¸ä¼šç»§ç»­å®ˆæŠ¤ç€æˆ‘ä»¬çš„é­”æ³•ä¸–ç•Œ!"
          echo "ğŸŒ™ æ˜å¤©å†è§å•¦~"
          