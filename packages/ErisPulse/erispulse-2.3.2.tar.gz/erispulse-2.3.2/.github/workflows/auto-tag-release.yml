name: ğŸ€ è‰¾è‰ä¸çš„ç‰ˆæœ¬æ ‡ç­¾é­”æ³• ~

permissions:
  contents: write

on:
  push:
    branches: [main, Pre-Release/v2]

jobs:
  update-latest-release:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: æ–½å±•ç‰ˆæœ¬é­”æ³•
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          # è¯»å–å½“å‰ç‰ˆæœ¬
          version=$(grep '^version' pyproject.toml | head -1 | sed 's/version = "//;s/"//')
          tag_name="v$version"
          
          echo "å½“å‰ç‰ˆæœ¬: $version"
          echo "æ ‡ç­¾åç§°: $tag_name"
          
          # ä» CHANGELOG.md æå–æ›´æ–°æ—¥å¿—
          if [ -f "CHANGELOG.md" ]; then
            # ä¿®å¤ç‰ˆæœ¬å·æ ¼å¼ï¼šå°† -de. æ›¿æ¢ä¸º -dev.
            fixed_version=$(echo "$version" | sed 's/-de\./-dev./g')
            
            echo "å°è¯•åŒ¹é…ç‰ˆæœ¬: $version æˆ– $fixed_version"
            
            # ä½¿ç”¨ sed æå–ç‰ˆæœ¬æ›´æ–°æ—¥å¿—
            # å…ˆå°è¯•åŒ¹é…åŸå§‹ç‰ˆæœ¬å·
            changelog_section=$(sed -n "/^## \[$version\] -/,/^## \[.*\] -/p" CHANGELOG.md | sed '$d')
            
            # å¦‚æœæ²¡æ‰¾åˆ°ï¼Œå°è¯•åŒ¹é…ä¿®å¤åçš„ç‰ˆæœ¬å·
            if [ -z "$changelog_section" ]; then
              changelog_section=$(sed -n "/^## \[$fixed_version\] -/,/^## \[.*\] -/p" CHANGELOG.md | sed '$d')
            fi
            
            # ç§»é™¤ç¬¬ä¸€è¡Œï¼ˆæ ‡é¢˜è¡Œï¼‰
            if [ -n "$changelog_section" ]; then
              changelog=$(echo "$changelog_section" | tail -n +2)
              
              # åˆ¤æ–­æ˜¯å¦ä¸ºå¼€å‘ç‰ˆæœ¬
              if [[ $version =~ dev|alpha|beta|pre|a|b ]]; then
                is_dev="true"
                latest_flag=""
              else
                is_dev="false"
                latest_flag="--latest"
              fi
              
              # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
              if ! git rev-parse "$tag_name" >/dev/null 2>&1; then
                echo "ğŸ€ğŸ€ åˆ›å»ºæ–°æ ‡ç­¾ $tag_name..."
                git tag "$tag_name"
                git push origin "$tag_name"
              else
                echo "æ ‡ç­¾ $tag_name å·²å­˜åœ¨"
              fi
              
              # æ£€æŸ¥å‘è¡Œæ˜¯å¦å­˜åœ¨
              if gh release view "$tag_name" &>/dev/null; then
                # æ›´æ–°å‘è¡Œ
                echo "ğŸ”„ æ›´æ–°å‘è¡Œ $tag_name..."
                gh release edit "$tag_name" \
                  --notes "$changelog" \
                  --prerelease=$is_dev
                echo "âœ… å·²æ›´æ–°å‘è¡Œ $tag_name"
              else
                # åˆ›å»ºå‘è¡Œ
                echo "âœ¨ åˆ›å»ºå‘è¡Œ $tag_name..."
                gh release create "$tag_name" \
                  --notes "$changelog" \
                  --title "âœ¨ è‰¾è‰ä¸çš„é­”æ³•æ›´æ–° $tag_name" \
                  --prerelease=$is_dev \
                  $latest_flag
                echo "âœ… å·²åˆ›å»ºå‘è¡Œ $tag_name"
              fi
              
              echo "ğŸ“¦ å‘è¡Œé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/$tag_name"
            else
              echo "âš ï¸ æœªæ‰¾åˆ°ç‰ˆæœ¬ $version çš„æ›´æ–°æ—¥å¿—"
            fi
          else
            echo "âš ï¸ CHANGELOG.md æ–‡ä»¶ä¸å­˜åœ¨"
          fi
