"""Common encoding codec operations"""

import base64
import html
import urllib.parse
from typing import Iterable

__all__ = [
    "sjoin",
    "base64_encode",
    "base64_decode",
    "url_encode",
    "url_decode",
    "html_encode",
    "html_decode",
]


def sjoin(texts: Iterable[str], front: str = "", mid: str = "", after: str = "") -> str:
    """
    Join strings with specific format

    >>> sjoin("abc", front="#")
    '#a#b#c'
    >>> sjoin("abc", after="!")
    'a!b!c!'
    >>> sjoin(["A", "B", "C"], front="<", mid=", ", after=">")
    '<A>, <B>, <C>'
    """
    return mid.join(f"{front}{i}{after}" for i in texts)


def hex2(i: int) -> str:
    """
    Convert integer to hexadecimal string with leading zeros

    >>> hex2(10)
    '0a'
    """
    return hex(i)[2:].zfill(2)


def base64_encode(text: str | bytes, encoding: str = "utf-8") -> str:
    """
    Base64 encode

    >>> base64_encode("Hello, World!")
    'SGVsbG8sIFdvcmxkIQ=='
    >>> base64_encode(b"Hello, World!")
    'SGVsbG8sIFdvcmxkIQ=='
    """
    if isinstance(text, str):
        text = text.encode(encoding=encoding)
    return base64.b64encode(text).decode(encoding=encoding)


def base64_decode(
    text: str, tostr: bool = False, encoding: str = "utf-8"
) -> bytes | str:
    """
    Base64 decode

    >>> base64_decode("SGVsbG8sIFdvcmxkIQ==")
    b'Hello, World!'
    >>> base64_decode("SGVsbG8sIFdvcmxkIQ==", tostr=True)
    'Hello, World!'
    """
    t = base64.b64decode(text)
    return t.decode(encoding=encoding) if tostr else t


def url_encode(text: str, encoding: str = "utf-8", all: bool = False) -> str:
    """
    URL encode

    >>> url_encode("Hello, World!")
    'Hello%2C%20World%21'
    >>> url_encode(b"Hello, World!", all=True)
    '%48%65%6c%6c%6f%2c%20%57%6f%72%6c%64%21'
    """
    if all:
        return sjoin((hex2(i) for i in text.encode(encoding=encoding)), front="%")
    return urllib.parse.quote(text, encoding=encoding)


def url_decode(text: str, encoding: str = "utf-8") -> str:
    """
    URL decode

    >>> url_decode("Hello%2C%20World%21")
    'Hello, World!'
    >>> url_decode("%48%65%6c%6c%6f%2c%20%57%6f%72%6c%64%21")
    'Hello, World!'
    """
    return urllib.parse.unquote(text, encoding=encoding)


def html_encode(text: str, all: bool = False):
    """
    HTML encode

    >>> html_encode("Hello, World!")
    'Hello&#44;&#32;World&#33;'
    >>> html_encode(b"Hello, World!", all=True)
    '&#72;&#101;&#108;&#108;&#111;&#44;&#32;&#87;&#111;&#114;&#108;&#100;&#33;'
    """
    if all:
        return sjoin((str(ord(i)) for i in text), front="&#", after=";")
    return html.escape(text)


def html_decode(text: str):
    """
    HTML decode

    >>> html_decode("Hello&#44;&#32;World&#33;")
    'Hello, World!'
    >>> html_decode("&#72;&#101;&#108;&#108;&#111;")
    'Hello'
    """
    return html.unescape(text)
