"""Command line argument related functionality"""

import argparse
import copy
from dataclasses import dataclass, field
from typing import Any, Callable, Iterable, Literal, TypedDict, cast

__all__ = [
    "ArgOptions",
    "Arg",
    "Preset",
    "Parser",
    "URL",
    "FILE",
    "OUTPUT",
    "THREADS",
    "DEBUG",
    "RHOST",
    "RPORT",
    "LHOST",
    "LPORT",
    "DICT",
    "COMMAND",
    "BASIC_PRESET",
    "REVERSE_SHELL_PRESET",
    "SCAN_PRESET",
]


class ArgOptions(TypedDict, total=False):
    action: str | type[argparse.Action]
    nargs: int | Literal["?", "*", "+"]
    const: Any
    default: Any
    type: Callable[[str], Any]
    choices: Iterable[Any]
    required: bool
    help: str
    metavar: str | tuple[str, ...]
    dest: str
    version: str


@dataclass
class Arg:
    name_or_flags: tuple[str, ...] = ()
    options: ArgOptions = field(default_factory=lambda: cast(ArgOptions, {}))

    def __call__(self, options: ArgOptions) -> "Arg":
        """Create a copy of this argument with modified options"""
        new_options = copy.deepcopy(self.options)
        new_options.update(options)
        return Arg(self.name_or_flags, new_options)


type Preset = list[Arg]


class Parser(argparse.ArgumentParser):
    """
    Parser for command line arguments like `argparse.ArgumentParser`

    Example:
    ```
    parser = Parser()
    parser.load_args(BASIC_PRESET + [DEBUG])
    parser.add_argument("--costume", help="Costume arg")
    args = parser.parse_args()
    ```
    """

    def load_args(self, args: Iterable[Arg]) -> None:
        """Batch import command line arguments defined by `exploit_utils.args.Arg`"""
        for arg in args:
            self.add_argument(*arg.name_or_flags, **arg.options)


URL = Arg(("--url", "-u"), {"help": "Target URL"})
"""--url URL, -u URL  Target URL"""
FILE = Arg(("--file", "-f"), {"help": "Batch get URLs from file"})
"""--file FILE, -f FILE  Batch get URLs from file"""
OUTPUT = Arg(("--output", "-o"), {"help": "Output file"})
"""--output OUTPUT, -o OUTPUT  Output file"""
THREADS = Arg(
    ("--threads", "-t"), {"type": int, "default": 5, "help": "Number of threads"}
)
"""--threads THREADS, -t THREADS  Number of threads"""
DEBUG = Arg(("--debug",), {"action": "store_true", "help": "Enable debug mode"})
"""--debug  Enable debug mode"""
RHOST = Arg(("--rhost", "-rh"), {"required": True, "help": "Target host"})
"""--rhost RHOST, -rh RHOST  Target host"""
RPORT = Arg(("--rport", "-rp"), {"type": int, "default": 80, "help": "Target port"})
"""--rport RPORT, -rp RPORT  Target port"""
LHOST = Arg(
    ("--lhost", "-lh"),
    {"default": "127.0.0.1", "help": "Local host (callback address)"},
)
"""--lhost LHOST, -lh LHOST  Local host (callback address)"""
LPORT = Arg(
    ("--lport", "-lp"),
    {"type": int, "default": 8080, "help": "Local port (callback port)"},
)
"""--lport LPORT, -lp LPORT  Local port (callback port)"""
DICT = Arg(("--dict", "-d"), {"help": "Specify dictionary"})
"""--dict DICT, -d DICT  Specify dictionary"""
COMMAND = Arg(("--command", "-c"), {"default": "whoami", "help": "Command to execute"})
"""--command COMMAND, -c COMMAND  Command to execute"""

BASIC_PRESET: Preset = [URL, FILE, OUTPUT, THREADS]
"""Basic preset containing commonly used exp parameters:
```
--url URL, -u URL              Target URL
--file FILE, -f FILE           Batch get URLs from file
--output OUTPUT, -o OUTPUT     Output file
--threads THREADS, -t THREADS  Number of threads
```"""

REVERSE_SHELL_PRESET: Preset = [RHOST, RPORT, LHOST, LPORT]
"""Reverse shell preset containing callback related parameters:
```
--rhost RHOST, -rh RHOST  Target host
--rport RPORT, -rp RPORT  Target port
--lhost LHOST, -lh LHOST  Local host (callback address)
--lport LPORT, -lp LPORT  Local port (callback port)
```"""

SCAN_PRESET: Preset = [URL, THREADS, DICT]
"""Scanner preset containing basic scanning parameters:
```
--url URL, -u URL              Target URL
--threads THREADS, -t THREADS  Number of threads
--dict DICT, -d DICT           Specify dictionary
```"""
