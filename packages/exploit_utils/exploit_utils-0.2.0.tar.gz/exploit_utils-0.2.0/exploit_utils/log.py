"""Logging related operations"""

import logging
from pathlib import Path
from threading import Lock

import tqdm

__all__ = ["get_logger", "add_outputfile", "RecordSet", "Logger", "rootlogger"]


class TqdmStream:
    def write(self, s: str) -> None:
        tqdm.tqdm.write(s, end="")


class RecordSet(set):
    """A thread-safe set that records its elements to a specified file in real-time"""

    def __init__(self, path: Path | str, **options) -> None:
        super().__init__(**options)
        self.save_path = path
        self.lock = Lock()

    def add(self, elm: str) -> None:
        if elm not in self:
            with self.lock, open(self.save_path, "a") as f:
                f.write(elm + "\n")
        return super().add(elm)


# Added SUCCESS and FAILURE log levels
SUCCESS = 25
logging.addLevelName(SUCCESS, "SUCCESS")
FAILURE = 35
logging.addLevelName(FAILURE, "FAILURE")


class Logger(object):
    """Wrapper for logging.Logger"""

    def __init__(self, logger: logging.Logger | None = None) -> None:
        if logger is None:
            module = self.__module__
            if not module.startswith("exploit_utils"):
                module = "exploit_utils." + module

            logger_name = "%s.%s.%s" % (module, self.__class__.__name__, id(self))
            logger = logging.getLogger(logger_name)

        self._logger = logger

    def set_level(self, level: int) -> None:
        """Set the log level"""
        self._logger.setLevel(level)

    def add_handler(self, handler: logging.Handler) -> None:
        """Add a log handler"""
        self._logger.addHandler(handler)

    def _log(self, level: int, message: str, *args, **kwargs) -> None:
        if self._logger is not None:
            self._logger._log(level, message, *args, **kwargs)

    def debug(self, message: str, *args, **kwargs) -> None:
        """Log debug information"""
        if self._logger.isEnabledFor(logging.DEBUG):
            self._log(logging.DEBUG, message, args, **kwargs)

    def info(self, message: str, *args, **kwargs) -> None:
        """Log information"""
        if self._logger.isEnabledFor(logging.INFO):
            self._log(logging.INFO, message, args, **kwargs)

    def warning(self, message: str, *args, **kwargs) -> None:
        """Log warning information"""
        if self._logger.isEnabledFor(logging.WARNING):
            self._log(logging.WARNING, message, args, **kwargs)

    def warn(self, message: str, *args, **kwargs) -> None:
        """Log warning information (alias)"""
        self.warning(message, *args, **kwargs)

    def error(self, message: str, *args, **kwargs) -> None:
        """Log error information"""
        if self._logger.isEnabledFor(logging.ERROR):
            self._log(logging.ERROR, message, args, **kwargs)

    def critical(self, message: str, *args, **kwargs) -> None:
        """Log critical error information"""
        if self._logger.isEnabledFor(logging.CRITICAL):
            self._log(logging.CRITICAL, message, args, **kwargs)

    def success(self, message: str, *args, **kwargs) -> None:
        """Log success information"""
        if self._logger.isEnabledFor(SUCCESS):
            self._log(SUCCESS, message, args, **kwargs)

    def failure(self, message: str, *args, **kwargs) -> None:
        """Log failure information"""
        if self._logger.isEnabledFor(FAILURE):
            self._log(FAILURE, message, args, **kwargs)

    def ok(self, message: str, *args, **kwargs) -> None:
        """Log success information (alias)"""
        self.success(message, *args, **kwargs)


def get_logger(name: str = "exploit_utils") -> Logger:
    return Logger(logging.getLogger(name))


def add_outputfile(path: Path | str) -> None:
    """Add file output to the logger"""
    file_handler = logging.FileHandler(path)
    formatter = logging.Formatter("[%(levelname)s] %(message)s")
    file_handler.setFormatter(formatter)
    get_logger().add_handler(file_handler)


rootlogger = get_logger()
rootlogger.set_level(logging.INFO)

formatter = logging.Formatter("[%(levelname)s] %(message)s")

# Console output
console_handler = logging.StreamHandler(stream=TqdmStream())
console_handler.setFormatter(formatter)
rootlogger.add_handler(console_handler)
