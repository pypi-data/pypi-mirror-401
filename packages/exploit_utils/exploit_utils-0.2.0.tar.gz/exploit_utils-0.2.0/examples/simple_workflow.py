"""示例: 一个简单的调用本地安全工具的工作流"""

import logging
from pathlib import Path

import exploit_utils as exp

banner = r"""
     _            _                      _    __ _
  __(_)_ __  _ __| |___  __ __ _____ _ _| |__/ _| |_____ __ __
 (_-< | '  \| '_ \ / -_) \ V  V / _ \ '_| / /  _| / _ \ V  V /
 /__/_|_|_|_| .__/_\___|  \_/\_/\___/_| |_\_\_| |_\___/\_/\_/
            |_|
"""
# 获取 logger, 记录日志
logger = exp.log.get_logger()


def workflow(target: str, output: Path) -> None:
    """
    对目标执行以下工作流:

    subfinder 获取子域名 -> rustscan 端口扫描 -> httpx 筛选 web 服务 -> nuclie 探测漏洞
    """
    logger.info(f"start workflow, {target=}")
    # 最终输出文件
    save_path = str(output / target.replace(".", "_"))
    # 创建临时文件夹, 用于存放中间结果
    with exp.fs.temp_dir() as temp_dir:
        domains = temp_dir / "domains.txt"
        all_targets = temp_dir / "all_targets.txt"
        web_targets = temp_dir / "web_targets.txt"
        # 依次执行工作流中的操作
        try:
            # subfinder 获取子域名
            # exp.sh.run 执行系统命令, raise_err 当存在错误输出时会抛出 StdErr 异常
            logger.debug("run subfinder")
            exp.sh.run(["subfinder", "-d", target, "-o", str(domains)]).raise_err()
            # rustscan 端口扫描
            # exp.sh.run 默认使用文本模式捕获输出, 可以使用 stdout 获取标准输出
            logger.debug("run rustscan")
            result = exp.sh.run(
                [
                    "rustscan",
                    "-a",
                    str(domains),
                    "-p",
                    "80,443,8080,8443,3000,5000,8000-9000",
                    "--ulimit",
                    "5000",
                    "-g",
                ]
            )
            result.raise_err()
            with open(str(all_targets), "w") as f:
                f.write(str(result.stdout))
            # httpx 筛选 web 服务
            logger.debug("run httpx")
            exp.sh.run(
                ["httpx", "-l", str(all_targets), "-o", str(web_targets)]
            ).raise_err()
            # nuclie 探测漏洞
            logger.debug("run nuclie")
            exp.sh.run(
                ["nuclie", "-l", str(web_targets), "-o", str(save_path)]
            ).raise_err()
        except exp.sh.StdErr as e:
            logger.error(f"workflow stop, stderr: {e.err}")
            return

    logger.ok(f"workflow done, result save at {save_path}")


if __name__ == "__main__":
    # 获取命令行参数
    parser = exp.args.Parser(description="输入域名, 自动化探测相关资产及其漏洞")
    parser.load_args(
        [
            exp.args.FILE({"required": True, "help": "输入域名列表文件"}),
            exp.args.OUTPUT(
                {
                    "type": Path,
                    "default": exp.fs.rget("results"),
                    "help": "输出存放路径",
                }
            ),
            exp.args.DEBUG,
        ]
    )
    args = parser.parse_args()
    # 打印 banner
    exp.misc.show_banner(banner)
    # 开启调试输出
    if args.debug:
        logger.set_level(logging.DEBUG)
    # 创建保存结果目录
    output_path: Path = args.output
    output_path.mkdir(exist_ok=True)
    # 设置日志输出文件
    exp.log.add_outputfile(output_path / "workflow.log")
    # 读取输入文件, 执行工作流
    for target in exp.fs.parse_lines(args.file):
        workflow(target, output_path)
