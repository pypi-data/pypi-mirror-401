spec is "1.0"

tool "echo":
  implemented using builtin

  input:
    value is json

  output:
    echo is json

ai "assistant":
  provider is "mock"
  model is "gpt-4.1"
  system_prompt is "You are a helpful multi-agent assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

ai "assistant_openai":
  provider is "openai"
  model is "gpt-4.1"
  system_prompt is "You are a helpful multi-agent assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

ai "assistant_openai_fallback":
  provider is "openai"
  model is "gpt-4o-mini"
  system_prompt is "You are a helpful multi-agent assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

agent "planner":
  ai is "assistant"
  system_prompt is "Plan step-by-step."

agent "critic":
  ai is "assistant"
  system_prompt is "Find risks and gaps."

agent "researcher":
  ai is "assistant"
  system_prompt is "Add supporting details."

agent "planner_openai":
  ai is "assistant_openai"
  system_prompt is "Plan step-by-step."

agent "critic_openai":
  ai is "assistant_openai"
  system_prompt is "Find risks and gaps."

agent "researcher_openai":
  ai is "assistant_openai"
  system_prompt is "Add supporting details."

agent "planner_openai_fallback":
  ai is "assistant_openai_fallback"
  system_prompt is "Plan step-by-step."

agent "critic_openai_fallback":
  ai is "assistant_openai_fallback"
  system_prompt is "Find risks and gaps."

agent "researcher_openai_fallback":
  ai is "assistant_openai_fallback"
  system_prompt is "Add supporting details."

define function "select ai provider":
  input:
    openai_available is boolean
  output:
    provider is text
    mode is text
  if openai_available is true:
    return map:
      "provider" is "assistant_openai"
      "mode" is "real"
  return map:
    "provider" is "assistant"
    "mode" is "mock"

flow "run_workflow":
  let task is "Plan a 3-step launch checklist for {{PROJECT_NAME}}"
  let openai_status is map get secrets key "NAMEL3SS_OPENAI_API_KEY"
  let selection is call function "select ai provider":
    openai_available is openai_status.available
  set state.ai_provider_selected is selection.provider
  set state.ai_mode is selection.mode
  let selected is selection.provider
  if selected is "assistant_openai":
    try:
      run agent "planner_openai" with input: task as plan
      run agents in parallel:
        agent "critic_openai" with input: plan
        agent "researcher_openai" with input: plan
      as feedback
      ask ai "assistant_openai" with input: plan as final
      set state.status.message is "AI Mode: OpenAI ✅"
    with catch err:
      let category is err.details.diagnostic.category
      if category is "model_access":
        try:
          run agent "planner_openai_fallback" with input: task as plan
          run agents in parallel:
            agent "critic_openai_fallback" with input: plan
            agent "researcher_openai_fallback" with input: plan
          as feedback
          ask ai "assistant_openai_fallback" with input: plan as final
          set state.status.message is "AI Mode: OpenAI ✅ (model downgraded to gpt-4o-mini)"
        with catch err:
          set state.status.message is "OpenAI failed - using mock (see Traces)."
          set state.ai_provider_selected is "assistant"
          set state.ai_mode is "mock"
          run agent "planner" with input: task as plan
          run agents in parallel:
            agent "critic" with input: plan
            agent "researcher" with input: plan
          as feedback
          ask ai "assistant" with input: plan as final
      else:
        if category is "server" or category is "network":
          try:
            run agent "planner_openai" with input: task as plan
            run agents in parallel:
              agent "critic_openai" with input: plan
              agent "researcher_openai" with input: plan
            as feedback
            ask ai "assistant_openai" with input: plan as final
            set state.status.message is "AI Mode: OpenAI ✅"
          with catch err:
            set state.status.message is "OpenAI unavailable - using mock (see Traces)."
            set state.ai_provider_selected is "assistant"
            set state.ai_mode is "mock"
            run agent "planner" with input: task as plan
            run agents in parallel:
              agent "critic" with input: plan
              agent "researcher" with input: plan
            as feedback
            ask ai "assistant" with input: plan as final
        else:
          if category is "rate_limit":
            set state.status.message is "OpenAI rate-limited - try again in a moment. Using mock (see Traces)."
            set state.ai_provider_selected is "assistant"
            set state.ai_mode is "mock"
            run agent "planner" with input: task as plan
            run agents in parallel:
              agent "critic" with input: plan
              agent "researcher" with input: plan
            as feedback
            ask ai "assistant" with input: plan as final
          else:
            if category is "auth" or category is "missing_key":
              set state.status.message is "OpenAI auth failed - set keys in Setup. Using mock (see Traces)."
              set state.ai_provider_selected is "assistant"
              set state.ai_mode is "mock"
              run agent "planner" with input: task as plan
              run agents in parallel:
                agent "critic" with input: plan
                agent "researcher" with input: plan
              as feedback
              ask ai "assistant" with input: plan as final
            else:
              set state.status.message is "OpenAI failed - using mock (see Traces)."
              set state.ai_provider_selected is "assistant"
              set state.ai_mode is "mock"
              run agent "planner" with input: task as plan
              run agents in parallel:
                agent "critic" with input: plan
                agent "researcher" with input: plan
              as feedback
              ask ai "assistant" with input: plan as final
  else:
    run agent "planner" with input: task as plan
    run agents in parallel:
      agent "critic" with input: plan
      agent "researcher" with input: plan
    as feedback
    ask ai "assistant" with input: plan as final
    set state.status.message is "AI Mode: Mock (set keys to use OpenAI)"
  set state.plan is plan
  set state.feedback is feedback
  set state.final is final
  return final

page "workflow":
  title is "{{PROJECT_NAME}} Multi-Agent Workflow"
  text is "Planner plus critic and researcher."
  button "Run workflow":
    calls flow "run_workflow"
