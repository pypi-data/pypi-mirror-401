spec is "1.0"

tool "echo":
  implemented using builtin

  input:
    value is json

  output:
    echo is json

record "Note":
  field "title" is text must be present
  field "body" is text must be present

ai "assistant":
  provider is "mock"
  model is "gpt-4.1"
  system_prompt is "You are a helpful assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

ai "assistant_openai":
  provider is "openai"
  model is "gpt-4.1"
  system_prompt is "You are a helpful assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

ai "assistant_openai_fallback":
  provider is "openai"
  model is "gpt-4o-mini"
  system_prompt is "You are a helpful assistant for {{PROJECT_NAME}}."
  tools:
    expose "echo"
  memory:
    short_term is 5
    semantic is true
    profile is true

define function "select ai provider":
  input:
    openai_available is boolean
  output:
    provider is text
    mode is text
  if openai_available is true:
    return map:
      "provider" is "assistant_openai"
      "mode" is "real"
  return map:
    "provider" is "assistant"
    "mode" is "mock"

flow "ask_assistant":
  let prompt is "Summarize the latest notes."
  let openai_status is map get secrets key "NAMEL3SS_OPENAI_API_KEY"
  let selection is call function "select ai provider":
    openai_available is openai_status.available
  set state.ai_provider_selected is selection.provider
  set state.ai_mode is selection.mode
  let selected is selection.provider
  if selected is "assistant_openai":
    try:
      ask ai "assistant_openai" with input: prompt as reply
      set state.status.message is "AI Mode: OpenAI ✅"
    with catch err:
      let category is err.details.diagnostic.category
      if category is "model_access":
        try:
          ask ai "assistant_openai_fallback" with input: prompt as reply
          set state.status.message is "AI Mode: OpenAI ✅ (model downgraded to gpt-4o-mini)"
        with catch err:
          set state.status.message is "OpenAI failed - using mock (see Traces)."
          set state.ai_provider_selected is "assistant"
          set state.ai_mode is "mock"
          ask ai "assistant" with input: prompt as reply
      else:
        if category is "server" or category is "network":
          try:
            ask ai "assistant_openai" with input: prompt as reply
            set state.status.message is "AI Mode: OpenAI ✅"
          with catch err:
            set state.status.message is "OpenAI unavailable - using mock (see Traces)."
            set state.ai_provider_selected is "assistant"
            set state.ai_mode is "mock"
            ask ai "assistant" with input: prompt as reply
        else:
          if category is "rate_limit":
            set state.status.message is "OpenAI rate-limited - try again in a moment. Using mock (see Traces)."
            set state.ai_provider_selected is "assistant"
            set state.ai_mode is "mock"
            ask ai "assistant" with input: prompt as reply
          else:
            if category is "auth" or category is "missing_key":
              set state.status.message is "OpenAI auth failed - set keys in Setup. Using mock (see Traces)."
              set state.ai_provider_selected is "assistant"
              set state.ai_mode is "mock"
              ask ai "assistant" with input: prompt as reply
            else:
              set state.status.message is "OpenAI failed - using mock (see Traces)."
              set state.ai_provider_selected is "assistant"
              set state.ai_mode is "mock"
              ask ai "assistant" with input: prompt as reply
  else:
    ask ai "assistant" with input: prompt as reply
    set state.status.message is "AI Mode: Mock (set keys to use OpenAI)"
  set state.reply is reply
  return reply

page "notes":
  title is "{{PROJECT_NAME}} Notes Assistant"
  text is "Save notes and ask the assistant for help."
  form is "Note"
  table is "Note"
  button "Ask assistant":
    calls flow "ask_assistant"
