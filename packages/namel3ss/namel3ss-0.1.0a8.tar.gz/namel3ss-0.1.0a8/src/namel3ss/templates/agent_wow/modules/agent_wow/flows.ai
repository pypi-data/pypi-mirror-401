spec is "1.0"

flow "generate_plan":
  require latest "ProjectBrief" as brief otherwise "Add a project description, then try again."
  let goal is brief.description

  clear:
    "PlannerOutput"
    "ResearcherOutput"
    "CriticOutput"
    "RefinedPlan"
    "RunSummary"

  planner drafts goal as plan
  let plan_text is plan.text
  save "PlannerOutput" with:
    text is plan_text

  save "RunSummary" with:
    seq is 1
    label is "Generate plan"
    detail is "Planner produced a draft plan from the project brief."
  return plan_text

flow "run_parallel_feedback":
  require latest "ProjectBrief" as brief otherwise "Add a project description, then run parallel feedback."
  let goal is brief.description

  clear:
    "PlannerOutput"
    "ResearcherOutput"
    "CriticOutput"
    "RefinedPlan"
    "RunSummary"

  planner drafts "Remember this for our project: We decided to hand off key risks to the critic." as seed
  planner drafts goal as plan
  in parallel:
    critic reviews plan as critic_text
    researcher enriches plan as researcher_text
  merge policy is "all" as feedback

  let plan_text is plan.text
  let critic_text is feedback[0].text
  let researcher_text is feedback[1].text

  save "PlannerOutput" with:
    text is plan_text
  save "CriticOutput" with:
    text is critic_text
  save "ResearcherOutput" with:
    text is researcher_text

  let echo_result is echo:
    value is map:
      "step" is "parallel_feedback"
      "agents" is list:
        "planner"
        "critic"
        "researcher"

  save "RunSummary" with:
    seq is 1
    label is "Parallel feedback"
    detail is "Planner ran, critic and researcher ran in parallel, and echo captured the run."
  return plan_text

flow "refine_plan":
  let plan_entry is latest "PlannerOutput"
  if plan_entry is not null:
    set state.refine_input is plan_entry.text
  else:
    let brief_entry is latest "ProjectBrief"
    if brief_entry is not null:
      set state.refine_input is brief_entry.description
    else:
      clear "RunSummary"
      save "RunSummary" with:
        seq is 1
        label is "Refine plan"
        detail is "Add a project description or generate a plan first."
      return "missing_inputs"

  ask ai "wow_ai" with input: state.refine_input as refined
  let refined_text is refined

  clear "RefinedPlan"
  save "RefinedPlan" with:
    text is refined_text

  ask ai "wow_ai" with input: "Remember this for our project: We decided to keep owners explicit and outcomes measurable." as team_decision

  clear "RunSummary"
  save "RunSummary" with:
    seq is 1
    label is "Refine plan"
    detail is "Refined the plan and recorded a team decision memory."
  return refined_text

flow "remember_preference":
  ask ai "wow_ai" with input: "Remember this about me: I prefer premium, concise language." as preference_note
  clear "RunSummary"
  save "RunSummary" with:
    seq is 1
    label is "Remember preference"
    detail is "Stored a preference memory for future runs."
  return "preference_saved"

flow "create_handoff":
  let result is handoff create:
    from_agent_id is "planner"
    to_agent_id is "critic"
  clear "RunSummary"
  save "RunSummary" with:
    seq is 1
    label is "Create handoff"
    detail is "Created a handoff from planner to critic."
  return result.summary

flow "apply_handoff":
  attempt:
    let result is handoff apply:
      packet_id is "first_pending"
    clear "RunSummary"
    save "RunSummary" with:
      seq is 1
      label is "Apply handoff"
      detail is "Applied the latest pending handoff."
    return result.written_count
  otherwise:
    clear "RunSummary"
    save "RunSummary" with:
      seq is 1
      label is "Apply handoff"
      detail is "No pending handoff found. Create one first."
    return "no_pending_handoff"

flow "follow_up":
  let plan_entry is latest "PlannerOutput"
  if plan_entry is not null:
    set state.follow_up_input is plan_entry.text
  else:
    let brief_entry is latest "ProjectBrief"
    if brief_entry is not null:
      set state.follow_up_input is brief_entry.description
    else:
      set state.follow_up_input is "Use the handed-off decision to flag one risk."

  critic critiques state.follow_up_input as critique
  let critique_text is critique.text
  clear "CriticOutput"
  save "CriticOutput" with:
    text is critique_text

  clear "RunSummary"
  save "RunSummary" with:
    seq is 1
    label is "Agent follow-up"
    detail is "Critic responded using the latest context."
  return critique_text

flow "reset_state":
  clear:
    "ProjectBrief"
    "PlannerOutput"
    "ResearcherOutput"
    "CriticOutput"
    "RefinedPlan"
    "RunSummary"
  return "reset"
