"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[472],{11603:(e,l,s)=>{s.d(l,{A:()=>C});var n=s(88629),a=s(95557),t=s(19854),r=s(24586),i=s(68342),c=s(85702),d=s(5329),o=s(52959),u=s(44001),m=s(47925),x=s(2262),h=s(91573);function g(e){let{className:l,...s}=e;return(0,n.jsx)("textarea",{"data-slot":"textarea",className:(0,h.cn)("border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",l),...s})}var p=s(16076),v=s(38642),f=s(26009),j=s(70281),b=s(46353),N=s(15144),w=s(1200);function C(e){var l,s;let{config:h,field:C,onFileUploaded:y}=e,[E,k]=(0,d.useState)([]),[V,_]=(0,d.useState)([]),[H,L]=(0,d.useState)([]),[O,R]=(0,d.useState)([]),[S,T]=(0,d.useState)(!1),[M,P]=(0,d.useState)(!1),[B,A]=(0,d.useState)([]),[I,Z]=(0,d.useState)(null),{t:U}=(0,m.Bd)(),D=async e=>{if(e.size>0xa00000)return u.oR.error(U("plugins.fileUpload.tooLarge")),null;try{T(!0);let l=await o.ok.uploadPluginConfigFile(e);return u.oR.success(U("plugins.fileUpload.success")),null==y||y(l.file_key),{file_key:l.file_key,mimetype:e.type}}catch(e){return u.oR.error(U("plugins.fileUpload.failed")+": "+e.message),null}finally{T(!1)}};switch((0,d.useEffect)(()=>{h.type===a.P.LLM_MODEL_SELECTOR&&o.ok.getProviderLLMModels().then(e=>{let l=e.models;o.c1.disable_models_service&&(l=l.filter(e=>{var l;return(null==(l=e.provider)?void 0:l.requester)!=="space-chat-completions"})),k(l)}).catch(e=>{u.oR.error("Failed to get LLM model list: "+e.msg)})},[h.type]),(0,d.useEffect)(()=>{(h.type===a.P.KNOWLEDGE_BASE_SELECTOR||h.type===a.P.KNOWLEDGE_BASE_MULTI_SELECTOR)&&(o.ok.getKnowledgeBases().then(e=>{_(e.bases)}).catch(e=>{u.oR.error("Failed to get knowledge base list: "+e.msg)}),o.ok.getPluginSystemStatus().then(e=>{Z(e)}).catch(e=>{console.error("Failed to get plugin system status:",e)}))},[h.type]),(0,d.useEffect)(()=>{(h.type===a.P.KNOWLEDGE_BASE_SELECTOR||h.type===a.P.KNOWLEDGE_BASE_MULTI_SELECTOR)&&(null==I?void 0:I.is_enable)&&(null==I?void 0:I.is_connected)&&o.ok.getExternalKnowledgeBases().then(e=>{L(e.bases)}).catch(e=>{console.error("Failed to get external knowledge base list:",e)})},[h.type,I]),(0,d.useEffect)(()=>{h.type===a.P.BOT_SELECTOR&&o.ok.getBots().then(e=>{R(e.bots)}).catch(e=>{u.oR.error("Failed to get bot list: "+e.msg)})},[h.type]),h.type){case a.P.INT:case a.P.FLOAT:return(0,n.jsx)(t.p,{type:"number",...C,onChange:e=>C.onChange(Number(e.target.value))});case a.P.STRING:return(0,n.jsx)(t.p,{...C});case a.P.TEXT:return(0,n.jsx)(g,{...C,className:"min-h-[120px]"});case a.P.BOOLEAN:return(0,n.jsx)(i.d,{checked:C.value,onCheckedChange:C.onChange});case a.P.STRING_ARRAY:return(0,n.jsxs)("div",{className:"space-y-2",children:[C.value.map((e,l)=>(0,n.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,n.jsx)(t.p,{className:"w-[200px]",value:e,onChange:e=>{let s=[...C.value];s[l]=e.target.value,C.onChange(s)}}),(0,n.jsx)("button",{type:"button",className:"p-2 hover:bg-gray-100 rounded",onClick:()=>{let e=C.value.filter((e,s)=>s!==l);C.onChange(e)},children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5 text-red-500",children:(0,n.jsx)("path",{d:"M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"})})})]},l)),(0,n.jsx)(c.$,{type:"button",variant:"outline",onClick:()=>{C.onChange([...C.value,""])},children:U("common.add")})]});case a.P.SELECT:return(0,n.jsxs)(r.l6,{value:C.value,onValueChange:C.onChange,children:[(0,n.jsx)(r.bq,{className:"bg-[#ffffff] dark:bg-[#2a2a2e]",children:(0,n.jsx)(r.yv,{placeholder:U("common.select")})}),(0,n.jsx)(r.gC,{children:(0,n.jsx)(r.s3,{children:null==(l=h.options)?void 0:l.map(e=>(0,n.jsx)(r.eb,{value:e.name,children:(0,x.Z)(e.label)},e.name))})})]});case a.P.LLM_MODEL_SELECTOR:let F=E.reduce((e,l)=>{var s,n;let a=(null==(s=l.provider)?void 0:s.name)||(null==(n=l.provider)?void 0:n.requester)||"Unknown";return e[a]||(e[a]=[]),e[a].push(l),e},{});return(0,n.jsxs)(r.l6,{value:C.value,onValueChange:C.onChange,children:[(0,n.jsx)(r.bq,{className:"bg-[#ffffff] dark:bg-[#2a2a2e]",children:(0,n.jsx)(r.yv,{placeholder:U("models.selectModel")})}),(0,n.jsx)(r.gC,{children:Object.entries(F).map(e=>{let[l,s]=e;return(0,n.jsxs)(r.s3,{children:[(0,n.jsx)(r.TR,{children:l}),s.map(e=>{var l,s;return(0,n.jsx)(r.eb,{value:e.uuid,children:(0,n.jsxs)("span",{className:"inline-flex items-center gap-1",children:[e.name,(null==(l=e.abilities)?void 0:l.includes("vision"))&&(0,n.jsx)(j.A,{className:"h-3 w-3 text-muted-foreground"}),(null==(s=e.abilities)?void 0:s.includes("func_call"))&&(0,n.jsx)(b.A,{className:"h-3 w-3 text-muted-foreground"})]})},e.uuid)})]},l)})})]});case a.P.KNOWLEDGE_BASE_SELECTOR:return(0,n.jsxs)(r.l6,{value:C.value,onValueChange:C.onChange,children:[(0,n.jsx)(r.bq,{className:"bg-[#ffffff] dark:bg-[#2a2a2e]",children:(0,n.jsx)(r.yv,{placeholder:U("knowledge.selectKnowledgeBase")})}),(0,n.jsxs)(r.gC,{children:[(0,n.jsx)(r.s3,{children:(0,n.jsx)(r.eb,{value:"__none__",children:U("knowledge.empty")})}),V.length>0&&(0,n.jsxs)(r.s3,{children:[(0,n.jsx)(r.TR,{children:U("knowledge.builtIn")}),V.map(e=>{var l;return(0,n.jsx)(r.eb,{value:null!=(l=e.uuid)?l:"",children:e.name},e.uuid)})]}),H.length>0&&(0,n.jsxs)(r.s3,{children:[(0,n.jsx)(r.TR,{children:U("knowledge.external")}),H.map(e=>{var l;return(0,n.jsx)(r.eb,{value:null!=(l=e.uuid)?l:"",children:(0,n.jsxs)("div",{className:"flex items-center gap-2",children:[(0,n.jsx)("img",{src:o.ok.getPluginIconURL(e.plugin_author,e.plugin_name),alt:"plugin icon",className:"w-4 h-4 rounded-[8%] flex-shrink-0"}),(0,n.jsx)("span",{children:e.name})]})},e.uuid)})]})]})]});case a.P.KNOWLEDGE_BASE_MULTI_SELECTOR:return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{className:"space-y-2",children:C.value&&C.value.length>0?(0,n.jsx)("div",{className:"space-y-2",children:C.value.map(e=>{let l=V.find(l=>l.uuid===e),s=H.find(l=>l.uuid===e),a=l||s;return a?(0,n.jsxs)("div",{className:"flex items-center justify-between rounded-lg border p-3 hover:bg-accent",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 flex-1",children:[s&&(0,n.jsx)("img",{src:o.ok.getPluginIconURL(s.plugin_author,s.plugin_name),alt:"plugin icon",className:"w-8 h-8 rounded-[8%] flex-shrink-0"}),(0,n.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,n.jsx)("div",{className:"font-medium",children:a.name}),a.description&&(0,n.jsx)("div",{className:"text-sm text-muted-foreground",children:a.description})]})]}),(0,n.jsx)(c.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>{let l=C.value.filter(l=>l!==e);C.onChange(l)},children:(0,n.jsx)(N.A,{className:"h-4 w-4"})})]},e):null})}):(0,n.jsx)("div",{className:"flex h-32 items-center justify-center rounded-lg border-2 border-dashed border-border",children:(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:U("knowledge.noKnowledgeBaseSelected")})})}),(0,n.jsxs)(c.$,{type:"button",onClick:()=>{A(C.value||[]),P(!0)},variant:"outline",className:"w-full",children:[(0,n.jsx)(w.A,{className:"mr-2 h-4 w-4"}),U("knowledge.addKnowledgeBase")]}),(0,n.jsx)(v.lG,{open:M,onOpenChange:P,children:(0,n.jsxs)(v.Cf,{className:"max-w-2xl max-h-[80vh] overflow-hidden flex flex-col",children:[(0,n.jsx)(v.c7,{children:(0,n.jsx)(v.L3,{children:U("knowledge.selectKnowledgeBases")})}),(0,n.jsxs)("div",{className:"flex-1 overflow-y-auto space-y-4 pr-2",children:[V.length>0&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("div",{className:"text-sm font-semibold text-muted-foreground px-2",children:U("knowledge.builtIn")}),V.map(e=>{var l;let s=B.includes(null!=(l=e.uuid)?l:"");return(0,n.jsxs)("div",{className:"flex items-center gap-3 rounded-lg border p-3 hover:bg-accent cursor-pointer",onClick:()=>{var l;let s=null!=(l=e.uuid)?l:"";A(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s])},children:[(0,n.jsx)(f.S,{checked:s,"aria-label":"Select ".concat(e.name)}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-medium",children:e.name}),e.description&&(0,n.jsx)("div",{className:"text-sm text-muted-foreground",children:e.description})]})]},e.uuid)})]}),H.length>0&&(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("div",{className:"text-sm font-semibold text-muted-foreground px-2",children:U("knowledge.external")}),H.map(e=>{var l;let s=B.includes(null!=(l=e.uuid)?l:"");return(0,n.jsxs)("div",{className:"flex items-center gap-3 rounded-lg border p-3 hover:bg-accent cursor-pointer",onClick:()=>{var l;let s=null!=(l=e.uuid)?l:"";A(e=>e.includes(s)?e.filter(e=>e!==s):[...e,s])},children:[(0,n.jsx)(f.S,{checked:s,"aria-label":"Select ".concat(e.name)}),(0,n.jsx)("img",{src:o.ok.getPluginIconURL(e.plugin_author,e.plugin_name),alt:"plugin icon",className:"w-8 h-8 rounded-[8%] flex-shrink-0"}),(0,n.jsxs)("div",{className:"flex-1",children:[(0,n.jsx)("div",{className:"font-medium",children:e.name}),e.description&&(0,n.jsx)("div",{className:"text-sm text-muted-foreground",children:e.description})]})]},e.uuid)})]})]}),(0,n.jsxs)(v.Es,{children:[(0,n.jsx)(c.$,{variant:"outline",onClick:()=>P(!1),children:U("common.cancel")}),(0,n.jsx)(c.$,{onClick:()=>{C.onChange(B),P(!1)},children:U("common.confirm")})]})]})})]});case a.P.BOT_SELECTOR:return(0,n.jsxs)(r.l6,{value:C.value,onValueChange:C.onChange,children:[(0,n.jsx)(r.bq,{className:"bg-[#ffffff] dark:bg-[#2a2a2e]",children:(0,n.jsx)(r.yv,{placeholder:U("bots.selectBot")})}),(0,n.jsx)(r.gC,{children:(0,n.jsx)(r.s3,{children:O.map(e=>{var l;return(0,n.jsx)(r.eb,{value:null!=(l=e.uuid)?l:"",children:e.name},e.uuid)})})})]});case a.P.PROMPT_EDITOR:return(0,n.jsxs)("div",{className:"space-y-2",children:[C.value.map((e,l)=>(0,n.jsxs)("div",{className:"flex gap-2 items-center",children:[0===l?(0,n.jsx)("div",{className:"w-[120px] px-3 py-2 border rounded bg-gray-50 dark:bg-[#2a292e] text-gray-500 dark:text-white dark:border-gray-600",children:"system"}):(0,n.jsxs)(r.l6,{value:e.role,onValueChange:e=>{let s=[...C.value];s[l]={...s[l],role:e},C.onChange(s)},children:[(0,n.jsx)(r.bq,{className:"w-[120px] bg-[#ffffff] dark:bg-[#2a2a2e]",children:(0,n.jsx)(r.yv,{})}),(0,n.jsx)(r.gC,{children:(0,n.jsxs)(r.s3,{children:[(0,n.jsx)(r.eb,{value:"user",children:"user"}),(0,n.jsx)(r.eb,{value:"assistant",children:"assistant"})]})})]}),(0,n.jsx)(g,{className:"w-[300px]",value:e.content,onChange:e=>{let s=[...C.value];s[l]={...s[l],content:e.target.value},C.onChange(s)}}),0!==l&&(0,n.jsx)("button",{type:"button",className:"p-2 hover:bg-gray-100 rounded",onClick:()=>{let e=C.value.filter((e,s)=>s!==l);C.onChange(e)},children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-5 h-5 text-red-500",children:(0,n.jsx)("path",{d:"M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"})})})]},l)),(0,n.jsx)(c.$,{type:"button",variant:"outline",onClick:()=>{C.onChange([...C.value,{role:"user",content:""}])},children:U("common.addRound")})]});case a.P.FILE:return(0,n.jsx)("div",{className:"space-y-2",children:C.value&&C.value.file_key?(0,n.jsx)(p.Zp,{className:"py-3 max-w-full overflow-hidden bg-gray-900",children:(0,n.jsxs)(p.Wu,{className:"flex items-center gap-3 p-0 px-4 min-w-0",children:[(0,n.jsxs)("div",{className:"flex-1 min-w-0 overflow-hidden",children:[(0,n.jsx)("div",{className:"text-sm font-medium truncate",title:C.value.file_key,children:C.value.file_key}),(0,n.jsx)("div",{className:"text-xs text-muted-foreground truncate",children:C.value.mimetype})]}),(0,n.jsx)(c.$,{type:"button",variant:"ghost",size:"sm",className:"flex-shrink-0 h-8 w-8 p-0",onClick:e=>{e.preventDefault(),e.stopPropagation(),C.onChange(null)},title:U("common.delete"),children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4 text-destructive",children:(0,n.jsx)("path",{d:"M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"})})})]})}):(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)("input",{type:"file",accept:h.accept,disabled:S,onChange:async e=>{var l;let s=null==(l=e.target.files)?void 0:l[0];if(s){let e=await D(s);e&&C.onChange(e)}e.target.value=""},className:"hidden",id:"file-input-".concat(h.name)}),(0,n.jsxs)(c.$,{type:"button",variant:"outline",size:"sm",disabled:S,onClick:()=>{var e;return null==(e=document.getElementById("file-input-".concat(h.name)))?void 0:e.click()},children:[(0,n.jsx)("svg",{className:"w-4 h-4 mr-2",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",children:(0,n.jsx)("path",{d:"M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"})}),S?U("plugins.fileUpload.uploading"):U("plugins.fileUpload.chooseFile")]})]})});case a.P.FILE_ARRAY:return(0,n.jsxs)("div",{className:"space-y-2",children:[null==(s=C.value)?void 0:s.map((e,l)=>(0,n.jsx)(p.Zp,{className:"py-3 max-w-full overflow-hidden bg-gray-900",children:(0,n.jsxs)(p.Wu,{className:"flex items-center gap-3 p-0 px-4 min-w-0",children:[(0,n.jsxs)("div",{className:"flex-1 min-w-0 overflow-hidden",children:[(0,n.jsx)("div",{className:"text-sm font-medium truncate",title:e.file_key,children:e.file_key}),(0,n.jsx)("div",{className:"text-xs text-muted-foreground truncate",children:e.mimetype})]}),(0,n.jsx)(c.$,{type:"button",variant:"ghost",size:"sm",className:"flex-shrink-0 h-8 w-8 p-0",onClick:e=>{e.preventDefault(),e.stopPropagation();let s=C.value.filter((e,s)=>s!==l);C.onChange(s)},title:U("common.delete"),children:(0,n.jsx)("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-4 h-4 text-destructive",children:(0,n.jsx)("path",{d:"M7 4V2H17V4H22V6H20V21C20 21.5523 19.5523 22 19 22H5C4.44772 22 4 21.5523 4 21V6H2V4H7ZM6 6V20H18V6H6ZM9 9H11V17H9V9ZM13 9H15V17H13V9Z"})})})]})},l)),(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)("input",{type:"file",accept:h.accept,disabled:S,onChange:async e=>{var l;let s=null==(l=e.target.files)?void 0:l[0];if(s){let e=await D(s);e&&C.onChange([...C.value||[],e])}e.target.value=""},className:"hidden",id:"file-array-input-".concat(h.name)}),(0,n.jsxs)(c.$,{type:"button",variant:"outline",size:"sm",disabled:S,onClick:()=>{var e;return null==(e=document.getElementById("file-array-input-".concat(h.name)))?void 0:e.click()},children:[(0,n.jsx)("svg",{className:"w-4 h-4 mr-2",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",children:(0,n.jsx)("path",{d:"M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"})}),S?U("plugins.fileUpload.uploading"):U("plugins.fileUpload.addFile")]})]})]});default:return(0,n.jsx)(t.p,{...C})}}},12472:(e,l,s)=>{s.d(l,{A:()=>u});var n=s(88629),a=s(15659),t=s(41680),r=s(22985),i=s(44996),c=s(11603),d=s(5329),o=s(2262);function u(e){let{itemConfigList:l,onSubmit:s,initialValues:u,onFileUploaded:m}=e,x=(0,d.useRef)(!0),h=(0,d.useRef)(u),g=r.Ik(l.reduce((e,l)=>{let s;switch(l.type){case"integer":case"float":s=r.ai();break;case"boolean":s=r.zM();break;case"string":case"select":case"llm-model-selector":case"knowledge-base-selector":case"bot-selector":default:s=r.Yj();break;case"array[string]":case"knowledge-base-multi-selector":s=r.YO(r.Yj());break;case"prompt-editor":s=r.YO(r.Ik({content:r.Yj(),role:r.Yj()}))}return l.required&&(s instanceof r.ND||s instanceof r.n)&&(s=s.min(1,{message:"此字段为必填项"})),{...e,[l.name]:s}},{})),p=(0,a.mN)({resolver:(0,t.u)(g),defaultValues:l.reduce((e,l)=>{var s;let n=null!=(s=null==u?void 0:u[l.name])?s:l.default;return{...e,[l.name]:n}},{})});return(0,d.useEffect)(()=>{if(x.current){x.current=!1,h.current=u;return}let e=JSON.stringify(h.current)!==JSON.stringify(u);u&&e&&(Object.entries(l.reduce((e,l)=>{var s;return e[l.name]=null!=(s=u[l.name])?s:l.default,e},{})).forEach(e=>{let[l,s]=e;p.setValue(l,s)}),h.current=u)},[u,p,l]),(0,d.useEffect)(()=>{let e=p.watch(()=>{let e=p.getValues(),n=l.reduce((l,s)=>{var n;return l[s.name]=null!=(n=e[s.name])?n:s.default,l},{});null==s||s(n)});return()=>e.unsubscribe()},[p,s,l]),(0,n.jsx)(i.lV,{...p,children:(0,n.jsx)("div",{className:"space-y-4",children:l.map(e=>(0,n.jsx)(i.zB,{control:p.control,name:e.name,render:l=>{let{field:s}=l;return(0,n.jsxs)(i.eI,{children:[(0,n.jsxs)(i.lR,{children:[(0,o.Z)(e.label)," ",e.required&&(0,n.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,n.jsx)(i.MJ,{children:(0,n.jsx)(c.A,{config:e,field:s,onFileUploaded:m})}),e.description&&(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:(0,o.Z)(e.description)}),(0,n.jsx)(i.C5,{})]})}},e.id))})})}},95557:(e,l,s)=>{s.d(l,{P:()=>n});var n=function(e){return e.INT="integer",e.FLOAT="float",e.BOOLEAN="boolean",e.STRING="string",e.TEXT="text",e.STRING_ARRAY="array[string]",e.FILE="file",e.FILE_ARRAY="array[file]",e.SELECT="select",e.LLM_MODEL_SELECTOR="llm-model-selector",e.PROMPT_EDITOR="prompt-editor",e.UNKNOWN="unknown",e.KNOWLEDGE_BASE_SELECTOR="knowledge-base-selector",e.KNOWLEDGE_BASE_MULTI_SELECTOR="knowledge-base-multi-selector",e.PLUGIN_SELECTOR="plugin-selector",e.BOT_SELECTOR="bot-selector",e}({})}}]);