# Copyright (C) 2024-2026 Niritech Labs
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or (at your option) any later version.
import re
from .Parser import ParserRealizationFabric
from .BlocksUtils import Block, Blocks


class HyprlangParser(ParserRealizationFabric):
    def __init__(self, production:bool, path):
        super().__init__(production, path, 'hyprlang parser')

    def Encode(self,data:Blocks):
        string = '###### AUTOGENERATED CONFIG PLEASE NOT EDIT THIS CONFIG ######\n\n'
        for param0 in data.params:
            string += f'{param0[0]} = {param0[1]}\n'
        string += '\n'

        for block in data.blocks:
            string += (f'{block.name}' + ' {\n')
            level = '    '*(block.level-2)
            for param in block.params:
                string += f'{level}    {param[0]} = {param[1]}\n'

            for block1 in block.blocks:
                string += (f'    {block1.name}' + ' {\n')
                level1 = '    '*(block1.level-2)
                for param1 in block1.params:
                    string += f'{level1}    {param1[0]} = {param1[1]}\n'

                string += '}\n\n'

            string += '}\n\n'

        self.save(string)


    def Decode(self) -> Blocks | None:
        text = self.open()
        step1 = text.replace(' ', '')
        step2 = re.sub(r'#.*','',step1,flags=re.MULTILINE)
        step3 = list(filter(None,step2.split('\n')))

        final = Blocks('hyprlang')
        blockLevel3 = None
        blockLevel2 = None
        block2writing = False
        block3writing = False

        
        for line in step3:
            if "{" in line and block2writing is False and block3writing is False :
                block2writing = True
                blockLevel2 = Block(line.split('{')[0])
                continue
            if "{" in line and block2writing is True and block3writing is False:
                block3writing = True
                block2writing = False
                blockLevel3 = Block(line.split('{')[0])
                continue
            
            if "}" in line and block3writing is True:
                block2writing = True 
                block3writing = False
                blockLevel3.level = 2
                blockLevel2.AddBlock(blockLevel3)
                continue

            if "}" in line and block3writing is False and block2writing is True:    
                final.AddBlock(blockLevel2)


                blockLevel2 = []
                blockLevel3 = []
                block2writing = False
                block3writing = False
                continue


            if block2writing:
                blockLevel2.AddParam(line.split('='))
            elif block3writing:
                blockLevel3.AddParam(line.split('='))
            else:
                final.AddParam(line.split('='))
        
        
        return final
    



class BlocksParser(ParserRealizationFabric):
    def __init__(self, production:bool, path):
        super().__init__(production, path, 'hyprlang parser')

    def Encode(self,data:Blocks):
        self.save(data.ToStr())

    def Decode(self) -> Blocks | None:
        return Blocks.FromStr(self.open())