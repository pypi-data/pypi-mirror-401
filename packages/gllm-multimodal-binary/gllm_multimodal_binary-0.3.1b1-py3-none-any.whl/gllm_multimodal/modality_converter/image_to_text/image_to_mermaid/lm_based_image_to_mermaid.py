"""LM-based image to mermaid implementation using multimodal Language Models.

This module implements image to mermaid using multimodal Language Models
through the lm_invoker package.

Authors:
    Obryan Ramadhan (obryan.ramadhan@gdplabs.id)

References:
    NONE
"""

from typing import Any

from gllm_inference.schema import Attachment
from gllm_inference.request_processor.lm_request_processor import LMRequestProcessor
from gllm_inference.request_processor.uses_lm_mixin import UsesLM

from gllm_multimodal.modality_converter.image_to_text.image_to_mermaid.image_to_mermaid import BaseImageToMermaid
from gllm_multimodal.modality_converter.image_to_text.image_to_mermaid.preset_image_to_mermaid import (
    get_preset_image_to_mermaid,
)
from gllm_multimodal.modality_converter.schema.mermaid import Mermaid


class LMBasedImageToMermaid(BaseImageToMermaid, UsesLM):
    """LM-based implementation for converting an image into Mermaid diagram syntax.

    This class leverages a language model (LM) pipeline to generate structured Mermaid syntax from
    image inputs and optional metadata. It uses prompt builders, LM invokers, and output parsers
    defined via a preset system to streamline model usage.

    Inherits:
        BaseImageToMermaid: Base class defining the image-to-mermaid interface.
        UsesLM: Mixin providing shared logic for components using language models.

    Attributes:
        lm_request_processor (LMRequestProcessor): Handles prompt creation, LM invocation,
            and output parsing. Core component that orchestrates the image-to-mermaid pipeline.
    """

    def __init__(self, lm_request_processor: LMRequestProcessor):
        """Initializes the LMBasedImageToMermaid instance with a language model request processor.

        Args:
            lm_request_processor (LMRequestProcessor): The processor handling prompt creation,
                LM invocation, and output parsing.
        """
        super().__init__()
        self.lm_request_processor = lm_request_processor

    @classmethod
    def from_preset(
        cls,
        preset_name: str | None = "default",
        lm_invoker_kwargs: dict | None = None,
        prompt_builder_kwargs: dict | None = None,
        **kwargs: Any,
    ) -> "LMBasedImageToMermaid":
        """Constructs an LMBasedImageToMermaid instance using a named preset configuration.

        Args:
            preset_name (str | None): Name of the predefined preset configuration to use.
                Defaults to "default".
            lm_invoker_kwargs: dict | None: Additional arguments for lm invoker.
            prompt_builder_kwargs: dict | None: Additional arguments for prompt builder.
            **kwargs (Any): Additional keyword arguments passed to the constructor.

        Returns:
            LMBasedImageToMermaid: An instance initialized with the preset's components.
        """
        lm_invoker_kwargs = lm_invoker_kwargs or {}
        prompt_builder_kwargs = prompt_builder_kwargs or {}

        lm_invoker, prompt_builder, output_parser = get_preset_image_to_mermaid(
            preset_name, lm_invoker_kwargs, prompt_builder_kwargs
        )
        return cls.from_lm_components(prompt_builder, lm_invoker, output_parser, **kwargs)

    async def _get_mermaid(
        self,
        image_binary: bytes,
        mermaid_data: Mermaid,
        **kwargs: Any,
    ) -> str:
        """Generates Mermaid diagram syntax from an image using the LM pipeline.

        Args:
            image_binary (bytes): The image data in binary form.
            mermaid_data (Mermaid): Structured mermaid-related metadata to guide prompt generation.
            **kwargs (Any): Optional arguments, such as an event_emitter for logging or tracing.

        Returns:
            str: A Mermaid syntax lines generated by the LM, or None on failure.
        """
        try:
            prompt_key_set = self.lm_request_processor.prompt_builder.prompt_key_set
            param_mapping = mermaid_data.model_dump()
            prompt_params = {key: value for key, value in param_mapping.items() if key in prompt_key_set}

            return await self.lm_request_processor.process(
                prompt_kwargs=prompt_params,
                extra_contents=[Attachment.from_bytes(image_binary)],
                event_emitter=kwargs.get("event_emitter", None),
            )

        except Exception as e:
            self._logger.debug(f"Failed to generate mermaid syntax: {str(e)}")
            return ""
