<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logler - Beautiful Log Viewer</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', path='logler-logo.png') }}">
    <link rel="stylesheet" href="{{ url_for('static', path='css/tailwind.css') }}">
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <script src="https://unpkg.com/htmx-ext-ws@2.0.1/ws.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        [x-cloak] { display: none !important; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: radial-gradient(circle at 20% 20%, rgba(102,126,234,0.08), transparent 25%),
                        radial-gradient(circle at 80% 0%, rgba(118,75,162,0.08), transparent 20%),
                        linear-gradient(135deg, #0f141f 0%, #0b101a 100%);
            min-height: 100vh;
            color: #e5edff;
        }

        .log-viewer {
            font-family: 'JetBrains Mono', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
        }

        .log-line {
            padding: 0.5rem;
            border-bottom: 1px solid #2d2d2d;
            transition: background 0.2s;
        }

        .log-line:hover {
            background: #2d2d2d;
        }

        .level-TRACE { color: #808080; }
        .level-DEBUG { color: #4FC3F7; }
        .level-INFO { color: #66BB6A; }
        .level-WARN, .level-WARNING { color: #FFA726; }
        .level-ERROR { color: #EF5350; }
        .level-CRITICAL, .level-FATAL { color: #F44336; font-weight: bold; }

        .glass-card {
            background: rgba(18, 24, 38, 0.65);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .file-item {
            transition: all 0.2s;
        }

        .file-item:hover {
            transform: translateX(4px);
            background: rgba(255, 255, 255, 0.1);
        }

        .thread-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.15rem 0.4rem;
            border-radius: 0.3rem;
            font-size: 0.7rem;
            font-weight: 700;
            background: rgba(99, 123, 255, 0.16);
            color: #cdd8ff;
            border: 1px solid rgba(99, 123, 255, 0.35);
            cursor: pointer;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f141f;
        }

        ::-webkit-scrollbar-thumb {
            background: #4452a3;
            border-radius: 6px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #6274d3;
        }
    </style>
</head>
<body x-data="logViewer()" x-init="init()" class="overflow-hidden">
    <!-- Header -->
    <header class="glass-card text-white p-4">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <img src="{{ url_for('static', path='logler-logo.png') }}" alt="Logler logo" class="h-8 w-8 rounded-md bg-white bg-opacity-5 shadow-lg" style="height:2rem;width:2rem;">
                <h1 class="text-2xl font-bold">Logler</h1>
            </div>
            <div class="flex items-center space-x-4">
                <span x-show="websocketConnected" class="flex items-center space-x-2">
                    <span class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                    <span class="text-sm">Live</span>
                </span>
                <button @click="showFilePicker = true" class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg transition">
                    üìÅ Open File
                </button>
            </div>
        </div>
    </header>

    <div class="flex h-[calc(100vh-73px)]">
        <!-- Sidebar -->
        <aside class="w-[21rem] glass-card text-white p-4 overflow-y-auto">
            <div class="space-y-6">
                <!-- Active Files -->
                <div>
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <span class="mr-2">üìÑ</span> Active Files
                    </h2>
                    <div x-show="interleaved && Object.keys(interleaveCounts).length > 0" class="flex flex-wrap gap-2 mb-3">
                        <template x-for="(count, path) in interleaveCounts" :key="'chip-' + path">
                            <span class="thread-badge bg-white bg-opacity-10 border-white/20 rounded-full px-2 py-1 text-xs" :title="path + ' ‚Äî ' + count + ' rows'">
                                <span x-text="(path.split('/').pop() || path) + ' ‚Ä¢ ' + count"></span>
                            </span>
                        </template>
                    </div>
                    <div x-show="activeFiles.length === 0" class="text-sm text-gray-300">
                        No files open yet
                    </div>
                    <div class="space-y-2">
                        <template x-for="file in activeFiles" :key="file">
                            <div class="p-2 bg-white bg-opacity-10 rounded cursor-pointer hover:bg-opacity-20 transition relative" @click="selectFile(file)" :title="file">
                                <div class="text-sm font-mono truncate" x-text="file.split('/').pop()"></div>
                                <div x-show="interleaved && currentFiles.includes(file)" class="absolute top-1 right-1 text-[10px] text-amber-300" :title="(interleaveCounts[file] || 0) + ' rows'">
                                    interleaved
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- Statistics -->
                <div x-show="stats.total > 0">
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <span class="mr-2">üìä</span> Statistics
                    </h2>
                    <div class="grid grid-cols-2 gap-2">
                        <div class="stat-card p-3 rounded-lg">
                            <div class="text-xs text-gray-300">Total</div>
                            <div class="text-2xl font-bold" x-text="stats.total"></div>
                        </div>
                        <div class="stat-card p-3 rounded-lg">
                            <div class="text-xs text-gray-300">Errors</div>
                            <div class="text-2xl font-bold text-red-400" x-text="stats.errors"></div>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div>
                    <h2 class="text-lg font-semibold mb-3 flex items-center">
                        <span class="mr-2">üîç</span> Filters
                    </h2>
                    <div class="space-y-3">
                        <div>
                            <input type="text" x-model="searchQuery" @keyup.enter="applyFilters()"
                                   placeholder="Search logs..."
                                   class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <div>
                            <input type="text" x-model="correlationFilter" @keyup.enter="applyFilters()"
                                   placeholder="Filter by correlation ID..."
                                   class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <div class="flex flex-wrap gap-2">
                            <template x-for="level in ['DEBUG', 'INFO', 'WARN', 'ERROR']">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" :value="level" x-model="selectedLevels" @change="applyFilters()"
                                           class="rounded bg-white bg-opacity-10">
                                    <span class="text-sm" x-text="level" :class="'level-' + level"></span>
                                </label>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Threads -->
                <div x-show="threads.length > 0">
                    <div class="flex items-center justify-between mb-2">
                        <h2 class="text-lg font-semibold flex items-center">
                            <span class="mr-2">üßµ</span> Threads
                        </h2>
                        <button class="text-xs px-2 py-1 bg-white bg-opacity-10 rounded hover:bg-opacity-20"
                                @click="clearThreadSelection()" x-show="selectedThreads.length > 0">
                            Clear selection
                        </button>
                    </div>
                    <div class="space-y-3">
                        <div x-show="selectedThreads.length > 0" class="flex flex-wrap gap-2">
                            <template x-for="threadId in selectedThreads" :key="'chip-' + threadId">
                                <span class="thread-badge bg-white bg-opacity-15 border-white/30 rounded-full px-2 py-1 text-xs flex items-center gap-2 max-w-full">
                                    <span class="truncate max-w-[9rem]" :title="threadId" x-text="threadId"></span>
                                    <button @click.stop="removeThread(threadId)" class="hover:text-red-300 focus:outline-none">‚úï</button>
                                </span>
                            </template>
                        </div>
                        <input type="text" x-model="threadSearch" @input="updateVisibleThreads()" placeholder="Search thread..."
                               class="w-full px-3 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                        <div id="thread-list" class="max-h-64 overflow-y-auto pr-1" @scroll.passive="updateVisibleThreads()">
                            <div :style="`height:${threadTopSpacer}px`"></div>
                            <template x-for="thread in visibleThreadsCache" :key="thread.thread_id">
                                <label class="flex items-center gap-2 p-2 bg-white bg-opacity-5 rounded cursor-pointer hover:bg-opacity-20 transition">
                                    <input type="checkbox" :value="thread.thread_id" x-model="selectedThreads" @change="applyFilters()" class="accent-indigo-400">
                                    <div class="flex-1 min-w-0 flex items-center justify-between gap-2">
                                        <span class="thread-badge truncate" x-text="thread.thread_id" :title="thread.thread_id"></span>
                                        <span class="text-[11px] text-gray-300 whitespace-nowrap" x-text="thread.log_count + ' logs'"></span>
                                        <span x-show="thread.error_count > 0" class="text-[11px] text-red-300 whitespace-nowrap" x-text="thread.error_count + ' err'"></span>
                                    </div>
                                </label>
                            </template>
                            <div :style="`height:${threadBottomSpacer}px`"></div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col overflow-hidden relative">
            <div x-show="loading" class="absolute inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-30 flex items-center justify-center">
                <div class="flex flex-col items-center gap-3">
                    <div class="h-10 w-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                    <div class="text-sm text-gray-200">Loading log...</div>
                </div>
            </div>
            <div x-show="indexing && !loading" class="absolute top-3 right-3 z-20 px-3 py-2 rounded-lg bg-white bg-opacity-10 border border-white/20 text-xs flex items-center gap-2">
                <span class="h-3 w-3 rounded-full bg-amber-400 animate-pulse"></span>
                <span>Indexing large log‚Ä¶</span>
            </div>
            <!-- Toolbar -->
            <div class="glass-card text-white p-3 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="text-sm space-y-1">
                        <div class="flex items-center gap-2 text-sm">
                            <span>Showing <span x-text="visibleEntries.length"></span></span>
                            <span x-show="totalAvailable > 0" class="text-xs text-gray-400">(of <span x-text="totalAvailable"></span> total)</span>
                            <span x-show="filteredEntries.length > MAX_ENTRIES" class="text-xs text-gray-400">(latest window)</span>
                            <span x-show="partialLoad" class="text-xs text-amber-300">Quick view</span>
                        </div>
                        <div class="text-xs text-gray-300" x-show="interleaved">
                            Interleaved: <span x-text="currentFiles.join(', ')"></span>
                        </div>
                        <div class="text-xs text-gray-300" x-show="!interleaved && currentFile">
                            File: <span x-text="currentFile"></span>
                        </div>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <button x-show="interleaved && currentFiles.length > 0" @click="showInterleaveModal = true" class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition">
                        Interleave details
                    </button>
                    <button x-show="partialLoad && !indexing" @click="loadFullCurrent()" class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition">
                        Load full log
                    </button>
                    <button @click="autoScroll = !autoScroll"
                            :class="autoScroll ? 'bg-green-500' : 'bg-white bg-opacity-20'"
                            class="px-3 py-1 rounded text-sm hover:opacity-80 transition">
                        <span x-text="autoScroll ? 'üìå Auto-scroll ON' : 'üìå Auto-scroll OFF'"></span>
                    </button>
                <button @click="toggleFollow()" x-show="currentFile && !interleaved"
                        class="px-3 py-1 bg-white bg-opacity-20 hover:bg-opacity-30 rounded text-sm transition">
                    <span x-text="isFollowing ? '‚èπ Stop Following' : 'üîÑ Follow'"></span>
                </button>
            </div>
            </div>

            <!-- View Mode Tabs -->
            <div class="glass-card text-white px-3 py-2 flex items-center gap-2 border-t border-white/10">
                <span class="text-xs text-gray-400">View:</span>
                <button @click="viewMode = 'logs'"
                        :class="viewMode === 'logs' ? 'bg-indigo-600' : 'bg-white bg-opacity-10'"
                        class="px-3 py-1 rounded text-xs hover:bg-opacity-30 transition">
                    üìú Logs
                </button>
                <button @click="viewMode = 'hierarchy'; loadHierarchy()"
                        :class="viewMode === 'hierarchy' ? 'bg-indigo-600' : 'bg-white bg-opacity-10'"
                        class="px-3 py-1 rounded text-xs hover:bg-opacity-30 transition">
                    üå≥ Hierarchy
                </button>
                <button @click="viewMode = 'waterfall'; loadHierarchy()"
                        :class="viewMode === 'waterfall' ? 'bg-indigo-600' : 'bg-white bg-opacity-10'"
                        class="px-3 py-1 rounded text-xs hover:bg-opacity-30 transition">
                    üìä Waterfall
                </button>
                <div x-show="viewMode !== 'logs'" class="flex-1"></div>
                <div x-show="viewMode !== 'logs'" class="flex items-center gap-2">
                    <input type="text" x-model="hierarchyRootId" @keyup.enter="loadHierarchy()"
                           placeholder="Root ID (thread, correlation, trace)..."
                           class="px-2 py-1 text-xs bg-white bg-opacity-10 border border-white/20 rounded w-48">
                    <button @click="loadHierarchy()" class="px-2 py-1 bg-white bg-opacity-20 rounded text-xs hover:bg-opacity-30">
                        üîç Load
                    </button>
                </div>
            </div>

            <!-- Log Viewer -->
            <div x-show="viewMode === 'logs'" class="flex-1 log-viewer overflow-auto" id="log-container" @scroll="handleScroll()">
                <div x-show="!currentFile" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <img src="{{ url_for('static', path='logler-logo.png') }}" alt="Logler logo" class="h-8 w-8 mx-auto mb-4 opacity-90" style="height:2rem;width:2rem;">
                        <div class="text-xl mb-2">No file opened</div>
                        <div class="text-sm">Click "Open File" to get started</div>
                    </div>
                </div>

                <div x-show="currentFile && visibleEntries.length === 0" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-4">üîç</div>
                        <div class="text-lg">No logs match the current filter</div>
                    </div>
                </div>

                <div :style="`height:${logTopSpacer}px`"></div>
                <template x-for="entry in visibleEntries" :key="entry.entry_id || entryKey(entry)">
                    <div class="log-line" :class="'level-' + entry.level">
                        <div class="flex items-start space-x-3">
                            <span class="text-gray-600 text-xs font-mono w-12 text-right flex-shrink-0" x-text="entry.line_number"></span>
                            <span class="text-gray-400 text-xs flex-shrink-0 w-36" x-text="formatTimestamp(entry.timestamp)"></span>
                            <span class="text-xs font-bold flex-shrink-0 w-16" :class="'level-' + entry.level" x-text="entry.level"></span>
                            <div class="flex-1 min-w-0">
                                <div class="break-words" x-text="entry.message"></div>
                                <div x-show="entry.thread_id || entry.correlation_id || entry.service_name" class="mt-1 flex items-center space-x-2 text-xs text-gray-500">
                                    <span x-show="entry.thread_id" class="thread-badge" @click.stop="toggleThreadFromEntry(entry.thread_id)" x-text="'üßµ ' + entry.thread_id"></span>
                                    <span x-show="entry.correlation_id" class="text-blue-400" x-text="'üîó ' + entry.correlation_id"></span>
                                    <span x-show="entry.service_name" class="text-green-300" x-text="'üõ† ' + entry.service_name"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
                <div :style="`height:${logBottomSpacer}px`"></div>
            </div>

            <!-- Hierarchy Tree View -->
            <div x-show="viewMode === 'hierarchy'" class="flex-1 log-viewer overflow-auto p-4">
                <div x-show="hierarchyLoading" class="flex items-center justify-center h-full">
                    <div class="flex flex-col items-center gap-3">
                        <div class="h-10 w-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                        <div class="text-sm text-gray-200">Loading hierarchy...</div>
                    </div>
                </div>

                <div x-show="!hierarchyLoading && hierarchyError" class="flex items-center justify-center h-full">
                    <div class="text-center text-red-400">
                        <div class="text-4xl mb-4">‚ùå</div>
                        <div class="text-lg" x-text="hierarchyError"></div>
                    </div>
                </div>

                <div x-show="!hierarchyLoading && !hierarchyError && !hierarchy" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-4">üå≥</div>
                        <div class="text-lg mb-2">No hierarchy loaded</div>
                        <div class="text-sm">Enter a root ID (thread, correlation, or trace) and click Load</div>
                    </div>
                </div>

                <div x-show="!hierarchyLoading && !hierarchyError && hierarchy">
                    <!-- Summary Stats -->
                    <div class="grid grid-cols-4 gap-3 mb-4">
                        <div class="stat-card p-3 rounded-lg">
                            <div class="text-xs text-gray-300">Total Nodes</div>
                            <div class="text-xl font-bold" x-text="hierarchy?.total_nodes || 0"></div>
                        </div>
                        <div class="stat-card p-3 rounded-lg">
                            <div class="text-xs text-gray-300">Max Depth</div>
                            <div class="text-xl font-bold" x-text="hierarchy?.max_depth || 0"></div>
                        </div>
                        <div class="stat-card p-3 rounded-lg">
                            <div class="text-xs text-gray-300">Duration</div>
                            <div class="text-xl font-bold" x-text="formatDuration(hierarchy?.total_duration_ms)"></div>
                        </div>
                        <div class="stat-card p-3 rounded-lg" :class="(hierarchy?.error_nodes?.length > 0) ? 'border-red-500 border' : ''">
                            <div class="text-xs text-gray-300">Errors</div>
                            <div class="text-xl font-bold text-red-400" x-text="hierarchy?.error_nodes?.length || 0"></div>
                        </div>
                    </div>

                    <!-- Bottleneck Alert -->
                    <div x-show="hierarchy?.bottleneck" class="mb-4 p-3 bg-amber-900/30 border border-amber-500/50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <span class="text-amber-400">‚ö†Ô∏è</span>
                            <span class="font-bold text-amber-300">Bottleneck Detected:</span>
                            <span x-text="hierarchy?.bottleneck?.node_id"></span>
                            <span class="text-gray-400">-</span>
                            <span x-text="formatDuration(hierarchy?.bottleneck?.duration_ms)"></span>
                            <span class="text-gray-400">(<span x-text="hierarchy?.bottleneck?.percentage?.toFixed(1)"></span>%)</span>
                        </div>
                    </div>

                    <!-- Interactive Tree -->
                    <div class="font-mono text-sm">
                        <template x-for="root in hierarchy?.roots || []" :key="root.id">
                            <div x-data="{ expanded: true }">
                                <div class="flex items-center gap-2 p-2 hover:bg-white/5 rounded cursor-pointer"
                                     @click="expanded = !expanded"
                                     :class="root.error_count > 0 ? 'bg-red-900/20' : ''">
                                    <span x-text="expanded ? '‚ñº' : '‚ñ∂'" class="text-gray-500 w-4"></span>
                                    <span x-text="root.error_count > 0 ? '‚ùå' : 'üìÅ'" class="w-5"></span>
                                    <span class="font-bold text-green-400" x-text="root.id"></span>
                                    <span class="text-gray-500">(<span x-text="root.entry_count"></span> entries)</span>
                                    <span x-show="root.duration_ms" class="text-yellow-400" x-text="formatDuration(root.duration_ms)"></span>
                                    <span class="text-gray-600 text-xs" x-text="root.node_type"></span>
                                </div>
                                <div x-show="expanded" class="ml-6 border-l border-gray-700">
                                    <template x-for="child in root.children || []" :key="child.id">
                                        <div x-html="renderHierarchyNode(child, 1)"></div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>

                    <!-- Error Flow Analysis -->
                    <div x-show="errorAnalysis?.has_errors" class="mt-6 p-4 bg-red-900/20 border border-red-500/30 rounded-lg">
                        <h3 class="text-lg font-bold text-red-400 mb-3">üîç Error Flow Analysis</h3>

                        <div x-show="errorAnalysis?.root_causes?.length > 0" class="mb-4">
                            <div class="text-sm font-bold text-red-300 mb-2">Root Cause(s):</div>
                            <template x-for="cause in errorAnalysis?.root_causes || []" :key="cause.node_id">
                                <div class="ml-4 p-2 bg-red-900/30 rounded mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-red-400">üî¥</span>
                                        <span class="font-bold" x-text="cause.node_id"></span>
                                        <span x-show="cause.is_leaf" class="text-xs text-gray-400">(leaf node)</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">
                                        Path: <span x-text="cause.path?.join(' ‚Üí ')"></span>
                                    </div>
                                </div>
                            </template>
                        </div>

                        <div x-show="errorAnalysis?.recommendations?.length > 0">
                            <div class="text-sm font-bold text-amber-300 mb-2">üí° Recommendations:</div>
                            <ul class="ml-4 text-sm text-gray-300 space-y-1">
                                <template x-for="rec in errorAnalysis?.recommendations || []" :key="rec">
                                    <li class="flex items-start gap-2">
                                        <span>‚Ä¢</span>
                                        <span x-text="rec"></span>
                                    </li>
                                </template>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Waterfall Timeline View -->
            <div x-show="viewMode === 'waterfall'" class="flex-1 log-viewer overflow-auto p-4">
                <div x-show="hierarchyLoading" class="flex items-center justify-center h-full">
                    <div class="flex flex-col items-center gap-3">
                        <div class="h-10 w-10 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
                        <div class="text-sm text-gray-200">Loading waterfall...</div>
                    </div>
                </div>

                <div x-show="!hierarchyLoading && !hierarchy" class="flex items-center justify-center h-full">
                    <div class="text-center text-gray-500">
                        <div class="text-4xl mb-4">üìä</div>
                        <div class="text-lg mb-2">No waterfall data</div>
                        <div class="text-sm">Enter a root ID and click Load</div>
                    </div>
                </div>

                <div x-show="!hierarchyLoading && hierarchy">
                    <!-- Waterfall Header -->
                    <div class="mb-4 flex items-center justify-between">
                        <div>
                            <span class="text-lg font-bold">Timeline:</span>
                            <span x-text="hierarchyRootId" class="text-green-400 ml-2"></span>
                            <span class="text-gray-400 ml-2">(<span x-text="formatDuration(hierarchy?.total_duration_ms)"></span>)</span>
                        </div>
                        <div class="text-xs text-gray-400">
                            Detection: <span x-text="hierarchy?.detection_method"></span>
                        </div>
                    </div>

                    <!-- Waterfall Bars -->
                    <div class="font-mono text-xs space-y-1">
                        <template x-for="node in flattenHierarchy()" :key="node.id">
                            <div class="flex items-center gap-2 py-1">
                                <div class="w-40 truncate text-right pr-2" :style="`padding-left: ${node.depth * 12}px`">
                                    <span :class="node.error_count > 0 ? 'text-red-400' : 'text-gray-300'" x-text="node.id"></span>
                                </div>
                                <div class="flex-1 h-5 bg-gray-800 rounded relative overflow-hidden">
                                    <div class="absolute h-full rounded"
                                         :class="node.error_count > 0 ? 'bg-red-600' : (node.id === hierarchy?.bottleneck?.node_id ? 'bg-amber-600' : 'bg-indigo-600')"
                                         :style="`left: ${getWaterfallBarLeft(node)}%; width: ${getWaterfallBarWidth(node)}%`">
                                    </div>
                                </div>
                                <div class="w-16 text-right text-gray-400" x-text="formatDuration(node.duration_ms)"></div>
                            </div>
                        </template>
                    </div>

                    <!-- Legend -->
                    <div class="mt-4 flex items-center gap-4 text-xs text-gray-400">
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 bg-indigo-600 rounded"></div>
                            <span>Normal</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 bg-amber-600 rounded"></div>
                            <span>Bottleneck</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-3 h-3 bg-red-600 rounded"></div>
                            <span>Error</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- File Picker Modal -->
    <div x-show="showFilePicker" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50"
         @click.self="showFilePicker = false">
        <div class="glass-card text-white p-6 rounded-xl max-w-2xl w-full mx-4 max-h-[80vh] flex flex-col">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold">üìÅ Open Log File</h2>
                <div class="flex gap-2 text-xs">
                    <button @click="toggleBrowseMode('browse')" :class="browseMode === 'browse' ? 'bg-white bg-opacity-20' : 'bg-white bg-opacity-5'" class="px-2 py-1 rounded hover:bg-opacity-30">Browse</button>
                    <button @click="toggleBrowseMode('glob')" :class="browseMode === 'glob' ? 'bg-white bg-opacity-20' : 'bg-white bg-opacity-5'" class="px-2 py-1 rounded hover:bg-opacity-30">Glob search</button>
                </div>
            </div>

            <div class="mb-4">
                <template x-if="browseMode === 'browse'">
                    <input type="text" x-model="currentDir" @keyup.enter="browseDirectory(currentDir)"
                           placeholder="Enter directory path..."
                           class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                </template>
                <template x-if="browseMode === 'glob'">
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <label class="text-xs text-gray-300 block mb-1">Pattern</label>
                            <input type="text" x-model="globPattern" @keyup.enter="searchGlob()"
                                   placeholder="Pattern (e.g. **/*.log)"
                                   class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <div class="flex-1">
                            <label class="text-xs text-gray-300 block mb-1">Base directory</label>
                            <input type="text" x-model="globBaseDir" @keyup.enter="searchGlob()"
                                   placeholder="Base directory"
                                   class="w-full px-4 py-2 bg-white bg-opacity-10 border border-white border-opacity-20 rounded focus:outline-none focus:ring-2 focus:ring-purple-400">
                        </div>
                        <button @click="searchGlob" class="px-3 py-2 bg-white bg-opacity-20 rounded hover:bg-opacity-30 self-end">Search</button>
                    </div>
                </template>
            </div>

            <div class="flex-1 overflow-y-auto space-y-2 mb-4">
                <div x-show="browseMode === 'browse'">
                    <div class="flex items-center flex-wrap gap-2 mb-3">
                        <template x-for="crumb in breadcrumbs()" :key="crumb.path">
                            <button @click="browseDirectory(crumb.path)" class="px-2 py-1 text-xs bg-white bg-opacity-10 rounded border border-white/10 hover:bg-opacity-20" x-text="crumb.label || crumb.path"></button>
                        </template>
                    </div>
                    <div x-show="parentDir" @click="browseDirectory(parentDir)"
                         class="file-item p-3 rounded cursor-pointer bg-white bg-opacity-5">
                        <span class="text-yellow-400">üìÅ ..</span>
                    </div>

                    <template x-for="dir in directories" :key="dir.path">
                        <div @click="browseDirectory(dir.path)"
                             class="file-item p-3 rounded cursor-pointer bg-white bg-opacity-5">
                            <div class="flex items-center space-x-2">
                                <span>üìÅ</span>
                                <span class="font-mono text-sm" x-text="dir.name"></span>
                            </div>
                        </div>
                    </template>

                    <template x-for="file in files" :key="file.path">
                        <div class="file-item p-3 rounded bg-white bg-opacity-5 flex items-center justify-between">
                            <div class="flex items-center space-x-2 cursor-pointer" @click="openFile(file.path); showFilePicker = false">
                                <span>üìÑ</span>
                                <div class="flex flex-col">
                                    <span class="font-mono text-sm truncate" x-text="file.name"></span>
                                    <span class="text-[11px] text-gray-400 truncate" x-text="file.path"></span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" :value="file.path" x-model="selectedPaths">
                                <span class="text-xs text-gray-400" x-text="formatSize(file.size)"></span>
                            </div>
                        </div>
                    </template>

                    <div x-show="files.length === 0 && directories.length === 0" class="text-center text-gray-400 py-8">
                        No log files found in this directory
                    </div>
                </div>

                <div x-show="browseMode === 'glob'">
                    <div class="flex items-center flex-wrap gap-2 mb-3">
                        <span class="px-2 py-1 text-xs bg-white bg-opacity-10 rounded border border-white/10" x-text="'Base: ' + (globBaseDir || '.')"></span>
                        <template x-for="preset in globPresets" :key="preset">
                            <button @click="globPattern = preset; searchGlob()" class="px-2 py-1 text-xs bg-white bg-opacity-5 rounded hover:bg-opacity-15 border border-white/5" x-text="preset"></button>
                        </template>
                    </div>
                    <div x-show="globLoading" class="text-center text-gray-300 py-4">Searching‚Ä¶</div>
                    <div x-show="globError" class="text-center text-amber-300 text-xs py-2" x-text="globError"></div>
                    <template x-for="file in globResults" :key="file.path">
                        <div class="file-item p-3 rounded bg-white bg-opacity-5 flex items-center justify-between">
                            <div class="flex items-center space-x-2 cursor-pointer" @click="openFile(file.path); showFilePicker = false">
                                <span>üìÑ</span>
                                <div class="flex flex-col">
                                    <span class="font-mono text-sm truncate" x-text="file.name"></span>
                                    <span class="text-[11px] text-gray-400 truncate" x-text="file.path"></span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <input type="checkbox" :value="file.path" x-model="selectedPaths">
                                <span class="text-xs text-gray-400" x-text="formatSize(file.size)"></span>
                            </div>
                        </div>
                    </template>
                    <div x-show="!globLoading && globResults.length === 0" class="text-center text-gray-400 py-8">
                        No files match this pattern
                    </div>
                </div>
            </div>

            <div class="space-y-2">
                <button @click="openSelected()"
                        class="w-full py-2 bg-green-500 hover:bg-green-600 rounded transition disabled:opacity-50"
                        :disabled="selectedPaths.length === 0">
                    Open Selected (interleave)
                </button>
                <button @click="showFilePicker = false"
                        class="w-full py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded transition">
                    Close
                </button>
            </div>
        </div>
    </div>

    <!-- Interleave Details Modal -->
    <div x-show="showInterleaveModal" x-cloak
         class="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center z-50"
         @click.self="showInterleaveModal = false">
        <div class="glass-card text-white p-6 rounded-xl max-w-xl w-full mx-4 max-h-[70vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold">Interleave Details</h2>
                <button @click="showInterleaveModal = false" class="text-sm px-2 py-1 bg-white bg-opacity-10 rounded hover:bg-opacity-20">Close</button>
            </div>
            <template x-if="interleaveMeta.length === 0">
                <div class="text-gray-300 text-sm">No metadata available.</div>
            </template>
            <div x-show="interleaveMeta.length > 0" class="space-y-3">
                <template x-for="item in interleaveMeta" :key="item.file">
                    <div class="p-3 bg-white bg-opacity-5 rounded border border-white/10">
                        <div class="flex items-center justify-between text-sm">
                            <div class="font-mono truncate" :title="item.file" x-text="item.file.split('/').pop() || item.file"></div>
                            <div class="text-xs text-gray-300" x-text="(interleaveCounts[item.file] || item.count || 0) + ' rows'"></div>
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2 text-xs text-gray-300">
                            <div>First: <span class="text-gray-100" x-text="item.first || 'N/A'"></span></div>
                            <div>Last: <span class="text-gray-100" x-text="item.last || 'N/A'"></span></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>

    <script>
        function logViewer() {
            return {
                MAX_ENTRIES: 10000,
                LOG_ROW_HEIGHT: 56,
                LOG_OVERSCAN: 20,
                THREAD_ROW_HEIGHT: 40,
                THREAD_OVERSCAN: 12,
                showFilePicker: false,
                currentDir: '.',
                parentDir: null,
                files: [],
                directories: [],
                activeFiles: [],
                selectedPaths: [],
                browseMode: 'browse',
                globPattern: '**/*.log',
                globBaseDir: '.',
                globResults: [],
                globLoading: false,
                globError: '',
                globPresets: ['*.log', '**/*.log', '**/app-*.log', '**/*error*.log'],
                rootDir: '',
                currentFile: null,
                currentFiles: [],
                interleaved: false,
                interleaveCounts: {},
                interleaveMeta: [],
                entries: [],
                filteredEntries: [],
                visibleEntries: [],
                // Hierarchy view state
                viewMode: 'logs',  // 'logs', 'hierarchy', 'waterfall'
                hierarchyRootId: '',
                hierarchy: null,
                errorAnalysis: null,
                hierarchyLoading: false,
                hierarchyError: '',
                hierarchyMinTime: null,
                hierarchyMaxTime: null,
                logTopSpacer: 0,
                logBottomSpacer: 0,
                logViewportHeight: 600,
                logScrollScheduled: false,
                threads: [],
                threadSearch: '',
                selectedThreads: [],
                visibleThreadsCache: [],
                threadTopSpacer: 0,
                threadBottomSpacer: 0,
                threadViewportHeight: 256,
                searchQuery: '',
                correlationFilter: '',
                selectedLevels: [],
                totalAvailable: 0,
                autoScroll: false,
                ignoreScrollEvents: false,
                websocketConnected: false,
                isFollowing: false,
                loading: false,
                indexing: false,
                partialLoad: false,
                skipFullIndex: true,
                showInterleaveModal: false,
                followSocket: null,
                stats: {
                    total: 0,
                    errors: 0,
                },

                entryKey(entry) {
                    const file = entry.file || this.currentFile || '';
                    const ts = entry.timestamp || '';
                    return `${file}:${entry.line_number || 0}:${ts}`;
                },

                currentFilterPayload() {
                    return {
                        query: this.searchQuery || null,
                        correlation: this.correlationFilter || null,
                        levels: this.selectedLevels || [],
                        threads: this.selectedThreads || [],
                    };
                },

                refreshLayout() {
                    this.measureViewports();
                    this.updateVisibleEntries(true);
                    this.updateVisibleThreads();
                },

                measureViewports() {
                    const logEl = document.getElementById('log-container');
                    const threadEl = document.getElementById('thread-list');
                    if (logEl) this.logViewportHeight = logEl.clientHeight || this.logViewportHeight;
                    if (threadEl) this.threadViewportHeight = threadEl.clientHeight || this.threadViewportHeight;
                },

                updateVisibleEntries(forceStick = false) {
                    const container = document.getElementById('log-container');
                    if (!container) return;

                    const total = this.filteredEntries.length;
                    if (total === 0) {
                        this.visibleEntries = [];
                        this.logTopSpacer = 0;
                        this.logBottomSpacer = 0;
                        return;
                    }

                    const viewport = this.logViewportHeight || container.clientHeight || 1;
                    const windowSize = Math.ceil(viewport / this.LOG_ROW_HEIGHT) + this.LOG_OVERSCAN * 2;

                    if (forceStick && this.autoScroll) {
                        const end = total;
                        const start = Math.max(0, end - windowSize);
                        this.logTopSpacer = start * this.LOG_ROW_HEIGHT;
                        const rendered = end - start;
                        this.visibleEntries = this.filteredEntries.slice(start, end);
                        this.logBottomSpacer = Math.max(
                            0,
                            total * this.LOG_ROW_HEIGHT - this.logTopSpacer - rendered * this.LOG_ROW_HEIGHT
                        );
                        this.ignoreScrollEvents = true;
                        container.scrollTop = container.scrollHeight;
                        requestAnimationFrame(() => {
                            const refreshed = document.getElementById('log-container');
                            if (refreshed) {
                                refreshed.scrollTop = refreshed.scrollHeight;
                            }
                            this.ignoreScrollEvents = false;
                        });
                        return;
                    }

                    let scrollTop = container.scrollTop;
                    const start = Math.max(0, Math.floor(scrollTop / this.LOG_ROW_HEIGHT) - this.LOG_OVERSCAN);
                    const end = Math.min(total, start + windowSize);

                    this.logTopSpacer = start * this.LOG_ROW_HEIGHT;
                    const rendered = end - start;
                    this.visibleEntries = this.filteredEntries.slice(start, end);
                    this.logBottomSpacer = Math.max(
                        0,
                        total * this.LOG_ROW_HEIGHT - this.logTopSpacer - rendered * this.LOG_ROW_HEIGHT
                    );
                },

                updateVisibleThreads() {
                    const pool = this.filteredThreadPool();
                    const container = document.getElementById('thread-list');
                    const viewport = this.threadViewportHeight || (container ? container.clientHeight : 1);
                    const scrollTop = container ? container.scrollTop : 0;

                    if (pool.length === 0) {
                        this.visibleThreadsCache = [];
                        this.threadTopSpacer = 0;
                        this.threadBottomSpacer = 0;
                        return;
                    }

                    const start = Math.max(0, Math.floor(scrollTop / this.THREAD_ROW_HEIGHT) - this.THREAD_OVERSCAN);
                    const windowSize = Math.ceil(viewport / this.THREAD_ROW_HEIGHT) + this.THREAD_OVERSCAN * 2;
                    const end = Math.min(pool.length, start + windowSize);

                    this.threadTopSpacer = start * this.THREAD_ROW_HEIGHT;
                    const rendered = end - start;
                    this.visibleThreadsCache = pool.slice(start, end);
                    this.threadBottomSpacer = Math.max(
                        0,
                        pool.length * this.THREAD_ROW_HEIGHT - this.threadTopSpacer - rendered * this.THREAD_ROW_HEIGHT
                    );
                },

                async openSelected() {
                    if (this.selectedPaths.length === 0) return;
                    if (this.isFollowing && this.followSocket) {
                        this.followSocket.close();
                    }
                    this.loading = true;
                    const response = await fetch('/api/files/open_many', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({paths: this.selectedPaths, filters: this.currentFilterPayload(), limit: this.MAX_ENTRIES})
                    });
                    const data = await response.json();
                    this.loading = false;
                    this.currentFile = null;
                    this.currentFiles = data.files || [];
                    this.interleaveCounts = data.file_counts || {};
                    this.interleaveMeta = data.file_meta || [];
                    this.activeFiles = Array.from(new Set([...this.activeFiles, ...this.currentFiles]));
                    this.interleaved = true;
                    this.entries = (data.entries || []).slice(-this.MAX_ENTRIES);
                    this.totalAvailable = data.total || this.entries.length;
                    this.showFilePicker = false;
                    this.selectedThreads = [];
                    this.threadSearch = '';
                    await this.applyFilters();
                    await this.loadThreads();
                    this.updateStats();
                    this.isFollowing = false;
                    this.websocketConnected = false;
                    if (this.autoScroll) {
                        this.$nextTick(() => this.scrollToBottom());
                    }
                },

                init() {
                    this.browseDirectory('.');
                    {% if active_files %}
                    this.activeFiles = {{ active_files | tojson }};
                    if (this.activeFiles.length > 0) {
                        this.openFile(this.activeFiles[0]);
                    }
                    {% endif %}
                    this.$nextTick(() => {
                        this.refreshLayout();
                        window.addEventListener('resize', () => this.refreshLayout());
                    });
                },

                async browseDirectory(dir) {
                    this.browseMode = 'browse';
                    this.globError = '';
                    this.globBaseDir = dir || '.';
                    const response = await fetch(`/api/files/browse?directory=${encodeURIComponent(dir)}`);
                    const data = await response.json();
                    if (!this.rootDir && data.log_root) {
                        this.rootDir = data.log_root;
                    }
                    this.currentDir = data.current_dir || dir;
                    this.parentDir = data.parent_dir;
                    this.files = data.files || [];
                    this.directories = data.directories || [];
                },

                toggleBrowseMode(mode) {
                    this.browseMode = mode;
                    if (mode === 'glob' && this.globResults.length === 0) {
                        this.globBaseDir = this.currentDir || '.';
                        this.globPattern = '**/*.log';
                        this.searchGlob();
                    }
                },

                async searchGlob() {
                    this.globLoading = true;
                    this.globError = '';
                    try {
                        const resp = await fetch(`/api/files/glob?pattern=${encodeURIComponent(this.globPattern)}&base_dir=${encodeURIComponent(this.globBaseDir)}`);
                        const data = await resp.json();
                        this.globResults = data.files || [];
                        this.globError = data.truncated ? `Showing first ${this.globResults.length} of ${data.count} matches` : '';
                    } catch (e) {
                        this.globError = 'Failed to search';
                    } finally {
                        this.globLoading = false;
                    }
                },

                async openFile(path) {
                    if (this.isFollowing && this.followSocket) {
                        this.followSocket.close();
                    }
                    this.loading = true;
                    this.partialLoad = false;
                    this.indexing = false;
                    this.skipFullIndex = true;

                    const quickPayload = {
                        path,
                        filters: this.currentFilterPayload(),
                        limit: this.MAX_ENTRIES,
                        quick: true,
                    };

                    try {
                        const quickResp = await fetch('/api/files/open', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify(quickPayload),
                        });
                        const quickData = await quickResp.json();
                        if (quickData.error) {
                            alert(quickData.error);
                            this.loading = false;
                            return;
                        }

                        this.currentFile = quickData.file_path;
                        this.currentFiles = [quickData.file_path];
                        this.interleaved = false;
                        this.interleaveCounts = {};
                        this.interleaveMeta = [];
                        if (!this.activeFiles.includes(this.currentFile)) {
                            this.activeFiles.push(this.currentFile);
                        }
                        this.entries = (quickData.entries || []).slice(-this.MAX_ENTRIES);
                        this.totalAvailable = quickData.total || this.entries.length;
                        this.selectedThreads = [];
                            this.threadSearch = '';
                            this.partialLoad = !!quickData.partial;
                            this.skipFullIndex = true;
                            this.loading = false;
                            await this.applyFilters();
                            await this.loadThreads();
                            this.updateStats();
                            if (this.autoScroll) {
                            this.$nextTick(() => this.scrollToBottom());
                        }

                        // Kick off full indexing in the background
                        this.indexing = false;
                    } catch (e) {
                        console.error(e);
                        alert('Failed to open file');
                        this.loading = false;
                        this.indexing = false;
                    }
                },

                async loadThreads() {
                    const response = await fetch('/api/threads');
                    this.threads = await response.json();
                    this.$nextTick(() => this.updateVisibleThreads());
                },

                async applyFilters() {
                    if (this.partialLoad || this.indexing) {
                        this.filteredEntries = this.entries;
                        if (this.searchQuery) {
                            const query = this.searchQuery.toLowerCase();
                            this.filteredEntries = this.filteredEntries.filter(e => (e.message || '').toLowerCase().includes(query));
                        }
                        if (this.correlationFilter) {
                            const cq = this.correlationFilter.toLowerCase();
                            this.filteredEntries = this.filteredEntries.filter(e => (e.correlation_id || '').toLowerCase().includes(cq));
                        }
                        if (this.selectedLevels.length > 0) {
                            this.filteredEntries = this.filteredEntries.filter(e => this.selectedLevels.includes(e.level));
                        }
                        if (this.selectedThreads.length > 0) {
                            const set = new Set(this.selectedThreads);
                            this.filteredEntries = this.filteredEntries.filter(e => set.has(e.thread_id));
                        }
                        this.$nextTick(() => {
                            this.updateVisibleEntries(this.autoScroll);
                            this.updateStats();
                        });
                        return;
                    }

                    // Try server-side filtering to avoid shipping unused rows
                    if (this.currentFiles.length > 0 && !this.isFollowing) {
                        const payload = {
                            paths: this.currentFiles,
                            filters: this.currentFilterPayload(),
                            limit: this.MAX_ENTRIES,
                        };
                        try {
                            const resp = await fetch('/api/files/filter', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify(payload),
                            });
                            if (resp.ok) {
                                const data = await resp.json();
                                this.entries = (data.entries || []).slice(-this.MAX_ENTRIES);
                                this.totalAvailable = data.total || this.entries.length;
                                this.filteredEntries = this.entries;
                                this.$nextTick(() => {
                                    this.updateVisibleEntries(this.autoScroll);
                                    this.updateStats();
                                });
                                return;
                            }
                        } catch (e) {
                            console.warn('Server filter failed, falling back to client filter', e);
                        }
                    }

                    // Client-side fallback
                    let filtered = this.entries;

                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(e => (e.message || '').toLowerCase().includes(query));
                    }

                    if (this.correlationFilter) {
                        const cq = this.correlationFilter.toLowerCase();
                        filtered = filtered.filter(e => (e.correlation_id || '').toLowerCase().includes(cq));
                    }

                    if (this.selectedLevels.length > 0) {
                        filtered = filtered.filter(e => this.selectedLevels.includes(e.level));
                    }

                    if (this.selectedThreads.length > 0) {
                        const set = new Set(this.selectedThreads);
                        filtered = filtered.filter(e => set.has(e.thread_id));
                    }

                    this.filteredEntries = filtered;
                    this.$nextTick(() => {
                        this.updateVisibleEntries(this.autoScroll);
                        this.updateStats();
                    });
                },

                updateStats() {
                    this.stats.total = this.filteredEntries.length;
                    this.stats.errors = this.filteredEntries.filter(e =>
                        ['ERROR', 'CRITICAL', 'FATAL'].includes(e.level)
                    ).length;
                },

                toggleThread(threadId) {
                    const idx = this.selectedThreads.indexOf(threadId);
                    if (idx >= 0) {
                        this.selectedThreads.splice(idx, 1);
                    } else {
                        this.selectedThreads.push(threadId);
                    }
                    this.applyFilters();
                },

                removeThread(threadId) {
                    const idx = this.selectedThreads.indexOf(threadId);
                    if (idx >= 0) {
                        this.selectedThreads.splice(idx, 1);
                        this.applyFilters();
                    }
                },

                toggleThreadFromEntry(threadId) {
                    if (!threadId) return;
                    if (!this.selectedThreads.includes(threadId)) {
                        this.selectedThreads.push(threadId);
                    }
                    this.applyFilters();
                },

                clearThreadSelection() {
                    this.selectedThreads = [];
                    this.applyFilters();
                },

                async loadFullCurrent() {
                    if (!this.currentFile) return;
                    this.indexing = true;
                    this.partialLoad = false;
                    this.skipFullIndex = false;
                    try {
                        const response = await fetch('/api/files/open', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                path: this.currentFile,
                                filters: this.currentFilterPayload(),
                                limit: this.MAX_ENTRIES,
                                quick: false,
                            }),
                        });
                        const data = await response.json();
                        if (data.error) {
                            alert(data.error);
                            this.indexing = false;
                            return;
                        }
                        this.entries = (data.entries || []).slice(-this.MAX_ENTRIES);
                        this.totalAvailable = data.total || this.entries.length;
                        this.selectedThreads = [];
                        this.threadSearch = '';
                        this.partialLoad = false;
                        this.applyFilters();
                        this.loadThreads();
                        this.updateStats();
                        if (this.autoScroll) {
                            this.$nextTick(() => this.scrollToBottom());
                        }
                    } catch (e) {
                        console.error(e);
                        alert('Failed to load full log');
                    } finally {
                        this.indexing = false;
                    }
                },

                filteredThreadPool() {
                    const query = this.threadSearch.toLowerCase().trim();
                    if (!query) return this.threads;
                    return this.threads.filter(t => (t.thread_id || '').toLowerCase().includes(query));
                },

                breadcrumbs() {
                    const root = this.rootDir || '';
                    const path = this.currentDir || '';
                    if (!root || !path || !path.startsWith(root)) {
                        return [];
                    }
                    const parts = [];
                    parts.push({label: root.split('/').pop() || root, path: root});
                    const relative = path.slice(root.length).replace(/^\\/+/, '');
                    let acc = root;
                    relative.split('/').filter(Boolean).forEach(segment => {
                        acc = acc.endsWith('/') ? acc + segment : acc + '/' + segment;
                        parts.push({label: segment, path: acc});
                    });
                    return parts;
                },

                selectFile(file) {
                    this.openFile(file);
                },

                toggleFollow() {
                    if (this.isFollowing) {
                        if (this.followSocket) {
                            this.followSocket.close();
                        }
                        this.isFollowing = false;
                        this.websocketConnected = false;
                        return;
                    }

                    if (!this.currentFile || this.interleaved) return;

                    this.followSocket = new WebSocket(`ws://${location.host}/ws`);
                    this.followSocket.onopen = () => {
                        this.websocketConnected = true;
                        this.isFollowing = true;
                        this.autoScroll = true;
                        this.followSocket.send(JSON.stringify({
                            action: 'follow',
                            file_path: this.currentFile,
                            filters: this.currentFilterPayload(),
                        }));
                    };

                    this.followSocket.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        if (data.type === 'log_entry') {
                            this.entries.push(data.entry);
                            if (this.entries.length > this.MAX_ENTRIES) {
                                this.entries = this.entries.slice(-this.MAX_ENTRIES);
                            }
                            this.totalAvailable += 1;
                            this.applyFilters();
                            if (this.autoScroll) {
                                this.$nextTick(() => this.scrollToBottom());
                            }
                        }
                    };

                    this.followSocket.onclose = () => {
                        this.websocketConnected = false;
                        this.isFollowing = false;
                    };
                },

                formatTimestamp(ts) {
                    if (!ts) return 'N/A';
                    return new Date(ts).toLocaleString();
                },

                formatSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                },

                scrollToBottom() {
                    const container = document.getElementById('log-container');
                    if (!container) return;
                    this.ignoreScrollEvents = true;
                    container.scrollTop = container.scrollHeight;
                    requestAnimationFrame(() => {
                        this.ignoreScrollEvents = false;
                        this.updateVisibleEntries(true);
                    });
                },

                handleScroll() {
                    if (this.ignoreScrollEvents) return;
                    if (this.logScrollScheduled) return;
                    this.logScrollScheduled = true;
                    requestAnimationFrame(() => {
                        const container = document.getElementById('log-container');
                        if (container) {
                            const distanceFromBottom = container.scrollHeight - (container.scrollTop + container.clientHeight);
                            const isAtBottom = distanceFromBottom <= 120;
                            if (!isAtBottom) {
                                this.autoScroll = false;
                            } else {
                                this.autoScroll = true;
                            }
                            this.updateVisibleEntries(this.autoScroll);
                        }
                        this.logScrollScheduled = false;
                    });
                },

                // ===== Hierarchy Functions =====

                async loadHierarchy() {
                    if (!this.hierarchyRootId || this.currentFiles.length === 0) {
                        if (this.hierarchyRootId && this.activeFiles.length > 0) {
                            // Use active files if no current files
                            this.currentFiles = this.activeFiles;
                        } else {
                            this.hierarchyError = 'No files loaded. Open a log file first.';
                            return;
                        }
                    }

                    this.hierarchyLoading = true;
                    this.hierarchyError = '';
                    this.hierarchy = null;
                    this.errorAnalysis = null;

                    try {
                        const response = await fetch('/api/hierarchy', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({
                                paths: this.currentFiles.length > 0 ? this.currentFiles : this.activeFiles,
                                root_identifier: this.hierarchyRootId,
                                min_confidence: 0.0,
                                use_naming_patterns: true,
                                use_temporal_inference: true,
                            })
                        });

                        const data = await response.json();

                        if (data.error) {
                            this.hierarchyError = data.error;
                        } else {
                            this.hierarchy = data.hierarchy;
                            this.errorAnalysis = data.error_analysis;
                            this.calculateTimeRange();
                        }
                    } catch (e) {
                        this.hierarchyError = 'Failed to load hierarchy: ' + e.message;
                    } finally {
                        this.hierarchyLoading = false;
                    }
                },

                calculateTimeRange() {
                    if (!this.hierarchy?.roots) return;

                    let minTime = null;
                    let maxTime = null;

                    const processNode = (node) => {
                        if (node.start_time) {
                            const t = new Date(node.start_time).getTime();
                            if (minTime === null || t < minTime) minTime = t;
                        }
                        if (node.end_time) {
                            const t = new Date(node.end_time).getTime();
                            if (maxTime === null || t > maxTime) maxTime = t;
                        }
                        (node.children || []).forEach(processNode);
                    };

                    this.hierarchy.roots.forEach(processNode);
                    this.hierarchyMinTime = minTime;
                    this.hierarchyMaxTime = maxTime;
                },

                formatDuration(ms) {
                    if (ms === null || ms === undefined) return 'N/A';
                    if (ms < 1) return '<1ms';
                    if (ms < 1000) return ms.toFixed(0) + 'ms';
                    if (ms < 60000) return (ms / 1000).toFixed(2) + 's';
                    return (ms / 60000).toFixed(2) + 'm';
                },

                renderHierarchyNode(node, depth) {
                    const hasChildren = node.children && node.children.length > 0;
                    const icon = node.error_count > 0 ? '‚ùå' : (hasChildren ? 'üìÅ' : 'üìÑ');
                    const bgClass = node.error_count > 0 ? 'bg-red-900/20' : '';
                    const indent = depth * 16;

                    let html = `
                        <div x-data="{ expanded: ${depth < 3} }" style="margin-left: ${indent}px">
                            <div class="flex items-center gap-2 p-1 hover:bg-white/5 rounded cursor-pointer ${bgClass}"
                                 @click="expanded = !expanded">
                                <span x-text="expanded ? '‚ñº' : '‚ñ∂'" class="text-gray-500 w-4 ${hasChildren ? '' : 'invisible'}"></span>
                                <span>${icon}</span>
                                <span class="text-blue-300">${this.escapeHtml(node.id)}</span>
                                <span class="text-gray-500">(${node.entry_count || 0} entries)</span>
                                ${node.duration_ms ? `<span class="text-yellow-400">${this.formatDuration(node.duration_ms)}</span>` : ''}
                                <span class="text-gray-600 text-xs">${node.node_type || ''}</span>
                            </div>
                    `;

                    if (hasChildren) {
                        html += `<div x-show="expanded" class="border-l border-gray-700">`;
                        for (const child of node.children) {
                            html += this.renderHierarchyNode(child, depth + 1);
                        }
                        html += `</div>`;
                    }

                    html += `</div>`;
                    return html;
                },

                escapeHtml(str) {
                    if (!str) return '';
                    return str.replace(/&/g, '&amp;')
                              .replace(/</g, '&lt;')
                              .replace(/>/g, '&gt;')
                              .replace(/"/g, '&quot;');
                },

                flattenHierarchy() {
                    if (!this.hierarchy?.roots) return [];

                    const result = [];
                    const flatten = (node, depth) => {
                        result.push({ ...node, depth });
                        (node.children || []).forEach(child => flatten(child, depth + 1));
                    };

                    this.hierarchy.roots.forEach(root => flatten(root, 0));
                    return result;
                },

                getWaterfallBarLeft(node) {
                    if (!node.start_time || !this.hierarchyMinTime || !this.hierarchyMaxTime) return 0;
                    const start = new Date(node.start_time).getTime();
                    const range = this.hierarchyMaxTime - this.hierarchyMinTime;
                    if (range <= 0) return 0;
                    return ((start - this.hierarchyMinTime) / range) * 100;
                },

                getWaterfallBarWidth(node) {
                    if (!node.duration_ms || !this.hierarchyMaxTime || !this.hierarchyMinTime) {
                        return 5; // Minimum width for visibility
                    }
                    const range = this.hierarchyMaxTime - this.hierarchyMinTime;
                    if (range <= 0) return 5;
                    const width = (node.duration_ms / range) * 100;
                    return Math.max(2, Math.min(100, width)); // Min 2%, max 100%
                }
            };
        }
    </script>
</body>
</html>
