name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.11"

jobs:
  lint-and-format:
    name: Lint and Format Check
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: ML modules have pre-existing formatting issues

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install black isort mypy
        pip install -e .[dev]

    - name: Check code formatting with Black
      run: black --check --diff src/

    - name: Check import sorting with isort
      run: isort --check-only --diff src/

    - name: Check for hardcoded strings
      run: python tools/lint_hardcoded_strings.py --check-all --json
      continue-on-error: true  # Non-blocking until codebase refactoring is complete (13k+ violations)

    - name: Type checking with mypy (full codebase)
      run: mypy src/ --ignore-missing-imports
      continue-on-error: true  # Non-blocking due to type errors in remaining modules

    - name: Type checking with mypy (priority modules)
      run: |
        # Check priority modules that have improved type annotations (issue #40)
        # These modules have fewer errors and are gradually being fully typed
        mypy src/mcli/lib/logger/logger.py src/mcli/lib/custom_commands.py --ignore-missing-imports
      continue-on-error: true  # Non-blocking until all function signatures are typed

  test-rust:
    name: Test Rust Extensions
    runs-on: ${{ matrix.os }}
    continue-on-error: true  # Non-blocking: macOS has LLVM version mismatch, tests pass on Ubuntu
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Rust format check
      run: |
        cd mcli_rust
        cargo fmt --all -- --check

    - name: Rust clippy
      run: |
        cd mcli_rust
        cargo clippy -- -D warnings || cargo clippy || echo "Warning: Clippy found issues, continuing"
      continue-on-error: ${{ matrix.os == 'macos-latest' }}

    - name: Rust tests
      run: |
        cd mcli_rust
        cargo test

  test-python:
    name: Test Python Package
    runs-on: ${{ matrix.os }}
    continue-on-error: true  # Non-blocking: Some tests have import errors (email-validator) - fixing in progress
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install system dependencies (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential libpq-dev

    - name: Install system dependencies (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew install postgresql@16

    - name: Set up Rust (for building extensions)
      uses: dtolnay/rust-toolchain@stable

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install maturin
        pip install -e .[dev]

    - name: Build Rust extensions
      run: |
        cd mcli_rust
        maturin develop --release || maturin develop || echo "Warning: Rust extension build failed, continuing without extensions"
      continue-on-error: ${{ matrix.python-version == '3.12' }}

    - name: Run Python tests with coverage
      run: |
        pytest tests/ -v --tb=short --cov=src/mcli --cov-report=xml --cov-report=term-missing

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: Test CLI functionality
      run: |
        mcli version
        mcli --help
        mcli self --help
        mcli visual --help

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: Rust-Python integration has known issues on CI
    if: always()  # Run even if test-python or test-rust fail
    needs: [test-python, test-rust]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Create virtual environment
      run: |
        python -m venv .venv
        echo "VIRTUAL_ENV=${{ github.workspace }}/.venv" >> $GITHUB_ENV
        echo "${{ github.workspace }}/.venv/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: |
        .venv/bin/python -m pip install --upgrade pip
        .venv/bin/pip install maturin
        .venv/bin/pip install -e .[dev]

    - name: Build Rust extensions
      id: rust_build
      run: |
        cd mcli_rust
        if maturin develop --release; then
          echo "rust_available=true" >> $GITHUB_OUTPUT
        elif maturin develop; then
          echo "rust_available=true" >> $GITHUB_OUTPUT
        else
          echo "rust_available=false" >> $GITHUB_OUTPUT
          echo "Warning: Rust extension build failed"
        fi
      continue-on-error: true

    - name: Test Rust-Python integration
      if: steps.rust_build.outputs.rust_available == 'true'
      run: |
        .venv/bin/python -c "
        import mcli_rust
        print('âœ… Rust extensions imported successfully')

        # Test TF-IDF
        vectorizer = mcli_rust.TfIdfVectorizer()
        docs = ['hello world', 'rust is fast', 'python integration']
        vectors = vectorizer.fit_transform(docs)
        print(f'âœ… TF-IDF: Generated {len(vectors)} vectors')

        # Test File Watcher
        watcher = mcli_rust.FileWatcher()
        print('âœ… File Watcher: Created successfully')

        # Test Command Matcher
        matcher = mcli_rust.CommandMatcher()
        print('âœ… Command Matcher: Created successfully')

        # Test Process Manager
        manager = mcli_rust.ProcessManager()
        print('âœ… Process Manager: Created successfully')

        print('ðŸŽ‰ All Rust extensions working!')
        "

    - name: Test performance monitoring
      run: |
        .venv/bin/mcli self performance --detailed

    - name: Test visual effects
      run: |
        .venv/bin/mcli self visual message --style success "Integration tests passed!"
        .venv/bin/mcli self visual spinner --spinner-type rust --duration 2 --message "Testing spinner..."

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    continue-on-error: true  # Non-blocking: CodeQL permissions and Trivy issues on this repo

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety

    - name: Run Bandit security linter
      run: |
        # Run with skip list for CLI tool false positives
        bandit -r src/ \
          --severity-level high \
          --skip B101,B102,B104,B108,B113,B301,B306,B310,B324,B404,B602,B603,B604,B605,B607 \
          -f json -o bandit-report.json || true
        # Also run a summary check (non-blocking)
        bandit -r src/ -ll || true

    - name: Run Safety dependency check
      run: |
        safety check --json > safety-report.json || true
        safety check --ignore 59234,71691,71584,71578,71577,71692,71579,71587,71693,64459,64396

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
        retention-days: 30

  build-package:
    name: Build Distribution Package
    runs-on: ubuntu-latest
    if: always()  # Run even if tests fail
    needs: [lint-and-format, test-python, test-rust, integration-test]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Set up Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build maturin

    - name: Build Rust extensions
      run: |
        cd mcli_rust
        maturin build --release

    - name: Build Python package
      run: |
        python -m build

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist-packages
        path: |
          dist/
          mcli_rust/target/wheels/
        retention-days: 7
