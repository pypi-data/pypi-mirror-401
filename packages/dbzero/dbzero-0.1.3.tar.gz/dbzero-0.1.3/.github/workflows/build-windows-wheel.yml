name: Build Windows Wheel

on:
  workflow_call:
    inputs:
      python-version:
        required: true
        type: string
      python-tag:
        required: true
        type: string
      architecture:
        required: true
        type: string
  workflow_dispatch:
    inputs:
      python-version:
        description: 'Python version to build'
        required: true
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
          - '3.13'
          - '3.14'
        default: '3.12'
      python-tag:
        description: 'Python tag (e.g., 310, 311, 312)'
        required: true
        type: choice
        options:
          - '39'
          - '310'
          - '311'
          - '312'
          - '313'
          - '314'
        default: '312'
      architecture:
        description: 'Build architecture'
        required: true
        type: choice
        options:
          - 'AMD64'
          - 'x86'
        default: 'AMD64'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python ${{ inputs.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}
      
      - uses: bus1/cabuild/action/msdevshell@v1
        with:
          architecture: x64
        if: inputs.architecture == 'AMD64'
      
      - uses: bus1/cabuild/action/msdevshell@v1
        with:
          architecture: x86
        if: inputs.architecture == 'x86'
      
      - name: Generate meson files
        run: |
          python scripts/generate_meson.py ./src/dbzero/ core
          python scripts/generate_meson_tests.py tests/
          python scripts/generate_meson_dbzero.py dbzero/
      
      - name: Configure git
        run: |
          git config --global user.email "ci@example.com"
          git config --global user.name "CI Builder"
          rm  .gitignore
          git add . && git commit -m "Update meson files for build"  
      
      - run: pip3 install pipx
      
      - run: pipx run cibuildwheel
        env:
          CIBW_BUILD: cp${{ inputs.python-tag }}-*
          CIBW_ARCHS_WINDOWS: ${{ inputs.architecture }}
      
      - uses: actions/upload-artifact@v4
        with:
          name: wheels-windows-${{ inputs.python-version }}
          path: wheelhouse/*.whl
