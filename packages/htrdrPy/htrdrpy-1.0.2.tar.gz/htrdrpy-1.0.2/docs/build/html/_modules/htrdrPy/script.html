

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>htrdrPy.script &mdash; htrdrPy 0.0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            htrdrPy
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../Examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../htrdrPy.html">htrdrPy documentation</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">htrdrPy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">htrdrPy.script</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for htrdrPy.script</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pickle</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">htrdrPy.helperFunctions</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">htrdrPy.data</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">htrdrPy.geometry</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="Script">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Script</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The ``htrdrPy.Script`` module aims at creating a callable (a function)</span>
<span class="sd">    taking as input a ``htrdrPy.Data`` object.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    The first step is to create an instance of ``htrdrPy.Script``:</span>

<span class="sd">    &gt;&gt;&gt; script = htrdrPy.script(case=&quot;caseName&quot;)</span>

<span class="sd">    The second step is to define the kind of script to be executed (see the</span>
<span class="sd">    documentation for all possibilities). If none of the predefined script suits</span>
<span class="sd">    your use, you can use the ``htrdrPy.Script.startMultipleObsGeometry``</span>
<span class="sd">    method.</span>

<span class="sd">    &gt;&gt;&gt; script.startMultipleObsGeometry(...)</span>
<span class="sd">    </span>
<span class="sd">    Finally, you can call the script on an already defined ``htrdrPy.Data``</span>
<span class="sd">    object:</span>

<span class="sd">    &gt;&gt;&gt; script(data)</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">threadFlag</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">MPIcmd</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">verbose</span> <span class="o">=</span> <span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        The Script module aims at creating a callable (a function) to be called on a Data object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        case : str, optional</span>
<span class="sd">            String to identify the script. This is mostly usefull in case</span>
<span class="sd">            different scripts are used on the same ``htrdrPy.Data`` instance.</span>
<span class="sd">            The output files being stored in the same folder (see</span>
<span class="sd">            ``htrdrPy.Data`` documentation), the case name is used to</span>
<span class="sd">            differentiate the output files of the different scripts.</span>
<span class="sd">        threadFlag : str, optional</span>
<span class="sd">            Thread option to use in the htrdr command. Should take the form &quot;-t</span>
<span class="sd">            &lt;num&gt;&quot; where &lt;num&gt; is the number of threads to be used. If left</span>
<span class="sd">            empty, the maximum number of threads (corresponding to the number of</span>
<span class="sd">            virtual cores on the computer) will be used.</span>
<span class="sd">        MPIcmd : str, optional</span>
<span class="sd">            MPI command to pass before the call to htrdr-planets, depending on</span>
<span class="sd">            the MPI runner on your system. For insatnce, it could be an &#39;mpirun&#39;</span>
<span class="sd">            command on many computers, or a &#39;srun&#39; command on a slurm-based</span>
<span class="sd">            supercalculator.</span>
<span class="sd">        verbose : bool, default True</span>
<span class="sd">            Whether or not activate the verbose of htrdr-planets.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFiles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="n">Script</span><span class="o">.</span><span class="n">_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">case</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">case</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">Geometry</span><span class="o">.</span><span class="n">_count</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span> <span class="o">=</span> <span class="n">threadFlag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span> <span class="o">=</span> <span class="n">MPIcmd</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;image&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>

        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;reflectanceSpectrum&quot;</span> <span class="ow">or</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;spectrum&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">case</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">(</span><span class="n">case</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">i</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;startMultipleObsGeometry&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">case</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;imageRatio&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;numerator&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;denominator&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;compositeRGB&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]},</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]},</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]},</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;twoStream&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">ndindex</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">longitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="c1"># i, j = 18, 16 # test at 22.5°N 0°E (near sub-solar point)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">if</span>      <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__twoStreamInColumnV1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">elif</span>    <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__twoStreamInColumnV2</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">elif</span>    <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">__twoStreamInColumnV3</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>   <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;This method is not defined&quot;</span><span class="p">)</span>
                <span class="c1"># break # to test on a single column for starting</span>

            <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">[</span><span class="s2">&quot;bands low&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span>
                <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">[</span><span class="s2">&quot;bands up&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cst</span><span class="o">.</span><span class="n">nano</span>
            <span class="p">}</span>

            <span class="n">threads</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">obs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="p">):</span>
                <span class="n">threads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__run</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">case</span><span class="p">)))</span>
            
            <span class="n">maxThread</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="k">while</span> <span class="n">active_count</span><span class="p">()</span> <span class="o">&gt;=</span> <span class="n">maxThread</span><span class="p">:</span> 
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">th</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span> <span class="n">th</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">==</span> <span class="s2">&quot;radiativeBudget&quot;</span><span class="p">:</span>
            <span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span><span class="p">,</span>
                <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">[</span><span class="s2">&quot;bands low&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="p">,</span>
                <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphere</span><span class="p">[</span><span class="s2">&quot;bands up&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">cst</span><span class="o">.</span><span class="n">nano</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__runRadBudget</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You have not provided the script procedure to be used&quot;</span><span class="p">)</span>

        <span class="n">fileName</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">outputPath</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.bin&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The script data is saved as: </span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                </span><span class="se">\n</span><span class="s2"> The object can be reconstructed in an independant script with: </span><span class="se">\</span>
<span class="s2">                </span><span class="se">\n</span><span class="s2"> script = htrdr.loadScript(&#39;</span><span class="si">{</span><span class="n">fileName</span><span class="si">}</span><span class="s2">&#39;)&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="s2">&quot;bw&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__testNoScript</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;A script is already defined, please start a new instance&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span>
              <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span>
              <span class="n">case</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start a htrdr run.</span>
<span class="sd">        # Input</span>
<span class="sd">        - wavelengths: dictionnary containing the spectral information with the following items:</span>
<span class="sd">            - &quot;type&quot;: type of calculation (&quot;cie_xyz&quot;, &quot;sw&quot;, &quot;lw&quot;)</span>
<span class="sd">            - &quot;low&quot;: (optional: not required for &quot;cie_xyz&quot;) lower bound of integration band in nm</span>
<span class="sd">            - &quot;up&quot;: (optional: not required for &quot;cie_xyz&quot;) upper bound of integration band in nm (if monochromatic calculation, &quot;up&quot; = &quot;low&quot;)</span>
<span class="sd">        - geometry: Geometry object containing the observation geometry data</span>
<span class="sd">        - threadFlag: thread option to use in the htrdr command. Should take the form &quot;-t &lt;num&gt;&quot; where &lt;num&gt; is the number of threads to be used. If left empty, the maximum number of threads (corresponding to the number of virtual cores on the computer) will be used.</span>
<span class="sd">        - MPIcmd: command (MPI) to pass before call to htrdr-planets</span>
<span class="sd">        - case (optional): string to rename the different output (usefull when multiple runs are started in the same directory)</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span> <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Define string variables</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gas</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:ck=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">gasOpticalProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gas</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:temp=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">gasTempearture</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">haze</span> <span class="o">=</span> <span class="s2">&quot;name=haze&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:radprop=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">particleOpticalProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:phasefn=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phaseFunctionList</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:phaseids=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phaseFunctionFile</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ground</span> <span class="o">=</span> <span class="s2">&quot;name=surface&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:prop=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundSurfaceProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:brdf=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundMaterialList</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1">##############</span>

        <span class="n">camera</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pos=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;position&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">camera</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:tgt=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;target&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">camera</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:up=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;roll&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;roll&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;roll&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">camera</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:fov=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">camera</span><span class="p">[</span><span class="s1">&#39;field of view&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1">##############</span>

        <span class="n">image</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;def=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;definition&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">x</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;definition&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2">:spp=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">image</span><span class="p">[</span><span class="s1">&#39;sampling&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">wavelengths</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;cie_xyz&quot;</span><span class="p">:</span>
            <span class="n">spectral</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spectral</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">octree</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;def=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeDef</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:nthreads=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nthOctree</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:tau=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">opthick</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeFile</span><span class="p">:</span>
            <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:storage=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeFile</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:proc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">procOctree</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">outputPath</span><span class="si">}</span><span class="s2">output_</span><span class="si">{</span><span class="n">case</span><span class="si">}</span><span class="s2">.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;-v&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">wavelengths</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span><span class="si">}</span><span class="s2"> htrdr-planets </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> -N </span><span class="se">\</span>
<span class="s2">                        -a </span><span class="si">{</span><span class="n">haze</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -G </span><span class="si">{</span><span class="n">ground</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -g </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -s </span><span class="si">{</span><span class="n">spectral</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -C </span><span class="si">{</span><span class="n">camera</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -i </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -b </span><span class="si">{</span><span class="n">octree</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -o </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;lon=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:lat=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:dst=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">kilo</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:radius=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">kilo</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;radiance&quot;</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:rad=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;radiance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:temp=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;error in source keys </span><span class="se">\</span>
<span class="s2">                                must be one of (&#39;radiance&#39;, &#39;temperature&#39;)&quot;</span><span class="p">)</span>
        
            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span><span class="si">}</span><span class="s2"> htrdr-planets </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> -N </span><span class="se">\</span>
<span class="s2">                        -a </span><span class="si">{</span><span class="n">haze</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -G </span><span class="si">{</span><span class="n">ground</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -g </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -S </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -s </span><span class="si">{</span><span class="n">spectral</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -C </span><span class="si">{</span><span class="n">camera</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -i </span><span class="si">{</span><span class="n">image</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -b </span><span class="si">{</span><span class="n">octree</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -o </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span><span class="si">}</span><span class="s2"> &quot;</span>

        <span class="c1"># print(command)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__runRadBudget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span>
                       <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span>
                       <span class="n">case</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start a htrdr run.</span>
<span class="sd">        # Input</span>
<span class="sd">        - wavelengths: dictionnary containing the spectral information with the following items:</span>
<span class="sd">            - &quot;type&quot;: type of calculation (&quot;sw&quot;, &quot;lw&quot;)</span>
<span class="sd">            - &quot;low&quot;: (optional: not required for &quot;cie_xyz&quot;) lower bound of integration band in nm</span>
<span class="sd">            - &quot;up&quot;: (optional: not required for &quot;cie_xyz&quot;) upper bound of integration band in nm (if monochromatic calculation, &quot;up&quot; = &quot;low&quot;)</span>
<span class="sd">        - geometry: Geometry object containing the observation geometry data</span>
<span class="sd">        - threadFlag: thread option to use in the htrdr command. Should take the form &quot;-t &lt;num&gt;&quot; where &lt;num&gt; is the number of threads to be used. If left empty, the maximum number of threads (corresponding to the number of virtual cores on the computer) will be used.</span>
<span class="sd">        - MPIcmd: command (MPI) to pass before call to htrdr-planets</span>
<span class="sd">        - case (optional): string to rename the different output (usefull when multiple runs are started in the same directory)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">case</span><span class="p">:</span> <span class="n">case</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">name</span>

        <span class="c1"># Define string variables</span>
        <span class="n">gas</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gas</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:ck=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">gasOpticalProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">gas</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:temp=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">gasTempearture</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">haze</span> <span class="o">=</span> <span class="s2">&quot;name=haze&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:radprop=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">particleOpticalProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:phasefn=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phaseFunctionList</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">haze</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:phaseids=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phaseFunctionFile</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="n">ground</span> <span class="o">=</span> <span class="s2">&quot;name=surface&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:prop=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundSurfaceProperties</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ground</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:brdf=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">groundMaterialList</span><span class="si">}</span><span class="s2">&quot;</span>
        
        <span class="c1">##############</span>
        <span class="n">volrad_budget_opt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;spt=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">volrad</span><span class="p">[</span><span class="s1">&#39;sampling&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">geometry</span><span class="o">.</span><span class="n">volrad</span><span class="p">[</span><span class="s2">&quot;mesh&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;origin&quot;</span><span class="p">:</span> 
            <span class="n">volrad_budget_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereGeometry</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">volrad_budget_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:mesh=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">volrad</span><span class="p">[</span><span class="s1">&#39;mesh&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;PDF&quot;</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">volrad</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span> 
            <span class="n">volrad_budget_opt</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:pdf=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">volrad</span><span class="p">[</span><span class="s1">&#39;PDF&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        
        <span class="n">spectral</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;low&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="si">}</span><span class="s2">,</span><span class="si">{</span><span class="n">wavelengths</span><span class="p">[</span><span class="s1">&#39;up&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">nano</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">octree</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;def=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeDef</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:nthreads=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">nthOctree</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:tau=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">opthick</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeFile</span><span class="p">:</span> 
            <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:storage=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">octreeFile</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">octree</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:proc=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">procOctree</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">output</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">outputPath</span><span class="si">}</span><span class="s2">output_</span><span class="si">{</span><span class="n">case</span><span class="si">}</span><span class="s2">.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFiles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span> <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;-v&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="n">verb</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="k">if</span> <span class="n">wavelengths</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;lw&quot;</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span><span class="si">}</span><span class="s2"> htrdr-planets </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> -N </span><span class="se">\</span>
<span class="s2">                        -a </span><span class="si">{</span><span class="n">haze</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -G </span><span class="si">{</span><span class="n">ground</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -g </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -s </span><span class="si">{</span><span class="n">spectral</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -r </span><span class="si">{</span><span class="n">volrad_budget_opt</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -b </span><span class="si">{</span><span class="n">octree</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        -o </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;lon=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:lat=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:dst=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">kilo</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:radius=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cst</span><span class="o">.</span><span class="n">kilo</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="s2">&quot;radiance&quot;</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:rad=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;radiance&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">elif</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">source</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;:temp=</span><span class="si">{</span><span class="n">geometry</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;error in source keys </span><span class="se">\</span>
<span class="s2">                                must be one of (&#39;radiance&#39;, &#39;temperature&#39;)&quot;</span><span class="p">)</span>
        
            <span class="n">command</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span><span class="si">}</span><span class="s2"> htrdr-planets </span><span class="si">{</span><span class="n">verb</span><span class="si">}</span><span class="s2"> -N </span><span class="se">\</span>
<span class="s2">                    -a </span><span class="si">{</span><span class="n">haze</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -G </span><span class="si">{</span><span class="n">ground</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -g </span><span class="si">{</span><span class="n">gas</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -S </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -s </span><span class="si">{</span><span class="n">spectral</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -r </span><span class="si">{</span><span class="n">volrad_budget_opt</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -b </span><span class="si">{</span><span class="n">octree</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    -o </span><span class="si">{</span><span class="n">output</span><span class="si">}</span><span class="s2"> </span><span class="se">\</span>
<span class="s2">                    </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span><span class="si">}</span><span class="s2"> &quot;</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span>

<div class="viewcode-block" id="Script.visibleImage">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.visibleImage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">visibleImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate a visible (RGB) image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s1">&#39;cie_xyz&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.monochromaticImage">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.monochromaticImage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">monochromaticImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelength</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate a monochromatic image.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelength : float</span>
<span class="sd">            Wavelength to use for the calculation [m].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">wavelength</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">wavelength</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.bandIntegratedImage">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.bandIntegratedImage">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">bandIntegratedImage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelengthLow</span><span class="p">,</span>
                            <span class="n">wavelengthUp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate an image integrated over a given spectral</span>
<span class="sd">        range.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelengthLow : float</span>
<span class="sd">            Lower boundary wavelength [m].</span>
<span class="sd">        wavelengthUp : float</span>
<span class="sd">            Upper boundary wavelength [m].</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;image&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span> <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">wavelengthUp</span><span class="p">,</span> <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">wavelengthLow</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.spectrum">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.spectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">bandWidths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start mutliple runs of htrdr-planets to calculate a spectrum, producing</span>
<span class="sd">        an output for each wavelength.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelength : float</span>
<span class="sd">            Wavelength to use for the calculation [m].</span>
<span class="sd">        bandWidths : ``numpy.ndarray`` </span>
<span class="sd">            Integration band around each wavelength. If not provided, the</span>
<span class="sd">            calculation is monochromatic (shape=(nWavelength), [m]).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;spectrum&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bandWidths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandWidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bandWidths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wvl</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">bandWidths</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">wvl</span> <span class="o">-</span> <span class="n">band</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># m</span>
                    <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">wvl</span> <span class="o">+</span> <span class="n">band</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># m </span>
                <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wvl</span> <span class="ow">in</span> <span class="n">wavelengths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">wvl</span><span class="p">,</span>     <span class="c1"># m</span>
                    <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">wvl</span>       <span class="c1"># m </span>
                <span class="p">})</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.reflectanceSpectrum">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.reflectanceSpectrum">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reflectanceSpectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelengths</span><span class="p">,</span> <span class="n">bandWidths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start mutliple runs of htrdr-planets to calculate a reflectance</span>
<span class="sd">        spectrum, producing an output for each wavelength.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelength : float</span>
<span class="sd">            Wavelength to use for the calculation [m].</span>
<span class="sd">        bandWidths : ``numpy.ndarray`` </span>
<span class="sd">            Integration band around each wavelength. If not provided, the</span>
<span class="sd">            calculation is monochromatic (shape=(nWavelength), [m]).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;reflectanceSpectrum&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cases</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">bandWidths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bandWidths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bandWidths</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">wvl</span><span class="p">,</span><span class="n">band</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">wavelengths</span><span class="p">,</span><span class="n">bandWidths</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">wvl</span> <span class="o">-</span> <span class="n">band</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span>  <span class="c1"># m</span>
                    <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">wvl</span> <span class="o">+</span> <span class="n">band</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>    <span class="c1"># m </span>
                <span class="p">})</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">wvl</span> <span class="ow">in</span> <span class="n">wavelengths</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cases</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">kind</span><span class="p">,</span>
                    <span class="s2">&quot;low&quot;</span><span class="p">:</span> <span class="n">wvl</span><span class="p">,</span>     <span class="c1"># m</span>
                    <span class="s2">&quot;up&quot;</span><span class="p">:</span> <span class="n">wvl</span>       <span class="c1"># m </span>
                <span class="p">})</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.imageRatio">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.imageRatio">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">imageRatio</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelengthNum</span><span class="p">,</span> <span class="n">wavelengthDen</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate the ratio of 2 monochromatic images.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelengthNum : float</span>
<span class="sd">            Wavelength for numerator image [m].</span>
<span class="sd">        wavelengthDen : float</span>
<span class="sd">            Wavelength for denominator image [m].</span>
<span class="sd">        &#39;&#39;&#39;</span> 
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;imageRatio&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavelengthNum</span><span class="p">,</span> <span class="n">wavelengthDen</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.compositeRBG">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.compositeRBG">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compositeRBG</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">wavelengthRed</span><span class="p">,</span>
                      <span class="n">wavelengthGreen</span><span class="p">,</span> <span class="n">wavelengthBlue</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate the composite image from 3 monochromatic</span>
<span class="sd">        images.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        wavelengthRed : float</span>
<span class="sd">            Wavelength for red chanel image [m].</span>
<span class="sd">        wavelengthGreen : float</span>
<span class="sd">            Wavelength for green chanel image [m].</span>
<span class="sd">        wavelengthBlue : float</span>
<span class="sd">            Wavelength for red chanel image [m].</span>

<span class="sd">        Warning</span>
<span class="sd">        -------</span>
<span class="sd">        This script has not bee tested yet and may not work correctly. This</span>
<span class="sd">        should be treated in future versions.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;This mode has not been tested yet and may crash&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;compositeRGB&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">wavelengthRed</span><span class="p">,</span> <span class="n">wavelengthGreen</span><span class="p">,</span> <span class="n">wavelengthBlue</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.startMultipleObsGeometry">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.startMultipleObsGeometry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">startMultipleObsGeometry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">obsList</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Geometry</span><span class="p">],</span> <span class="n">wavelength</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Start multiple runs with different observation geometries but the same planet inputs</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        obsList : array-like</span>
<span class="sd">            List of ``htrdrPy.Geometry`` instances.</span>
<span class="sd">        wavelength : dict</span>
<span class="sd">            Dictionnary containing the spectral information with the following</span>
<span class="sd">            items:</span>

<span class="sd">            - &quot;type&quot; : {&quot;cie_xyz&quot;, &quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">                Type of calculation.</span>
<span class="sd">            - &quot;low&quot; : float</span>
<span class="sd">                Lower bound of integration band [m].</span>
<span class="sd">            - &quot;up&quot; : float</span>
<span class="sd">                Upper bound of integration band [m] (if monochromatic</span>
<span class="sd">                calculation, &quot;up&quot; = &quot;low&quot;).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;startMultipleObsGeometry&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span> <span class="o">=</span> <span class="n">obsList</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wavelengths</span> <span class="o">=</span> <span class="n">wavelength</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Script.startRadBudgetGCM">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.Script.startRadBudgetGCM">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">startRadBudgetGCM</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">geometry</span><span class="p">:</span> <span class="n">Geometry</span><span class="p">,</span> <span class="n">kind</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Set up the script to calculate athe radiative budget of each GCM cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        geometry : ``htrdrPy.Geometry``</span>
<span class="sd">            A ``htrdrPy.Geometry`` object previously created and set up.</span>
<span class="sd">        kind : {&quot;sw&quot;, &quot;lw&quot;}</span>
<span class="sd">            Type of calculation. &quot;sw&quot; for a calculation with an external source,</span>
<span class="sd">            and &quot;lw&quot; to use the atmosphere emission as source.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;radiativeBudget&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">geometry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="k">return</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__startThermalTwoStream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">kind</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nAngle</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">sampling</span><span class="o">=</span><span class="mf">1e4</span><span class="p">,</span>
                                        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;Under developement ...&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__testNoScript</span><span class="p">():</span> <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predefinedScript</span> <span class="o">=</span> <span class="s2">&quot;twoStream&quot;</span>
        <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="mf">179.99</span>
        <span class="k">elif</span> <span class="n">method</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Method 1 is deprecated, use method 2 or 3&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">=</span> <span class="n">angle</span> <span class="c1">#np.arccos(3**(-0.5)) / cst.degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threadFlag</span> <span class="o">=</span> <span class="s2">&quot;-t 1&quot;</span> <span class="c1">#threadFlag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MPIcmd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="c1">#MPIcmd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kind</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nAngle</span> <span class="o">=</span> <span class="n">nAngle</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling</span> <span class="o">=</span> <span class="n">sampling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__twoStreamInColumnV1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">column</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nPlans</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPlans</span><span class="p">)</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">column</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">topoMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># +1 serves to make sure the camera is not bellow the surface...</span>
        <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># plans[-1] + (plans[-1]-plans[-2])</span>

        <span class="c1"># print(plans)</span>
        <span class="c1"># dlat = np.pi / len(self.data.latitudes)</span>
        <span class="c1"># dlon = 2*np.pi / len(self.data.longitudes)</span>
        <span class="c1"># &#39;&#39;&#39; </span>
        <span class="c1"># surfaces considering trapezes with:</span>
        <span class="c1">#   a   </span>
        <span class="c1">#  ___</span>
        <span class="c1"># /   \  | b</span>
        <span class="c1"># -----</span>
        <span class="c1">#   c</span>
        <span class="c1"># b is along the latitudes: b = z * dlat</span>
        <span class="c1"># a and c are along longitudes, i.e. on circles of radii z * cos( lat +\- dlat/2 )</span>
        <span class="c1"># so: </span>
        <span class="c1">#   a = z * dlon * cos( lat + dlat/2 )</span>
        <span class="c1">#   c = z * dlon * cos( lat - dlat/2 )</span>
        <span class="c1"># The surface is given by the mean of the inner and outer rectangle ((a * b) + (c * b))/2</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># areasInner = (plans**2) * dlat * dlon * np.cos(latitude + dlat/2)</span>
        <span class="c1"># areasOuter = (plans**2) * dlat * dlon * np.cos(latitude - dlat/2)</span>
        <span class="c1"># areas = 0.5 * ( areasInner + areasOuter )</span>

        <span class="n">image</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;sampling&quot;</span><span class="p">:</span><span class="mi">1000</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">plan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">plan</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>
            <span class="n">targetUp</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>
            <span class="n">geomTop1</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_top1&quot;</span><span class="p">)</span>
            <span class="n">geomTop1</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">targetUp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">geomTop2</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_top2&quot;</span><span class="p">)</span>
            <span class="n">geomTop2</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">targetUp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">)</span>
            <span class="n">geomDown1</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_down1&quot;</span><span class="p">)</span>
            <span class="n">geomDown1</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">geomDown2</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_down2&quot;</span><span class="p">)</span>
            <span class="n">geomDown2</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="o">*</span> <span class="mf">0.99</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomTop1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomDown1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomTop2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomDown2</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__twoStreamInColumnV2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">column</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nPlans</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPlans</span><span class="p">)</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">column</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">topoMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">radius</span> <span class="o">+</span> <span class="mf">1e-3</span> <span class="c1"># +1e-3 serves to make sure the camera is not bellow the surface...</span>
        <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># plans[-1] + (plans[-1]-plans[-2])</span>


        <span class="c1"># rotation matrix</span>
        <span class="c1"># defining the unitary vectors of the camera referential</span>
        <span class="n">ez</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>        <span class="c1"># ez is normal to the surface</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">latitude</span><span class="p">)</span><span class="o">-</span><span class="mi">90</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">:</span>    <span class="c1"># if we are at either pole,</span>
            <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>   <span class="c1"># ey is parallel to y in Titan referential</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">])</span>   <span class="c1"># ex is parallel to x in Titan referential</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ey</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">]),</span><span class="n">ez</span><span class="p">)</span> <span class="c1"># ey is perpendicular to the plan formed by the camera and the Titan z axis</span>
            <span class="n">ex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">ey</span><span class="p">,</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">ex</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
        <span class="n">ey</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ey</span><span class="p">)</span>
        <span class="n">ez</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">ez</span><span class="p">)</span>
        <span class="n">M</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ex</span><span class="p">,</span> <span class="n">ey</span><span class="p">,</span> <span class="n">ez</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span> <span class="c1"># degree</span>
        <span class="n">phis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">360</span><span class="p">,</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nAngle</span><span class="p">))</span>

        <span class="n">image</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;sampling&quot;</span><span class="p">:</span><span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sampling</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">plan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">plan</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>
            <span class="n">zenith</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;distance&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">]]))</span>
            <span class="n">geomDirect</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_zenith&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">FOVzenith</span> <span class="o">=</span> <span class="mf">0.2</span>
            <span class="n">geomDirect</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">zenith</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">FOVzenith</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomDirect</span><span class="p">)</span>
            <span class="c1"># print(f&quot;{k}_{i}_{j}&quot;)</span>
            <span class="k">for</span> <span class="n">l</span><span class="p">,</span><span class="n">phi</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">phis</span><span class="p">):</span>
                <span class="n">los</span> <span class="o">=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">]))</span>
                <span class="c1"># print( f&quot;top{l}: &quot;,  np.arccos( np.dot( los, position ) / ( np.linalg.norm(los)*np.linalg.norm(position) ) )/cst.degree   )</span>
                <span class="n">targetUp</span> <span class="o">=</span> <span class="n">los</span> <span class="o">+</span> <span class="n">position</span>
                <span class="n">geomTop</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_top</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">geomTop</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">targetUp</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

                <span class="n">los</span> <span class="o">=</span> <span class="n">M</span> <span class="o">@</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="n">theta</span><span class="p">,</span> <span class="n">phi</span><span class="p">]))</span>
                <span class="n">targetDown</span> <span class="o">=</span> <span class="n">los</span> <span class="o">+</span> <span class="n">position</span>
                <span class="c1"># print( f&quot;down{l}: &quot;,  180 - np.arccos( np.dot( los, position ) / ( np.linalg.norm(los)*np.linalg.norm(position) ) )/cst.degree   )</span>
                <span class="n">geomDown</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_down</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">geomDown</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">targetDown</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomTop</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomDown</span><span class="p">)</span>
        <span class="c1"># raise</span>
        <span class="k">return</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__twoStreamInColumnV3</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>
        <span class="n">column</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">latitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">longitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">atmosphereCellCoord</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">nPlans</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nPlans</span><span class="p">)</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">column</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+</span> <span class="n">column</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="n">plans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">topoMap</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">latitudes</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">radius</span> <span class="o">+</span> <span class="mi">1</span>  <span class="c1"># +1 serves to make sure the camera is not bellow the surface...</span>
        <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="c1"># plans[-1] + (plans[-1]-plans[-2])</span>

        <span class="n">image</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;definition&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;sampling&quot;</span><span class="p">:</span><span class="mi">100000</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">plan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plans</span><span class="p">):</span>
            <span class="n">position</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">plan</span><span class="p">,</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>
            <span class="n">targetUp</span> <span class="o">=</span> <span class="n">sphere2cart</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">plans</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">latitude</span><span class="p">,</span> <span class="n">longitude</span><span class="p">]))</span>
            <span class="n">geomTop</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_top&quot;</span><span class="p">)</span>
            <span class="n">geomTop</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">targetUp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
            <span class="n">geomDown</span> <span class="o">=</span> <span class="n">Geometry</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">case</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2">_down&quot;</span><span class="p">)</span>
            <span class="n">geomDown</span><span class="o">.</span><span class="n">setCamera</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]),</span> <span class="bp">self</span><span class="o">.</span><span class="n">angle</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomTop</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">obsList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">geomDown</span><span class="p">)</span>

        <span class="k">return</span></div>



<div class="viewcode-block" id="loadScript">
<a class="viewcode-back" href="../../htrdrPy.script.html#htrdrPy.script.loadScript">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">loadScript</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Load a ``htrdrPy.Script`` object from the binary file where it is saved</span>
<span class="sd">    (generated after the call on a ``htrdrPy.Data`` object).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : str</span>
<span class="sd">        Path to the binary file to be loaded.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;br&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
        <span class="n">script</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">outputFiles</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">script</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">workingDirectory</span><span class="p">):</span>
            <span class="n">script</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">workingDirectory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
            <span class="n">script</span><span class="o">.</span><span class="n">outputFiles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="s1">&#39;/&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="w"> </span><span class="n">file</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="w"> </span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">script</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2026, Anthony Arfaux.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>