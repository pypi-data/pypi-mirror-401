"use strict";(self.webpackChunk_mlflow_mlflow=self.webpackChunk_mlflow_mlflow||[]).push([[5615],{24432:function(e,t,n){n.d(t,{p:function(){return E}});var a=n(68248),s=n(27757),r=n(79081),o=n(66916),i=n(82716),l=n(90061),c=n(43617),d=n(76256),u=n(40724),f=n(52849),m=n(72607),p=n(46709),g=n(54313),v=n(76118),h=n(4168);var _=n(61077),x=n(61060);var y=n(32874),w=n(49708),I=n(69986),b=n(34599);var T=n(73408);const S=[{id:"name",accessorKey:"name",header:"Name"}];var C={name:"tardml",styles:"height:500px;overflow:hidden"},k={name:"82a6rk",styles:"flex:1"};const E=({experimentId:e,visible:t,setVisible:n,selectedTraceInfos:E})=>{const{theme:R}=(0,s.u)(),[A,M]=(0,p.useState)(""),[F,D]=(0,p.useState)(A),N=E.map(e=>(0,g.MF)({info:e,data:{spans:[]}})),{data:P,isLoading:Y}=(({traceIds:e})=>(0,w.I)({queryKey:[b.lA,e],queryFn:async({queryKey:[,e]})=>{const t=(0,v.chunk)(e,20),n=[];for(const a of t){const e=await Promise.all(a.map(e=>(0,I.Uv)(e)));n.push(...e)}return n}}))({traceIds:N}),z=(e=>{const t=e.map(e=>{const t=e.data.spans.find(e=>!(0,g.cp)(e));if((0,v.isNil)(t))return null;const n={};if((0,g.gD)(e.info))for(const r of null!==(a=e.info.assessments)&&void 0!==a?a:[]){var a;if("expectation"in r)if("serialized_value"in r.expectation){const e=r.expectation.serialized_value.value;try{n[r.assessment_name]=JSON.parse(e)}catch(s){n[r.assessment_name]=e}}else n[r.assessment_name]=r.expectation.value}return{inputs:(0,g.UZ)(t)||(0,g.$f)(t)?(0,g.xD)((0,h.zl)(t.attributes,"mlflow.spanInputs")):t.inputs,expectations:n,source:{source_type:"TRACE",source_data:{trace_id:(0,g.MF)(e)}}}});return(0,v.compact)(t)})((0,v.compact)(P)),{data:H,isLoading:q,isFetching:O,fetchNextPage:L,hasNextPage:K}=(0,m.J)({experimentId:e,nameFilter:A}),J=q||Y,W=(0,f.v)({isFetching:O,hasNextPage:null!==K&&void 0!==K&&K,fetchNextPage:L}),V=(0,d.L)("mlflow/server/js/src/experiment-tracking/pages/experiment-evaluation-datasets/components/ExportTracesToDatasetModal.tsx",{columns:S,getRowId:e=>e.dataset_id,data:null!==H&&void 0!==H?H:[],getCoreRowModel:(0,l.HT)(),enableColumnResizing:!1}),B=V.getSelectedRowModel().rows.map(e=>e.original),{upsertDatasetRecordsMutation:U,isLoading:j}=(({onSuccess:e,onError:t})=>{const{mutate:n,isLoading:a}=(0,x.n)({mutationFn:async({datasetId:e,records:t})=>{const n={dataset_id:e,records:t};return await(0,_.ff)((0,_.we)(`ajax-api/3.0/mlflow/datasets/${e}/records`),"POST",n)},onSuccess:()=>{null===e||void 0===e||e()},onError:e=>{null===t||void 0===t||t(e)}});return{upsertDatasetRecordsMutation:n,isLoading:a}})({onSuccess:()=>{n(!1)}}),Z=(0,p.useCallback)(()=>{Promise.all(B.map(e=>U({datasetId:e.dataset_id,records:JSON.stringify(z)})))},[B,U,z]);return(0,T.Y)(r.d,{componentId:"mlflow.export-traces-to-dataset-modal",visible:t,onCancel:()=>n(!1),okText:(0,T.Y)(u.A,{id:"a1liZ7",defaultMessage:"Export"}),okButtonProps:{disabled:Y||0===B.length,loading:j},onOk:Z,title:(0,T.Y)(u.A,{id:"ZBRK9J",defaultMessage:"Export traces to datasets"}),zIndex:R.options.zIndexBase+10,children:(0,T.FD)("div",{css:C,children:[(0,T.FD)("div",{css:(0,a.AH)({display:"flex",gap:R.spacing.sm,alignItems:"center",marginBottom:R.spacing.sm},""),children:[(0,T.Y)(o.I,{allowClear:!0,placeholder:"Search by dataset name",value:F,onChange:e=>{D(e.target.value),e.target.value||M(e.target.value)},onClear:()=>{D(""),M("")},onPressEnter:()=>M(F),componentId:"mlflow.eval-datasets.search-input",css:k,prefix:(0,T.Y)(o.S,{})}),(0,T.Y)(y.Z,{experimentId:e})]}),(0,T.FD)(i.Table,{scrollable:!0,onScroll:e=>W(e.currentTarget),someRowsSelected:V.getIsSomeRowsSelected()||V.getIsAllRowsSelected(),empty:!q&&!O&&0===H.length&&(0,T.Y)(i.Empty,{description:(0,T.Y)(u.A,{id:"F4K195",defaultMessage:"No evaluation datasets found"})}),children:[(0,T.FD)(i.TableRow,{isHeader:!0,children:[(0,T.Y)(i.TableRowSelectCell,{componentId:"mlflow.export-traces-to-dataset-modal.header-checkbox",checked:V.getIsAllRowsSelected(),indeterminate:V.getIsSomeRowsSelected(),onChange:V.getToggleAllRowsSelectedHandler()}),V.getLeafHeaders().map(e=>(0,T.Y)(i.TableHeader,{componentId:"mlflow.eval-datasets.column-header",header:e,column:e.column,css:(0,a.AH)({width:e.column.columnDef.size,maxWidth:e.column.columnDef.maxSize},""),children:(0,c.Kv)(e.column.columnDef.header,e.getContext())},e.id))]}),!J&&V.getRowModel().rows.map(e=>(0,T.FD)(i.TableRow,{children:[(0,T.Y)("div",{children:(0,T.Y)(i.TableRowSelectCell,{componentId:"mlflow.export-traces-to-dataset-modal.row-checkbox",checked:e.getIsSelected(),onChange:e.getToggleSelectedHandler()})}),e.getVisibleCells().map(e=>(0,T.Y)(i.TableCell,{css:(0,a.AH)({width:e.column.columnDef.size,maxWidth:e.column.columnDef.maxSize},""),children:(0,c.Kv)(e.column.columnDef.cell,e.getContext())},e.id))]},e.id)),(J||O)&&(0,T.Y)(i.TableSkeletonRows,{table:V})]})]})})}},27462:function(e,t,n){n.d(t,{F:function(){return r}});var a=n(46709),s=n(40720);const r=({traceSearchLocations:e,reviewAppId:t,labelingSessionId:n,traceIdToItemIdMap:r})=>{const o=(0,s.C)();return(0,a.useMemo)(()=>({deleteTraces:async(e,t)=>o.mutateAsync({experimentId:e,traceRequestIds:t})}),[o])}},32874:function(e,t,n){n.d(t,{Z:function(){return h}});var a=n(27757),s=n(82716),r=n(46709),o=n(40724),i=n(79081),l=n(66916),c=n(42747),d=n(61077),u=n(39595),f=n(61060),m=n(34599);var p=n(73408);const g=({visible:e,experimentId:t,onCancel:n})=>{const{theme:o}=(0,a.u)(),g=(0,c.tz)(),[v,h]=(0,r.useState)(""),[_,x]=(0,r.useState)(""),{createEvaluationDatasetMutation:y,isLoading:w}=(({onSuccess:e,onError:t})=>{const n=(0,u.jE)(),{mutate:a,isLoading:s}=(0,f.n)({mutationFn:async({datasetName:e,experimentIds:t})=>{const n={name:e,experiment_ids:t};return(await(0,d.ff)((0,d.we)("ajax-api/3.0/mlflow/datasets/create"),"POST",n)).dataset},onSuccess:()=>{n.invalidateQueries({queryKey:[m.P4]}),null===e||void 0===e||e()},onError:e=>{null===t||void 0===t||t(e)}});return{createEvaluationDatasetMutation:a,isLoading:s}})({onSuccess:()=>{n()}}),I=(0,r.useCallback)(()=>{v?y({datasetName:v,experimentIds:[t]}):x(g.formatMessage({id:"sbHChH",defaultMessage:"Dataset name is required"}))},[y,t,v,g]);return(0,p.FD)(i.d,{componentId:"mlflow.create-evaluation-dataset-modal",visible:e,onCancel:n,okText:g.formatMessage({id:"creoEe",defaultMessage:"Create"}),cancelText:g.formatMessage({id:"nEnDEu",defaultMessage:"Cancel"}),onOk:I,okButtonProps:{loading:w,disabled:!v},title:(0,p.Y)(c.sA,{id:"287Ack",defaultMessage:"Create evaluation dataset"}),zIndex:o.options.zIndexBase+20,children:[(0,p.Y)(s.FormUI.Label,{htmlFor:"dataset-name-input",children:(0,p.Y)(c.sA,{id:"xdFMIN",defaultMessage:"Dataset name"})}),(0,p.Y)(l.I,{componentId:"mlflow.create-evaluation-dataset-modal.dataset-name",id:"dataset-name-input",name:"name",type:"text",placeholder:g.formatMessage({id:"ZQpc2w",defaultMessage:"Enter dataset name"}),value:v,onChange:e=>{h(e.target.value),x("")}}),_&&(0,p.Y)(s.FormUI.Message,{type:"error",message:_})]})};var v={name:"b9l38d",styles:"width:min-content"};const h=({experimentId:e})=>{const[t,n]=(0,r.useState)(!1);return(0,p.FD)(p.FK,{children:[(0,p.Y)(a.B,{componentId:"mlflow.eval-datasets.create-dataset-button",css:v,icon:(0,p.Y)(s.DatabaseIcon,{}),onClick:()=>n(!0),children:(0,p.Y)(o.A,{id:"N7BCue",defaultMessage:"Create dataset"})}),(0,p.Y)(g,{experimentId:e,visible:t,onCancel:()=>n(!1)})]})}},33656:function(e,t,n){n.d(t,{N9:function(){return f},NW:function(){return d},OT:function(){return l},Yc:function(){return u}});var a=n(46709),s=n(22141),r=n.n(s),o=n(76251);let i=null;const l=()=>i||(i=new o.Converter,i.setFlavor("github"),i),c={allowedTags:["h1","h2","h3","h4","h5","h6","h7","h8","blockquote","p","a","ul","ol","nl","li","ins","b","i","strong","em","strike","code","hr","br","div","table","thead","tbody","tr","th","td","pre","del","sup","sub","dl","dt","dd","kbd","q","samp","samp","var","hr","rt","rp","summary","iframe","img","caption","figure"],allowedAttributes:{a:["href","name","target"],img:["src","longdesc"],div:["itemscope","itemtype"]}},d=e=>r()(e,c),u=e=>e.replace(new RegExp("<a","g"),'<a target="_blank"'),f=()=>(0,a.useCallback)(e=>{const t=l().makeHtml(e);return d(t)},[])},34599:function(e,t,n){n.d(t,{P4:function(){return s},lA:function(){return r},uz:function(){return a}});const a="GET_DATASET_RECORDS",s="SEARCH_EVALUATION_DATASETS",r="FETCH_TRACES"},40720:function(e,t,n){n.d(t,{C:function(){return i}});var a=n(39595),s=n(61060),r=n(12803),o=n(4168);const i=()=>{const e=(0,a.jE)();return(0,s.n)({mutationFn:async({experimentId:e,traceRequestIds:t})=>{const n=[];for(let s=0;s<t.length;s+=100)n.push(t.slice(s,s+100));const a=n.map(t=>r.x.deleteTracesV3(e,t));return{traces_deleted:(await Promise.all(a)).reduce((e,t)=>e+t.traces_deleted,0)}},onSuccess:()=>(0,o.BL)({queryClient:e})})}},52849:function(e,t,n){n.d(t,{v:function(){return s}});var a=n(46709);const s=({isFetching:e,hasNextPage:t,fetchNextPage:n})=>(0,a.useCallback)(a=>{if(a){const{scrollHeight:s,scrollTop:r,clientHeight:o}=a;s-r-o<200&&!e&&t&&n()}},[n,e,t])},69986:function(e,t,n){n.d(t,{RT:function(){return p},Rb:function(){return c},Uv:function(){return l},a_:function(){return g},fz:function(){return v},lc:function(){return _}});var a=n(12803),s=n(54313),r=n(71540),o=n(13433),i=n(4168);async function l(e,t){if(e){if((0,r.ZZ)(t)===r.Cf){const t=await(0,o.UA)({traceId:e});if(null!==t&&void 0!==t&&t.trace&&t.trace.data)return{info:t.trace.trace_info||{},data:t.trace.data}}return(0,s.ho)(e)?s._A.getTraceV4(e):e.startsWith("tr-")?s.TJ.getTraceV3(e):c(e)}}async function c(e){if(!e)return;const[t,n]=await Promise.all([a.x.getExperimentTraceInfo(e).then(e=>e.trace_info||{}),a.x.getExperimentTraceData(e)]);return n?{info:t,data:n}:void 0}function d(e){if("trace_id"in e&&"span_id"in e){return!e.parent_span_id}const t=e;return!t.parent_span_id&&!t.parent_id}function u(e){var t;return((null===(t=e.data)||void 0===t?void 0:t.spans)||[]).find(d)||null}function f(e){return"string"===typeof e?e:JSON.stringify(e)}function m(e,t,n){if(t in e){const n=e[t];if(void 0!==n)return f(n)}return void 0!==(0,i.zl)(e.attributes,n)?f((0,i.zl)(e.attributes,n)):null}function p(e){const t=u(e);return t?m(t,"inputs","mlflow.spanInputs"):null}function g(e){const t=u(e);return t?m(t,"outputs","mlflow.spanOutputs"):null}function v(e){const t={},n=e.info;return n.assessments&&Array.isArray(n.assessments)?(n.assessments.forEach(e=>{var n;if(!function(e){return"expectation"in e}(e))return;if(!1===e.valid)return;if("HUMAN"!==(null===(n=e.source)||void 0===n?void 0:n.source_type))return;const a=function(e){if("value"in e)return e.value;if("serialized_value"in e&&e.serialized_value)try{return JSON.parse(e.serialized_value.value)}catch{return e.serialized_value.value}return null}(e.expectation);void 0!==a&&null!==a&&(t[e.assessment_name]=a)}),t):t}function h(e){if("trace_id"in e&&"span_id"in e){var t;let n=null===(t=e.attributes)||void 0===t?void 0:t["mlflow.spanType"];if("string"===typeof n&&n.startsWith('"')&&n.endsWith('"'))try{n=JSON.parse(n)}catch{}return"RETRIEVER"===n}let n=e.span_type;if("string"===typeof n&&n.startsWith('"')&&n.endsWith('"'))try{n=JSON.parse(n)}catch{}return"RETRIEVER"===n}function _(e){const t=function(e){var t;const n=(null===(t=e.data)||void 0===t?void 0:t.spans)||[];if(0===n.length)return[];const a=n.filter(h);if(0===a.length)return[];const s=new Set;for(const o of a){const e="span_id"in o?o.span_id:o.context.span_id;e&&s.add(e)}const r=[];for(const o of a){let e,t=!0;if("trace_id"in o&&"span_id"in o)e=o.parent_span_id;else{const t=o;e=t.parent_span_id||t.parent_id}for(;e;){if(s.has(e)){t=!1;break}let a;for(const t of n)if(("span_id"in t?t.span_id:t.context.span_id)===e){a=t;break}if(!a)break;if("trace_id"in a&&"span_id"in a)e=a.parent_span_id;else{const t=a;e=t.parent_span_id||t.parent_id}}t&&r.push(o)}return r}(e);if(0===t.length)return null;const n=[];for(const r of t){let e=[],t="",o="";if("trace_id"in r&&"span_id"in r){var a;const n=r;t=n.span_id||"",o=n.name||t;let s=null===(a=n.attributes)||void 0===a?void 0:a["mlflow.spanOutputs"];if("string"===typeof s)try{s=JSON.parse(s)}catch{continue}s&&"object"===typeof s&&Array.isArray(s)&&(e=s.map(e=>{var t;return{doc_uri:e.doc_uri||e.uri||(null===(t=e.metadata)||void 0===t?void 0:t.doc_uri)||"",content:e.content||e.page_content||""}}))}else{var s;const n=r;t=(null===(s=n.context)||void 0===s?void 0:s.span_id)||"",o=n.name||t,n.outputs&&Array.isArray(n.outputs)&&(e=n.outputs.map(e=>({doc_uri:e.doc_uri||e.uri||"",content:e.content||e.page_content||""})))}e.length>0&&n.push({span_id:t,span_name:o,documents:e})}return 0===n.length?null:{retrieved_documents:n}}},72607:function(e,t,n){n.d(t,{J:function(){return i}});var a=n(96584),s=n(61077),r=n(46709),o=n(34599);const i=({experimentId:e,enabled:t=!0,nameFilter:n=""})=>{const{data:i,fetchNextPage:l,hasNextPage:c,isLoading:d,isFetching:u,refetch:f,error:m}=(0,a.q)({queryKey:[o.P4,e,n],queryFn:async({queryKey:[,e,t],pageParam:n})=>{const a={experiment_ids:[e],filter_string:t?`name ILIKE '%${t}%'`:void 0,order_by:["created_time DESC"],max_results:50,page_token:n};return await(0,s.ff)((0,s.we)("ajax-api/3.0/mlflow/datasets/search"),"POST",a)},cacheTime:0,refetchOnWindowFocus:!1,retry:!1,enabled:t,getNextPageParam:e=>e.next_page_token});return{data:(0,r.useMemo)(()=>{var e;return null!==(e=null===i||void 0===i?void 0:i.pages.flatMap(e=>{var t;return null!==(t=e.datasets)&&void 0!==t?t:[]}))&&void 0!==e?e:[]},[i]),fetchNextPage:l,hasNextPage:c,isLoading:d,isFetching:u,refetch:f,error:m}}},82636:function(e,t,n){n.d(t,{l:function(){return s}});var a=n(4168);const s=e=>{let t=!1,n=!1,s=!1;for(const i of e){var r,o;const e=i.traceInfo;e&&((0,a.h)(e)&&(n=!0),(0,a.Mq)(e)&&(t=!0),null!==(r=i.traceInfo)&&void 0!==r&&null!==(o=r.trace_metadata)&&void 0!==o&&o["mlflow.trace.tokenUsage"]&&(s=!0))}return{responseHasContent:t,inputHasContent:n,tokensHasContent:s}}},88525:function(e,t,n){n.d(t,{$:function(){return i}});var a=n(27042),s=n(12803),r=n(46709),o=n(181);const i=({onSuccess:e,existingTagKeys:t=[]})=>{const{showEditTagsModal:n,EditTagsModal:i}=(0,a.Q)({saveTagsHandler:async(e,t,n)=>{if(!e.traceRequestId)return;const a=e.traceRequestId,r=n.filter(({key:e,value:n})=>!t.some(({key:t,value:a})=>t===e&&n===a)),o=t.filter(({key:e})=>!n.some(({key:t})=>e===t));return Promise.all([...r.map(({key:e,value:t})=>s.x.setExperimentTraceTagV3(a,e,t)),...o.map(({key:e})=>s.x.deleteExperimentTraceTagV3(a,e))])},valueRequired:!0,allAvailableTags:t.filter(e=>e&&!e.startsWith(o.nt)),onSuccess:e});return{showEditTagsModalForTrace:(0,r.useCallback)(e=>{var t;if(!e.trace_id)return;const a=Object.entries(null!==(t=e.tags)&&void 0!==t?t:{}).map(([e,t])=>({key:e,value:t})).filter(({key:e})=>e&&!e.startsWith(o.nt))||[];n({traceRequestId:e.trace_id,tags:a||[]})},[n]),EditTagsModal:i}}}}]);