stages:
  - test
  - build
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip

# Build the package
build:
  stage: build
  image: python:3.11
  script:
    - pip install --upgrade build
    - python -m build
  artifacts:
    paths:
      - dist/
    expire_in: 1 day
  only:
    - release

# Deploy to PyPI using API token
deploy-pypi:
  stage: deploy
  image: python:3.11
  script:
    - pip install --upgrade twine
    - python -m twine upload --verbose --non-interactive dist/*
  dependencies:
    - build
  only:
    - release
  variables:
    TWINE_USERNAME: __token__
    TWINE_PASSWORD: $PYPI_TOKEN




test:
  stage: test

  image: python:3.11-slim-bookworm

  services:
    - name: postgres:15
      alias: postgres

  variables:
    POSTGRES_DB: postgres
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    POSTGRES_HOST_AUTH_METHOD: trust
    # Variables for test database connection
    DB_HOST: postgres
    DB_USER: test_user
    DB_PASSWORD: test_password
    DB_NAME: test_vesta_db
    DB_PORT: "5432"

  before_script:
    # Install PostgreSQL client
    - apt-get update -qq && apt-get install -y -qq postgresql-client

    # Wait for PostgreSQL to be ready
    - until PGPASSWORD=postgres psql -h postgres -U postgres -c '\q'; do echo "Waiting for postgres..."; sleep 2; done

    # Create test database and user
    - PGPASSWORD=postgres psql -h postgres -U postgres -c "CREATE USER test_user WITH PASSWORD 'test_password';" || echo "User already exists"
    - PGPASSWORD=postgres psql -h postgres -U postgres -c "CREATE DATABASE test_vesta_db OWNER test_user;" || echo "Database might already exist"

  script:
    - echo 'Running tests...'
    - apt-get update && apt-get install -y git && apt-get install -y gcc
    - apt install -y libpq-dev
    - python -m venv venv
    - source venv/bin/activate

    # Install build tools and build the package
    - python3 -m pip install --upgrade build
    - python3 -m build
    - pip install $(ls -t dist/*.whl | head -n1)


    - pip install -r requirements.txt
    - vesta test
