cmake_minimum_required(VERSION 3.10...3.27)
project(
    ${SKBUILD_PROJECT_NAME}
    VERSION ${SKBUILD_PROJECT_VERSION}
    LANGUAGES CXX C
)

# ============================================================================
# å…¨å±€ç¼–è¯‘è®¾ç½®
# ============================================================================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_EXPORT_COMPILE_COMMANDS ON)
set(CMAKE_POSITION_INDEPENDENT_CODE ON)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -fPIC")
set(CMAKE_CXX_FLAGS_RELEASE "-O3 -DNDEBUG")
set(CMAKE_CXX_FLAGS_DEBUG "-g -O0")

# ============================================================================
# æŸ¥æ‰¾ä¾èµ–
# ============================================================================
find_package(Python REQUIRED COMPONENTS Interpreter Development.Module)

message(STATUS "")
message(STATUS "=== SAGE Libs Build Configuration ===")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "")
message(STATUS "ğŸ“¦ Package Type: Hybrid (Python + optional C++ extensions)")
message(STATUS "")
message(STATUS "C++ Extensions Status:")
message(STATUS "  - AMM algorithms: Integrated (builds with sage-libs)")
message(STATUS "  - ANNS algorithms: Independent package (install separately)")
message(STATUS "")
message(STATUS "Optional Dependencies:")
message(STATUS "  pip install isage-anns    # ANNS algorithms (in migration)")
message(STATUS "  pip install isage-amms    # AMM algorithms (alternative to embedded)")
message(STATUS "======================================")
message(STATUS "")

# ============================================================================
# é…ç½®æ‘˜è¦
# ============================================================================
message(STATUS "")
message(STATUS "SAGE Libs Build Summary")
message(STATUS "=========================================")
message(STATUS "Project: ${SKBUILD_PROJECT_NAME} v${SKBUILD_PROJECT_VERSION}")
message(STATUS "Python: ${Python_VERSION}")
message(STATUS "C++ Standard: C++${CMAKE_CXX_STANDARD}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "")
message(STATUS "ğŸ” SKBUILD Variables:")
message(STATUS "  SKBUILD_STATE: ${SKBUILD_STATE}")
message(STATUS "  SKBUILD_PLATLIB_DIR: ${SKBUILD_PLATLIB_DIR}")
message(STATUS "")
message(STATUS "Extensions: None (pure Python package)")
message(STATUS "=========================================")
message(STATUS "")

# ============================================================================
# å®‰è£… Python æºæ–‡ä»¶
# ============================================================================
# scikit-build-core éœ€è¦æ˜ç¡®å‘ŠçŸ¥è¦å®‰è£…å“ªäº› Python æ–‡ä»¶
# è¿™ç¡®ä¿çº¯ Python ä»£ç ï¼ˆå¦‚ sage.libs.context.compressionï¼‰ä¹Ÿè¢«æ­£ç¡®å®‰è£…
#
# æ³¨æ„ï¼šåœ¨ editable æ¨¡å¼ä¸‹è·³è¿‡æ–‡ä»¶å¤åˆ¶ï¼Œè®© scikit-build-core çš„ redirect æ¨¡å¼ç”Ÿæ•ˆ
# SKBUILD_STATE å¯èƒ½çš„å€¼: "wheel", "editable", "sdist", "metadata_wheel", "metadata_editable"
# ============================================================================
if(SKBUILD_STATE STREQUAL "editable" OR SKBUILD_STATE STREQUAL "metadata_editable")
    message(STATUS "")
    message(STATUS "========================================")
    message(STATUS "  Editable mode detected - skipping Python file installation")
    message(STATUS "  Source files will be used directly from: ${CMAKE_CURRENT_SOURCE_DIR}/src/sage/")
    message(STATUS "========================================")
    message(STATUS "")
else()
    message(STATUS "Configuring Python source installation...")

    # å®‰è£…æ‰€æœ‰ Python åŒ…åˆ° site-packages/sage
    install(
        DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/src/sage/"
        DESTINATION "${SKBUILD_PLATLIB_DIR}/sage"
        COMPONENT python
        FILES_MATCHING
        PATTERN "*.py"
        PATTERN "*.pyi"
        PATTERN "py.typed"
        PATTERN "__pycache__" EXCLUDE
        PATTERN "*.pyc" EXCLUDE
        PATTERN ".pytest_cache" EXCLUDE
        PATTERN "tests" EXCLUDE
    )

    message(STATUS "  âœ“ Python source files will be installed to: ${SKBUILD_PLATLIB_DIR}/sage")
    message(STATUS "")
endif()
