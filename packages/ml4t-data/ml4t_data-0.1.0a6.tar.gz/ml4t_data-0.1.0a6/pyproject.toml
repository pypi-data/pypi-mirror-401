# ML4T Data - High-performance market data management for quantitative finance
# Independent package configuration for standalone distribution

[build-system]
requires = ["hatchling", "hatch-vcs"]
build-backend = "hatchling.build"

[tool.hatch.version]
source = "vcs"

[tool.hatch.build.hooks.vcs]
version-file = "src/ml4t/data/_version.py"

[tool.hatch.build.targets.wheel]
packages = ["src/ml4t"]
namespaces = true

[tool.hatch.build.targets.sdist]
include = [
    "/src",
    "/tests",
    "/README.md",
    "/LICENSE",
    "/CHANGELOG.md",
]

[project]
name = "ml4t-data"
dynamic = ["version"]
description = "High-performance market data management library with unified multi-provider interface"
readme = "README.md"
license = { text = "MIT" }
authors = [
    { name = "ML4T Team", email = "info@ml4trading.io" },
]
maintainers = [
    { name = "ML4T Contributors", email = "dev@ml4trading.io" },
]
keywords = [
    "finance",
    "market-data",
    "trading",
    "backtesting",
    "quantitative-finance",
    "yahoo-finance",
    "binance",
    "cryptocompare",
    "databento",
    "oanda",
    "polars",
    "parquet",
]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Financial and Insurance Industry",
    "Intended Audience :: Developers",
    "Intended Audience :: Science/Research",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Office/Business :: Financial :: Investment",
    "Topic :: Scientific/Engineering :: Information Analysis",
    "Typing :: Typed",
]
requires-python = ">=3.11"

# Core dependencies
dependencies = [
    # Data processing
    "polars>=0.20.0",
    "pandas>=2.0.0",
    "numpy>=1.24.0",
    "pyarrow>=14.0.0",
    # HTTP and networking
    "httpx>=0.25.0",
    "tenacity>=8.0.0",
    "pybreaker>=1.0.0", # Circuit breaker pattern
    # Configuration and CLI
    "pyyaml>=6.0",
    "click>=8.0.0",
    "python-dotenv>=1.0.0",
    "pydantic-settings>=2.0.0",
    # Utilities
    "structlog>=23.0.0",
    "platformdirs>=4.0.0",
    "filelock>=3.19.1",
    "rich>=13.0.0",
    "aiofiles>=23.0.0", # Async file I/O for async storage backends
    # Exchange calendars for session-aware operations
    "pandas-market-calendars>=4.3.0",
    "lxml>=6.0.2",
    "html5lib>=1.1",
]

[project.optional-dependencies]
# Provider-specific dependencies
yahoo = [
    "yfinance>=0.2.0",
]
databento = [
    "databento>=0.38.0",
]
oanda = [
    "oandapyV20>=0.7.0",
]
cot = [
    "cot-reports>=0.1.0",  # CFTC Commitment of Traders data
]

all-providers = [
    "ml4t-data[yahoo,databento,oanda,cot]",
]

# Development dependencies
dev = [
    "pytest>=7.4.0",
    "pytest-cov>=4.1.0",
    "pytest-xdist>=3.3.0",
    "pytest-timeout>=2.1.0",
    "pytest-asyncio>=0.21.0",
    "hypothesis>=6.80.0",
    "ruff>=0.1.0",
    "mypy>=1.5.0",
    "ipython>=8.14.0",
    "ipdb>=0.13.0",
    "pre-commit>=3.3.0",
    "xlsxwriter>=3.1.0",  # Excel export testing
]

# Documentation dependencies (MkDocs Material with Picasso theme)
docs = [
    "mkdocs>=1.6.0",
    "mkdocs-material>=9.5.0",
    "mkdocstrings[python]>=0.24.0",
    "mkdocs-git-revision-date-localized-plugin>=1.2.0",
]

# All optional dependencies
all = [
    "ml4t-data[all-providers,dev,docs]",
]

[project.scripts]
ml4t-data = "ml4t.data.cli_interface:cli"

[project.urls]
Homepage = "https://github.com/stefan-jansen/ml4t-data"
Documentation = "https://ml4t-data.readthedocs.io"
Repository = "https://github.com/stefan-jansen/ml4t-data"
Issues = "https://github.com/stefan-jansen/ml4t-data/issues"
Changelog = "https://github.com/stefan-jansen/ml4t-data/blob/main/CHANGELOG.md"

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]

# Default: run all tests except explicitly marked as slow
# Integration tests will run if API keys are present (they skip themselves if keys missing)
# NOTE: Parallel execution (-n auto) causes hangs - disabled by default
# Use: pytest -n auto  (to enable parallel execution manually)
addopts = [
    "-ra",
    "--strict-markers",
    "-m", "not slow and not paid_tier",
    "--tb=short",
]

markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
    "paid_tier: marks tests requiring paid API tier (skipped by default)",
    "integration: marks tests as integration tests requiring external APIs",
    "real_api: marks tests that use real API calls (deprecated, use integration)",
    "requires_api_key: marks tests requiring specific API keys",
    "expensive: marks tests with high API costs",
]

filterwarnings = [
    "ignore::DeprecationWarning",
    "ignore::PendingDeprecationWarning",
]

# Timeout for tests (prevent hanging)
timeout = 300

[tool.ruff]
line-length = 100
target-version = "py311"
fix = true

[tool.ruff.lint]
select = [
    "E",    # pycodestyle errors
    "W",    # pycodestyle warnings
    "F",    # pyflakes
    "I",    # isort
    "B",    # flake8-bugbear
    "C4",   # flake8-comprehensions
    "UP",   # pyupgrade
    "ARG",  # flake8-unused-arguments
    "SIM",  # flake8-simplify
]
ignore = [
    "E501",  # line too long (handled by formatter)
    "B008",  # do not perform function calls in argument defaults
    "B905",  # zip without explicit strict parameter
    "E402",  # module import not at top (common in notebooks)
    "SIM105",  # try-except-pass pattern (often clearer than contextlib.suppress)
    "SIM102",  # nested ifs (often clearer than complex and)
    "B904",  # exception chaining (not always needed)
]

[tool.ruff.lint.per-file-ignores]
"tests/*" = ["ARG001", "ARG002", "ARG005", "B017", "F821", "SIM117"]  # Test patterns
"src/ml4t/data/providers/base.py" = ["ARG002"]  # Template method pattern
"src/ml4t/data/validation/*.py" = ["ARG002"]  # Validator pattern
"src/ml4t/data/provider_updater.py" = ["ARG002"]  # Template pattern
"src/ml4t/data/cli_interface.py" = ["ARG001"]  # Click callback signature
"src/ml4t/data/export/formats/excel.py" = ["F401"]  # Conditional import
"provider_template/*" = ["ARG002", "F821"]  # Template placeholders
"examples/notebooks/*" = ["E402"]  # Jupyter notebooks

[tool.mypy]
python_version = "3.11"
# Set mypy_path to src for proper module resolution
mypy_path = "src"
namespace_packages = true
explicit_package_bases = true
# Exclude data storage directory at project root (conflicts with ml4t.data package)
exclude = ["^data/", "^benchmarks/", "^scripts/", "^examples/", "^provider_template/"]
# Start with moderate strictness - can be increased incrementally
strict = false
warn_return_any = false  # Too many false positives with Any
warn_unused_ignores = true
disallow_untyped_defs = false  # Relax for initial commit
disallow_any_unimported = false
no_implicit_optional = true
check_untyped_defs = true
show_error_codes = true
warn_redundant_casts = true
ignore_missing_imports = true
# Still catch real issues
warn_unreachable = true
warn_unused_configs = true
disallow_untyped_calls = false

# Exclude test files, examples, and benchmarks from strict checking
[[tool.mypy.overrides]]
module = ["tests.*", "examples.*", "benchmarks.*", "scripts.*"]
disallow_untyped_defs = false
check_untyped_defs = false
warn_return_any = false

# CLI files use Click which has complex decorators and config model issues
[[tool.mypy.overrides]]
module = ["ml4t.data.cli", "ml4t.data.cli_interface"]
ignore_errors = true

# Storage modules with async/complex patterns
[[tool.mypy.overrides]]
module = ["ml4t.data.storage.async_migration"]
ignore_errors = true

# Provider init with dynamic loading and specific provider issues
[[tool.mypy.overrides]]
module = ["ml4t.data.providers.__init__", "ml4t.data.providers.twelve_data", "ml4t.data.provider_updater"]
ignore_errors = true

# Pipeline and storage async modules need refactoring
[[tool.mypy.overrides]]
module = ["ml4t.data.pipeline", "ml4t.data.storage.async_filesystem"]
ignore_errors = true

# Anomaly detection module
[[tool.mypy.overrides]]
module = ["ml4t.data.anomaly.*"]
ignore_errors = true

# Config modules with model issues
[[tool.mypy.overrides]]
module = ["ml4t.data.config.*"]
ignore_errors = true

# Storage and provider modules needing refactoring
[[tool.mypy.overrides]]
module = ["ml4t.data.storage.hive", "ml4t.data.storage.migration", "ml4t.data.storage.partitioning", "ml4t.data.storage.__init__", "ml4t.data.storage.transaction"]
ignore_errors = true

# Data manager with complex type interactions
[[tool.mypy.overrides]]
module = ["ml4t.data.data_manager"]
ignore_errors = true

# Provider modules with various issues
[[tool.mypy.overrides]]
module = ["ml4t.data.providers.base", "ml4t.data.providers.oanda", "ml4t.data.providers.mock", "ml4t.data.providers.binance", "ml4t.data.providers.yahoo", "ml4t.data.providers.polygon", "ml4t.data.providers.eodhd", "ml4t.data.providers.finnhub", "ml4t.data.providers.tiingo", "ml4t.data.providers.alpha_vantage"]
ignore_errors = true

# Export and core modules
[[tool.mypy.overrides]]
module = ["ml4t.data.export.formats.*", "ml4t.data.core.config"]
ignore_errors = true

# Utility modules
[[tool.mypy.overrides]]
module = ["ml4t.data.utils.global_rate_limit"]
ignore_errors = true

# Asset modules
[[tool.mypy.overrides]]
module = ["ml4t.data.assets.asset_class", "ml4t.data.assets.validation"]
ignore_errors = true

# Modules with Polars type inference issues (to be fixed incrementally)
[[tool.mypy.overrides]]
module = [
    "ml4t.data.utils.gaps",
    "ml4t.data.update_manager",
    "ml4t.data.storage.chunked",
    "ml4t.data.providers.wiki_prices",
    "ml4t.data.core.schemas",
    "ml4t.data.etfs.downloader",
    "ml4t.data.futures.roll",
    "ml4t.data.futures.downloader",
    "ml4t.data.futures.book_downloader",
    "ml4t.data.providers.nasdaq_itch",
    "ml4t.data.providers.kalshi",
    "ml4t.data.calendar.crypto",
    "ml4t.data.futures.continuous",
    "ml4t.data.cot.fetcher",
    "ml4t.data.cot.workflow",
    "ml4t.data.utils.format",
    "ml4t.data.sessions.*",
    "ml4t.data.providers.polymarket",
    "ml4t.data.providers.fred",
    "ml4t.data.macro.downloader",
    "ml4t.data.crypto.downloader",
    "ml4t.data.providers.fama_french",
    "ml4t.data.providers.aqr",
    "ml4t.data.providers.databento",
    "ml4t.data.validation.*",
    "ml4t.data.futures.parser",
    "ml4t.data.storage.flat",
]
ignore_errors = true

[tool.coverage.run]
source = ["src/ml4t/data"]
omit = [
    "*/tests/*",
    "*/__init__.py",
]

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "if __name__ == .__main__.:",
    "raise NotImplementedError",
    "pass",
    "except ImportError:",
]
