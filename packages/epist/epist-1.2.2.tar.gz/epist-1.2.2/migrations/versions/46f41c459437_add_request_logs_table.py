"""add request logs table

Revision ID: 46f41c459437
Revises: 0a7c69d5cceb
Create Date: 2025-11-27 17:11:32.993060+00:00

"""

from collections.abc import Sequence

import pgvector
import sqlalchemy as sa
import sqlmodel
from alembic import op
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = "46f41c459437"
down_revision: str | None = "0a7c69d5cceb"
branch_labels: str | Sequence[str] | None = None
depends_on: str | Sequence[str] | None = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    bind = op.get_bind()
    inspector = sa.inspect(bind)
    tables = inspector.get_table_names()

    # Rename tables to match new model definitions if they exist and target doesn't
    if "organization" in tables and "organizations" not in tables:
        op.rename_table("organization", "organizations")
    if "user" in tables and "users" not in tables:
        op.rename_table("user", "users")
    if "apikey" in tables and "api_keys" not in tables:
        op.rename_table("apikey", "api_keys")

    # Create transcript_segments (was missing)
    if "transcript_segments" not in tables:
        op.create_table(
            "transcript_segments",
            sa.Column("start", sa.Float(), nullable=False),
            sa.Column("end", sa.Float(), nullable=False),
            sa.Column("text", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
            sa.Column("speaker", sqlmodel.sql.sqltypes.AutoString(), nullable=True),
            sa.Column("confidence", sa.Float(), nullable=True),
            sa.Column("embedding", pgvector.sqlalchemy.vector.VECTOR(dim=1536), nullable=True),
            sa.Column("content_vector", postgresql.TSVECTOR(), nullable=True),
            sa.Column("id", sa.Uuid(), nullable=False),
            sa.Column("transcript_id", sa.Uuid(), nullable=False),
            sa.ForeignKeyConstraint(
                ["transcript_id"],
                ["transcripts.id"],
            ),
            sa.PrimaryKeyConstraint("id"),
        )
        # Create indices for transcript_segments
        op.create_index(
            "ix_transcript_segments_embedding",
            "transcript_segments",
            ["embedding"],
            unique=False,
            postgresql_using="ivfflat",
        )
        op.create_index(
            "ix_transcript_segments_content_vector",
            "transcript_segments",
            ["content_vector"],
            unique=False,
            postgresql_using="gin",
        )

    # Create request_logs
    if "request_logs" not in tables:
        op.create_table(
            "request_logs",
            sa.Column("id", sa.Uuid(), nullable=False),
            sa.Column("request_id", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
            sa.Column("method", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
            sa.Column("path", sqlmodel.sql.sqltypes.AutoString(), nullable=False),
            sa.Column("status_code", sa.Integer(), nullable=False),
            sa.Column("latency_ms", sa.Float(), nullable=False),
            sa.Column("ip_address", sqlmodel.sql.sqltypes.AutoString(), nullable=True),
            sa.Column("user_agent", sqlmodel.sql.sqltypes.AutoString(), nullable=True),
            sa.Column("api_key_id", sa.Uuid(), nullable=True),
            sa.Column("error_message", sqlmodel.sql.sqltypes.AutoString(), nullable=True),
            sa.Column("created_at", sa.DateTime(), nullable=False),
            sa.ForeignKeyConstraint(
                ["api_key_id"],
                ["api_keys.id"],
            ),
            sa.PrimaryKeyConstraint("id"),
        )
        op.create_index(op.f("ix_request_logs_request_id"), "request_logs", ["request_id"], unique=False)
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index(op.f("ix_request_logs_request_id"), table_name="request_logs")
    op.drop_table("request_logs")

    op.drop_index("ix_transcript_segments_content_vector", table_name="transcript_segments")
    op.drop_index("ix_transcript_segments_embedding", table_name="transcript_segments")
    op.drop_table("transcript_segments")

    # Rename tables back
    op.rename_table("api_keys", "apikey")
    op.rename_table("users", "user")
    op.rename_table("organizations", "organization")
    # ### end Alembic commands ###
