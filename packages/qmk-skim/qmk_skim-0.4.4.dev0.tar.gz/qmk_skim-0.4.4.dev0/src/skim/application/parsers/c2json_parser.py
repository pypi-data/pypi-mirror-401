"""Parser for QMK c2json keymap format.

This module provides the :class:`C2JsonParser` for parsing keymap files
in QMK's c2json format. This format is produced by the `qmk c2json` command
and stores keycodes in a structured JSON format.

The c2json format structure::

    {
        "layers": [
            ["KC_Q", "KC_W", "KC_E", ...],  // Layer 0
            ["KC_1", "KC_2", "KC_3", ...],  // Layer 1
            ...
        ],
        "keyboard": "...",
        "keymap": "...",
        ...
    }

Example:
    >>> parser = C2JsonParser()
    >>> layers = parser.parse(json_content)
    >>> layers[0]  # First layer keycodes
    ['KC_Q', 'KC_W', 'KC_E', ...]
"""

import json


class C2JsonParser:
    """Parses QMK keymap files in c2json JSON format.

    The c2json format is the standard JSON export format for QMK keymaps,
    generated by the `qmk c2json` command. It contains keycode definitions
    organized by layers.

    Unlike Keybard or Vial formats, c2json keycodes are already in the
    correct order for Skim and don't require reordering transformation.

    Example:
        >>> parser = C2JsonParser()
        >>> with open("keymap.json") as f:
        ...     content = f.read()
        >>> layers = parser.parse(content)
        >>> len(layers)
        8  # Number of layers in the keymap
    """

    def parse(self, content: str) -> list[list[str]]:
        """Parse c2json content and extract keycode layers.

        Validates the JSON structure and extracts the layers array
        containing keycode strings for each layer.

        Args:
            content: JSON string content of the keymap file.

        Returns:
            List of layers, where each layer is a list of keycode strings.
            Keycodes are in the order they appear in the c2json file.

        Raises:
            ValueError: If JSON is invalid, missing 'layers' key,
                or layers have incorrect structure.

        Example:
            >>> content = '{"layers": [["KC_A", "KC_B"], ["KC_1", "KC_2"]]}'
            >>> parser.parse(content)
            [['KC_A', 'KC_B'], ['KC_1', 'KC_2']]
        """
        try:
            data = json.loads(content)
        except json.JSONDecodeError as e:
            raise ValueError(f"Invalid JSON: {e}") from e

        if "layers" not in data:
            raise ValueError("Missing 'layers' key in c2json data")

        layers = data["layers"]
        if not isinstance(layers, list):
            raise ValueError("'layers' must be a list")

        for i, layer in enumerate(layers):
            if not isinstance(layer, list):
                raise ValueError(f"Layer {i} must be a list")

        return layers
