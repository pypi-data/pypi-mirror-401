# Migration Guide: v0.2.0

This guide covers migrating from codemode v0.1.x to v0.2.0. Version 0.2.0 introduces significant improvements to configuration, reliability, and observability.

## Overview of Changes

Version 0.2.0 includes:

- **Configuration Separation**: Distinct `ClientConfig` and `SidecarConfig` models
- **Environment Variable Support**: Full configuration via environment variables
- **Retry Logic**: Automatic retries with exponential backoff
- **Correlation IDs**: End-to-end request tracing
- **Structured Errors**: Detailed error information with tracebacks
- **Tool Schema Support**: Input/output schema definitions for tools
- **Improved Docker Support**: Production-ready Dockerfile and compose files

## Breaking Changes

### Configuration Model Changes

**Before (v0.1.x)**:
```python
from codemode import Codemode

# Single unified config file
codemode = Codemode.from_config("codemode.yaml")
```

**After (v0.2.0)**:
```python
from codemode import Codemode
from codemode.config import ClientConfig

# Option 1: Explicit ClientConfig
config = ClientConfig(
    executor_url="http://executor:8001",
    executor_api_key="your-api-key",
)
codemode = Codemode.from_client_config(config)

# Option 2: From environment variables
codemode = Codemode.from_env()

# Option 3: Legacy config still works
codemode = Codemode.from_config("codemode.yaml")
```

### Configuration File Changes

If using YAML configuration files, you should now use separate files for client and sidecar.

**Before (v0.1.x)** - Single `codemode.yaml`:
```yaml
project:
  name: my-app

executor:
  url: http://executor:8001
  api_key: secret

grpc:
  tls:
    enabled: false
```

**After (v0.2.0)** - Separate files:

`codemode-client.yaml`:
```yaml
executor_url: http://executor:8001
executor_api_key: secret
executor_timeout: 35

retry:
  enabled: true
  max_attempts: 3

tls:
  enabled: false

observability:
  log_level: INFO
  include_correlation_id: true
```

`codemode-sidecar.yaml`:
```yaml
port: 8001
host: 0.0.0.0
main_app_grpc_target: app:50051
api_key: secret

limits:
  code_timeout: 30
  max_code_length: 10000

tls:
  enabled: false
```

### ExecutionResult Changes

The `ExecutionResult` model now includes additional fields:

```python
# Before (v0.1.x)
result.success  # bool
result.result   # str | None
result.error    # str | None

# After (v0.2.0) - New fields
result.success        # bool
result.result         # str | None
result.error          # str | None
result.error_details  # ExecutionError | None (NEW)
result.correlation_id # str | None (NEW)
result.duration_ms    # int | None (NEW)
```

### Tool Registration Changes

Tools can now include input/output schemas:

```python
# Before (v0.1.x)
registry.register_tool(
    name="weather",
    func=get_weather,
    description="Get weather for a location",
)

# After (v0.2.0) - With schemas
from pydantic import BaseModel

class WeatherInput(BaseModel):
    location: str
    units: str = "celsius"

class WeatherOutput(BaseModel):
    temperature: float
    conditions: str

registry.register_tool(
    name="weather",
    func=get_weather,
    description="Get weather for a location",
    input_schema=WeatherInput,   # NEW
    output_schema=WeatherOutput, # NEW
)
```

## Migration Steps

### Step 1: Update Dependencies

```bash
pip install --upgrade opencodemode>=0.2.0
```

### Step 2: Update Configuration

Choose one of these approaches:

**Option A: Environment Variables (Recommended for Production)**

Set environment variables instead of using YAML files:

```bash
# Client-side (main application)
export CODEMODE_EXECUTOR_URL="http://executor:8001"
export CODEMODE_EXECUTOR_API_KEY="your-api-key"
export CODEMODE_LOG_LEVEL="INFO"

# Sidecar (executor container)
export CODEMODE_API_KEY="your-api-key"
export CODEMODE_MAIN_APP_TARGET="app:50051"
```

```python
from codemode import Codemode

codemode = Codemode.from_env()
```

**Option B: New ClientConfig**

```python
from codemode import Codemode
from codemode.config import ClientConfig

config = ClientConfig(
    executor_url="http://executor:8001",
    executor_api_key="your-api-key",
    executor_timeout=35,
)
codemode = Codemode.from_client_config(config)
```

**Option C: Keep Legacy Config**

The legacy `codemode.yaml` format still works:

```python
codemode = Codemode.from_config("codemode.yaml")
```

### Step 3: Update Docker Compose

Update your `docker-compose.yml` to use environment variables:

```yaml
services:
  app:
    build: .
    environment:
      - CODEMODE_EXECUTOR_URL=http://executor:8001
      - CODEMODE_EXECUTOR_API_KEY=${API_KEY}
    depends_on:
      executor:
        condition: service_healthy

  executor:
    image: codemode/executor:0.2.0
    environment:
      - CODEMODE_API_KEY=${API_KEY}
      - CODEMODE_MAIN_APP_TARGET=app:50051
      - CODEMODE_CODE_TIMEOUT=30
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
```

### Step 4: Update Error Handling

Take advantage of structured errors:

```python
result = codemode.execute(code)

if not result.success:
    if result.error_details:
        print(f"Error type: {result.error_details.error_type}")
        print(f"Message: {result.error_details.message}")
        if result.error_details.line_number:
            print(f"Line: {result.error_details.line_number}")
        for frame in result.error_details.traceback:
            print(f"  {frame}")
    else:
        print(f"Error: {result.error}")
```

### Step 5: Add Correlation ID Logging

Enable correlation ID tracking for distributed tracing:

```python
import logging

logging.basicConfig(
    format="%(asctime)s [%(name)s] %(levelname)s [%(correlation_id)s] %(message)s"
)

# Correlation IDs are automatically included in requests
result = codemode.execute(code)
print(f"Request correlation ID: {result.correlation_id}")
```

### Step 6: Update Tool Registrations (Optional)

Add schemas to your tools for better validation:

```python
from pydantic import BaseModel

class SearchInput(BaseModel):
    query: str
    max_results: int = 10

class SearchOutput(BaseModel):
    results: list[dict]
    total_count: int

registry.register_tool(
    name="search",
    func=search_function,
    description="Search the database",
    input_schema=SearchInput,
    output_schema=SearchOutput,
)
```

## New Features to Explore

### Retry Configuration

Configure automatic retries for transient failures:

```python
config = ClientConfig(
    executor_url="http://executor:8001",
    executor_api_key="secret",
    retry=RetryConfig(
        enabled=True,
        max_attempts=3,
        backoff_base_ms=100,
        backoff_max_ms=5000,
    ),
)
```

### TLS Configuration

Enable TLS for secure communication:

```python
config = ClientConfig(
    executor_url="https://executor:8001",
    executor_api_key="secret",
    tls=TlsClientConfig(
        enabled=True,
        mode="custom",
        ca_file="/path/to/ca.pem",
        client_cert_file="/path/to/client.pem",
        client_key_file="/path/to/client-key.pem",
    ),
)
```

### Meta-Tools

The sidecar now exposes meta-tools for tool discovery:

```python
# In executed code, these special tools are available:
tools["__list__"].run()  # List all available tools
tools["__schema__"].run(tool_name="weather")  # Get tool schema
```

## Compatibility Notes

- Python 3.11+ is required (unchanged)
- The legacy `CodemodeConfig` and `from_config()` method remain available
- All existing tool functions work without modification
- gRPC protocol is backward compatible

## Getting Help

If you encounter issues during migration:

1. Check the [Configuration Reference](../configuration/index.md)
2. Review the [API Reference](../api-reference/core.md)
3. Open an issue on [GitHub](https://github.com/mldlwizard/code_mode/issues)
