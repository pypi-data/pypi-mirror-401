stages:
  - test
  - publish

# Template: https://docs.astral.sh/uv/guides/integration/gitlab/#using-the-uv-image
# Key points:
# - Use ghcr.io/astral-sh/uv:<UV_VERSION>-python<UV_PYTHON>-<BASE_LAYER>
# - Set UV_LINK_MODE=copy for GitLabâ€™s mount behavior
variables:
  UV_VERSION: "0.9.23"
  BASE_LAYER: "trixie"
  UV_LINK_MODE: "copy"
  UV_CACHE_DIR: "${CI_PROJECT_DIR}/.uv-cache"
  UV_FROZEN: "true"
  UV_PYTHON_DOWNLOADS: "false"
  UV_PYTHON_PREFERENCE: "system"

default:
  image: "ghcr.io/astral-sh/uv:${UV_VERSION}-python${UV_PYTHON}-${BASE_LAYER}"
  cache:
    - key:
        files:
          - uv.lock
        prefix: "uv-${UV_PYTHON}"
      paths:
        - $UV_CACHE_DIR

# -------------------------
# Tests (matrix 3.12..3.14)
# -------------------------
test:
  stage: test
  parallel:
    matrix:
      - UV_PYTHON: ["3.12", "3.13", "3.14"]
  script:
    - uv run pre-commit run --all-files

  after_script:
    # Recommended by Astral to keep cache size under control in CI
    - uv cache prune --ci
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage.xml
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml

# -------------------------
# Publish to PyPI (Trusted Publisher / OIDC)
# -------------------------
publish:pypi:
  stage: publish
  # Build/publish once (pick a stable version for publishing)
  variables:
    UV_PYTHON: "3.12"
  rules:
    # Typical choice: publish only for tags
    - if: $CI_COMMIT_TAG
  # Request an OIDC token from GitLab with the audience expected by PyPI ("pypi")
  # This matches PyPI's GitLab Trusted Publishing guidance.
  id_tokens:
    PYPI_ID_TOKEN:
      aud: pypi
  environment:
    name: 'release'
    url: 'https://pypi.org/project/uvrev'
  script:
    # If your tooling expects CI_JOB_JWT_V2, map the token (safe no-op if unused).
    - export CI_JOB_JWT_V2="$PYPI_ID_TOKEN"

    # Build distributions
    - uv build

    # Publish using Trusted Publishing (OIDC). No API token needed if PyPI Trusted Publisher is configured.
    - uv publish --trusted-publishing=always
  artifacts:
    when: always
    paths:
      - dist/
