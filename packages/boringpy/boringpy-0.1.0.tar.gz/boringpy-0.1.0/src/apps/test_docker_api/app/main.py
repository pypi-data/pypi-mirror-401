"""Main FastAPI application entry point."""

import uuid

from fastapi import FastAPI, Request
from fastapi.responses import JSONResponse

from app import __version__
from app.api.v1.endpoints import health
from app.core.config import get_settings
from app.core.lifespan import lifespan
from app.core.logger import (
    configure_logger,
    get_trace_id,
    log,
    set_trace_id,
    setup_logging,
)

# Setup logging first
setup_logging()

settings = get_settings()

# Initialize FastAPI app
app = FastAPI(
    title=settings.app_name,
    version=__version__,
    description="Test Docker Api - Generated by BoringPy",
    debug=settings.debug,
    lifespan=lifespan,
)


@app.middleware("http")
async def add_trace_id_middleware(request: Request, call_next):
    """
    Add trace ID to each request for distributed tracing.

    Checks for X-Trace-ID header, generates new one if not present.
    """
    trace_id = request.headers.get("X-Trace-ID") or str(uuid.uuid4())
    set_trace_id(trace_id)

    # Get logger with trace_id bound
    request_log = configure_logger()
    request_log.info(
        f"{request.method} {request.url.path}",
        method=request.method,
        path=request.url.path,
    )

    response = await call_next(request)
    response.headers["X-Trace-ID"] = trace_id

    return response


@app.exception_handler(Exception)
async def global_exception_handler(request: Request, exc: Exception):
    """
    Global exception handler that logs errors with trace ID.
    """
    request_log = configure_logger()
    request_log.error(
        f"Unhandled exception: {exc}",
        exc_info=exc,
        path=request.url.path,
        method=request.method,
    )

    return JSONResponse(
        status_code=500,
        content={
            "detail": "Internal server error",
            "trace_id": get_trace_id(),
        },
    )


# Include routers
app.include_router(
    health.router,
    prefix=settings.api_v1_prefix,
    tags=["health"],
)


@app.get("/")
async def root() -> dict[str, str]:
    """Root endpoint with basic info."""
    log.info("Root endpoint accessed")
    return {
        "message": f"Welcome to {settings.app_name}",
        "version": __version__,
        "environment": settings.environment,
        "docs": "/docs",
        "trace_id": get_trace_id(),
    }