name: Validate pipx Installation

on:
  workflow_run:
    workflows: ["Release to PyPI"]
    types:
      - completed
  workflow_dispatch:  # Allow manual triggering

jobs:
  validate-installation:
    # Only run if the release workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            platform: Ubuntu
          - os: macos-latest
            platform: macOS
          - os: windows-latest
            platform: Windows

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for PyPI propagation
        if: github.event_name == 'workflow_run'
        run: |
          echo "Waiting 90 seconds for PyPI to propagate the new package..."
          sleep 90
        shell: bash

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install pipx
        run: |
          python -m pip install --user pipx
          python -m pipx ensurepath
        shell: bash

      - name: Install tasktree via pipx
        run: |
          python -m pipx install tasktree
        shell: bash

      - name: Get installed tt version
        working-directory: example
        run: |
          tt --version
        shell: bash

      - name: Test tt --list command
        working-directory: example
        run: |
          tt --list
        shell: bash

      - name: Run test task
        working-directory: example
        run: |
          tt package
        shell: bash

      - name: Verify installation
        run: |
          echo "✓ tasktree successfully installed via pipx on ${{ matrix.platform }}"

  validate-centos:
    # Only run if the release workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: ubuntu-latest
    container:
      image: quay.io/centos/centos:stream9

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for PyPI propagation
        if: github.event_name == 'workflow_run'
        run: |
          echo "Waiting 90 seconds for PyPI to propagate the new package..."
          sleep 90

      - name: Install dependencies
        run: |
          dnf install -y python python-pip
        shell: bash

      - name: Install Python 3.12
        run: dnf install -y python3.12
        shell: bash

      - name: Install pipx with Python 3.12
        run: |
          pip install pipx
          pipx ensurepath
        shell: bash

      - name: Install tasktree via pipx with Python 3.12
        run: |
          pipx install --python python3.12 tasktree
        shell: bash

      - name: Get installed tt version
        working-directory: example
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          tt --version
        shell: bash

      - name: Test tt --list command
        working-directory: example
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          tt --list
        shell: bash

      - name: Run test task
        working-directory: example
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          tt package
        shell: bash

      - name: Verify installation
        run: |
          echo "✓ tasktree successfully installed via pipx on CentOS Stream 9"