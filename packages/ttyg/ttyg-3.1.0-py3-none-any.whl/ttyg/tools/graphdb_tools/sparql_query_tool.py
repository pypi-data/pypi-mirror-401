import json
import logging
from typing import (
    Type,
    Tuple,
)

from langchain_core.callbacks import CallbackManagerForToolRun
from langchain_core.tools import ToolException
from pydantic import BaseModel, Field

from ttyg.utils import timeit
from .base import BaseGraphDBTool
from .sparql_query_artifact import SparqlQueryArtifact


class SparqlQueryTool(BaseGraphDBTool):
    """
    Tool, which executes SPARQL queries generated by the agent.
    """

    class SearchInput(BaseModel):
        query: str = Field(
            description="A valid SPARQL SELECT, CONSTRUCT, DESCRIBE or ASK query without prefixes"
        )

    name: str = "sparql_query"
    description: str = "Query GraphDB by SPARQL SELECT, CONSTRUCT, DESCRIBE or ASK query and return result."
    response_format: str = "content_and_artifact"
    args_schema: Type[BaseModel] = SearchInput

    @timeit
    def _run(
        self,
        query: str,
        run_manager: CallbackManagerForToolRun | None = None,
    ) -> Tuple[str, SparqlQueryArtifact]:
        try:
            logging.debug(f"Executing generated SPARQL query {query}")
            query_results, actual_query = self.graph.eval_sparql_query(query)
            return json.dumps(query_results, indent=2), SparqlQueryArtifact(query=actual_query)
        except Exception as e:
            raise ToolException(str(e))
