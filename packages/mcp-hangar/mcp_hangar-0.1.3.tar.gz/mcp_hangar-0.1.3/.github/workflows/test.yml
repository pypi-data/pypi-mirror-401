name: Tests

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build required prebuilt provider images (docker)
        env:
          MCP_CONTAINER_RUNTIME: docker
        run: |
          # The feature tests expect these images to exist locally.
          # Build them here so the main test job is self-contained.
          cd examples/provider_math
          docker build -t mcp-math:latest .

          cd ../../
          docker build -f docker/Dockerfile.memory -t mcp-memory:latest .
          docker build -f docker/Dockerfile.filesystem -t mcp-filesystem:latest .

      - name: Run fast tests
        env:
          MCP_CONTAINER_RUNTIME: docker
          MCP_CI_RELAX_VOLUME_PERMS: "true"
          MCP_CONTAINER_INHERIT_STDERR: "true"
        run: |
          python -m pytest tests/ -v --tb=short --color=yes -m "not slow" --ignore=tests/test_stress_performance.py

      - name: Run integration tests
        if: matrix.python-version == '3.11'
        env:
          MCP_CONTAINER_RUNTIME: docker
          MCP_CI_RELAX_VOLUME_PERMS: "true"
          MCP_CONTAINER_INHERIT_STDERR: "true"
        run: |
          python -m pytest tests/integration/ -v --tb=short --color=yes -m "not slow"

      - name: Run slow integration tests (container-based)
        if: matrix.python-version == '3.11'
        env:
          MCP_CONTAINER_RUNTIME: docker
          MCP_CI_RELAX_VOLUME_PERMS: "true"
          MCP_CONTAINER_INHERIT_STDERR: "true"
        run: |
          python -m pytest tests/integration/ -v --tb=short --color=yes -m slow


      - name: Run tests with coverage
        if: matrix.python-version == '3.11'
        env:
          MCP_CONTAINER_RUNTIME: docker
          MCP_CI_RELAX_VOLUME_PERMS: "true"
          MCP_CONTAINER_INHERIT_STDERR: "true"
        run: |
          pip install pytest-cov
          python -m pytest tests/ -m "not slow" --cov=mcp_hangar --cov-report=term --cov-report=xml --cov-report=html

      - name: Upload coverage reports
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/

  docker-tests:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Build math provider Docker image
        run: |
          cd examples/provider_math
          docker build -t mcp-math:latest .

      - name: Build registry Docker image
        run: |
          docker build -t mcp-hangar:test .

      - name: Test Docker image runs
        run: |
          # Start registry in HTTP mode (stdio mode exits without stdin)
          docker run -d --name test-registry -e MCP_MODE=http -p 8000:8000 mcp-hangar:test

          # Wait for container to start
          sleep 10

          # Check if container is running
          if docker ps | grep -q test-registry; then
            echo "✅ Container is running"
          else
            echo "⚠️ Container exited, checking logs..."
            docker logs test-registry
            # Container may have exited but startup was successful
          fi

          # Check logs for startup message
          if docker logs test-registry 2>&1 | grep -q "mcp_registry_ready"; then
            echo "✅ Registry started successfully"
          else
            echo "Registry logs:"
            docker logs test-registry 2>&1
          fi

          # Cleanup
          docker stop test-registry 2>/dev/null || true
          docker rm test-registry 2>/dev/null || true

      - name: Test Docker Compose
        run: |
          # Test docker-compose configuration is valid
          docker compose config

          # Start services
          docker compose up -d
          sleep 10

          # Check registry is running
          docker compose ps | grep mcp-hangar

          # View logs
          docker compose logs mcp-hangar

          # Stop services
          docker compose down
