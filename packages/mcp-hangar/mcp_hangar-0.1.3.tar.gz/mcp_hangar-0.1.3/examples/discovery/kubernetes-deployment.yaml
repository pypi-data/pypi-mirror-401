# Example Kubernetes Deployment with MCP Discovery Annotations
# Apply with: kubectl apply -f kubernetes-deployment.yaml

apiVersion: v1
kind: Namespace
metadata:
  name: mcp-providers
  labels:
    app.kubernetes.io/managed-by: mcp-hangar

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-processor
  namespace: mcp-providers
  labels:
    app.kubernetes.io/name: data-processor
    app.kubernetes.io/component: mcp-provider
spec:
  replicas: 2
  selector:
    matchLabels:
      app.kubernetes.io/name: data-processor
  template:
    metadata:
      labels:
        app.kubernetes.io/name: data-processor
        app.kubernetes.io/component: mcp-provider
      annotations:
        # MCP Hangar Discovery Annotations
        mcp.hangar.io/enabled: "true"
        mcp.hangar.io/name: "data-processor"
        mcp.hangar.io/mode: "http"
        mcp.hangar.io/port: "8080"
        mcp.hangar.io/group: "data-team"
        mcp.hangar.io/health-path: "/health"
        mcp.hangar.io/ttl: "120"
    spec:
      containers:
        - name: mcp-server
          image: my-mcp-provider:latest
          ports:
            - containerPort: 8080
              name: mcp
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 30
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
          resources:
            limits:
              memory: "256Mi"
              cpu: "500m"
            requests:
              memory: "128Mi"
              cpu: "100m"

---
apiVersion: v1
kind: Service
metadata:
  name: data-processor
  namespace: mcp-providers
spec:
  selector:
    app.kubernetes.io/name: data-processor
  ports:
    - port: 8080
      targetPort: 8080
      name: mcp

---
# MCP Hangar Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mcp-hangar
  namespace: mcp-providers
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: mcp-hangar
  template:
    metadata:
      labels:
        app.kubernetes.io/name: mcp-hangar
    spec:
      serviceAccountName: mcp-hangar
      containers:
        - name: mcp-hangar
          image: mcp-hangar:latest
          ports:
            - containerPort: 8000
          env:
            - name: LOG_LEVEL
              value: "INFO"
          volumeMounts:
            - name: config
              mountPath: /app/config.yaml
              subPath: config.yaml
      volumes:
        - name: config
          configMap:
            name: mcp-hangar-config

---
# Service Account for Kubernetes API access
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mcp-hangar
  namespace: mcp-providers

---
# RBAC for pod discovery
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: mcp-hangar-discovery
rules:
  - apiGroups: [""]
    resources: ["pods", "namespaces"]
    verbs: ["get", "list", "watch"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: mcp-hangar-discovery
subjects:
  - kind: ServiceAccount
    name: mcp-hangar
    namespace: mcp-providers
roleRef:
  kind: ClusterRole
  name: mcp-hangar-discovery
  apiGroup: rbac.authorization.k8s.io

---
# ConfigMap with MCP Hangar configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: mcp-hangar-config
  namespace: mcp-providers
data:
  config.yaml: |
    discovery:
      enabled: true
      refresh_interval_s: 30
      auto_register: true
      
      sources:
        - type: kubernetes
          mode: authoritative
          namespaces:
            - mcp-providers
          label_selector: "app.kubernetes.io/component=mcp-provider"
          in_cluster: true
      
      security:
        max_providers_per_source: 100
        require_health_check: true
        quarantine_on_failure: true
        
        denied_namespaces:
          - kube-system
          - default

