import{h as W,D as H,r as J,E as x,e as A,F as K,G as X,k as L,H as Y,n as Z,c as i,o as n,a as l,I as p,t as o,g as t,J as P,K as ee,b as g,w as c,d as f,v as T,L as te,y as ae,M as se,N as re,O as b,P as N,Q as V}from"./BzhixHsn.js";import{_ as ne}from"./4isL45Eu.js";import{_ as oe}from"./Di109XjC.js";import{_ as ie}from"./hcYt5xb6.js";import{u as le}from"./G5O1m7ek.js";const ue={class:"flex flex-col items-center gap-2 text-center"},de={class:"text-2xl font-bold"},ce={key:0,class:"rounded-md border border-red-200 bg-red-50 p-3 text-sm text-red-600"},me={key:1,class:"rounded-md border border-green-200 bg-green-50 p-3 text-sm text-green-700"},pe={key:2,class:"flex justify-center py-4"},ge={key:3,class:"grid gap-6"},fe={class:"space-y-2"},he={key:0,class:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"},_e=["src"],ve={class:"after:border-border relative text-center text-sm after:absolute after:inset-0 after:top-1/2 after:z-0 after:flex after:items-center after:border-t"},ye={class:"bg-background text-muted-foreground relative z-10 px-2"},be={key:1,class:"space-y-4"},we={class:"grid gap-2"},xe={class:"grid gap-2"},ke={class:"flex items-center justify-between"},$e={key:0,class:"text-muted-foreground text-center text-xs"},Ue={key:4,class:"text-center text-sm"},Ce=W({__name:"AuthForm",props:{scene:{},redirectUrl:{}},setup(R){const a=R,{$api:k}=H(),r=J({email:"",password:""}),h=x(!1),d=x(""),v=x(""),{t:m}=A(),{locale:F}=A(),C=K(),O=async()=>{if(!r.email||!r.password){d.value=m("auth.fillAllFields");return}h.value=!0,d.value="",v.value="";try{const e=F.value.split("-")[0];await k("/v1/auth/register",{method:"POST",body:{email:r.email,password:r.password,language:e}}),await b({path:"/sign-in",query:{email:r.email,registered:"1",redirect:a.redirectUrl||void 0}});return}catch(e){if(!(e instanceof N))throw e;if(e.statusCode===400&&e.data?.detail==="REGISTER_USER_ALREADY_EXISTS"){d.value=m("auth.emailAlreadyExists");return}d.value=m("auth.registrationFailed")}finally{h.value=!1}},S=()=>a.redirectUrl&&a.redirectUrl.length>0?a.redirectUrl:"/chat",q=async()=>{h.value=!0,d.value="",v.value="";try{const e=new URLSearchParams({username:r.email,password:r.password}),s=await k("/v1/auth/login",{method:"POST",body:e,headers:{"Content-Type":"application/x-www-form-urlencoded"}});await b(S())}catch(e){if(!(e instanceof N))throw e;if(e.statusCode===400&&e.data?.detail==="LOGIN_USER_NOT_VERIFIED")return await D();if(e.statusCode===400&&e.data?.detail==="LOGIN_BAD_CREDENTIALS"){d.value=m("auth.invalidCredentials");return}d.value=m("auth.loginFailed")}finally{h.value=!1}},D=async()=>{await b(`/verify-email?email=${encodeURIComponent(r.email)}`)},z=async()=>{a.scene==="sign-up"?await O():await q()},_=x(null),B=e=>{if(_.value)return;_.value=e;const s=window.location.origin+S();k(`/v1/oauth/${e}/authorize`,{method:"POST",body:{redirect_uri:s}}).then(y=>{y.authorization_url?window.location.href=y.authorization_url:(V.error(m("auth.gettingAuthUrl")),_.value=null)}).catch(()=>{V.error(m("auth.gettingAuthUrl")),_.value=null})},G=()=>{const e=a.redirectUrl?{redirect:a.redirectUrl}:void 0;a.scene==="sign-in"?b({path:"/sign-up",query:e}):b({path:"/sign-in",query:e})},w=X(),M=L(()=>!w.isLoaded),{data:$}=le("/v1/oauth/providers"),j=L(()=>{const e=r.email?.trim(),s=r.password?.trim();return!(!e||!s)});return Y(()=>{if(a.scene==="sign-in"){const e=C.query.email;typeof e=="string"&&e.length>0&&(r.email=e);const s=C.query.registered;(s==="1"||s==="true")&&(v.value=m("auth.registrationSuccess"))}}),(e,s)=>{const y=te,E=ne,I=oe,U=ie,Q=Z("i18n-t");return n(),i("form",{onSubmit:se(z,["prevent"]),class:ae(t(re)("flex flex-col gap-6")),autocomplete:"off"},[l("div",ue,[l("h1",de,o(a.scene==="sign-up"?e.$t("auth.signUpTitle"):e.$t("auth.signInTitle")),1),s[2]||(s[2]=l("p",{class:"text-muted-foreground text-sm text-balance"},null,-1))]),t(d)?(n(),i("div",ce,o(t(d)),1)):p("",!0),t(v)?(n(),i("div",me,o(t(v)),1)):p("",!0),t(M)?(n(),i("div",pe,[...s[3]||(s[3]=[l("div",{class:"border-primary h-6 w-6 animate-spin rounded-full border-b-2"},null,-1)])])):(n(),i("div",ge,[t($)&&t($).length>0?(n(),i(P,{key:0},[l("div",fe,[(n(!0),i(P,null,ee(t($)||[],u=>(n(),T(y,{key:u.id,type:"button",disabled:!!t(_),variant:"outline",class:"h-12 w-full text-base",onClick:Se=>B(u.name)},{default:c(()=>[t(_)===u.name?(n(),i("div",he)):u.icon_url?(n(),i("img",{key:1,src:u.icon_url,alt:"icon",class:"mr-2 h-4 w-4 rounded"},null,8,_e)):p("",!0),f(" "+o(e.$t(a.scene==="sign-up"?"auth.signUpWithProvider":"auth.signInWithProvider",{provider:u.display_name})),1)]),_:2},1032,["disabled","onClick"]))),128))]),l("div",ve,[l("span",ye,o(e.$t("common.or")),1)])],64)):p("",!0),a.scene==="sign-up"&&!t(w)?.config.registration_enabled?p("",!0):(n(),i("div",be,[l("div",we,[g(E,{for:"email"},{default:c(()=>[f(o(e.$t("auth.email")),1)]),_:1}),g(I,{id:"email",modelValue:t(r).email,"onUpdate:modelValue":s[0]||(s[0]=u=>t(r).email=u),type:"email",placeholder:e.$t("auth.emailPlaceholder"),required:"",autocomplete:"email",class:"h-12 text-base"},null,8,["modelValue","placeholder"])]),l("div",xe,[l("div",ke,[g(E,{for:"password"},{default:c(()=>[f(o(e.$t("auth.password")),1)]),_:1}),a.scene==="sign-in"?(n(),T(U,{key:0,to:"/forgot-password",class:"text-muted-foreground hover:text-primary text-xs underline-offset-4 hover:underline"},{default:c(()=>[f(o(e.$t("auth.forgotPassword")),1)]),_:1})):p("",!0)]),g(I,{id:"password",modelValue:t(r).password,"onUpdate:modelValue":s[1]||(s[1]=u=>t(r).password=u),type:"password",required:"",autocomplete:"new-password",class:"h-12 text-base"},null,8,["modelValue"])]),a.scene==="sign-up"&&t(w)?.config.ui_show_signup_terms?(n(),i("div",$e,[g(Q,{keypath:"auth.agreeTerms",tag:"span"},{terms:c(()=>[g(U,{to:"/terms",target:"_blank",class:"text-primary hover:underline"},{default:c(()=>[f(o(e.$t("auth.termsOfUse")),1)]),_:1})]),privacy:c(()=>[g(U,{to:"/privacy",target:"_blank",class:"text-primary hover:underline"},{default:c(()=>[f(o(e.$t("auth.privacyPolicy")),1)]),_:1})]),_:1})])):p("",!0),g(y,{type:"submit",class:"h-12 w-full text-base",disabled:t(h)||!t(j)},{default:c(()=>[f(o(t(h)?e.$t("common.processing"):a.scene==="sign-up"?e.$t("auth.signUp"):e.$t("auth.signIn")),1)]),_:1},8,["disabled"])]))])),a.scene==="sign-in"&&!t(w)?.config.registration_enabled?p("",!0):(n(),i("div",Ue,[f(o(a.scene==="sign-up"?e.$t("auth.hasAccount"):e.$t("auth.noAccount"))+" ",1),l("button",{type:"button",onClick:G,class:"hover:text-primary underline underline-offset-4"},o(a.scene==="sign-up"?e.$t("auth.signInNow"):e.$t("auth.signUpNow")),1)]))],34)}}}),Te=Object.assign(Ce,{__name:"AuthForm"});export{Te as _};
