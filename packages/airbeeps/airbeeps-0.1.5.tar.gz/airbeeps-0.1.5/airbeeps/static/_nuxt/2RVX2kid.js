import{R as B,h as H,e as O,E as y,H as $,m as L,c as m,o as f,a as l,I as w,y as q,M as A,b as E,g as i,t as b,d as I,a1 as J,D as M}from"./BzhixHsn.js";import{U as j}from"./C-9Ampo3.js";import{T as W}from"./C-xhCs27.js";const X=B("user",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]]),G={class:"space-y-4"},K={class:"flex items-center space-x-4"},Q=["disabled"],Y={key:0,class:"text-center"},Z={class:"text-xs text-gray-500"},ee=["src","alt"],ae={key:2,class:"bg-opacity-50 absolute inset-0 flex items-center justify-center rounded-full bg-black"},te={class:"flex flex-col space-y-2"},oe=["disabled"],se=["disabled"],re={key:0,class:"text-xs text-gray-500"},le={key:1,class:"space-y-2"},ne={class:"flex items-center justify-between text-sm"},de={class:"h-2 w-full rounded-full bg-gray-200"},ie={key:2,class:"text-sm text-red-600"},ce=H({__name:"AvatarUpload",props:{modelValue:{default:null},initialUrl:{default:null},disabled:{type:Boolean,default:!1},placeholder:{default:""},required:{type:Boolean,default:!1}},emits:["update:modelValue","upload-success","upload-error"],setup(h,{expose:N,emit:R}){const{t}=O(),n=h,_=R,U=y(),o=y(""),g=y(""),c=y(!1),x=y(0),p=y(""),C=y(!1),k=()=>{!n.disabled&&!c.value&&U.value?.click()},S=e=>{if(!e.type.startsWith("image/"))return t("components.avatarUpload.error.type");const a=2*1024*1024;return e.size>a?t("components.avatarUpload.error.size"):null},T=async e=>{const a=new FormData;a.append("file",e),a.append("file_type","avatar");const{$api:d}=M();return new Promise((s,u)=>{const r=new XMLHttpRequest;r.upload.addEventListener("progress",v=>{v.lengthComputable&&(x.value=Math.round(v.loaded/v.total*100))}),r.addEventListener("load",()=>{if(r.status>=200&&r.status<300)try{const v=JSON.parse(r.responseText);s(v)}catch{u(new Error(t("components.avatarUpload.error.parse")))}else try{const v=JSON.parse(r.responseText);u(new Error(v.message||t("components.avatarUpload.error.upload",{status:r.status})))}catch{u(new Error(t("components.avatarUpload.error.upload",{status:r.status})))}}),r.addEventListener("error",()=>{u(new Error(t("components.avatarUpload.error.network")))}),r.addEventListener("timeout",()=>{u(new Error(t("components.avatarUpload.error.timeout")))}),r.addEventListener("abort",()=>{u(new Error(t("components.avatarUpload.error.cancel")))}),r.open("POST","/api/v1/files/upload"),r.timeout=3e4,r.setRequestHeader("Accept","application/json"),r.send(a)})},P=async e=>{const d=e.target.files?.[0];d&&await D(d)},z=async e=>{if(C.value=!1,n.disabled||c.value)return;const d=e.dataTransfer?.files?.[0];d&&await D(d)},D=async e=>{p.value="";const a=S(e);if(a){p.value=a;return}const d=new FileReader;d.onload=s=>{o.value=s.target?.result,g.value=e.name},d.readAsDataURL(e);try{c.value=!0,x.value=0;const s=await T(e);_("update:modelValue",s.file_path),_("upload-success",s),o.value=s.url,g.value=s.filename}catch(s){const u=s instanceof Error?s.message:t("components.avatarUpload.error.generic");p.value=u,_("upload-error",u),o.value="",g.value=""}finally{c.value=!1,x.value=0}},F=()=>{n.disabled||c.value||(o.value="",g.value="",p.value="",_("update:modelValue",null),U.value&&(U.value.value=""))},V=async e=>{try{const{$api:a}=M(),d=encodeURIComponent(e),s=await a(`/v1/files/url/${d}`);s&&s.url&&(o.value=s.url,g.value=s.filename||"")}catch(a){console.warn("Failed to load avatar preview:",a)}};return $(()=>{n.modelValue&&(n.initialUrl?o.value=n.initialUrl:V(n.modelValue))}),L(()=>n.modelValue,async e=>{if(!e){o.value="",g.value="";return}if(n.initialUrl&&!o.value){o.value=n.initialUrl;return}e&&!o.value&&V(e)}),L(()=>n.initialUrl,e=>{e&&!o.value&&(o.value=e)}),N({removeAvatar:F,triggerFileInput:k}),(e,a)=>(f(),m("div",G,[l("div",K,[l("div",{onClick:k,onDragover:a[0]||(a[0]=A(()=>{},["prevent"])),onDrop:A(z,["prevent"]),class:q(["relative flex h-20 w-20 cursor-pointer items-center justify-center overflow-hidden rounded-full border-2 border-dashed border-gray-300 bg-gray-50 transition-colors hover:border-gray-400",{"border-red-500":p.value,"border-blue-500":C.value,"cursor-not-allowed opacity-50":h.disabled}])},[l("input",{ref_key:"fileInput",ref:U,type:"file",accept:"image/*",class:"hidden",onChange:P,disabled:h.disabled},null,40,Q),o.value?(f(),m("img",{key:1,src:o.value,alt:i(t)("components.avatarUpload.previewAlt"),class:"h-full w-full object-cover"},null,8,ee)):(f(),m("div",Y,[E(i(X),{class:"mx-auto mb-1 h-8 w-8 text-gray-400"}),l("div",Z,b(i(t)("components.avatarUpload.label")),1)])),c.value?(f(),m("div",ae,[...a[1]||(a[1]=[l("div",{class:"h-6 w-6 animate-spin rounded-full border-2 border-white border-t-transparent"},null,-1)])])):w("",!0)],34),l("div",te,[l("button",{type:"button",onClick:k,disabled:h.disabled||c.value,class:"rounded-md border border-gray-300 px-3 py-1.5 text-sm transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-50"},[E(i(j),{class:"mr-1 inline h-4 w-4"}),I(" "+b(c.value?i(t)("components.avatarUpload.uploading"):o.value?i(t)("components.avatarUpload.change"):i(t)("components.avatarUpload.select")),1)],8,oe),o.value?(f(),m("button",{key:0,type:"button",onClick:F,disabled:h.disabled||c.value,class:"rounded-md border border-red-300 px-3 py-1.5 text-sm text-red-600 transition-colors hover:bg-red-50 disabled:cursor-not-allowed disabled:opacity-50"},[E(i(W),{class:"mr-1 inline h-4 w-4"}),I(" "+b(i(t)("components.avatarUpload.remove")),1)],8,se)):w("",!0)])]),!o.value&&!p.value?(f(),m("div",re,b(h.placeholder||i(t)("components.avatarUpload.placeholder")),1)):w("",!0),c.value?(f(),m("div",le,[l("div",ne,[l("span",null,b(i(t)("components.avatarUpload.uploading")),1),l("span",null,b(x.value)+"%",1)]),l("div",de,[l("div",{class:"h-2 rounded-full bg-blue-600 transition-all duration-300",style:J({width:`${x.value}%`})},null,4)])])):w("",!0),p.value?(f(),m("div",ie,b(p.value),1)):w("",!0)]))}}),me=Object.assign(ce,{__name:"AvatarUpload"});export{X as U,me as _};
