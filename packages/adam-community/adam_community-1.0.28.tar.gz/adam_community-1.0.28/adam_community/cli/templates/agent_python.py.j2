from adam_community.tool import Tool
from adam_community.util import runCmd
import json
import datetime


# è¾“å‡ºå¤„ç†å¸¸é‡
MAX_OUTPUT_LENGTH = 10000
TRUNCATE_PREFIX_LENGTH = 5000
TRUNCATE_SUFFIX_LENGTH = 5000
SUMMARY_STDOUT_LENGTH = 300
SUMMARY_STDERR_LENGTH = 200


def truncate_output(text):
    """æˆªæ–­è¿‡é•¿çš„è¾“å‡ºæ–‡æœ¬ã€‚
    
    Args:
        text (str): éœ€è¦æˆªæ–­çš„æ–‡æœ¬
        
    Returns:
        str: æˆªæ–­åçš„æ–‡æœ¬
    """
    if len(text) <= MAX_OUTPUT_LENGTH:
        return text
    return (text[:TRUNCATE_PREFIX_LENGTH] + 
            "\n...è¾“å‡ºå¤ªé•¿å·²çœç•¥...\n" + 
            text[-TRUNCATE_SUFFIX_LENGTH:])


def get_status_info(exit_code):
    """è·å–æ‰§è¡ŒçŠ¶æ€ä¿¡æ¯ã€‚
    
    Args:
        exit_code (int): é€€å‡ºç 
        
    Returns:
        tuple: (çŠ¶æ€å›¾æ ‡, çŠ¶æ€æ–‡æœ¬) å…ƒç»„
    """
    if exit_code == 0:
        return "âœ…", "æˆåŠŸ"
    return "âŒ", "å¤±è´¥"


def format_output_display(stdout, stderr, exit_code, tool_display_name):
    """æ ¼å¼åŒ–è¾“å‡ºæ˜¾ç¤ºæ–‡æœ¬ã€‚
    
    Args:
        stdout (str): æ ‡å‡†è¾“å‡º
        stderr (str): é”™è¯¯è¾“å‡º
        exit_code (int): é€€å‡ºç 
        tool_display_name (str): å·¥å…·æ˜¾ç¤ºåç§°
        
    Returns:
        str: æ ¼å¼åŒ–çš„Markdownæ–‡æœ¬
    """
    status_icon, status_text = get_status_info(exit_code)
    
    display_parts = [
        f"## {status_icon} {tool_display_name}å¤„ç†{status_text}",
        "",
        "### ğŸ“‹ å¤„ç†ç»“æœ",
        f"- é€€å‡ºç : {exit_code}",
        "- æ ‡å‡†è¾“å‡º:",
        "```",
        stdout,
        "```"
    ]
    
    if stderr:
        display_parts.extend([
            "",
            "### âš ï¸ é”™è¯¯/è­¦å‘Šä¿¡æ¯",
            "```",
            stderr,
            "```"
        ])
    
    return "\n".join(display_parts)


def generate_summary(stdout, stderr, exit_code, tool_name):
    """ç”Ÿæˆæ‰§è¡Œç»“æœæ‘˜è¦ã€‚
    
    Args:
        stdout (str): æ ‡å‡†è¾“å‡º
        stderr (str): é”™è¯¯è¾“å‡º
        exit_code (int): é€€å‡ºç 
        tool_name (str): å·¥å…·åç§°
        
    Returns:
        str: æ‰§è¡Œæ‘˜è¦æ–‡æœ¬
    """
    if exit_code != 0:
        summary = f"{tool_name}æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç : {exit_code}ï¼‰ã€‚"
        if stderr:
            summary += f" é”™è¯¯ä¿¡æ¯: {stderr[:SUMMARY_STDERR_LENGTH]}"
        return summary
    
    if stderr:
        summary = f"{tool_name}æ‰§è¡Œå®Œæˆä½†æœ‰è­¦å‘Šã€‚"
        summary += f" è¾“å‡º: {stdout[:SUMMARY_STDERR_LENGTH]}"
        summary += f" è­¦å‘Š: {stderr[:SUMMARY_STDERR_LENGTH]}"
        return summary
    
    summary = f"{tool_name}æ‰§è¡ŒæˆåŠŸã€‚"
    summary += f" è¾“å‡ºæ‘˜è¦: {stdout[:SUMMARY_STDOUT_LENGTH]}"
    return summary


class {{ name.replace("-", "_") }}_tool(Tool):
    """
    {{ description }}
    
    Args:
        input_text (str): è¾“å…¥çš„æ–‡æœ¬å†…å®¹
        mode (str, optional): å¤„ç†æ¨¡å¼ï¼Œå¯é€‰å€¼ï¼šbasicã€advanced
    """
    DISPLAY_NAME = "{{ display_name }}å·¥å…·"
    NETWORK = False
    CPU = 1
    GPU = 0
    SIF = "adam-base:1.0.0"
    
    # è¾“å‡ºæ–‡ä»¶é…ç½®
    OUTPUT_FILE = "output.txt"

    def inputShow(self, **kwargs):
        """AIå†³å®šä½¿ç”¨è¯¥å·¥å…·æ—¶è°ƒç”¨ï¼Œç”¨äºå‘ç”¨æˆ·å±•ç¤ºå½“å‰è°ƒç”¨çš„å·¥å…·ä¿¡æ¯ã€‚
        
        Args:
            kwargs (dict): åŒ…å«argsã€messageã€filesã€userã€task_idç­‰å‚æ•°çš„å­—å…¸ã€‚
        
        Returns:
            str: ç»™ç”¨æˆ·æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ï¼ˆå¯ä½¿ç”¨markdownæ¸²æŸ“ï¼‰ã€‚
        """
        args = kwargs['args']
        input_text = args['input_text']
        mode = args.get('mode', 'basic')
        
        show_text = f"æ­£åœ¨ä½¿ç”¨ {{ display_name }} å·¥å…·å¤„ç†æ–‡æœ¬å†…å®¹"
        if mode == 'advanced':
            show_text += "ï¼ˆé«˜çº§æ¨¡å¼ï¼‰"
        
        return Tool.markdown_terminal(
            show_text,
            workdir=kwargs.get("task_id", ""),
            user=kwargs.get("user", "Adam"),
            conda_env=getattr(self, "CONDA_ENV", "base")
        )

    def call(self, kwargs):
        """Tool é€»è¾‘å®ç°å‡½æ•°"""    
        args = kwargs['args']
        input_text = args['input_text']
        mode = args.get('mode', 'basic')
        
        # TODO: åœ¨è¿™é‡Œå®ç°ä½ çš„ä¸»è¦é€»è¾‘
        if mode == 'advanced':
            result = f"é«˜çº§æ¨¡å¼å¤„ç†: {input_text}"
        else:
            result = f"åŸºç¡€æ¨¡å¼å¤„ç†: {input_text}"
        
        # ç”Ÿæˆbashå‘½ä»¤
        bash_script = f'''# {{ display_name }} å¤„ç†è„šæœ¬
echo "å¼€å§‹å¤„ç†: {input_text}"
echo "å¤„ç†æ¨¡å¼: {mode}"

# TODO: åœ¨è¿™é‡Œæ·»åŠ å®é™…çš„å¤„ç†å‘½ä»¤
echo "{result}"

# ç”Ÿæˆè¾“å‡ºæ–‡ä»¶
echo "å¤„ç†å®Œæˆ" > {self.OUTPUT_FILE}
echo "ç»“æœ: {result}" >> {self.OUTPUT_FILE}

echo "å¤„ç†å®Œæˆï¼Œç»“æœå·²ä¿å­˜åˆ° {self.OUTPUT_FILE}"
'''
        
        return runCmd(bash_script)
    
    def outputShow(self, kwargs):
        """ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ï¼Œç”¨äºå‘ç”¨æˆ·å±•ç¤ºå·¥å…·æ‰§è¡Œç»“æœã€‚
        
        Args:
            kwargs (dict): åŒ…å«stdoutã€stderrã€exit_codeç­‰æ‰§è¡Œç»“æœçš„å­—å…¸ã€‚
        
        Returns:
            tuple: (ç”¨æˆ·æ˜¾ç¤ºå­—ç¬¦ä¸², æ–‡ä»¶åˆ—è¡¨) å…ƒç»„ã€‚
                - ç”¨æˆ·æ˜¾ç¤ºå­—ç¬¦ä¸² (str): æ ¼å¼åŒ–çš„æ˜¾ç¤ºæ–‡æœ¬
                - æ–‡ä»¶åˆ—è¡¨ (list): ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¼šåœ¨å‰ç«¯æä¾›ä¸‹è½½
        """
        stdout = truncate_output(kwargs.get('stdout', ''))
        stderr = truncate_output(kwargs.get('stderr', ''))
        exit_code = kwargs.get('exit_code', 0)
        
        display_text = format_output_display(
            stdout, stderr, exit_code, "{{ display_name }} "
        )
        
        # æ ¹æ®æ‰§è¡Œç»“æœåˆ¤æ–­ç”Ÿæˆçš„æ–‡ä»¶
        file_list = []
        if exit_code == 0 or self.OUTPUT_FILE in kwargs.get('stdout', ''):
            file_list.append(self.OUTPUT_FILE)
        
        return display_text, file_list
    
    def summary(self, kwargs):
        """ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ï¼Œç”¨äºå‘AIæä¾›æ‰§è¡Œç»“æœæ‘˜è¦ã€‚
        
        Args:
            kwargs (dict): åŒ…å«stdoutã€stderrã€exit_codeç­‰æ‰§è¡Œç»“æœçš„å­—å…¸ã€‚
        
        Returns:
            str: ç»™AIçš„æ–‡æœ¬æ‘˜è¦ï¼Œåº”ç®€æ´æ˜äº†ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿ã€‚
        """
        stdout = truncate_output(kwargs.get('stdout', ''))
        stderr = truncate_output(kwargs.get('stderr', ''))
        exit_code = kwargs.get('exit_code', 0)
        
        return generate_summary(
            stdout, stderr, exit_code, "{{ display_name }}å·¥å…·"
        )


class {{ name.replace("-", "_") }}_advanced_tool(Tool, calltype="python"):    
    """{{ description }} - é«˜çº§åŠŸèƒ½
    
    Args:
        input_file (str): è¾“å…¥æ–‡ä»¶è·¯å¾„
        output_format (str): è¾“å‡ºæ ¼å¼ï¼Œå¯é€‰å€¼ï¼šjsonã€csvã€txt
    """    
    DISPLAY_NAME = "{{ display_name }}é«˜çº§å·¥å…·"
    NETWORK = False
    CPU = 1
    GPU = 0
    SIF = "adam-base:1.0.0"
    CONDA_ENV = "base"
    
    # è¾“å‡ºæ–‡ä»¶é…ç½®
    OUTPUT_FILE = "result.json"
    DEFAULT_OUTPUT_FORMAT = "json"

    def inputShow(self, **kwargs):
        """AIå†³å®šä½¿ç”¨è¯¥å·¥å…·æ—¶è°ƒç”¨ï¼Œç”¨äºå‘ç”¨æˆ·å±•ç¤ºå½“å‰è°ƒç”¨çš„å·¥å…·ä¿¡æ¯ã€‚
        
        Args:
            kwargs (dict): åŒ…å«argsã€messageã€filesã€userã€task_idç­‰å‚æ•°çš„å­—å…¸ã€‚
        
        Returns:
            str: ç»™ç”¨æˆ·æ˜¾ç¤ºçš„å­—ç¬¦ä¸²ï¼ˆå¯ä½¿ç”¨markdownæ¸²æŸ“ï¼‰ã€‚
        """
        args = kwargs['args']
        input_file = args['input_file']
        output_format = args.get('output_format', self.DEFAULT_OUTPUT_FORMAT)
        
        show_text = (f"æ­£åœ¨ä½¿ç”¨ {{ display_name }} é«˜çº§å·¥å…·å¤„ç†æ–‡ä»¶: {input_file}"
                    f"ï¼ˆè¾“å‡ºæ ¼å¼: {output_format}ï¼‰")
        
        return Tool.markdown_terminal(
            show_text,
            workdir=kwargs.get("task_id", ""),
            user=kwargs.get("user", "Adam"),
            conda_env=self.CONDA_ENV
        )
    
    def call(self, kwargs):    
        """Tool é€»è¾‘å®ç°å‡½æ•°"""
        args = kwargs['args']
        input_file = args['input_file']
        output_format = args.get('output_format', self.DEFAULT_OUTPUT_FORMAT)
        
        # TODO: åœ¨è¿™é‡Œå®ç°ä½ çš„Pythoné€»è¾‘
        result = {
            'input_file': input_file,
            'output_format': output_format,
            'processed_at': datetime.datetime.now().isoformat(),
            'result': 'Pythonå·¥å…·å¤„ç†å®Œæˆ'
        }
        
        # å¯¹äºPythonå·¥å…·ï¼Œå¿…é¡»ä½¿ç”¨printè¾“å‡ºç»“æœ
        print(f"Pythonå·¥å…·å¤„ç†å®Œæˆï¼Œè¾“å…¥æ–‡ä»¶: {input_file}")
        print(f"è¾“å‡ºæ ¼å¼: {output_format}")
        print(f"å¤„ç†ç»“æœ: {result}")
        
        # ç”Ÿæˆè¾“å‡ºæ–‡ä»¶
        if output_format == 'json':
            with open(self.OUTPUT_FILE, 'w', encoding='utf-8') as f:
                json.dump(result, f, indent=2, ensure_ascii=False)
            print(f"ç»“æœå·²ä¿å­˜åˆ° {self.OUTPUT_FILE}")
    
    def outputShow(self, kwargs):
        """ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ï¼Œç”¨äºå‘ç”¨æˆ·å±•ç¤ºå·¥å…·æ‰§è¡Œç»“æœã€‚
        
        Args:
            kwargs (dict): åŒ…å«stdoutã€stderrã€exit_codeç­‰æ‰§è¡Œç»“æœçš„å­—å…¸ã€‚
        
        Returns:
            tuple: (ç”¨æˆ·æ˜¾ç¤ºå­—ç¬¦ä¸², æ–‡ä»¶åˆ—è¡¨) å…ƒç»„ã€‚
                - ç”¨æˆ·æ˜¾ç¤ºå­—ç¬¦ä¸² (str): æ ¼å¼åŒ–çš„æ˜¾ç¤ºæ–‡æœ¬
                - æ–‡ä»¶åˆ—è¡¨ (list): ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨ï¼Œä¼šåœ¨å‰ç«¯æä¾›ä¸‹è½½
        """
        stdout = truncate_output(kwargs.get('stdout', ''))
        stderr = truncate_output(kwargs.get('stderr', ''))
        exit_code = kwargs.get('exit_code', 0)
        
        display_text = format_output_display(
            stdout, stderr, exit_code, "{{ display_name }} é«˜çº§å·¥å…·"
        )
        
        # æ ¹æ®è¾“å‡ºæ ¼å¼åˆ¤æ–­ç”Ÿæˆçš„æ–‡ä»¶
        file_list = []
        args = kwargs.get('args', {})
        output_format = args.get('output_format', self.DEFAULT_OUTPUT_FORMAT)
        if output_format == 'json' and exit_code == 0:
            file_list.append(self.OUTPUT_FILE)
        
        return display_text, file_list
    
    def summary(self, kwargs):
        """ä»»åŠ¡ç»“æŸæ—¶è°ƒç”¨ï¼Œç”¨äºå‘AIæä¾›æ‰§è¡Œç»“æœæ‘˜è¦ã€‚
        
        Args:
            kwargs (dict): åŒ…å«stdoutã€stderrã€exit_codeç­‰æ‰§è¡Œç»“æœçš„å­—å…¸ã€‚
        
        Returns:
            str: ç»™AIçš„æ–‡æœ¬æ‘˜è¦ï¼Œåº”ç®€æ´æ˜äº†ï¼Œé¿å…ä¸Šä¸‹æ–‡è¿‡é•¿ã€‚
        """
        stdout = truncate_output(kwargs.get('stdout', ''))
        stderr = truncate_output(kwargs.get('stderr', ''))
        exit_code = kwargs.get('exit_code', 0)
        
        return generate_summary(
            stdout, stderr, exit_code, "{{ display_name }}é«˜çº§å·¥å…·"
        )
