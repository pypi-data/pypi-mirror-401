from adam_community.tool import Tool
from adam_community.util import runCmd
from datetime import datetime

class runner(Tool):
    """
    {{ description }}
    
    :param str input_text: è¾“å…¥çš„æ–‡æœ¬å†…å®¹
    """
    
    DISPLAY_NAME = "{{ display_name }}"
    NETWORK = False  # æ ¹æ®éœ€è¦è®¾ç½®æ˜¯å¦éœ€è¦ç½‘ç»œè®¿é—®
    CPU = 1  # éœ€è¦çš„CPUæ•°é‡
    GPU = 0  # éœ€è¦çš„GPUæ•°é‡
    SIF = "adam-base:1.0.0"  # æŒ‡å®šå®¹å™¨é•œåƒï¼ˆå¿…å¡«ï¼‰
    
    def call(self, kwargs):
        """
        å·¥å…·çš„ä¸»è¦å®ç°å‡½æ•°
        
        Args:
            kwargs: åŒ…å«argsã€messageã€filesã€userã€task_idç­‰å‚æ•°çš„å­—å…¸
        
        Returns:
            æ‰§è¡Œç»“æœ
        """
        # è·å–ç”¨æˆ·è¾“å…¥çš„å‚æ•°
        input_text = kwargs['args']['input_text']
        
        # TODO: åœ¨è¿™é‡Œå®ç°ä½ çš„ä¸»è¦é€»è¾‘
        # ç¤ºä¾‹ï¼šç®€å•çš„æ–‡æœ¬å¤„ç†
        processed_text = f"å¤„ç†åçš„æ–‡æœ¬: {input_text}"
        
        # ç”ŸæˆæŠ¥å‘Šï¼ˆkitç±»å‹çš„å·¥å…·éœ€è¦ç”Ÿæˆreport.mdæ–‡ä»¶ï¼‰
        report_content = f"""# {{ display_name }} å¤„ç†æŠ¥å‘Š

## è¾“å…¥å†…å®¹
{input_text}

## å¤„ç†ç»“æœ
{processed_text}

## å¤„ç†æ—¶é—´
{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## ä½œè€…
{{ author }}
"""
        
        # å†™å…¥æŠ¥å‘Šæ–‡ä»¶
        with open('./report.md', 'w', encoding='utf-8') as f:
            f.write(report_content)
        
        print(f"å¤„ç†å®Œæˆï¼Œè¾“å…¥æ–‡æœ¬: {input_text}")
        print(f"å¤„ç†ç»“æœ: {processed_text}")
        print("æŠ¥å‘Šå·²ç”Ÿæˆ: report.md")
        
        return processed_text
    
    def outputShow(self, kwargs):
        """
        è‡ªå®šä¹‰è¾“å‡ºæ˜¾ç¤ºæ ¼å¼ï¼ˆå¯é€‰ï¼‰
        
        Args:
            kwargs: åŒ…å«stdoutã€stderrã€exitcodeç­‰çš„å‚æ•°å­—å…¸
            
        Returns:
            (display_text, file_list): æ˜¾ç¤ºæ–‡æœ¬å’Œæ–‡ä»¶åˆ—è¡¨çš„å…ƒç»„
        """
        output = kwargs.get('stdout', '')
        
        # è‡ªå®šä¹‰è¾“å‡ºæ ¼å¼
        display_text = f"""## ğŸ‰ å¤„ç†å®Œæˆ

### ğŸ“‹ å¤„ç†ç»“æœ
```
{output}
```

### ğŸ“„ ç”Ÿæˆæ–‡ä»¶
- report.md: è¯¦ç»†å¤„ç†æŠ¥å‘Š
"""
        
        # è¿”å›ç”Ÿæˆçš„æ–‡ä»¶åˆ—è¡¨
        file_list = ['report.md']
        
        return display_text, file_list
    
    def summary(self, kwargs):
        """
        ä¸ºAIç”Ÿæˆç®€çŸ­çš„æ‰§è¡Œæ‘˜è¦ï¼ˆå¯é€‰ï¼‰
        
        Args:
            kwargs: åŒ…å«stdoutã€stderrã€exitcodeç­‰çš„å‚æ•°å­—å…¸
            
        Returns:
            str: æ‰§è¡Œæ‘˜è¦æ–‡æœ¬
        """
        output = kwargs.get('stdout', '')
        
        if kwargs.get('stderr'):
            return f"å·¥å…·æ‰§è¡Œå®Œæˆä½†æœ‰è­¦å‘Š: {output}ã€‚è­¦å‘Šä¿¡æ¯: {kwargs['stderr']}"
        else:
            return f"å·¥å…·æ‰§è¡ŒæˆåŠŸ: {output}"