[build-system]
requires = [
    "scikit-build-core>=0.10.0",
    "pybind11>=3.0.1",

    # Comments on numpy build requirement range:
    #
    #   1. >=2.0.x is the numpy requirement for wheel builds for distribution
    #      on PyPI - building against 2.x yields wheels that are also
    #      ABI-compatible with numpy 1.x at runtime.
    #   2. Note that building against numpy 1.x works fine too - users and
    #      redistributors can do this by installing the numpy version they like
    #      and disabling build isolation.
    #   3. The <3 upper bound is to pre-empt problems with the next major release.
    "numpy>=2.0.0rc1,<3",

    "pybind11-stubgen",
    "ruff",
    "typing_extensions >= 4.5.0; python_version < '3.13'",
]
build-backend = "scikit_build_core.build"

[project.urls]
homepage = "https://www.tango-controls.org/"
documentation = "https://pytango.readthedocs.io"
repository = "https://gitlab.com/tango-controls/pytango.git"
changelog = "https://gitlab.com/tango-controls/pytango/-/releases"

[project]
name = "pytango"
version = "10.1.2"
description = "Python bindings for the cppTango library; part of the Tango Distributed Control System toolkit"
readme = "README.rst"
requires-python = ">=3.10"
authors = [
    {'name' = "Coutinho"}]
maintainers = [
    {"name" = "Anton Joubert"},
    {"name" = "Yury Matveyev"}]
classifiers = [
        "Development Status :: 5 - Production/Stable",
        "Environment :: Other Environment",
        "Intended Audience :: Developers",
        "License :: OSI Approved :: GNU Library or Lesser General Public License (LGPL)",
        "Natural Language :: English",
        "Operating System :: Microsoft :: Windows",
        "Operating System :: MacOS",
        "Operating System :: POSIX",
        "Operating System :: POSIX :: Linux",
        "Operating System :: Unix",
        "Programming Language :: C",
        "Programming Language :: Python",
        "Programming Language :: Python :: 3.10",
        "Programming Language :: Python :: 3.11",
        "Programming Language :: Python :: 3.12",
        "Programming Language :: Python :: 3.13",
        "Programming Language :: Python :: 3.14",
        "Topic :: Scientific/Engineering",
        "Topic :: Software Development :: Libraries",
    ]

dependencies = [
    "numpy (>=1.19.3,<3)",
    "packaging",
    "psutil >=5.3.0",
    "typing_extensions >= 4.5.0; python_version < '3.13'",

    # Note: docstring_parser dependency is needed for full functionallity,
    # but it could be removed without any additional changes
    "docstring_parser"
]

[project.optional-dependencies]
telemetry = [
    "opentelemetry-api",
    "opentelemetry-sdk",
    "opentelemetry-exporter-otlp-proto-grpc",
    "opentelemetry-exporter-otlp-proto-http",
]
tests = [
    "gevent >= 20.0",
    "pytest",
    "pytest-asyncio >=0.24",
    "pytest-cov>=7.0.0",
    "pytest-env",
    "pytest-forked",
    "pytest-timeout",
]

[tool.scikit-build]
cmake.version = "CMakeLists.txt"
minimum-version = "build-system.requires"
build.verbose = true
wheel.packages = ["tango", "tango.databaseds", "tango.databaseds.db_access", "PyTango"]
install.strip = false
sdist.include = ["*.pyi"] # .pyi files are not included in sdist (they are generated in build step) this option is using to include .pyi in binary dits

[tool.scikit-build.cmake.define]
# Put CMake defines in this table.
# Can also be set as cmake cache variables through the CMAKE_ARGS environment variable:
# e.g.: CMAKE_ARGS="-DTANGO_ROOT=/path/to/installed/cpptango" python3 -m build
# TANGO_ROOT="/path/to/installed/tango.9.4"
Tango_USE_PKG_CONFIG="OFF"

[tool.pytest.ini_options]
# see also pytest_win_config.toml
asyncio_default_fixture_loop_scope = "function"
addopts = "-v --showlocals --forked"
env = ["PYTANGO_TESTS_RUNNING=True"]
filterwarnings = ["error", "ignore::ResourceWarning"]
testpaths = [
    "tests"
]
log_format = "%(threadName)-14s %(levelname)-8s %(asctime)s %(name)s: %(message)s"
log_date_format = "%Y-%m-%d %H:%M:%S,%f"
log_level = "DEBUG"

[tool.coverage.run]
branch = true
core = "ctrace"
source = ["tango", "PyTango", "tests"]
omit = [
    # environment files
    "*/.pixi/*",
    # deprecated modules
    "tango/client.py",
    "tango/codec.py",
    "tango/tango_object.py",
]
patch = ["subprocess", "fork", "_exit"]

[tool.ruff]
exclude = [
    ".git",
    "__pycache__",
    ".eggs",
    "*.egg",
    "*.pyi",
    "build",
    "databaseds",
    "examples",
    "doc",
]

[tool.ruff.lint]
ignore = [
    "E402",  # Module level import not at top of file
    "E501",  # Line too long (> 79 characters)
    "E731",  # Do not assign a lambda expression, use a def
]
select = [
    "E",  # pycodestyle errors
    "W",  # pycodestyle warnings
    "F",  # pyflakes
]
