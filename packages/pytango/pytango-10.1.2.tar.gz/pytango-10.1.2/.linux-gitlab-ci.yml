.matrix-wheel-linux:
  image: ${IMAGE_REGISTRY}:${MANYLINUX}_${ARCH}_v${LINUX_WHEEL_DOCKER_IMAGE_VERSION}
  tags:
    - linux
    - docker
    - $RUNNER_TAG
  variables:
    IMAGE_REGISTRY: registry.gitlab.com/tango-controls/docker/pytango-builder
    MANYLINUX: manylinux2014
    GLIBC_TAG: '2_17' # depends on manylinux
    PYTHON_TAG: 'cp${PYTHON_VER}-cp${PYTHON_VER}'
    WHEEL_GLOB_PATTERN: pytango-*${PYTHON_TAG}*${ARCH}.whl
  parallel:
    matrix:
      - RUNNER_TAG: amd64
        ARCH: [x86_64, i686]
        PYTHON_VER: [310, 311, 312, 313]
      # Skip i686 for Python >=3.14
      - RUNNER_TAG: amd64
        ARCH: [x86_64]
        PYTHON_VER: [314]
      - RUNNER_TAG: aarch64
        ARCH: aarch64
        PYTHON_VER: [310, 311, 312, 313, 314]

linux:build-wheel:
  extends: [.matrix-wheel-linux, .build-wheel]
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  script:
    # build wheel
    - |
      /opt/python/${PYTHON_TAG}/bin/python -m pip install build
      /opt/python/${PYTHON_TAG}/bin/python -m build --wheel --config-setting=cmake.build-type="RelWithDebInfo" --config-setting=cmake.args="--preset=ci-Linux-wheel"
    # repair wheel, keeping any debug symbols (output will be in the 'wheelhouse' directory)
    - auditwheel repair dist/${WHEEL_GLOB_PATTERN}
    # move repaired debug wheel into its own directory
    - mv wheelhouse debug_dist
    # repair wheel again, but this time strip all debug symbols (output will be in the 'wheelhouse' directory)
    - auditwheel repair --strip dist/${WHEEL_GLOB_PATTERN}
    # delete unrepaired wheel
    - rm -rf dist/*.whl
    # move repaired wheel to dist
    - mv wheelhouse/*.whl dist/

linux:build-wheel-against-specific-branch:
  stage: build
  when: manual
  image: ${IMAGE_REGISTRY}:${MANYLINUX}_${ARCH}_v${LINUX_WHEEL_DOCKER_IMAGE_VERSION}
  tags:
    - linux
    - docker
    - $RUNNER_TAG
  variables:
    RUNNER_TAG: amd64
    ARCH: x86_64
    PYTHON_VER: 314
    IMAGE_REGISTRY: registry.gitlab.com/tango-controls/docker/pytango-builder
    MANYLINUX: manylinux2014
    GLIBC_TAG: '2_17' # depends on manylinux
    PYTHON_TAG: 'cp${PYTHON_VER}-cp${PYTHON_VER}'
    WHEEL_GLOB_PATTERN: pytango-*${PYTHON_TAG}*${ARCH}.whl
    IDL_SOURCE: "main"
    CPPTANGO_SOURCE: "main"
    GIT_SUBMODULE_STRATEGY: recursive
  before_script:
    # Build and install dependencies
    # check which idl should we use and install it
    - |
      echo "Building and installing idl from ${IDL_SOURCE} branch"
      pushd /tmp
      git clone --recurse-submodules --depth 1 -b $IDL_SOURCE https://gitlab.com/tango-controls/tango-idl
      cd tango-idl
      cmake -B build
      make -C build install
      popd
    # check which cpptango should we use and install it
    - |
      echo "Building and installing cpptango from ${CPPTANGO_SOURCE} branch"
      pushd /tmp
      git clone --recurse-submodules --depth 1 -b $CPPTANGO_SOURCE https://gitlab.com/tango-controls/cppTango
      cd cppTango
      mkdir build
      cd build
      cmake ${CMAKE_ARGS} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON -DBUILD_TESTING=OFF -DCMAKE_CXX_STANDARD=17 -DTANGO_USE_TELEMETRY=ON ..
      make
      make install
      popd
  script:
    # build wheel
    - |
      /opt/python/${PYTHON_TAG}/bin/python -m pip install build
      /opt/python/${PYTHON_TAG}/bin/python -m build --wheel --config-setting=cmake.build-type="RelWithDebInfo" --config-setting=cmake.args="--preset=ci-Linux-wheel"
    # repair wheel, keeping any debug symbols (output will be in the 'wheelhouse' directory)
    - auditwheel repair dist/${WHEEL_GLOB_PATTERN}
    # move repaired debug wheel into its own directory
    - mv wheelhouse debug_dist
  artifacts:
    expire_in: 1 day
    paths:
      - debug_dist/


linux:build-sdist:
  stage: build
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  image: quay.io/condaforge/miniforge3:latest
  tags:
    - linux
    - docker
    - amd64
  before_script:
    - pip install twine build
  script:
    - python -m build --sdist
    - twine check dist/*
  artifacts:
    expire_in: 1 day
    paths:
      - dist/

linux:test-source:
  stage: test
  image: registry.gitlab.com/tango-controls/docker/micromamba:2.3.0
  tags:
    - linux
    - docker
    - amd64
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
  # Avoid job to wait on wheels building
  needs: [linux:build-sdist]
  before_script:
    - ulimit -c unlimited
    - eval "$(/bin/micromamba shell hook -s bash)"
    # Install build and test dependencies
    - >
      micromamba install -y -n base -c conda-forge
      "pybind11>=3.0.1" cppzmq cxx-compiler pkg-config
      python=$PYTHON_VERSION numpy "gcovr>=8.3" "lxml>=6" git make
      packaging psutil typing_extensions pytest pytest-asyncio pytest-forked pytest-cov pytest-timeout pystack gevent
      opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp-proto-grpc opentelemetry-exporter-otlp-proto-http
      cmake clang-format clang-tools cppcheck ninja docstring_parser
      scikit-build-core pybind11-stubgen ruff
    - micromamba activate base
    - |
      {
        if [[ $CPP_TANGO_VERSION == *"dev"* ]]; then
          micromamba install -c tango-controls/label/tango-test_dev -c conda-forge -c tango-controls/label/dev cpptango-dbg=$CPP_TANGO_VERSION tango-test=${TANGO_TEST_VERSION}
        else
          micromamba install -c conda-forge -c conda-forge/label/cpptango_rc -c conda-forge/label/tango-test_rc cpptango=$CPP_TANGO_VERSION tango-test=${TANGO_TEST_VERSION}
        fi
      } || {
        echo "Cannot find matching TangoTest, trying to building TangoTest against dev cpp_tango"
        if [[ $CPP_TANGO_VERSION == *"dev"* ]]; then
          micromamba install -c conda-forge -c tango-controls/label/dev cpptango-dbg=$CPP_TANGO_VERSION
        else
          micromamba install -c conda-forge -c conda-forge/label/cpptango_rc cpptango=$CPP_TANGO_VERSION
        fi
        pushd /tmp
        git clone --recurse-submodules https://gitlab.com/tango-controls/TangoTest.git
        cd TangoTest
        cmake --install-prefix="$CONDA_PREFIX" -B build
        make -C build install
        popd
      }
    # Install pytango
    - >
      python -m pip install
      --no-build-isolation
      --config-settings=cmake.args="--preset=ci-Linux"
      --config-settings=cmake.build-type="Debug"
      --config-settings=build-dir="cmakebuild"
      -v -e ".[tests,telemetry]"
  script:
    # run full test suite with telemetry disabled (default), then re-run telemetry-specific tests with it enabled
    - >
      pytest --cov . --cov-branch --cov-append --cov-report=term --write_cpp_coverage --run_extra_src_tests --junitxml=report.xml ||
      pytest --lf --cov . --cov-branch --cov-append --cov-report=term --write_cpp_coverage --run_extra_src_tests --junitxml=report-lf.xml
    - >
      TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
      --cov . --cov-branch --cov-append --cov-report=term --cov-report=xml --write_cpp_coverage --junitxml=report-telem.xml
    # create coverage xml file from cpp gcda/gcno files
    - >
      gcovr
      --gcov-ignore-parse-errors=negative_hits.warn_once_per_file
      --decisions
      --exclude-unreachable-branches
      --exclude-throw-branches
      --txt
      --cobertura-pretty
      --cobertura coverage-cpp.xml
    # workaround gcovr bug, see https://github.com/gcovr/gcovr/issues/1034
    - sed -e "s;\( filename=\"\);\1$(pwd)/;g" coverage.xml > coverage-python-processed.xml
    - >
      gcovr
      --cobertura-add-tracefile coverage-python-processed.xml
      --cobertura-add-tracefile coverage-cpp.xml
      --txt
      --html-details htmlcov/
      --html-title "PyTango python and cpp coverage report"
      --cobertura-pretty
      --cobertura coverage-all.xml
    # check typing stubs
    - python cmake/check_stubs.py
    - |
      if [[ $PYTHON_VERSION = "3.13" ]]; then
        echo "ðŸ” Checking if tango/*.pyi stubs are unchanged..."
        if git diff --quiet -- tango/*.pyi; then
          echo "âœ… tango/*.pyi files are unchanged."
        else
          echo "âŒ tango/*.pyi files have been modified. Commit updated version to the repo (use Linux or macOS, Python 3.13)."
          exit 1
        fi
      else
        echo "â„¹ï¸ Skipping check of tango/*.pyi stubs: only done on Python 3.13"
      fi
  after_script:
    # Core files configuration
    - python_executable=$(which python)
    - dline="================================================================================"
    - |
      pattern=$(cat /proc/sys/kernel/core_pattern)
      if [ "$pattern" == "core.%e.%p.%t" ]; then
        echo "Core pattern is correct: $pattern";
        for core_file in core.*; do
          if [ -f "$core_file" ]; then
            echo -e "$dline\nAnalyzing core file: $core_file\n$dline\n"
            pystack core $core_file $python_executable --native-all --locals
            echo -e "$dline\n"
          fi
        done
      else
        echo "Core pattern is incorrect(expected: core.%e.%p.%t): $pattern";
      fi
  parallel:
    matrix:
      - PYTHON_VERSION: ['3.10', '3.11', '3.12', '3.13', '3.14']
  coverage: '/^TOTAL.*\s+(\d+\%)$/'
  artifacts:
    when: always
    paths:
      - htmlcov/
      - coverage*.xml
      - report*.xml
    reports:
      junit: report*.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage-all.xml
  environment:
    name: code-coverage/$CI_COMMIT_REF_SLUG/python-${PYTHON_VERSION}
    auto_stop_in: 1 week
    url: "https://${CI_PROJECT_NAMESPACE}.gitlab.io/-/${CI_PROJECT_NAME}/-/jobs/${CI_JOB_ID}/artifacts/htmlcov/coverage_details.html"

linux:test-source-against-develop-dependencies:
  stage: test
  when: manual
  image: registry.gitlab.com/tango-controls/docker/micromamba:2.3.0
  tags:
    - linux
    - docker
    - amd64
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    IDL_SOURCE: "main"
    CPPTANGO_SOURCE: "main"
    TANGOTEST_SOURCE: "main"
    PYTHON_VERSION: "3.14"
  # Avoid job to wait on wheels building
  needs: [linux:build-sdist]
  before_script:
    - ulimit -c unlimited
    - eval "$(/bin/micromamba shell hook -s bash)"
    # Install build and test dependencies
    - >
      micromamba install -y -n base -c conda-forge
      "pybind11>=3.0.1" cmake cppzmq cxx-compiler omniorb libtool pkg-config gnuconfig autoconf zeromq jpeg
      cpp-opentelemetry-api cpp-opentelemetry-sdk
      git make ninja python numpy packaging psutil pytest pytest-forked pytest-cov pystack gevent valgrind
      clang-format clang-tools cppcheck python=$PYTHON_VERSION typing_extensions docstring_parser
      opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp-proto-grpc opentelemetry-exporter-otlp-proto-http
    - micromamba activate base
    # check which idl should we use and install it
    - |
      if [[ $IDL_SOURCE == "conda" ]]; then
        echo "Installing idl from conda-forge"
        micromamba install -c conda-forge tango-idl
      else
          echo "Building and installing idl from ${IDL_SOURCE} branch"
          pushd /tmp
          git clone --recurse-submodules --depth 1 -b $IDL_SOURCE https://gitlab.com/tango-controls/tango-idl
          cd tango-idl
          cmake --install-prefix="$CONDA_PREFIX" -B build
          make -C build install
          popd
      fi
    # check which cpptango should we use and install it
    - |
      if [[ $CPPTANGO_SOURCE = "conda" ]] ; then
        echo "Installing cpptango from conda-forge"
        micromamba install  -c conda-forge -c tango-controls/label/dev -c conda-forge/label/cpptango_rc cpptango-dbg=$CPP_TANGO_VERSION
      else
        echo "Building and installing cpptango from ${CPPTANGO_SOURCE} branch"
        pushd /tmp
        git clone --recurse-submodules --depth 1 -b $CPPTANGO_SOURCE https://gitlab.com/tango-controls/cppTango
        cd cppTango
        mkdir build
        cd build
        cmake ${CMAKE_ARGS} -DCMAKE_BUILD_TYPE=Debug -DCMAKE_VERBOSE_MAKEFILE=ON -DCMAKE_INSTALL_PREFIX="$CONDA_PREFIX" -DCMAKE_PREFIX_PATH="$CONDA_PREFIX" -DBUILD_TESTING=OFF -DCMAKE_CXX_STANDARD=17 -DTANGO_USE_TELEMETRY=ON ..
        make
        make install
        popd
      fi
    # check which tango test should we use and install it
    - |
      if [[ $TANGOTEST_SOURCE = "conda" ]] && [[$CPP_TANGO_VERSION != *"dev"*]]; then
        echo "Installing tangotest from conda-forge"
        micromamba install  -c conda-forge -c conda-forge/label/tango-test_rc tango-test=${TANGO_TEST_VERSION}
      else
        pushd /tmp
        if [[ $CPP_TANGO_VERSION == *"dev"* ]]; then
          echo "Building TangoTest head against dev cpp_tango"
          git clone --recurse-submodules https://gitlab.com/tango-controls/TangoTest.git
        else
          echo "Building and installing TangoTest from ${TANGOTEST_SOURCE}"
          git clone --recurse-submodules -b $TANGOTEST_SOURCE https://gitlab.com/tango-controls/TangoTest.git
        fi
        cd TangoTest
        cmake --install-prefix="$CONDA_PREFIX" -B build
        make -C build install
        popd
      fi
    # Install pytango
    - >
      python -m pip install
      --config-settings=cmake.args="--preset=ci-Linux"
      --config-settings=cmake.build-type="Debug"
      --config-settings=build-dir="cmakebuild"
      -v -e ".[tests,telemetry]"
  script:
    # run full test suite with telemetry disabled (default), then re-run telemetry-specific tests with it enabled
    - pytest || pytest --lf
    - TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
    # now remove opentelemetry packages (all depend on opentelemetry-api), and see if some tests still pass
    - micromamba remove -y opentelemetry-api
    - TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
    # check for valgrind issues
    - pushd tests/valgrind
    - ./run_valgrind_checks.sh
    - popd
  after_script:
    # Core files configuration
    - python_executable=$(which python)
    - dline="================================================================================"
    - |
      pattern=$(cat /proc/sys/kernel/core_pattern)
      if [ "$pattern" == "core.%e.%p.%t" ]; then
        echo "Core pattern is correct: $pattern";
        for core_file in core.*; do
          if [ -f "$core_file" ]; then
            echo -e "$dline\nAnalyzing core file: $core_file\n$dline\n"
            pystack core $core_file $python_executable --native-all --locals
            echo -e "$dline\n"
          fi
        done
      else
        echo "Core pattern is incorrect(expected: core.%e.%p.%t): $pattern";
      fi
  artifacts:
    when: always
    paths:
      - tests/valgrind/*.xml

linux:test-main-cpptango:
  stage: test
  image: registry.gitlab.com/tango-controls/docker/micromamba:2.3.0
  tags:
    - linux
    - docker
    - amd64
  # Avoid job to wait on wheels building
  needs: [linux:build-sdist]
  before_script:
    - eval "$(/bin/micromamba shell hook -s bash)"
    # Install build and test dependencies
    - >
      micromamba install -y -n base -c tango-controls/label/dev -c conda-forge
      cpptango "pybind11>=3.0.1" cmake cppzmq cxx-compiler git make pkg-config ninja
      python numpy
      packaging psutil typing_extensions pytest pytest-forked gevent valgrind docstring_parser
      opentelemetry-api opentelemetry-sdk opentelemetry-exporter-otlp-proto-grpc opentelemetry-exporter-otlp-proto-http
    - micromamba activate base
    # build and install TangoTest
    - pushd /tmp
    - git clone --recurse-submodules https://gitlab.com/tango-controls/TangoTest.git
    - cd TangoTest
    - cmake --install-prefix="$CONDA_PREFIX" -B build
    - make -C build install
    - popd
    # Install pytango
    - python -m pip install -v $(ls dist/pytango*.tar.gz)[tests,telemetry]
  script:
    # run telemetry-specific tests with telemetry enabled, then full test suite with it disabled (default)
    - TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
    - >
      pytest --junitxml=report.xml ||
      pytest --lf --junitxml=report-lf.xml
    # now remove opentelemetry packages (all depend on opentelemetry-api), and see if some tests still pass
    - micromamba remove -y opentelemetry-api
    - TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
    # check for valgrind issues
    - pushd tests/valgrind
    - ./run_valgrind_checks.sh
    - popd
  artifacts:
    when: always
    paths:
      - report*.xml
      - tests/valgrind/*.xml
    reports:
      junit: report*.xml
  rules:
    # Disable detached pipeline on MR
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule"
      allow_failure: false
    - if: $CI_COMMIT_BRANCH || $CI_COMMIT_TAG
      when: manual
      allow_failure: true

.linux-test-wheel:
  stage: test
  extends: .matrix-wheel-linux
  needs: [linux:build-wheel]
  before_script:
    - /opt/python/${PYTHON_TAG}/bin/python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install --prefer-binary $(find dist/${WHEEL_GLOB_PATTERN})[tests,telemetry]
  script:
    # run telemetry-specific tests with telemetry enabled, then full test suite with it disabled (default)
    - TANGO_TELEMETRY_ENABLE=on pytest -k telemetry
    - pytest || pytest --lf
  rules:
    - if: $CI_COMMIT_TAG && $ARCH == "aarch64"
      allow_failure: true
    - !reference [.rules-wheel, rules]

# All linux wheels need to be built to trigger those jobs
linux:test-wheel:
  extends: .linux-test-wheel

# Only wait on linux wheel for x86_64 python 3.14
linux:test-wheel:x86_64:3.14:
  extends: .linux-test-wheel
  when: manual
  parallel:
    matrix:
      - RUNNER_TAG: amd64
        ARCH: x86_64
        PYTHON_VER: "314"
  needs:
    - job: linux:build-wheel
      parallel:
        matrix:
          - RUNNER_TAG: amd64
            ARCH: x86_64
            PYTHON_VER: "314"

# Only wait on linux wheel for aarch64 python 3.14
linux:test-wheel:aarch64:3.14:
  extends: .linux-test-wheel
  when: manual
  parallel:
    matrix:
      - RUNNER_TAG: aarch64
        ARCH: aarch64
        PYTHON_VER: "314"
  needs:
    - job: linux:build-wheel
      parallel:
        matrix:
          - RUNNER_TAG: aarch64
            ARCH: aarch64
            PYTHON_VER: "314"

.linux-test-pixi:
  extends: .test-pixi
  before_script:
    - apt-get update
    - apt-get install -y git

linux:test-pixi:x86_64:
  extends: .linux-test-pixi
  image: ghcr.io/prefix-dev/pixi:latest
  tags:
    - linux
    - docker
    - amd64

# Note that platform doesn't support variable (can't define that using matrix)
# See https://gitlab.com/gitlab-org/gitlab/-/issues/441691
linux:test-pixi:aarch64:
  extends: .linux-test-pixi
  image:
    name: ghcr.io/prefix-dev/pixi:latest
    docker:
      platform: arm64
  tags:
    - linux
    - docker
    - aarch64
