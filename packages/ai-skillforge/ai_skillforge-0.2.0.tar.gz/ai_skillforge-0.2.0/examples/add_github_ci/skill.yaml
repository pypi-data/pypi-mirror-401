name: add_github_ci
version: "0.1.0"
description: "Add GitHub Actions CI workflow to a project"

inputs:
  - name: target_dir
    type: path
    description: "Target directory for the project"
    required: true

  - name: project_type
    type: string
    description: "Project type: python, node, or auto (auto-detect)"
    required: false
    default: "auto"

  - name: python_versions
    type: string
    description: "Python versions to test (comma-separated)"
    required: false
    default: "3.10,3.11,3.12"

  - name: node_versions
    type: string
    description: "Node.js versions to test (comma-separated)"
    required: false
    default: "18,20,22"

  - name: enable_dependabot
    type: string
    description: "Enable Dependabot updates (true/false)"
    required: false
    default: "true"

preconditions:
  - "Target directory must be a git repository or about to become one"
  - "Project should have package.json (Node) or pyproject.toml/setup.py (Python)"

steps:
  - id: create_workflows_dir
    type: shell
    name: "Create .github/workflows directory"
    command: mkdir -p .github/workflows
    cwd: "{sandbox_dir}"

  - id: detect_project_type
    type: shell
    name: "Detect project type"
    command: |
      if [ "{project_type}" != "auto" ]; then
        echo "{project_type}"
        exit 0
      fi

      if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
        echo "python"
      elif [ -f "package.json" ]; then
        echo "node"
      else
        echo "unknown"
      fi
    cwd: "{sandbox_dir}"

  - id: create_python_ci
    type: shell
    name: "Create Python CI workflow"
    command: |
      PROJECT_TYPE=$(cat /tmp/sf_project_type 2>/dev/null || echo "{project_type}")
      if [ "{project_type}" = "auto" ]; then
        if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ]; then
          PROJECT_TYPE="python"
        fi
      else
        PROJECT_TYPE="{project_type}"
      fi

      if [ "$PROJECT_TYPE" = "python" ]; then
        cat > .github/workflows/ci.yml << 'CIEOF'
      name: CI

      on:
        push:
          branches: [main, master]
        pull_request:
          branches: [main, master]

      jobs:
        test:
          runs-on: ubuntu-latest
          strategy:
            fail-fast: false
            matrix:
              python-version: [{python_versions}]

          steps:
            - uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                python-version: ${{ matrix.python-version }}

            - name: Install dependencies
              run: |
                python -m pip install --upgrade pip
                pip install -e ".[dev]" || pip install -e . || pip install -r requirements.txt

            - name: Run linting
              run: |
                pip install ruff
                ruff check . || true

            - name: Run tests
              run: |
                pip install pytest pytest-cov
                pytest tests/ -v --cov=. --cov-report=xml || pytest -v || echo "No tests found"

            - name: Upload coverage
              uses: codecov/codecov-action@v4
              if: matrix.python-version == '3.11'
              with:
                files: ./coverage.xml
                fail_ci_if_error: false
      CIEOF
        echo "Created Python CI workflow"
      else
        echo "Skipping Python CI (project type: $PROJECT_TYPE)"
      fi
    cwd: "{sandbox_dir}"

  - id: create_node_ci
    type: shell
    name: "Create Node.js CI workflow"
    command: |
      if [ "{project_type}" = "auto" ]; then
        if [ -f "package.json" ] && [ ! -f "pyproject.toml" ] && [ ! -f "setup.py" ]; then
          PROJECT_TYPE="node"
        else
          PROJECT_TYPE="other"
        fi
      else
        PROJECT_TYPE="{project_type}"
      fi

      if [ "$PROJECT_TYPE" = "node" ]; then
        cat > .github/workflows/ci.yml << 'CIEOF'
      name: CI

      on:
        push:
          branches: [main, master]
        pull_request:
          branches: [main, master]

      jobs:
        test:
          runs-on: ubuntu-latest
          strategy:
            fail-fast: false
            matrix:
              node-version: [{node_versions}]

          steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js ${{ matrix.node-version }}
              uses: actions/setup-node@v4
              with:
                node-version: ${{ matrix.node-version }}
                cache: 'npm'

            - name: Install dependencies
              run: npm ci || npm install

            - name: Run linting
              run: npm run lint || true

            - name: Run tests
              run: npm test || echo "No tests configured"

            - name: Build
              run: npm run build || true
      CIEOF
        echo "Created Node.js CI workflow"
      else
        echo "Skipping Node.js CI (project type: $PROJECT_TYPE)"
      fi
    cwd: "{sandbox_dir}"

  - id: create_dependabot
    type: shell
    name: "Create Dependabot configuration"
    command: |
      if [ "{enable_dependabot}" = "true" ]; then
        cat > .github/dependabot.yml << 'DEPEOF'
      version: 2
      updates:
        - package-ecosystem: "github-actions"
          directory: "/"
          schedule:
            interval: "weekly"
          commit-message:
            prefix: "ci"

        - package-ecosystem: "pip"
          directory: "/"
          schedule:
            interval: "weekly"
          commit-message:
            prefix: "deps"
          ignore:
            - dependency-name: "*"
              update-types: ["version-update:semver-patch"]

        - package-ecosystem: "npm"
          directory: "/"
          schedule:
            interval: "weekly"
          commit-message:
            prefix: "deps"
          ignore:
            - dependency-name: "*"
              update-types: ["version-update:semver-patch"]
      DEPEOF
        echo "Created Dependabot configuration"
      else
        echo "Skipping Dependabot (disabled)"
      fi
    cwd: "{sandbox_dir}"

checks:
  - id: check_ci_workflow
    type: file_exists
    path: "{sandbox_dir}/.github/workflows/ci.yml"

  - id: check_ci_has_jobs
    type: file_contains
    path: "{sandbox_dir}/.github/workflows/ci.yml"
    contains: "jobs:"

  - id: check_ci_has_checkout
    type: file_contains
    path: "{sandbox_dir}/.github/workflows/ci.yml"
    contains: "actions/checkout"

  - id: check_mkdir_step
    type: exit_code
    step_id: create_workflows_dir
    equals: 0
