"""
集中管理所有上下文、记忆、文件长度等限制配置。

这个模块包含所有与大小、长度、字符数相关的限制配置。
所有硬编码的限制值都应该在这里定义，并在代码中引用。

设计原则：
1. 所有限制都在这里集中定义
2. 每个限制都有清晰的注释说明用途
3. 限制值应该根据实际需求合理设置，避免过大（浪费token）或过小（丢失信息）
4. 对于文件查看命令，需要更大的限制以确保LLM能看到完整内容
"""

# ============================================================================
# 工具执行输出限制
# ============================================================================

# 普通工具的标准输出限制（字符数）
# 用于非文件查看命令的 stdout/stderr
# 优化：针对 128k token 上下文，从 5KB 增加到 8KB，可以保留更多命令输出
STDOUT_STDERR_LIMIT_NORMAL: int = 8000  # 8KB - 普通命令的输出限制

# 文件查看命令的输出限制（字符数）
# 用于 cat, head, tail, sed -n 等文件查看命令
# 需要更大的限制以确保LLM能看到完整的文件内容来修复错误
# 优化：针对 128k token 上下文，从 40KB 增加到 60KB，可以查看更大的文件
STDOUT_STDERR_LIMIT_FILE_VIEW: int = 60000  # 60KB - 文件查看命令的输出限制

# 非 run 工具的输出限制（字符数）
# 用于 write_file 等其他工具
STDOUT_STDERR_LIMIT_OTHER: int = 2000  # 2KB - 其他工具的输出限制

# 错误摘要的最大长度（字符数）
# 用于存储工具执行结果的摘要，传递给LLM
# 优化：针对 128k token 上下文，增加到 25KB/50KB，确保完整错误信息（包括长 traceback）
ERROR_SUMMARY_LIMIT_NORMAL: int = 25000  # 25KB - 普通命令的错误摘要限制
ERROR_SUMMARY_LIMIT_FILE_VIEW: int = 50000  # 50KB - 文件查看命令的错误摘要限制

# stderr 尾部存储限制（字符数）
# 用于存储 stderr 的尾部，用于详细错误分析
# 优化：针对 128k token 上下文，从 5KB 增加到 10KB，错误信息通常在尾部
STDERR_TAIL_LIMIT: int = 10000  # 10KB - stderr 尾部限制

# ============================================================================
# 上下文包（Context Pack）限制
# ============================================================================

# 最近错误信息的最大长度（字符数）
# 用于在 prompt 中传递给 LLM 的最近错误信息
# 优化：针对 128k token 上下文，增加到 20KB/40KB，可以包含更多错误上下文
RECENT_ERROR_LIMIT_NORMAL: int = 20000  # 20KB - 普通错误信息限制
RECENT_ERROR_LIMIT_FILE_CONTENT: int = 40000  # 40KB - 包含文件内容的错误信息限制

# Diff 信息的最大长度（字符数）
# 用于显示文件变更的 diff 信息
# 优化：针对 128k token 上下文，从 5KB 增加到 10KB，可以显示更多文件变更
DIFF_LIMIT: int = 10000  # 10KB - Diff 信息限制

# 测试结果的最大长度（字符数）
# 用于存储测试/验证命令的输出
# 优化：针对 128k token 上下文，增加到 15KB/10KB，测试输出可能很长
TEST_RESULTS_LIMIT: int = 15000  # 15KB - 测试结果限制（在 agent_loop 中）
TEST_RESULTS_LIMIT_CONTEXT: int = 10000  # 10KB - 测试结果限制（在 context_pack 中）

# 上下文包的最大总大小（字节数）
# 用于限制整个上下文包的大小
# 优化：针对 128k token 上下文，从 100KB 增加到 200KB，充分利用上下文空间
CONTEXT_PACK_MAX_SIZE: int = 200 * 1024  # 200KB - 上下文包最大大小

# ============================================================================
# 文件索引和检索限制
# ============================================================================

# 注意：以下配置已移除（未使用）：
# - FILE_SNIPPETS_MAX_TOTAL_SIZE
# - FILE_SNIPPETS_MAX_LINES
# - READ_CONTEXT_LIMIT
# - SNIPPETS_MAX

# ============================================================================
# 验证器（Verifier）限制
# ============================================================================

# 错误摘要的最大长度（字符数）
# 用于从验证输出中提取错误摘要
# 需要足够大以包含完整的 ImportError traceback
# 优化：针对 128k token 上下文，从 8KB 增加到 15KB，确保完整 traceback
VERIFIER_ERROR_SUMMARY_LIMIT: int = 15000  # 15KB - 验证器错误摘要限制

# 错误行提取的最大行数
# 用于从验证输出中提取错误相关的行数
VERIFIER_ERROR_LINES_MAX: int = 30  # 30行 - 最大错误行数

# 错误签名提取的单行最大长度（字符数）
# 用于提取错误签名时的单行限制
VERIFIER_ERROR_SIGNATURE_LINE_LIMIT: int = 200  # 200字符 - 错误签名单行限制

# ============================================================================
# 记忆摘要（Memory Summary）限制
# ============================================================================

# 记忆摘要的默认最大长度（字符数）
# 用于限制记忆摘要的长度
# 优化：针对 128k token 上下文，从 32KB 增加到 64KB，充分利用长期记忆能力（12.5% 的输入上下文）
MEMORY_SUMMARY_DEFAULT_LIMIT: int = 64000  # 64KB - 默认记忆摘要限制

# 记忆摘要的最小有效长度（字符数）
# 确保至少保留这么多字符，以包含工具执行结果
# 即使设置了较小的 max_length，也会至少保留这么多字符
# 影响：太大可能强制保留过多信息，导致截断失效；太小可能仍然丢失关键信息
# 优化：针对 128k token 上下文，从 8KB 增加到 16KB，确保至少保留足够的关键信息
MEMORY_SUMMARY_MIN_EFFECTIVE_LIMIT: int = 16000  # 16KB - 最小有效记忆摘要限制

# Shell 命令的 stdout/stderr 限制（字符数）
# 用于在记忆摘要中显示 shell 命令的输出
# 比普通输出限制大，因为记忆摘要需要保留更多上下文以便 LLM 了解历史操作
# - SHELL: Shell 命令的输出，需要更大空间因为命令输出通常较长
# - OTHER: 其他工具的输出，通常更短（简单的成功/失败消息）
# 影响：太大浪费 token；太小可能丢失重要执行结果
# 优化：针对 128k token 上下文，增加到 12KB/4KB，记忆摘要需要保留更多历史操作
MEMORY_SUMMARY_STDOUT_STDERR_SHELL: int = 12000  # 12KB - Shell 命令输出限制
MEMORY_SUMMARY_STDOUT_STDERR_OTHER: int = 4000  # 4KB - 其他工具输出限制

# 最后错误的 stderr 尾部限制（字符数）
# 用于在记忆摘要中显示最后错误的 stderr 尾部
# 比 STDERR_TAIL_LIMIT 小，因为记忆摘要需要包含更多其他信息
# 很多错误信息（如 Python traceback）在输出的末尾，需要保留尾部
# 影响：太大占用过多记忆摘要空间；太小可能丢失关键错误信息
# 优化：针对 128k token 上下文，从 2KB 增加到 5KB，最后错误很重要
MEMORY_SUMMARY_STDERR_TAIL: int = 5000  # 5KB - stderr 尾部限制

# 最后错误的完整输出限制（字符数）
# 用于在记忆摘要中显示最后错误的完整输出
# 最后错误通常是最重要的，需要足够空间显示完整信息
# - SHELL: Shell 命令的完整输出（stdout + stderr），用于显示最后执行的 shell 命令的完整结果
# - OTHER: 其他工具（如 write_file, edit_file）的完整输出，用于显示最后执行的非 shell 工具的完整结果
# 影响：太大占用过多记忆摘要空间；太小可能丢失关键错误信息
# 优化：针对 128k token 上下文，从 8KB 增加到 15KB，最后错误需要完整信息
MEMORY_SUMMARY_LAST_ERROR_STDOUT_STDERR_SHELL: int = 15000  # 15KB - Shell 命令完整输出限制
MEMORY_SUMMARY_LAST_ERROR_STDOUT_STDERR_OTHER: int = 15000  # 15KB - 其他工具完整输出限制

# ============================================================================
# 事件日志（Event Logger）限制
# ============================================================================

# 工具输出的最大长度（字符数）
# 用于在事件日志中存储工具输出
# 事件日志用于记录和调试，不需要完整输出，只需要关键部分
# 影响：太大事件日志文件会变得很大；太小可能丢失关键输出信息
# 优化：针对 128k token 上下文，从 8KB 增加到 12KB，事件日志需要记录更多信息
EVENT_LOGGER_OUTPUT_LIMIT_NORMAL: int = 12000  # 12KB - 普通工具输出限制
# 注意：以下配置已移除（未使用）：
# - EVENT_LOGGER_OUTPUT_LIMIT_LLM
# - EVENT_LOGGER_OUTPUT_LIMIT_VERIFICATION

# Prompt 预览的最大长度（字符数）
# 用于在事件日志中存储 prompt 预览
# 只存储 prompt 的开头部分，用于调试，不需要完整 prompt
# 影响：太大事件日志文件会变得很大；太小可能无法看到 prompt 的关键部分
# 优化：针对 128k token 上下文，从 2KB 增加到 4KB，可以预览更多 prompt 内容
EVENT_LOGGER_PROMPT_PREVIEW_LIMIT: int = 4000  # 4KB - Prompt 预览限制

# ============================================================================
# 报告生成（Report Generator）限制
# ============================================================================

# 报告中的 diff 最大长度（字符数）
# 用于在生成的报告中显示 diff
# 优化：针对 128k token 上下文，从 5KB 增加到 10KB，报告需要显示更多变更
REPORT_DIFF_LIMIT: int = 10000  # 10KB - 报告 diff 限制

# 报告中的测试结果最大长度（字符数）
# 用于在生成的报告中显示测试结果
# 优化：针对 128k token 上下文，从 2KB 增加到 5KB，报告需要显示更多测试信息
REPORT_TEST_RESULTS_LIMIT: int = 5000  # 5KB - 报告测试结果限制

# 报告中的 stderr 最大长度（字符数）
# 用于在生成的报告中显示 stderr
# 优化：针对 128k token 上下文，从 1KB 增加到 3KB，报告需要显示更多错误信息
REPORT_STDERR_LIMIT: int = 3000  # 3KB - 报告 stderr 限制

# ============================================================================
# 其他配置限制
# ============================================================================

# 注意：以下配置已移除（未使用）：
# - DIFF_MAX_LINES
# - STDERR_TAIL_LINES

# 日志文件的最大大小（MB）
# 用于日志轮转
LOG_FILE_MAX_SIZE_MB: int = 100  # 100MB - 日志文件最大大小

# ============================================================================
# 辅助函数
# ============================================================================


def is_file_view_command(cmd: str) -> bool:
    """
    判断命令是否是文件查看命令。

    Args:
        cmd: 命令字符串

    Returns:
        如果是文件查看命令返回 True，否则返回 False
    """
    cmd_lower = cmd.lower()
    return any(cmd in cmd_lower for cmd in ["cat ", "head ", "tail ", "sed -n"])


def is_file_content(text: str) -> bool:
    """
    判断文本是否包含文件内容。

    Args:
        text: 文本内容

    Returns:
        如果包含文件内容返回 True，否则返回 False
    """
    text_lower = text.lower()
    return any(cmd in text_lower for cmd in ["cat ", "head ", "tail ", "sed -n"])
