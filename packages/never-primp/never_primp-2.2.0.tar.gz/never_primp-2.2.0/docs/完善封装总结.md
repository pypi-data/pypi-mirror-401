# never_primp - å®Œæ•´å°è£…æ€»ç»“

## åŠŸèƒ½æ¦‚è§ˆ

`never_primp` æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„ Python HTTP å®¢æˆ·ç«¯åº“ï¼ŒåŸºäº Rust çš„ wreq å’Œ wreq-util æ„å»ºï¼Œé€šè¿‡ PyO3 æä¾› Python ç»‘å®šã€‚

### æ ¸å¿ƒç‰¹æ€§

1. **æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…** - 100+ æµè§ˆå™¨ç‰ˆæœ¬æ”¯æŒ
2. **é«˜å¹¶å‘ä¼˜åŒ–** - 512 è¿æ¥/ä¸»æœºï¼Œ2048 æ€»è¿æ¥æ± 
3. **æ™ºèƒ½æç¤ºå®Œæ•´** - å®Œæ•´çš„ç±»å‹æç¤ºå’Œ IDE è‡ªåŠ¨å®Œæˆ
4. **å“åº”å¯¹è±¡å®Œå–„** - æ‰€æœ‰å±æ€§æ™ºèƒ½åŠ è½½ï¼Œæ”¯æŒä»»æ„é¡ºåºè®¿é—®
5. **å¼‚æ­¥æ”¯æŒ** - åŒæ—¶æä¾›åŒæ­¥å’Œå¼‚æ­¥ API

## æ™ºèƒ½æç¤ºæ”¯æŒ

### 1. ç±»å‹å­˜æ ¹æ–‡ä»¶ (.pyi)

åˆ›å»ºäº† `never_primp/never_primp.pyi` æ–‡ä»¶ï¼Œä¸º Rust æ‰©å±•æ¨¡å—æä¾›ç±»å‹æç¤ºï¼š

```python
class Response:
    """HTTP response object with lazy-loaded content."""

    url: str
    """Final URL after following redirects."""

    status_code: int
    """HTTP status code (200, 404, etc.)."""

    @property
    def content(self) -> bytes:
        """Get raw response body as bytes."""
        ...

    @property
    def text(self) -> str:
        """Get response body as decoded string."""
        ...

    @property
    def encoding(self) -> Optional[str]:
        """Get detected character encoding."""
        ...

    @property
    def headers(self) -> Dict[str, str]:
        """Get response headers as dictionary."""
        ...

    @property
    def cookies(self) -> Dict[str, str]:
        """Get response cookies as dictionary."""
        ...

    def json(self) -> Any:
        """Parse response body as JSON."""
        ...
```

### 2. py.typed æ ‡è®°

åˆ›å»ºäº† `never_primp/py.typed` ç©ºæ–‡ä»¶ï¼Œå‘Šè¯‰ç±»å‹æ£€æŸ¥å™¨è¿™æ˜¯ä¸€ä¸ªç±»å‹åŒ–çš„åŒ…ã€‚

### 3. å®Œæ•´ç±»å‹æ³¨è§£

åœ¨ `__init__.py` ä¸­ä½¿ç”¨ Literal ç±»å‹å®šä¹‰æ‰€æœ‰å¯ç”¨é€‰é¡¹ï¼š

```python
IMPERSONATE = Literal[
    "chrome_100", "chrome_101", ..., "chrome_143",
    "firefox_109", ..., "firefox_146",
    "safari_15.3", ..., "safari_26.2",
    "edge_101", ..., "edge_142",
    # ... 100+ browser versions
]

IMPERSONATE_OS = Literal["windows", "macos", "linux", "android", "ios"]
```

## Response å¯¹è±¡ä¼˜åŒ–

### é—®é¢˜ä¿®å¤

**åŸå§‹é—®é¢˜**ï¼šè®¿é—® `response.content` åæ— æ³•è®¿é—® `response.text`ï¼Œå› ä¸ºåº•å±‚çš„ Rust Response è¢«æ¶ˆè€—äº†ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. åœ¨ `response.rs` ä¸­æ·»åŠ  `ensure_metadata_extracted()` æ–¹æ³•
2. åœ¨æ¶ˆè€— Response body ä¹‹å‰æå–æ‰€æœ‰ metadataï¼ˆheaders, encoding, cookiesï¼‰
3. å°†æå–çš„æ•°æ®ç¼“å­˜èµ·æ¥ï¼Œä¾›åç»­è®¿é—®ä½¿ç”¨

### å®ç°ç»†èŠ‚

```rust
/// Ensure all metadata is extracted before consuming response body
fn ensure_metadata_extracted(&self, py: Python) -> PyResult<()> {
    // Extract headers first
    let headers = self.extract_headers(py)?;
    *self._headers.lock().unwrap() = Some(headers);

    // Extract encoding from Content-Type header
    match self.extract_encoding(py) {
        Ok(encoding) => {
            *self._encoding.lock().unwrap() = Some(encoding);
        }
        Err(_) => {
            *self._encoding.lock().unwrap() = Some("utf-8".to_string());
        }
    }

    // Extract cookies from Set-Cookie headers
    let cookies = self.extract_cookies(py)?;
    *self._cookies.lock().unwrap() = Some(cookies);

    Ok(())
}
```

### ä½¿ç”¨æ•ˆæœ

ç°åœ¨å¯ä»¥æŒ‰ä»»æ„é¡ºåºè®¿é—® Response å±æ€§ï¼š

```python
response = never_primp.get("https://httpbin.org/get")

# âœ“ å¯ä»¥å…ˆè®¿é—® content
print(len(response.content))   # bytes
print(len(response.text))       # str - ä»ç„¶å¯ç”¨ï¼

# âœ“ å¯ä»¥å…ˆè®¿é—® text
response2 = never_primp.get("https://httpbin.org/get")
print(len(response2.text))      # str
print(len(response2.content))   # bytes - ä»ç„¶å¯ç”¨ï¼

# âœ“ å¯ä»¥è®¿é—®æ‰€æœ‰å±æ€§
print(response.url)             # str
print(response.status_code)     # int
print(response.encoding)        # Optional[str]
print(response.headers)         # Dict[str, str]
print(response.cookies)         # Dict[str, str]
data = response.json()          # Any
```

## å±æ€§è¯´æ˜

### Response å±æ€§è¯¦è§£

| å±æ€§ | ç±»å‹ | è¯´æ˜ | æ‡’åŠ è½½ |
|------|------|------|--------|
| `url` | `str` | æœ€ç»ˆ URLï¼ˆè·Ÿéšé‡å®šå‘åï¼‰ | âŒ |
| `status_code` | `int` | HTTP çŠ¶æ€ç  (200, 404, ...) | âŒ |
| `content` | `bytes` | åŸå§‹å“åº”ä½“å­—èŠ‚ | âœ“ |
| `text` | `str` | è§£ç åçš„å“åº”æ–‡æœ¬ | âœ“ |
| `encoding` | `Optional[str]` | æ£€æµ‹åˆ°çš„å­—ç¬¦ç¼–ç  | âœ“ |
| `headers` | `Dict[str, str]` | å“åº”å¤´å­—å…¸ | âœ“ |
| `cookies` | `Dict[str, str]` | å“åº” cookies å­—å…¸ | âœ“ |
| `json()` | `Any` | è§£æçš„ JSON æ•°æ® | - |

### æ‡’åŠ è½½æœºåˆ¶

- **ç«‹å³å¯ç”¨**ï¼š`url`, `status_code` åœ¨åˆ›å»ºæ—¶å°±å¯ç”¨
- **æŒ‰éœ€åŠ è½½**ï¼š`content`, `text`, `headers`, `cookies`, `encoding` é¦–æ¬¡è®¿é—®æ—¶åŠ è½½
- **è‡ªåŠ¨ç¼“å­˜**ï¼šåŠ è½½åçš„å€¼ä¼šè¢«ç¼“å­˜ï¼Œé‡å¤è®¿é—®ç›´æ¥è¿”å›ç¼“å­˜
- **é¡ºåºæ— å…³**ï¼šæ— è®ºæŒ‰ä»€ä¹ˆé¡ºåºè®¿é—®ï¼Œæ‰€æœ‰å±æ€§éƒ½èƒ½æ­£å¸¸å·¥ä½œ

## IDE æ”¯æŒ

### è‡ªåŠ¨å®Œæˆç¤ºä¾‹

åœ¨ PyCharmã€VSCode ç­‰ IDE ä¸­ï¼š

```python
import never_primp

# è¾“å…¥ "response." å IDE ä¼šæ˜¾ç¤ºï¼š
response = never_primp.get("https://httpbin.org/get")
response.  # â† IDE è‡ªåŠ¨æç¤ºï¼š
           # - url: str
           # - status_code: int
           # - content: bytes
           # - text: str
           # - encoding: Optional[str]
           # - headers: Dict[str, str]
           # - cookies: Dict[str, str]
           # - json() â†’ Any
```

### å‚æ•°æç¤º

```python
# è¾“å…¥å‡½æ•°ååï¼ŒIDE ä¼šæ˜¾ç¤ºæ‰€æœ‰å‚æ•°å’Œç±»å‹ï¼š
Client(
    impersonate="chrome",  # â† IDE æ˜¾ç¤ºæ‰€æœ‰ 100+ æµè§ˆå™¨é€‰é¡¹
    impersonate_os="...",  # â† IDE æ˜¾ç¤ºï¼šwindows, macos, linux, android, ios
    timeout=30.0,          # â† IDE æ˜¾ç¤ºï¼šfloat
    verify=True,           # â† IDE æ˜¾ç¤ºï¼šbool
)
```

### ç±»å‹æ£€æŸ¥

ä½¿ç”¨ mypy æˆ– pyright è¿›è¡Œé™æ€ç±»å‹æ£€æŸ¥ï¼š

```python
response = never_primp.get("https://example.com")

# âœ“ æ­£ç¡®
status: int = response.status_code

# âœ— ç±»å‹é”™è¯¯ - mypy ä¼šæ£€æµ‹åˆ°
status: str = response.status_code  # Error: int is not compatible with str
```

## ç¤ºä¾‹æ–‡ä»¶

åˆ›å»ºäº†å®Œæ•´çš„ç¤ºä¾‹æ–‡ä»¶å±•ç¤ºæ‰€æœ‰åŠŸèƒ½ï¼š

1. **basic_usage.py** - åŸºæœ¬ä½¿ç”¨ç¤ºä¾‹
   - GET/POST è¯·æ±‚
   - æµè§ˆå™¨ä¼ªè£…
   - Context manager ä½¿ç”¨

2. **browser_impersonation.py** - æµè§ˆå™¨ä¼ªè£…ç¤ºä¾‹
   - 100+ æµè§ˆå™¨ç‰ˆæœ¬æµ‹è¯•
   - User-Agent éªŒè¯

3. **concurrent_requests.py** - å¹¶å‘è¯·æ±‚ç¤ºä¾‹
   - 50 ä¸ªå¹¶å‘è¯·æ±‚
   - ThreadPoolExecutor ä½¿ç”¨
   - è¿æ¥æ± ä¼˜åŒ–éªŒè¯

4. **response_guide.py** - Response å¯¹è±¡å®Œæ•´æŒ‡å—
   - æ‰€æœ‰å±æ€§è¯¦ç»†è¯´æ˜
   - ä½¿ç”¨æ¨¡å¼ç¤ºä¾‹
   - é”™è¯¯å¤„ç†ç¤ºä¾‹
   - æ‡’åŠ è½½æ¼”ç¤º

5. **type_hints_demo.py** - ç±»å‹æç¤ºæ¼”ç¤º
   - IDE è‡ªåŠ¨å®Œæˆå±•ç¤º
   - ç±»å‹æ£€æŸ¥ç¤ºä¾‹
   - å¸¸è§ä½¿ç”¨æ¨¡å¼

## æ–‡æ¡£

åˆ›å»ºäº†å®Œæ•´çš„æ–‡æ¡£ï¼š

1. **never_primp/never_primp.pyi** - ç±»å‹å­˜æ ¹æ–‡ä»¶ï¼ˆ300+ è¡Œï¼‰
2. **docs/IDE_GUIDE.md** - IDE ä½¿ç”¨æŒ‡å—ï¼ˆ400+ è¡Œï¼‰
3. **example/response_guide.py** - Response å¯¹è±¡ä½¿ç”¨æŒ‡å—ï¼ˆ280+ è¡Œï¼‰
4. **example/type_hints_demo.py** - ç±»å‹æç¤ºæ¼”ç¤ºï¼ˆ180+ è¡Œï¼‰

## æŠ€æœ¯è¦ç‚¹

### PyO3 ç»‘å®š

```rust
#[pyclass]
pub struct Response {
    inner: Arc<Mutex<Option<wreq::Response>>>,
    _content: Arc<Mutex<Option<Vec<u8>>>>,
    _text: Arc<Mutex<Option<String>>>,
    _encoding: Arc<Mutex<Option<String>>>,
    _headers: Arc<Mutex<Option<Py<PyDict>>>>,
    _cookies: Arc<Mutex<Option<Py<PyDict>>>>,

    #[pyo3(get)]
    pub url: String,

    #[pyo3(get)]
    pub status_code: u16,
}

#[pymethods]
impl Response {
    #[getter]
    fn content<'py>(&self, py: Python<'py>) -> PyResult<Bound<'py, PyBytes>> {
        // Check cache first
        if let Some(bytes) = &*self._content.lock().unwrap() {
            return Ok(PyBytes::new(py, bytes));
        }

        // Extract metadata before consuming response
        self.ensure_metadata_extracted(py)?;

        // Now safe to consume response body
        let bytes = /* ... fetch bytes ... */;

        // Cache for future access
        *self._content.lock().unwrap() = Some(bytes.clone());

        Ok(PyBytes::new(py, &bytes))
    }

    #[getter]
    fn encoding(&self, py: Python) -> PyResult<Option<String>> {
        // Return cached value if available
        if let Some(encoding) = &*self._encoding.lock().unwrap() {
            return Ok(Some(encoding.clone()));
        }
        // Extract and cache on first access
        // ...
    }
}
```

### Python å±‚å°è£…

```python
class Client:
    """Python wrapper with composition pattern."""

    def __init__(self, **kwargs):
        # Use composition instead of inheritance
        self._client = RClient(**kwargs)

    def get(self, url: str) -> Response:
        return self._client.get(url)

    # Context manager support
    def __enter__(self) -> Client:
        return self

    def __exit__(self, *args):
        pass
```

## æµ‹è¯•ç»“æœ

æ‰€æœ‰åŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼š

```
Test 1: Access content then text
  âœ“ SUCCESS: Can access both content and text

Test 2: Access text then content
  âœ“ SUCCESS: Can access both text and content

Test 3: Access json then text
  âœ“ SUCCESS: Can access both json and text

Test 4: Access all properties
  url: https://httpbin.org/get
  status_code: 200
  encoding: utf-8
  headers count: 6
  cookies count: 0
  content length: 248
  text length: 248
  json type: <class 'dict'>
  âœ“ SUCCESS: Can access all properties in any order
```

## ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
import never_primp

# ç®€å•è¯·æ±‚
response = never_primp.get("https://httpbin.org/get")
print(response.status_code)  # IDE æ˜¾ç¤ºç±»å‹ï¼šint
print(response.text)         # IDE æ˜¾ç¤ºç±»å‹ï¼šstr
data = response.json()       # IDE æ˜¾ç¤ºç±»å‹ï¼šAny

# æµè§ˆå™¨ä¼ªè£…
response = never_primp.get(
    "https://httpbin.org/get",
    impersonate="chrome_143",  # IDE è‡ªåŠ¨å®Œæˆæ˜¾ç¤ºæ‰€æœ‰é€‰é¡¹
    impersonate_os="windows"    # IDE è‡ªåŠ¨å®Œæˆæ˜¾ç¤ºï¼šwindows, macos, ...
)

# Client å®ä¾‹
with never_primp.Client(impersonate="firefox") as client:
    response = client.get("https://example.com")
    print(response.status_code)
```

### å¼‚æ­¥ä½¿ç”¨

```python
import asyncio
import never_primp

async def main():
    async with never_primp.AsyncClient(impersonate="safari") as client:
        response = await client.get("https://httpbin.org/get")
        print(response.json())

asyncio.run(main())
```

### Response å±æ€§è®¿é—®

```python
response = never_primp.get("https://httpbin.org/get")

# æ‰€æœ‰å±æ€§éƒ½å¯ç”¨ï¼Œä»»æ„é¡ºåºè®¿é—®
print(f"URL: {response.url}")
print(f"Status: {response.status_code}")
print(f"Encoding: {response.encoding}")

# Headers
for key, value in response.headers.items():
    print(f"{key}: {value}")

# Cookies
for name, value in response.cookies.items():
    print(f"{name}: {value}")

# Content
raw_bytes = response.content  # bytes
text = response.text          # str
data = response.json()        # dict/list/...
```

## æ€»ç»“

### å®Œæˆçš„å·¥ä½œ

1. âœ… åˆ›å»ºç±»å‹å­˜æ ¹æ–‡ä»¶ (`never_primp.pyi`)
2. âœ… æ·»åŠ  `py.typed` æ ‡è®°æ–‡ä»¶
3. âœ… ä¿®å¤ Response å¯¹è±¡å±æ€§è®¿é—®é¡ºåºé—®é¢˜
4. âœ… æš´éœ² `encoding` å±æ€§ç»™ Python
5. âœ… å®ç° metadata é¢„æå–æœºåˆ¶
6. âœ… åˆ›å»ºå®Œæ•´çš„ç¤ºä¾‹æ–‡ä»¶
7. âœ… ç¼–å†™ IDE ä½¿ç”¨æŒ‡å—
8. âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

### æ™ºèƒ½æç¤ºæ”¯æŒ

- âœ… æ‰€æœ‰ç±»å’Œæ–¹æ³•éƒ½æœ‰å®Œæ•´çš„ç±»å‹æ³¨è§£
- âœ… IDE è‡ªåŠ¨å®Œæˆæ”¯æŒï¼ˆPyCharmã€VSCodeã€Sublime Textï¼‰
- âœ… å‚æ•°ç±»å‹æç¤º
- âœ… è¿”å›å€¼ç±»å‹æç¤º
- âœ… Hover æ–‡æ¡£æ˜¾ç¤º
- âœ… Go to definition æ”¯æŒ
- âœ… mypy/pyright ç±»å‹æ£€æŸ¥æ”¯æŒ
- âœ… Literal ç±»å‹ç”¨äºæµè§ˆå™¨/OS é€‰é¡¹éªŒè¯

### ä½¿ç”¨ä½“éªŒ

ç”¨æˆ·åœ¨ IDE ä¸­ä½¿ç”¨æ—¶å°†è·å¾—ï¼š

1. **è‡ªåŠ¨å®Œæˆ**ï¼šè¾“å…¥å¯¹è±¡å + "." å³å¯çœ‹åˆ°æ‰€æœ‰å¯ç”¨æ–¹æ³•/å±æ€§
2. **å‚æ•°æç¤º**ï¼šè°ƒç”¨å‡½æ•°æ—¶æ˜¾ç¤ºæ‰€æœ‰å‚æ•°ç±»å‹å’Œé»˜è®¤å€¼
3. **ç±»å‹æ£€æŸ¥**ï¼šç¼–å†™æ—¶å°±èƒ½å‘ç°ç±»å‹é”™è¯¯
4. **æ–‡æ¡£æç¤º**ï¼šHover æ˜¾ç¤ºå®Œæ•´æ–‡æ¡£è¯´æ˜
5. **æ™ºèƒ½å¯¼èˆª**ï¼šCtrl+Click è·³è½¬åˆ°å®šä¹‰

### æ€§èƒ½ç‰¹ç‚¹

- ğŸš€ é«˜å¹¶å‘ï¼š512 è¿æ¥/ä¸»æœºï¼Œ2048 æ€»è¿æ¥æ± 
- ğŸ”’ çº¿ç¨‹å®‰å…¨ï¼šæ‰€æœ‰ç¼“å­˜ä½¿ç”¨ Arc<Mutex<>>
- âš¡ GIL é‡Šæ”¾ï¼šI/O æ“ä½œæ—¶é‡Šæ”¾ GILï¼Œå®ç°çœŸå¹¶å‘
- ğŸ’¾ æ™ºèƒ½ç¼“å­˜ï¼šå±æ€§å€¼é¦–æ¬¡è®¿é—®åç¼“å­˜
- ğŸ¯ æŒ‰éœ€åŠ è½½ï¼šåªåŠ è½½å®é™…ä½¿ç”¨çš„å±æ€§

åº“ç°åœ¨å·²ç»å®Œå…¨ready for production useï¼
