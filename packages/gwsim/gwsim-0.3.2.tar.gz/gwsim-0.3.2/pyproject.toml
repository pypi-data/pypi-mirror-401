[build-system]
requires = ["hatchling", "hatch-vcs"]
build-backend = "hatchling.build"

[project]
name =  "gwsim"
authors = [
    {name = "Isaac C. F. Wong", email = "chunfung.wong@kuleuven.be"},
]
description = "A Python package for simulating gravitational wave detector data for mock data challenges."
readme = "README.md"
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Science/Research",
    "Topic :: Scientific/Engineering :: Physics",
    "Topic :: Scientific/Engineering :: Astronomy",
    "License :: OSI Approved :: MIT License",
    "Programming Language :: Python :: 3 :: Only",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12"
]
requires-python = ">=3.10"
dynamic = ["version"]
dependencies = [
    "typer",
    "tqdm",
    "numpy",
    "h5py",
    "pycbc",
    "gengli",
    "bilby",
    "pydantic",
    "pymap3d",
    "psutil",
    "scipy<=1.16.3",
]

[project.optional-dependencies]
test = [
    "bandit[toml]==1.8.2",
    "black==25.12.0",
    "check-manifest==0.50",
    "flake8-bugbear==24.12.12",
    "flake8-docstrings",
    "flake8-formatter_junit_xml",
    "flake8",
    "flake8-pyproject",
    "pre-commit==4.1.0",
    "pytest-cov==6.0.0",
    "pytest-mock<3.14.1",
    "pytest-runner",
    "pytest==8.3.4",
    "pytest-github-actions-annotate-failures",
    "shellcheck-py==0.10.0.1"
]
dev = [
    "pytest",
    "pre-commit",
    "black",
    "flake8"
]
docs = [
    "mkdocs",
    "mkdocs-material",
    "mkdocstrings[python]",
    "mkdocs-gen-files",
    "mkdocs-literate-nav",
    "mkdocs-section-index"
]

[project.scripts]
gwsim = "gwsim.cli.main:app"

[project.urls]
Documentation = "https://leuven-gravity-institute.github.io/gwsim"
Source = "https://github.com/Leuven-Gravity-Institute/gwsim"
Tracker = "https://github.com/Leuven-Gravity-Institute/gwsim/issues"

[tool.hatch.version]
source = "vcs"

[tool.hatch.build.targets.wheel]
packages = ["src/gwsim"]

# Register the custom build hook
[tool.hatch.build.hooks.custom]
path = "hatch_build.py"

[tool.hatch.build.targets.sdist]
include = [
    "/src",           # Include the source code
    "/examples/**/*.yaml",  # Include only YAML files from examples
    "/tests",         # Include tests for source distributions
    "/README.md",
    "/pyproject.toml",
    "/hatch_build.py",  # Include the build hook itself
]

[tool.bandit]
exclude_dirs = ["build","dist","tests","scripts"]
number = 4
recursive = true
targets = "src"

[tool.black]
line-length = 120
fast = true

[tool.coverage.run]
branch = true

[tool.coverage.report]
fail_under = 0

[tool.coverage.xml]
output = "coverage.xml"

[tool.flake8]
max-line-length = 120
select = "F,E,W,B,B901,B902,B903"
exclude = [
    ".eggs",
    ".git",
    ".tox",
    "nssm",
    "obj",
    "out",
    "packages",
    "pywin32",
    "tests",
    "swagger_client"
]
ignore = [
    "E722",
    "B001",
    "W503",
    "E203"
]

[tool.pyright]
include = ["src"]
exclude = [
    "**/node_modules",
    "**/__pycache__",
]
venv = "env"

reportMissingImports = true
reportMissingTypeStubs = false

pythonVersion = "3.10"  # Match minimum supported version
pythonPlatform = "Linux"

executionEnvironments = [
  { root = "src" }
]

[tool.pytest.ini_options]
addopts = [
    "--cov=gwsim",
    "--cov-report=xml",
    "--cov-report=term",
    "--junitxml=test-results.xml",
    "--cov-append",
    "-m", "not integration"
]
pythonpath = [
    "src"
]
testpaths = "tests"
junit_family = "xunit2"
markers = [
    "integration: marks as integration test",
    "notebooks: marks as notebook test",
    "gpu: marks as gpu test",
    "spark: marks tests which need Spark",
    "slow: marks tests as slow",
    "unit: fast offline tests",
]

[tool.tox]
legacy_tox_ini = """
[tox]
envlist = py, integration, spark, all

[testenv]
commands =
    pytest -m "not integration and not spark" {posargs}

[testenv:integration]
commands =
    pytest -m "integration" {posargs}

[testenv:spark]
extras = spark
setenv =
       PYSPARK_DRIVER_PYTHON = {envpython}
       PYSPARK_PYTHON = {envpython}
commands =
    pytest -m "spark" {posargs}

[testenv:all]
extras = all
setenv =
       PYSPARK_DRIVER_PYTHON = {envpython}
       PYSPARK_PYTHON = {envpython}
commands =
    pytest {posargs}
"""

[tool.ruff]
line-length = 120  # Matches Black's default
target-version = "py310" # Align with CI (3.10â€“3.12) and requires-python (>=3.8.1)
lint.extend-select = [
  "E", "F", "W",  # pycodestyle errors and warnings
  "I",  # isort rules
  "UP",  # pyupgrade rules
  "C90",  # McCabe complexity
  "N",  # PEP8 naming
  "B",  # Bugbear (opinionated checks)
  "A",  # Flake8-builtins
  "C4",  # Flake8-comprehensions
  "PT",  # Flake8-pytest
  "RUF",  # Ruff-specific rules
  "PL",  # Add pylint rules for fuller coverage
  "SIM",  # Similarities
  "T10",  # Debugger statements
]
lint.ignore = [
  "E501",  # Line length (handled by formatter)
  "C901",  # Disable overly strict complexity checks (optional, adjust as needed)
]
lint.pylint.max-args = 10
fix = true  # Enable autofix
lint.unfixable = []  # List rules that should not be autofixed, if any
exclude = [
    "docs/conf.py"
]

[tool.ruff.format]
quote-style = "double"  # Use double quotes for strings
indent-style = "space"  # Use spaces for indentation
docstring-code-format = true  # Format code in docstrings

[tool.isort]
profile = "black"
line_length = 120
multi_line_output = 3
include_trailing_comma = true
force_grid_wrap = 0
use_parentheses = true
ensure_newline_before_comments = true
add_imports = ["from __future__ import annotations"]

[tool.pycln]
path = "src"
expand_stars = true
all = true

[tool.check-manifest]
ignore = [
    "examples/**/output/**",
    "examples/**/metadata/**",
    "examples/**/checkpoints/**",
    "hatch_build.py"
]
