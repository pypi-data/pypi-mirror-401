
{% extends 'base.html' %}
{% load helpers %}
{% load static %}
{% block title %}AI Chat Agent{% endblock %}

{% block content %}
  <!-- Marked.js -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <!-- DOMPurify (browser-optimized sanitizer) -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

  <!-- Chat Widget Styles -->
    <link rel="stylesheet" href="{% static 'ai_ops/css/chat_widget.css' %}">

    {% csrf_token %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <span class="card-title h4 mb-0">
                            <i class="mdi mdi-chat"></i> AI Chat Agent
                        </span>
                        <button id="clear-chat" class="btn btn-danger btn-sm float-end ms-2"
                                title="Clear chat history" {% if not chat_enabled %}disabled{% endif %}>
                            <i class="mdi mdi-delete"></i> Clear History
                        </button>
                    </div>

                    <div class="card-body p-0">
            <!-- Chat Messages Container -->
                        <div id="chat-messages"
                             role="log"
                             aria-live="polite"
                             aria-relevant="additions"
                             aria-atomic="false"
                             tabindex="0"
                             style="overflow-y:auto;">
              <!-- Messages will be dynamically added here -->
                        </div>

            <!-- Chat Input Area -->
                        <div class="bg-white p-3">
                            <div class="input-group">
                                <input type="text"
                                       id="chat-input"
                                       class="form-control"
                                       placeholder="{% if chat_enabled %}Type your message here...{% elif not has_default_model %}Chat disabled - configure default LLM model first{% else %}Chat disabled{% endif %}"
                                       style="height:45px;"
                                       {% if not chat_enabled %}disabled{% endif %}>
                                <button id="send-message"
                                        class="btn btn-primary"
                                        type="button"
                                        style="height:45px;"
                                        {% if not chat_enabled %}disabled{% endif %}>
                                    <i class="mdi mdi-send"></i> Send
                                </button>
                            </div>
                        </div>
                    </div> <!-- /card-body -->
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block javascript %}
    <script>
        window.CHAT_ENABLED = {{ chat_enabled|yesno:"true,false" }};
        window.HAS_DEFAULT_MODEL = {{ has_default_model|yesno:"true,false" }};
        window.HAS_HEALTHY_MCP = {{ has_healthy_mcp|yesno:"true,false" }};
        window.HAS_ANY_MCP = {{ has_any_mcp|yesno:"true,false" }};
        window.CHAT_TTL_MINUTES = {{ chat_session_ttl_minutes }};
    </script>
    <script src="{% static 'ai_ops/js/chat_widget.js' %}"></script>
{% endblock %}
