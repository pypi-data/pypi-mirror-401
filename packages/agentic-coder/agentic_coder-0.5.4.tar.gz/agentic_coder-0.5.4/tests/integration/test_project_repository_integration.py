"""Integration tests for ProjectRepository with real PostgreSQL."""

import pytest
from sqlalchemy.ext.asyncio import AsyncSession

from coding_agent_plugin.repositories.project import ProjectRepository
from coding_agent_plugin.schemas.project import ProjectSchema


@pytest.mark.asyncio
async def test_create_and_get_project(session: AsyncSession):
    repo = ProjectRepository(session)

    from coding_agent_plugin.models.project import ProjectCreate
    data = ProjectCreate(
        # id="int-test-1", # Removing ID as it's autogenerated
        project_name="Integration Project",
        description="Repo integration test",
        config={"k": "v"},
    )

    created = await repo.create(data)
    await session.commit()

    assert isinstance(created, ProjectSchema)
    assert isinstance(created.id, int)

    fetched = await repo.get_by_id(created.id)
    assert fetched is not None
    assert fetched.project_name == "Integration Project"
    assert fetched.config == {"k": "v"}


@pytest.mark.asyncio
async def test_update_and_delete_project(session: AsyncSession):
    repo = ProjectRepository(session)
    
    from coding_agent_plugin.models.project import ProjectCreate, ProjectUpdate

    created = await repo.create(
        ProjectCreate(
            project_name="Before",
            description=None,
            config={},
        )
    )
    await session.commit()

    updated = await repo.update(
        created.id,
        ProjectUpdate(project_name="After", description="Updated"),
    )
    await session.commit()

    assert updated is not None
    assert updated.project_name == "After"
    assert updated.description == "Updated"

    deleted = await repo.delete(created.id)
    await session.commit()

    assert deleted is True
    assert await repo.get_by_id(created.id) is None
