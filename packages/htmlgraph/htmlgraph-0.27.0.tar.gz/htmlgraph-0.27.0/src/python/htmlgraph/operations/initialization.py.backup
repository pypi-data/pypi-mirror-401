"""HtmlGraph initialization operations.

This module provides functions for initializing the .htmlgraph directory structure,
creating necessary files, and optionally installing Git hooks.

The initialization process includes:
1. Directory structure creation (.htmlgraph with subdirectories)
2. Database initialization (htmlgraph.db)
3. Index creation (index.sqlite)
4. Configuration files
5. Optional Git hooks installation

Extracted from monolithic cmd_init() implementation for better maintainability.
"""

from __future__ import annotations

import json
import sqlite3
import subprocess
import sys
from pathlib import Path
from typing import TYPE_CHECKING

if TYPE_CHECKING:
    from htmlgraph.cli.models import InitConfig, InitResult, ValidationResult


# Default collections to create
DEFAULT_COLLECTIONS = [
    "features",
    "bugs",
    "chores",
    "spikes",
    "epics",
    "phases",
    "tracks",
    "sessions",
    "insights",
    "metrics",
    "agents",
    "cigs",
]

# Additional directories
ADDITIONAL_DIRECTORIES = [
    "events",
    "logs",
    "archive-index",
    "archives",
]


def initialize_htmlgraph(config: InitConfig) -> InitResult:
    """Initialize .htmlgraph directory structure.

    Creates the standard HtmlGraph directory structure:
    - .htmlgraph/
      - features/
      - sessions/
      - spikes/
      - bugs/
      - tracks/
      - events/
      - logs/

    Args:
        config: Initialization configuration

    Returns:
        InitResult with success status and details
    """
    try:
        # Resolve directory path
        base_dir = Path(config.dir).resolve()
        htmlgraph_dir = base_dir / ".htmlgraph"

        created_dirs: list[str] = []
        updated_files: list[str] = []

        # Create main directory
        if not htmlgraph_dir.exists():
            htmlgraph_dir.mkdir(parents=True, exist_ok=True)
            created_dirs.append(str(htmlgraph_dir))

        # Create standard subdirectories
        subdirs = [
            "features",
            "sessions",
            "spikes",
            "bugs",
            "tracks",
            "events",
            "logs",
            "logs/errors",
        ]

        for subdir in subdirs:
            subdir_path = htmlgraph_dir / subdir
            if not subdir_path.exists():
                subdir_path.mkdir(parents=True, exist_ok=True)
                created_dirs.append(str(subdir_path))

        # Create .gitkeep in events directory (unless disabled)
        if not config.no_events_keep:
            events_dir = htmlgraph_dir / "events"
            gitkeep_file = events_dir / ".gitkeep"
            if not gitkeep_file.exists():
                gitkeep_file.touch()
                updated_files.append(str(gitkeep_file))

        # Update .gitignore (unless disabled)
        if not config.no_update_gitignore:
            gitignore_path = base_dir / ".gitignore"
            gitignore_entries = [
                "# HtmlGraph cache files",
                ".htmlgraph/index.sqlite",
                ".htmlgraph/htmlgraph.db",
                ".htmlgraph/sessions/*.jsonl",
                ".htmlgraph/events/*.jsonl",
                ".htmlgraph/parent-activity.json",
            ]

            # Read existing .gitignore
            existing_entries: set[str] = set()
            if gitignore_path.exists():
                existing_entries = set(
                    line.strip() for line in gitignore_path.read_text().splitlines()
                )

            # Add missing entries
            new_entries = [
                entry for entry in gitignore_entries if entry not in existing_entries
            ]

            if new_entries:
                mode = "a" if gitignore_path.exists() else "w"
                with gitignore_path.open(mode) as f:
                    if mode == "a":
                        f.write("\n")  # Add newline before appending
                    f.write("\n".join(new_entries) + "\n")
                updated_files.append(str(gitignore_path))

        # Initialize analytics index (unless disabled)
        if not config.no_index:
            from htmlgraph.analytics_index import AnalyticsIndex

            index_path = htmlgraph_dir / "index.sqlite"
            if not index_path.exists():
                # Create empty index (will be populated on first use)
                index = AnalyticsIndex(str(index_path))
                index.ensure_schema()
                created_dirs.append(str(index_path))

        # Install Git hooks (if requested)
        if config.install_hooks:
            from htmlgraph.operations.hooks import install_hooks

            try:
                hooks_result = install_hooks(project_dir=base_dir, use_copy=False)
                if hooks_result.installed:
                    updated_files.extend(hooks_result.installed)
                if hooks_result.warnings:
                    for warning in hooks_result.warnings:
                        print(f"Warning: {warning}", file=sys.stderr)
            except Exception as e:
                # Non-fatal: hooks installation failed but init succeeded
                print(f"Warning: Failed to install hooks: {e}", file=sys.stderr)

        # Interactive setup wizard (if requested)
        if config.interactive:
            _run_interactive_setup(htmlgraph_dir)

        # Build success message
        message_parts = []
        if created_dirs:
            message_parts.append(f"Created {len(created_dirs)} directories")
        if updated_files:
            message_parts.append(f"Updated {len(updated_files)} files")

        message = ", ".join(message_parts) if message_parts else "Already initialized"

        return InitResult(
            success=True,
            directory=htmlgraph_dir,
            message=message,
            created_dirs=created_dirs,
            updated_files=updated_files,
        )

    except Exception as e:
        return InitResult(
            success=False,
            directory=Path(config.dir).resolve() / ".htmlgraph",
            error=f"Initialization failed: {e}",
        )


def _run_interactive_setup(htmlgraph_dir: Path) -> None:
    """Run interactive setup wizard.

    Args:
        htmlgraph_dir: Path to .htmlgraph directory
    """
    print("\n=== HtmlGraph Interactive Setup ===\n")

    # Ask about project name
    project_name = input("Project name (optional, press Enter to skip): ").strip()

    # Ask about default agent
    default_agent = input("Default agent name (default: claude): ").strip()
    if not default_agent:
        default_agent = "claude"

    # Create config file
    config_file = htmlgraph_dir / "config.json"
    if not config_file.exists():
        import json

        config_data = {}
        if project_name:
            config_data["project_name"] = project_name
        config_data["default_agent"] = default_agent

        config_file.write_text(json.dumps(config_data, indent=2) + "\n")
        print(f"\n✓ Created config file: {config_file}")

    print("\n✓ Interactive setup complete!\n")
