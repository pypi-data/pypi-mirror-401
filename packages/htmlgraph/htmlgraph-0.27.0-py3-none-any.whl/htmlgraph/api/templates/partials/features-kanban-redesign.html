<div class="view-container features-view">
    <div class="view-header">
        <h2>Feature Tracker - Smart Kanban</h2>
        <div class="view-description">
            Drag cards between visible columns. Columns auto-collapse when others are opened.
        </div>
        <div class="view-filters">
            <div class="filter-group">
                <label>Quick Filter:</label>
                <select class="filter-select"
                        hx-get="/views/features"
                        hx-target="#content-area"
                        hx-trigger="change"
                        name="status">
                    <option value="all">All Status</option>
                    <option value="todo">To Do Only</option>
                    <option value="in_progress">In Progress Only</option>
                    <option value="blocked">Blocked Only</option>
                    <option value="done">Done Only</option>
                </select>
            </div>
        </div>
    </div>

    <div class="kanban-board">
        <!-- TO DO Column -->
        <div class="kanban-column todo-column" data-status="todo">
            <div class="column-header">
                <div>
                    <h3><span class="column-collapse-indicator">â–¼</span> To Do</h3>
                </div>
                <span class="column-count">{{ features_by_status.todo|length }}</span>
            </div>
            <div class="column-cards">
                {% for feature in features_by_status.todo %}
                <div class="feature-card todo-card" draggable="true" data-feature-id="{{ feature.id }}">
                    <div class="card-header">
                        <span class="feature-type-badge type-{{ feature.type }}">{{ feature.type }}</span>
                        <span class="priority-badge priority-{{ feature.priority }}">{{ feature.priority }}</span>
                    </div>
                    <h4 class="card-title">{{ feature.title }}</h4>
                    {% if feature.description %}
                    <p class="card-description">{{ feature.description[:100] }}{% if feature.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    <div class="card-footer">
                        <span class="feature-id" title="{{ feature.id }}">{{ feature.id[:8] }}</span>
                        {% if feature.assigned_to %}
                        <span class="assigned-to">ðŸ‘¤ {{ feature.assigned_to }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not features_by_status.todo %}
                <div class="empty-column">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- IN PROGRESS Column -->
        <div class="kanban-column in-progress-column" data-status="in_progress">
            <div class="column-header">
                <div>
                    <h3><span class="column-collapse-indicator">â–¼</span> In Progress</h3>
                </div>
                <span class="column-count">{{ features_by_status.in_progress|length }}</span>
            </div>
            <div class="column-cards">
                {% for feature in features_by_status.in_progress %}
                <div class="feature-card in-progress-card" draggable="true" data-feature-id="{{ feature.id }}">
                    <div class="card-header">
                        <span class="feature-type-badge type-{{ feature.type }}">{{ feature.type }}</span>
                        <span class="priority-badge priority-{{ feature.priority }}">{{ feature.priority }}</span>
                    </div>
                    <h4 class="card-title">{{ feature.title }}</h4>
                    {% if feature.description %}
                    <p class="card-description">{{ feature.description[:100] }}{% if feature.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    <div class="card-footer">
                        <span class="feature-id" title="{{ feature.id }}">{{ feature.id[:8] }}</span>
                        {% if feature.assigned_to %}
                        <span class="assigned-to">ðŸ‘¤ {{ feature.assigned_to }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not features_by_status.in_progress %}
                <div class="empty-column">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- BLOCKED Column (Collapsed by default) -->
        <div class="kanban-column blocked-column collapsed" data-status="blocked">
            <div class="column-header">
                <div>
                    <h3><span class="column-collapse-indicator">â–¶</span> Blocked</h3>
                </div>
                <span class="column-count">{{ features_by_status.blocked|length }}</span>
            </div>
            <div class="column-cards">
                {% for feature in features_by_status.blocked %}
                <div class="feature-card blocked-card" draggable="true" data-feature-id="{{ feature.id }}">
                    <div class="card-header">
                        <span class="feature-type-badge type-{{ feature.type }}">{{ feature.type }}</span>
                        <span class="priority-badge priority-{{ feature.priority }}">{{ feature.priority }}</span>
                    </div>
                    <h4 class="card-title">{{ feature.title }}</h4>
                    {% if feature.description %}
                    <p class="card-description">{{ feature.description[:100] }}{% if feature.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    <div class="card-footer">
                        <span class="feature-id" title="{{ feature.id }}">{{ feature.id[:8] }}</span>
                        {% if feature.assigned_to %}
                        <span class="assigned-to">ðŸ‘¤ {{ feature.assigned_to }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not features_by_status.blocked %}
                <div class="empty-column">No tasks</div>
                {% endif %}
            </div>
        </div>

        <!-- DONE Column (Collapsed by default) -->
        <div class="kanban-column done-column collapsed" data-status="done">
            <div class="column-header">
                <div>
                    <h3><span class="column-collapse-indicator">â–¶</span> Done</h3>
                </div>
                <span class="column-count">{{ features_by_status.done|length }}</span>
            </div>
            <div class="column-cards">
                {% for feature in features_by_status.done %}
                <div class="feature-card done-card" draggable="true" data-feature-id="{{ feature.id }}">
                    <div class="card-header">
                        <span class="feature-type-badge type-{{ feature.type }}">{{ feature.type }}</span>
                        <span class="priority-badge priority-{{ feature.priority }}">{{ feature.priority }}</span>
                    </div>
                    <h4 class="card-title">{{ feature.title }}</h4>
                    {% if feature.description %}
                    <p class="card-description">{{ feature.description[:100] }}{% if feature.description|length > 100 %}...{% endif %}</p>
                    {% endif %}
                    <div class="card-footer">
                        <span class="feature-id" title="{{ feature.id }}">{{ feature.id[:8] }}</span>
                        {% if feature.assigned_to %}
                        <span class="assigned-to">ðŸ‘¤ {{ feature.assigned_to }}</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% if not features_by_status.done %}
                <div class="empty-column">No tasks</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Smart Kanban Column Management
    class SmartKanban {
        constructor() {
            this.visibleColumns = ['todo', 'in_progress']; // Default visible columns
            this.openOrder = []; // Track which column was opened first
            this.init();
        }

        init() {
            // Load saved state from localStorage
            const saved = localStorage.getItem('kanban-visible-columns');
            if (saved) {
                this.visibleColumns = JSON.parse(saved);
                this.renderColumns();
            }

            // Setup column header click handlers
            document.querySelectorAll('.column-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    const column = header.closest('.kanban-column');
                    const status = column.dataset.status;
                    this.toggleColumn(status);
                });
            });

            // Setup drag and drop
            this.setupDragDrop();
        }

        toggleColumn(status) {
            if (this.visibleColumns.includes(status)) {
                // Column is visible, hide it
                this.visibleColumns = this.visibleColumns.filter(s => s !== status);
                this.openOrder = this.openOrder.filter(s => s !== status);
            } else {
                // Column is hidden, show it
                this.visibleColumns.push(status);
                this.openOrder.push(status);

                // Keep only 2 visible columns
                if (this.visibleColumns.length > 2) {
                    // Collapse oldest opened column (if not 'done' or 'blocked')
                    const toCollapse = this.openOrder.shift();
                    if (toCollapse && toCollapse !== 'done' && toCollapse !== 'blocked') {
                        this.visibleColumns = this.visibleColumns.filter(s => s !== toCollapse);
                    } else if (toCollapse) {
                        // If we need to collapse 'done' or 'blocked', find next oldest
                        for (let col of this.openOrder) {
                            if (col !== 'done' && col !== 'blocked') {
                                this.visibleColumns = this.visibleColumns.filter(s => s !== col);
                                this.openOrder = this.openOrder.filter(s => s !== col);
                                break;
                            }
                        }
                    }
                }
            }

            this.saveState();
            this.renderColumns();
        }

        renderColumns() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const status = column.dataset.status;
                const isVisible = this.visibleColumns.includes(status);

                column.classList.toggle('collapsed', !isVisible);
            });
        }

        saveState() {
            localStorage.setItem('kanban-visible-columns', JSON.stringify(this.visibleColumns));
        }

        setupDragDrop() {
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('feature-card')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('card-id', e.target.dataset.featureId);
                }
            });

            document.addEventListener('dragend', (e) => {
                document.querySelectorAll('.feature-card').forEach(card => {
                    card.classList.remove('dragging');
                });
            });

            document.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                // Only allow drops in visible columns
                const cardsList = e.target.closest('.column-cards');
                if (cardsList) {
                    const column = cardsList.closest('.kanban-column');
                    if (!column.classList.contains('collapsed')) {
                        cardsList.style.background = 'rgba(205, 255, 0, 0.1)';
                    }
                }
            });

            document.addEventListener('dragleave', (e) => {
                const cardsList = e.target.closest('.column-cards');
                if (cardsList) {
                    cardsList.style.background = '';
                }
            });

            document.addEventListener('drop', (e) => {
                e.preventDefault();
                const cardsList = e.target.closest('.column-cards');
                if (cardsList) {
                    const column = cardsList.closest('.kanban-column');
                    const cardId = e.dataTransfer.getData('card-id');
                    const card = document.querySelector(`[data-feature-id="${cardId}"]`);

                    if (card && !column.classList.contains('collapsed')) {
                        cardsList.appendChild(card);
                        cardsList.style.background = '';

                        // TODO: Send update to server
                        const newStatus = column.dataset.status;
                        console.log(`Move feature ${cardId} to ${newStatus}`);
                    }
                }
            });
        }
    }

    // Initialize when DOM is ready
    document.addEventListener('htmx:afterSettle', function(evt) {
        if (evt.detail.target.id === 'content-area' &&
            document.querySelector('.features-view')) {
            window.kanban = new SmartKanban();
        }
    });

    // Also initialize on page load if features are already visible
    if (document.querySelector('.features-view')) {
        window.kanban = new SmartKanban();
    }
</script>

<style>
    /* Kanban specific styles */
    .kanban-board {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: var(--spacing-lg);
        height: calc(100% - 100px);
    }

    .kanban-column {
        display: flex;
        flex-direction: column;
        background: var(--bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: 2px;
        overflow: hidden;
        transition: all var(--transition-base);
        min-height: 100px;
    }

    .kanban-column.collapsed {
        background: var(--bg-darker);
        max-height: 60px;
    }

    .column-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg);
        background: var(--bg-darker);
        border-bottom: 1px solid var(--border-subtle);
        cursor: pointer;
        transition: all var(--transition-base);
        user-select: none;
    }

    .column-header:hover {
        background: var(--bg-hover);
    }

    .column-header h3 {
        margin: 0;
        font-size: 1rem;
        color: var(--accent-lime);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .column-count {
        background: var(--accent-lime);
        color: var(--bg-dark);
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 2px;
        font-weight: 700;
        font-size: 0.8rem;
        min-width: 32px;
        text-align: center;
    }

    .column-cards {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
        transition: background-color var(--transition-base);
    }

    .kanban-column.collapsed .column-cards {
        display: none;
    }

    .feature-card {
        background: var(--bg-darker);
        border: 1px solid var(--border-subtle);
        border-radius: 2px;
        padding: var(--spacing-lg);
        cursor: grab;
        transition: all var(--transition-base);
        flex-shrink: 0;
        user-select: none;
    }

    .feature-card:hover {
        border-color: var(--accent-lime);
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .feature-card.dragging {
        opacity: 0.5;
        cursor: grabbing;
        transform: rotate(-5deg) scale(0.95);
    }

    .card-header {
        display: flex;
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-md);
        flex-wrap: wrap;
    }

    .feature-type-badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 2px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        background: var(--bg-card);
        color: var(--accent-lime);
        border: 1px solid var(--border-subtle);
    }

    .priority-badge {
        padding: var(--spacing-xs) var(--spacing-sm);
        border-radius: 2px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border: 1px solid;
    }

    .priority-badge.high {
        background: rgba(239, 68, 68, 0.15);
        color: var(--status-blocked);
        border-color: var(--status-blocked);
    }

    .priority-badge.medium {
        background: rgba(251, 191, 36, 0.15);
        color: #FBBF24;
        border-color: #FBBF24;
    }

    .priority-badge.low {
        background: rgba(34, 197, 94, 0.15);
        color: var(--status-success);
        border-color: var(--status-success);
    }

    .card-title {
        color: var(--text-primary);
        font-size: 0.95rem;
        margin: 0;
        line-height: 1.4;
        font-weight: 600;
    }

    .card-description {
        color: var(--text-secondary);
        font-size: 0.85rem;
        margin: var(--spacing-md) 0 0 0;
        line-height: 1.5;
    }

    .card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: var(--spacing-md);
        padding-top: var(--spacing-md);
        border-top: 1px solid var(--border-subtle);
        font-size: 0.8rem;
        color: var(--text-secondary);
    }

    .feature-id {
        font-family: 'JetBrains Mono', monospace;
        color: var(--accent-lime);
        font-weight: 600;
    }

    .assigned-to {
        color: var(--text-muted);
    }

    .empty-column {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100px;
        color: var(--text-muted);
        font-size: 0.85rem;
        text-align: center;
        padding: var(--spacing-lg);
    }

    @media (max-width: 1024px) {
        .kanban-board {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .kanban-board {
            grid-template-columns: 1fr;
        }
    }
</style>
