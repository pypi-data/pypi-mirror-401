name: Publish to PyPI

on:
  push:
    tags:
      - 'v*'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install whatnext
        run: pip install .[test]

      - name: Install testing dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bats ripgrep

      - name: Run tests
        run: make test

  publish:
    runs-on: ubuntu-latest
    needs: test
    permissions:
      id-token: write

    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install build tools
        run: pip install build

      - name: Build package
        run: python -m build

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  release:
    runs-on: ubuntu-latest
    needs: publish
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v6

      - name: Get version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> "$GITHUB_OUTPUT"

      - name: Extract changelog for version
        id: changelog
        run: |
          version="${{ steps.version.outputs.version }}"
          changelog=$(awk -v ver="$version" '
            /^## \[/ {
              if (found) exit
              if ($0 ~ "\\[v" ver "\\]") found=1
              next
            }
            found { print }
          ' CHANGELOG.md)
          {
            echo "notes<<EOF"
            echo "$changelog"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ github.token }}
          NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          version="${{ steps.version.outputs.version }}"
          pypi_link="https://pypi.org/project/whatnext/${version}/"
          full_notes=$(printf '%s\n\n---\n[pypi release](%s)' "$NOTES" "$pypi_link")
          gh release create "${{ github.ref_name }}" \
            --title "whatnext ${version}" \
            --notes "$full_notes"
