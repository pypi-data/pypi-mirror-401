<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAAQEAAAEAIAAwAAAAFgAAACgAAAABAAAAAgAAAAEAIAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAPAAAAAA=="/>
    <link rel="stylesheet" href="css/prism.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/font-awesome.css">
    <style>
        /* Prevent the main page from scrolling */
    html, body {
        height: 100%;
        margin: 0;
        overflow: hidden; 
    }
    /* The main wrapper for your app */
    #app {
        display: flex;
        flex-direction: column;
        height: 100vh; /* Full viewport height */
    }
    /* The scrollable area */
    .notebook-area {
        flex-grow: 1;      /* Take up all remaining space */
        overflow-y: auto;  /* Scroll only this div */
        padding-top: 1.5rem;
    }
    </style>
  </head>
  <body class="has-navbar-fixed-top">
    
    <script type="text/x-template" id="app-template">

        <app-navbar 
            :is-locked="isLocked"
            :running="running"
            :has-notebook="!!notebook"
            :last-run-index="lastRunIndex"
            :cell-count="notebook ? notebook.cells.length : 0"
            :has-api-key="!!geminiApiKey"
            @lock="lockNotebook"
            @refresh="reloadNotebook"
            @interrupt="interruptKernel"
            @regenerate-all="regenerateAllCode"
            @reset-run-all="resetAndRunAllCells"
            @open-info="showInfo = true"
            @open-settings="showSettings = true"
        />    

        <div v-if="uiError" class="notification mb-0 mt-0 px-4 pl-2 pr-6 has-text-danger has-background-danger-light" 
            style="width: 100%; border-radius: 0; align-items: center; justify-content: space-between;">
            <span><strong>Error:</strong> {{ uiError }}</span>
            <button class="delete" @click="closeUiError"></button>
        </div>

        <div class="section notebook-area">
            <h1 class="title">
                {{ notebook_name }}
            </h1>
            <div class="notebook-container px-2 py-2">
                <div v-if="loading" class="has-text-centered py-6">
                    <button class="button is-loading is-ghost is-large">Loading</button>
                    <p class="has-text-grey">Fetching notebook data...</p>
                </div>
                <div v-else-if="error" class="notification is-danger is-light">
                    <button class="delete" @click="error = null"></button>
                    <strong>Error:</strong> {{ error }}
                </div>
                <div v-else="notebook">

                    <cell-insertion-zone v-if="!isLocked"
                        @insert="(celltype) => insertCell(0, celltype)" 
                    />

                    <template v-for="(cell, index) in notebook.cells" :key="index">

                        <notebook-cell 
                            :cell="cell"
                            :is-active="activeIndex === index"
                            :needs-running="index > lastRunIndex"
                            :is-locked="isLocked"
                            :last-run-index="lastRunIndex"
                            :as-read="asRead"
                            :markdown-edit-key="markdownEditKey[index]"
                            :explanation-edit-key="explanationEditKey[index]"
                            @click="setActiveCell(index)"
                            
                            @save-markdown="(content) => sendMarkdownToServer(content, index)"
                            @save-explanation="(content) => sendExplanationToServer(content, index)"
                            @save-code="(content) => sendCodeToServer(content, index)"
                            @save-and-run="(content) => saveExplanationAndRun(content, index)"
                            
                            @run-cell="runCell(index)"
                            @generate-code="generateCode(index)"
                            @validate-code="validateCode(index)"
                            @dismiss-validation="dismissValidation(index)"
                            
                            @delete="deleteCell(index)"
                            @move-up="moveCell(index, -1)"
                            @move-down="moveCell(index, 1)"
                        />

                        <cell-insertion-zone v-if="!isLocked"
                            @insert="(celltype) => insertCell(index + 1, celltype)" 
                        />

                    </template>
                    
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <settings-modal 
            :is-active="showSettings" 
            :api-key="geminiApiKey" 
            @close="showSettings = false" 
            @save="(newKey) => {showSettings = false; saveSettings(newKey); }" 
        />
        <!-- Info Modal -->
        <info-modal 
            :is-active="showInfo" 
            @close="showInfo = false" 
        />

    </script>
    
    <footer class="footer">
    </footer>
  </body>
  <!-- Loads the index-specific js for Vue -->
  <script src="js/prism.min.js"></script>
  <script src="js/prism-python.min.js"></script>
  <script src="js/markdown-it.min.js"></script>
  <script type="module" src="js/nb.js"></script>
</html>

