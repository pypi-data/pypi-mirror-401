"use strict";(self.webpackChunkopenagents_studio=self.webpackChunkopenagents_studio||[]).push([[623],{5623:(e,t,n)=>{n.r(t),n.d(t,{YjsCollaborativeEditor:()=>g,default:()=>p});var o=n(5043),s=n(5946),r=n(2275),i=n(94),a=n(6328),c=n(9379),d=n(1465);class l{constructor(e,t,n){this.ydoc=void 0,this.connection=void 0,this.documentId=void 0,this.awareness=void 0,this.isInitialized=!1,this.updateHandler=null,this.eventListener=null,this.ydoc=e,this.connection=t,this.documentId=n,this.awareness=new d.ww(e),console.log("\ud83d\udce1 [Yjs Provider] Initializing for document:",n),console.log("\ud83d\udce1 [Yjs Provider] Y.Doc client ID:",e.clientID),this.setupYjsListeners(),this.setupEventListeners(),this.setupAwarenessListeners(),this.isInitialized=!0,console.log("\u2705 [Yjs Provider] All listeners setup complete")}setupYjsListeners(){this.updateHandler=(e,t)=>{if("remote"===t)return void console.log("\u23ed\ufe0f  [Yjs Update] Skipping remote-originated update");console.log("\ud83d\udce4 [Yjs Update \u2192 Backend] Sending local update",{size:e.length,documentId:this.documentId,origin:t,clientID:this.ydoc.clientID});const n=Array.from(e);this.connection.sendEvent({event_name:"document.yjs_update",destination_id:"mod:openagents.mods.workspace.documents",payload:{document_id:this.documentId,update:n}}).catch((e=>{console.error("\u274c Failed to send Yjs update:",e)}))},this.ydoc.on("update",this.updateHandler)}setupEventListeners(){this.eventListener=e=>{const{document_id:t,update:n}=e.detail;if(t===this.documentId)if(console.log("\ud83d\udce5 [Yjs Update \u2190 Backend] Received remote update",{size:null===n||void 0===n?void 0:n.length,documentId:t,source_agent_id:e.detail.source_agent_id,myClientID:this.ydoc.clientID}),n&&Array.isArray(n))try{const e=new Uint8Array(n);r.QE(this.ydoc,e,"remote"),console.log("\u2705 Yjs update applied successfully")}catch(o){console.error("\u274c Failed to apply Yjs update:",o)}else console.error("\u274c Invalid update format:",n);else console.log("\u23ed\ufe0f  [Yjs Update] Ignoring update for different document:",t)},window.addEventListener("document-yjs-update",this.eventListener)}setupAwarenessListeners(){this.awareness.on("change",(()=>{const e=this.awareness.getLocalState();e&&e.cursor&&(console.log("\ud83d\udccd Local awareness changed:",e),this.connection.sendEvent({event_name:"document.awareness_update",destination_id:"mod:openagents.mods.workspace.documents",payload:{document_id:this.documentId,awareness_state:e}}).catch((e=>{console.error("\u274c Failed to send awareness update:",e)})))}));window.addEventListener("document-awareness-update",(e=>{const{document_id:t,client_id:n,awareness_state:o}=e.detail;var s;t===this.documentId&&(console.log("\ud83d\udccd Received remote awareness update:",{client_id:n,awareness_state:o}),o&&this.awareness.setLocalStateField("clients",(0,c.A)((0,c.A)({},(null===(s=this.awareness.getLocalState())||void 0===s?void 0:s.clients)||{}),{},{[n]:o})))}))}getAwareness(){return this.awareness}async initialize(e){console.log("\ud83d\udd04 [Yjs Init] Starting initialization");const t=this.ydoc.getText("monaco");try{return console.log("\ud83d\udd04 [Yjs Init] Attempting to sync from server Yjs state..."),await this.syncWithServer(),void console.log("\u2705 [Yjs Init] Synced from server, document length:",t.length)}catch(n){console.warn("\u26a0\ufe0f  [Yjs Init] Server Yjs sync failed, falling back to initialContent:",n)}e&&0===t.length&&(console.log("\ud83d\udcdd [Yjs Init] Initializing with fallback content, length:",e.length),this.ydoc.transact((()=>{t.insert(0,e)}),"init"),console.log("\u2705 [Yjs Init] Initialized with fallback content")),console.log("\u2705 [Yjs Init] Initialization complete, document length:",t.length)}getText(){return this.ydoc.getText("monaco")}async syncWithServer(){console.log("\ud83d\udd04 [Yjs Sync] Requesting full document state from server");try{var e;const t=await this.connection.sendEvent({event_name:"document.yjs_sync",destination_id:"mod:openagents.mods.workspace.documents",payload:{document_id:this.documentId}});if(console.log("\ud83d\udd04 [Yjs Sync] Server response:",t),!t.success||null===(e=t.data)||void 0===e||!e.yjs_state)throw new Error(t.message||"No Yjs state returned from server");{console.log("\ud83d\udce5 [Yjs Sync] Applying state from server, size:",t.data.yjs_state.length);const e=new Uint8Array(t.data.yjs_state);r.QE(this.ydoc,e,"remote"),console.log("\u2705 [Yjs Sync] State applied successfully")}}catch(t){throw console.error("\u274c [Yjs Sync] Failed to sync with server:",t),t}}destroy(){console.log("\ud83d\uded1 Destroying OpenAgentsYjsProvider"),this.updateHandler&&this.ydoc.off("update",this.updateHandler),this.eventListener&&window.removeEventListener("document-yjs-update",this.eventListener),this.isInitialized=!1}isReady(){return this.isInitialized}getContent(){return this.ydoc.getText("monaco").toString()}}var u=n(4896),m=n(579);const g=e=>{let{documentId:t,initialContent:n,onSave:c,readOnly:d=!1,language:g="markdown"}=e;const{connector:p}=(0,u.Cd)(),h=(0,o.useRef)(null),y=(0,o.useRef)(null),v=(0,o.useRef)(null),w=(0,o.useRef)(null),f=(0,o.useRef)(null),[b,j]=(0,o.useState)([]),[x,I]=(0,o.useState)("syncing"),_=(0,o.useRef)(!1),Y=(0,o.useRef)([]);(0,o.useEffect)((()=>{if(!p||!t||_.current)return;console.log("\ud83d\ude80 [Yjs Init] Initializing YjsCollaborativeEditor for document:",t),_.current=!0;const e=new r.JA;v.current=e;const o=new l(e,p,t);return w.current=o,o.initialize(n).then((()=>{console.log("\u2705 [Yjs Init] Provider initialized successfully"),I("synced")})).catch((e=>{console.error("\u274c [Yjs Init] Provider initialization failed:",e),I("error")})),()=>{console.log("\ud83d\uded1 [Yjs Cleanup] Cleaning up YjsCollaborativeEditor"),f.current&&(f.current.destroy(),f.current=null),w.current&&(w.current.destroy(),w.current=null),v.current&&(v.current.destroy(),v.current=null),_.current=!1}}),[p,t,n]);const k=(0,o.useCallback)(((e,n)=>{if(console.log("\ud83d\udcdd Monaco editor mounted"),h.current=e,y.current=n,!v.current||!w.current)return void console.error("\u274c Yjs not initialized when editor mounted");const o=w.current.getText(),s=w.current.getAwareness(),r=new i.h(o,e.getModel(),new Set([e]),s);f.current=r,console.log("\u2705 Monaco binding created with awareness"),e.onDidChangeCursorPosition((e=>{d||null===p||void 0===p||p.sendEvent({event_name:"document.cursor_update",destination_id:"mod:openagents.mods.workspace.documents",payload:{document_id:t,position:{lineNumber:e.position.lineNumber,column:e.position.column}}}).catch((e=>{console.error("\u274c Failed to send cursor update:",e)}))}));const a=e=>{const{document_id:n,agent_id:o,position:s}=e.detail;n===t&&j((e=>[...e.filter((e=>e.agentId!==o)),{agentId:o,position:s}]))};return window.addEventListener("document-cursor-update",a),()=>{window.removeEventListener("document-cursor-update",a)}}),[p,t,d]);(0,o.useEffect)((()=>{if(!h.current||!y.current)return;const e=h.current,t=y.current,n=[];b.forEach((e=>{const{lineNumber:o,column:s}=e.position;n.push({range:new t.Range(o,s,o,s),options:{className:"remote-cursor remote-cursor-".concat(e.agentId.replace(/[^a-zA-Z0-9]/g,"_")),beforeContentClassName:"remote-cursor-caret",after:{content:" ".concat(e.agentId.substring(0,12)),inlineClassName:"remote-cursor-label-text"}}})})),Y.current=e.deltaDecorations(Y.current,n)}),[b]);const E=(0,o.useCallback)((()=>{if(!w.current)return;const e=w.current.getContent();c&&c(e),null===p||void 0===p||p.sendEvent({event_name:"document.save",destination_id:"mod:openagents.mods.workspace.documents",payload:{document_id:t,content:e}}).then((()=>{console.log("\u2705 Document saved"),I("synced"),a.oR.success("Document saved successfully")})).catch((e=>{console.error("\u274c Failed to save document:",e),I("error"),a.oR.error("Failed to save document")}))}),[p,t,c]);return(0,o.useEffect)((()=>{const e=e=>{(e.metaKey||e.ctrlKey)&&"s"===e.key&&(e.preventDefault(),E())};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)}),[E]),(0,m.jsxs)("div",{className:"yjs-collaborative-editor relative h-full w-full",children:[(0,m.jsxs)("div",{className:"absolute top-2 right-2 z-10 flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1 rounded-md shadow-sm border border-gray-200 dark:border-gray-700",children:[(0,m.jsxs)("div",{className:"flex items-center gap-2",children:[(0,m.jsx)("div",{className:"w-2 h-2 rounded-full ".concat("synced"===x?"bg-green-500":"syncing"===x?"bg-yellow-500 animate-pulse":"bg-red-500")}),(0,m.jsx)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:"synced"===x?"Synced":"syncing"===x?"Syncing...":"Error"})]}),b.length>0&&(0,m.jsx)("div",{className:"flex items-center gap-1 border-l border-gray-300 dark:border-gray-600 pl-2",children:(0,m.jsxs)("span",{className:"text-xs text-gray-600 dark:text-gray-400",children:[b.length," ",1===b.length?"user":"users"]})}),(0,m.jsx)("button",{onClick:E,disabled:d,className:"ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed",children:"Save"})]}),(0,m.jsx)(s.default,{height:"100%",language:g,theme:"vs-dark",onMount:k,options:{readOnly:d,minimap:{enabled:!0},fontSize:14,lineNumbers:"on",wordWrap:"on",automaticLayout:!0,scrollBeyondLastLine:!1,tabSize:2}}),(0,m.jsx)("style",{children:"\n        .remote-cursor {\n          border-left: 2px solid #4CAF50 !important;\n          margin-left: -1px;\n          pointer-events: none;\n        }\n\n        .remote-cursor-caret {\n          position: absolute;\n          width: 2px;\n          height: 1.2em;\n          background-color: #4CAF50;\n          pointer-events: none;\n        }\n\n        .remote-cursor-label-text {\n          display: inline-block;\n          padding: 1px 4px;\n          margin-left: 2px;\n          font-size: 10px;\n          background-color: #4CAF50;\n          color: white;\n          border-radius: 2px;\n          white-space: nowrap;\n          pointer-events: none;\n        }\n\n        /* Different colors for different users */\n        .remote-cursor-1 .remote-cursor-caret,\n        .remote-cursor-1 .remote-cursor-label-text {\n          background-color: #4CAF50;\n        }\n\n        .remote-cursor-2 .remote-cursor-caret,\n        .remote-cursor-2 .remote-cursor-label-text {\n          background-color: #2196F3;\n        }\n\n        .remote-cursor-3 .remote-cursor-caret,\n        .remote-cursor-3 .remote-cursor-label-text {\n          background-color: #FF9800;\n        }\n\n        .remote-cursor-4 .remote-cursor-caret,\n        .remote-cursor-4 .remote-cursor-label-text {\n          background-color: #E91E63;\n        }\n\n        .remote-cursor-5 .remote-cursor-caret,\n        .remote-cursor-5 .remote-cursor-label-text {\n          background-color: #9C27B0;\n        }\n      "})]})},p=g}}]);
//# sourceMappingURL=623.fbc55d8c.chunk.js.map