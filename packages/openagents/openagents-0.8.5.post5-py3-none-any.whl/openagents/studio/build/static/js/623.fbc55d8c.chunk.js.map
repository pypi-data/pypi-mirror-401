{"version":3,"file":"static/js/623.fbc55d8c.chunk.js","mappings":"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","sources":["providers/OpenAgentsYjsProvider.ts","components/documents/YjsCollaborativeEditor.tsx"],"sourcesContent":["/**\n * OpenAgentsYjsProvider - Custom Yjs provider for OpenAgents event system\n *\n * This provider connects Yjs documents to the OpenAgents event system,\n * allowing real-time collaborative editing without WebSocket.\n */\n\nimport * as Y from 'yjs';\nimport { Awareness } from 'y-protocols/awareness';\n\nexport interface OpenAgentsConnection {\n  sendEvent: (event: any) => Promise<any>;\n}\n\nexport class OpenAgentsYjsProvider {\n  private ydoc: Y.Doc;\n  private connection: OpenAgentsConnection;\n  private documentId: string;\n  public awareness: Awareness;\n  private isInitialized: boolean = false;\n  private updateHandler: ((update: Uint8Array, origin: any) => void) | null = null;\n  private eventListener: ((event: CustomEvent) => void) | null = null;\n\n  constructor(\n    ydoc: Y.Doc,\n    connection: OpenAgentsConnection,\n    documentId: string\n  ) {\n    this.ydoc = ydoc;\n    this.connection = connection;\n    this.documentId = documentId;\n    this.awareness = new Awareness(ydoc);\n\n    console.log('üì° [Yjs Provider] Initializing for document:', documentId);\n    console.log('üì° [Yjs Provider] Y.Doc client ID:', ydoc.clientID);\n\n    this.setupYjsListeners();\n    this.setupEventListeners();\n    this.setupAwarenessListeners();\n    this.isInitialized = true;\n\n    console.log('‚úÖ [Yjs Provider] All listeners setup complete');\n  }\n\n  /**\n   * Set up Yjs document listeners to send local updates\n   */\n  private setupYjsListeners() {\n    this.updateHandler = (update: Uint8Array, origin: any) => {\n      // Don't send updates that came from remote (avoid loops)\n      if (origin === 'remote') {\n        console.log('‚è≠Ô∏è  [Yjs Update] Skipping remote-originated update');\n        return;\n      }\n\n      console.log('üì§ [Yjs Update ‚Üí Backend] Sending local update', {\n        size: update.length,\n        documentId: this.documentId,\n        origin: origin,\n        clientID: this.ydoc.clientID\n      });\n\n      // Convert Uint8Array to regular array for JSON serialization\n      const updateArray = Array.from(update);\n\n      // Send through OpenAgents event system\n      this.connection.sendEvent({\n        event_name: 'document.yjs_update',\n        destination_id: 'mod:openagents.mods.workspace.documents',\n        payload: {\n          document_id: this.documentId,\n          update: updateArray,\n        },\n      }).catch((error) => {\n        console.error('‚ùå Failed to send Yjs update:', error);\n      });\n    };\n\n    this.ydoc.on('update', this.updateHandler);\n  }\n\n  /**\n   * Set up event listeners to receive remote updates\n   */\n  private setupEventListeners() {\n    this.eventListener = (event: CustomEvent) => {\n      const { document_id, update } = event.detail;\n\n      // Only process updates for this document\n      if (document_id !== this.documentId) {\n        console.log('‚è≠Ô∏è  [Yjs Update] Ignoring update for different document:', document_id);\n        return;\n      }\n\n      console.log('üì• [Yjs Update ‚Üê Backend] Received remote update', {\n        size: update?.length,\n        documentId: document_id,\n        source_agent_id: event.detail.source_agent_id,\n        myClientID: this.ydoc.clientID\n      });\n\n      if (!update || !Array.isArray(update)) {\n        console.error('‚ùå Invalid update format:', update);\n        return;\n      }\n\n      try {\n        // Convert array back to Uint8Array\n        const updateBytes = new Uint8Array(update);\n\n        // Apply update with 'remote' origin to prevent echo\n        Y.applyUpdate(this.ydoc, updateBytes, 'remote');\n\n        console.log('‚úÖ Yjs update applied successfully');\n      } catch (error) {\n        console.error('‚ùå Failed to apply Yjs update:', error);\n      }\n    };\n\n    // Listen for Yjs updates from OpenAgents\n    window.addEventListener('document-yjs-update', this.eventListener as EventListener);\n  }\n\n  /**\n   * Set up awareness listeners to sync cursor positions\n   */\n  private setupAwarenessListeners() {\n    // Listen for local awareness changes\n    this.awareness.on('change', () => {\n      const localState = this.awareness.getLocalState();\n\n      if (localState && localState.cursor) {\n        console.log('üìç Local awareness changed:', localState);\n\n        // Send awareness update through OpenAgents\n        this.connection.sendEvent({\n          event_name: 'document.awareness_update',\n          destination_id: 'mod:openagents.mods.workspace.documents',\n          payload: {\n            document_id: this.documentId,\n            awareness_state: localState,\n          },\n        }).catch((error) => {\n          console.error('‚ùå Failed to send awareness update:', error);\n        });\n      }\n    });\n\n    // Listen for remote awareness updates\n    const awarenessListener = (event: CustomEvent) => {\n      const { document_id, client_id, awareness_state } = event.detail;\n\n      if (document_id !== this.documentId) return;\n\n      console.log('üìç Received remote awareness update:', { client_id, awareness_state });\n\n      // Update remote awareness state\n      if (awareness_state) {\n        this.awareness.setLocalStateField('clients', {\n          ...(this.awareness.getLocalState()?.clients || {}),\n          [client_id]: awareness_state,\n        });\n      }\n    };\n\n    window.addEventListener('document-awareness-update', awarenessListener as EventListener);\n  }\n\n  /**\n   * Get the Awareness instance for MonacoBinding\n   */\n  getAwareness(): Awareness {\n    return this.awareness;\n  }\n\n  /**\n   * Initialize the document by fetching initial state from server\n   */\n  async initialize(initialContent?: string): Promise<void> {\n    console.log('üîÑ [Yjs Init] Starting initialization');\n\n    const ytext = this.ydoc.getText('monaco');\n\n    // STEP 1: Try to sync with server's Yjs state first (most up-to-date CRDT state)\n    // This includes all edits from all users, even unsaved changes\n    try {\n      console.log('üîÑ [Yjs Init] Attempting to sync from server Yjs state...');\n      await this.syncWithServer();\n      console.log('‚úÖ [Yjs Init] Synced from server, document length:', ytext.length);\n      return; // Successfully synced, we're done\n    } catch (error) {\n      console.warn('‚ö†Ô∏è  [Yjs Init] Server Yjs sync failed, falling back to initialContent:', error);\n    }\n\n    // STEP 2: Fallback - only use initialContent if server sync failed\n    // This happens when server has no Yjs state yet (e.g., first user to open the document)\n    if (initialContent && ytext.length === 0) {\n      console.log('üìù [Yjs Init] Initializing with fallback content, length:', initialContent.length);\n      this.ydoc.transact(() => {\n        ytext.insert(0, initialContent);\n      }, 'init');\n      console.log('‚úÖ [Yjs Init] Initialized with fallback content');\n    }\n\n    console.log('‚úÖ [Yjs Init] Initialization complete, document length:', ytext.length);\n  }\n\n  /**\n   * Get the Yjs text object for Monaco binding\n   */\n  getText(): Y.Text {\n    return this.ydoc.getText('monaco');\n  }\n\n  /**\n   * Sync with server - request full document state\n   */\n  async syncWithServer(): Promise<void> {\n    console.log('üîÑ [Yjs Sync] Requesting full document state from server');\n\n    try {\n      const response = await this.connection.sendEvent({\n        event_name: 'document.yjs_sync',\n        destination_id: 'mod:openagents.mods.workspace.documents',\n        payload: {\n          document_id: this.documentId,\n        },\n      });\n\n      console.log('üîÑ [Yjs Sync] Server response:', response);\n\n      if (response.success && response.data?.yjs_state) {\n        console.log('üì• [Yjs Sync] Applying state from server, size:', response.data.yjs_state.length);\n        const state = new Uint8Array(response.data.yjs_state);\n        Y.applyUpdate(this.ydoc, state, 'remote');\n        console.log('‚úÖ [Yjs Sync] State applied successfully');\n      } else {\n        throw new Error(response.message || 'No Yjs state returned from server');\n      }\n    } catch (error) {\n      console.error('‚ùå [Yjs Sync] Failed to sync with server:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * Clean up listeners and connections\n   */\n  destroy() {\n    console.log('üõë Destroying OpenAgentsYjsProvider');\n\n    if (this.updateHandler) {\n      this.ydoc.off('update', this.updateHandler);\n    }\n\n    if (this.eventListener) {\n      window.removeEventListener('document-yjs-update', this.eventListener as EventListener);\n    }\n\n    this.isInitialized = false;\n  }\n\n  /**\n   * Check if provider is connected and ready\n   */\n  isReady(): boolean {\n    return this.isInitialized;\n  }\n\n  /**\n   * Get current document content as plain text\n   */\n  getContent(): string {\n    const ytext = this.ydoc.getText('monaco');\n    return ytext.toString();\n  }\n}\n\nexport default OpenAgentsYjsProvider;\n","/**\n * YjsCollaborativeEditor - Yjs-based collaborative document editor\n *\n * Uses Yjs CRDT for conflict-free collaborative editing without WebSocket.\n * Integrates with OpenAgents event system via OpenAgentsYjsProvider.\n */\n\nimport React, { useEffect, useRef, useState, useCallback } from 'react';\nimport Editor from '@monaco-editor/react';\nimport * as Y from 'yjs';\nimport { MonacoBinding } from 'y-monaco';\nimport { editor } from 'monaco-editor';\nimport { toast } from 'sonner';\nimport { OpenAgentsYjsProvider } from '../../providers/OpenAgentsYjsProvider';\nimport { useOpenAgents } from '../../context/OpenAgentsProvider';\n\ninterface YjsCollaborativeEditorProps {\n  documentId: string;\n  initialContent: string;\n  onSave?: (content: string) => void;\n  readOnly?: boolean;\n  language?: string;\n}\n\ninterface UserCursor {\n  agentId: string;\n  position: {\n    lineNumber: number;\n    column: number;\n  };\n  color?: string;\n}\n\nexport const YjsCollaborativeEditor: React.FC<YjsCollaborativeEditorProps> = ({\n  documentId,\n  initialContent,\n  onSave,\n  readOnly = false,\n  language = 'markdown',\n}) => {\n  const { connector: connection } = useOpenAgents();\n\n  // Editor refs\n  const editorRef = useRef<editor.IStandaloneCodeEditor | null>(null);\n  const monacoRef = useRef<any>(null);\n\n  // Yjs refs\n  const ydocRef = useRef<Y.Doc | null>(null);\n  const providerRef = useRef<OpenAgentsYjsProvider | null>(null);\n  const bindingRef = useRef<MonacoBinding | null>(null);\n\n  // State\n  const [userCursors, setUserCursors] = useState<UserCursor[]>([]);\n  const [syncStatus, setSyncStatus] = useState<'syncing' | 'synced' | 'error'>('syncing');\n\n  // Initialization ref to ensure single initialization\n  const hasInitialized = useRef(false);\n\n  // Cursor decorations\n  const decorationsRef = useRef<string[]>([]);\n\n  /**\n   * Initialize Yjs document and provider (ONCE)\n   */\n  useEffect(() => {\n    if (!connection || !documentId || hasInitialized.current) return;\n\n    console.log('üöÄ [Yjs Init] Initializing YjsCollaborativeEditor for document:', documentId);\n    hasInitialized.current = true;\n\n    // Create Yjs document\n    const ydoc = new Y.Doc();\n    ydocRef.current = ydoc;\n\n    // Create custom provider\n    const provider = new OpenAgentsYjsProvider(ydoc, connection, documentId);\n    providerRef.current = provider;\n\n    // Initialize with initial content\n    provider.initialize(initialContent).then(() => {\n      console.log('‚úÖ [Yjs Init] Provider initialized successfully');\n      setSyncStatus('synced');\n    }).catch((error) => {\n      console.error('‚ùå [Yjs Init] Provider initialization failed:', error);\n      setSyncStatus('error');\n    });\n\n    return () => {\n      console.log('üõë [Yjs Cleanup] Cleaning up YjsCollaborativeEditor');\n\n      if (bindingRef.current) {\n        bindingRef.current.destroy();\n        bindingRef.current = null;\n      }\n\n      if (providerRef.current) {\n        providerRef.current.destroy();\n        providerRef.current = null;\n      }\n\n      if (ydocRef.current) {\n        ydocRef.current.destroy();\n        ydocRef.current = null;\n      }\n\n      hasInitialized.current = false;\n    };\n  }, [connection, documentId, initialContent]);\n\n  /**\n   * Handle Monaco editor mount\n   */\n  const handleEditorDidMount = useCallback(\n    (editor: editor.IStandaloneCodeEditor, monaco: any) => {\n      console.log('üìù Monaco editor mounted');\n\n      editorRef.current = editor;\n      monacoRef.current = monaco;\n\n      if (!ydocRef.current || !providerRef.current) {\n        console.error('‚ùå Yjs not initialized when editor mounted');\n        return;\n      }\n\n      // Create Monaco binding with awareness\n      const ytext = providerRef.current.getText();\n      const awareness = providerRef.current.getAwareness();\n\n      const binding = new MonacoBinding(\n        ytext,\n        editor.getModel()!,\n        new Set([editor]),\n        awareness // Pass awareness for remote cursor rendering\n      );\n\n      bindingRef.current = binding;\n      console.log('‚úÖ Monaco binding created with awareness');\n\n      // Listen for cursor position changes\n      editor.onDidChangeCursorPosition((e) => {\n        if (readOnly) return;\n\n        // Send cursor position through OpenAgents\n        connection?.sendEvent({\n          event_name: 'document.cursor_update',\n          destination_id: 'mod:openagents.mods.workspace.documents',\n          payload: {\n            document_id: documentId,\n            position: {\n              lineNumber: e.position.lineNumber,\n              column: e.position.column,\n            },\n          },\n        }).catch((error) => {\n          console.error('‚ùå Failed to send cursor update:', error);\n        });\n      });\n\n      // Listen for remote cursor updates\n      const handleCursorUpdate = (event: CustomEvent) => {\n        const { document_id, agent_id, position } = event.detail;\n\n        if (document_id !== documentId) return;\n\n        setUserCursors((prev) => {\n          const filtered = prev.filter((c) => c.agentId !== agent_id);\n          return [...filtered, { agentId: agent_id, position }];\n        });\n      };\n\n      window.addEventListener('document-cursor-update', handleCursorUpdate as EventListener);\n\n      return () => {\n        window.removeEventListener('document-cursor-update', handleCursorUpdate as EventListener);\n      };\n    },\n    [connection, documentId, readOnly]\n  );\n\n  /**\n   * Render remote cursors as Monaco decorations\n   */\n  useEffect(() => {\n    if (!editorRef.current || !monacoRef.current) return;\n\n    const editor = editorRef.current;\n    const monaco = monacoRef.current;\n    const decorations: any[] = [];\n\n    userCursors.forEach((cursor) => {\n      const { lineNumber, column } = cursor.position;\n\n      decorations.push({\n        range: new monaco.Range(lineNumber, column, lineNumber, column),\n        options: {\n          className: `remote-cursor remote-cursor-${cursor.agentId.replace(/[^a-zA-Z0-9]/g, '_')}`,\n          beforeContentClassName: 'remote-cursor-caret',\n          after: {\n            content: ` ${cursor.agentId.substring(0, 12)}`,\n            inlineClassName: 'remote-cursor-label-text',\n          },\n        },\n      });\n    });\n\n    decorationsRef.current = editor.deltaDecorations(decorationsRef.current, decorations);\n  }, [userCursors]);\n\n  /**\n   * Manual save handler\n   */\n  const handleSave = useCallback(() => {\n    if (!providerRef.current) return;\n\n    const content = providerRef.current.getContent();\n\n    if (onSave) {\n      onSave(content);\n    }\n\n    // Send save event through OpenAgents\n    connection?.sendEvent({\n      event_name: 'document.save',\n      destination_id: 'mod:openagents.mods.workspace.documents',\n      payload: {\n        document_id: documentId,\n        content,\n      },\n    }).then(() => {\n      console.log('‚úÖ Document saved');\n      setSyncStatus('synced');\n      // Show success toast notification\n      toast.success('Document saved successfully');\n    }).catch((error) => {\n      console.error('‚ùå Failed to save document:', error);\n      setSyncStatus('error');\n      // Show error toast notification\n      toast.error('Failed to save document');\n    });\n  }, [connection, documentId, onSave]);\n\n  /**\n   * Keyboard shortcut for save (Cmd/Ctrl + S)\n   */\n  useEffect(() => {\n    const handleKeyDown = (e: KeyboardEvent) => {\n      if ((e.metaKey || e.ctrlKey) && e.key === 's') {\n        e.preventDefault();\n        handleSave();\n      }\n    };\n\n    window.addEventListener('keydown', handleKeyDown);\n    return () => window.removeEventListener('keydown', handleKeyDown);\n  }, [handleSave]);\n\n  return (\n    <div className=\"yjs-collaborative-editor relative h-full w-full\">\n      {/* Status bar */}\n      <div className=\"absolute top-2 right-2 z-10 flex items-center gap-2 bg-white dark:bg-gray-800 px-3 py-1 rounded-md shadow-sm border border-gray-200 dark:border-gray-700\">\n        <div className=\"flex items-center gap-2\">\n          <div\n            className={`w-2 h-2 rounded-full ${\n              syncStatus === 'synced'\n                ? 'bg-green-500'\n                : syncStatus === 'syncing'\n                ? 'bg-yellow-500 animate-pulse'\n                : 'bg-red-500'\n            }`}\n          />\n          <span className=\"text-xs text-gray-600 dark:text-gray-400\">\n            {syncStatus === 'synced' ? 'Synced' : syncStatus === 'syncing' ? 'Syncing...' : 'Error'}\n          </span>\n        </div>\n\n        {userCursors.length > 0 && (\n          <div className=\"flex items-center gap-1 border-l border-gray-300 dark:border-gray-600 pl-2\">\n            <span className=\"text-xs text-gray-600 dark:text-gray-400\">\n              {userCursors.length} {userCursors.length === 1 ? 'user' : 'users'}\n            </span>\n          </div>\n        )}\n\n        <button\n          onClick={handleSave}\n          disabled={readOnly}\n          className=\"ml-2 px-2 py-1 text-xs bg-blue-500 hover:bg-blue-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed\"\n        >\n          Save\n        </button>\n      </div>\n\n      {/* Monaco Editor */}\n      <Editor\n        height=\"100%\"\n        language={language}\n        theme=\"vs-dark\"\n        onMount={handleEditorDidMount}\n        options={{\n          readOnly,\n          minimap: { enabled: true },\n          fontSize: 14,\n          lineNumbers: 'on',\n          wordWrap: 'on',\n          automaticLayout: true,\n          scrollBeyondLastLine: false,\n          tabSize: 2,\n        }}\n      />\n\n      {/* Remote cursor styles */}\n      <style>{`\n        .remote-cursor {\n          border-left: 2px solid #4CAF50 !important;\n          margin-left: -1px;\n          pointer-events: none;\n        }\n\n        .remote-cursor-caret {\n          position: absolute;\n          width: 2px;\n          height: 1.2em;\n          background-color: #4CAF50;\n          pointer-events: none;\n        }\n\n        .remote-cursor-label-text {\n          display: inline-block;\n          padding: 1px 4px;\n          margin-left: 2px;\n          font-size: 10px;\n          background-color: #4CAF50;\n          color: white;\n          border-radius: 2px;\n          white-space: nowrap;\n          pointer-events: none;\n        }\n\n        /* Different colors for different users */\n        .remote-cursor-1 .remote-cursor-caret,\n        .remote-cursor-1 .remote-cursor-label-text {\n          background-color: #4CAF50;\n        }\n\n        .remote-cursor-2 .remote-cursor-caret,\n        .remote-cursor-2 .remote-cursor-label-text {\n          background-color: #2196F3;\n        }\n\n        .remote-cursor-3 .remote-cursor-caret,\n        .remote-cursor-3 .remote-cursor-label-text {\n          background-color: #FF9800;\n        }\n\n        .remote-cursor-4 .remote-cursor-caret,\n        .remote-cursor-4 .remote-cursor-label-text {\n          background-color: #E91E63;\n        }\n\n        .remote-cursor-5 .remote-cursor-caret,\n        .remote-cursor-5 .remote-cursor-label-text {\n          background-color: #9C27B0;\n        }\n      `}</style>\n    </div>\n  );\n};\n\nexport default YjsCollaborativeEditor;\n"],"names":["OpenAgentsYjsProvider","constructor","ydoc","connection","documentId","awareness","isInitialized","updateHandler","eventListener","this","Awareness","console","log","clientID","setupYjsListeners","setupEventListeners","setupAwarenessListeners","update","origin","size","length","updateArray","Array","from","sendEvent","event_name","destination_id","payload","document_id","catch","error","on","event","detail","source_agent_id","myClientID","isArray","updateBytes","Uint8Array","Y","window","addEventListener","localState","getLocalState","cursor","awareness_state","client_id","_this$awareness$getLo","setLocalStateField","_objectSpread","clients","getAwareness","initialize","initialContent","ytext","getText","syncWithServer","warn","transact","insert","_response$data","response","success","data","yjs_state","Error","message","state","destroy","off","removeEventListener","isReady","getContent","toString","YjsCollaborativeEditor","_ref","onSave","readOnly","language","connector","useOpenAgents","editorRef","useRef","monacoRef","ydocRef","providerRef","bindingRef","userCursors","setUserCursors","useState","syncStatus","setSyncStatus","hasInitialized","decorationsRef","useEffect","current","provider","then","handleEditorDidMount","useCallback","editor","monaco","binding","MonacoBinding","getModel","Set","onDidChangeCursorPosition","e","position","lineNumber","column","handleCursorUpdate","agent_id","prev","filter","c","agentId","decorations","forEach","push","range","Range","options","className","concat","replace","beforeContentClassName","after","content","substring","inlineClassName","deltaDecorations","handleSave","toast","handleKeyDown","metaKey","ctrlKey","key","preventDefault","_jsxs","children","_jsx","onClick","disabled","Editor","height","theme","onMount","minimap","enabled","fontSize","lineNumbers","wordWrap","automaticLayout","scrollBeyondLastLine","tabSize"],"sourceRoot":""}