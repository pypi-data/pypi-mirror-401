name: Release

# Triggered manually or when a version tag is pushed
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.6.0)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (no publish)'
        required: false
        type: choice
        options:
          - 'false'
          - 'true'
        default: 'false'

jobs:
  # ─────────────────────────────────────────────────────────────
  # Test matrix (Python versions on Linux)
  # Note: Forgejo/Codeberg only has Linux runners. Multi-platform
  # testing should be done locally before tagging a release.
  # ─────────────────────────────────────────────────────────────
  test-matrix:
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12', '3.13']
      fail-fast: false

    runs-on: codeberg-small-lazy

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: Build source-only grammars (while memory is fresh)
        run: |
          # Build grammars BEFORE trying sentence-transformers since
          # torch/cuBLAS can fragment memory and cause OOM during builds
          ./scripts/build-source-grammars

      - name: Try installing sentence-transformers (optional)
        run: |
          echo "Attempting to install sentence-transformers..."
          if timeout 300 pip install sentence-transformers 2>&1; then
            echo "sentence-transformers installed successfully"
            echo "EMBEDDINGS_AVAILABLE=true" >> "$GITHUB_ENV"
          else
            echo "::warning::sentence-transformers install failed (expected on small runners)"
            echo "EMBEDDINGS_AVAILABLE=false" >> "$GITHUB_ENV"
          fi
        continue-on-error: true

      - name: Contingency reinstall (if sentence-transformers failed)
        if: always() && env.EMBEDDINGS_AVAILABLE != 'true'
        run: |
          echo "Reinstalling clean [dev] dependencies..."
          pip cache purge 2>/dev/null || true
          pip uninstall -y sentence-transformers torch transformers huggingface_hub safetensors 2>/dev/null || true
          pip install -e .[dev] --force-reinstall

      - name: Run tests with coverage
        run: |
          if [ "$EMBEDDINGS_AVAILABLE" = "true" ]; then
            echo "Embeddings available - using standard coverage"
            pytest --cov=src --cov-report=term-missing --cov-fail-under=100
          else
            echo "::warning::Embeddings unavailable - using reduced coverage config"
            pytest --cov=src --cov-report=term-missing --cov-fail-under=100 \
              --cov-config=.coveragerc.no-embeddings
          fi

  # ─────────────────────────────────────────────────────────────
  # Security audit
  # ─────────────────────────────────────────────────────────────
  security-audit:
    runs-on: codeberg-small-lazy

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]
          pip install pip-audit bandit safety pip-licenses

      - name: Vulnerability scan (pip-audit)
        run: pip-audit --skip-editable

      - name: Security linting (Bandit)
        run: bandit -r src/ -c pyproject.toml

      - name: Dependency safety check
        run: safety check || true  # Advisory, don't fail

      - name: License audit
        run: |
          pip-licenses --format=markdown > licenses.md
          cat licenses.md
          # Check for problematic licenses
          if pip-licenses --format=csv | grep -qiE "GPL|AGPL|SSPL"; then
            echo "::warning::Some dependencies have copyleft licenses"
          fi

      - name: Secret scanning
        run: |
          pip install trufflehog
          trufflehog filesystem . --no-update --only-verified || true

  # ─────────────────────────────────────────────────────────────
  # Integration tests
  # ─────────────────────────────────────────────────────────────
  integration-tests:
    runs-on: codeberg-small-lazy
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -e .[dev]

      - name: Build source-only grammars (while memory is fresh)
        run: ./scripts/build-source-grammars

      - name: Try installing sentence-transformers (optional)
        run: |
          if timeout 300 pip install sentence-transformers 2>&1; then
            echo "sentence-transformers installed successfully"
          else
            echo "::warning::sentence-transformers install failed (expected on small runners)"
          fi
        continue-on-error: true

      - name: Install jq
        run: |
          sudo apt-get update && sudo apt-get install -y jq || true

      - name: Run integration tests
        run: ./scripts/integration-test --quick

  # ─────────────────────────────────────────────────────────────
  # Build and publish
  # ─────────────────────────────────────────────────────────────
  build-and-publish:
    needs: [test-matrix, security-audit, integration-tests]
    runs-on: codeberg-small-lazy

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build tools
        run: |
          pip install --upgrade pip
          pip install build twine cyclonedx-bom

      - name: Extract version
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Building version: $VERSION"

      - name: Build package
        run: python -m build

      - name: Generate checksums
        run: |
          cd dist
          sha256sum * > SHA256SUMS
          cat SHA256SUMS

      - name: Generate SBOM
        run: |
          cyclonedx-py environment -o dist/sbom.json --format json || true

      - name: Verify wheel
        run: |
          pip install dist/*.whl --dry-run
          twine check dist/*.whl dist/*.tar.gz

      - name: Publish to PyPI
        if: github.event_name == 'push' || github.event.inputs.dry_run != 'true'
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          if [[ -n "$TWINE_PASSWORD" ]]; then
            echo "Publishing to PyPI..."
            twine upload dist/*.whl dist/*.tar.gz --skip-existing
          else
            echo "::warning::PYPI_TOKEN not set, skipping publish"
          fi

      - name: Extract changelog for release notes
        run: |
          VERSION="${{ env.VERSION }}"
          # Extract changelog section for this version
          awk '/^## \['"$VERSION"'\]/{flag=1; next} /^## \[/{flag=0} flag' CHANGELOG.md > release_notes.md
          if [[ ! -s release_notes.md ]]; then
            echo "Release v$VERSION" > release_notes.md
            echo "" >> release_notes.md
            echo "See [CHANGELOG.md](CHANGELOG.md) for details." >> release_notes.md
          fi
          cat release_notes.md

      - name: Create Forgejo Release
        if: github.event_name == 'push'
        env:
          FORGEJO_TOKEN: ${{ secrets.FORGEJO_TOKEN }}
        run: |
          VERSION="${{ env.VERSION }}"
          TAG="v$VERSION"

          if [[ -z "$FORGEJO_TOKEN" ]]; then
            echo "::warning::FORGEJO_TOKEN not set, skipping release creation"
            exit 0
          fi

          # Determine if prerelease
          PRERELEASE=false
          if [[ "$VERSION" == *"dev"* ]] || [[ "$VERSION" == *"rc"* ]] || [[ "$VERSION" == *"alpha"* ]] || [[ "$VERSION" == *"beta"* ]]; then
            PRERELEASE=true
          fi

          # Read release notes
          BODY=$(cat release_notes.md | jq -Rs .)

          # Create release via Forgejo API
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: token $FORGEJO_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"$TAG\",
              \"name\": \"$TAG\",
              \"body\": $BODY,
              \"draft\": false,
              \"prerelease\": $PRERELEASE
            }" \
            "https://codeberg.org/api/v1/repos/${{ github.repository }}/releases")

          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id // empty')

          if [[ -z "$RELEASE_ID" ]]; then
            echo "::warning::Failed to create release"
            echo "$RESPONSE"
            exit 0
          fi

          echo "Created release ID: $RELEASE_ID"

          # Upload assets
          for file in dist/*.whl dist/*.tar.gz dist/SHA256SUMS dist/sbom.json; do
            if [[ -f "$file" ]]; then
              FILENAME=$(basename "$file")
              echo "Uploading $FILENAME..."
              curl -s -X POST \
                -H "Authorization: token $FORGEJO_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary "@$file" \
                "https://codeberg.org/api/v1/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=$FILENAME"
            fi
          done

          echo "Release created: https://codeberg.org/${{ github.repository }}/releases/tag/$TAG"
