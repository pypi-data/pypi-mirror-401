.\" Man page for btrfs-backup-ng config
.TH BTRFS-BACKUP-NG-CONFIG 1 "January 2026" "btrfs-backup-ng" "User Commands"
.SH NAME
btrfs-backup-ng-config \- configuration management commands
.SH SYNOPSIS
.B btrfs-backup-ng config validate
.br
.B btrfs-backup-ng config init
[\fB\-i\fR|\fB\-\-interactive\fR]
[\fB\-o\fR \fIFILE\fR]
.br
.B btrfs-backup-ng config import
[\fB\-o\fR \fIFILE\fR] \fIBTRBK_CONF\fR
.br
.B btrfs-backup-ng config detect
[\fB\-\-json\fR]
[\fB\-w\fR|\fB\-\-wizard\fR]
.br
.B btrfs-backup-ng config migrate-systemd
[\fB\-\-dry-run\fR]
.SH DESCRIPTION
Manage btrfs-backup-ng configuration files. These commands help create,
validate, detect subvolumes, migrate from btrbk, and manage systemd integration.
.SH SUBCOMMANDS
.SS validate
Validate the current configuration file. Checks for syntax errors, missing
required fields, and invalid values.
.PP
.RS
.B btrfs-backup-ng config validate
.RE
.PP
Exit status is 0 if valid, non-zero if errors are found.
.SS init
Generate an example configuration file with comments explaining all options.
Can be run in interactive mode for a guided setup wizard.
.PP
.RS
.B btrfs-backup-ng config init
[\fB\-i\fR|\fB\-\-interactive\fR]
[\fB\-o\fR \fIFILE\fR]
.RE
.TP
.BR \-i ", " \-\-interactive
Run the interactive configuration wizard. This guides you through setting up:
.RS
.IP \(bu 2
Global settings (snapshot directory, timestamp format)
.IP \(bu 2
Parallelism settings
.IP \(bu 2
Retention policies (hourly, daily, weekly, monthly, yearly)
.IP \(bu 2
Email and webhook notifications
.IP \(bu 2
Volumes to backup and their targets
.RE
.IP
Requires a terminal (TTY). Press Ctrl+C to cancel at any time.
.TP
.BR \-o ", " \-\-output " " \fIFILE\fR
Write output to FILE instead of stdout.
.PP
Example:
.PP
.RS
.nf
# Generate example config to stdout
btrfs-backup-ng config init > ~/.config/btrfs-backup-ng/config.toml

# Generate example config to file
btrfs-backup-ng config init -o /etc/btrfs-backup-ng/config.toml

# Run interactive wizard
btrfs-backup-ng config init --interactive

# Run interactive wizard and save to file
btrfs-backup-ng config init -i -o config.toml
.fi
.RE
.SS import
Import a btrbk configuration file and convert it to TOML format. This helps
migrate from btrbk to btrfs-backup-ng.
.PP
.RS
.B btrfs-backup-ng config import
[\fB\-o\fR \fIFILE\fR] \fIBTRBK_CONF\fR
.RE
.TP
.I BTRBK_CONF
Path to the btrbk.conf file to import.
.TP
.BR \-o ", " \-\-output " " \fIFILE\fR
Write output to FILE instead of stdout.
.PP
The importer:
.IP \(bu 2
Parses btrbk's custom syntax
.IP \(bu 2
Resolves inheritance (options cascade down)
.IP \(bu 2
Converts retention policies
.IP \(bu 2
Maps timestamp formats (short, long, long-iso to strftime patterns)
.IP \(bu 2
Converts SSH sudo settings (backend btrfs-progs-sudo to ssh_sudo)
.IP \(bu 2
Converts raw_target_compress and raw_target_encrypt settings
.IP \(bu 2
Warns about common btrbk pitfalls
.IP \(bu 2
Outputs valid TOML
.PP
Timestamp format mapping:
.IP \(bu 2
\fBshort\fR \(-> %Y%m%d (e.g., 20260109)
.IP \(bu 2
\fBlong\fR \(-> %Y%m%dT%H%M (e.g., 20260109T1430)
.IP \(bu 2
\fBlong-iso\fR \(-> %Y%m%dT%H%M%S%z (e.g., 20260109T143052+0000)
.PP
Example:
.PP
.RS
.nf
btrfs-backup-ng config import /etc/btrbk/btrbk.conf
btrfs-backup-ng config import /etc/btrbk/btrbk.conf -o config.toml
.fi
.RE
.SS detect
Scan the system for btrfs subvolumes and suggest backup configurations.
This command helps discover what subvolumes exist on your system and
categorizes them for backup purposes.
.PP
.RS
.B btrfs-backup-ng config detect
[\fB\-\-json\fR]
[\fB\-w\fR|\fB\-\-wizard\fR]
.RE
.TP
.B \-\-json
Output results in JSON format for scripting and automation.
.TP
.BR \-w ", " \-\-wizard
Launch the interactive configuration wizard with detected volumes
pre-populated. Requires a terminal (TTY).
.PP
The detect command:
.IP \(bu 2
Scans all mounted btrfs filesystems
.IP \(bu 2
Lists all subvolumes found
.IP \(bu 2
Categorizes subvolumes as recommended, optional, or excluded
.IP \(bu 2
Suggests snapshot prefixes based on mount paths
.IP \(bu 2
Identifies existing snapshots and system-internal subvolumes
.PP
Subvolume categories:
.IP \(bu 2
\fBRecommended\fR: User data directories like /home that should be backed up
.IP \(bu 2
\fBOptional\fR: System data (/opt, /var/log) that may or may not need backup
.IP \(bu 2
\fBExcluded\fR: Existing snapshots and system-internal subvolumes
.PP
Example:
.PP
.RS
.nf
# Scan for subvolumes (requires root for full access)
sudo btrfs-backup-ng config detect

# Output in JSON format
sudo btrfs-backup-ng config detect --json

# Launch wizard with detected volumes
sudo btrfs-backup-ng config detect --wizard
.fi
.RE
.SS migrate-systemd
Migrate systemd integration from btrbk to btrfs-backup-ng. This command
stops and disables btrbk's systemd timer and enables btrfs-backup-ng's timer.
.PP
.RS
.B btrfs-backup-ng config migrate-systemd
[\fB\-\-dry-run\fR]
.RE
.TP
.B \-\-dry-run
Show what would be done without making any changes. Use this to preview
the migration before applying it.
.PP
The migrate-systemd command:
.IP \(bu 2
Detects active btrbk systemd units (btrbk.timer, btrbk.service)
.IP \(bu 2
Stops running btrbk timers
.IP \(bu 2
Disables btrbk.timer
.IP \(bu 2
Enables btrfs-backup-ng.timer (if installed)
.IP \(bu 2
Prevents both tools from running simultaneously
.PP
Example:
.PP
.RS
.nf
# Preview migration (recommended first step)
btrfs-backup-ng config migrate-systemd --dry-run

# Apply migration
sudo btrfs-backup-ng config migrate-systemd

# If btrfs-backup-ng timer not installed, install it first
sudo btrfs-backup-ng install --timer=hourly
sudo btrfs-backup-ng config migrate-systemd
.fi
.RE
.SH CONFIGURATION FORMAT
Configuration uses TOML format. Key sections:
.SS [global]
Global settings applied to all volumes unless overridden.
.PP
.RS
.nf
[global]
snapshot_dir = ".snapshots"
timestamp_format = "%Y%m%d-%H%M%S"
incremental = true
log_file = "/var/log/btrfs-backup-ng.log"
parallel_volumes = 2
parallel_targets = 2
.fi
.RE
.SS [global.retention]
Default retention policy.
.PP
.RS
.nf
[global.retention]
min = "1d"
hourly = 24
daily = 7
weekly = 4
monthly = 12
yearly = 0
.fi
.RE
.SS [[volumes]]
Volume definitions. Each volume specifies a source path and targets.
.PP
.RS
.nf
[[volumes]]
path = "/home"
snapshot_prefix = "home-"
snapshot_dir = ".snapshots"  # optional override

[[volumes.targets]]
path = "/mnt/backup/home"

[[volumes.targets]]
path = "ssh://backup@server:/backups/home"
ssh_sudo = true
compress = "zstd"
rate_limit = "50M"

[volumes.retention]  # optional override
daily = 14
.fi
.RE
.SS Raw targets
Raw targets write btrfs send streams to files instead of using btrfs receive.
This enables backups to non-btrfs filesystems with optional compression and
encryption.
.PP
.RS
.nf
# Raw target to local path with compression and GPG encryption
[[volumes.targets]]
path = "raw:///mnt/nas/backups/home"
compress = "zstd"
encrypt = "gpg"
gpg_recipient = "backup@example.com"

# Raw target over SSH
[[volumes.targets]]
path = "raw+ssh://backup@server/backups/home"
compress = "zstd"

# Raw target with OpenSSL encryption (btrbk compatible)
[[volumes.targets]]
path = "raw:///mnt/backup"
compress = "gzip"
encrypt = "openssl_enc"
openssl_cipher = "aes-256-cbc"
.fi
.RE
.PP
Configuration options for raw targets:
.TP
.B compress
Compression method: gzip, pigz, zstd, lz4, xz, lzo, bzip2, pbzip2.
.TP
.B encrypt
Encryption method: gpg or openssl_enc.
.TP
.B gpg_recipient
GPG key recipient (required for gpg encryption).
.TP
.B gpg_keyring
Optional path to GPG keyring file.
.TP
.B openssl_cipher
OpenSSL cipher (default: aes-256-cbc).
.PP
For OpenSSL encryption, set the passphrase via environment variable
BTRFS_BACKUP_PASSPHRASE or BTRBK_PASSPHRASE (for btrbk compatibility).
.SS [notifications]
Optional notification settings.
.PP
.RS
.nf
[notifications]
on_success = false
on_failure = true

[notifications.email]
smtp_host = "smtp.example.com"
smtp_port = 587
from_addr = "backup@example.com"
to_addrs = ["admin@example.com"]
use_tls = true
username = "backup@example.com"
password = "secret"

[notifications.webhook]
url = "https://hooks.example.com/backup"
.fi
.RE
.SH FILES
.TP
.I ~/.config/btrfs-backup-ng/config.toml
User configuration file.
.TP
.I /etc/btrfs-backup-ng/config.toml
System-wide configuration file.
.SH SEE ALSO
.BR btrfs-backup-ng (1),
.BR toml (5)
