<!DOCTYPE html>
<html>
<head>
<script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
<script src="{{ url_for('static', filename='waitme/waitMe.js') }}"></script>
<script src="{{ url_for('static', filename='xlsx.full.min.js') }}"></script>
<link rel="stylesheet" type="text/css" href="{{url_for('.static', filename='waitme/waitMe.css')}}">
<link rel="stylesheet" type="text/css" href="{{url_for('.static', filename='jquery-ui.css')}}">
<link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
<script src="{{ url_for('static', filename='waitme/waitMeFunc.js') }}"></script>
<title>DPDC:: Meter Reading Testing</title>

<style>
/* layout fixes so table area always grows between header/nav and footer */
html, body {
    height: 100%;
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size:13px;
}

/* Keep your header and nav untouched visually (they appear at top as before) */
body > div:first-of-type { /* your top header block */
    /* no layout change to header content; just ensure it's not collapsing */
}

/* Make the overall page a column flex container so middle expands */
body {
    display: flex;
    flex-direction: column;
}

/* Navbar remains where it is and not changed */
.navbar { display:flex; justify-content: space-around; align-items:center; background-color:#2c3e50; padding:5px 10px; }
.navbar a { color:white; text-decoration:none; padding:5px 10px; transition: background-color 0.3s, color 0.3s; }
.navbar a:hover { background-color:#8B0000; color:#ecf0f1; border-radius:5px; }

/* Main container should grow to fill remaining viewport */
#container {
    flex: 1 1 auto; /* grow and shrink */
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
    min-height: 0; /* important for children flex scrolling */
}

/* The scrollable area will expand to fill available vertical space */
.scrollable-div {
    flex: 1 1 auto; /* fill available vertical space */
    min-height: 0;  /* important for proper scrolling inside flexbox */
    overflow: auto;
    border: 1px solid #ccc;
}

/* table styling (your original rules preserved) */
table {
    width: 100%;
    border-collapse: collapse;
}
table, th, td { border: 1px solid black; }
th, td { padding: 5px; text-align: center; }
td:nth-child(2), th:nth-child(2) { width: 50px; }
img { max-width: 210px; height: auto; }

/* footer with buttons that visually sits at the bottom (in normal flow) */
#footer-actions {
    box-shadow: 0 -1px 4px rgba(0,0,0,0.05);
    padding: 8px 12px;
    background: #fff;
    display: flex;
    gap: 8px;
    justify-content: flex-start;
    align-items: center;
}

/* reuse your button styles */
.smart-button {
    background-color: #3498db; border: none; color: white;
    padding: 5px 10px; text-align: center;
    font-size: 12px; margin: 4px 2px; cursor: pointer;
    border-radius: 8px; transition: background-color 0.3s, transform 0.3s;
}
.smart-button:hover { background-color: #2980b9; transform: scale(1.05); }
.smart-button:active { background-color: #1c598a; transform: scale(0.95); }

/* dashboard styles (unchanged visually) */
.dash-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: 10px;
    margin: 10px 0;
}
.dash-box {
    background: #3498db;
    color: #fff;
    text-align: center;
    padding: 10px;
    border-radius: 8px;
    font-weight: bold;
    font-size: 14px;
}
</style>
</head>
<body id="body">

<div style="width:100%;
            display:flex;
            justify-content:center;
            align-items:center;
            font-family:Arial;
            font-size:10pt;
            color:#333333;
            border-bottom:1px solid #f1f4fb;
            padding:10px 0;">

    <!-- Left Section: Logo + Tagline -->
    <div style="text-align:center; margin-right:20px;">
        <img src="{{ url_for('static', filename='images/DPDC.png') }}" width="60px" alt="DPDC Logo" />
        <div style="font-size:11px; font-style:italic; margin-top:4px; line-height:1.2;">
            Dependable Power<br>Delighted Customer
        </div>
    </div>

    <!-- Right Section: Company Information -->
    <div style="text-align:center;">
        <h2 style="color:#111111; margin:0;">
            Dhaka Power Distribution Company Limited
        </h2>
        <h5 style="margin:0;">
            (An Enterprise of the Government of the People's Republic of Bangladesh)
        </h5>
        <h6 style="margin:0;">
            Biddut Bhaban, 1, Abdul Gani Road, Dhaka-1000
        </h6>
    </div>

</div>

  <div class="navbar">
       <a href="/">Home</a>
      <a href="#">Batch Process </a>
  </div>

<!-- MAIN CONTENT AREA: will expand -->
<div id="container">

    <h3>Meter Reading using Deep Learning (Batch Processing)</h3>
    <form id="upload-file" action="/upload_batch" method="post" enctype="multipart/form-data">
        <input type="file"  name="files" id="files" accept="image/*" multiple>
    </form>

    <hr>
    <div class="scrollable-div">
        <table id="imageTable">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>File Name</th>
                    <th>Classified As</th>
                    <th>Meter Reading</th>
                    <th>Reading Image</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div> <!-- #container -->

<hr>

 <!-- Four-class dashboard -->
    <div id="dashboard" class="dash-grid" style="padding:0 12px;">
        <div class="dash-box" id="dash-meter">Meter: 0</div>
        <div class="dash-box" id="dash-calc">Calculator: 0</div>
        <div class="dash-box" id="dash-ileg">IllegibleMeter: 0</div>
        <div class="dash-box" id="dash-other">Others: 0</div>
        <div class="dash-box" id="dash-error">Error: 0</div>
    </div>

<!-- Footer actions (placed after dashboard so it's visually near bottom) -->
<div id="footer-actions">
    <input type="button" class="smart-button" id="upload-file-btn" value="Batch Process"/>
    <input type="button" class="smart-button" id="btn-export" onclick="exportTableToExcel()" value="Export Result"/>
</div>

<script>
/* preserve your existing logic but add auto-scroll behaviors */

/* when files are selected, create table rows and scroll bottom */
document.getElementById('files').addEventListener('change', function(event) {
    const files = event.target.files;
    if (files.length>1000){
        this.value='';
        return alert('Please choose less than 1000 files!');
    }
    const tableBody = document.querySelector('#imageTable tbody');
    tableBody.innerHTML = '';
    for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const row = document.createElement('tr');
            row.id=file.name;
            const imgCell = document.createElement('td');
            const nameCell = document.createElement('td');
            const classCell = document.createElement('td');
            const readingCell =document.createElement('td');
            const resImgCell=document.createElement('td');

            const img = document.createElement('img');
            img.src = e.target.result;
            imgCell.appendChild(img);

            nameCell.textContent = file.name;

            const resimg = document.createElement('img');
            resimg.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
            resImgCell.appendChild(resimg);

            row.appendChild(imgCell);
            row.appendChild(nameCell);
            row.appendChild(classCell);
            row.appendChild(readingCell);
            row.appendChild(resImgCell);
            tableBody.appendChild(row);

            // scroll the scrollable-div to bottom so new rows are visible
            const sc = document.querySelector('.scrollable-div');
            sc.scrollTop = sc.scrollHeight;
        };
        reader.readAsDataURL(file);
    }
});

/* keep existing jQuery waitMe code */
$(function(){
    var current_effect = 'ios';
    $('#upload-file-btn').click(function(){
        run_waitMe(current_effect);
    });
    function run_waitMe(effect){
        $('#body').waitMe({
            effect: effect,
            text: 'Extracting Meter Reading using DPDC ShockWave...',
            bg: 'rgba(255,255,255,0.7)',
            color:'#990033'
        });
    }
});

function getCredentials() {
    let username = sessionStorage.getItem('username');
    let token = sessionStorage.getItem('token');

    if (!username || !token) {
        username = prompt("Enter username:");
        token = prompt("Enter token:");
        if (!username || !token) {
            alert("Username and token are required!");
            return null;
        }
        sessionStorage.setItem('username', username);
        sessionStorage.setItem('token', token);
    }
    return { username, token };
}

/* adjust ajax click handler: show wait, auto-scroll to bottom during processing, hide wait when done */
$('#upload-file-btn').click(function() {
    const creds = getCredentials();
    if (!creds) return;  // stop if user cancels

    // ensure we show the scroll area so user sees results at bottom
    const sc = document.querySelector('.scrollable-div');
    sc.scrollTop = sc.scrollHeight;

    var form_data = new FormData($('#upload-file')[0]);
    form_data.append('imgflg','');

    // Append session credentials
    form_data.append('username', creds.username);
    form_data.append('token', creds.token);

     $.ajax({
        type: 'POST',
        url: '/upload_batch',
        data: form_data,
        contentType: false,
        cache: false,
        processData: false,
        success: function(data) {
                    const tableBody = document.querySelector('#imageTable tbody');
                    const dtarr = data.message;

                    // Reset counters
                    var v_meter = 0, v_imeter = 0, v_calc = 0, v_other = 0, v_error = 0;

                    dtarr.forEach(dtx => {
                        // Get the row or create a new one if it doesn't exist
                        let row = document.getElementById(dtx.filename);
                        if (!row) {
                            row = document.createElement('tr');
                            row.id = dtx.filename;
                            // create 5 td cells
                            for (let i = 0; i < 5; i++) {
                                const td = document.createElement('td');
                                // For 5th column (image), create an img
                                if (i === 4) {
                                    const img = document.createElement('img');
                                    img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                                    td.appendChild(img);
                                }
                                row.appendChild(td);
                            }
                            tableBody.appendChild(row);
                        }

                        const tds = row.querySelectorAll('td');
                        const col3Cell = tds[2]; // Classified As
                        const col4Cell = tds[3]; // Reading
                        const col5Cell = tds[4]; // Image

                        // Ensure image exists
                        let img = col5Cell.querySelector('img');
                        if (!img) {
                            img = document.createElement('img');
                            col5Cell.appendChild(img);
                        }

                        let cls = dtx.cls;

                        // Assign classification and image
                        switch(cls) {
                            case 'Meter':
                                v_meter++;
                                col3Cell.innerHTML = '<a href="#" onclick="showImages(this)">Meter</a>';
                                img.src = 'data:image/png;base64,' + (dtx.img || '');
                                col4Cell.textContent = dtx.reading || '';
                                break;

                            case 'Calculator':
                                v_calc++;
                                col3Cell.textContent = 'Calculator';
                                img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                                col4Cell.textContent = dtx.reading || '';
                                break;

                            case 'IllegibleMeter':
                                v_imeter++;
                                col3Cell.textContent = 'IllegibleMeter';
                                img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                                col4Cell.textContent = dtx.reading || '';
                                break;

                            case 'Non-Meter':
                                v_other++;
                                col3Cell.textContent = 'Non-Meter';
                                img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                                col4Cell.textContent = dtx.reading || '';
                                break;

                            default:
                                // Any unknown or failed file
                                v_error++;
                                col3Cell.textContent = 'Error';
                                col4Cell.textContent = dtx.reading || '';
                                img.src = 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=';
                                break;
                        }
                    });

                    // Update dashboard
                    $('#dash-meter').text('Meter: ' + v_meter);
                    $('#dash-calc').text('Calculator: ' + v_calc);
                    $('#dash-ileg').text('IllegibleMeter: ' + v_imeter);
                    $('#dash-other').text('Others: ' + v_other);
                    $('#dash-error').text('Error: ' + v_error);

                    // scroll to bottom after appending all rows so user sees latest results
                    sc.scrollTop = sc.scrollHeight;

                    $('#body').waitMe('hide');
                },
        error: function(data) {
            $('#body').waitMe('hide');
            if (data.status === 401) {
                alert("Authentication failed. Please refresh and enter correct username/token.");
                sessionStorage.removeItem('username');
                sessionStorage.removeItem('token');
            } else {
                var x = JSON.parse(data.responseText)
                alert(JSON.stringify(x));
            }
        }
    });

});
</script>

<script>
function exportTableToExcel() {
    var table = document.getElementById('imageTable');
    var workbook = XLSX.utils.table_to_book(table, {sheet: "Sheet1"});
    XLSX.writeFile(workbook, 'table.xlsx');
}
function showImages(link) {
    const row = link.closest('tr');
    const images = row.getElementsByTagName('img');
    const popup = window.open("", "ImagePopup", `width=${screen.width},height=${screen.height}`);
    let content ='<div><label style="color:red;font-weight:bold">File Name:</label>'+row.querySelectorAll('td')[1].innerText+'</div>';
    content +='<div><label style="color:red;font-weight:bold">Reading: </label><b>'+row.querySelectorAll('td')[3].innerText+'</b></div><hr>';
    content += '<div style="display:flex;justify-content:space-around;height:70vh;align-items:center;">';
    for (let img of images) {
        content += `<img src="${img.src}" style="max-width:60%; max-height:100%;">`;
    }
    content += '</div><div style="text-align:center;margin-top:10px;"><button onclick="window.close()">Exit</button></div>';
    popup.document.write(content);
}
</script>

</body>
</html>
