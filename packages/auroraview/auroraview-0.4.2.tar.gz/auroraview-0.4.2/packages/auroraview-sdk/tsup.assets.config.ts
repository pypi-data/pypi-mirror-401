import { defineConfig, type Options } from 'tsup';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const coreAssetsDir = path.resolve(__dirname, '../../crates/auroraview-core/src/assets/js');
const extensionsAssetsDir = path.resolve(__dirname, '../../crates/auroraview-extensions/src/assets/js');

const commonOptions: Partial<Options> = {
  format: ['iife'],
  clean: false,
  minify: false,
  sourcemap: false,
  splitting: false,
  treeshake: true,
  noExternal: [/.*/],
  outExtension: () => ({ js: '.js' }),
  banner: {
    js: '// Generated by @auroraview/sdk',
  },
};

export default defineConfig([
  // Core bridge scripts (IIFE format for injection)
  {
    ...commonOptions,
    outDir: coreAssetsDir,
    entry: {
      'core/event_bridge': 'src/inject/event_bridge.ts',
      'core/state_bridge': 'src/inject/state_bridge.ts',
      'core/bridge_stub': 'src/inject/bridge_stub.ts',
    },
  },
  // Plugin scripts (IIFE format for injection)
  {
    ...commonOptions,
    outDir: coreAssetsDir,
    entry: {
      'plugins/fs': 'src/inject/plugins/fs.ts',
      'plugins/dialog': 'src/inject/plugins/dialog.ts',
      'plugins/clipboard': 'src/inject/plugins/clipboard.ts',
      'plugins/shell': 'src/inject/plugins/shell.ts',
    },
  },
  // Chrome Extension polyfill (for auroraview-extensions crate)
  {
    ...commonOptions,
    outDir: extensionsAssetsDir,
    entry: {
      'chrome_polyfill': 'src/inject/extensions/chrome_polyfill.ts',
    },
  },
]);
