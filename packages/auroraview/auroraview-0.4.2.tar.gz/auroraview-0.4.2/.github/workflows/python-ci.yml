name: Python CI

# Isolated CI for Python package (auroraview)
# Tests Python code changes without rebuilding Rust unless necessary
#
# This workflow focuses on:
# - Python unit tests
# - Python integration tests
# - Python code quality (ruff)
# - Python type checking (if configured)

on:
  push:
    branches: [develop]
    paths:
      - 'python/**'
      - 'tests/python/**'
      - 'pyproject.toml'
      - 'noxfile.py'
      - '.github/workflows/python-ci.yml'
  workflow_dispatch:
  workflow_call:
    inputs:
      artifact-prefix:
        description: "Prefix for artifact names"
        required: false
        type: string
        default: ''
      wheel-artifact:
        description: "Name of pre-built wheel artifact to use"
        required: false
        type: string
        default: ''

permissions:
  contents: read

# Cancel in-progress runs for the same workflow/ref combination
# Use workflow file name instead of github.workflow to avoid conflicts when called from other workflows
concurrency:
  group: python-ci-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  # Lint and format check (fast, no wheel needed)
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: Setup vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check formatting
        run: vx uvx ruff format --check python/ tests/

      - name: Check linting
        run: vx uvx ruff check python/ tests/

  # Unit tests (requires wheel)
  unit-tests:
    name: Unit Tests (Python ${{ matrix.python-version }}, ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.11', '3.12']
        exclude:
          # Reduce matrix - test edge versions on all platforms
          - os: windows-latest
            python-version: '3.8'
          - os: macos-latest
            python-version: '3.8'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Setup vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download pre-built wheel
        if: inputs.wheel-artifact != ''
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.wheel-artifact }}
          path: dist/

      - name: Build wheel (if not provided)
        if: inputs.wheel-artifact == ''
        shell: bash
        run: |
          # Install system dependencies on Linux
          if [[ "${{ runner.os }}" == "Linux" ]]; then
            sudo apt-get update
            sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libglib2.0-dev libxdo-dev pkg-config
          fi

          # Build wheel with maturin
          vx uv pip install maturin
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            vx uv run maturin build --release --out dist --features "ext-module,python-bindings,abi3-py38,win-webview2"
          else
            vx uv run maturin build --release --out dist --features "ext-module,python-bindings,abi3-py38"
          fi

      - name: Install wheel and test dependencies
        shell: bash
        run: |
          python -m pip install --upgrade pip
          pip install dist/*.whl
          pip install pytest pytest-cov pytest-timeout

      - name: Run unit tests
        shell: bash
        env:
          CI: 'true'
        run: |
          pytest tests/python/unit/ -v --tb=short --timeout=60

      - name: Upload coverage (Python 3.11 on ubuntu only)
        if: matrix.python-version == '3.11' && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v5
        with:
          files: coverage.xml
          flags: python,unit
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

  # Integration tests (requires wheel + Qt on some platforms)
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Setup vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libglib2.0-dev libxdo-dev pkg-config
          sudo apt-get install -y libegl1 libxkbcommon0 libxcb-cursor0 libxcb-icccm4 libxcb-keysyms1 libxcb-shape0

      - name: Download pre-built wheel
        if: inputs.wheel-artifact != ''
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.wheel-artifact }}
          path: dist/

      - name: Build wheel (if not provided)
        if: inputs.wheel-artifact == ''
        run: |
          vx uv pip install maturin
          vx uv run maturin build --release --out dist --features "ext-module,python-bindings,abi3-py38"

      - name: Install wheel and test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dist/*.whl
          pip install pytest pytest-cov pytest-timeout qtpy "PySide6<6.7"

      - name: Run integration tests
        env:
          CI: 'true'
          QT_API: pyside6
          QT_QPA_PLATFORM: offscreen
          QT_OPENGL: software
        run: |
          pytest tests/python/integration/ -v --tb=short --timeout=60 \
            --ignore=tests/python/integration/test_gallery_e2e.py \
            --ignore=tests/python/integration/test_gallery_real_e2e.py \
            --ignore=tests/python/integration/test_gallery_contract.py \
            --ignore=tests/python/integration/test_gallery_plugin_api.py

  # Python 3.7 compatibility test
  python37-compat:
    name: Python 3.7 Compatibility
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    needs: lint
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python 3.7
        uses: actions/setup-python@v6
        with:
          python-version: '3.7'

      - name: Setup vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libglib2.0-dev libxdo-dev pkg-config

      - name: Build wheel for Python 3.7
        run: |
          vx uv pip install maturin
          vx uv run maturin build --release --out dist -i python3.7 --features "ext-module,python-bindings"

      - name: Install and test
        run: |
          pip install dist/*.whl
          pip install pytest pytest-timeout
          # Run unit tests (skip Qt tests as PySide6 doesn't support Python 3.7)
          pytest tests/python/unit/ -v --tb=short --timeout=60 \
            --ignore=tests/python/unit/test_qt_signals.py \
            -k "not qt"

  # Final gate
  python-ready:
    name: Python Ready
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, python37-compat]
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## Python CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          declare -A jobs=(
            ["lint"]="${{ needs.lint.result }}"
            ["unit-tests"]="${{ needs.unit-tests.result }}"
            ["integration-tests"]="${{ needs.integration-tests.result }}"
            ["python37-compat"]="${{ needs.python37-compat.result }}"
          )

          failed=0
          for job in "${!jobs[@]}"; do
            result="${jobs[$job]}"
            if [[ "$result" == "success" ]]; then
              echo "- ✅ $job" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "- ⏭️ $job (skipped)" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "cancelled" ]]; then
              echo "- ⚠️ $job (cancelled)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $job ($result)" >> $GITHUB_STEP_SUMMARY
              failed=1
            fi
          done

          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Python CI failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Python CI passed!**" >> $GITHUB_STEP_SUMMARY
