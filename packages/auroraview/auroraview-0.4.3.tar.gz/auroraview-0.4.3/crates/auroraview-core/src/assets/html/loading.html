<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            /* Aurora Borealis gradient - cyan to purple to magenta */
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        /* Aurora animated background effect */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(ellipse at 40% 40%, rgba(98, 216, 243, 0.2) 0%, transparent 50%);
            animation: aurora 8s ease-in-out infinite alternate;
        }

        @keyframes aurora {
            0% {
                opacity: 0.5;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 1;
                transform: scale(1.1) translateY(-20px);
            }
        }

        .loading-container {
            text-align: center;
            color: white;
            z-index: 1;
            position: relative;
        }

        /* Logo container with glow effect */
        .logo-container {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Aurora logo SVG */
        .logo {
            width: 80px;
            height: 80px;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(98, 216, 243, 0.5));
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Rotating ring around logo */
        .logo-ring {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 2px solid transparent;
            border-top-color: rgba(98, 216, 243, 0.8);
            border-right-color: rgba(120, 119, 198, 0.6);
            border-radius: 50%;
            animation: spin 3s linear infinite;
        }

        .logo-ring::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            border: 2px solid transparent;
            border-bottom-color: rgba(255, 119, 198, 0.6);
            border-left-color: rgba(98, 216, 243, 0.4);
            border-radius: 50%;
            animation: spin 2s linear infinite reverse;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 3px;
            background: linear-gradient(90deg, #62d8f3, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 2s ease-in-out infinite;
            text-transform: uppercase;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .loading-subtext {
            font-size: 14px;
            opacity: 0.8;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 1px;
            min-height: 20px;
            transition: opacity 0.3s ease;
        }

        /* Progress bar with aurora colors */
        .progress-container {
            width: 280px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            margin: 24px auto 0;
            overflow: hidden;
            position: relative;
        }

        /* Indeterminate progress animation (default) */
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #62d8f3, #a78bfa, #f472b6);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-bar.indeterminate {
            width: 30%;
            animation: indeterminate 1.5s ease-in-out infinite;
        }

        .progress-bar.determinate {
            animation: none;
        }

        @keyframes indeterminate {
            0% { 
                transform: translateX(-100%);
            }
            100% { 
                transform: translateX(400%);
            }
        }

        /* Progress percentage text */
        .progress-text {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 8px;
            min-height: 16px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .progress-text.visible {
            opacity: 1;
        }

        /* Step indicators */
        .step-container {
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .step-item {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.3s ease, opacity 0.3s ease;
        }

        .step-item.active {
            color: rgba(255, 255, 255, 0.9);
        }

        .step-item.completed {
            color: #62d8f3;
        }

        .step-icon {
            width: 14px;
            height: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .step-icon .spinner {
            width: 12px;
            height: 12px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-top-color: #62d8f3;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .step-icon .check {
            color: #62d8f3;
            font-size: 14px;
        }
    </style>
    <script>
        /**
         * AuroraView Loading Screen API
         * 
         * Global API for controlling the loading screen progress and status.
         * Can be called from Rust via evaluate_script or from JavaScript.
         * 
         * Usage:
         *   window.auroraLoading.setProgress(50);           // Set progress to 50%
         *   window.auroraLoading.setText('Loading...');     // Set status text
         *   window.auroraLoading.setStep('init', true);     // Mark step as active
         *   window.auroraLoading.update({ progress: 75, text: 'Almost done' });
         */
        (function() {
            'use strict';

            // State
            var state = {
                progress: -1,  // -1 means indeterminate
                text: 'Preparing your experience',
                steps: []
            };

            // DOM elements (cached after DOMContentLoaded)
            var elements = {};

            /**
             * Update the progress bar
             * @param {number} percent - Progress percentage (0-100), or -1 for indeterminate
             */
            function setProgress(percent) {
                state.progress = percent;
                if (!elements.progressBar) return;

                if (percent < 0) {
                    // Indeterminate mode
                    elements.progressBar.classList.add('indeterminate');
                    elements.progressBar.classList.remove('determinate');
                    elements.progressBar.style.width = '';
                    elements.progressText.classList.remove('visible');
                } else {
                    // Determinate mode
                    elements.progressBar.classList.remove('indeterminate');
                    elements.progressBar.classList.add('determinate');
                    elements.progressBar.style.width = Math.min(100, Math.max(0, percent)) + '%';
                    elements.progressText.textContent = Math.round(percent) + '%';
                    elements.progressText.classList.add('visible');
                }
            }

            /**
             * Update the status text
             * @param {string} text - Status text to display
             */
            function setText(text) {
                state.text = text;
                if (elements.subtext) {
                    elements.subtext.textContent = text;
                }
            }

            /**
             * Add or update a step indicator
             * @param {string} id - Unique step identifier
             * @param {string} text - Step description
             * @param {string} status - 'pending', 'active', or 'completed'
             */
            function setStep(id, text, status) {
                var existing = state.steps.find(function(s) { return s.id === id; });
                if (existing) {
                    existing.text = text;
                    existing.status = status;
                } else {
                    state.steps.push({ id: id, text: text, status: status });
                }
                renderSteps();
            }

            /**
             * Clear all steps
             */
            function clearSteps() {
                state.steps = [];
                renderSteps();
            }

            /**
             * Render step indicators
             */
            function renderSteps() {
                if (!elements.stepContainer) return;

                elements.stepContainer.innerHTML = '';
                state.steps.forEach(function(step) {
                    var item = document.createElement('div');
                    item.className = 'step-item ' + step.status;

                    var icon = document.createElement('span');
                    icon.className = 'step-icon';

                    if (step.status === 'completed') {
                        icon.innerHTML = '<span class="check">✓</span>';
                    } else if (step.status === 'active') {
                        icon.innerHTML = '<span class="spinner"></span>';
                    } else {
                        icon.innerHTML = '<span style="opacity: 0.3">○</span>';
                    }

                    var text = document.createElement('span');
                    text.textContent = step.text;

                    item.appendChild(icon);
                    item.appendChild(text);
                    elements.stepContainer.appendChild(item);
                });
            }

            /**
             * Batch update multiple properties
             * @param {Object} options - { progress, text, steps }
             */
            function update(options) {
                if (options.progress !== undefined) {
                    setProgress(options.progress);
                }
                if (options.text !== undefined) {
                    setText(options.text);
                }
                if (options.steps !== undefined) {
                    state.steps = options.steps;
                    renderSteps();
                }
            }

            /**
             * Get current state
             */
            function getState() {
                return JSON.parse(JSON.stringify(state));
            }

            // Initialize DOM references
            function initElements() {
                elements.progressBar = document.getElementById('progress-bar');
                elements.progressText = document.getElementById('progress-text');
                elements.subtext = document.getElementById('loading-subtext');
                elements.stepContainer = document.getElementById('step-container');

                // Apply initial state
                setProgress(state.progress);
                setText(state.text);
                renderSteps();
            }

            // Expose global API
            window.auroraLoading = {
                setProgress: setProgress,
                setText: setText,
                setStep: setStep,
                clearSteps: clearSteps,
                update: update,
                getState: getState
            };

            // Also expose via window.AuroraLoading for consistency
            window.AuroraLoading = window.auroraLoading;

            // Initialize on DOM ready
            document.addEventListener('DOMContentLoaded', function() {
                console.log('[Loading] DOM ready, initializing loading API');
                initElements();

                // Notify Rust that loading screen is ready
                // Use send_event which is the correct method name in event_bridge.js
                if (window.auroraview && window.auroraview.send_event) {
                    console.log('[Loading] Sending loading_screen_ready event');
                    window.auroraview.send_event('loading_screen_ready', {});
                } else {
                    console.warn('[Loading] auroraview.send_event not available, event bridge may not be initialized');
                }
            });

            // Listen for loading updates from Rust via custom events
            window.addEventListener('auroraview:loading_update', function(e) {
                if (e.detail) {
                    update(e.detail);
                }
            });

            // Listen for backend_ready event - when Python is ready
            // This will update the UI and then trigger navigation
            window.addEventListener('auroraview:backend_ready', function(e) {
                console.log('[Loading] Backend is ready!', e.detail);
                clearTimeout(window.__loadingTimeout);
                window.__backendReady = true;
                
                // Update loading UI to show ready state
                setProgress(100);
                setText('Ready! Loading application...');
                
                // Short delay to show the "Ready" state, then navigate
                setTimeout(function() {
                    console.log('[Loading] Triggering navigation to app');
                    if (window.auroraview && window.auroraview.send_event) {
                        window.auroraview.send_event('navigate_to_app', {});
                    } else {
                        console.error('[Loading] auroraview.send_event not available for navigation');
                    }
                }, 300);  // 300ms delay to show "Ready" state
            });

            // Timeout and diagnostic mechanism for headless testing
            // If backend_ready is not received within timeout, show diagnostic info
            var LOADING_TIMEOUT_MS = 30000; // 30 seconds default
            var DIAGNOSTIC_INTERVAL_MS = 5000; // Log diagnostics every 5 seconds
            
            window.__loadingStartTime = Date.now();
            window.__backendReady = false;
            window.__diagnosticCount = 0;
            
            // Diagnostic function to help debug stuck loading
            function logDiagnostics() {
                window.__diagnosticCount++;
                var elapsed = Date.now() - window.__loadingStartTime;
                var diagnostics = {
                    elapsed_ms: elapsed,
                    backend_ready: window.__backendReady,
                    auroraview_available: !!window.auroraview,
                    send_event_available: !!(window.auroraview && window.auroraview.send_event),
                    trigger_available: !!(window.auroraview && window.auroraview.trigger),
                    loading_state: window.auroraLoading ? window.auroraLoading.getState() : null,
                    diagnostic_count: window.__diagnosticCount
                };
                console.log('[Loading:Diagnostic]', JSON.stringify(diagnostics, null, 2));
                
                // Emit diagnostic event for external monitoring (CDP/Playwright)
                window.dispatchEvent(new CustomEvent('auroraview:loading_diagnostic', { 
                    detail: diagnostics 
                }));
                
                return diagnostics;
            }
            
            // Periodic diagnostic logging
            window.__diagnosticInterval = setInterval(function() {
                if (!window.__backendReady) {
                    logDiagnostics();
                } else {
                    clearInterval(window.__diagnosticInterval);
                }
            }, DIAGNOSTIC_INTERVAL_MS);
            
            // Timeout handler
            window.__loadingTimeout = setTimeout(function() {
                if (window.__backendReady) return;
                
                var diagnostics = logDiagnostics();
                console.error('[Loading:Timeout] Backend not ready after ' + LOADING_TIMEOUT_MS + 'ms');
                
                // Update UI to show timeout state
                setText('Loading timeout - Backend not responding');
                setProgress(-1); // Back to indeterminate
                
                // Emit timeout event for external handling
                window.dispatchEvent(new CustomEvent('auroraview:loading_timeout', { 
                    detail: {
                        timeout_ms: LOADING_TIMEOUT_MS,
                        diagnostics: diagnostics
                    }
                }));
                
                // For headless testing: expose a function to force navigation
                window.__forceNavigate = function() {
                    console.log('[Loading] Force navigation triggered');
                    if (window.auroraview && window.auroraview.send_event) {
                        window.auroraview.send_event('navigate_to_app', {});
                    }
                };
                
                console.log('[Loading:Timeout] Call window.__forceNavigate() to force navigation');
            }, LOADING_TIMEOUT_MS);
            
            // Expose diagnostic API for external tools
            window.auroraLoading.getDiagnostics = logDiagnostics;
            window.auroraLoading.isReady = function() { return window.__backendReady; };
            window.auroraLoading.getElapsedTime = function() { return Date.now() - window.__loadingStartTime; };
        })();
    </script>
</head>
<body>
    <div class="loading-container">
        <div class="logo-container">
            <div class="logo-ring"></div>
            <!-- Aurora Logo SVG - stylized 'A' with aurora waves -->
            <svg class="logo" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <!-- Aurora waves background -->
                <defs>
                    <linearGradient id="auroraGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#62d8f3"/>
                        <stop offset="50%" style="stop-color:#a78bfa"/>
                        <stop offset="100%" style="stop-color:#f472b6"/>
                    </linearGradient>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                <!-- Stylized 'A' for Aurora -->
                <path d="M50 15 L20 85 L35 85 L42 65 L58 65 L65 85 L80 85 L50 15Z M50 35 L55 55 L45 55 L50 35Z" 
                      fill="url(#auroraGrad)" filter="url(#glow)"/>
                <!-- Aurora wave accent -->
                <path d="M15 50 Q30 40, 50 50 T85 50" 
                      stroke="url(#auroraGrad)" stroke-width="3" fill="none" opacity="0.6">
                    <animate attributeName="d" 
                             values="M15 50 Q30 40, 50 50 T85 50;M15 50 Q30 60, 50 50 T85 50;M15 50 Q30 40, 50 50 T85 50" 
                             dur="3s" repeatCount="indefinite"/>
                </path>
            </svg>
        </div>
        <div class="loading-text">AuroraView</div>
        <div class="loading-subtext" id="loading-subtext">Preparing your experience</div>
        <div class="progress-container">
            <div class="progress-bar indeterminate" id="progress-bar"></div>
        </div>
        <div class="progress-text" id="progress-text"></div>
        <div class="step-container" id="step-container"></div>
    </div>
</body>
</html>

