name: MCP CI

# CI for AuroraView MCP Server package
# Includes unit tests, linting, and package build

on:
  push:
    branches: [develop]
    paths:
      - 'packages/auroraview-mcp/**'
      - '.github/workflows/mcp-ci.yml'
  workflow_dispatch:
  workflow_call:
    inputs:
      artifact-prefix:
        description: "Prefix for artifact names to avoid conflicts"
        required: false
        type: string
        default: ''
      version:
        description: "Version to use for the package (if not set, uses pyproject.toml version)"
        required: false
        type: string
        default: ''
    outputs:
      mcp-package-artifact:
        description: "Name of the MCP package artifact"
        value: ${{ jobs.build-package.outputs.artifact-name }}

permissions:
  contents: read

# Cancel in-progress runs for the same workflow/ref combination
# Use workflow file name instead of github.workflow to avoid conflicts when called from release.yml
concurrency:
  group: mcp-ci-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  # Lint and format check
  lint:
    if: ${{ false }} # temporarily disabled MCP CI
    name: Lint

    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v6

      - name: Install vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run lint
        run: |
          echo "Running MCP lint checks..."
          vx just mcp-lint
          echo "Lint checks completed successfully"

  # Unit tests with coverage
  unit-tests:
    if: ${{ false }} # temporarily disabled MCP CI
    name: Unit Tests (Python ${{ matrix.python-version }})

    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests
        run: |
          echo "Running MCP unit tests (Python ${{ matrix.python-version }})..."
          vx just mcp-test
          echo "Unit tests completed successfully"

  # Coverage report (only on Python 3.11)
  coverage:
    if: ${{ false }} # temporarily disabled MCP CI
    name: Coverage Report

    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run tests with coverage
        run: |
          echo "Running MCP tests with coverage..."
          vx just mcp-test-cov
          echo "Coverage tests completed successfully"

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          files: packages/auroraview-mcp/coverage.xml
          flags: mcp,python
          name: mcp-coverage
          fail_ci_if_error: false
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-prefix }}mcp-coverage-report
          path: packages/auroraview-mcp/htmlcov/
          retention-days: 7
          if-no-files-found: ignore

  # Build package
  build-package:
    if: ${{ false }} # temporarily disabled MCP CI
    name: Build Package

    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [lint]
    outputs:
      artifact-name: ${{ steps.upload.outputs.artifact-name }}
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version if specified
        if: inputs.version != ''
        run: |
          cd packages/auroraview-mcp
          echo "Updating version to: ${{ inputs.version }}"
          # Update version in pyproject.toml using sed
          sed -i 's/^version = ".*"/version = "${{ inputs.version }}"/' pyproject.toml
          cat pyproject.toml | grep version

      - name: Build package
        run: |
          echo "Building MCP package..."
          vx just mcp-build
          echo "Package build completed successfully"

      - name: Verify build outputs
        run: |
          set -e
          echo "Checking MCP dist..."
          ls -la packages/auroraview-mcp/dist/
          
          # Verify wheel exists
          if ! ls packages/auroraview-mcp/dist/*.whl 1> /dev/null 2>&1; then
            echo "Error: Missing wheel file"
            exit 1
          fi
          echo "✓ Wheel file found"
          
          # Verify sdist exists
          if ! ls packages/auroraview-mcp/dist/*.tar.gz 1> /dev/null 2>&1; then
            echo "Error: Missing sdist file"
            exit 1
          fi
          echo "✓ Sdist file found"
          
          echo "All MCP package outputs verified!"

      - name: Upload MCP package artifact
        id: upload
        uses: actions/upload-artifact@v6
        with:
          name: ${{ inputs.artifact-prefix }}mcp-package
          path: packages/auroraview-mcp/dist/
          retention-days: 7

      - name: Set artifact name output
        run: echo "artifact-name=${{ inputs.artifact-prefix }}mcp-package" >> $GITHUB_OUTPUT

  # Test package installation
  test-install:
    if: ${{ false }} # temporarily disabled MCP CI
    name: Test Install

    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    needs: [build-package]
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install vx
        uses: loonghao/vx@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download MCP package
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact-prefix }}mcp-package
          path: dist/

      - name: Create test environment and install (Unix)
        if: runner.os != 'Windows'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e  # Exit on any error
          
          PYEXEC=$(python -c "import sys; print(sys.executable)")
          echo "Python executable: $PYEXEC"
          
          # Create virtual environment
          echo "Creating virtual environment..."
          vx uv venv --python "$PYEXEC" .test-venv
          
          # Verify virtual environment
          PYTHON_BIN=".test-venv/bin/python"
          if [ ! -f "$PYTHON_BIN" ]; then
            echo "Error: Python executable not found at $PYTHON_BIN"
            exit 1
          fi
          echo "Virtual environment created successfully"
          
          # Check for wheel files
          WHEEL_COUNT=$(ls dist/*.whl 2>/dev/null | wc -l)
          if [ "$WHEEL_COUNT" -eq 0 ]; then
            echo "Error: No wheel file found in dist/"
            exit 1
          fi
          echo "Found $WHEEL_COUNT wheel file(s)"
          
          # Install package
          echo "Installing wheel..."
          vx uv pip install --python "$PYTHON_BIN" dist/*.whl
          echo "Package installed successfully"

      - name: Create test environment and install (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = "Stop"
          
          $py = (python -c "import sys; print(sys.executable)")
          Write-Host "Python executable: $py"
          
          # Create virtual environment
          Write-Host "Creating virtual environment..."
          vx uv venv --python $py .test-venv
          
          # Verify virtual environment
          $pythonExe = ".test-venv\Scripts\python.exe"
          if (-not (Test-Path $pythonExe)) {
            Write-Error "Python executable not found at $pythonExe"
            exit 1
          }
          Write-Host "Virtual environment created successfully"
          
          # Get wheel file
          $wheel = Get-ChildItem dist/*.whl | Select-Object -First 1
          if (-not $wheel) {
            Write-Error "No wheel file found in dist/"
            exit 1
          }
          Write-Host "Installing wheel: $($wheel.FullName)"
          
          # Install package
          vx uv pip install --python $pythonExe $wheel.FullName
          Write-Host "Package installed successfully"



      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          set -e
          echo "Verifying MCP server installation..."
          
          # Test MCP server import
          .test-venv/bin/python -c "from auroraview_mcp.server import mcp; print('✓ MCP server imported successfully')"
          
          # Test FastMCP Client import
          .test-venv/bin/python -c "from fastmcp import Client; print('✓ FastMCP Client imported successfully')"
          
          # Test CLI (may not be available for stdio server)
          if .test-venv/bin/auroraview-mcp --help > /dev/null 2>&1; then
            echo "✓ CLI help available"
          else
            echo "ℹ CLI help not available (expected for stdio server)"
          fi
          
          echo "Installation verification completed successfully"

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          Write-Host "Verifying MCP server installation..."
          
          # Test MCP server import
          .test-venv\Scripts\python.exe -c "from auroraview_mcp.server import mcp; print('✓ MCP server imported successfully')"
          
          # Test FastMCP Client import
          .test-venv\Scripts\python.exe -c "from fastmcp import Client; print('✓ FastMCP Client imported successfully')"
          
          # Test CLI (may not be available for stdio server)
          try {
            .test-venv\Scripts\auroraview-mcp.exe --help | Out-Null
            Write-Host "✓ CLI help available"
          } catch {
            Write-Host "ℹ CLI help not available (expected for stdio server)"
          }
          
          Write-Host "Installation verification completed successfully"

  # Final gate
  mcp-ready:
    if: ${{ false }} # temporarily disabled MCP CI
    name: MCP Ready

    runs-on: ubuntu-latest
    needs: [lint, unit-tests, coverage, build-package, test-install]
    steps:
      - name: Check results
        run: |
          echo "## MCP CI Results" >> $GITHUB_STEP_SUMMARY
          
          declare -A jobs=(
            ["lint"]="${{ needs.lint.result }}"
            ["unit-tests"]="${{ needs.unit-tests.result }}"
            ["coverage"]="${{ needs.coverage.result }}"
            ["build-package"]="${{ needs.build-package.result }}"
            ["test-install"]="${{ needs.test-install.result }}"
          )
          
          failed=0
          for job in "${!jobs[@]}"; do
            result="${jobs[$job]}"
            if [[ "$result" == "success" ]]; then
              echo "- ✅ $job" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "skipped" ]]; then
              echo "- ⏭️ $job (skipped)" >> $GITHUB_STEP_SUMMARY
            elif [[ "$result" == "cancelled" ]]; then
              echo "- ⚠️ $job (cancelled)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- ❌ $job ($result)" >> $GITHUB_STEP_SUMMARY
              failed=1
            fi
          done
          
          if [[ $failed -eq 1 ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "❌ **MCP CI failed**" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **MCP CI passed!**" >> $GITHUB_STEP_SUMMARY
