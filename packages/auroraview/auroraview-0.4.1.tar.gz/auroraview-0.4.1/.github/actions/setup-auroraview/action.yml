name: 'Setup AuroraView Development Environment'
description: 'Sets up development environment using vx tool manager'

inputs:
  python-version:
    description: 'Python version to use (overrides vx.toml)'
    required: false
    default: ''
  rust-components:
    description: 'Additional Rust components to install'
    required: false
    default: ''
  cache-key-suffix:
    description: 'Additional suffix for cache keys'
    required: false
    default: ''
  install-dependencies:
    description: 'Whether to install project dependencies'
    required: false
    default: 'true'

outputs:
  python-version:
    description: 'The Python version that was installed'
    value: ${{ steps.setup-vx.outputs.python-version }}
  rust-version:
    description: 'The Rust version that was installed'
    value: ${{ steps.setup-vx.outputs.rust-version }}

runs:
  using: 'composite'
  steps:
    - name: Install vx
      uses: loonghao/vx@vx-v0.6.4
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        cache: false

    - name: Setup vx
      id: setup-vx
      shell: bash
      run: vx setup --ci

    - name: Show installed tools
      shell: bash
      run: |
        echo "=== Installed Tools ==="
        vx python --version
        vx rustc --version
        vx node --version
        vx uv --version
        vx just --version
        echo "python-version=$(vx python --version 2>&1 | head -1)" >> $GITHUB_OUTPUT
        echo "rust-version=$(vx rustc --version 2>&1 | head -1)" >> $GITHUB_OUTPUT

    - name: Install additional Rust components
      if: inputs.rust-components != ''
      shell: bash
      run: |
        vx rustup component add ${{ inputs.rust-components }}

    - name: Setup Advanced Caching
      uses: ./.github/actions/cache-setup
      with:
        cache-type: 'build'
        cache-key-suffix: ${{ inputs.cache-key-suffix }}
        python-version: ${{ inputs.python-version || '3.11' }}

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libwebkit2gtk-4.1-dev \
          libgtk-3-dev \
          libglib2.0-dev \
          libpango1.0-dev \
          libcairo2-dev
        # X11 and related dev packages needed by active-win-pos-rs and GUI crates on Linux
        sudo apt-get install -y \
          libx11-dev \
          libx11-xcb-dev \
          libxcb1-dev \
          libxcb-render0-dev \
          libxcb-shape0-dev \
          libxcb-xfixes0-dev \
          libxrandr-dev \
          libxi-dev \
          libxfixes-dev \
          libxtst-dev \
          libxdo-dev \
          pkg-config
        # Qt6 dependencies for PySide6
        sudo apt-get install -y \
          libegl1 \
          libxkbcommon0 \
          libdbus-1-3

    - name: Install dependencies
      if: inputs.install-dependencies == 'true'
      shell: bash
      run: vx just ci-install
