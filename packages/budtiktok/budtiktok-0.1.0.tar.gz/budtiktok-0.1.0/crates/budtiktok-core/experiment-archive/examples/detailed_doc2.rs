//! Find exact divergence in doc 2

use std::collections::HashMap;
use std::fs;
use std::io::{BufRead, BufReader};
use ahash::AHashMap;

fn main() {
    let workspace = "/home/bud/Desktop/latentbud/budtiktok";

    // Load vocab and merges
    let vocab_path = format!("{}/benchmark_data/gpt2/vocab.json", workspace);
    let content = fs::read_to_string(&vocab_path).unwrap();
    let vocab: HashMap<String, u32> = serde_json::from_str(&content).unwrap();
    let vocab_ahash: AHashMap<String, u32> = vocab.iter().map(|(k, v)| (k.clone(), *v)).collect();

    // Build reverse vocab
    let mut vocab_r: Vec<String> = vec![String::new(); vocab.len()];
    for (k, &v) in &vocab {
        vocab_r[v as usize] = k.clone();
    }

    let merges_path = format!("{}/benchmark_data/gpt2/merges.txt", workspace);
    let merge_content = fs::read_to_string(&merges_path).unwrap();
    let merges: Vec<(String, String)> = merge_content.lines()
        .skip(1)
        .filter_map(|line| {
            let parts: Vec<&str> = line.split_whitespace().collect();
            if parts.len() == 2 {
                Some((parts[0].to_string(), parts[1].to_string()))
            } else {
                None
            }
        })
        .collect();

    use budtiktok_core::bpe_linear::OptimizedBpeEncoder;
    let encoder = OptimizedBpeEncoder::new(vocab_ahash, merges, "<|endoftext|>");

    // Load doc 2
    let data_path = format!("{}/benchmark_data/openwebtext_1gb.jsonl", workspace);
    let file = fs::File::open(&data_path).unwrap();
    let reader = BufReader::new(file);

    let doc2: String = reader.lines()
        .skip(2)
        .take(1)
        .map(|line| {
            let line = line.unwrap();
            let json: serde_json::Value = serde_json::from_str(&line).unwrap();
            json["text"].as_str().unwrap_or("").to_string()
        })
        .next()
        .unwrap();

    // Full HF tokens for doc 2 (from Python)
    let hf_expected: Vec<u32> = vec![
        464, 9317, 6241, 416, 5721, 1023, 389, 511, 898, 290, 466, 407, 2380, 262, 5009, 286, 8329, 18323, 13, 785,
        13, 198, 198, 1639, 423, 284, 1577, 1992, 8732, 2486, 3884, 329, 530, 1517, 25, 15794, 13, 10528, 318, 1683,
        465, 8046, 13, 10528, 481, 1683, 307, 465, 8046, 13, 40050, 278, 5426, 3000, 290, 262, 1605, 661, 11, 319,
        262, 584, 1021, 11, 783, 326, 338, 257, 1180, 1621, 13, 198, 198, 5211, 345, 3505, 618, 2486, 1291, 2419,
        276, 1088, 262, 1499, 290, 16459, 16407, 351, 3399, 284, 3015, 329, 5073, 2605, 780, 465, 8666, 290, 465, 10655,
        547, 319, 262, 11100, 30, 679, 925, 257, 2092, 7078, 878, 262, 7582, 5430, 465, 2151, 1718, 287, 262, 1946,
        11702, 7024, 13, 198, 198, 11486, 750, 339, 12127, 706, 428, 1946, 9894, 326, 339, 550, 1997, 284, 466, 351,
        340, 30, 8314, 339, 898, 510, 284, 465, 3756, 2597, 287, 938, 1227, 338, 4787, 3071, 30, 198, 198, 5756,
        338, 302, 7972, 262, 9154, 2252, 11, 284, 2486, 338, 6317, 284, 465, 2151, 338, 13393, 7433, 287, 262, 3050,
        11702, 7024, 11, 543, 373, 5688, 546, 12439, 13, 679, 1422, 470, 12127, 597, 2614, 21286, 1799, 329, 10013, 326,
        937, 48288, 414, 319, 262, 1605, 661, 832, 6908, 1924, 290, 37268, 13, 679, 2391, 40176, 326, 339, 8020, 470,
        1760, 257, 922, 1576, 1693, 1972, 262, 3275, 503, 284, 262, 1605, 661, 546, 340, 11, 3805, 465, 2026, 11613,
        18138, 2111, 284, 20999, 514, 284, 8856, 674, 9105, 2951, 13, 198, 198, 5211, 345, 766, 262, 3912, 994, 30,
        2486, 338, 1570, 318, 326, 262, 1605, 661, 1377, 883, 287, 262, 2266, 2585, 11, 6949, 1377, 389, 257, 1310,
        3105, 11, 30285, 290, 1263, 5191, 290, 761, 284, 307, 3181, 1863, 7773, 656, 262, 2310, 301, 4289, 11, 810,
        4371, 25085, 468, 47098, 287, 257, 649, 2479, 286, 35957, 13, 2399, 691, 9894, 468, 587, 287, 17881, 1286, 302,
        12, 18123, 803, 262, 12922, 36331, 364, 13, 198, 198, 5756, 502, 1577, 345, 1194, 1672, 13, 11436, 2486, 338,
        33016, 286, 262, 5533, 1812, 1448, 355, 366, 64, 449, 53, 1074, 13984, 1374, 546, 465, 1624, 11, 262, 1755,
        878, 262, 7417, 50010, 287, 6342, 11, 326, 262, 5533, 1812, 373, 366, 45964, 13984, 198, 198, 11633, 339, 1683,
        12127, 465, 8563, 612, 30, 1400, 13, 6521, 11, 465, 691, 9894, 373, 287, 407, 1719, 28412, 17338, 465, 36573,
        10064, 284, 262, 1605, 661, 13, 679, 531, 465, 4811, 1028, 262, 5533, 1812, 373, 1762, 13, 357, 1212, 373,
        878, 11, 355, 314, 10014, 11, 465, 13938, 326, 339, 550, 645, 2450, 2014, 383, 1917, 373, 326, 24725, 2056,
        5197, 706, 262, 6342, 3434, 373, 43881, 3246, 10251, 287, 262, 1578, 1829, 13, 679, 531, 25, 366, 1135, 4398,
        470, 11, 319, 257, 3218, 4308, 11, 314, 892, 11, 3417, 477, 262, 670, 326, 356, 1053, 587, 1804, 329,
        517, 621, 257, 614, 783, 284, 7433, 1, 262, 5533, 1812, 13, 366, 1532, 345, 1053, 587, 4964, 5581, 329,
        262, 938, 1227, 11, 477, 345, 1053, 587, 4379, 11, 477, 345, 1053, 587, 4854, 546, 318, 777, 3730, 351,
        20680, 393, 2042, 9701, 508, 389, 6196, 2406, 284, 651, 345, 13, 843, 523, 314, 1833, 1521, 661, 389, 5213,
        546, 340, 526, 198, 198, 15316, 11, 612, 338, 2147, 284, 766, 994, 13, 632, 338, 407, 257, 8649, 1917,
        475, 257, 11202, 1917, 13, 1318, 338, 645, 12439, 1917, 26, 340, 338, 655, 326, 262, 1605, 661, 836, 470,
        651, 340, 13, 198, 198, 6104, 7270, 968, 1971, 3782, 22309, 6669, 49851, 21842, 67, 10810, 11, 287, 2321, 11,
        326, 2486, 290, 465, 3656, 11, 16738, 11, 389, 41466, 1571, 290, 435, 37711, 13, 383, 1835, 17485, 366, 4598,
        1975, 287, 1605, 15313, 1042, 1377, 511, 898, 11, 290, 484, 1254, 625, 46635, 276, 290, 739, 1324, 29102, 515,
        553, 673, 2630, 13, 383, 1835, 17485, 4398, 470, 11679, 3399, 26, 366, 732, 11679, 606, 526, 198, 198, 6104,
        2961, 11, 287, 3945, 3050, 11, 2486, 16387, 284, 366, 4868, 268, 1, 284, 4734, 379, 257, 1535, 1337, 14237,
        13, 887, 11, 355, 22309, 7212, 4424, 75, 2630, 11, 366, 15344, 82, 503, 339, 4001, 339, 1549, 307, 8680,
        284, 465, 898, 3809, 13, 2750, 262, 886, 286, 262, 30681, 1785, 11, 1770, 13, 2486, 550, 9635, 329, 15136,
        2431, 1377, 5193, 2431, 517, 621, 262, 9796, 2431, 13529, 416, 1596, 4734, 13, 383, 2310, 4390, 10191, 973, 17342,
        2431, 11, 3501, 262, 1893, 290, 465, 5941, 257, 27833, 30435, 2431, 526, 198, 198, 1870, 1521, 466, 262, 6437,
        274, 1394, 2984, 525, 344, 1412, 2486, 338, 27951, 30, 5426, 3000, 11, 13063, 43306, 11, 11465, 35368, 13, 198,
        198, 818, 257, 2904, 3199, 2720, 351, 21567, 8026, 11, 2486, 6699, 326, 339, 290, 465, 2151, 21655, 262, 366,
        1073, 71, 419, 286, 1762, 12, 4871, 2330, 4446, 1, 326, 13519, 17830, 329, 3759, 1301, 338, 5373, 13, 28416,
        407, 465, 8046, 13, 366, 7841, 286, 340, 553, 531, 2486, 11, 366, 271, 5426, 3000, 287, 790, 2318, 290,
        7072, 287, 1263, 22716, 286, 262, 1499, 11, 475, 636, 286, 340, 318, 635, 4956, 407, 1762, 379, 257, 8701,
        12, 19150, 1241, 11, 852, 287, 612, 11, 4478, 510, 11, 1642, 7159, 526, 198, 198, 464, 4427, 4956, 423,
        11, 1864, 284, 2486, 11, 318, 407, 326, 484, 1053, 24007, 777, 5348, 422, 257, 2450, 6650, 13, 366, 2061,
        318, 2081, 11, 996, 11, 318, 326, 4232, 2450, 34092, 326, 356, 1053, 587, 24634, 836, 470, 3151, 11, 389,
        407, 2982, 416, 11, 262, 7974, 287, 777, 5348, 13, 843, 644, 484, 466, 3285, 318, 705, 15948, 393, 5073,
        389, 2111, 284, 1011, 1497, 357, 14108, 8, 6541, 6, 393, 705, 9930, 23797, 345, 11496, 198, 198, 40, 9585,
        25, 770, 3516, 318, 21196, 11, 5970, 4359, 3193, 6414, 13, 679, 468, 925, 645, 2450, 8563, 26, 465, 3275,
        655, 2125, 470, 1972, 832, 11, 11476, 780, 262, 5940, 2056, 389, 9105, 546, 340, 290, 11476, 780, 661, 389,
        655, 1165, 39189, 276, 15715, 13, 198, 198, 40, 5465, 284, 1394, 6079, 510, 262, 1613, 11, 475, 465, 1175,
        319, 262, 5940, 2056, 318, 2147, 649, 11, 2035, 13, 314, 2630, 546, 340, 287, 3050, 287, 616, 1492, 366,
        13916, 999, 12914, 14734, 526, 679, 2540, 3013, 549, 4623, 5426, 7638, 379, 1705, 19993, 329, 19022, 306, 19798, 1586,
        13, 383, 2635, 2097, 4130, 7987, 26443, 5426, 3000, 290, 584, 9188, 13, 2635, 2097, 8062, 3437, 38992, 30833, 7151,
        257, 366, 2416, 312, 2882, 1, 284, 47578, 366, 19399, 338, 20385, 1, 1028, 262, 3662, 11, 4585, 5426, 3000,
        366, 3911, 286, 262, 3415, 3615, 526, 17471, 12534, 3271, 42575, 14892, 531, 5426, 3000, 11102, 318, 366, 1662, 1107,
        257, 1705, 4429, 526, 198, 198, 16676, 618, 12439, 338, 10033, 7068, 11, 11232, 25665, 527, 11, 11764, 6848, 326,
        262, 2486, 3662, 373, 1498, 284, 38666, 262, 1605, 661, 546, 12439, 290, 30860, 276, 340, 510, 284, 366, 1169,
        37775, 286, 262, 1605, 10765, 13984, 198, 198, 2396, 467, 4058, 290, 3960, 514, 257, 7850, 546, 703, 262, 5940,
        2056, 389, 4020, 34567, 345, 11, 1770, 13, 2486, 11, 290, 15850, 262, 1171, 13, 921, 423, 587, 2111, 284,
        38666, 514, 329, 3624, 812, 11, 290, 262, 1171, 468, 587, 4291, 345, 329, 379, 1551, 718, 352, 14, 17,
        286, 883, 812, 13, 2735, 4446, 423, 10158, 345, 534, 4094, 599, 15230, 1865, 11, 290, 345, 991, 481, 407,
        6004, 13, 921, 460, 470, 6004, 13, 632, 338, 407, 644, 345, 466, 13, 887, 262, 1605, 661, 423, 587,
        8680, 11, 290, 484, 466, 1833, 534, 4788, 13, 843, 340, 338, 257, 649, 1110, 287, 2253, 13,
    ];

    let bt_tokens = encoder.encode(&doc2);

    println!("BudTikTok: {} tokens", bt_tokens.len());
    println!("HF expected: {} tokens", hf_expected.len());

    // Find first divergence
    println!("\nComparing tokens...");
    let max_len = bt_tokens.len().max(hf_expected.len());
    for i in 0..max_len {
        let bt = bt_tokens.get(i).copied();
        let hf = hf_expected.get(i).copied();

        if bt != hf {
            println!("\nFirst divergence at position {}:", i);
            println!("  BT: {:?} = {:?}", bt, bt.map(|id| vocab_r.get(id as usize).map(|s| s.as_str())));
            println!("  HF: {:?} = {:?}", hf, hf.map(|id| vocab_r.get(id as usize).map(|s| s.as_str())));

            // Show context (previous tokens)
            println!("\n  Context (positions {} to {}):", i.saturating_sub(5), i + 5);
            for j in i.saturating_sub(5)..=(i + 5).min(max_len - 1) {
                let bt_tok = bt_tokens.get(j).copied();
                let hf_tok = hf_expected.get(j).copied();
                let mark = if j == i { ">>>" } else { "   " };
                println!("  {} {}: BT={:?}={:?}  HF={:?}={:?}",
                    mark, j,
                    bt_tok, bt_tok.map(|id| vocab_r.get(id as usize).map(|s| s.as_str())),
                    hf_tok, hf_tok.map(|id| vocab_r.get(id as usize).map(|s| s.as_str())));
            }
            break;
        }
    }

    if bt_tokens.len() == hf_expected.len() {
        let all_match = bt_tokens.iter().zip(hf_expected.iter()).all(|(a, b)| a == b);
        if all_match {
            println!("\nâœ“ PERFECT MATCH: All {} tokens are identical!", bt_tokens.len());
        }
    }
}
