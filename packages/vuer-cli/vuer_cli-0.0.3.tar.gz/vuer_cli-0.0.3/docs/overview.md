# Vuer CLI Documentation

**vuer-cli** is a command-line tool for managing physical simulation
environments. It works with Vuer Hub to version-control and distribute
environments the same way you manage software packages.

## Installation

```shell
pip install vuer-cli==0.0.2
```

## Overview

Vuer CLI provides two main capabilities:

1. **Project Environment Dependency Management**: Based on `environment.json` +
  `vuer_environments/` + `environments-lock.yaml`, manage project dependencies
  through `sync` / `add` / `remove` / `upgrade` commands.

2. **Environment Package Publishing and Pulling**: Based on `environment.json`
  metadata, publish and retrieve environment packages on Vuer Hub through
  `envs-publish` / `envs-pull` commands.

---

## Part I: Project Environment Dependency Management

### Core Concepts

#### Environment Configuration File: `environment.json`

Maintain an `environment.json` file in your project root directory to declare
the list of environments your project depends on, similar to `package.json` in
Node.js.

**Example:**

```json
{
  "dependencies": {
    "some-dependency": "^1.2.3",
    "another-dependency": "~4.5.6",
    "new-dependency": "0.1.0",
    "updated-dependency": "^2.0.0",
    "extra-dependency": "^3.3.3"
  }
}
```

**`dependencies` field:**

- **Key**: Environment name (e.g., `some-dependency`)
- **Value**: Version expression (e.g., `^1.2.3`, `~4.5.6`, etc.)

#### Local Cache Directory: `vuer_environments/`

`vuer sync` downloads all direct and transitive dependencies to the
`vuer_environments/` directory under your project root.

- Each environment uses a nested directory layout under `vuer_environments/`
  following the logical spec `name/version`. On disk this maps to
  `vuer_environments/<name>/<version>` (for example:
  `vuer_environments/my-environment/v4.0.0`).
- If a downloaded environment directory contains its own `environment.json`, it
  will be preserved after download (the CLI keeps per-version metadata files).

#### Dependency Index File: `environments-lock.yaml`

A system-maintained file generated by `vuer sync`. **Do not edit manually.**

This file records all resolved and deduplicated environment dependencies
currently in the repository (it sits next to `vuer_environments/`), ensuring
local cache consistency with `environment.json`.

Format example (YAML):

```yaml
# This file is generated by `vuer sync`.
# DO NOT EDIT THIS FILE MANUALLY.
# This file is maintained by the system.
# It lists the resolved (deduplicated) environment dependencies.

environments:
  - "some-dependency/^1.2.3"
  - "another-dependency/~4.5.6"
  - "new-dependency/0.1.0"
  - "updated-dependency/^2.0.0"
  - "extra-dependency/^3.3.3"
  - "numpy/^1.24.0"
  - "pandas/~2.0.0"
  - "scikit-learn/>=1.3.0"
  - "lodash/^4.17.21"
```

### Environment Variables

When running in non-dry-run mode (making actual backend API calls), you must
configure the following environment variables:

#### `VUER_AUTH_TOKEN` (Required)

**Description**: JWT authentication token for accessing Vuer Hub API.

If not configured, `sync` / `add` / `remove` / `upgrade` commands will throw an
exception and terminate.

#### `VUER_HUB_URL` (Required)

**Description**: Base URL of the Vuer Hub API.

#### Dry-Run Mode (Recommended for local development and CI)

**Environment Variable**: `VUER_CLI_DRY_RUN`

- **Not set or set to `"0"` / `"false"` / `"False"`**: Dry-run disabled, actual
  backend calls are made
- **Any other value**: Dry-run enabled, no real backend calls, only simulated
  behavior is printed

### Command Overview

| Command                               | Description                                                                                               |
|---------------------------------------|-----------------------------------------------------------------------------------------------------------|
| `vuer sync`                           | Parse `environment.json`, validate dependencies, and download all environments (similar to `npm install`) |
| `vuer add some-environment/v1.2.3`    | Add a dependency to `environment.json` and run `sync`                                                     |
| `vuer remove some-environment/v1.2.3` | Remove a dependency from `environment.json` and run `sync`                                                |
| `vuer upgrade some-environment-name`  | Upgrade the specified environment to the latest version from backend and run `sync`                       |
| `vuer envs-publish`                   | Package a local environment directory and publish it to Vuer Hub                                          |
| `vuer envs-pull`                      | Pull (download) a specified environment from Vuer Hub to local directory                                  |
| `vuer --help`                         | Show detailed usage for root command and list subcommands and environment variables                       |

Use `vuer <command> --help` for detailed options.

---

### `sync` Command

#### Usage

```bash
vuer sync

# Or specify output directory (optional)
vuer sync --output ./vuer_environments
```

#### Behavior (Similar to `npm install`)

**1. Find `environment.json`**

Searches for `environment.json` in the current working directory.

If not found:

- Throws an exception: `environment.json not found in <current-directory>`

**2. Parse Dependency List**

Reads the `dependencies` field from `environment.json` and converts it to a
list:

**Original structure (example):**

```json
{
  "dependencies": {
    "some-dependency": "^1.2.3",
    "another-dependency": "~4.5.6",
    "new-dependency": "0.1.0",
    "updated-dependency": "^2.0.0",
    "extra-dependency": "^3.3.3"
  }
}
```

**Converted result:**

```
[
  "some-dependency/^1.2.3",
  "another-dependency/~4.5.6",
  "new-dependency/0.1.0",
  "updated-dependency/^2.0.0",
  "extra-dependency/^3.3.3"
]
```

If `dependencies` is not an object or has an invalid structure, an exception is
thrown and execution terminates.

**3. Behavior When Dependencies Are Empty**

If `dependencies` is an empty object or has no entries:

- No backend calls are made
- Prints to terminal: `No environments to sync`
- Returns success status code
- Still performs reconciliation: removes old dependencies from
  `vuer_environments/` and updates `environments-lock.yaml`

**4. Validate Dependencies via Backend API**

The CLI parses the structure and calls the backend API
`/environments/dependencies` (POST) to validate all dependencies.

If the backend returns a non-200 status code or an error in the response body (
e.g.,
`{"error": "The following environments do not exist: env1/1.0.0, dep2/^2.0.0"}`),
the CLI prints the error message and throws an exception to terminate.

**5. Dependency Expansion**

The CLI merges:

- All direct dependencies
- All transitive dependencies expanded from each direct dependency

Into a unified list, for example:

```
[
  "some-dependency/^1.2.3",
  "another-dependency/~4.5.6",
  "new-dependency/0.1.0",
  "updated-dependency/^2.0.0",
  "extra-dependency/^3.3.3",
  "numpy/^1.24.0",
  "pandas/~2.0.0",
  "scikit-learn/>=1.3.0",
  "lodash/^4.17.21"
]
```

**6. Deduplication and Ordering**

Deduplicates the above list using a "preserve first occurrence order" strategy:

- If a dependency appears multiple times in different dependency chains, only
  the first occurrence is kept
- The deduplicated result is written to `environments-lock.yaml` (next to
  `vuer_environments/`) as the single source of truth for current resolved
  dependencies

**7. Download Environments to `vuer_environments/` Directory**

For each deduplicated dependency item `name/version`:

- If `vuer_environments/<name>/<version>` already exists and is listed in the
  existing `environments-lock.yaml`, it is considered already installed and
  download is skipped
- Otherwise, downloads via internal subcommand equivalent to:
```bash
vuer envs-pull --flag <name/version> --output vuer_environments
```
- If a downloaded environment directory contains its own `environment.json`, it will be recursively scanned and deleted to avoid polluting the current project's configuration

**8. Maintain Consistency with Local Cache**

`sync` reads the current `environments-lock.yaml`:
 - Deletes version directories that exist in the old list but are no longer in the new resolution result
 - Synchronously writes back the latest lockfile

This way, when you manually edit `environment.json` (add/remove dependencies) and run `vuer sync` again, the `vuer_environments/` directory and `environments-lock.yaml` will automatically stay consistent.

---

### `add` Command

#### Usage

```bash
vuer add some-environment/v1.2.3
```

#### Behavior

**1. Parameter Format Validation**

Requires the parameter to be in `name/version` format, e.g.,
`some-environment/v1.2.3`.

Uses `/` to separate name and version:

- If name or version is empty, or `/` is missing, the CLI will raise:
  `Invalid environment spec 'xxx'. Expected format: name/version`

**2. Check if Already in `environments-lock.yaml`**

If `environments-lock.yaml` exists:

- If it already contains an identical entry (e.g.,
  `"some-environment/v1.2.3"`), the dependency is already satisfied:
    - Prints a message like:
      `[INFO] Environment some-environment/v1.2.3 already present in environments-lock.yaml`
    - Command returns success directly, does not modify `environment.json`,
      does not trigger `sync`

**3. Update `environment.json`**

If `environment.json` does not exist:

- Creates a new file (with an empty `dependencies` object)

If it exists:

- Parses JSON, validates that `dependencies` field is an object type, otherwise
  throws an exception
- Splits `some-environment/v1.2.3` into:
    - **Name**: `some-environment`
    - **Version**: `v1.2.3`
- Writes (overwrites or adds) to `dependencies`:
  ```json
  {
    "dependencies": {
      "some-environment": "v1.2.3",
      "...": "..."
    }
  }
  ```

**4. Trigger `vuer sync`**

After successfully updating `environment.json`, `add` automatically calls the
equivalent of:
```bash
vuer sync
```

To ensure `vuer_environments/` directory and `environments-lock.yaml` stay
consistent with the new dependency list.

---

### `remove` Command

#### Usage

```bash
vuer remove some-environment/v1.2.3
```

#### Behavior

**1. Parameter Format Validation**

Same as `add`, requires strict `name/version` format, otherwise throws an
exception.

**2. Check `environments-lock.yaml`**

If the `vuer_environments/` directory does not exist, or
`environments-lock.yaml` does not exist:

- Throws an exception, prompts that dependency index file is not found. For
example:
  `vuer_environments directory or environments-lock.yaml not found. Please run 'vuer sync' first...`

If `environments-lock.yaml` exists but does not contain
`"some-environment/v1.2.3"`:

- Indicates the environment is not currently in the synced list:
- Prints a message like:
  `[INFO] Environment some-environment/v1.2.3 is not present in environments-lock.yaml`
- Command returns success

**3. Remove Dependency from `environment.json`**

If `environment.json` does not exist:

- Throws an exception prompting missing configuration file:
  `environment.json not found. Cannot remove dependency.`

If it exists, parses JSON:

- Ensures `dependencies` is an object, otherwise throws an exception
- Checks if an entry with name `some-environment` exists in `dependencies`:
    - **If exists**: Removes the key-value pair, writes back to
      `environment.json`, and prints something like:
      `[INFO] Removed some-environment/v1.2.3 from environment.json dependencies.`
    - **If not exists**: Outputs a message (but does not error):
      `Dependency some-environment/v1.2.3 not found in environment.json. Skipping removal.`

**4. Trigger `vuer sync`**

Regardless of whether `environment.json` actually had a deletion operation, as
long as the previous checks pass, `remove` will eventually call:
```bash
vuer sync
```

To clean up environment directories in `vuer_environments/` that are no longer
needed and update `environments-lock.yaml`.

---

### `upgrade` Command

#### Usage

```bash
vuer upgrade some-environment-name
```

Only pass the environment name, without version number.

#### Behavior

**1. Find Environment in `environment.json`**

Reads `environment.json` in the current directory and parses `dependencies`.

Searches for an entry with key name `some-environment-name` in `dependencies`:

- If not found, throws an exception prompting nothing to upgrade:
  `Environment 'some-environment-name' not found in environment.json; nothing to upgrade.`

**2. Call Backend to Get Latest Version**

Calls the backend API `/environments/latest-by-name` with query parameter
`name=some-environment-name`.

**Error response:**

```json
{
  "error": "name is required"
}
```

The CLI reads the `"error"` field and throws an exception with the message.

**Success response example:**

```json
{
  "data": {
    "name": "my-environment",
    "versionId": "3.0.10",
    "name_versionId_unique": "my-environment/3.0.10",
    "createdAt": "2025-01-20T08:30:00.000Z"
  }
}
```

The CLI reads:

- `data.name` (can be used for validation or display)
- `data.versionId`: Latest version number, e.g., `"3.0.10"`

**3. Version Comparison and Update**

Assume current `environment.json` content is:

```json
{
  "dependencies": {
    "some-environment-name": "3.0.2"
  }
}
```

Backend returns `versionId` as `3.0.10`:

- **If identical to current version** (e.g., both are `"3.0.10"`):
    - Outputs message:
      `Environment 'some-environment-name' is already at latest version (3.0.10).`
    - Command returns success, does not call `sync`

- **If different**:
    - Updates the corresponding dependency version in `environment.json` to the
      latest version:
      ```json
      {
        "dependencies": {
          "some-environment-name": "3.0.10"
        }
      }
      ```
    - Outputs a message like:
      `Upgraded some-environment-name from 3.0.2 to 3.0.10 in environment.json. Running sync...`

**4. Trigger `vuer sync`**

When the version is updated, `upgrade` automatically calls:

```bash
vuer sync
```

To ensure:

- The new version environment is downloaded and written to `vuer_environments/`
- Old versions (if no longer referenced by any dependency) are cleaned up from
  `vuer_environments/`
- `environments-lock.yaml` is updated to the dependency list resolved based on
  the latest version

---

## Part II: Environment Package Publishing and Pulling

### `envs-publish` Command

#### Usage

```bash
# Publish directly in current directory (containing environment.json)
vuer envs-publish

# Or specify a directory containing environment.json
vuer envs-publish --directory ./my-environment
```

#### Behavior

**1. Read Metadata**

Searches for `environment.json` in the specified directory (default is current
directory).

Parses the following fields as publishing metadata:

- `name`: Environment name (required)
- `version`: Environment version (required, corresponds to Hub's `versionId`)
- `description`: Environment description (optional)
- `visibility`: Visibility (optional, default `PUBLIC`)
- `env-type` / `env_type`: Environment type, such as `isaac`, `mujoco`, etc. (
  optional)

Throws an exception if `name` or `version` is missing.

**Example `environment.json`:**

```json
{
  "name": "my-environment-1",
  "version": "v3.0.2",
  "description": "Demo robotic arm env",
  "visibility": "PUBLIC",
  "env-type": "isaac",
  "dependencies": {
    "some-library": "v1.2.3"
  }
}
```

**2. Validate Dependencies (if present)**

If `environment.json` contains a `dependencies` block with content:

- Extracts these dependencies into a list (e.g., `["some-library/v1.2.3"]`)
- Calls the backend API `/environments/dependencies` (POST request) to validate
  these dependencies
- If the backend returns a non-200 status code or an error in the response
  body (e.g.,
  `{"error": "The following environments do not exist: env1/1.0.0, dep2/^2.0.0"}`),
  prints the error message in red and terminates
- If status code is 200 and no error is returned, continues with publish logic
- If `environment.json` has no `dependencies` block or it's empty, skips this
  validation

**3. Package Directory**

Packages all files in the directory (including `environment.json` itself) into
a `.tgz` archive file, with filename:

```
"{name}-{version}.tgz"
```

The archive is written to the system temporary directory (e.g., `/tmp`) and the
archive path is printed in the log.

**4. Dry-Run and Real Publishing**

If in dry-run mode (`VUER_CLI_DRY_RUN` is not `"0"`), or explicitly passed
`--dry-run`:

- Does not call real network interface
- Simulates upload process, prints archive size and upload progress prompts
- Finally prints success message (marked as `(dry-run)`)

In real publishing mode (non-dry-run):

- Checks if `VUER_HUB_URL` and `VUER_AUTH_TOKEN` are configured, otherwise
  throws an exception
- Calls backend to publish
- After success, prints to terminal:
    - Environment ID (if available)
    - Name, version, visibility, and other information
- If backend returns `error` or non-2xx status code, CLI parses and prints
  detailed error information

---

### `envs-pull` Command

#### Usage

```bash
# Pull by environment ID
vuer envs-pull --flag 252454509945688064

# Pull by name/version
vuer envs-pull --flag my-environment/v3.0.10

# Specify output directory and custom archive name
vuer envs-pull --flag my-environment/v3.0.10 --output ./downloads
```

#### Behavior

**Parameter Description**

- `--flag` (required): Environment identifier, can be:
    - Environment ID (e.g., `252454509945688064`)
    - `name/version` format (e.g., `my-environment/v3.0.10`)
- `--output`: Download target directory, default `./downloads`
- `--timeout`: Request timeout, default 300 seconds
- `--skip-progress`: Skip progress bar display

**Dry-Run and Real Download**

If in dry-run mode:

- Does not call real network interface
- Creates a subdirectory with the same name as `env_flag` in the target output
  directory, and writes a simple `README.txt` to simulate download results
- Terminal prints `(dry-run)` success message

In real download mode:

- Checks if `VUER_HUB_URL` and `VUER_AUTH_TOKEN` are configured, otherwise
  throws an exception
- Writes the returned data stream to an archive file (default is
  `<env_flag>.tgz`, or can parse filename from `Content-Disposition` header)

**Extraction and Directory Structure**

After download completes:

- If the archive is a tar series (`.tar` / `.tgz` / `.tar.gz`), CLI
  automatically extracts it into the nested layout
  `output_dir/<name>/<version>/` when the `--flag` was provided in
  `name/version` form.
- After successful extraction, deletes the original archive
- Terminal prints success path (e.g., `Downloaded and extracted to <dir>`)

---

## Part III: Summary and Recommended Workflow

### Initialize Project Dependencies

```bash
# Edit environment.json, fill in initial dependencies
vuer sync
```

### Add New Environment

```bash
vuer add my-environment/1.0.0
# Automatically writes to environment.json and executes sync
```

### Remove Unneeded Environment

```bash
vuer remove my-environment/1.0.0
# Automatically updates environment.json and executes sync, cleans up corresponding directory in vuer_environments/
```

### Upgrade Specified Environment to Latest Version

```bash
vuer upgrade my-environment
# Automatically queries latest versionId, updates environment.json, and executes sync
```

Through these four commands, Vuer CLI provides an npm-like dependency
management experience, using `environment.json` declaratively to manage
environments, and `vuer_environments/` + `environments-lock.yaml` as a local
cache and mirror of the actual resolution results.

---

## Environment Variables Reference

| Variable           | Required | Description                                                |
|--------------------|----------|------------------------------------------------------------|
| `VUER_AUTH_TOKEN`  | Yes      | JWT token for authenticated requests                       |
| `VUER_HUB_URL`     | Yes      | Base URL of Vuer Hub API                                   |
| `VUER_CLI_DRY_RUN` | No       | Enable dry-run mode (any non-"0"/"false" value enables it) |

---

## GitHub Repository

Source code: [github.com/vuer-ai/vuer-cli](https://github.com/vuer-ai/vuer-cli)


