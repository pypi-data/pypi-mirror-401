<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pipeline Story: {{ metadata.pipeline_name }}</title>
    <!-- Graphviz via @hpcc-js/wasm for DAG visualization -->
    <script src="https://unpkg.com/@hpcc-js/wasm@2.13.0/dist/graphviz.umd.js"></script>
    <style>
        :root {
            --primary-color: #0066cc;
            --bg-color: #f4f7f9;
            --card-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --success-color: #28a745;
            --error-color: #dc3545;
            --warning-color: #ffc107;
            --skipped-color: #6c757d;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --mono-font: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            --code-bg: #2d2d2d;
            --code-text: #f8f8f2;
        }

        /* Collapsible sections */
        .collapsible-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 12px 16px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 8px 8px 0 0;
            border: 1px solid var(--border-color);
            border-bottom: none;
            user-select: none;
            transition: background 0.2s;
        }
        .collapsible-header:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
        }
        .collapsible-header h3 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1em;
        }
        .collapsible-header .toggle-icon {
            font-size: 1.2em;
            color: #666;
            transition: transform 0.3s;
        }
        .collapsible-header.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }
        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.collapsed {
            max-height: 0 !important;
            border: none !important;
        }

        /* Custom tooltip for DAG nodes */
        .dag-tooltip {
            position: fixed;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            max-width: 350px;
            font-size: 13px;
            pointer-events: none;
            display: none;
        }
        .dag-tooltip.visible {
            display: block;
        }
        .dag-tooltip h4 {
            margin: 0 0 8px 0;
            color: var(--primary-color);
            font-size: 14px;
            border-bottom: 1px solid #eee;
            padding-bottom: 6px;
        }
        .dag-tooltip .tooltip-row {
            display: flex;
            margin: 4px 0;
        }
        .dag-tooltip .tooltip-label {
            font-weight: 500;
            color: #666;
            min-width: 80px;
        }
        .dag-tooltip .tooltip-value {
            color: #333;
        }
        .dag-tooltip .deps-list {
            margin: 4px 0 0 0;
            padding-left: 20px;
        }
        .dag-tooltip .deps-list li {
            margin: 2px 0;
            color: #555;
        }
        .dag-tooltip .external-badge {
            display: inline-block;
            background: #e7f5ff;
            color: #1c7ed6;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 8px;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        .header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-left: 5px solid var(--primary-color);
        }

        .header h1 { margin: 0 0 10px 0; color: var(--primary-color); }
        .meta-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 0.9em; }
        .meta-item label { display: block; color: #666; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; }

        /* Summary Stats */
        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            flex: 1;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }
        .stat-success { color: var(--success-color); }
        .stat-error { color: var(--error-color); }

        /* Node Card */
        .node-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .node-header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #fff;
            transition: background 0.2s;
        }
        .node-header:hover { background: #f8f9fa; }

        .node-title { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 1.1em; }
        .node-metrics { display: flex; gap: 20px; color: #666; font-size: 0.9em; }

        .status-icon { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 50%; color: white; font-size: 14px; }
        .status-success { background-color: var(--success-color); }
        .status-failed { background-color: var(--error-color); }
        .status-skipped { background-color: var(--skipped-color); }

        /* Node Body (Collapsible) */
        .node-body {
            display: none;
            border-top: 1px solid var(--border-color);
        }
        .node-body.open { display: block; }

        /* Tabs */
        .tabs { display: flex; background: #f8f9fa; border-bottom: 1px solid var(--border-color); }
        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
        }
        .tab-btn:hover { color: var(--primary-color); }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); background: #fff; }

        .tab-content { padding: 20px; display: none; }
        .tab-content.active { display: block; }

        /* Data Tables */
        table { width: 100%; border-collapse: collapse; font-size: 0.9em; margin-bottom: 15px; }
        th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: #f8f9fa; font-weight: 600; }
        .diff-added { color: var(--success-color); background: #e6fffa; }
        .diff-removed { color: var(--error-color); background: #fff5f5; }

        /* Code Blocks */
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-family: var(--mono-font);
            font-size: 0.9em;
            margin: 0;
        }

        /* Badges */
        .badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            text-transform: uppercase;
        }
        .badge-blue { background: #e7f5ff; color: #1971c2; }
        .badge-green { background: #e6fffa; color: #0ca678; }
        .badge-red { background: #fff5f5; color: #e03131; }
        .badge-orange { background: #fff9db; color: #f08c00; }
        .badge-gray { background: #f1f3f5; color: #868e96; }
        .badge-purple { background: #f3e8ff; color: #7c3aed; }

        /* Anomaly Badge */
        .anomaly-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }
        .anomaly-badge.slow { background: #fee2e2; color: #991b1b; border-color: #f87171; }
        .anomaly-badge.rows { background: #dbeafe; color: #1e40af; border-color: #60a5fa; }

        /* Flash highlight animation for scrolled-to nodes */
        @keyframes flash-highlight {
            0% { box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.6); }
            50% { box-shadow: 0 0 0 8px rgba(0, 102, 204, 0.3); }
            100% { box-shadow: 0 0 0 0 rgba(0, 102, 204, 0); }
        }
        .node-card.flash {
            animation: flash-highlight 1.5s ease-out;
        }

        /* Keyboard navigation focus indicator */
        .node-card.keyboard-focus {
            outline: 3px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Print-friendly styles */
        @media print {
            body { background: white; padding: 10px; }
            .node-card { break-inside: avoid; page-break-inside: avoid; }
            .node-body { display: block !important; max-height: none !important; }
            .node-body.open { max-height: none !important; }
            #pipeline-graph-card { display: none; }
            .filter-bar, .stats-bar button, #dark-mode-btn, #view-mode-btn { display: none !important; }
            .header { border-left: 5px solid #333; }
            pre { white-space: pre-wrap; word-wrap: break-word; }
            .copy-btn { display: none !important; }
        }

        /* Execution Timeline styles - horizontal bar chart */
        .timeline-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .timeline-row {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
            height: 24px;
        }
        .timeline-label {
            width: 180px;
            min-width: 180px;
            font-size: 11px;
            text-align: right;
            padding-right: 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: var(--text-color);
        }
        .timeline-bar-container {
            flex: 1;
            height: 20px;
            background: var(--bg-color);
            border-radius: 3px;
            overflow: hidden;
        }
        .timeline-bar {
            height: 100%;
            border-radius: 3px;
            display: flex;
            align-items: center;
            padding-left: 6px;
            font-size: 10px;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 30px;
        }
        .timeline-bar:hover { opacity: 0.8; }
        .timeline-bar.success { background: var(--success-color); }
        .timeline-bar.failed { background: var(--error-color); }
        .timeline-bar.skipped { background: var(--skipped-color); }
        .timeline-bar.unknown { background: var(--skipped-color); }

        /* Run Health Header */
        .health-header {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            border-left: 5px solid var(--error-color);
        }
        .health-header.success { border-left-color: var(--success-color); }
        .health-header h2 { margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; }
        .health-header .failed-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .health-header .failed-chip {
            background: #fff5f5;
            border: 1px solid #ffa8a8;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.9em;
            color: var(--error-color);
            cursor: pointer;
            transition: background 0.2s;
        }
        .health-header .failed-chip:hover { background: #ffe3e3; }
        .health-header .first-error {
            background: #fff5f5;
            border: 1px solid #ffa8a8;
            border-radius: 6px;
            padding: 15px;
            font-family: var(--mono-font);
            font-size: 0.9em;
            color: #c92a2a;
            margin-top: 10px;
        }
        .health-header .first-error .error-type { font-weight: 600; margin-bottom: 5px; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 10px 15px;
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            align-items: center;
        }
        .filter-bar label { font-weight: 600; color: #666; font-size: 0.9em; }
        .filter-btn {
            padding: 6px 16px;
            border: 1px solid var(--border-color);
            background: #fff;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .filter-btn:hover { background: #f8f9fa; }
        .filter-btn.active { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .filter-btn .count { opacity: 0.7; font-size: 0.85em; margin-left: 4px; }

        /* Copy Button */
        .copy-btn {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            color: #666;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .copy-btn:hover { background: #e9ecef; color: #333; }
        .copy-btn.copied { background: var(--success-color); color: #fff; border-color: var(--success-color); }

        /* Schema Diff */
        .schema-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .schema-box { background: #f8f9fa; padding: 15px; border-radius: 6px; }
        .schema-list { list-style: none; padding: 0; margin: 0; }
        .schema-list li { padding: 4px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .col-added { color: var(--success-color); font-weight: bold; }
        .col-removed { color: var(--error-color); text-decoration: line-through; }

        /* Config Diff Viewer */
        .config-diff-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .config-diff-pane { background: var(--code-bg); border-radius: 6px; overflow: hidden; }
        .config-diff-header { padding: 8px 12px; font-weight: 600; font-size: 0.85em; border-bottom: 1px solid var(--border-color); }
        .config-diff-header.previous { background: #fff5f5; color: #c92a2a; }
        .config-diff-header.current { background: #e6fffa; color: #0ca678; }
        [data-theme="dark"] .config-diff-header.previous { background: #3b1a1a; color: #f87171; }
        [data-theme="dark"] .config-diff-header.current { background: #1a2f2a; color: #4ade80; }
        .config-diff-content { padding: 12px; font-family: var(--mono-font); font-size: 0.85em; overflow-x: auto; white-space: pre-wrap; word-break: break-word; }
        .diff-line-added { background: rgba(40, 167, 69, 0.15); color: var(--success-color); }
        .diff-line-removed { background: rgba(220, 53, 69, 0.15); color: var(--error-color); }
        .diff-line-changed { background: rgba(255, 193, 7, 0.15); }

        /* Duration Sparkline */
        .sparkline-container { display: inline-flex; align-items: center; gap: 4px; vertical-align: middle; }
        .sparkline { display: inline-block; }
        .sparkline-tooltip { font-size: 0.75em; color: #666; }

    </style>
</head>
<body>

<!-- Custom tooltip for DAG nodes -->
<div class="dag-tooltip" id="dag-tooltip"></div>

<div class="container">
    <!-- Nigerian accent bar -->
    <div style="height: 4px; background: linear-gradient(to right, #008751 33%, #fff 33%, #fff 66%, #008751 66%); margin-bottom: 15px; border-radius: 2px;"></div>

    <!-- Header -->
    <div class="header">
        <p style="color: #008751; font-size: 0.85em; margin: 0 0 5px 0; font-weight: 500;">Ndewo ‚Äî Welcome to your data story</p>
        <h1>{{ metadata.pipeline_name }}</h1>
        <div class="meta-grid">
            <div class="meta-item">
                <label>Run ID</label>
                <span>{{ metadata.run_id }}</span>
            </div>
            <div class="meta-item">
                <label>Started</label>
                <span class="timestamp" data-utc="{{ metadata.started_at }}">{{ metadata.started_at }}</span>
            </div>
            <div class="meta-item">
                <label>Duration</label>
                <span>{{ "%.2f"|format(metadata.duration) }}s</span>
            </div>
            <div class="meta-item">
                <label>Context</label>
                <span>
                    {% if metadata.project %}{{ metadata.project }}{% endif %}
                    {% if metadata.plant %} / {{ metadata.plant }}{% endif %}
                </span>
            </div>
            {% if metadata.git_info and metadata.git_info.commit != 'unknown' %}
            <div class="meta-item">
                <label>Git</label>
                <span style="font-family: var(--mono-font); font-size: 0.9em;">
                    {{ metadata.git_info.branch }} @ {{ metadata.git_info.commit }}
                </span>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Toolbar (Phase 4 - Polish & UX) -->
    <div class="filter-bar" style="justify-content: space-between;">
        <div style="display: flex; gap: 15px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <label style="font-weight: 500;">View:</label>
                <select id="view-mode" onchange="setViewMode(this.value)" 
                        style="padding: 6px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 0.9em; background: var(--card-bg); color: var(--text-color);">
                    <option value="developer">üë®‚Äçüíª Developer</option>
                    <option value="stakeholder">üìä Stakeholder</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="copy-btn" onclick="alert('Keyboard Shortcuts:\n\nF - Jump to first failed node\nN - Next node\nP - Previous node\nEnter - Toggle current node\nEsc - Collapse all nodes\n\nCtrl+P - Print/PDF')" title="Keyboard shortcuts">‚å®Ô∏è Shortcuts</button>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-value">{{ metadata.total_nodes }}</div>
            <div class="stat-label">Nodes</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-success">{{ metadata.completed_nodes }}</div>
            <div class="stat-label">Completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value stat-error">{{ metadata.failed_nodes }}</div>
            <div class="stat-label">Failed</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "{:,}".format(metadata.get_total_rows_processed()) }}</div>
            <div class="stat-label">Total Rows</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ "%.1f"|format(metadata.get_success_rate()) }}%</div>
            <div class="stat-label">Success Rate</div>
        </div>
    </div>

    <!-- Run Health Header (Phase 1 - Triage) -->
    {% set health = metadata.get_run_health_summary() %}
    {% if health.has_failures %}
    <div class="health-header">
        <h2>
            <span style="font-size: 1.2em;">‚ö†Ô∏è</span>
            Run Failed - {{ health.failed_count }} node{% if health.failed_count > 1 %}s{% endif %} failed
        </h2>
        <div class="failed-list">
            {% for node_name in health.failed_nodes %}
            <span class="failed-chip" onclick="scrollToNode('{{ node_name }}')">{{ node_name }}</span>
            {% endfor %}
        </div>
        {% if health.first_failure_error %}
        <div class="first-error">
            <div class="error-type">{{ health.first_failure_type }}: {{ health.first_failure_node }}</div>
            <div>{{ health.first_failure_error }}</div>
        </div>
        {% endif %}
    </div>
    {% elif health.anomaly_count > 0 %}
    <div class="health-header" style="border-left-color: var(--warning-color);">
        <h2>
            <span style="font-size: 1.2em;">‚ö°</span>
            Run Succeeded with {{ health.anomaly_count }} Anomal{% if health.anomaly_count > 1 %}ies{% else %}y{% endif %}
        </h2>
        <div class="failed-list">
            {% for node_name in health.anomalous_nodes %}
            <span class="failed-chip" style="background: #fff9db; border-color: #ffe066; color: #e0a800;" onclick="scrollToNode('{{ node_name }}')">{{ node_name }}</span>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="health-header success">
        <h2>
            <span style="font-size: 1.2em;">‚úÖ</span>
            Run Completed Successfully
        </h2>
    </div>
    {% endif %}

    <!-- Changes Summary Card (Phase 3 - Cross-Run Context) -->
    {% if metadata.change_summary and metadata.change_summary.has_changes %}
    <div class="node-card" style="padding: 20px; border-left: 4px solid #7c3aed;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #7c3aed;">üìä Changes vs Last Success</h3>
            <span style="font-size: 0.85em; color: #666;">Compared to previous run ({{ metadata.compared_to_run_id | format_run_id }})</span>
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 15px;">
            {% if metadata.change_summary.newly_failing_count > 0 %}
            <div style="background: #fff5f5; border: 1px solid #ffa8a8; padding: 12px 16px; border-radius: 8px; min-width: 150px;">
                <div style="font-size: 1.5em; font-weight: bold; color: var(--error-color);">{{ metadata.change_summary.newly_failing_count }}</div>
                <div style="font-size: 0.85em; color: #666;">Newly Failing</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">{{ metadata.change_summary.newly_failing_nodes | join(', ') }}</div>
            </div>
            {% endif %}
            {% if metadata.change_summary.sql_changed_count > 0 %}
            <div style="background: #f3e8ff; border: 1px solid #c4b5fd; padding: 12px 16px; border-radius: 8px; min-width: 150px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #7c3aed;">{{ metadata.change_summary.sql_changed_count }}</div>
                <div style="font-size: 0.85em; color: #666;">SQL Changed</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">{{ metadata.change_summary.sql_changed_nodes | join(', ') }}</div>
            </div>
            {% endif %}
            {% if metadata.change_summary.schema_changed_count > 0 %}
            <div style="background: #dbeafe; border: 1px solid #93c5fd; padding: 12px 16px; border-radius: 8px; min-width: 150px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #1e40af;">{{ metadata.change_summary.schema_changed_count }}</div>
                <div style="font-size: 0.85em; color: #666;">Schema Changed</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">{{ metadata.change_summary.schema_changed_nodes | join(', ') }}</div>
            </div>
            {% endif %}
            {% if metadata.change_summary.rows_changed_count > 0 %}
            <div style="background: #fef3c7; border: 1px solid #fcd34d; padding: 12px 16px; border-radius: 8px; min-width: 150px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #92400e;">{{ metadata.change_summary.rows_changed_count }}</div>
                <div style="font-size: 0.85em; color: #666;">Row Count Changed</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">{{ metadata.change_summary.rows_changed_nodes | join(', ') }}</div>
            </div>
            {% endif %}
        </div>
    </div>
    {% elif metadata.compared_to_run_id %}
    <div class="node-card" style="padding: 15px; border-left: 4px solid var(--success-color);">
        <span style="color: var(--success-color); font-weight: 600;">‚úì No significant changes</span>
        <span style="color: #666; font-size: 0.9em; margin-left: 10px;">vs previous run ({{ metadata.compared_to_run_id | format_run_id }})</span>
    </div>
    {% endif %}

    <!-- Data Quality Summary Card (Phase 5 - Quality & Documentation) -->
    {% set quality = metadata.get_data_quality_summary() %}
    {% set freshness = metadata.get_freshness_info() %}
    {% if quality.has_quality_issues or quality.top_null_columns %}
    <div class="node-card" style="padding: 20px; border-left: 4px solid #f59e0b;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h3 style="margin: 0; color: #f59e0b;">üîç Data Quality Summary</h3>
            {% if freshness %}
            <span style="font-size: 0.85em; color: #666;">
                üìÖ Data as of: <strong>{{ freshness.formatted }}</strong>
                <span style="color: #999;">({{ freshness.column }} in {{ freshness.node }})</span>
            </span>
            {% endif %}
        </div>
        <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 15px;">
            {% if quality.total_validations_failed > 0 %}
            <div style="background: #fff5f5; border: 1px solid #ffa8a8; padding: 12px 16px; border-radius: 8px; min-width: 120px;">
                <div style="font-size: 1.5em; font-weight: bold; color: var(--error-color);">{{ quality.total_validations_failed }}</div>
                <div style="font-size: 0.85em; color: #666;">Validations Failed</div>
            </div>
            {% endif %}
            {% if quality.total_failed_rows > 0 %}
            <div style="background: #fff5f5; border: 1px solid #ffa8a8; padding: 12px 16px; border-radius: 8px; min-width: 120px;">
                <div style="font-size: 1.5em; font-weight: bold; color: var(--error-color);">{{ "{:,}".format(quality.total_failed_rows) }}</div>
                <div style="font-size: 0.85em; color: #666;">Total Failed Rows</div>
            </div>
            {% endif %}
            {% if quality.nodes_with_warnings %}
            <div style="background: #fff9db; border: 1px solid #ffe066; padding: 12px 16px; border-radius: 8px; min-width: 150px;">
                <div style="font-size: 1.5em; font-weight: bold; color: #e0a800;">{{ quality.nodes_with_warnings|length }}</div>
                <div style="font-size: 0.85em; color: #666;">Nodes with Warnings</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">{{ quality.nodes_with_warnings[:3] | join(', ') }}{% if quality.nodes_with_warnings|length > 3 %}...{% endif %}</div>
            </div>
            {% endif %}
        </div>
        {% if quality.top_null_columns %}
        <div style="margin-top: 15px;">
            <h4 style="margin: 0 0 10px 0; font-size: 0.9em; color: #666;">Top Columns by Null %</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                {% for col in quality.top_null_columns[:5] %}
                <span style="background: {% if col.null_pct > 0.9 %}#fff5f5; border-color: #ffa8a8; color: #c92a2a;{% elif col.null_pct > 0.5 %}#fff9db; border-color: #ffe066; color: #e0a800;{% else %}#f8f9fa; border-color: #e1e4e8; color: #666;{% endif %} border: 1px solid; padding: 4px 10px; border-radius: 16px; font-size: 0.85em;">
                    <strong>{{ col.column }}</strong> {{ "%.0f"|format(col.null_pct * 100) }}%
                    <span style="color: #999; font-size: 0.85em;">({{ col.node }})</span>
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% elif freshness %}
    <!-- Show freshness indicator even without quality issues -->
    <div class="node-card" style="padding: 15px; border-left: 4px solid var(--success-color);">
        <span style="color: var(--success-color); font-weight: 600;">‚úì Data Quality: No issues detected</span>
        <span style="color: #666; font-size: 0.9em; margin-left: 15px;">
            üìÖ Data as of: <strong>{{ freshness.formatted }}</strong>
        </span>
    </div>
    {% endif %}

    <!-- Filter Bar (Phase 1 - Triage) -->
    {% set changed_count = metadata.change_summary.sql_changed_count + metadata.change_summary.schema_changed_count if metadata.change_summary else 0 %}
    <div class="filter-bar">
        <label>Show:</label>
        <button class="filter-btn active" onclick="filterNodes('all', this)">All <span class="count">({{ metadata.total_nodes }})</span></button>
        <button class="filter-btn" onclick="filterNodes('failed', this)">Failed <span class="count">({{ metadata.failed_nodes }})</span></button>
        <button class="filter-btn" onclick="filterNodes('anomalous', this)">Anomalous <span class="count">({{ health.anomaly_count }})</span></button>
        {% if changed_count > 0 %}
        <button class="filter-btn" onclick="filterNodes('changed', this)">Changed <span class="count">({{ changed_count }})</span></button>
        {% endif %}
    </div>

    <!-- Execution Timeline (Collapsible - default collapsed) -->
    <div class="timeline-container" id="execution-timeline" style="padding: 0; border: none;">
        <div class="collapsible-header collapsed" onclick="toggleSection('timeline')">
            <h3>Execution Timeline <span style="font-weight: normal; font-size: 0.8em; color: #666;">Total: {{ "%.2f"|format(metadata.duration) }}s</span></h3>
            <span class="toggle-icon">‚ñº</span>
        </div>
        <div class="collapsible-content collapsed" id="timeline-content" style="border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: var(--card-bg);">
            <div id="timeline-chart"></div>
        </div>
    </div>

    <!-- Node List -->
    <div class="node-list">

        <!-- Pipeline Graph (Graphviz) -->
        <!-- Pipeline Flow (Collapsible - default expanded) -->
        {% set node_count = metadata.nodes|length %}
        <div id="pipeline-graph-card" style="margin-bottom: 20px;">
            <div class="collapsible-header" onclick="toggleSection('pipeline')">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <h3>Pipeline Flow <span style="font-weight: normal; font-size: 0.8em; color: #666;">({{ node_count }} nodes)</span></h3>
                    <span style="font-size: 0.8em; color: #666;">Click node for details</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <select id="graph-view-type" onchange="event.stopPropagation(); changeGraphViewType(this.value)" style="padding: 4px 8px; border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.85em; background: var(--card-bg); color: var(--text-color);">
                        <option value="dag" selected>DAG View</option>
                        <option value="list">List View</option>
                    </select>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>
            <div class="collapsible-content" id="pipeline-content" style="border: 1px solid var(--border-color); border-top: none; border-radius: 0 0 8px 8px; padding: 16px; background: var(--card-bg);">
                <!-- Layout fixed to Left‚ÜíRight for optimal readability -->
                <input type="hidden" id="graph-layout" value="LR">
                <div id="graphviz-container" style="min-height: 400px; max-height: 800px; overflow: auto; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--border-color); text-align: center;"></div>
                <div id="pipeline-list-view" style="display: none; max-height: 600px; overflow-y: auto; background: #f8f9fa; border-radius: 8px; border: 1px solid var(--border-color); padding: 16px;"></div>
            </div>
        </div>

        {% for node in metadata.nodes %}
        <div class="node-card" id="node-{{ node.node_name }}" data-status="{{ node.status }}" data-anomaly="{{ 'true' if node.is_anomaly else 'false' }}" data-changed="{{ 'true' if node.changed_from_last_success else 'false' }}">
            <div class="node-header" onclick="toggleNode(this)">
                <div class="node-title">
                    <div class="status-icon status-{{ node.status }}">
                        {% if node.status == 'success' %}‚úì{% elif node.status == 'failed' %}!{% else %}-{% endif %}
                    </div>
                    <div>
                        {{ node.node_name }}
                        {% if node.description %}
                        <div style="font-size: 0.75em; color: #666; font-weight: normal; margin-top: 2px;">{{ node.description }}</div>
                        {% endif %}
                    </div>
                    <span class="badge badge-blue">{{ node.operation }}</span>
                    {% if node.is_anomaly %}
                        {% if node.is_slow %}
                        <span class="anomaly-badge slow" title="{{ node.anomaly_reasons|join(', ') }}">üê¢ Slow</span>
                        {% endif %}
                        {% if node.has_row_anomaly %}
                        <span class="anomaly-badge rows" title="{{ node.anomaly_reasons|join(', ') }}">üìä Row Œî</span>
                        {% endif %}
                    {% endif %}
                    {% if node.changed_from_last_success %}
                    <span class="badge badge-purple" title="Changed: {{ node.changes_detected|join(', ') }}">Œî {{ node.changes_detected|join(', ') }}</span>
                    {% endif %}
                    {% if node.runbook_url and node.status == 'failed' %}
                    <a href="{{ node.runbook_url }}" target="_blank" style="font-size: 0.8em; color: var(--primary-color); text-decoration: none; margin-left: 8px;" onclick="event.stopPropagation();">Troubleshooting guide ‚Üí</a>
                    {% endif %}
                </div>
                <div class="node-metrics">
                    {% if node.rows_in is not none %}
                    <span title="Rows Read">üì• {{ "{:,}".format(node.rows_in) }}</span>
                    {% endif %}
                    {% if node.rows_written is not none %}
                    <span title="Rows Written">üì§ {{ "{:,}".format(node.rows_written) }}{% if node.rows_in is not none and node.rows_written == 0 and node.rows_in > 0 %} (no changes){% endif %}</span>
                    {% elif node.rows_out is not none %}
                    <span>{{ "{:,}".format(node.rows_out) }} rows</span>
                    {% endif %}

                    {% if node.rows_change is not none and node.rows_change != 0 %}
                    <span class="badge {% if node.rows_change > 0 %}badge-green{% else %}badge-red{% endif %}">
                        {% if node.rows_change > 0 %}+{% endif %}{{ "{:,}".format(node.rows_change) }}
                    </span>
                    {% endif %}

                    <span class="sparkline-container">
                        {{ "%.4f"|format(node.duration) }}s
                        {% if node.duration_history and node.duration_history|length > 1 %}
                        <span class="sparkline" id="sparkline-{{ loop.index }}" 
                              data-history="{{ node.duration_history | tojson | e }}"
                              title="Duration trend (last {{ node.duration_history|length }} runs)"></span>
                        {% endif %}
                    </span>
                </div>
            </div>

            <div class="node-body">
                <div class="tabs">
                    <button class="tab-btn active" onclick="openTab(event, 'info-{{ loop.index }}')">Info & Schema</button>
                    {% if node.executed_sql %}
                    <button class="tab-btn" onclick="openTab(event, 'sql-{{ loop.index }}')">SQL Logic</button>
                    {% endif %}
                    {% if node.sample_data or node.sample_in or node.data_diff %}
                    <button class="tab-btn" onclick="openTab(event, 'data-{{ loop.index }}')">Data Preview</button>
                    {% endif %}
                    {% if node.config_snapshot %}
                    <button class="tab-btn" onclick="openTab(event, 'config-{{ loop.index }}')">Config</button>
                    {% endif %}
                </div>

                <!-- Tab: Info -->
                <div id="info-{{ loop.index }}" class="tab-content active">
                    <!-- Quick Actions -->
                    <div style="display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap;">
                        <button class="copy-btn" onclick="copyToClipboard(this, 'odibi run {{ metadata.config_file or 'pipeline.yaml' }} --node {{ node.node_name }}'); event.stopPropagation();" title="Copy CLI command to re-run this node">
                            üîÑ Copy Re-run Command
                        </button>
                        <button class="copy-btn" onclick="copyToClipboard(this, 'spark.sql(\"SELECT * FROM {{ node.node_name }} LIMIT 10\").show()'); event.stopPropagation();" title="Copy Spark debug query">
                            üîç Copy Debug Query
                        </button>
                        <button class="copy-btn" onclick="copyNodeLink(this, '{{ node.node_name }}'); event.stopPropagation();" title="Copy link to this node">
                            üîó Copy Link
                        </button>
                    </div>

                    {% if node.validation_warnings %}
                    <div style="background: #fff9db; color: #e0a800; padding: 15px; border-radius: 4px; border: 1px solid #ffe066; margin-bottom: 20px;">
                        <strong>Validation Warnings:</strong>
                        <ul style="margin: 5px 0 0 20px; padding: 0;">
                            {% for warning in node.validation_warnings %}
                            <li>{{ warning }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}

                    {% if node.error_message %}
                    <div style="background: #fff5f5; color: #c92a2a; padding: 15px; border-radius: 4px; border: 1px solid #ffa8a8; margin-bottom: 20px; position: relative;">
                        <button class="copy-btn" style="position: absolute; top: 10px; right: 10px;" onclick="copyError(this, '{{ node.node_name }}'); event.stopPropagation();">üìã Copy Error</button>
                        <strong>Error: {{ node.error_type }}</strong>
                        <pre style="background: none; color: #c92a2a; padding: 0; margin-top: 10px; padding-right: 80px;" id="error-{{ loop.index }}">{{ node.error_message }}</pre>

                        {% if node.error_traceback_cleaned %}
                        <details style="margin-top: 15px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #c92a2a;">Show Traceback (Cleaned)</summary>
                            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;" id="traceback-cleaned-{{ loop.index }}">{{ node.error_traceback_cleaned }}</pre>
                        </details>
                        {% endif %}

                        {% if node.error_traceback %}
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: 500; color: #999; font-size: 0.9em;">Show Full Traceback (Raw)</summary>
                            <pre style="background: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 4px; margin-top: 10px; overflow-x: auto; font-size: 0.8em; max-height: 400px; overflow-y: auto;" id="traceback-full-{{ loop.index }}">{{ node.error_traceback }}</pre>
                        </details>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% if node.execution_steps %}
                    <div style="margin-bottom: 20px; border: 1px solid #e1e4e8; border-radius: 6px; overflow: hidden;">
                        <details open>
                            <summary style="background: #f8f9fa; padding: 10px 15px; cursor: pointer; font-weight: 600; color: #333;">
                                üîß Execution Steps ({{ node.execution_steps|length }})
                            </summary>
                            <div style="padding: 15px;">
                                <ol style="margin: 0; padding-left: 20px; font-size: 0.9em; color: #555;">
                                    {% for step in node.execution_steps %}
                                    <li style="padding: 4px 0;">{{ step }}</li>
                                    {% endfor %}
                                </ol>
                            </div>
                        </details>
                    </div>
                    {% endif %}

                    {% if node.retry_history and node.retry_history|length > 1 %}
                    <div style="margin-bottom: 20px; border: 1px solid #ffe066; border-radius: 6px; overflow: hidden;">
                        <details open>
                            <summary style="background: #fff9db; padding: 10px 15px; cursor: pointer; font-weight: 600; color: #e0a800;">
                                üîÑ Retry History ({{ node.retry_history|length }} attempts)
                            </summary>
                            <div style="padding: 15px;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e1e4e8;">Attempt</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e1e4e8;">Status</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e1e4e8;">Duration</th>
                                            <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e1e4e8;">Error</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for attempt in node.retry_history %}
                                        <tr>
                                            <td style="padding: 8px; border-bottom: 1px solid #eee;">#{{ attempt.attempt }}</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #eee;">
                                                {% if attempt.success %}
                                                <span class="badge badge-green">‚úì Success</span>
                                                {% else %}
                                                <span class="badge badge-red">‚úó Failed</span>
                                                {% endif %}
                                            </td>
                                            <td style="padding: 8px; border-bottom: 1px solid #eee;">{{ attempt.duration }}s</td>
                                            <td style="padding: 8px; border-bottom: 1px solid #eee; font-family: var(--mono-font); font-size: 0.85em; color: #c92a2a;">
                                                {% if attempt.error %}
                                                <details>
                                                    <summary style="cursor: pointer;">{{ attempt.error|truncate(80) }}</summary>
                                                    <div style="margin-top: 8px; padding: 10px; background: #fff5f5; border-radius: 4px; white-space: pre-wrap; max-height: 300px; overflow-y: auto;">{{ attempt.error_traceback or attempt.error }}</div>
                                                </details>
                                                {% else %}-{% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                    {% endif %}

                    {% if node.failed_rows_samples %}
                    <div style="margin-bottom: 20px; border: 1px solid #ffa8a8; border-radius: 6px; overflow: hidden;">
                        <details>
                            <summary style="background: #fff5f5; padding: 10px 15px; cursor: pointer; font-weight: 600; color: #c92a2a;">
                                ‚ùå Failed Rows Samples ({{ node.failed_rows_samples|length }} validation{% if node.failed_rows_samples|length > 1 %}s{% endif %})
                                {% if node.failed_rows_truncated %}<span style="font-weight: normal; font-size: 0.85em;">(truncated)</span>{% endif %}
                            </summary>
                            <div style="padding: 15px;">
                                {% for validation_name, rows in node.failed_rows_samples.items() %}
                                <div style="margin-bottom: 20px;">
                                    <h5 style="margin: 0 0 10px 0; color: #c92a2a; font-size: 0.95em;">
                                        {{ validation_name }}
                                        {% if node.failed_rows_counts and node.failed_rows_counts[validation_name] %}
                                        <span style="font-weight: normal; color: #999;">({{ node.failed_rows_counts[validation_name] }} total failed)</span>
                                        {% endif %}
                                    </h5>
                                    {% if rows|length > 0 %}
                                    <div style="overflow-x: auto; border: 1px solid #ffa8a8; border-radius: 4px;">
                                        <table style="width: 100%; margin: 0; font-size: 0.85em;">
                                            <thead>
                                                <tr style="background: #fff5f5;">
                                                    {% for key in rows[0].keys() %}<th style="padding: 6px 10px;">{{ key }}</th>{% endfor %}
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for row in rows %}
                                                <tr>
                                                    {% for val in row.values() %}<td style="padding: 6px 10px; border-top: 1px solid #ffa8a8;">{{ val }}</td>{% endfor %}
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    {% else %}
                                    <p style="color: #999; font-style: italic; margin: 0;">No sample data available</p>
                                    {% endif %}
                                </div>
                                {% endfor %}

                                {% if node.truncated_validations %}
                                <div style="padding: 10px; background: #f8f9fa; border-radius: 4px; color: #666; font-size: 0.9em;">
                                    <strong>{{ node.truncated_validations|length }} more validation{% if node.truncated_validations|length > 1 %}s{% endif %} failed</strong> (showing counts only):
                                    <ul style="margin: 5px 0 0 0; padding-left: 20px;">
                                        {% for val_name in node.truncated_validations %}
                                        <li>{{ val_name }}: {{ node.failed_rows_counts.get(val_name, 'N/A') }} failed rows</li>
                                        {% endfor %}
                                    </ul>
                                </div>
                                {% endif %}
                            </div>
                        </details>
                    </div>
                    {% endif %}

                    {% if node.source_files %}
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin: 0 0 10px 0; font-size: 0.95em; color: #666;">Source Files ({{ node.source_files|length }})</h4>
                        <div style="max-height: 100px; overflow-y: auto; background: #f8f9fa; padding: 10px; border: 1px solid #e1e4e8; border-radius: 4px; font-family: var(--mono-font); font-size: 0.8em; color: #555;">
                            {% for file in node.source_files %}
                            <div style="white-space: nowrap;">{{ file }}</div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="schema-grid">
                        <div class="schema-box">
                            <h4>Input Schema ({% if node.schema_in %}{{ node.schema_in|length }}{% else %}0{% endif %})</h4>
                            <ul class="schema-list">
                                {% if node.schema_in %}
                                    {% if node.schema_in is mapping %}
                                        {% for col, dtype in node.schema_in.items() %}
                                        <li class="{% if col in node.columns_removed %}col-removed{% endif %}">
                                            <span style="font-weight: 500;">{{ col }}</span>
                                            <span style="color: #666; font-family: var(--mono-font); font-size: 0.85em;">{{ dtype }}</span>
                                        </li>
                                        {% endfor %}
                                    {% else %}
                                        {% for col in node.schema_in %}
                                        <li class="{% if col in node.columns_removed %}col-removed{% endif %}">{{ col }}</li>
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    <li style="color: #999; font-style: italic;">No input schema</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="schema-box">
                            <h4>Output Schema ({% if node.schema_out %}{{ node.schema_out|length }}{% else %}0{% endif %})</h4>
                            <ul class="schema-list">
                                {% if node.schema_out %}
                                    {% if node.schema_out is mapping %}
                                        {% for col, dtype in node.schema_out.items() %}
                                        <li class="{% if col in node.columns_added %}col-added{% endif %}">
                                            <div>
                                                <span style="font-weight: 500;">{{ col }}</span>
                                                {% if col in node.columns_added %}<span style="font-size: 0.8em;">(NEW)</span>{% endif %}

                                                {% if node.null_profile %}
                                                    {% set null_pct = node.null_profile.get(col, 0.0) or 0.0 %}
                                                    {% if null_pct > 0 %}
                                                        <span class="badge {% if null_pct > 0.9 %}badge-red{% elif null_pct > 0.1 %}badge-orange{% else %}badge-gray{% endif %}" style="font-size: 0.75em; margin-left: 6px;">
                                                            {{ "%.0f"|format(null_pct * 100) }}% Null
                                                        </span>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                            <span style="color: #666; font-family: var(--mono-font); font-size: 0.85em;">{{ dtype }}</span>
                                        </li>
                                        {% endfor %}
                                    {% else %}
                                        {% for col in node.schema_out %}
                                        <li class="{% if col in node.columns_added %}col-added{% endif %}">
                                            {{ col }}
                                            {% if col in node.columns_added %}<span style="font-size: 0.8em;">(NEW)</span>{% endif %}

                                            {% if node.null_profile %}
                                                {% set null_pct = node.null_profile.get(col, 0.0) or 0.0 %}
                                                {% if null_pct > 0 %}
                                                    <span class="badge {% if null_pct > 0.9 %}badge-red{% elif null_pct > 0.1 %}badge-orange{% else %}badge-gray{% endif %}" style="font-size: 0.75em; margin-left: 6px;">
                                                        {{ "%.0f"|format(null_pct * 100) }}% Null
                                                    </span>
                                                {% endif %}
                                            {% endif %}
                                        </li>
                                        {% endfor %}
                                    {% endif %}
                                {% else %}
                                    <li style="color: #999; font-style: italic;">No output schema</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>

                    {% if node.column_statistics %}
                    <div style="margin-top: 20px; border: 1px solid #e1e4e8; border-radius: 6px; overflow: hidden;">
                        <details>
                            <summary style="background: #f8f9fa; padding: 10px 15px; cursor: pointer; font-weight: 600; color: #333;">
                                üìä Column Statistics ({{ node.column_statistics|length }} columns)
                            </summary>
                            <div style="padding: 15px; overflow-x: auto;">
                                <table style="width: 100%; margin: 0; font-size: 0.85em;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 6px 10px;">Column</th>
                                            <th style="padding: 6px 10px; text-align: right;">Min</th>
                                            <th style="padding: 6px 10px; text-align: right;">Max</th>
                                            <th style="padding: 6px 10px; text-align: right;">Mean</th>
                                            <th style="padding: 6px 10px; text-align: right;">Std Dev</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for col_name, stats in node.column_statistics.items() %}
                                        <tr>
                                            <td style="padding: 6px 10px; font-weight: 500;">{{ col_name }}</td>
                                            <td style="padding: 6px 10px; text-align: right; font-family: var(--mono-font);">{{ stats.min if stats.min is not none else '-' }}</td>
                                            <td style="padding: 6px 10px; text-align: right; font-family: var(--mono-font);">{{ stats.max if stats.max is not none else '-' }}</td>
                                            <td style="padding: 6px 10px; text-align: right; font-family: var(--mono-font);">{{ "%.2f"|format(stats.mean) if stats.mean is not none else '-' }}</td>
                                            <td style="padding: 6px 10px; text-align: right; font-family: var(--mono-font);">{{ "%.2f"|format(stats.stddev) if stats.stddev is not none else '-' }}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                    {% endif %}

                    {% if node.delta_info %}
                    <div style="margin-top: 20px; border: 1px solid #b8daff; background: #f1f8ff; border-radius: 6px; overflow: hidden;">
                        <div style="background: #e7f5ff; padding: 10px 15px; border-bottom: 1px solid #b8daff; display: flex; justify-content: space-between; align-items: center;">
                            <h4 style="margin: 0; font-size: 0.95em; color: #004085; display: flex; align-items: center; gap: 8px;">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 0L1 4l7 4 7-4-7-4zM1 12l7 4 7-4V8l-7 4-7-4v4z"/></svg>
                                Delta Lake Write
                            </h4>
                            <span class="badge badge-blue" style="font-size: 0.8em;">v{{ node.delta_info.version }}</span>
                        </div>
                        <div style="padding: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 0.9em;">
                            <div>
                                <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Operation</div>
                                <div style="font-weight: 600; color: #333;">{{ node.delta_info.operation }}</div>
                            </div>
                            <div>
                                <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Timestamp</div>
                                <div style="font-weight: 600; color: #333;">{{ node.delta_info.timestamp }}</div>
                            </div>

                            <!-- Metrics Highlights -->
                            {% if node.delta_info.operation_metrics %}
                                {% set metrics = node.delta_info.operation_metrics %}
                                {% set inserted = metrics.numTargetRowsInserted or metrics.numOutputRows or metrics.num_added_rows %}
                                {% set updated = metrics.numTargetRowsUpdated or metrics.num_updated_rows %}
                                {% set deleted = metrics.numTargetRowsDeleted or metrics.num_deleted_rows %}
                                {% set files = metrics.numAddedFiles or metrics.numFilesAdded or metrics.num_added_files %}

                                {% if inserted %}
                                <div>
                                    <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Rows Inserted</div>
                                    <div style="font-weight: 600; color: var(--success-color);">+{{ inserted }}</div>
                                </div>
                                {% endif %}
                                {% if updated %}
                                <div>
                                    <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Rows Updated</div>
                                    <div style="font-weight: 600; color: #f59f00;">~{{ updated }}</div>
                                </div>
                                {% endif %}
                                {% if deleted %}
                                <div>
                                    <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Rows Deleted</div>
                                    <div style="font-weight: 600; color: var(--error-color);">-{{ deleted }}</div>
                                </div>
                                {% endif %}

                                <!-- Generic fallback if specific metrics missing -->
                                {% if not inserted and not updated and not deleted %}
                                <div>
                                    <div style="color: #6c757d; font-size: 0.85em; text-transform: uppercase;">Files Added</div>
                                    <div style="font-weight: 600;">{{ files }}</div>
                                </div>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Tab: SQL -->
                {% if node.executed_sql %}
                <div id="sql-{{ loop.index }}" class="tab-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="margin: 0; color: #333;">
                            üíæ Executed SQL ({{ node.executed_sql|length }} statement{% if node.executed_sql|length > 1 %}s{% endif %})
                        </h4>
                        <button class="copy-btn" onclick="copyAllSQL(this, '{{ node.node_name }}')">üìã Copy All SQL</button>
                    </div>
                    {% for sql in node.executed_sql %}
                    <details {% if loop.first %}open{% endif %} style="margin-bottom: 15px;">
                        <summary style="cursor: pointer; padding: 8px; background: #f8f9fa; border: 1px solid #e1e4e8; border-radius: 4px; font-weight: 500; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center;">
                            <span>
                                Statement #{{ loop.index }}
                                {% if sql|length > 100 %}
                                <span style="color: #666; font-weight: normal;"> - {{ sql[:50]|replace('\n', ' ') }}...</span>
                                {% endif %}
                            </span>
                        </summary>
                        <div style="position: relative; margin-top: 10px;">
                            <button class="copy-btn" style="position: absolute; top: 8px; right: 8px;" onclick="copyToClipboard(this, `{{ sql|e }}`); event.stopPropagation();">üìã Copy</button>
                            <pre style="border-left: 3px solid var(--primary-color); padding-right: 80px;" id="sql-{{ node.node_name }}-{{ loop.index }}">{{ sql }}</pre>
                        </div>
                    </details>
                    {% endfor %}
                    {% if node.sql_hash %}
                    <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; color: #666; font-size: 0.85em;">
                        <strong>SQL Hash:</strong> <code style="background: #e9ecef; padding: 2px 6px; border-radius: 3px;">{{ node.sql_hash }}</code>
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Tab: Data -->
                {% if node.sample_data or node.sample_in or node.data_diff %}
                <div id="data-{{ loop.index }}" class="tab-content">
                    {% if node.data_diff %}
                    <div style="margin-bottom: 20px; border: 1px solid #e1e4e8; border-radius: 6px; overflow: hidden;">
                        <div style="background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #e1e4e8;">
                            <h4 style="margin: 0; font-size: 1em; color: #666;">
                                üìâ Changes vs Previous Version
                                {% if node.delta_info and node.delta_info.read_version is not none %}
                                <span style="font-weight: normal; font-size: 0.9em;">(v{{ node.delta_info.version }} vs v{{ node.delta_info.version - 1 }})</span>
                                {% endif %}
                            </h4>
                        </div>

                        <div style="padding: 15px;">
                            <div style="display: flex; gap: 20px; margin-bottom: 15px; font-size: 0.95em;">
                            <div><strong>Net Change:</strong> {{ node.data_diff.rows_change }}</div>
                            {% if node.data_diff.rows_added is defined and node.data_diff.rows_added is not none %}
                            <div style="color: var(--success-color);"><strong>Added:</strong> {{ node.data_diff.rows_added }}</div>
                            {% endif %}
                            {% if node.data_diff.rows_updated is defined and node.data_diff.rows_updated is not none %}
                            <div style="color: #f59f00;"><strong>Updated:</strong> {{ node.data_diff.rows_updated }}</div>
                            {% endif %}
                            {% if node.data_diff.rows_removed is defined and node.data_diff.rows_removed is not none %}
                            <div style="color: var(--error-color);"><strong>Removed:</strong> {{ node.data_diff.rows_removed }}</div>
                            {% endif %}
                            {% if node.data_diff.rows_added is not defined and node.data_diff.rows_updated is not defined and node.data_diff.rows_removed is not defined %}
                            <div style="color: #888; font-style: italic; font-size: 0.9em;">(Enable deep diff for detailed breakdown)</div>
                            {% endif %}
                        </div>

                        {% if node.data_diff.schema_previous is not none %}
                        <div style="margin-bottom: 20px; padding: 15px; background: #fff; border: 1px solid #e1e4e8; border-radius: 4px;">
                            <h5 style="margin-top: 0; margin-bottom: 10px; color: #333; display: flex; align-items: center; gap: 8px;">
                                <span>üìã</span> Schema Evolution
                            </h5>

                            {% if not node.data_diff.schema_added and not node.data_diff.schema_removed %}
                                <div style="color: #666; font-style: italic;">No schema changes detected vs previous run.</div>
                            {% else %}
                                <div style="display: grid; gap: 10px;">
                                    {% if node.data_diff.schema_added %}
                                    <div>
                                        <span class="badge badge-green" style="margin-right: 8px;">+ ADDED</span>
                                        <span style="color: var(--success-color); font-family: var(--mono-font);">{{ node.data_diff.schema_added|join(', ') }}</span>
                                    </div>
                                    {% endif %}
                                    {% if node.data_diff.schema_removed %}
                                    <div>
                                        <span class="badge badge-red" style="margin-right: 8px;">- REMOVED</span>
                                        <span style="color: var(--error-color); font-family: var(--mono-font);">{{ node.data_diff.schema_removed|join(', ') }}</span>
                                    </div>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% if node.data_diff.sample_updated %}
                        <h5 style="margin-top: 0; margin-bottom: 10px; font-size: 0.9em; color: #666;">UPDATED ROWS (Values changed from previous run)</h5>
                        <div style="overflow-x: auto; margin-bottom: 20px; border: 1px solid #eee;">
                            <table style="margin: 0;">
                                <thead>
                                    <tr>
                                        <th>Key(s)</th>
                                        <th>Changes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in node.data_diff.sample_updated %}
                                    <tr>
                                        <td style="white-space: nowrap;">
                                            {% for k, v in row.items() if k != '_changes' %}
                                            <div><small>{{ k }}:</small> <strong>{{ v }}</strong></div>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for col, change in row._changes.items() %}
                                            <div style="margin-bottom: 4px;">
                                                <strong>{{ col }}</strong>:
                                                <span style="color: var(--error-color); text-decoration: line-through;">{{ change.old }}</span>
                                                &rarr;
                                                <span style="color: var(--success-color);">{{ change.new }}</span>
                                            </div>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if node.data_diff.sample_added %}
                        <h5 style="margin-top: 0; margin-bottom: 10px; font-size: 0.9em; color: #666;">ADDED ROWS (New in this run)</h5>
                        <div style="overflow-x: auto; margin-bottom: 20px; border: 1px solid #eee;">
                            <table style="margin: 0;">
                                <thead>
                                    <tr>
                                    {% for key in node.data_diff.sample_added[0].keys() %}<th>{{ key }}</th>{% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in node.data_diff.sample_added %}
                                    <tr class="diff-added">
                                    {% for val in row.values() %}<td>{{ val }}</td>{% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}

                        {% if node.data_diff.sample_removed %}
                        <h5 style="margin-top: 0; margin-bottom: 10px; font-size: 0.9em; color: #666;">REMOVED ROWS (Existed in previous run, gone now)</h5>
                        <div style="overflow-x: auto; border: 1px solid #eee;">
                            <table style="margin: 0;">
                                <thead>
                                    <tr>
                                    {% for key in node.data_diff.sample_removed[0].keys() %}<th>{{ key }}</th>{% endfor %}
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in node.data_diff.sample_removed %}
                                    <tr class="diff-removed">
                                    {% for val in row.values() %}<td>{{ val }}</td>{% endfor %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% endif %}
                        </div> <!-- End padding container -->
                    </div>
                    {% endif %}

                    {% if node.sample_in %}
                    <h4>Input Sample</h4>
                    <div style="overflow-x: auto; margin-bottom: 20px;">
                        <table>
                            <thead>
                                <tr>
                                {% if node.sample_in|length > 0 %}
                                    {% for key in node.sample_in[0].keys() %}<th>{{ key }}</th>{% endfor %}
                                {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in node.sample_in %}
                                <tr>
                                {% for val in row.values() %}<td>{{ val }}</td>{% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                    {% if node.sample_data %}
                    <h4>Output Sample</h4>
                    <div style="overflow-x: auto;">
                        <table>
                            <thead>
                                <tr>
                                {% if node.sample_data|length > 0 %}
                                    {% for key in node.sample_data[0].keys() %}<th>{{ key }}</th>{% endfor %}
                                {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in node.sample_data %}
                                <tr>
                                {% for val in row.values() %}<td>{{ val }}</td>{% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <p>No sample data available.</p>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Tab: Config -->
                {% if node.config_snapshot %}
                <div id="config-{{ loop.index }}" class="tab-content">
                    {% if node.environment %}
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px; border: 1px solid #e1e4e8;">
                        <h5 style="margin-top: 0; margin-bottom: 10px; color: #666;">Execution Environment</h5>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9em;">
                            <div><span style="color: #999;">Host:</span> <strong>{{ node.environment.host }}</strong></div>
                            <div><span style="color: #999;">User:</span> <strong>{{ node.environment.user }}</strong></div>
                            <div><span style="color: #999;">Python:</span> <strong>{{ node.environment.python }}</strong></div>
                            <div><span style="color: #999;">Platform:</span> <strong>{{ node.environment.platform }}</strong></div>
                            {% if node.environment.pandas %}<div><span style="color: #999;">Pandas:</span> <strong>{{ node.environment.pandas }}</strong></div>{% endif %}
                            {% if node.environment.pyspark %}<div><span style="color: #999;">PySpark:</span> <strong>{{ node.environment.pyspark }}</strong></div>{% endif %}
                            {% if node.environment.odibi %}<div><span style="color: #999;">Odibi:</span> <strong>{{ node.environment.odibi }}</strong></div>{% endif %}
                        </div>
                    </div>
                    {% endif %}

                    {% if node.previous_config_snapshot %}
                    <!-- Config Diff Viewer -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #7c3aed; display: flex; align-items: center; gap: 8px;">
                                <span>üìã</span> Config Changes vs Last Run
                            </h4>
                            <button class="copy-btn" onclick="toggleConfigDiffView({{ loop.index }})" id="config-diff-toggle-{{ loop.index }}">
                                Show Side-by-Side
                            </button>
                        </div>
                        
                        <!-- Inline Diff View (default) -->
                        <div id="config-diff-inline-{{ loop.index }}" class="config-diff-inline">
                            <pre id="config-diff-output-{{ loop.index }}" style="padding: 15px; max-height: 400px; overflow-y: auto;"></pre>
                        </div>
                        
                        <!-- Side-by-Side View (hidden by default) -->
                        <div id="config-diff-sidebyside-{{ loop.index }}" class="config-diff-container" style="display: none;">
                            <div class="config-diff-pane">
                                <div class="config-diff-header previous">Previous Run</div>
                                <div class="config-diff-content">
                                    <pre style="margin: 0; background: none; padding: 0;">{{ node.previous_config_snapshot | to_yaml }}</pre>
                                </div>
                            </div>
                            <div class="config-diff-pane">
                                <div class="config-diff-header current">Current Run</div>
                                <div class="config-diff-content">
                                    <pre style="margin: 0; background: none; padding: 0;">{{ node.config_snapshot | to_yaml }}</pre>
                                </div>
                            </div>
                        </div>
                        
                        <script>
                            (function() {
                                const prev = {{ node.previous_config_snapshot | tojson | safe }};
                                const curr = {{ node.config_snapshot | tojson | safe }};
                                const outputEl = document.getElementById('config-diff-output-{{ loop.index }}');
                                if (outputEl) {
                                    outputEl.innerHTML = generateConfigDiff(prev, curr);
                                }
                            })();
                        </script>
                    </div>
                    <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                    <h4 style="margin: 0 0 10px 0; color: #666;">Current Configuration</h4>
                    {% endif %}

                    <div style="position: relative;">
                        <button class="copy-btn" style="position: absolute; top: 8px; right: 8px; z-index: 1;" onclick="copyConfig(this, '{{ node.node_name }}'); event.stopPropagation();">üìã Copy YAML</button>
                        <pre style="padding-right: 90px;" id="config-yaml-{{ loop.index }}">{{ node.config_snapshot | to_yaml }}</pre>
                    </div>
                </div>
                {% endif %}

            </div>
        </div>
        {% endfor %}
    </div>

    <div style="text-align: center; margin-top: 40px; color: #666; font-size: 0.9em; font-style: italic;">
        "Where others saw gaps, I built bridges."
    </div>
    <div style="text-align: center; margin-top: 8px; color: #888; font-size: 0.8em;">
        Odibi v{{ odibi_version }} ¬∑ Henry Odibi
        <svg style="vertical-align: middle; margin-left: 4px;" width="20" height="14" viewBox="0 0 3 2">
            <rect width="1" height="2" x="0" fill="#008751"/>
            <rect width="1" height="2" x="1" fill="#ffffff"/>
            <rect width="1" height="2" x="2" fill="#008751"/>
        </svg>
    </div>
</div>

<script>
    // ========================================
    // Config Diff Functions
    // ========================================
    
    function generateConfigDiff(prev, curr) {
        const prevYaml = objectToYamlLines(prev);
        const currYaml = objectToYamlLines(curr);
        
        const diff = computeLineDiff(prevYaml, currYaml);
        return diff.map(line => {
            if (line.type === 'added') {
                return `<span class="diff-line-added">+ ${escapeHtml(line.text)}</span>`;
            } else if (line.type === 'removed') {
                return `<span class="diff-line-removed">- ${escapeHtml(line.text)}</span>`;
            } else {
                return `  ${escapeHtml(line.text)}`;
            }
        }).join('\n');
    }
    
    function objectToYamlLines(obj, indent = 0) {
        const lines = [];
        const prefix = '  '.repeat(indent);
        
        if (obj === null || obj === undefined) {
            return ['null'];
        }
        
        if (typeof obj !== 'object') {
            return [String(obj)];
        }
        
        if (Array.isArray(obj)) {
            obj.forEach(item => {
                if (typeof item === 'object' && item !== null) {
                    lines.push(`${prefix}-`);
                    objectToYamlLines(item, indent + 1).forEach(l => lines.push(l));
                } else {
                    lines.push(`${prefix}- ${item}`);
                }
            });
        } else {
            Object.keys(obj).sort().forEach(key => {
                const val = obj[key];
                if (val === null || val === undefined) {
                    lines.push(`${prefix}${key}: null`);
                } else if (typeof val === 'object') {
                    lines.push(`${prefix}${key}:`);
                    objectToYamlLines(val, indent + 1).forEach(l => lines.push(l));
                } else {
                    lines.push(`${prefix}${key}: ${val}`);
                }
            });
        }
        return lines;
    }
    
    function computeLineDiff(oldLines, newLines) {
        const result = [];
        const oldSet = new Set(oldLines);
        const newSet = new Set(newLines);
        
        // Find removed lines
        oldLines.forEach(line => {
            if (!newSet.has(line)) {
                result.push({ type: 'removed', text: line });
            }
        });
        
        // Find added and unchanged lines
        newLines.forEach(line => {
            if (!oldSet.has(line)) {
                result.push({ type: 'added', text: line });
            } else {
                result.push({ type: 'unchanged', text: line });
            }
        });
        
        // Sort: removed first, then unchanged/added in order
        const removed = result.filter(r => r.type === 'removed');
        const rest = result.filter(r => r.type !== 'removed');
        return [...removed, ...rest];
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function toggleConfigDiffView(index) {
        const inline = document.getElementById('config-diff-inline-' + index);
        const sideBySide = document.getElementById('config-diff-sidebyside-' + index);
        const btn = document.getElementById('config-diff-toggle-' + index);
        
        if (inline && sideBySide && btn) {
            if (sideBySide.style.display === 'none') {
                sideBySide.style.display = 'grid';
                inline.style.display = 'none';
                btn.textContent = 'Show Inline Diff';
            } else {
                sideBySide.style.display = 'none';
                inline.style.display = 'block';
                btn.textContent = 'Show Side-by-Side';
            }
        }
    }
    
    // ========================================
    // Duration Sparkline Functions
    // ========================================
    
    function renderSparkline(data, width = 60, height = 16) {
        if (!data || data.length < 2) return '';
        
        const durations = data.map(d => d.duration).reverse(); // Oldest to newest
        const min = Math.min(...durations);
        const max = Math.max(...durations);
        const range = max - min || 1;
        
        const points = durations.map((d, i) => {
            const x = (i / (durations.length - 1)) * width;
            const y = height - ((d - min) / range) * (height - 2) - 1;
            return `${x},${y}`;
        }).join(' ');
        
        const lastDuration = durations[durations.length - 1];
        const avgDuration = durations.reduce((a, b) => a + b, 0) / durations.length;
        const trend = lastDuration > avgDuration * 1.5 ? '#dc3545' : 
                      lastDuration < avgDuration * 0.5 ? '#28a745' : '#6c757d';
        
        return `<svg width="${width}" height="${height}" style="vertical-align: middle;">
            <polyline points="${points}" fill="none" stroke="${trend}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="${width}" cy="${height - ((lastDuration - min) / range) * (height - 2) - 1}" r="2" fill="${trend}"/>
        </svg>`;
    }
    
    function initSparklines() {
        document.querySelectorAll('.sparkline[data-history]').forEach(el => {
            try {
                const history = JSON.parse(el.dataset.history);
                if (history && history.length > 1) {
                    el.innerHTML = renderSparkline(history);
                }
            } catch (e) {
                console.debug('Failed to render sparkline:', e);
            }
        });
    }

    // Toggle node card open/closed
    function toggleNode(header) {
        const body = header.nextElementSibling;
        body.classList.toggle('open');
    }

    // Tab switching within a node
    function openTab(evt, tabId) {
        var nodeBody = evt.currentTarget.closest('.node-body');
        var tabContents = nodeBody.getElementsByClassName("tab-content");
        for (var i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove("active");
        }
        var tabBtns = nodeBody.getElementsByClassName("tab-btn");
        for (var i = 0; i < tabBtns.length; i++) {
            tabBtns[i].classList.remove("active");
        }
        document.getElementById(tabId).classList.add("active");
        evt.currentTarget.classList.add("active");
        evt.stopPropagation();
    }

    // Scroll to a specific node card - exposed on window for dynamic onclick handlers
    window.scrollToNode = function(nodeName) {
        // Handle both 'node-xxx' and 'xxx' formats
        const cleanName = nodeName && nodeName.startsWith('node-') ? nodeName.substring(5) : nodeName;
        const targetId = 'node-' + cleanName;
        
        // Use querySelector with .node-card class to avoid matching SVG elements
        const nodeCard = document.querySelector('div.node-card#' + CSS.escape(targetId));
        
        if (nodeCard) {
            nodeCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Flash highlight effect
            nodeCard.classList.add('flash');
            setTimeout(() => nodeCard.classList.remove('flash'), 1500);
            // Auto-expand the node
            const body = nodeCard.querySelector('.node-body');
            if (body && !body.classList.contains('open')) {
                body.classList.add('open');
            }
        }
    };

    // Filter nodes by status
    function filterNodes(filter, btn) {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // Get all node cards (skip the pipeline graph card)
        const nodeCards = document.querySelectorAll('.node-card[data-status]');
        nodeCards.forEach(card => {
            const status = card.dataset.status;
            const isAnomaly = card.dataset.anomaly === 'true';

            const isChanged = card.dataset.changed === 'true';

            if (filter === 'all') {
                card.style.display = '';
            } else if (filter === 'failed') {
                card.style.display = status === 'failed' ? '' : 'none';
            } else if (filter === 'anomalous') {
                card.style.display = isAnomaly ? '' : 'none';
            } else if (filter === 'changed') {
                card.style.display = isChanged ? '' : 'none';
            }
        });
    }

    // Copy text to clipboard with button feedback
    function copyToClipboard(btn, text) {
        navigator.clipboard.writeText(text).then(() => {
            btn.classList.add('copied');
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úì Copied!';
            setTimeout(() => {
                btn.classList.remove('copied');
                btn.innerHTML = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy to clipboard');
        });
    }

    // Copy all SQL for a node
    function copyAllSQL(btn, nodeName) {
        const nodeCard = document.getElementById('node-' + nodeName);
        const sqlBlocks = nodeCard.querySelectorAll('[id^="sql-"][id$="-"]');
        let allSQL = [];
        sqlBlocks.forEach(block => {
            if (block.tagName === 'PRE') {
                allSQL.push(block.textContent);
            }
        });
        // Fallback: get from details > pre
        if (allSQL.length === 0) {
            nodeCard.querySelectorAll('.tab-content details pre').forEach(pre => {
                allSQL.push(pre.textContent);
            });
        }
        copyToClipboard(btn, allSQL.join('\n\n-- Next Statement --\n\n'));
    }

    // Copy error info for a node
    function copyError(btn, nodeName) {
        const nodeCard = document.getElementById('node-' + nodeName);
        const errorPre = nodeCard.querySelector('[id^="error-"]');
        const tracebackCleaned = nodeCard.querySelector('[id^="traceback-cleaned-"]');
        let errorText = errorPre ? errorPre.textContent : '';
        if (tracebackCleaned) {
            errorText += '\n\n--- Traceback ---\n' + tracebackCleaned.textContent;
        }
        copyToClipboard(btn, errorText);
    }

    // Copy config YAML for a node
    function copyConfig(btn, nodeName) {
        const nodeCard = document.getElementById('node-' + nodeName);
        const configPre = nodeCard.querySelector('[id^="config-yaml-"]');
        if (configPre) {
            copyToClipboard(btn, configPre.textContent);
        }
    }

    // Auto-expand failed nodes on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Find all failed node cards and expand them
        document.querySelectorAll('.node-card[data-status="failed"]').forEach(card => {
            const body = card.querySelector('.node-body');
            if (body) {
                body.classList.add('open');
            }
        });

        // Also expand anomalous nodes
        document.querySelectorAll('.node-card[data-anomaly="true"]').forEach(card => {
            const body = card.querySelector('.node-body');
            if (body) {
                body.classList.add('open');
            }
        });

        // Initialize Graphviz graph
        initGraphvizGraph();

        // Initialize dark mode from localStorage
        initDarkMode();

        // Localize timestamps
        localizeTimestamps();

        // Initialize view mode from localStorage
        initViewMode();

        // Initialize duration sparklines
        initSparklines();
    });

    // Dark Mode (Phase 4)
    function initDarkMode() {
        const savedTheme = localStorage.getItem('odibi-story-theme');
    }

    // Collapsible Sections
    function toggleSection(sectionId) {
        const header = document.querySelector(`#${sectionId === 'timeline' ? 'execution-timeline' : 'pipeline-graph-card'} .collapsible-header`);
        const content = document.getElementById(`${sectionId}-content`);
        
        if (header && content) {
            const isCollapsed = header.classList.toggle('collapsed');
            content.classList.toggle('collapsed', isCollapsed);
            
            // Save state to localStorage
            localStorage.setItem(`odibi-section-${sectionId}`, isCollapsed ? 'collapsed' : 'expanded');
            
            // If expanding pipeline, re-render graph to fix sizing
            if (sectionId === 'pipeline' && !isCollapsed) {
                setTimeout(() => renderGraphviz('LR'), 100);
            }
            // If expanding timeline, re-render timeline
            if (sectionId === 'timeline' && !isCollapsed) {
                setTimeout(renderExecutionTimeline, 100);
            }
        }
    }

    function initCollapsibleSections() {
        // Timeline: default collapsed, Pipeline: default expanded
        const timelineState = localStorage.getItem('odibi-section-timeline') || 'collapsed';
        const pipelineState = localStorage.getItem('odibi-section-pipeline') || 'expanded';
        
        const timelineHeader = document.querySelector('#execution-timeline .collapsible-header');
        const timelineContent = document.getElementById('timeline-content');
        const pipelineHeader = document.querySelector('#pipeline-graph-card .collapsible-header');
        const pipelineContent = document.getElementById('pipeline-content');
        
        if (timelineHeader && timelineContent) {
            if (timelineState === 'collapsed') {
                timelineHeader.classList.add('collapsed');
                timelineContent.classList.add('collapsed');
            } else {
                timelineHeader.classList.remove('collapsed');
                timelineContent.classList.remove('collapsed');
            }
        }
        
        if (pipelineHeader && pipelineContent) {
            if (pipelineState === 'collapsed') {
                pipelineHeader.classList.add('collapsed');
                pipelineContent.classList.add('collapsed');
            } else {
                pipelineHeader.classList.remove('collapsed');
                pipelineContent.classList.remove('collapsed');
            }
        }
    }

    // Timestamp Localizer (Phase 4)
    function localizeTimestamps() {
        document.querySelectorAll('.timestamp').forEach(el => {
            const utc = el.dataset.utc;
            if (utc) {
                try {
                    const date = new Date(utc);
                    if (!isNaN(date.getTime())) {
                        el.textContent = date.toLocaleString();
                        el.title = utc + ' (UTC)';
                    }
                } catch (e) {
                    console.debug('Could not parse timestamp:', utc);
                }
            }
        });
    }

    // View Mode (Phase 4)
    function initViewMode() {
        const savedMode = localStorage.getItem('odibi-story-view-mode') || 'developer';
        document.getElementById('view-mode').value = savedMode;
        applyViewMode(savedMode);
    }

    function setViewMode(mode) {
        localStorage.setItem('odibi-story-view-mode', mode);
        applyViewMode(mode);
    }

    function applyViewMode(mode) {
        const developerElements = document.querySelectorAll('.tab-btn[onclick*="sql-"], .tab-btn[onclick*="config-"], details:has(pre), .error-traceback');
        const tracebackDetails = document.querySelectorAll('details:has([id^="traceback"])');

        if (mode === 'stakeholder') {
            // Hide SQL tabs, config tabs, and tracebacks
            document.querySelectorAll('.tabs').forEach(tabs => {
                tabs.querySelectorAll('.tab-btn').forEach(btn => {
                    const onclick = btn.getAttribute('onclick') || '';
                    if (onclick.includes('sql-') || onclick.includes('config-')) {
                        btn.style.display = 'none';
                    }
                });
            });
            tracebackDetails.forEach(el => el.style.display = 'none');
        } else {
            // Show all tabs
            document.querySelectorAll('.tabs .tab-btn').forEach(btn => {
                btn.style.display = '';
            });
            tracebackDetails.forEach(el => el.style.display = '');
        }
    }

    // Graph data from template
    const graphData = {{ metadata.graph_data | tojson | safe if metadata.graph_data else '{"nodes":[],"edges":[]}' }};

    // Status colors for Graphviz nodes
    const statusColors = {
        success: { fill: '#e6fffa', border: '#0ca678' },
        failed: { fill: '#fff5f5', border: '#e03131' },
        skipped: { fill: '#f8f9fa', border: '#adb5bd' },
        unknown: { fill: '#f8f9fa', border: '#868e96' },
        external: { fill: '#e7f5ff', border: '#1c7ed6' }  // Blue for cross-pipeline dependencies
    };

    // Generate DOT syntax from graph data
    function generateDOT(rankdir = 'LR') {
        if (!graphData.nodes || graphData.nodes.length === 0) {
            return 'digraph { node [label="No data"] }';
        }

        let dot = `digraph pipeline {
            rankdir=${rankdir};
            bgcolor="transparent";
            node [shape=box, style="filled,rounded", fontname="Segoe UI, Arial", fontsize=11, margin="0.2,0.1"];
            edge [color="#adb5bd", arrowsize=0.7];
            nodesep=0.4;
            ranksep=0.6;
        `;

        // Add nodes with status-based colors
        graphData.nodes.forEach(node => {
            const colors = statusColors[node.status] || statusColors.unknown;
            const label = (node.label || node.id).replace(/"/g, '\\"');
            // Truncate long names
            const displayLabel = label.length > 25 ? label.substring(0, 22) + '...' : label;
            // Use different shape for external (cross-pipeline) nodes
            const shape = node.is_external ? 'ellipse' : 'box';
            const style = node.is_external ? 'filled,dashed' : 'filled,rounded';
            const externalLabel = node.is_external ? `‚Üó ${displayLabel}` : displayLabel;

            // Build tooltip with dependencies info
            let tooltipText = label;
            if (node.dependencies && node.dependencies.length > 0) {
                const depsStr = node.dependencies.join(', ');
                tooltipText += `\\nDepends on: ${depsStr}`;
            }
            if (node.is_external && node.source_pipeline) {
                tooltipText += `\\nFrom: ${node.source_pipeline}`;
            }

            dot += `    "${node.id}" [label="${externalLabel}", shape=${shape}, style="${style}", fillcolor="${colors.fill}", color="${colors.border}", penwidth=2, tooltip="${tooltipText}", id="dag-${node.id}", class="dag-node"];\n`;
        });

        // Add edges
        graphData.edges.forEach(edge => {
            dot += `    "${edge.source}" -> "${edge.target}";\n`;
        });

        dot += '}';
        return dot;
    }

    // Render graph using Graphviz
    async function renderGraphviz(rankdir = 'LR') {
        const container = document.getElementById('graphviz-container');
        if (!container) return;

        if (!graphData.nodes || graphData.nodes.length === 0) {
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #666;">No graph data available</div>';
            return;
        }

        container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #666;">Loading graph...</div>';

        try {
            const graphviz = await window["@hpcc-js/wasm"].Graphviz.load();
            const dot = generateDOT(rankdir);
            const svg = graphviz.dot(dot);
            container.innerHTML = svg;

            // Make SVG responsive
            const svgEl = container.querySelector('svg');
            if (svgEl) {
                svgEl.style.maxWidth = '100%';
                svgEl.style.height = 'auto';
                svgEl.style.minHeight = '400px';
                
                // Add click and hover handlers to nodes (Graphviz uses .node class for node groups)
                container.querySelectorAll('.node').forEach(nodeEl => {
                    nodeEl.style.cursor = 'pointer';
                    
                    // Click to navigate
                    nodeEl.addEventListener('click', function(e) {
                        const titleEl = this.querySelector('title');
                        if (titleEl) {
                            const nodeId = titleEl.textContent.trim();
                            window.scrollToNode(nodeId);
                            highlightNodeInGraph(nodeId);
                        }
                    });
                    
                    // Hover to show tooltip
                    nodeEl.addEventListener('mouseenter', function(e) {
                        const titleEl = this.querySelector('title');
                        if (titleEl) {
                            const nodeId = titleEl.textContent.trim();
                            showDagTooltip(nodeId, e);
                        }
                    });
                    
                    nodeEl.addEventListener('mousemove', function(e) {
                        moveDagTooltip(e);
                    });
                    
                    nodeEl.addEventListener('mouseleave', function(e) {
                        hideDagTooltip();
                    });
                });
            }
        } catch (error) {
            console.error('Graphviz error:', error);
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #e03131;">Error rendering graph: ' + error.message + '</div>';
        }
    }

    // Highlight a node in the SVG graph
    function highlightNodeInGraph(nodeId) {
        const container = document.getElementById('graphviz-container');
        if (!container) return;

        // Reset all nodes
        container.querySelectorAll('.node polygon, .node path, .node ellipse').forEach(el => {
            el.style.strokeWidth = '';
            el.style.stroke = '';
        });

        // Find and highlight selected node by matching title content
        container.querySelectorAll('.node').forEach(nodeEl => {
            const titleEl = nodeEl.querySelector('title');
            if (titleEl && titleEl.textContent === nodeId) {
                const shape = nodeEl.querySelector('polygon, path, ellipse');
                if (shape) {
                    shape.style.strokeWidth = '4';
                    shape.style.stroke = '#0066cc';
                }
            }
        });
    }

    // Tooltip functions for DAG nodes
    function showDagTooltip(nodeId, event) {
        const tooltip = document.getElementById('dag-tooltip');
        if (!tooltip || !graphData.nodes) return;
        
        // Find node data
        const node = graphData.nodes.find(n => n.id === nodeId);
        if (!node) return;
        
        // Build tooltip HTML
        let html = `<h4>${node.label || node.id}`;
        if (node.is_external) {
            html += `<span class="external-badge">External</span>`;
        }
        html += `</h4>`;
        
        // Status
        const statusColors = {
            success: '#0ca678',
            failed: '#e03131',
            skipped: '#adb5bd',
            external: '#1c7ed6'
        };
        const statusColor = statusColors[node.status] || '#666';
        html += `<div class="tooltip-row">
            <span class="tooltip-label">Status:</span>
            <span class="tooltip-value" style="color: ${statusColor}; font-weight: 500;">${node.status}</span>
        </div>`;
        
        // Duration (if not external)
        if (!node.is_external && node.duration !== undefined) {
            html += `<div class="tooltip-row">
                <span class="tooltip-label">Duration:</span>
                <span class="tooltip-value">${node.duration.toFixed(2)}s</span>
            </div>`;
        }
        
        // Rows Read (if available)
        if (node.rows_in !== null && node.rows_in !== undefined) {
            html += `<div class="tooltip-row">
                <span class="tooltip-label">Rows Read:</span>
                <span class="tooltip-value">${node.rows_in.toLocaleString()}</span>
            </div>`;
        }
        
        // Rows Written (if available)
        if (node.rows_written !== null && node.rows_written !== undefined) {
            const noChanges = node.rows_in && node.rows_written === 0 && node.rows_in > 0 ? ' (no changes)' : '';
            html += `<div class="tooltip-row">
                <span class="tooltip-label">Rows Written:</span>
                <span class="tooltip-value">${node.rows_written.toLocaleString()}${noChanges}</span>
            </div>`;
        } else if (node.rows_out !== null && node.rows_out !== undefined) {
            html += `<div class="tooltip-row">
                <span class="tooltip-label">Rows Out:</span>
                <span class="tooltip-value">${node.rows_out.toLocaleString()}</span>
            </div>`;
        }
        
        // Source pipeline (for external nodes)
        if (node.is_external && node.source_pipeline) {
            html += `<div class="tooltip-row">
                <span class="tooltip-label">From:</span>
                <span class="tooltip-value">${node.source_pipeline}</span>
            </div>`;
        }
        
        // Dependencies
        if (node.dependencies && node.dependencies.length > 0) {
            html += `<div class="tooltip-row" style="flex-direction: column;">
                <span class="tooltip-label">Depends on:</span>
                <ul class="deps-list">`;
            node.dependencies.forEach(dep => {
                html += `<li>${dep}</li>`;
            });
            html += `</ul></div>`;
        }
        
        tooltip.innerHTML = html;
        tooltip.classList.add('visible');
        moveDagTooltip(event);
    }
    
    function moveDagTooltip(event) {
        const tooltip = document.getElementById('dag-tooltip');
        if (!tooltip) return;
        
        // Position tooltip near cursor but not overlapping
        let x = event.clientX + 15;
        let y = event.clientY + 15;
        
        // Keep tooltip within viewport
        const rect = tooltip.getBoundingClientRect();
        if (x + rect.width > window.innerWidth - 10) {
            x = event.clientX - rect.width - 15;
        }
        if (y + rect.height > window.innerHeight - 10) {
            y = event.clientY - rect.height - 15;
        }
        
        tooltip.style.left = x + 'px';
        tooltip.style.top = y + 'px';
    }
    
    function hideDagTooltip() {
        const tooltip = document.getElementById('dag-tooltip');
        if (tooltip) {
            tooltip.classList.remove('visible');
        }
    }

    // Initialize Graphviz graph on page load
    function initGraphvizGraph() {
        renderGraphviz('LR');
    }

    // Switch between DAG and List view
    function changeGraphViewType(viewType) {
        const graphContainer = document.getElementById('graphviz-container');
        const listView = document.getElementById('pipeline-list-view');
        
        if (viewType === 'list') {
            graphContainer.style.display = 'none';
            listView.style.display = 'block';
            renderListView();
        } else {
            graphContainer.style.display = 'block';
            listView.style.display = 'none';
            renderGraphviz('LR');
        }
    }

    // Render pipeline as a readable list with dependencies
    function renderListView() {
        const listView = document.getElementById('pipeline-list-view');
        if (!graphData.nodes || graphData.nodes.length === 0) {
            listView.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">No nodes to display</div>';
            return;
        }

        // Build edge lookup for dependencies
        const edgesByTarget = {};
        const edgesBySource = {};
        graphData.edges.forEach(edge => {
            if (!edgesByTarget[edge.target]) edgesByTarget[edge.target] = [];
            if (!edgesBySource[edge.source]) edgesBySource[edge.source] = [];
            edgesByTarget[edge.target].push(edge.source);
            edgesBySource[edge.source].push(edge.target);
        });

        const statusIcons = {
            success: '‚úì',
            failed: '‚úó',
            skipped: '‚óã',
            unknown: '?',
            external: '‚Üó'
        };
        const statusColors = {
            success: '#0ca678',
            failed: '#e03131',
            skipped: '#adb5bd',
            unknown: '#868e96',
            external: '#1c7ed6'
        };

        // Helper to create clickable dependency links - use data attributes for event delegation
        const makeDepLinks = (deps, color) => {
            return deps.map(d => `<a href="#node-${encodeURIComponent(d)}" class="dep-link" data-node-id="${d.replace(/"/g, '&quot;')}" style="color: ${color}; text-decoration: none; border-bottom: 1px dashed ${color};">${d}</a>`).join(', ');
        };

        let html = `<div style="font-size: 13px; color: #666; margin-bottom: 16px;">
            ${graphData.nodes.length} nodes ‚Ä¢ Click node name for details ‚Ä¢ Click dependency to navigate
        </div>`;
        
        // Render nodes in order
        graphData.nodes.forEach(node => {
            const upstream = edgesByTarget[node.id] || [];
            const downstream = edgesBySource[node.id] || [];
            const statusIcon = statusIcons[node.status] || statusIcons.unknown;
            const statusColor = statusColors[node.status] || statusColors.unknown;
            const isExternal = node.is_external === true;
            const borderStyle = isExternal ? '2px dashed' : '1px solid';
            const bgColor = isExternal ? '#f0f9ff' : 'white';
            const labelPrefix = isExternal ? '‚Üó ' : '';
            
            html += `
            <div style="display: flex; align-items: flex-start; padding: 12px 16px; margin-bottom: 8px; background: ${bgColor}; border-radius: 8px; border: ${borderStyle} #e1e4e8; transition: all 0.15s;" 
                 onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.borderColor='${statusColor}';"
                 onmouseout="this.style.boxShadow='none'; this.style.borderColor='#e1e4e8';">
                <div style="min-width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; background: ${statusColor}20; color: ${statusColor}; border-radius: ${isExternal ? '50%' : '6px'}; font-weight: bold; margin-right: 14px;">
                    ${statusIcon}
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 4px; word-break: break-word;">
                        ${isExternal ? `<span style="color: ${statusColor};">${labelPrefix}${node.label || node.id}</span> <span style="font-size: 11px; color: #666; font-weight: normal;">(cross-pipeline)</span>` : `<a href="#node-${encodeURIComponent(node.id)}" class="node-link" data-node-id="${(node.id || '').replace(/"/g, '&quot;')}" style="color: #333; text-decoration: none;">${node.label || node.id}</a>`}
                    </div>
                    <div style="font-size: 13px; color: #666; display: flex; flex-wrap: wrap; gap: 12px;">
                        ${!isExternal && node.duration !== undefined ? `<span>‚è± ${node.duration.toFixed(3)}s</span>` : ''}
                        ${!isExternal && node.rows_in !== null && node.rows_in !== undefined ? `<span title="Rows Read">üì• ${node.rows_in.toLocaleString()}</span>` : ''}
                        ${!isExternal && node.rows_written !== null && node.rows_written !== undefined ? `<span title="Rows Written">üì§ ${node.rows_written.toLocaleString()}${node.rows_in && node.rows_written === 0 && node.rows_in > 0 ? ' (no changes)' : ''}</span>` : (!isExternal && node.rows_out !== null && node.rows_out !== undefined ? `<span>üìä ${node.rows_out.toLocaleString()} rows</span>` : '')}
                        ${isExternal ? '<span style="font-style: italic;">External dependency</span>' : ''}
                    </div>
                    ${upstream.length > 0 ? `<div style="font-size: 12px; margin-top: 6px;">‚Üê <span style="color: #666;">${upstream.length} upstream:</span> ${makeDepLinks(upstream, '#0066cc')}</div>` : (isExternal ? '' : '<div style="font-size: 12px; color: #999; margin-top: 6px;">‚Üê No dependencies (source)</div>')}
                    ${downstream.length > 0 ? `<div style="font-size: 12px; margin-top: 2px;">‚Üí <span style="color: #666;">${downstream.length} downstream:</span> ${makeDepLinks(downstream, '#0ca678')}</div>` : ''}
                </div>
            </div>`;
        });

        listView.innerHTML = html;
    }
    
    // Set up event delegation for list view links (once, on document level)
    document.addEventListener('click', function(e) {
        const link = e.target.closest('.node-link, .dep-link');
        if (link) {
            e.preventDefault();
            e.stopPropagation();
            const nodeId = link.dataset.nodeId;
            if (nodeId && typeof window.scrollToNode === 'function') {
                window.scrollToNode(nodeId);
            }
        }
    });
    
    // Focus on a node in the graph from list view
    function focusGraphNode(nodeId) {
        highlightNodeInGraph(nodeId);
    }

    // Copy node deep link to clipboard
    function copyNodeLink(btn, nodeName) {
        const url = window.location.href.split('#')[0] + '#node-' + nodeName;
        copyToClipboard(btn, url);
    }

    // ========================================
    // Keyboard Navigation
    // ========================================
    let currentFocusedIndex = -1;
    const nodeCards = [];

    function initKeyboardNavigation() {
        // Collect all node cards (excluding pipeline-graph-card)
        document.querySelectorAll('.node-card[data-status]').forEach(card => {
            nodeCards.push(card);
        });

        document.addEventListener('keydown', function(e) {
            // Ignore if typing in an input
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            switch(e.key.toLowerCase()) {
                case 'f': // Jump to first failed node
                    e.preventDefault();
                    jumpToFirstFailed();
                    break;
                case 'n': // Next node
                    e.preventDefault();
                    navigateNodes(1);
                    break;
                case 'p': // Previous node
                    e.preventDefault();
                    navigateNodes(-1);
                    break;
                case 'escape': // Collapse all nodes
                    e.preventDefault();
                    collapseAllNodes();
                    break;
                case 'enter': // Toggle current node
                    if (currentFocusedIndex >= 0) {
                        e.preventDefault();
                        const card = nodeCards[currentFocusedIndex];
                        const header = card.querySelector('.node-header');
                        if (header) toggleNode(header);
                    }
                    break;
            }
        });
    }

    function jumpToFirstFailed() {
        for (let i = 0; i < nodeCards.length; i++) {
            if (nodeCards[i].dataset.status === 'failed') {
                focusNodeCard(i);
                return;
            }
        }
    }

    function navigateNodes(direction) {
        const newIndex = currentFocusedIndex + direction;
        if (newIndex >= 0 && newIndex < nodeCards.length) {
            focusNodeCard(newIndex);
        } else if (newIndex < 0) {
            focusNodeCard(nodeCards.length - 1);
        } else {
            focusNodeCard(0);
        }
    }

    function focusNodeCard(index) {
        // Remove previous focus
        nodeCards.forEach(card => card.classList.remove('keyboard-focus'));
        
        currentFocusedIndex = index;
        const card = nodeCards[index];
        card.classList.add('keyboard-focus');
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function collapseAllNodes() {
        document.querySelectorAll('.node-body.open').forEach(body => {
            body.classList.remove('open');
        });
        // Remove keyboard focus
        nodeCards.forEach(card => card.classList.remove('keyboard-focus'));
        currentFocusedIndex = -1;
    }

    // ========================================
    // Deep Links (URL Hash Navigation)
    // ========================================
    function handleHashNavigation() {
        const hash = window.location.hash;
        if (hash && hash.startsWith('#node-')) {
            const nodeName = hash.substring(6); // Remove '#node-'
            setTimeout(() => {
                window.scrollToNode(nodeName);
            }, 500); // Delay to ensure DOM is ready
        }
    }

    // ========================================
    // Execution Timeline
    // ========================================
    let timelineExpanded = false;

    function renderExecutionTimeline() {
        const container = document.getElementById('timeline-chart');
        if (!container || !graphData.nodes || graphData.nodes.length === 0) return;

        // Get nodes with timing data
        const nodesWithTiming = graphData.nodes.filter(n => n.duration > 0 && !n.is_external);
        if (nodesWithTiming.length === 0) {
            container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">No timing data available</div>';
            return;
        }

        // Find max duration for scaling
        const maxDuration = Math.max(...nodesWithTiming.map(n => n.duration));

        // Sort by duration descending (slowest first)
        nodesWithTiming.sort((a, b) => b.duration - a.duration);

        // Show top 15 collapsed, all when expanded
        const initialCount = 15;
        const hasMore = nodesWithTiming.length > initialCount;
        const nodesToShow = timelineExpanded ? nodesWithTiming : nodesWithTiming.slice(0, initialCount);

        let html = '';
        nodesToShow.forEach((node, index) => {
            const widthPct = (node.duration / maxDuration) * 100;
            const statusClass = node.status || 'unknown';

            html += `<div class="timeline-row">
                <div class="timeline-label" title="${node.label}">${node.label}</div>
                <div class="timeline-bar-container">
                    <div class="timeline-bar ${statusClass}" 
                         style="width: ${widthPct}%;"
                         onclick="window.scrollToNode('${node.id}')"
                         title="${node.label}: ${node.duration.toFixed(3)}s">
                        ${node.duration.toFixed(2)}s
                    </div>
                </div>
            </div>`;
        });

        if (hasMore) {
            const remaining = nodesWithTiming.length - initialCount;
            if (timelineExpanded) {
                html += `<div style="text-align: center; margin-top: 10px;">
                    <button onclick="toggleTimeline()" style="background: none; border: 1px solid var(--border-color); padding: 6px 16px; border-radius: 4px; cursor: pointer; color: var(--text-color); font-size: 12px;">
                        ‚ñ≤ Show less
                    </button>
                </div>`;
            } else {
                html += `<div style="text-align: center; margin-top: 10px;">
                    <button onclick="toggleTimeline()" style="background: none; border: 1px solid var(--border-color); padding: 6px 16px; border-radius: 4px; cursor: pointer; color: var(--text-color); font-size: 12px;">
                        ‚ñº Show ${remaining} more nodes
                    </button>
                </div>`;
            }
        }

        container.style.height = 'auto';
        container.innerHTML = html;
    }

    function toggleTimeline() {
        timelineExpanded = !timelineExpanded;
        renderExecutionTimeline();
    }

    // ========================================
    // Failed Path Trace (Auto-highlight)
    // ========================================
    function highlightFailedPaths() {
        if (!graphData.nodes || !graphData.edges) return;

        const failedNodes = graphData.nodes.filter(n => n.status === 'failed').map(n => n.id);
        if (failedNodes.length === 0) return;

        // Build reverse edge map (target -> sources)
        const upstreamMap = {};
        graphData.edges.forEach(e => {
            if (!upstreamMap[e.target]) upstreamMap[e.target] = [];
            upstreamMap[e.target].push(e.source);
        });

        // Find all nodes in failed paths (trace upstream from failed nodes)
        const failedPathNodes = new Set(failedNodes);
        const queue = [...failedNodes];

        while (queue.length > 0) {
            const current = queue.shift();
            const upstream = upstreamMap[current] || [];
            upstream.forEach(u => {
                if (!failedPathNodes.has(u)) {
                    failedPathNodes.add(u);
                    queue.push(u);
                }
            });
        }

        // Highlight these nodes in the SVG with red border
        const container = document.getElementById('graphviz-container');
        if (!container) return;

        container.querySelectorAll('.node').forEach(nodeEl => {
            const titleEl = nodeEl.querySelector('title');
            if (titleEl) {
                const nodeId = titleEl.textContent.trim();
                if (failedNodes.includes(nodeId)) {
                    // Failed node - thick red border
                    const shape = nodeEl.querySelector('polygon, path, ellipse');
                    if (shape) {
                        shape.style.strokeWidth = '4';
                        shape.style.stroke = '#e03131';
                    }
                } else if (failedPathNodes.has(nodeId)) {
                    // Upstream of failed - orange dashed
                    const shape = nodeEl.querySelector('polygon, path, ellipse');
                    if (shape) {
                        shape.style.strokeWidth = '2';
                        shape.style.stroke = '#f59f00';
                        shape.style.strokeDasharray = '5,3';
                    }
                }
            }
        });
    }

    // ========================================
    // Initialize on page load
    // ========================================
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize collapsible sections first
        initCollapsibleSections();

        const viewTypeSelect = document.getElementById('graph-view-type');
        const pipelineContent = document.getElementById('pipeline-content');
        const isPipelineExpanded = pipelineContent && !pipelineContent.classList.contains('collapsed');
        
        // Only render graph if pipeline section is expanded
        if (isPipelineExpanded) {
            if (viewTypeSelect && viewTypeSelect.value === 'list') {
                changeGraphViewType('list');
            } else {
                initGraphvizGraph();
            }
        }

        // Initialize other features
        initKeyboardNavigation();
        handleHashNavigation();
        
        // Render timeline only if expanded
        const timelineContent = document.getElementById('timeline-content');
        if (timelineContent && !timelineContent.classList.contains('collapsed')) {
            setTimeout(renderExecutionTimeline, 100);
        }
        
        // Highlight failed paths after graph renders
        setTimeout(highlightFailedPaths, 500);
    });

    // Also handle hash changes for deep linking
    window.addEventListener('hashchange', handleHashNavigation);
</script>

</body>
</html>
