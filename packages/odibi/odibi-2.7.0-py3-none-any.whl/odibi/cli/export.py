import os

from odibi.config import load_config_from_file
from odibi.orchestration.airflow import AirflowExporter


def add_export_parser(subparsers):
    export_parser = subparsers.add_parser("export", help="Export pipeline to orchestration code")
    export_parser.add_argument(
        "--target", choices=["airflow", "dagster"], required=True, help="Export target"
    )
    export_parser.add_argument("--pipeline", help="Pipeline name (required for Airflow)")
    export_parser.add_argument("--out", required=True, help="Output file path")
    export_parser.add_argument("--config", default="odibi.yaml", help="Path to odibi.yaml")


def export_command(args):
    """Export pipeline to orchestration code."""
    config_path = args.config
    if not os.path.exists(config_path):
        print(f"Error: Config file '{config_path}' not found.")
        return 1

    try:
        project_config = load_config_from_file(config_path)
    except Exception as e:
        print(f"Error loading config: {e}")
        return 1

    if args.target == "airflow":
        if not args.pipeline:
            print("Error: --pipeline is required for Airflow export.")
            return 1

        exporter = AirflowExporter(project_config)
        try:
            code = exporter.generate_code(args.pipeline)
            with open(args.out, "w", encoding="utf-8") as f:
                f.write(code)
            print(f"Successfully exported Airflow DAG to {args.out}")
        except ValueError as e:
            print(f"Error: {e}")
            return 1

    elif args.target == "dagster":
        # Generate a definitions.py scaffolding
        content = f"""
# Generated by Odibi
import os
from dagster import Definitions
from odibi.config import load_config_from_file
from odibi.orchestration.dagster import DagsterFactory

# Load project config
# Ensure odibi.yaml is in the same directory or adjust path
config_path = os.path.join(os.path.dirname(__file__), "{config_path}")
project_config = load_config_from_file(config_path)

# Create definitions
defs = DagsterFactory(project_config).create_definitions()
"""
        with open(args.out, "w", encoding="utf-8") as f:
            f.write(content)
        print(f"Successfully created Dagster definitions at {args.out}")

    return 0
