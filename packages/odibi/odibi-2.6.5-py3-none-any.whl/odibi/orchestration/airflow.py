import re

from jinja2 import Template

from odibi.config import ProjectConfig

AIRFLOW_DAG_TEMPLATE = """
from airflow import DAG
from airflow.operators.bash import BashOperator
from datetime import datetime, timedelta

# Generated by Odibi
# Project: {{ project_name }}
# Pipeline: {{ pipeline_name }}

default_args = {
    'owner': '{{ owner }}',
    'depends_on_past': False,
    'start_date': datetime(2023, 1, 1),
    'email_on_failure': False,
    'email_on_retry': False,
    'retries': {{ retries }},
    'retry_delay': timedelta(minutes=5),
}

with DAG(
    '{{ dag_id }}',
    default_args=default_args,
    description='{{ description }}',
    schedule_interval=None, # Set schedule manually or via config
    catchup=False,
    tags=['odibi', '{{ layer }}'],
) as dag:

    # --- Nodes ---
{% for node in nodes %}
    {{ node.safe_name }} = BashOperator(
        task_id='{{ node.name }}',
        bash_command='odibi run --pipeline {{ pipeline_name }} --node {{ node.name }}',
    )
{% endfor %}

    # --- Dependencies ---
{% for node in nodes %}
    {% if node.upstream_vars %}
    # {{ node.name }} depends on {{ node.depends_on }}
    [{{ node.upstream_vars|join(', ') }}] >> {{ node.safe_name }}
    {% endif %}
{% endfor %}
"""


class AirflowExporter:
    def __init__(self, config: ProjectConfig):
        self.config = config

    def _sanitize(self, name: str) -> str:
        return re.sub(r"[^a-zA-Z0-9_]", "_", name)

    def generate_code(self, pipeline_name: str) -> str:
        # Find pipeline
        pipeline = next((p for p in self.config.pipelines if p.pipeline == pipeline_name), None)
        if not pipeline:
            raise ValueError(f"Pipeline '{pipeline_name}' not found in config")

        nodes_ctx = []
        for node in pipeline.nodes:
            safe_name = self._sanitize(node.name)
            upstream_vars = [self._sanitize(dep) for dep in node.depends_on]

            nodes_ctx.append(
                {
                    "name": node.name,
                    "safe_name": safe_name,
                    "depends_on": node.depends_on,
                    "upstream_vars": upstream_vars,
                }
            )

        template = Template(AIRFLOW_DAG_TEMPLATE)
        return template.render(
            project_name=self.config.project,
            pipeline_name=pipeline.pipeline,
            dag_id=f"odibi_{pipeline.pipeline}",
            owner=self.config.owner or "airflow",
            description=pipeline.description or "Odibi Pipeline",
            layer=pipeline.layer or "default",
            retries=self.config.retry.max_attempts if self.config.retry.enabled else 0,
            nodes=nodes_ctx,
        )
