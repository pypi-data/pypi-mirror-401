services:
  # === BACKEND SERVICE ===
  backend:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-backend:${VERSION:-latest}
    container_name: thoth-backend
    restart: always
    volumes:
      - thoth-backend-db:/app/backend_db
      - thoth-shared-data:/app/data
      - thoth-data-exchange:/app/data_exchange
      - thoth-logs:/app/logs
      - backend-static:/vol/static
      - backend-media:/vol/media
      - thoth-secrets:/vol/secrets
      - ./config.yml.local:/app/config.yml.local:ro
    env_file: .env.docker
    environment:
      - HOST_IP=host.docker.internal
      - DOCKER_ENV=production
      - DB_NAME_DOCKER=/app/backend_db/db.sqlite3
      - FRONTEND_URL=http://localhost:${FRONTEND_PORT:-3040}
      - AUTO_GENERATE_SECRETS=true
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/admin/login/" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 1200s
    depends_on:
      - thoth-qdrant

  # === FRONTEND SERVICE ===
  frontend:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-frontend:${VERSION:-latest}
    container_name: thoth-frontend
    restart: always
    ports:
      - "${FRONTEND_PORT:-3040}:3000"
    volumes:
      - frontend-cache:/app/.next/cache
      - thoth-secrets:/vol/secrets
      - thoth-data-exchange:/app/data_exchange:ro
    env_file: .env.docker
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - DJANGO_SERVER=http://proxy:80
      - SQL_GENERATOR_URL=http://sql-generator:8020
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
      - NEXT_PUBLIC_DJANGO_SERVER=http://localhost:${BACKEND_PORT:-8040}
      - NEXT_PUBLIC_SQL_GENERATOR_URL=http://localhost:${SQL_GENERATOR_PORT:-8020}
      - RUNTIME_BACKEND_URL=http://localhost:${WEB_PORT:-8040}
      - RUNTIME_SQL_GENERATOR_URL=http://localhost:${SQL_GENERATOR_PORT:-8020}
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
      - sql-generator

  # === SQL GENERATOR SERVICE ===
  sql-generator:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-sql-generator:${VERSION:-latest}
    container_name: thoth-sql-generator
    restart: always
    ports:
      - "${SQL_GENERATOR_PORT:-8020}:8020"
    volumes:
      - thoth-shared-data:/app/data
      - thoth-data-exchange:/app/data_exchange
      - thoth-logs:/app/logs
      - thoth-secrets:/vol/secrets
    env_file: .env.docker
    environment:
      - DOCKER_CONTAINER=true
      - HOST_IP=host.docker.internal
      - PORT=8020
      - DJANGO_SERVER=http://backend:8000
      - VECTOR_DB_HOST=thoth-qdrant
      - VECTOR_DB_PORT=6333
      - DB_ROOT_PATH=/app/data
    networks:
      - thoth-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
      - thoth-qdrant

  # === PROXY SERVICE ===
  proxy:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-proxy:${VERSION:-latest}
    container_name: thoth-proxy
    restart: always
    ports:
      - "${WEB_PORT:-8040}:80"
    volumes:
      - backend-static:/vol/static:ro
      - backend-media:/vol/media:ro
      - thoth-data-exchange:/vol/data_exchange:ro
    env_file: .env.docker
    environment:
      - APP_HOST=backend
      - APP_PORT=8000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=3000
      - SQL_GEN_HOST=sql-generator
      - SQL_GEN_PORT=8020
      - DEBUG=False
    networks:
      - thoth-network
    depends_on:
      backend:
        condition: service_healthy
      frontend:
        condition: service_started
      sql-generator:
        condition: service_started

  # === MERMAID SERVICE ===
  mermaid-service:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-mermaid-service:${VERSION:-latest}
    container_name: thoth-mermaid-service
    restart: always
    ports:
      - "${MERMAID_SERVICE_PORT:-8003}:8001"
    networks:
      - thoth-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8001/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # === VECTOR DATABASE SERVICE ===
  thoth-qdrant:
    image: qdrant/qdrant:latest
    container_name: thoth-qdrant
    restart: always
    ports:
      - "6333:6333"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - thoth-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:6333/" ]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  backend-static:
    name: thoth-backend-static
    external: true
  backend-media:
    name: thoth-backend-media
    external: true
  frontend-cache:
    name: thoth-frontend-cache
    external: true
  qdrant-data:
    name: thoth-qdrant-data
    external: true
  thoth-secrets:
    name: thoth-secrets
    external: true
  thoth-backend-db:
    name: thoth-backend-db
  thoth-logs:
    name: thoth-logs
  thoth-shared-data:
    name: thoth-shared-data
    external: true
  thoth-data-exchange:
    external: true

networks:
  thoth-network:
    external: true
    name: thoth-network
