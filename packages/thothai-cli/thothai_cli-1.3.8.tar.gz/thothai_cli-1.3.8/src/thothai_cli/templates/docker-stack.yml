# Copyright (c) 2025 Marco Pancotti
# This file is part of ThothAI and is released under the Apache 2.0.
# See the LICENSE.md file in the project root for full license information.
#
# Docker Stack configuration for Docker Swarm deployment
# Use: docker stack deploy -c docker-stack.yml thoth

version: '3.8'

services:
  # === BACKEND SERVICE ===
  backend:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-backend:${VERSION:-latest}
    networks:
      - thoth-network
    volumes:
      - thoth-backend-db:/app/backend_db
      - thoth-shared-data:/app/data
      - thoth-logs:/app/logs
      - backend-static:/vol/static
      - backend-media:/vol/media
      - thoth-data-exchange:/app/data_exchange
      - thoth-backend-secrets:/vol/secrets
    environment:
      - HOST_IP=host.docker.internal
      - DOCKER_ENV=production
      - DB_NAME_DOCKER=/app/backend_db/db.sqlite3
      - FRONTEND_URL=http://localhost:${FRONTEND_PORT:-3040}
      - DOCKER_CONTAINER=true
      - AUTO_GENERATE_SECRETS=true
    secrets:
      - ${STACK_NAME:-thothai-swarm}_thoth_env_config
      - source: ${STACK_NAME:-thothai-swarm}_thoth_config_yml
        target: /app/config.yml.local
    configs:
      - source: ${STACK_NAME:-thothai-swarm}_thoth_env_docker
        target: /app/.env.docker
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/admin/login/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 1200s
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=backend"
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # === FRONTEND SERVICE ===
  frontend:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-frontend:${VERSION:-latest}
    networks:
      - thoth-network
    ports:
      - target: 3000
        published: ${FRONTEND_PORT:-3040}
        protocol: tcp
        mode: ingress
    volumes:
      - frontend-cache:/app/.next/cache
      - thoth-data-exchange:/app/data_exchange:ro
      - thoth-backend-secrets:/vol/secrets:ro
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - DJANGO_SERVER=http://proxy:80
      - SQL_GENERATOR_URL=http://sql-generator:8020
      - DOCKER_CONTAINER=true
      # Build-time embedded (for client-side fallback)
      - NEXT_PUBLIC_DJANGO_SERVER=http://localhost:${WEB_PORT}
      - NEXT_PUBLIC_SQL_GENERATOR_URL=http://localhost:${SQL_GENERATOR_PORT}
      # Runtime variables for /api/config endpoint
      # Runtime variables for /api/config endpoint
      # The frontend container needs to know where the Proxy is (Gateway)
      # In execution, this points to the external URL of the Proxy
      - RUNTIME_BACKEND_URL=http://localhost:${WEB_PORT}
      - RUNTIME_SQL_GENERATOR_URL=http://localhost:${SQL_GENERATOR_PORT}
    secrets:
      - ${STACK_NAME:-thothai-swarm}_thoth_env_config
    configs:
      - source: ${STACK_NAME:-thothai-swarm}_thoth_env_docker
        target: /app/.env.docker
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=frontend"
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.25'
          memory: 512M

  # === SQL GENERATOR SERVICE ===
  sql-generator:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-sql-generator:${VERSION:-latest}
    networks:
      - thoth-network
    ports:
      - target: 8020
        published: ${SQL_GENERATOR_PORT:-8020}
        protocol: tcp
        mode: ingress
    volumes:
      - thoth-shared-data:/app/data
      - thoth-logs:/app/logs
      - thoth-data-exchange:/app/data_exchange
      - thoth-backend-secrets:/vol/secrets:ro
    environment:
      - DOCKER_CONTAINER=true
      - PORT=8020
      - DJANGO_SERVER=http://backend:8000
      - VECTOR_DB_HOST=thoth-qdrant
      - VECTOR_DB_PORT=6333
      - DB_ROOT_PATH=/app/data
    secrets:
      - ${STACK_NAME:-thothai-swarm}_thoth_env_config
    configs:
      - source: ${STACK_NAME:-thothai-swarm}_thoth_env_docker
        target: /app/.env.docker
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=sql-generator"
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G

  # === PROXY SERVICE ===
  # Nginx reverse proxy for Django (required for static files in production)
  proxy:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-proxy:${VERSION:-latest}
    networks:
      - thoth-network
    ports:
      - target: 80
        published: ${WEB_PORT:-7010}
        protocol: tcp
        mode: ingress
    volumes:
      - backend-static:/vol/static:ro
      - backend-media:/vol/media:ro
      - thoth-data-exchange:/vol/data_exchange:ro
    environment:
      - APP_HOST=backend
      - APP_PORT=8000
      - FRONTEND_HOST=frontend
      - FRONTEND_PORT=3000
      - SQL_GEN_HOST=sql-generator
      - SQL_GEN_PORT=8020
      - DEBUG=False
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=proxy"
      replicas: 2
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.1'
          memory: 128M

  # === MERMAID SERVICE ===
  mermaid-service:
    image: ${DOCKER_USERNAME:-tylconsulting}/thoth-mermaid-service:${VERSION:-latest}
    networks:
      - thoth-network
    ports:
      - target: 8001
        published: ${MERMAID_SERVICE_PORT:-8003}
        protocol: tcp
        mode: ingress
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=mermaid"
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '0.5'
          memory: 1G
        reservations:
          cpus: '0.1'
          memory: 256M

  # === VECTOR DATABASE SERVICE ===
  thoth-qdrant:
    image: qdrant/qdrant:latest
    networks:
      - thoth-network
    ports:
      - target: 6333
        published: ${QDRANT_PORT:-6333}
        protocol: tcp
        mode: ingress
    volumes:
      - qdrant-data:/qdrant/storage
    deploy:
      labels:
        - "com.docker.stack.namespace=thothai-swarm"
        - "com.thoth.project=thoth-ai"
        - "com.thoth.service=qdrant"
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 2G
        reservations:
          cpus: '0.25'
          memory: 512M

volumes:
  backend-static:
    driver: local
  backend-media:
    driver: local
  frontend-cache:
    driver: local
  qdrant-data:
    driver: local
  thoth-backend-db:
    driver: local
  thoth-backend-secrets:
    driver: local
  thoth-logs:
    driver: local
  thoth-shared-data:
    driver: local
  thoth-data-exchange:
    driver: local

networks:
  thoth-network:
    driver: overlay
    attachable: true

secrets:
  ${STACK_NAME:-thothai-swarm}_thoth_env_config:
    external: true
  ${STACK_NAME:-thothai-swarm}_thoth_config_yml:
    external: true

configs:
  ${STACK_NAME:-thothai-swarm}_thoth_env_docker:
    external: true
