# failcore/api/run.py
"""
Run API - run context manager entry point
"""

from typing import Optional, Dict, Any
from .context import RunCtx


def run(
    policy: str = "safe",
    sandbox: Optional[str] = None,
    trace: str = "auto",
    strict: bool = True,
    run_id: Optional[str] = None,
    tags: Optional[Dict[str, str]] = None,
    auto_ingest: bool = True,
    allow_outside_root: bool = False,
    allowed_trace_roots: Optional[list] = None,
    allowed_sandbox_roots: Optional[list] = None,
    # Cost guardrails (budget enforcement)
    max_cost_usd: Optional[float] = None,
    max_tokens: Optional[int] = None,
    max_usd_per_minute: Optional[float] = None,
    # Guard configuration (per-run)
    guards: Optional[Any] = None,  # Optional GuardConfig
) -> RunCtx:
    r"""
    Create a run context manager with intelligent path resolution.
    
    Path Resolution Rules:
    
    1. Name-only (no path separators):
       - trace="trace.jsonl" → <project>/.failcore/runs/<run>/trace.jsonl
       - sandbox="data" → <project>/.failcore/runs/<run>/sandbox/data/
    
    2. Relative path (contains / or \, not absolute):
       - trace="artifacts/demo.jsonl" → <project>/artifacts/demo.jsonl
       - sandbox="work/sandboxA" → <project>/work/sandboxA/
    
    3. Absolute path (fully qualified):
       - trace="/home/user/project/data/trace.jsonl" → Resolved as-is
       - sandbox="C:\\project\\data" → Resolved as-is (Windows)
    
    Security Constraints (default behavior):
    - All paths (relative or absolute) MUST stay within project root
    - Path traversal (..) is blocked if it escapes project root
    - No special permission needed for absolute paths (just a format)
    
    External Paths (whitelist mechanism):
    - Set allow_outside_root=True to enable external paths
    - Provide allowed_trace_roots=[] for trace whitelist
    - Provide allowed_sandbox_roots=[] for sandbox whitelist
    - Only paths within whitelist are allowed outside project root
    
    Args:
        policy: Policy name (default: "safe" = fs_safe + net_safe)
            - "safe": Combined fs_safe + net_safe preset
            - "fs_safe": File system safety only
            - "net_safe": Network safety only
            - None: No policy
        sandbox: Sandbox root directory
            - None (default): <project>/.failcore/sandbox/
            - Name-only: <project>/.failcore/runs/<run>/sandbox/<name>/
            - Relative: <project>/<path>/
            - Absolute: Rejected unless allow_absolute_paths=True
        trace: Trace file path
            - "auto" (default): <project>/.failcore/runs/<date>/<run_id>_<time>/trace.jsonl
            - Name-only: <project>/.failcore/runs/<run>/trace/<name>
            - Relative: <project>/<path>
            - Absolute: Rejected unless allow_absolute_paths=True
            - None: Disable tracing
        strict: Enable strict validation (default: True)
        run_id: Optional run ID (auto-generated by default)
        tags: Optional tags for trace filtering
        auto_ingest: Auto-ingest trace to database on close (default: True)
        allow_outside_root: Allow paths outside project root (default: False)
            - Requires explicit whitelist (allowed_trace_roots or allowed_sandbox_roots)
            - Security: Only whitelisted root directories are allowed
        allowed_trace_roots: Whitelist of allowed trace root directories
            - Example: [Path("/tmp"), Path("/var/log")]
            - Only effective when allow_outside_root=True
            - Trace paths must be within one of these roots
        allowed_sandbox_roots: Whitelist of allowed sandbox root directories
            - Example: [Path("/tmp/sandbox"), Path("/opt/data")]
            - Only effective when allow_outside_root=True
            - Sandbox paths must be within one of these roots
        max_cost_usd: Maximum total cost in USD (default: None = unlimited)
            - Example: max_cost_usd=1.0 limits run to $1.00
            - Automatically creates CostGuardian for budget enforcement
        max_tokens: Maximum total tokens (default: None = unlimited)
            - Example: max_tokens=10000 limits run to 10k tokens
        max_usd_per_minute: Maximum burn rate in USD/minute (default: None = unlimited)
            - Example: max_usd_per_minute=0.5 limits spending velocity to $0.50/min
            - Uses sliding window for burn rate calculation
    
    Returns:
        RunCtx: Run context object
    
    Example - Method 1: Explicit tool registration and calling:
        >>> from failcore import run
        >>> 
        >>> with run(policy="fs_safe", sandbox="./data", strict=True) as ctx:
        ...     ctx.tool(write_file)
        ...     ctx.call("write_file", path="a.txt", content="hi")
        ...     print(ctx.trace_path)
    
    Example - Method 2: Decorator style with @guard():
        >>> from failcore import run, guard
        >>> 
        >>> with run(policy="fs_safe", sandbox="./data", strict=True) as ctx:
        ...     @guard()
        ...     def write_file(path: str, content: str):
        ...         with open(path, "w") as f:
        ...             f.write(content)
        ...     
        ...     write_file(path="a.txt", content="hi")
        ...     print(ctx.trace_path)
    
    Example - Custom trace path:
        >>> with run(trace="my_trace.jsonl") as ctx:
        ...     ctx.tool(my_function)
        ...     ctx.call("my_function", arg=123)
    
    Example - Disable tracing:
        >>> with run(trace=None) as ctx:
        ...     ctx.call("some_tool")
    
    Example - Disable auto-ingest:
        >>> with run(auto_ingest=False) as ctx:
        ...     ctx.call("some_tool")
    
    Example - External paths with whitelist:
        >>> import tempfile
        >>> from pathlib import Path
        >>> 
        >>> # Allow trace in system temp directory
        >>> temp_dir = Path(tempfile.gettempdir())
        >>> with run(
        ...     trace=str(temp_dir / "external_trace.jsonl"),
        ...     allow_outside_root=True,
        ...     allowed_trace_roots=[temp_dir]
        ... ) as ctx:
        ...     ctx.call("some_tool")
    
    Note:
        - Within the with block, this context automatically becomes the global current context
        - @guard() decorator will automatically use this context's configuration
        - Same trace / sandbox / policy is shared across all tools in the run() block
    
    Security Philosophy:
        - Path format (absolute vs relative) is just syntax, not security
        - Security boundary is project root - always enforced
        - No special permission needed for absolute paths
        - Clear, predictable behavior without security surprises
    """
    return RunCtx(
        policy=policy,
        sandbox=sandbox,
        trace=trace,
        strict=strict,
        run_id=run_id,
        tags=tags,
        auto_ingest=auto_ingest,
        allow_outside_root=allow_outside_root,
        allowed_trace_roots=allowed_trace_roots,
        allowed_sandbox_roots=allowed_sandbox_roots,
        # Cost guardrails
        max_cost_usd=max_cost_usd,
        max_tokens=max_tokens,
        max_usd_per_minute=max_usd_per_minute,
        guard_config=guards,
    )
