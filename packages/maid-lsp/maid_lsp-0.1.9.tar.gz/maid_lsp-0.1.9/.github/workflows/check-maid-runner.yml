name: Check maid-runner Updates

on:
  schedule:
    # Run daily at 9:00 AM UTC
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    name: Check for maid-runner updates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Get current and latest versions
        id: versions
        run: |
          set -e  # Exit on any error

          # Extract current version requirement from pyproject.toml
          CURRENT_REQ=$(grep -oP 'maid-runner>=\K[0-9]+\.[0-9]+\.[0-9]+' pyproject.toml || true)
          if [ -z "$CURRENT_REQ" ]; then
            echo "::error::Failed to extract current maid-runner version from pyproject.toml"
            exit 1
          fi
          echo "current=$CURRENT_REQ" >> $GITHUB_OUTPUT

          # Get latest version from PyPI with validation
          PYPI_RESPONSE=$(curl -sf https://pypi.org/pypi/maid-runner/json) || {
            echo "::error::Failed to fetch maid-runner info from PyPI"
            exit 1
          }
          LATEST=$(echo "$PYPI_RESPONSE" | python3 -c "import sys, json; print(json.load(sys.stdin)['info']['version'])" 2>/dev/null) || {
            echo "::error::Failed to parse PyPI JSON response"
            exit 1
          }
          # Validate version format (semver)
          if ! echo "$LATEST" | grep -qP '^[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "::error::Invalid version format from PyPI: $LATEST"
            exit 1
          fi
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          # Get current maid-lsp version
          CURRENT_LSP_VERSION=$(grep -oP '__version__ = "\K[0-9]+\.[0-9]+\.[0-9]+' maid_lsp/__init__.py || true)
          if [ -z "$CURRENT_LSP_VERSION" ]; then
            echo "::error::Failed to extract current maid-lsp version from __init__.py"
            exit 1
          fi
          echo "current_lsp=$CURRENT_LSP_VERSION" >> $GITHUB_OUTPUT

          # Calculate new patch version
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_LSP_VERSION"
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "new_lsp=$NEW_VERSION" >> $GITHUB_OUTPUT

          # Check if update is needed
          if [ "$CURRENT_REQ" != "$LATEST" ]; then
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

          echo "Current maid-runner: $CURRENT_REQ"
          echo "Latest maid-runner: $LATEST"
          echo "Current maid-lsp: $CURRENT_LSP_VERSION"
          echo "New maid-lsp: $NEW_VERSION"

      - name: Check if PR already exists
        id: check_pr
        if: steps.versions.outputs.update_needed == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          EXISTING_PR=$(gh pr list --search "Update maid-runner to ${{ steps.versions.outputs.latest }}" --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "PR #$EXISTING_PR already exists for this update"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update files
        if: steps.versions.outputs.update_needed == 'true' && steps.check_pr.outputs.exists == 'false'
        env:
          CURRENT: ${{ steps.versions.outputs.current }}
          LATEST: ${{ steps.versions.outputs.latest }}
          CURRENT_LSP: ${{ steps.versions.outputs.current_lsp }}
          NEW_LSP: ${{ steps.versions.outputs.new_lsp }}
        run: |
          set -e

          # Update pyproject.toml
          sed -i "s/maid-runner>=${CURRENT}/maid-runner>=${LATEST}/" pyproject.toml
          sed -i "s/^version = \"${CURRENT_LSP}\"/version = \"${NEW_LSP}\"/" pyproject.toml

          # Update __init__.py
          sed -i "s/__version__ = \"${CURRENT_LSP}\"/__version__ = \"${NEW_LSP}\"/" maid_lsp/__init__.py

          # Update CHANGELOG.md using Python for reliable multi-line handling
          python3 << 'PYTHON_SCRIPT'
          import os
          import re
          import textwrap
          import subprocess

          current = os.environ['CURRENT']
          latest = os.environ['LATEST']
          current_lsp = os.environ['CURRENT_LSP']
          new_lsp = os.environ['NEW_LSP']

          today = subprocess.check_output(['date', '+%Y-%m-%d']).decode().strip()

          with open('CHANGELOG.md', 'r') as f:
              content = f.read()

          # Create new changelog entry
          new_entry = textwrap.dedent(f'''\
              ## [{new_lsp}] - {today}

              ### Changed
              - Bump maid-runner dependency from >={current} to >={latest}

              ''')

          # Insert after [Unreleased] section
          content = re.sub(
              r'(## \[Unreleased\]\n)',
              r'\1\n' + new_entry,
              content
          )

          # Update [Unreleased] comparison link
          content = re.sub(
              rf'\[Unreleased\]: (.*)/compare/v{re.escape(current_lsp)}\.\.\.HEAD',
              rf'[Unreleased]: \1/compare/v{new_lsp}...HEAD',
              content
          )

          # Add new version comparison link after [Unreleased] link
          new_link = f'[{new_lsp}]: https://github.com/mamertofabian/maid-lsp/compare/v{current_lsp}...v{new_lsp}'
          content = re.sub(
              r'(\[Unreleased\]: .*\n)',
              rf'\1{new_link}\n',
              content
          )

          with open('CHANGELOG.md', 'w') as f:
              f.write(content)

          print(f"Updated CHANGELOG.md with version {new_lsp}")
          PYTHON_SCRIPT

      - name: Create Pull Request
        if: steps.versions.outputs.update_needed == 'true' && steps.check_pr.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST: ${{ steps.versions.outputs.latest }}
          NEW_LSP: ${{ steps.versions.outputs.new_lsp }}
          CURRENT: ${{ steps.versions.outputs.current }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH="deps/update-maid-runner-${LATEST}"

          # Delete remote branch if it exists (from previous failed run)
          git push origin --delete "$BRANCH" 2>/dev/null || true

          git checkout -b "$BRANCH"

          git add pyproject.toml maid_lsp/__init__.py CHANGELOG.md
          git commit -m "chore(deps): update maid-runner to ${LATEST}"

          git push origin "$BRANCH"

          gh pr create \
            --title "chore(deps): update maid-runner to ${LATEST}" \
            --body "## Summary

          This PR automatically updates the \`maid-runner\` dependency to version **${LATEST}**.

          ### Changes
          - \`pyproject.toml\`: Updated maid-runner from >=${CURRENT} to >=${LATEST}
          - \`pyproject.toml\`: Bumped maid-lsp version to ${NEW_LSP}
          - \`maid_lsp/__init__.py\`: Updated \`__version__\` to ${NEW_LSP}
          - \`CHANGELOG.md\`: Added entry for version ${NEW_LSP}

          ### Release
          Once this PR is merged, a new release (v${NEW_LSP}) will be automatically created and published to PyPI.

          ---
          *This PR was automatically created by the check-maid-runner workflow.*" \
            --label "dependencies,automated-pr"

      - name: Summary
        run: |
          if [ "${{ steps.versions.outputs.update_needed }}" == "true" ]; then
            if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
              echo "### PR already exists" >> $GITHUB_STEP_SUMMARY
              echo "A PR for maid-runner ${{ steps.versions.outputs.latest }} already exists." >> $GITHUB_STEP_SUMMARY
            else
              echo "### Update PR Created" >> $GITHUB_STEP_SUMMARY
              echo "- **Current**: maid-runner ${{ steps.versions.outputs.current }}" >> $GITHUB_STEP_SUMMARY
              echo "- **Latest**: maid-runner ${{ steps.versions.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
              echo "- **New maid-lsp version**: ${{ steps.versions.outputs.new_lsp }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "### No updates needed" >> $GITHUB_STEP_SUMMARY
            echo "maid-runner is already at the latest version (${{ steps.versions.outputs.current }})." >> $GITHUB_STEP_SUMMARY
          fi
