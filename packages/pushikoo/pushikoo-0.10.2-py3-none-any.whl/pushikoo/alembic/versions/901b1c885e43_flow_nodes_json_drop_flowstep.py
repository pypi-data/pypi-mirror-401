"""flow nodes json, drop flowstep

Revision ID: 901b1c885e43
Revises: bfbf041984e0
Create Date: 2025-12-12 21:04:24.622593

"""

from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
import pushikoo


# revision identifiers, used by Alembic.
revision: str = "901b1c885e43"
down_revision: Union[str, None] = "bfbf041984e0"
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    """Upgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "flow",
        sa.Column("id", sa.Uuid(), nullable=False),
        sa.Column("nodes", pushikoo.util.db.JSONField(), nullable=True),
        sa.PrimaryKeyConstraint("id"),
    )
    op.drop_table("adapterinstancepair")
    op.drop_table("pushtask")
    # ### end Alembic commands ###


def downgrade() -> None:
    """Downgrade schema."""
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table(
        "pushtask",
        sa.Column("id", sa.CHAR(length=32), nullable=False),
        sa.Column("pusher_instance_id", sa.CHAR(length=32), nullable=False),
        sa.Column("message_id", sa.CHAR(length=32), nullable=False),
        sa.Column("status", sa.VARCHAR(), nullable=False),
        sa.Column("retry_count", sa.INTEGER(), nullable=False),
        sa.Column("created_at", sa.DATETIME(), nullable=False),
        sa.ForeignKeyConstraint(
            ["message_id"],
            ["message.id"],
        ),
        sa.ForeignKeyConstraint(
            ["pusher_instance_id"],
            ["adapterinstance.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "pusher_instance_id", "message_id", name=op.f("uix_pusher_message")
        ),
    )
    op.create_table(
        "adapterinstancepair",
        sa.Column("id", sa.CHAR(length=32), nullable=False),
        sa.Column("getter_instance_id", sa.CHAR(length=32), nullable=False),
        sa.Column("pusher_instance_id", sa.CHAR(length=32), nullable=False),
        sa.ForeignKeyConstraint(
            ["getter_instance_id"],
            ["adapterinstance.id"],
        ),
        sa.ForeignKeyConstraint(
            ["pusher_instance_id"],
            ["adapterinstance.id"],
        ),
        sa.PrimaryKeyConstraint("id"),
        sa.UniqueConstraint(
            "getter_instance_id",
            "pusher_instance_id",
            name=op.f("uix_getter_pusher_pair"),
        ),
    )
    op.drop_table("flow")
    # ### end Alembic commands ###
