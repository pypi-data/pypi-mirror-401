# **MethyAnno: An Interpretable Automated Annotation Method Leveraging Multi-scale Information and Metric Learning Framework for scDNAm Data**

![MethyAnno](./MethyAnno.png)

## Introduction
**MethyAnno** is an interpretable deep metric learning framework that leverages multi-scale information for **accurate cell type annotation of scDNAm data**. 

Additionally, MethyAnno enables **generalized category discovery (GCD)** in open-set scenarios by utilizing density-based clustering to automatically estimate the number of novel cell types, while simultaneously deciphering **cell-type-specific epigenetic signatures** for biological interpretability.

## Installation

It's prefered to create a new environment for MethyAnno:

```python
conda create -n MethyAnno python==3.10
conda activate MethyAnno
```

MethyAnno is available on PyPI, and could be installed using:

```python
pip install scMethyAnno
```

This process will take approximately 5 to 10 minutes, depending on the user's computer device and internet connectivition.

## Quick Start

The main function `scMethyAnno.MethyAnno_train_test` can perform cell type annotation, identification of novel cell types, and model interpretation. If you do not wish to modify the parameter settings for the model, you can conveniently use the MethyAnno model by simply importing `scMethyAnno.MethyAnno_train_test`.

```python
from scMethyAnno import MethyAnno_train_test
```

### 1. Data

You should input the scDNAm data as **AnnData** object. Make sure that the column name corresponding to the cell type and the column name corresponding to the feature (genomic region) in training set and test set are identical.

### 2. Model

#### Cell type annotation

```python
MethyAnno_train_test(train_adata, 
                    test_adata, 
                    target_colname,
                    output_dir, 
                    device,
                    is_calculate_metric,  
                    is_discover_novel_type,
                    is_interpret_model)
```

| Parameter | Type | Description |
| :--- | :--- | :--- |
| `adata_train` | `anndata.AnnData` | The training `AnnData` object. It must contain the column specified by `target_colname` to serve as labels. |
| `adata_test` | `anndata.AnnData` | The testing `AnnData` object. |
| `target_colname` | `str` | The name of the column containing cell type labels (e.g., `'cell_type'`). |
| `output_dir`  | `str` | The base directory path where results, models, and other output files should be saved. |
| `device` | `torch.device` | The device to be used for training.|
| `is_calculate_metric` | `bool`, optional | Whether to calculate classification metrics (ACC/Kappa/F1). Default is `False`. |
| `is_discover_novel_type` | `bool`, optional | Whether to perform novel cell type discovery. Default is `False`. |
| `is_interpret_model` | `bool`, optional | Whether to perform model interpretability analysis (extracting cell-type-specific features). Default is `False`. |


After execution, MethyAnno will save the output to the folder `output_dir`. This folder will contain the following outputs: `pre_result.csv`, `report.csv`, `model.pth`, `novel_umap.pdf`, `novel_res.csv` and files in `bed` format in `features` folder.

| Output files  | Description                                                  |
| ------------- | ------------------------------------------------------------ |
| `pre_result.csv `   | The annotation results generated by MethyAnno.                  |
| `report.csv`  | The model's performance scores based on four evaluation metrics. |
| `model.pth`  | A saved model file containing the weights of the model. |
| `novel_umap.pdf`    | UMAP plot of the novel cell type discovery results for the test set. |
| `novel_res.csv`    | The novel cell type discovery results generated by MethyAnno. |
| `./features/celltype.bed`    | Cell type-specific features identified for each cell type. |


#### Identify novel cell type

```python
MethyAnno_train_test(train_adata, test_adata, target_colname, output_dir, device,is_discover_novel_type=True)
```

Once the parameter `is_discover_novel_type` is set to `True`, MethyAnno will identify the novel types in test set to `Novel type` and saves them in `novel_res.csv`.

#### Explain the model

```python
MethyAnno_train_test(train_adata, test_adata, target_colname, output_dir, device,is_interpret_model=True)
```

Once `is_interpret_model` is set to `True`, MethyAnno will iterate through all cell types in the training set, identify cell-type-specific features, and save the cell-type-specific features for each cell type and background features in bed format. The features are saved in `output_dir/features/` folder.

