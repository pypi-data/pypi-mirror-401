Metadata-Version: 2.4
Name: pytest-mark-integration
Version: 1.0.1
Summary: Pytest plugin for automatic integration test marking and management
Project-URL: Bug Tracker, https://github.com/xykong/pytest-mark-integration/issues
Project-URL: Changelog, https://github.com/xykong/pytest-mark-integration/blob/main/CHANGELOG.md
Project-URL: Documentation, https://github.com/xykong/pytest-mark-integration#readme
Project-URL: Homepage, https://github.com/xykong/pytest-mark-integration
Project-URL: Repository, https://github.com/xykong/pytest-mark-integration
Author-email: "xy.kong" <xy.kong@gmail.com>
Maintainer-email: "xy.kong" <xy.kong@gmail.com>
License: Apache-2.0
License-File: LICENSE
Keywords: integration,plugin,pytest,test-automation,testing
Classifier: Development Status :: 4 - Beta
Classifier: Framework :: Pytest
Classifier: Intended Audience :: Developers
Classifier: License :: OSI Approved :: Apache Software License
Classifier: Operating System :: OS Independent
Classifier: Programming Language :: Python
Classifier: Programming Language :: Python :: 3
Classifier: Programming Language :: Python :: 3.10
Classifier: Programming Language :: Python :: 3.11
Classifier: Programming Language :: Python :: 3.12
Classifier: Programming Language :: Python :: 3.13
Classifier: Programming Language :: Python :: 3.14
Classifier: Topic :: Software Development :: Quality Assurance
Classifier: Topic :: Software Development :: Testing
Requires-Python: >=3.10
Requires-Dist: pytest>=7.0.0
Provides-Extra: dev
Requires-Dist: black>=23.0.0; extra == 'dev'
Requires-Dist: mypy>=1.0.0; extra == 'dev'
Requires-Dist: pytest-cov>=4.0.0; extra == 'dev'
Requires-Dist: pytest-timeout>=2.0.0; extra == 'dev'
Requires-Dist: ruff>=0.1.0; extra == 'dev'
Description-Content-Type: text/markdown

# pytest-mark-integration

[![PyPI version](https://badge.fury.io/py/pytest-mark-integration.svg)](https://pypi.org/project/pytest-mark-integration/)
[![Python versions](https://img.shields.io/pypi/pyversions/pytest-mark-integration.svg)](https://pypi.org/project/pytest-mark-integration/)
[![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

A pytest plugin for automatic integration test marking and management.

## Features

- ğŸ¯ **Automatic Test Marking**: Automatically marks tests as integration tests based on file path patterns
- ğŸ›ï¸ **Flexible Configuration**: Configure default behavior via `pytest.ini` or `pyproject.toml`
- âš¡ **Smart Test Ordering**: Runs unit tests before integration tests for faster feedback
- ğŸš¦ **Fail-Fast Support**: Optionally skip integration tests when unit tests fail
- ğŸ”Œ **Plugin Integration**: Seamlessly integrates with `pytest-cov` and `pytest-timeout`
- ğŸšï¸ **Command-Line Control**: Override default behavior with `--with-integration` and `--without-integration` flags

## Installation

Install using pip:

```bash
pip install pytest-mark-integration
```

Or using uv:

```bash
uv add pytest-mark-integration --dev
```

## Quick Start

Once installed, the plugin automatically activates. By default:

1. **Tests are automatically marked** if their file path contains `integration`
2. **Integration tests run by default** (configurable)
3. **Unit tests run before integration tests** (for faster feedback)

### Example Test Structure

```
your_project/
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ unit/
â”‚   â”‚   â””â”€â”€ test_utils.py           # Not marked (runs first)
â”‚   â”œâ”€â”€ integration/
â”‚   â”‚   â””â”€â”€ test_api.py              # Auto-marked as integration
â”‚   â””â”€â”€ test_db_integration.py       # Auto-marked (path contains "integration")
```

### Running Tests

```bash
# Run all tests (including integration tests)
pytest

# Skip integration tests
pytest --without-integration

# Run only integration tests
pytest --with-integration -m integration

# Run tests with coverage (integration tests excluded from coverage by default)
pytest --cov
```

## Configuration

### Configuration Options

Configure via `pytest.ini`:

```ini
[pytest]
# Run integration tests by default (default: true)
run_integration_by_default = true

# Skip integration tests if unit tests fail (default: true)
fail_fast_on_unit_test_failure = true
```

Or via `pyproject.toml`:

```toml
[tool.pytest.ini_options]
run_integration_by_default = true
fail_fast_on_unit_test_failure = true
```

### Command-Line Options

| Option                                | Description                                                      |
| ------------------------------------- | ---------------------------------------------------------------- |
| `--with-integration`                  | Run integration tests (overrides config)                         |
| `--without-integration`               | Skip integration tests (overrides config)                        |
| `--integration-cover`                 | Include integration tests in coverage reports                    |
| `--integration-timeout SECONDS`       | Set timeout for integration tests (requires `pytest-timeout`)    |
| `--integration-timeout-method METHOD` | Timeout method: `thread` or `signal` (requires `pytest-timeout`) |

## How It Works

### Automatic Marking

The plugin automatically adds the `@pytest.mark.integration` marker to tests when:

1. The test file path contains the word `integration` (case-insensitive)
2. The test is manually decorated with `@pytest.mark.integration`

**Note**: The plugin uses paths relative to the pytest root directory to avoid false positives from parent directory names containing "integration".

**Examples of auto-marked tests:**

```python
# tests/integration/test_api.py - âœ… Auto-marked
def test_api_endpoint():
    pass

# tests/test_database_integration.py - âœ… Auto-marked
def test_db_connection():
    pass

# integration_tests/test_system.py - âœ… Auto-marked
def test_full_system():
    pass

# tests/unit/test_helpers.py - âŒ Not marked
def test_helper_function():
    pass
```

### Test Execution Priority

The plugin ensures integration tests run **after** unit tests:

```
Execution Order:
1. Unit tests (no integration marker) âš¡ Fast
2. Integration tests (@pytest.mark.integration) ğŸ¢ Slower
```

This provides:

- **Faster feedback** during development
- **Efficient CI/CD** pipelines (fail fast on basic issues)

### Fail-Fast Behavior

When `fail_fast_on_unit_test_failure = true` (default):

```
Unit Test â†’ FAIL âŒ
  â†“
Integration Tests â†’ SKIPPED â­ï¸
  â†“
Reason: "Skipping integration tests due to unit test failure"
```

This saves time by not running expensive integration tests when basic functionality is broken.

## Manual Marking

You can still manually mark tests:

```python
import pytest

@pytest.mark.integration
def test_external_api():
    """This test will be treated as an integration test"""
    pass
```

## Integration with Other Plugins

### pytest-cov (Coverage)

By default, integration tests **do not contribute** to coverage reports (since unit tests should cover all code).

```bash
# Integration tests excluded from coverage
pytest --cov

# Include integration tests in coverage
pytest --cov --integration-cover
```

### pytest-timeout

Set timeouts specifically for integration tests:

```bash
# Set 60-second timeout for integration tests
pytest --integration-timeout 60

# Use signal-based timeout method
pytest --integration-timeout 60 --integration-timeout-method signal
```

### pytest-xdist (Parallel Execution)

The plugin is compatible with pytest-xdist for parallel test execution:

```bash
# Run tests in parallel across 4 workers
pytest -n 4
```

**Note**: In parallel mode, fail-fast behavior may not work perfectly since tests are distributed across multiple processes.

## Configuration Priority

The plugin respects the following priority order:

1. **Command-line flags** (highest priority)

   - `--with-integration` â†’ Always run integration tests
   - `--without-integration` â†’ Always skip integration tests

2. **Configuration file** (medium priority)

   - `run_integration_by_default = true/false`

3. **Default behavior** (lowest priority)
   - Run integration tests (`run_integration_by_default` defaults to `true`)

## Use Cases

### Local Development

Fast feedback loop - skip slow integration tests:

```bash
# In pytest.ini
run_integration_by_default = false
```

```bash
pytest  # Only unit tests run
```

### CI/CD Pipeline

Run all tests in CI:

```bash
# In pyproject.toml
run_integration_by_default = true
fail_fast_on_unit_test_failure = true
```

```bash
pytest  # All tests run, fail fast if unit tests fail
```

### Pre-commit Hook

Quick validation before committing:

```bash
pytest --without-integration
```

### Integration Test Suite

Run only integration tests:

```bash
pytest --with-integration -m integration
```

## Examples

### Example 1: Mixed Test Suite

```python
# tests/unit/test_calculator.py
def test_add():
    assert 1 + 1 == 2  # Runs first

# tests/integration/test_api.py
def test_api_health():
    response = requests.get("http://api.example.com/health")
    assert response.status_code == 200  # Runs second

# tests/test_database_integration.py
def test_database_connection():
    db = Database()
    assert db.connect()  # Runs third (auto-marked due to filename)
```

```bash
$ pytest -v
tests/unit/test_calculator.py::test_add PASSED             [ 33%]
tests/integration/test_api.py::test_api_health PASSED      [ 66%]
tests/test_database_integration.py::test_database_connection PASSED [100%]
```

### Example 2: Skip Integration Tests

```bash
$ pytest --without-integration -v
tests/unit/test_calculator.py::test_add PASSED             [100%]
tests/integration/test_api.py::test_api_health SKIPPED     (Integration tests skipped)
tests/test_database_integration.py::test_database_connection SKIPPED (Integration tests skipped)
```

### Example 3: Fail-Fast Behavior

```python
# tests/unit/test_calculator.py
def test_add():
    assert 1 + 1 == 3  # âŒ FAILS

# tests/integration/test_api.py
def test_api_health():
    # This test is skipped because unit test failed
    pass
```

```bash
$ pytest -v
tests/unit/test_calculator.py::test_add FAILED             [50%]
tests/integration/test_api.py::test_api_health SKIPPED     [100%]
(Skipping integration tests due to unit test failure)
```

## Troubleshooting

### Integration Tests Not Being Marked

**Problem**: Tests in integration paths aren't being marked.

**Solution**: Ensure the file path (not just the directory name) contains `integration`:

```bash
# âœ… Correct
tests/integration/test_api.py
tests/test_integration_api.py

# âŒ Won't work
int/test_api.py  # "integration" not in path
```

**Note**: The plugin uses paths relative to the pytest root directory. If you're running tests from a subdirectory, ensure the relative path from the project root contains "integration".

### Integration Tests Still Running After Unit Test Failure

**Problem**: Integration tests run even when unit tests fail.

**Solution**: Enable fail-fast in configuration:

```ini
[pytest]
fail_fast_on_unit_test_failure = true
```

### Coverage Reports Include Integration Tests

**Problem**: Integration tests are included in coverage reports.

**Solution**: Remove `--integration-cover` flag (it's disabled by default):

```bash
pytest --cov  # Integration tests excluded
```

## Development

### Setup Development Environment

```bash
# Clone repository
git clone https://github.com/yourusername/pytest-mark-integration.git
cd pytest-mark-integration

# Install dependencies with uv
uv sync --all-extras

# Or with pip
pip install -e ".[dev]"
```

### Run Tests

```bash
make test
```

### Code Quality

```bash
# Format code
make format

# Lint code
make lint

# Type check
make typecheck
```

### Build and Publish

```bash
# Build distribution
make build

# Publish to TestPyPI
make publish-test

# Publish to PyPI
make publish
```

## Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the Apache License 2.0 - see the [LICENSE](LICENSE) file for details.

## Comparison with Similar Projects

This plugin combines and improves upon features from two existing projects:

### Feature Comparison

| Feature                          | **pytest-mark-integration** (This Project) | pytest-integration                 | pytest-integration-mark             |
| -------------------------------- | ------------------------------------------ | ---------------------------------- | ----------------------------------- |
| **Auto-marking by path**         | âœ… `integration` in path                   | âŒ Manual only                     | âœ… `tests/integration/` folder only |
| **Configurable folder**          | âœ… Any path with "integration"             | âŒ N/A                             | âœ… Via `--integration-tests-folder` |
| **Default behavior**             | âœ… Run by default (configurable)           | âœ… Run by default                  | âŒ Skip by default                  |
| **Smart test ordering**          | âœ… Unit â†’ Integration                      | âœ… Unit â†’ Integration â†’ Slow       | âŒ No ordering                      |
| **Fail-fast on unit failure**    | âœ… Yes (configurable)                      | âœ… Yes                             | âŒ No                               |
| **Multi-tier integration tests** | âŒ Single tier                             | âœ… Two tiers (quick/slow)          | âŒ Single tier                      |
| **Coverage integration**         | âœ… Exclude by default                      | âœ… Exclude by default              | âŒ Not handled                      |
| **Timeout support**              | âœ… Via `--integration-timeout`             | âœ… Via `--integration-timeout`     | âŒ No                               |
| **Configuration file**           | âœ… `pytest.ini` / `pyproject.toml`         | âŒ Command-line only               | âŒ Command-line only                |
| **CLI override**                 | âœ… `--with/without-integration`            | âœ… `--with/without-integration`    | âœ… `--with-integration` only        |
| **pytest-xdist compatible**      | âœ… Yes                                     | âš ï¸ Partial (documented limitation) | âœ… Yes                              |
| **Marker name**                  | `@pytest.mark.integration`                 | `@pytest.mark.integration_test`    | `@pytest.mark.integration`          |
| **Python version**               | 3.10+                                      | Any                                | 3.7+                                |
| **Active maintenance**           | âœ… 2025                                    | âš ï¸ Last updated 2020               | âš ï¸ Last updated 2021                |

### Detailed Comparison

#### vs. pytest-integration

**pytest-integration** is the original project that pioneered integration test management in pytest. Our project builds upon its foundation with modern improvements:

**Advantages of pytest-mark-integration:**

- âœ… **Automatic path-based marking**: No need to manually add `@pytest.mark.integration_test` to every test
- âœ… **Flexible configuration**: Configure behavior via `pytest.ini` or `pyproject.toml`, not just command-line
- âœ… **Better defaults**: Integration tests run by default (matches CI/CD workflows)
- âœ… **Simpler marker name**: `integration` vs. `integration_test`
- âœ… **Modern codebase**: Type hints, Python 3.10+, uses current pytest APIs
- âœ… **Better path detection**: Uses relative paths from project root to avoid false positives

**Advantages of pytest-integration:**

- âœ… **Multi-tier tests**: Supports both quick and slow integration tests (two-tier hierarchy)
- âœ… **Cascading fail-fast**: Stops slow integration tests if quick integration tests fail

**Best for:**

- **pytest-mark-integration**: Projects wanting automatic marking, modern Python, and simpler configuration
- **pytest-integration**: Projects needing multi-tier integration test hierarchies

#### vs. pytest-integration-mark

**pytest-integration-mark** focuses on automatically marking tests in a specific folder. Our project extends this concept significantly:

**Advantages of pytest-mark-integration:**

- âœ… **Flexible path matching**: Any path containing "integration", not just `tests/integration/`
- âœ… **Run by default**: Better for CI/CD (skip integration tests locally, run in CI)
- âœ… **Smart ordering**: Unit tests always run before integration tests
- âœ… **Fail-fast support**: Skip integration tests when unit tests fail (saves time)
- âœ… **Coverage integration**: Automatically excludes integration tests from coverage
- âœ… **Timeout support**: Set timeouts specifically for integration tests
- âœ… **Configuration file**: Persistent settings via `pytest.ini` or `pyproject.toml`
- âœ… **Both CLI options**: `--with-integration` and `--without-integration`

**Advantages of pytest-integration-mark:**

- âœ… **Simpler**: Fewer features, easier to understand
- âœ… **Skip by default**: Integration tests won't run unless explicitly requested

**Best for:**

- **pytest-mark-integration**: Production projects needing comprehensive integration test management
- **pytest-integration-mark**: Simple projects wanting basic auto-marking with minimal configuration

### Migration Guide

#### From pytest-integration

```python
# Old (pytest-integration)
@pytest.mark.integration_test
def test_api():
    pass

@pytest.mark.slow_integration_test
def test_slow_api():
    pass
```

```python
# New (pytest-mark-integration)
# Automatic marking - no decorator needed if in integration path!
def test_api():  # Auto-marked if in tests/integration/test_api.py
    pass

# Or manual marking with simpler name
@pytest.mark.integration
def test_api():
    pass

# Note: No slow_integration_test tier (use timeout instead)
```

**Configuration:**

```ini
# pytest-integration (command-line only)
pytest --without-integration

# pytest-mark-integration (persistent config)
[pytest]
run_integration_by_default = false
```

#### From pytest-integration-mark

```python
# Old (pytest-integration-mark)
# File: tests/integration/test_api.py
def test_api():  # Auto-marked only in tests/integration/
    pass
```

```python
# New (pytest-mark-integration)
# File: tests/integration/test_api.py
def test_api():  # Auto-marked (same behavior)
    pass

# File: tests/test_db_integration.py
def test_db():  # ALSO auto-marked (path contains "integration")
    pass
```

**Command-line:**

```bash
# pytest-integration-mark
pytest --with-integration  # Run integration tests

# pytest-mark-integration
pytest --with-integration   # Run integration tests
pytest --without-integration # Skip integration tests (new option!)
pytest                       # Run by default (configurable)
```

### Why Choose pytest-mark-integration?

Choose this plugin if you want:

1. **ğŸ¯ Zero-configuration auto-marking**: Just name your files/folders with "integration"
2. **âš™ï¸ Flexible configuration**: Persistent settings in config files, not just CLI
3. **âš¡ Smart execution**: Unit tests first, fail-fast on failures
4. **ğŸ”Œ Ecosystem integration**: Works seamlessly with pytest-cov, pytest-timeout, pytest-xdist
5. **ğŸ“Š Better defaults**: Designed for modern CI/CD workflows
6. **ğŸ› ï¸ Active maintenance**: Modern codebase with ongoing updates

## Acknowledgments

Inspired by:

- [pytest-integration](https://github.com/jbwdevries/pytest-integration)
- [pytest-integration-mark](https://github.com/Barbora-Data-Science/pytest-integration-mark)

## Changelog

See [CHANGELOG.md](CHANGELOG.md) for version history.

## Support

- ğŸ“– [Documentation](https://github.com/yourusername/pytest-mark-integration#readme)
- ğŸ› [Issue Tracker](https://github.com/yourusername/pytest-mark-integration/issues)
- ğŸ’¬ [Discussions](https://github.com/yourusername/pytest-mark-integration/discussions)
