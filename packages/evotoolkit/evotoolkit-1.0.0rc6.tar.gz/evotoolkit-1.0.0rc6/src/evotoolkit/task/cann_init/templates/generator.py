# Copyright (c) 2025 Ping Guo
# Licensed under the MIT License

"""
Main AscendCTemplateGenerator class.

Orchestrates all 6 component generators to produce complete Ascend C operator code.
"""

from typing import Any, Dict, Optional

from .project_json import ProjectJsonGenerator
from .host_tiling import HostTilingGenerator
from .host_operator import HostOperatorGenerator
from .python_bind import PythonBindGenerator
from .model_src import ModelSrcGenerator


class AscendCTemplateGenerator:
    """
    Generate Ascend C operator code from templates.

    Given an operator signature and kernel code, generates all 6 components
    needed for a complete Ascend C operator:
    1. project_json_src - Operator project configuration
    2. host_tiling_src - Tiling data structure definition
    3. host_operator_src - Host-side operator implementation
    4. kernel_src - Device kernel (provided by LLM)
    5. python_bind_src - Python binding via pybind11
    6. model_src - Test model for verification
    """

    def __init__(self, signature: Dict[str, Any]):
        """
        Initialize with operator signature.

        Args:
            signature: Operator signature containing:
                - op_name: Operator name (e.g., "add")
                - inputs: List of input info [{name, dtype, is_tensor}]
                - outputs: List of output info [{name, dtype, is_tensor}]
                - init_params: List of __init__ param info [{name, dtype, is_tensor, default}]
        """
        self.signature = signature

        # Initialize all component generators
        self._project_json_gen = ProjectJsonGenerator(signature)
        self._host_tiling_gen = HostTilingGenerator(signature)
        self._host_operator_gen = HostOperatorGenerator(signature)
        self._python_bind_gen = PythonBindGenerator(signature)
        self._model_src_gen = ModelSrcGenerator(signature)

    def generate(
        self,
        kernel_src: str,
        block_dim: int = 8,
        host_tiling_src: Optional[str] = None,
        host_operator_src: Optional[str] = None,
        python_bind_src: Optional[str] = None,
    ) -> Dict[str, str]:
        """
        Generate all 6 code components.

        Tiling Modes (simplified to 2 modes):
        1. Default mode: host_tiling_src=None and host_operator_src=None
           - Uses built-in defaults (totalLength + tileNum)
           - For element-wise operators (Add, ReLU, Exp, etc.)
        2. Full LLM mode: Both host_tiling_src and host_operator_src provided
           - Uses complete code generated by LLM
           - For complex operators (MatMul, Reduce, Softmax, LayerNorm, etc.)

        Python Bind Modes:
        1. Default mode: python_bind_src=None
           - Auto-generates with at::empty_like(first_tensor)
           - For element-wise operators (output shape = input shape)
        2. Full LLM mode: python_bind_src provided
           - Uses complete code generated by LLM
           - For complex operators (MatMul needs custom output shape)

        Args:
            kernel_src: Kernel code (from LLM, always required)
            block_dim: Number of parallel cores (only used in default mode)
            host_tiling_src: Complete tiling header (full LLM mode)
            host_operator_src: Complete host operator (full LLM mode)
            python_bind_src: Complete python binding (full LLM mode)

        Returns:
            Dictionary with all 6 code components:
                - project_json_src
                - host_tiling_src
                - host_operator_src
                - kernel_src
                - python_bind_src
                - model_src

        Raises:
            ValueError: If only one of host_tiling_src/host_operator_src is provided.
        """
        # Collect all scalar params (non-tensor) for tiling
        scalar_params = self._host_tiling_gen._collect_scalar_params()

        # Determine tiling mode
        use_default_tiling = host_tiling_src is None and host_operator_src is None

        if use_default_tiling:
            # Default mode: generate from built-in template
            fields = self._host_tiling_gen.default_tiling_fields()
            # Add scalar params to tiling fields
            fields = fields + self._host_tiling_gen.scalar_params_to_tiling_fields(scalar_params)
            host_tiling_src = self._host_tiling_gen.generate(fields)

            # Generate host_operator_src with default TilingFunc body
            base_func_body = self._host_operator_gen.default_tiling_func_body()
            func_body = self._host_operator_gen.add_scalar_params_to_tiling_func(
                base_func_body, scalar_params
            )
            host_operator_src = self._host_operator_gen.generate(block_dim, func_body)
        else:
            # Full LLM mode: validate both are provided
            if host_tiling_src is None or host_operator_src is None:
                raise ValueError(
                    "Full LLM mode requires both host_tiling_src and host_operator_src. "
                    "Either provide both (full LLM mode) or neither (default mode)."
                )

        # Determine python_bind mode
        if python_bind_src is None:
            python_bind_src = self._python_bind_gen.generate()

        return {
            "project_json_src": self._project_json_gen.generate(),
            "host_tiling_src": host_tiling_src,
            "host_operator_src": host_operator_src,
            "kernel_src": kernel_src,
            "python_bind_src": python_bind_src,
            "model_src": self._model_src_gen.generate(),
        }
