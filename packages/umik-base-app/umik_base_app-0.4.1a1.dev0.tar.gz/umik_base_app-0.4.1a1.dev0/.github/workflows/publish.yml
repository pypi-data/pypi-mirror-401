name: Publish to PyPI

on:
  release:
    types: [published]

jobs:
  verify-ci:
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  pypi-publish:
    name: Build and publish Python distribution
    runs-on: ubuntu-latest
    environment: pypi
    
    needs: verify-ci

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          version: "latest"

      - name: Sync Version with Release Tag
        run: |
          # 1. Get the tag name (e.g., "v0.2.0")
          TAG_NAME=${{ github.event.release.tag_name }}
          
          # 2. Strip the leading 'v' (e.g., "0.2.0")
          CLEAN_VERSION=${TAG_NAME#v}
          
          echo "ðŸš€ Updating build version to: $CLEAN_VERSION"

          # 3. Update pyproject.toml
          # Uses regex to find 'version = "..."' and replace it
          sed -i "s/^version = \".*\"/version = \"$CLEAN_VERSION\"/" pyproject.toml

          # 4. Update internal _version.py (if it exists)
          # This ensures 'import umik_base_app; print(umik_base_app.__version__)' matches
          echo "__version__ = \"$CLEAN_VERSION\"" > src/umik_base_app/_version.py

      - name: Build package
        run: uv build

      - name: Publish to PyPI
        run: uv publish