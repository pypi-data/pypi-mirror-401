# {{ app_name | pascal_case }} - Project Rules

> **Generated by Anchor Stack v{{ stack_version }}** | Stack: FastAPI {{ dependencies.fastapi }}

---

## ğŸ¯ æ ¸å¿ƒåŸåˆ™

æœ¬é¡¹ç›®éµå¾ª **Anchor Stack** è§„èŒƒï¼Œç¡®ä¿ AI è¾…åŠ©å¼€å‘çš„å¯ç»´æŠ¤æ€§å’Œä¸€è‡´æ€§ã€‚

---

## ğŸš¨ ç¦æ­¢äº‹é¡¹ (NEVER DO)

| âŒ ç¦æ­¢ | âœ… æ­£ç¡®åšæ³• |
|--------|------------|
| `print()` | `logger.info()` / `logger.error()` |
| `os.getenv()` | `settings.database_url` |
| ä¿®æ”¹ `src/app/core/*` | è¿™äº›æ˜¯æ¡†æ¶æ ¸å¿ƒæ–‡ä»¶ |
| åˆ é™¤ `anchor.config.json` | è¿™æ˜¯é¡¹ç›®å…ƒæ•°æ® |
| ç¡¬ç¼–ç é…ç½®å€¼ | ä½¿ç”¨ `settings` å¯¹è±¡ |
| åœ¨è·¯ç”±ä¸­å†™ä¸šåŠ¡é€»è¾‘ | æ”¾åˆ° `services/` ç›®å½• |

---

## ğŸ“ æ—¥å¿—è§„èŒƒ

### å¯¼å…¥æ–¹å¼
```python
from app.core.logger import logger
```

### ä½¿ç”¨ç¤ºä¾‹
```python
# âœ… æ­£ç¡® - ç»“æ„åŒ–æ—¥å¿—ï¼Œå¸¦ä¸Šä¸‹æ–‡
logger.info("User logged in", user_id=123, ip="192.168.1.1")
logger.error("Payment failed", order_id="ORD-001", error=str(e))
logger.warning("Rate limit approaching", current=95, limit=100)
logger.debug("Cache hit", key="user:123", ttl=300)

# âŒ é”™è¯¯ - ä¸è¦è¿™æ ·åš
print("User logged in")           # ç¦æ­¢ä½¿ç”¨ print
logger.info(f"User {user_id}")    # é¿å… f-stringï¼Œç”¨ç»“æ„åŒ–å‚æ•°
```

### æ—¥å¿—çº§åˆ«é€‰æ‹©
| çº§åˆ« | ä½¿ç”¨åœºæ™¯ |
|------|---------|
| `DEBUG` | å¼€å‘è°ƒè¯•ä¿¡æ¯ |
| `INFO` | æ­£å¸¸ä¸šåŠ¡æ“ä½œï¼ˆç”¨æˆ·ç™»å½•ã€è®¢å•åˆ›å»ºï¼‰|
| `WARNING` | å¼‚å¸¸ä½†å¯æ¢å¤çš„æƒ…å†µ |
| `ERROR` | é”™è¯¯ï¼Œéœ€è¦å…³æ³¨ |

### ä½•æ—¶æ·»åŠ æ—¥å¿—
- API è¯·æ±‚å¼€å§‹å’Œç»“æŸ
- æ•°æ®åº“æ“ä½œï¼ˆæŸ¥è¯¢ã€å†™å…¥ï¼‰
- å¤–éƒ¨æœåŠ¡è°ƒç”¨
- è®¤è¯/æˆæƒäº‹ä»¶
- ä¸šåŠ¡çŠ¶æ€å˜æ›´

---

## âš™ï¸ é…ç½®è§„èŒƒ

### å¯¼å…¥æ–¹å¼
```python
from app.core.config import settings
```

### ä½¿ç”¨ç¤ºä¾‹
```python
# âœ… æ­£ç¡® - é€šè¿‡ settings è®¿é—®
database_url = settings.database_url
is_debug = settings.debug
app_name = settings.app_name

# âŒ é”™è¯¯ - ä¸è¦ç›´æ¥è®¿é—®ç¯å¢ƒå˜é‡
import os
database_url = os.getenv("DATABASE_URL")  # ç¦æ­¢
database_url = os.environ["DATABASE_URL"]  # ç¦æ­¢
```

### æ·»åŠ æ–°é…ç½®é¡¹
åœ¨ `src/app/core/config.py` çš„ `Settings` ç±»ä¸­æ·»åŠ ï¼š
```python
class Settings(BaseSettings):
    # ç°æœ‰é…ç½®...

    # æ–°å¢é…ç½®
    redis_url: str = Field(
        default="redis://localhost:6379",
        description="Redis connection URL",
    )
```

---

## ğŸ“ ç›®å½•ç»“æ„

```
src/app/
â”œâ”€â”€ api/                  # API å±‚
â”‚   â””â”€â”€ v1/
â”‚       â”œâ”€â”€ router.py     # è·¯ç”±æ³¨å†Œ
â”‚       â”œâ”€â”€ health.py     # å¥åº·æ£€æŸ¥
â”‚       â”œâ”€â”€ users.py      # ç”¨æˆ·ç›¸å…³ API
â”‚       â””â”€â”€ [æ–°æ¨¡å—].py   # æ–°å¢ API æ”¾è¿™é‡Œ
â”‚
â”œâ”€â”€ core/                 # âš ï¸ æ ¸å¿ƒæ¨¡å— - è¯·å‹¿ä¿®æ”¹
â”‚   â”œâ”€â”€ config.py         # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ logger.py         # æ—¥å¿—æ¡†æ¶
â”‚
â”œâ”€â”€ models/               # æ•°æ®åº“æ¨¡å‹ (SQLAlchemy)
â”‚   â””â”€â”€ [è¡¨å].py
â”‚
â”œâ”€â”€ schemas/              # æ•°æ®æ ¡éªŒ (Pydantic)
â”‚   â”œâ”€â”€ user.py           # ç”¨æˆ·ç›¸å…³ schema
â”‚   â”œâ”€â”€ response.py       # é€šç”¨å“åº” schema
â”‚   â””â”€â”€ [æ¨¡å—].py
â”‚
â”œâ”€â”€ services/             # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â””â”€â”€ [æ¨¡å—]_service.py
â”‚
â””â”€â”€ main.py               # åº”ç”¨å…¥å£
```

---

## ğŸ”§ æ–°å¢åŠŸèƒ½æŒ‡å—

### æ–°å¢ API ç«¯ç‚¹

**æ­¥éª¤ 1**: åˆ›å»º Schema (`src/app/schemas/items.py`)
```python
from pydantic import BaseModel, Field

class ItemCreate(BaseModel):
    name: str = Field(..., min_length=1, max_length=100)
    price: float = Field(..., gt=0)

class Item(ItemCreate):
    id: int

    model_config = {"from_attributes": True}
```

**æ­¥éª¤ 2**: åˆ›å»º API è·¯ç”± (`src/app/api/v1/items.py`)
```python
from fastapi import APIRouter, HTTPException
from app.core.logger import logger
from app.schemas.items import Item, ItemCreate

router = APIRouter()

@router.get("", response_model=list[Item])
async def list_items():
    """è·å–æ‰€æœ‰å•†å“"""
    logger.info("Listing items")
    # TODO: ä»æ•°æ®åº“è·å–
    return []

@router.post("", response_model=Item, status_code=201)
async def create_item(item_in: ItemCreate):
    """åˆ›å»ºå•†å“"""
    logger.info("Creating item", name=item_in.name, price=item_in.price)
    # TODO: ä¿å­˜åˆ°æ•°æ®åº“
    return Item(id=1, **item_in.model_dump())

@router.get("/{item_id}", response_model=Item)
async def get_item(item_id: int):
    """è·å–å•ä¸ªå•†å“"""
    logger.info("Getting item", item_id=item_id)
    # TODO: ä»æ•°æ®åº“è·å–
    raise HTTPException(status_code=404, detail="Item not found")
```

**æ­¥éª¤ 3**: æ³¨å†Œè·¯ç”± (`src/app/api/v1/router.py`)
```python
from app.api.v1 import health, users, items  # æ·»åŠ  items

api_router.include_router(items.router, prefix="/items", tags=["items"])
```

### æ–°å¢ Service å±‚

å¤æ‚ä¸šåŠ¡é€»è¾‘åº”æ”¾åœ¨ `services/` ç›®å½•:

```python
# src/app/services/item_service.py
from app.core.logger import logger

class ItemService:
    async def create_item(self, name: str, price: float) -> dict:
        logger.info("Creating item in service", name=name)
        # ä¸šåŠ¡é€»è¾‘...
        return {"id": 1, "name": name, "price": price}

    async def calculate_discount(self, item_id: int, discount: float) -> float:
        logger.info("Calculating discount", item_id=item_id, discount=discount)
        # å¤æ‚è®¡ç®—é€»è¾‘...
        return price * (1 - discount)
```

åœ¨ API ä¸­ä½¿ç”¨:
```python
from app.services.item_service import ItemService

service = ItemService()

@router.post("/calculate-discount")
async def calculate_discount(item_id: int, discount: float):
    return await service.calculate_discount(item_id, discount)
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†

### æ ‡å‡†é”™è¯¯å“åº”
```python
from fastapi import HTTPException

# 404 - èµ„æºä¸å­˜åœ¨
raise HTTPException(status_code=404, detail="User not found")

# 400 - è¯·æ±‚é”™è¯¯
raise HTTPException(status_code=400, detail="Invalid email format")

# 403 - æƒé™ä¸è¶³
raise HTTPException(status_code=403, detail="Permission denied")

# 500 - æœåŠ¡å™¨é”™è¯¯ (è®°å½•æ—¥å¿—)
try:
    result = await some_operation()
except Exception as e:
    logger.error("Operation failed", error=str(e), operation="some_operation")
    raise HTTPException(status_code=500, detail="Internal server error")
```

---

## ğŸ§ª æµ‹è¯•è§„èŒƒ

æµ‹è¯•æ–‡ä»¶æ”¾åœ¨ `tests/` ç›®å½•:

```python
# tests/test_items.py
from fastapi.testclient import TestClient

def test_create_item(client: TestClient):
    response = client.post(
        "/api/v1/items",
        json={"name": "Test Item", "price": 99.99}
    )
    assert response.status_code == 201
    data = response.json()
    assert data["name"] == "Test Item"

def test_get_item_not_found(client: TestClient):
    response = client.get("/api/v1/items/999")
    assert response.status_code == 404
```

è¿è¡Œæµ‹è¯•:
```bash
uv run pytest
uv run pytest -v              # è¯¦ç»†è¾“å‡º
uv run pytest tests/test_items.py  # å•ä¸ªæ–‡ä»¶
```

---

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤

```bash
# å¼€å‘æœåŠ¡å™¨
cd src && uv run uvicorn app.main:app --reload

# æµ‹è¯•
uv run pytest

# ä»£ç æ£€æŸ¥
uv run ruff check src/
uv run mypy src/

# æ ¼å¼åŒ–
uv run ruff format src/
```

---

## ğŸ“š API æ–‡æ¡£

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- OpenAPI JSON: http://localhost:8000/openapi.json

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶ | ç”¨é€” |
|------|------|
| `CLAUDE.md` | Claude Code è§„åˆ™ (æœ¬æ–‡ä»¶) |
| `.cursor/rules/` | Cursor IDE è§„åˆ™ |
| `.windsurfrules` | Windsurf è§„åˆ™ |
| `anchor.config.json` | Anchor Stack é¡¹ç›®é…ç½® |
