name: Monitor Organization Bot PRs

on:
  schedule:
    # Run every day at midnight UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'Specific repo to check (e.g., VectorInstitute/repo-name)'
        required: false
      pr_number:
        description: 'Specific PR number to process'
        required: false

# Prevent concurrent workflow runs to avoid duplicate PR processing
concurrency:
  group: monitor-org-bot-prs
  cancel-in-progress: false

permissions:
  contents: read
  issues: write
  id-token: write

env:
  ORG_NAME: VectorInstitute

jobs:
  discover-bot-prs:
    runs-on: ubuntu-latest
    outputs:
      prs: ${{ steps.find-prs.outputs.prs }}
      repos: ${{ steps.find-prs.outputs.repos }}

    steps:
      - name: Checkout bot repository
        uses: actions/checkout@v6

      - name: Find bot PRs across organization
        id: find-prs
        run: |
          # Search for all open bot PRs (Dependabot and pre-commit-ci) in the organization
          if [ -n "${{ github.event.inputs.target_repo }}" ]; then
            # Manual trigger - specific repo
            REPOS="${{ github.event.inputs.target_repo }}"
          else
            # Scheduled - read repos from CSV file
            if [ -f repos-to-monitor.csv ]; then
              REPOS=$(tail -n +2 repos-to-monitor.csv | grep -v '^$' | tr '\n' ' ')
              echo "Reading repos from repos-to-monitor.csv"
            else
              echo "Error: repos-to-monitor.csv not found"
              exit 1
            fi
          fi

          # Array to store PR information
          PRS_JSON="[]"

          # Bot authors to check
          BOT_AUTHORS=("app/dependabot" "pre-commit-ci[bot]")

          for REPO in $REPOS; do
            # Skip the bot repository itself to prevent self-modification
            if [ "$REPO" = "VectorInstitute/aieng-bot" ]; then
              echo "Skipping $REPO (bot repository itself)"
              continue
            fi

            echo "Checking $REPO for bot PRs..."

            # Get all open PRs from each bot author
            for BOT_AUTHOR in "${BOT_AUTHORS[@]}"; do
              REPO_PRS=$(gh pr list --repo "$REPO" \
                --author "$BOT_AUTHOR" \
                --state open \
                --json number,title,url,headRefName,statusCheckRollup,author 2>/dev/null || echo "[]")

              if [ "$REPO_PRS" != "[]" ] && [ -n "$REPO_PRS" ]; then
                # Add repo name to each PR object in the array
                REPO_PRS=$(echo "$REPO_PRS" | jq -c "map(. + {repo: \"$REPO\"})")

                # Append to our collection
                PRS_JSON=$(echo "$PRS_JSON" | jq -c ". + $REPO_PRS")
              fi
            done
          done

          # Output the collected PRs
          echo "Found $(echo "$PRS_JSON" | jq 'length') bot PRs"
          echo "$PRS_JSON" | jq -c '.'

          # Extract unique repos for matrix
          REPOS_JSON=$(echo "$PRS_JSON" | jq -c '[.[].repo] | unique')
          echo "Unique repos: $(echo "$REPOS_JSON" | jq 'length')"

          # Save to output (handle GitHub Actions output size limits)
          echo "prs=$(echo "$PRS_JSON" | jq -c '.')" >> $GITHUB_OUTPUT
          echo "repos=$REPOS_JSON" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}

  process-repo-queues:
    runs-on: ubuntu-latest
    needs: discover-bot-prs
    if: needs.discover-bot-prs.outputs.repos != '[]'
    strategy:
      matrix:
        repo: ${{ fromJson(needs.discover-bot-prs.outputs.repos) }}
      max-parallel: 5
      fail-fast: false

    steps:
      - name: Checkout bot repository
        uses: actions/checkout@v6

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          pip install -e .

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v3

      - name: Process repository queue
        run: |
          aieng-bot queue \
            --repo "${{ matrix.repo }}" \
            --workflow-run-id "${{ github.run_id }}" \
            --all-prs '${{ needs.discover-bot-prs.outputs.prs }}'
        env:
          GH_TOKEN: ${{ secrets.ORG_ACCESS_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        continue-on-error: true


  report-summary:
    runs-on: ubuntu-latest
    needs: [discover-bot-prs, process-repo-queues]
    if: always()

    steps:
      - name: Generate summary
        run: |
          PR_COUNT=$(echo '${{ needs.discover-bot-prs.outputs.prs }}' | jq 'length')

          echo "## Bot PR Monitor Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Organization**: ${{ env.ORG_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Bot PRs Found**: $PR_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$PR_COUNT" -gt 0 ]; then
            echo "### PRs Processed" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.discover-bot-prs.outputs.prs }}' | \
              jq -r '.[] | "- [\(.repo)#\(.number)](\(.url)) - \(.title)"' >> $GITHUB_STEP_SUMMARY
          fi
