name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  wheels:
    name: Build wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    env:
      CIBW_ARCHS_MACOS: "x86_64 arm64"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        sdist: [false]
        include:
          - os: ubuntu-latest
            sdist: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Build wheels
        uses: pypa/cibuildwheel@v2.19.2
        with:
          output-dir: dist

      - name: Build sdist
        if: matrix.sdist
        run: |
          python -m pip install --upgrade pip build
          python -m build --sdist --outdir dist

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.os }}-${{ matrix.sdist }}
          path: dist/*.whl

      - name: Upload sdist
        if: matrix.sdist
        uses: actions/upload-artifact@v4
        with:
          name: sdist
          path: dist/*.tar.gz

  tests:
    name: Test wheels (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: wheels
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      QT_QPA_PLATFORM: offscreen
      GEON_USE_INSTALLED: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Install test dependencies
        shell: bash
        run: |
          python -m venv .venv
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          "$VENV_PY" -m pip install --upgrade pip packaging pytest

      - name: Install wheel
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          WHEEL=$("$VENV_PY" - <<'PY'
          from pathlib import Path
          from packaging.tags import sys_tags
          from packaging.utils import parse_wheel_filename
          wheels = list(Path("dist").glob("*.whl"))
          tagset = set(sys_tags())
          for wheel in wheels:
            _, _, _, tags = parse_wheel_filename(wheel.name)
            if tagset.intersection(tags):
              print(wheel)
              break
          PY
          )
          "$VENV_PY" -m pip install "$WHEEL"

      - name: Run tests
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          "$VENV_PY" -m pytest

  pyinstaller:
    name: Build PyInstaller (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: tests
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Linux runtime libs
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libegl1 \
            libgl1 \
            libglib2.0-0 \
            libxkbcommon0 \
            libdbus-1-3 \
            libfontconfig1 \
            libnss3 \
            libxrender1 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libxcb1 \
            libxcb-xinerama0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Install wheel and PyInstaller
        shell: bash
        run: |
          python -m venv .venv
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          "$VENV_PY" -m pip install --upgrade pip packaging pyinstaller
          WHEEL=$("$VENV_PY" - <<'PY'
          from pathlib import Path
          from packaging.tags import sys_tags
          from packaging.utils import parse_wheel_filename
          wheels = list(Path("dist").glob("*.whl"))
          tagset = set(sys_tags())
          for wheel in wheels:
            _, _, _, tags = parse_wheel_filename(wheel.name)
            if tagset.intersection(tags):
              print(wheel)
              break
          PY
          )
          "$VENV_PY" -m pip install "$WHEEL"

      - name: Build executable
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
            VENV_PY=".venv/Scripts/python.exe"
          else
            VENV_PY=".venv/bin/python"
          fi
          "$VENV_PY" -m PyInstaller geon.spec --noconfirm --clean

      - name: Package executable
        shell: bash
        run: |
          python - <<'PY'
          import os
          import zipfile
          from pathlib import Path

          dist = Path("dist")
          version = os.environ.get("GITHUB_REF_NAME", "v0.0.0").lstrip("v")
          os_name = os.environ.get("RUNNER_OS", "unknown").lower()
          arch = os.environ.get("RUNNER_ARCH", "unknown").lower()

          candidates = [
              dist / "geon.exe",
              dist / "geon.app",
              dist / "geon",
          ]
          target_path = next((p for p in candidates if p.exists()), None)
          if not target_path:
              raise SystemExit("No PyInstaller output found in dist/")

          target = dist / f"geon-{version}-{os_name}-{arch}.zip"
          with zipfile.ZipFile(target, "w", compression=zipfile.ZIP_DEFLATED) as zf:
            if target_path.is_dir():
              for path in target_path.rglob("*"):
                if path.is_file():
                  zf.write(path, path.relative_to(target_path.parent))
            else:
              zf.write(target_path, target_path.name)
          print(target)
          PY

      - name: Upload PyInstaller artifact
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-${{ matrix.os }}
          path: dist/geon-*.zip

  pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: pyinstaller
    permissions:
      id-token: write
      contents: read
    steps:
      - name: Download wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: dist

      - name: Download sdist
        uses: actions/download-artifact@v4
        with:
          name: sdist
          path: dist

      - name: Publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist

  github-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: pypi
    steps:
      - name: Download PyInstaller artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: pyinstaller-*
          merge-multiple: true
          path: dist

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/geon-*.zip
          generate_release_notes: true
