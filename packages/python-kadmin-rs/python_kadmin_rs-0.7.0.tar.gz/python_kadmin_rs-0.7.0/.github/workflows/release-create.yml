---
name: Create release

on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  release-info:
    if: github.event.pull_request.merged
    outputs:
      is-release: ${{ steps.meta.outputs.is-release }}
      package: ${{ steps.meta.outputs.crates-names }}
      version: ${{ steps.meta.outputs.version-actual }}
    runs-on: ubuntu-latest
    steps:
      - id: meta
        uses: cargo-bins/release-meta@878b404d09251e067413b4974a2f23c668fd664e # v1
        with:
          event-data: ${{ toJSON(github.event) }}

  release-create:
    needs:
      - release-info
    if: needs.release-info.outputs.is-release == 'true'
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          name: "${{ needs.release-info.outputs.package }} ${{ needs.release-info.outputs.version }}"
          tag_name: "${{ needs.release-info.outputs.package }}/version/${{ needs.release-info.outputs.version }}"
          target_commitish: "${{ github.sha }}"
          draft: true
          make_latest: true
