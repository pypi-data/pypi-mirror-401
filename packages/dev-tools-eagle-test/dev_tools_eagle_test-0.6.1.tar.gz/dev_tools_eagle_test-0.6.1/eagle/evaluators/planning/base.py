from eagle.evaluators.base import AgentEvaluationBase, AgentEvaluationResultSchema
from eagle.agents.base import BasicWorkingMemoryState
from eagle.agents.react_agent.base import ReactPlanningAgent, ReactPlanningAgentConfigSchema
from eagle.chains.plan_evaluation import create_plan_evaluation_chain

class AgentPlanningEvaluationResultSchema(AgentEvaluationResultSchema):
    plan: str

def route_after_plan_node(*args, **kwargs):
    return "execute"

def execute(state, *args, **kwargs):
    return {
        "execution_is_complete": True
    }

class AgentPlanningEvaluationBase(AgentEvaluationBase):
    def __init__(self, agent: ReactPlanningAgent, scenario, llm, prompt_language="en", use_structured_output=False):
        super().__init__(agent, scenario)
        self.llm = llm
        self.prompt_language = prompt_language
        self.use_structured_output = use_structured_output
        self.plan_evaluation_chain = create_plan_evaluation_chain(
            prompt_language=prompt_language,
            llm=llm,
            use_structured_output=use_structured_output
        )

    def wrap_agent_to_stop_in_plan(self):

        class AgentWithPlanStopping(self.agent.__class__):
            ROUTE_AFTER_PLAN_NODE = route_after_plan_node
            EXECUTE_NODE = execute

        wrapped_agent = AgentWithPlanStopping(name=self.agent.name, description=self.agent.description)
        wrapped_agent._memories = self.agent._memories
        return wrapped_agent

    def evaluate_case(self, state: BasicWorkingMemoryState, config: dict, evaluation_criteria: str) -> AgentPlanningEvaluationResultSchema:
        wrapped_agent = self.wrap_agent_to_stop_in_plan()
        wrapped_agent.run(state, config)
        plan = wrapped_agent.state_snapshot.values['plan']
        if plan:
            result = self.plan_evaluation_chain.invoke({
                "plan": plan,
                "evaluation_criteria": evaluation_criteria
            })
            return AgentPlanningEvaluationResultSchema(plan=plan, **result.model_dump())
        else:
            return AgentPlanningEvaluationResultSchema(description="No plan generated by the agent.", score=0.0, plan="")

    def get_results_new_columns(self):
        return ["description", "score", "plan"]