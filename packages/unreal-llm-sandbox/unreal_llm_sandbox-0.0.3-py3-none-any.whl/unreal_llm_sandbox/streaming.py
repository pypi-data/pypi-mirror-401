# AUTOGENERATED! DO NOT EDIT! File to edit: ../nbs/streaming.ipynb.

# %% auto 0
__all__ = ['active_streams', 'SSEStream']

# %% ../nbs/streaming.ipynb 3
import queue
import asyncio
import json
from starlette.responses import StreamingResponse


active_streams = {}


class SSEStream:
    """Unified SSE streaming with queue-based message passing.
    
    Args:
        cell_id: Unique identifier for abort handling.
    """
    def __init__(self, stream_key):
        self.stream_key = stream_key  
        self.q = queue.Queue()
        active_streams[stream_key] = {'abort': False}
    
    def text(self, content: str):
        """Send text chunk to stream.
        
        Args:
            content: String to send.
        """
        self.q.put({"type": "text", "data": content})

    def tag(self, content: str):
        """Send control tag to switch stream target.
        
        Args:
            content: Tag name.
        """
        self.q.put({"type": "tag", "data": content})
    
    def output(self, data):
        """Send Jupyter-style output dict.
        
        Args:
            data: Output dict/list (may contain ANSI).
        """
        self.q.put({"type": "output", "data": data})
        
    def done(self):
        """Signal stream complete and cleanup."""
        self.q.put(None)
        self.cleanup()

    def aborted(self):
        """Check if user requested abort.
        
        Returns:
            True if aborted, False otherwise.
        """
        return active_streams.get(self.stream_key, {}).get('abort', True)

    def response(self):
        """Create async SSE response.
        
        Returns:
            StreamingResponse for FastHTML route.
        """
        async def generator():
            while True:
                item = await asyncio.to_thread(self.q.get)
                if item is None: break
                yield f"data: {json.dumps(item)}\n\n"
            self.cleanup()
        return StreamingResponse(generator(), media_type='text/event-stream')

    def cleanup(self):
        """Remove cell_id from active_streams."""
        active_streams.pop(self.stream_key, None)
        
