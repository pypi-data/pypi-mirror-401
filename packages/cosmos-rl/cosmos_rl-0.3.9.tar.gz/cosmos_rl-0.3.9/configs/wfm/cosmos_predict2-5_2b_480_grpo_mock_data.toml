[[model.conditioner]]
name = "fps"
type = "remap_key"
output_key = "fps"
input_key = "fps"

[[model.conditioner]]
name = "padding_mask"
type = "remap_key"
output_key = "padding_mask"
input_key = "padding_mask"

[[model.conditioner]]
name = "text"
type = "text_attr"
input_key = ["t5_text_embeddings"]

[[model.conditioner]]
name = "use_video_condition"
type = "boolean_flag"
output_key = "use_video_condition"
input_key = "fps"

[model]
fsdp_shard_size = 8

[model_parallel]
tensor_model_parallel_size = 1
pipeline_model_parallel_size = 1
pipeline_parallel_size = 1
context_parallel_size = 1

[[trainer.callbacks]]
name = "grad_clip"
[trainer.callbacks.args]
clip_norm = 1.0
force_finite = true

[[trainer.callbacks]]
name = "low_prec"
[trainer.callbacks.args]
update_iter = 1

[[trainer.callbacks]]
name = "iter_speed"
[trainer.callbacks.args]
hit_thres = 5
save_s3 = true
save_s3_every_log_n = 10
every_n = 2

[[trainer.callbacks]]
name = "param_count"
[trainer.callbacks.args]
save_s3 = true

[[trainer.callbacks]]
name = "heart_beat"
[trainer.callbacks.args]
step_size = 1
update_interval_in_minute = 20
save_s3 = true
every_n = 10

[[trainer.callbacks]]
name = "device_monitor"
[trainer.callbacks.args]
every_n = 2
step_size = 1
save_s3 = true
upload_every_n_mul = 10
log_memory_detail = true

[[trainer.callbacks]]
name = "verify_data_batch_keys"
[trainer.callbacks.args]
check_first_n = 10

[[trainer.callbacks]]
name = "manual_gc"
[trainer.callbacks.args]
warm_up = 5
every_n = 5

[[trainer.callbacks]]
name = "compile_tokenizer"
[trainer.callbacks.args]
enabled = false
compile_after_iterations = 4
dynamic = false

[[trainer.callbacks]]
name = "frame_loss_log"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 1
save_s3 = true

[[trainer.callbacks]]
name = "every_n_sample_reg"
[trainer.callbacks.args]
step_size = 1
n_x0_level = 4
n_viz_sample = 3
n_sample_to_save = 128
num_sampling_step = 35
guidance = []
is_x0 = false
is_sample = true
save_s3 = true
is_ema = false
use_negative_prompt = false
show_all_frames = false
fps = 16
every_n = 2

[[trainer.callbacks]]
name = "every_n_sample_ema"
[trainer.callbacks.args]
step_size = 1
n_x0_level = 4
n_viz_sample = 3
n_sample_to_save = 128
num_sampling_step = 35
guidance = []
is_x0 = false
is_sample = true
save_s3 = true
is_ema = true
use_negative_prompt = false
show_all_frames = false
fps = 16
every_n = 2

[[trainer.callbacks]]
name = "wandb"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 10
save_s3 = true

[[trainer.callbacks]]
name = "wandb_10x"
[trainer.callbacks.args]
logging_iter_multipler = 10
save_logging_iter_multipler = 1
save_s3 = true

[[trainer.callbacks]]
name = "dataloader_speed"
[trainer.callbacks.args]
step_size = 1
save_s3 = true
every_n = 2

[[trainer.callbacks]]
name = "reward_callback"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 10
save_s3 = true

[trainer.grad_scaler_args]
enabled = false

[dataloader_train]
type = 'web'

[dataloader_train.image_dataloader]
ratio = 0

  [dataloader_train.image_dataloader.dataloader]
  use_cache = false
  cache_size = 8
  concat_size = 1
  cache_replay_name = "image_dataloader"
  batch_size = 12
  num_workers = 6
  pin_memory = true
  webdataset = false

    [dataloader_train.image_dataloader.dataloader.cache_augment_fn]
    name = "duplicate_batches"
    args = {n = 1}

    [dataloader_train.image_dataloader.dataloader.dataset]
    dataset_resolution_type = "gt720p"
    caption_type = "qwen2p5_7b_v4"
    resolution = "480"
    len_t5 = 512
    t5_dim = 1024

[dataloader_train.video_dataloader]
ratio = 1

  [dataloader_train.video_dataloader.dataloader]
  use_cache = false
  cache_size = 16
  concat_size = 1
  cache_replay_name = "video_dataloader"
  batch_size = 1
  num_workers = 8
  pin_memory = true
  webdataset = false

    [dataloader_train.video_dataloader.dataloader.cache_augment_fn]
    name = "duplicate_batches_random"
    args = {n = 1.8}

    [dataloader_train.video_dataloader.dataloader.dataset]
    resolution = "480"
    len_t5 = 512
    t5_dim = 1024
    num_video_frames = 93
    video_decoder_name = "video_naive_bytes"
    augmentor_name = "video_basic_augmentor_v2"
    caption_type = "t2w_qwen2p5_7b"
    embedding_type = "t5_xxl"

[dataloader_val]
type = 'web'

[dataloader_val.image_dataloader]
ratio = 1

  [dataloader_val.image_dataloader.dataloader]
  use_cache = false
  cache_size = 32
  concat_size = 1
  cache_replay_name = "image_dataloader"
  batch_size = 2
  num_workers = 8
  pin_memory = true
  webdataset = false

    [dataloader_val.image_dataloader.dataloader.dataset]
    resolution = "512"
    len_t5 = 512
    t5_dim = 1024

[dataloader_val.video_dataloader]
ratio = 1

  [dataloader_val.video_dataloader.dataloader]
  use_cache = false
  cache_size = 32
  concat_size = 1
  cache_replay_name = "video_dataloader"
  batch_size = 1
  num_workers = 8
  pin_memory = true
  webdataset = false

    [dataloader_val.video_dataloader.dataloader.dataset]
    resolution = "512"
    len_t5 = 512
    t5_dim = 1024
    num_video_frames = 136

[job]
project = "cosmos_rl_wfm"
group = "official_runs_t2v"
name = "cosmos_predict2-5_2b_480_grpo_mock_data"
wandb_mode = "online"
