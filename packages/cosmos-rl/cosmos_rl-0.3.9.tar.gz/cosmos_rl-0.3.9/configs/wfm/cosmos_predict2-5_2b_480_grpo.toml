[[model.conditioner]]
name = "fps"
type = "remap_key"
output_key = "fps"
input_key = "fps"

[[model.conditioner]]
name = "padding_mask"
type = "remap_key"
output_key = "padding_mask"
input_key = "padding_mask"

[[model.conditioner]]
name = "text"
type = "text_attr"
input_key = ["t5_text_embeddings"]

[[model.conditioner]]
name = "use_video_condition"
type = "boolean_flag"
output_key = "use_video_condition"
input_key = "fps"

[model]
fsdp_shard_size = 8

[model_parallel]
tensor_model_parallel_size = 1
pipeline_model_parallel_size = 1
pipeline_parallel_size = 1
context_parallel_size = 1

[trainer]
max_iter = 2001

[[trainer.callbacks]]
name = "grad_clip"
[trainer.callbacks.args]
clip_norm = 1.0
force_finite = true

[[trainer.callbacks]]
name = "low_prec"
[trainer.callbacks.args]
update_iter = 1

[[trainer.callbacks]]
name = "iter_speed"
[trainer.callbacks.args]
hit_thres = 5
save_s3 = true
save_s3_every_log_n = 10
every_n = 2

[[trainer.callbacks]]
name = "param_count"
[trainer.callbacks.args]
save_s3 = true

[[trainer.callbacks]]
name = "heart_beat"
step_size = 1
[trainer.callbacks.args]
update_interval_in_minute = 20
save_s3 = true
every_n = 10

[[trainer.callbacks]]
name = "device_monitor"
[trainer.callbacks.args]
every_n = 2
step_size = 1
save_s3 = true
upload_every_n_mul = 10
log_memory_detail = true

[[trainer.callbacks]]
name = "manual_gc"
[trainer.callbacks.args]
warm_up = 5
every_n = 5

[[trainer.callbacks]]
name = "compile_tokenizer"
[trainer.callbacks.args]
enabled = true
compile_after_iterations = 4
dynamic = false

[[trainer.callbacks]]
name = "frame_loss_log"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 1
save_s3 = true

[[trainer.callbacks]]
name = "every_n_sample_reg"
[trainer.callbacks.args]
step_size = 1
n_x0_level = 4
n_viz_sample = 3
n_sample_to_save = 128
num_sampling_step = 35
guidance = []
is_x0 = false
is_sample = true
save_s3 = true
is_ema = false
use_negative_prompt = false
show_all_frames = false
fps = 16
every_n = 16

[[trainer.callbacks]]
name = "every_n_sample_ema"
[trainer.callbacks.args]
step_size = 1
n_x0_level = 4
n_viz_sample = 3
n_sample_to_save = 128
num_sampling_step = 35
guidance = []
is_x0 = false
is_sample = true
save_s3 = true
is_ema = true
use_negative_prompt = false
show_all_frames = false
fps = 16
every_n = 16

[[trainer.callbacks]]
name = "wandb"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 10
save_s3 = true

[[trainer.callbacks]]
name = "wandb_10x"
[trainer.callbacks.args]
logging_iter_multipler = 10
save_logging_iter_multipler = 1
save_s3 = true

[[trainer.callbacks]]
name = "dataloader_speed"
[trainer.callbacks.args]
step_size = 1
save_s3 = true
every_n = 2

[[trainer.callbacks]]
name = "reward_callback"
[trainer.callbacks.args]
logging_iter_multipler = 1
save_logging_iter_multipler = 10
save_s3 = true

[trainer.grad_scaler_args]
enabled = false

[optimizer]
lr = 1e-5
weight_decay = 1e-4

[scheduler]
f_start = [1e-6]
f_max = [1.0]
f_min = [1.0]
warm_up_steps = [50]
cycle_lengths = [400000]

[dataloader_train]
type = 'local'

[dataloader_train.video_dataloader]
ratio = 1
dataset_dir = 'path_to_your_local_train_dataset'
batch_size = 1
num_workers = 8
pin_memory = true
num_frames = 93
video_size = [768, 432]
offline_text_embedding = true

[dataloader_val]
type = 'local'

[dataloader_val.video_dataloader]
ratio = 1
dataset_dir = 'path_to_your_local_val_dataset'
batch_size = 1
num_workers = 8
pin_memory = true
num_frames = 93
video_size = [768, 432]
offline_text_embedding = true

[job]
project = "cosmos_rl_wfm"
group = "official_runs_t2v"
name = "cosmos_predict2-5_2b_480_grpo"
wandb_mode = "online"

[checkpoint]
type = "distributed"
load_path = "nvidia/Cosmos-Predict2.5-2B"
model_id = "base/pre-trained/d20b7120-df3e-4911-919d-db6e08bad31c_ema_bf16.pt"
