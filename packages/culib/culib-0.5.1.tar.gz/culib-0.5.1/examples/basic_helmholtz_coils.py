"""
Basic example based on Helmholtz coil configuration (distance between coils = coil radius) :

- Create 2 coils in Helmholtz configuration
- Display characteristics of coils
- Calculate fields generated by each coils
- Display homogeneity at center
- Plot fields along the full axis for macro view
- Plot field zoomed on position of interest (center) in +/- 0.5mm
- Save plots as .png or/and .html
"""
from pathlib import Path

import culib as cul

cul.init_logging(log_level='INFO')

# Init dataframe that will contain fields
AXIS_LENGTH_MM = 159.9
RES_STEP_MM = 0.05
df_field = cul.init_df_field(AXIS_LENGTH_MM, RES_STEP_MM)

# Define wire to be used in coils
my_wire = cul.RoundWire(awg = 22, t_insulation_mm = 0.05)

# Define left coil, calc its field and add it to df_field
my_left_helmholtz_coil = cul.CircularCoil(
    name='left_coil',
    axis = 'x_mm',
    r_out_mm = 50+5,
    r_in_mm = 50-5,
    L_mm = 15,
    pos_mm = -50/2,
    wire = my_wire,
)
print(my_left_helmholtz_coil)

my_left_helmholtz_coil.cur_A = 12 # You can define the current or other parameters after the coil creation. It will trigger recalc of its characteristics automatically.
df_field = my_left_helmholtz_coil.calc_field(df_field)

print('\nDisplaying updated characteristics of my_left_helmholtz_coil :')
print(my_left_helmholtz_coil)

# Define right coil, calc its field and add it to df_field
my_right_helmholtz_coil = cul.CircularCoil(
    name='right_coil',
    axis = 'x_mm',
    r_out_mm = 50+5,
    r_in_mm = 50-5,
    L_mm = 15,
    pos_mm = +50/2,
    wire = my_wire,
    cur_A = 12, # Here we defined current directly during coil creation
)
df_field = my_right_helmholtz_coil.calc_field(df_field)

# Display homogeneity at center in +/- 0.5mm
homo_at_center = cul.get_field_homo_at_pos(df_field, axis='x_mm', Baxis='Bx_total_mT', pos_mm=0.0, homo_region_mm=0.5)
print(f"Field homo at center = {homo_at_center:6f} %")

# Plot as charts and save them as .png and interactive .html
savepath_png = Path.cwd() / 'helmholtz_coils_plots'
savepath_html = savepath_png / 'interactive_html'

chart_full = cul.plot_field(
    df_field, axis='x_mm', Baxis=['Bx_left_coil_mT', 'Bx_right_coil_mT','Bx_total_mT'],
    pos_mm=0.0, homo_region_mm=0.5,
    is_save=True, save_filename='helmholtz_full_axis', savepath_png=savepath_png, savepath_html=savepath_html,
    title="Helmholtz circular coils (distance btw coils = radius)",
)

chart_zoom = cul.plot_field(
    df_field, axis='x_mm', Baxis=['Bx_total_mT'],
    pos_mm=0.0, homo_region_mm=0.5,
    is_zoom_on_pos=True,  dezoom_factor=0.001,
    is_save=True, save_filename='helmholtz_zoom_center', savepath_png=savepath_png, savepath_html=savepath_html,
    title="Helmholtz circular coils (distance btw coils = radius)",
    log_level='DEBUG',
)