"use strict";(self.webpackChunk_jupyter_ai_contrib_server_documents=self.webpackChunk_jupyter_ai_contrib_server_documents||[]).push([[291],{1291:(e,t,o)=>{o.r(t),o.d(t,{backupCellExecutorPlugin:()=>be,default:()=>we,executionIndicator:()=>ye,kernelStatus:()=>fe,plugin:()=>_e,rtcGlobalAwarenessPlugin:()=>ve});var s=o(489),n=o(8490),r=o(428),i=o(5014),a=o(2570),l=o(14),c=o(3345),d=o.n(c),h=o(2840);class u extends h.VDomRenderer{constructor(e,t=!0){super(new u.Model),this.translator=e||a.nullTranslator,this.addClass("jp-mod-highlighted")}render(){if(null!==this.model&&this.model.renderFlag){const e=this.model.currentNotebook;return e?d().createElement(r.ExecutionIndicatorComponent,{displayOption:this.model.displayOption,state:this.model.executionState(e),translator:this.translator}):d().createElement(r.ExecutionIndicatorComponent,{displayOption:this.model.displayOption,state:void 0,translator:this.translator})}return d().createElement("div",null)}}!function(e){class t extends r.ExecutionIndicator.Model{attachNotebook(e){var t;const o=null==e?void 0:e.content;if(!o)return;this._currentNotebook=o,this._notebookExecutionProgress.set(o,{executionStatus:"idle",kernelStatus:"idle",totalTime:0,interval:0,timeout:0,scheduledCell:new Set,scheduledCellNumber:0,needReset:!0});const s=this._notebookExecutionProgress.get(o);null===(t=null==o?void 0:o.model)||void 0===t||t.sharedModel.awareness.on("change",(e=>{var t;if(s){const e=null===(t=null==o?void 0:o.model)||void 0===t?void 0:t.sharedModel.awareness.getStates();if(e)for(const[,t]of e)if("kernel"in t)return s.kernelStatus=t.kernel.execution_state,void this.stateChanged.emit(void 0)}})),super.attachNotebook(e)}}e.Model=t}(u||(u={}));var g=o(6469),p=o(2830);async function _(e="",t={}){const o=p.ServerConnection.makeSettings(),s=g.URLExt.join(o.baseUrl,e.startsWith("/")?"":"jupyter-server-documents",e);let n;try{n=await p.ServerConnection.makeRequest(s,t,o)}catch(e){throw new p.ServerConnection.NetworkError(e)}const r=n.headers.get("Content-Type")||"";let i;const a=await n.text();if(r.includes("application/x-ndjson"))i=a.trim().split("\n").map((e=>JSON.parse(e)));else if(a.length>0)try{i=JSON.parse(a)}catch(e){console.log("Not a JSON response body.",n)}if(!n.ok)throw new p.ServerConnection.ResponseError(n,i.message||i);return i}var v=o(4019),m=o(7898),y=o(7630),f=o(8e3),b=o(3875),w=o(2206),C=o(6381),S=o(4602);class k extends f.YFile{constructor(){super(),this._resetSignal=new S.Signal(this)}reset(){this._ystate.unobserve(this.onStateChanged),this.ysource.unobserve(this._modelObserver),this._ydoc=new w.Doc,this.ysource=this.ydoc.getText("source"),this._ystate=this.ydoc.getMap("state"),this._undoManager=new w.UndoManager([],{trackedOrigins:new Set([this]),doc:this._ydoc}),this._undoManager.addToScope(this.ysource),this._awareness=new C.ww(this.ydoc),this._resetSignal.emit(null),this._ystate.observe(this.onStateChanged),this.ysource.observe(this._modelObserver)}get resetSignal(){return this._resetSignal}}class x extends f.YNotebook{constructor(e){super(e),this._resetSignal=new S.Signal(this)}reset(){this._ycells.unobserve(this._onYCellsChanged),this.ymeta.unobserveDeep(this._onMetaChanged),this._ystate.unobserve(this.onStateChanged),this._ydoc=new w.Doc,this._ystate=this.ydoc.getMap("state"),this._ycells=this.ydoc.getArray("cells"),this.cells=[],this.ymeta=this.ydoc.getMap("meta"),this._undoManager=new w.UndoManager([],{trackedOrigins:new Set([this]),doc:this._ydoc}),this._undoManager.addToScope(this._ycells),this._awareness=new C.ww(this.ydoc),this._resetSignal.emit(null),this._ycells.observe(this._onYCellsChanged),this.ymeta.observeDeep(this._onMetaChanged),this._ystate.observe(this.onStateChanged)}get resetSignal(){return this._resetSignal}}class M extends b.YChat{constructor(){super(),this._resetSignal=new S.Signal(this)}reset(){this._users.unobserve(this._usersObserver),this._messages.unobserve(this._messagesObserver),this._attachments.unobserve(this._attachmentsObserver),this._metadata.unobserve(this._metadataObserver),this._ydoc=new w.Doc,this._users=this.ydoc.getMap("users"),this._messages=this.ydoc.getArray("messages"),this._attachments=this.ydoc.getMap("attachments"),this._metadata=this.ydoc.getMap("metadata"),this._awareness=new C.ww(this.ydoc),this._resetSignal.emit(null),this._users.observe(this._usersObserver),this._messages.observe(this._messagesObserver),this._attachments.observe(this._attachmentsObserver),this._metadata.observe(this._metadataObserver)}get resetSignal(){return this._resetSignal}}var I=o(3571),P=o(7262),D=o(2081),N=o(3379);class T{constructor(e){this._onConnectionClosed=e=>{const t=e.code;4e3!==t?4001!==t?4002!==t?(console.error("WebSocket connection was closed. Close event: ",e),(0,l.showErrorMessage)(this._trans.__("Document session error"),"Please refresh the browser tab.",[l.Dialog.okButton()]),this._sharedModel.dispose()):this._handleIbDeletion():this._handleOobMove():this._handleOobChange()},this._onSync=e=>{e&&(this._yWebsocketProvider&&this._yWebsocketProvider.off("sync",this._onSync),this._ready.resolve())},this._ready=new P.PromiseDelegate,this._fileId=null,this._app=e.app,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect().catch((e=>console.warn(e)))}get awareness(){return this._sharedModel.awareness}get isDisposed(){return this._isDisposed}get parentDocumentWidget(){var e;const t=this._app.shell;for(const o of t.widgets()){if(!(o instanceof v.DocumentWidget))continue;const t=o.content;if((t instanceof m.FileEditor||t instanceof r.Notebook||t instanceof N.ChatWidget)&&(null===(e=t.model)||void 0===e?void 0:e.sharedModel)===this._sharedModel)return o}return null}get ready(){return this._ready.promise}get contentType(){return this._contentType}get format(){return this._format}dispose(){var e,t,o;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(o=this._yWebsocketProvider)||void 0===o||o.destroy(),this._disconnect(),S.Signal.clearData(this))}async reconnect(){this._disconnect(),this._connect()}async _getFileId(){let e=null;try{const t=await async function(e="",t={}){const o=p.ServerConnection.makeSettings(),s=g.URLExt.join(o.baseUrl,e);let n;try{n=await p.ServerConnection.makeRequest(s,t,o)}catch(e){throw new p.ServerConnection.NetworkError(e)}let r=await n.text();if(r.length>0)try{r=JSON.parse(r)}catch(e){console.error("Not a JSON response body.",n)}if(!n.ok)throw new p.ServerConnection.ResponseError(n,r.message||r);return r}(`api/fileid/index?path=${this._path}`,{method:"POST"});t&&"id"in t&&"string"==typeof t.id&&(e=t.id)}catch(e){return console.error(`Could not get file ID for path '${this._path}'.`),null}return e}async _connect(){this._fileId||(this._fileId=await this._getFileId()),this._fileId?(this._yWebsocketProvider=new D.WebsocketProvider(this._serverUrl,`${this._format}:${this._contentType}:${this._fileId}`,this._sharedModel.ydoc,{disableBc:!0,awareness:this.awareness}),this._yWebsocketProvider.on("sync",this._onSync),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)):(0,l.showErrorMessage)(this._trans.__("File ID error"),`The file '${this._path}' cannot be opened because its file ID could not be retrieved. Please report this issue on GitHub.`,[l.Dialog.okButton()])}get wsProvider(){return this._yWebsocketProvider}_disconnect(){var e,t,o;null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.off("sync",this._onSync),null===(o=this._yWebsocketProvider)||void 0===o||o.destroy(),this._yWebsocketProvider=null}_onUserChanged(e){this.awareness.setLocalStateField("user",e.identity)}_handleOobChange(){this._sharedModel.reset(),this.reconnect()}_handleOobMove(){this._stopCloseAndNotify(`The file '${this._path}' no longer exists, and was either moved or deleted. The document tab has been closed.`)}_handleIbDeletion(){this._stopCloseAndNotify(`The file '${this._path}' was deleted. The document tab has been closed.`)}_stopCloseAndNotify(e){this._sharedModel.dispose();const t=this.parentDocumentWidget;t&&(t.close(),l.Notification.warning(e,{autoClose:1e4}))}}const E="true"===g.PageConfig.getOption("disableRTC");class A extends p.RestContentProvider{constructor(e){super(e),this._onCreate=(e,t)=>{var o,s;if("string"==typeof e.format)try{const n=new T({app:this._app,url:g.URLExt.join(this._serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),r=((null===(o=this._globalAwareness)||void 0===o?void 0:o.getLocalState())||{}).documents||[];r.includes(e.path)||(r.push(e.path),null===(s=this._globalAwareness)||void 0===s||s.setLocalStateField("documents",r));const i=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(i,n),t.changed.connect((async(o,s)=>{var n;if(!s.stateChange)return;const r=s.stateChange.filter((e=>"hash"===e.name));if(0===r.length)return;r.length>1&&console.error("Unexpected multiple changes to hash value in a single transaction");const i=r[0],a=null!==(n=t.state.path)&&void 0!==n?n:e.path,l=await this.get(a,{content:!1});this._ydriveFileChanged.emit({type:"save",newValue:{...l,hash:i.newValue},oldValue:{hash:i.oldValue}})})),t.disposed.connect((()=>{var t,o;const s=this._providers.get(i);s&&(s.dispose(),this._providers.delete(i));const n=((null===(t=this._globalAwareness)||void 0===t?void 0:t.getLocalState())||{}).documents||[],r=n.indexOf(e.path);r>-1&&n.splice(r,1),null===(o=this._globalAwareness)||void 0===o||o.setLocalStateField("documents",n)}))}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._ydriveFileChanged=new S.Signal(this),this._app=e.app,this._user=e.user,this._trans=e.trans,this._globalAwareness=e.globalAwareness,this._serverSettings=e.serverSettings,this.sharedModelFactory=new O(this._onCreate),this._providers=new Map}get providers(){return this._providers}async get(e,t){if(t&&t.format&&t.type){const o=`${t.format}:${t.type}:${e}`,s=this._providers.get(o);if(s){const[o]=await Promise.all([super.get(e,{...t,content:!1}),s.ready]);return{...o,format:t.format}}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const o=`${t.format}:${t.type}:${e}`;if(this._providers.get(o)){const o={type:t.type,format:t.format,content:!1};return this.get(e,o)}}return super.save(e,t)}get fileChanged(){return this._ydriveFileChanged}}class O{constructor(e){this._onCreate=e,this.collaborative=!E,this.documentFactories=new Map}registerDocumentFactory(e,t){if(this.documentFactories.has(e)&&"chat"!==e)throw new Error(`The content type ${e} already exists.`);this.documentFactories.set(e,t)}createNew(e){var t;if("string"!=typeof e.format)return void console.warn(`Only defined format are supported; got ${e.format}.`);const o=this.collaborative,s=null===(t=e.collaborative)||void 0===t||t;if(o&&s&&this.documentFactories.has(e.contentType)){const t=this.documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}}const F="The file %1 has been opened with two different views. This is not supported. Please close this view; otherwise, some of your edits may not be saved properly.",R={id:"@jupyter-ai-contrib/server-documents:rtc-content-provider",description:"The RTC content provider",provides:I.ICollaborativeContentProvider,requires:[a.ITranslator],optional:[I.IGlobalAwareness],activate:(e,t,o)=>{const s=t.load("jupyter_collaboration"),n=e.serviceManager.contents.defaultDrive;if(!n)throw Error("Cannot initialize content provider: default drive property not accessible on contents manager instance.");const r=n.contentProviderRegistry;if(!r)throw Error("Cannot initialize content provider: no content provider registry.");const i=new A({app:e,apiEndpoint:"/api/contents",serverSettings:n.serverSettings,user:e.serviceManager.user,trans:s,globalAwareness:o});return r.register("rtc",i),i}},$={id:"@jupyter-ai-contrib/server-documents:yfile",description:"Plugin to register the shared model factory for the content type 'file'",autoStart:!0,requires:[I.ICollaborativeContentProvider,m.IEditorWidgetFactory],activate:(e,t,o)=>{t.sharedModelFactory.registerDocumentFactory("file",(()=>new k)),o.contentProviderId="rtc"}},j={id:"@jupyter-ai-contrib/server-documents:ynotebook",description:"Plugin to register the shared model factory for the content type 'notebook'",autoStart:!0,requires:[I.ICollaborativeContentProvider,r.INotebookWidgetFactory],optional:[n.ISettingRegistry],activate:(e,t,o,s)=>{let n=!0;s&&s.load("@jupyterlab/notebook-extension:tracker").then((e=>{const t=e=>{const t=null==e?void 0:e.get("experimentalEnableDocumentWideUndoRedo").composite;n=!(null!=t&&t)};t(e),e.changed.connect((e=>t(e)))})),t.sharedModelFactory.registerDocumentFactory("notebook",(()=>new x({disableDocumentWideUndoRedo:n}))),o.contentProviderId="rtc"}},W={id:"@jupyter-ai-contrib/server-documents:ychat",description:"Plugin to register a custom YChat factory and handle document resets.",autoStart:!0,requires:[I.ICollaborativeContentProvider],optional:[b.IChatFactory],activate:(e,t,o)=>{o?t.sharedModelFactory.registerDocumentFactory("chat",(()=>{const t=new M;return t.resetSignal.connect((()=>{(t=>{for(const o of e.shell.widgets()){if(!(o instanceof v.DocumentWidget))continue;const e=o.content.model,s=e&&e._sharedModel;if(e instanceof N.AbstractChatModel&&s instanceof M&&s===t){e._messages=[],e._messagesUpdated.emit();break}}})(t)})),t})):console.warn("No existing shared model factory found for chat. Not providing custom chat shared model.")}},L={id:"@jupyter-ai-contrib/server-documents:rtc-drive-logger",description:"A logging plugin for debugging purposes.",autoStart:!0,optional:[y.ILoggerRegistry,m.IEditorTracker,r.INotebookTracker,a.ITranslator],activate:(e,t,o,s,n)=>{const r=(null!=n?n:a.nullTranslator).load("jupyter_collaboration"),i="https://schema.jupyter.org/jupyter_collaboration/session/v1";if(!t)return void e.serviceManager.events.stream.connect(((e,t)=>{var o,s;t.schema_id===i&&(console.debug(`[${t.room}(${t.path})] ${null!==(o=t.action)&&void 0!==o?o:""}: ${null!==(s=t.msg)&&void 0!==s?s:""}`),"WARNING"===t.level&&(0,l.showDialog)({title:r.__("Warning"),body:r.__(F,t.path),buttons:[l.Dialog.okButton()]}))}));const c=new Map,d=(e,o)=>{const s=t.getLogger(o.context.path);c.set(o.context.localPath,s),o.disposed.connect((e=>{c.delete(e.context.localPath)}))};o&&o.widgetAdded.connect(d),s&&s.widgetAdded.connect(d),(async()=>{var t,o;const{events:s}=e.serviceManager;for await(const e of s.stream)if(e.schema_id===i){const s=c.get(e.path);null==s||s.log({type:"text",level:e.level.toLowerCase(),data:`[${e.room}] ${null!==(t=e.action)&&void 0!==t?t:""}: ${null!==(o=e.msg)&&void 0!==o?o:""}`}),"WARNING"===e.level&&(0,l.showDialog)({title:r.__("Warning"),body:r.__(F,e.path),buttons:[l.Dialog.warnButton({label:r.__("Ok")})]})}})()}};var Y=o(5614);class U extends D.WebsocketProvider{constructor(e){super(e.url,e.roomID,e.awareness.doc,{awareness:e.awareness}),this._isDisposed=!1,this._awareness=e.awareness,this._user=e.user,this._user.ready.then((()=>this._onUserChanged(this._user))).catch((e=>console.error(e))),this._user.userChanged.connect(this._onUserChanged,this)}get isDisposed(){return this._isDisposed}dispose(){this._isDisposed||(this._user.userChanged.disconnect(this._onUserChanged,this),this._isDisposed=!0,this.destroy())}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}function V(e){const t=(e.translator||a.nullTranslator).load("jupyterlab");let o="";return e.status&&(o=` | ${e.status}`),d().createElement(i.TextItem,{onClick:e.handleClick,onKeyDown:e.handleKeyDown,source:`${e.kernelName}${o}`,title:t.__("Change kernel for %1",e.activityName),tabIndex:0})}class J extends h.VDomRenderer{constructor(e,t){super(new J.Model(t)),this.translator=t||a.nullTranslator,this._handleClick=e.onClick,this._handleKeyDown=e.onKeyDown,this.addClass("jp-mod-highlighted")}render(){return null===this.model?null:d().createElement(V,{status:this.model.status,kernelName:this.model.kernelName,activityName:this.model.activityName,handleClick:this._handleClick,handleKeyDown:this._handleKeyDown,translator:this.translator})}}!function(e){class t extends l.KernelStatus.Model{attachDocument(e){var t;if(!e)return;const o=e;null===(t=o.model)||void 0===t||t.sharedModel.awareness.on("change",(()=>{var e;if(this){const t=null===(e=null==o?void 0:o.model)||void 0===e?void 0:e.sharedModel.awareness.getStates();if(t)for(const[,e]of t)if("kernel"in e)return this._kernelStatus=e.kernel.execution_state,void this.stateChanged.emit(void 0)}}))}set sessionContext(e){var t;const o=this._getAllState();this._sessionContext=e,this._kernelName=null!==(t=null==e?void 0:e.kernelDisplayName)&&void 0!==t?t:this._trans.__("No Kernel"),this._triggerChange(o,this._getAllState()),null==e||e.kernelChanged.connect(this._onKernelDisplayNameChanged,this)}_onKernelDisplayNameChanged(e,t){const o=this._getAllState();this._kernelName=e.kernelDisplayName,this._triggerChange(o,this._getAllState())}}e.Model=t}(J||(J={}));var K=o(6261),q=o(195),B=o(5024);class G{constructor(e){this.undoManager=e}}const z=q.Facet.define({combine:e=>e[e.length-1]}),H=B.ViewPlugin.fromClass(class{constructor(e){this._onStackItemAdded=({stackItem:e,changedParentTypes:t})=>{t.has(this._syncConf.getYText())&&this._beforeChangeSelection&&!e.meta.has(this)&&e.meta.set(this,this._beforeChangeSelection)},this._onStackItemPopped=({stackItem:e})=>{const t=e.meta.get(this);if(t){const e=this._syncConf.fromYRange(t);this._view.dispatch(this._view.state.update({selection:e,effects:[B.EditorView.scrollIntoView(e)]})),this._storeSelection()}},this._storeSelection=()=>{this._beforeChangeSelection=this._syncConf.toYRange(this._view.state.selection.main)},this._view=e,this._conf=e.state.facet(z),this._undoManager=this._conf.undoManager,this._syncConf=e.state.facet(Z),this._beforeChangeSelection=null,this._undoManager.on("stack-item-added",this._onStackItemAdded),this._undoManager.on("stack-item-popped",this._onStackItemPopped),this._undoManager.addTrackedOrigin(this._syncConf)}update(e){!e.selectionSet||0!==e.transactions.length&&e.transactions[0].annotation(ee)===this._syncConf||this._storeSelection()}destroy(){this._undoManager.off("stack-item-added",this._onStackItemAdded),this._undoManager.off("stack-item-popped",this._onStackItemPopped),this._undoManager.removeTrackedOrigin(this._syncConf)}});class Q{constructor(e,t){this.yanchor=e,this.yhead=t}toJSON(){return{yanchor:(0,w.relativePositionToJSON)(this.yanchor),yhead:(0,w.relativePositionToJSON)(this.yhead)}}static fromJSON(e){return new Q((0,w.createRelativePositionFromJSON)(e.yanchor),(0,w.createRelativePositionFromJSON)(e.yhead))}}class X{constructor(e,t){this.getYText=e,this.ytextResetSignal=t}toYPos(e,t=0){return(0,w.createRelativePositionFromTypeIndex)(this.getYText(),e,t)}fromYPos(e){const t=(0,w.createAbsolutePositionFromRelativePosition)((0,w.createRelativePositionFromJSON)(e),this.getYText().doc);if(null===t||t.type!==this.getYText())throw new Error("[y-codemirror] The position you want to retrieve was created by a different document");return{pos:t.index,assoc:t.assoc}}toYRange(e){const t=e.assoc,o=this.toYPos(e.anchor,t),s=this.toYPos(e.head,t);return new Q(o,s)}fromYRange(e){const t=this.fromYPos(e.yanchor),o=this.fromYPos(e.yhead);return t.pos===o.pos?q.EditorSelection.cursor(o.pos,o.assoc):q.EditorSelection.range(t.pos,o.pos)}}const Z=q.Facet.define({combine:e=>e[e.length-1]}),ee=q.Annotation.define(),te=B.ViewPlugin.fromClass(class{constructor(e){this.view=e,this.conf=e.state.facet(Z),this._getYText=this.conf.getYText,this._ytext=this._getYText(),this._resetSignal=this.conf.ytextResetSignal,this._ytext_observer=(e,t)=>this._handle_ytext_update(e,t),this._ytext.observe(this._ytext_observer),this._resetSignalSlot=()=>{this._handle_reset()},this._resetSignal&&this._resetSignal.connect(this._resetSignalSlot)}_handle_ytext_update(e,t){var o;if(t.origin!==this.conf){const t=e.delta,s=[];let n=0;for(let e=0;e<t.length;e++){const r=t[e];null!=r.insert?s.push({from:n,to:n,insert:r.insert}):null!=r.delete?(s.push({from:n,to:n+r.delete,insert:""}),n+=r.delete):n+=null!==(o=r.retain)&&void 0!==o?o:0}this.view.dispatch({changes:s,annotations:[ee.of(this.conf)]})}}_handle_reset(){this._ytext.unobserve(this._ytext_observer),this.view.dispatch({changes:{from:0,to:this.view.state.doc.toString().length,insert:""}}),this._ytext=this._getYText(),this._ytext.observe(this._ytext_observer)}update(e){if(!e.docChanged||e.transactions.length>0&&e.transactions[0].annotation(ee)===this.conf)return;const t=this._ytext;t.doc.transact((()=>{let o=0;e.changes.iterChanges(((e,s,n,r,i)=>{const a=i.sliceString(0,i.length,"\n");e!==s&&t.delete(e+o,s-e),a.length>0&&t.insert(e+o,a),o+=a.length-(s-e)}))}),this.conf)}destroy(){this._ytext.unobserve(this._ytext_observer),this._resetSignal&&this._resetSignal.disconnect(this._resetSignalSlot)}}),oe={id:"@jupyter-ai-contrib/server-documents:ybinding",description:"Register the CodeMirror extension factory binding the editor and the shared model.",autoStart:!0,requires:[K.IEditorExtensionRegistry],activate:(e,t)=>{t.addExtension({name:"shared-model-binding",factory:e=>{var t;const o=e.model.sharedModel;return K.EditorExtensionRegistry.createImmutableExtension(function(e){const t=new X(e.getYText,e.ytextResetSignal),o=[Z.of(t),te];return e.undoManager&&o.push(z.of(new G(e.undoManager)),H),o}({getYText:()=>o.ysource,ytextResetSignal:o.resetSignal,undoManager:null!==(t=o.undoManager)&&void 0!==t?t:void 0}))}})}};var se=o(6711),ne=o(283),re=o(9198);class ie extends r.Notebook{constructor(e){super(e),this._resetSignalSlot=()=>this._onReset()}get model(){return super.model}set model(e){const t=this.model;t&&t.sharedModel.resetSignal.disconnect(this._resetSignalSlot),super.model=e,e&&e.sharedModel.resetSignal.connect(this._resetSignalSlot)}_onReset(){this.model?this.onModelContentChanged(this.model):console.warn("The notebook was reset without a model. This should never happen.")}}const ae=(0,f.createMutex)(),le="jp-mod-dirty";ne.CodeCellModel.prototype._onSharedModelChanged=function(e,t){t.streamOutputChange&&ae((()=>{for(const e of t.streamOutputChange)"delete"in e&&this._outputs.removeStreamOutput(e.delete),"insert"in e&&this._outputs.appendStreamOutput(e.insert.toString())})),t.outputsChange&&ae((()=>{var e;let o=0;for(const s of t.outputsChange){if("retain"in s&&(o+=s.retain),"delete"in s)for(let e=0;e<s.delete;e++)this._outputs.remove(o);if("insert"in s)for(const t of s.insert)if("toJSON"in t){const o=t.toJSON();(null===(e=o.metadata)||void 0===e?void 0:e.url)?_(o.metadata.url).then((e=>{this._outputs.add(e)})):this._outputs.add(o)}else this._outputs.add(t)}})),t.executionCountChange&&(!t.executionCountChange.newValue||!this.isDirty&&t.executionCountChange.oldValue||this._setDirty(!1),this.stateChanged.emit({name:"executionCount",oldValue:t.executionCountChange.oldValue,newValue:t.executionCountChange.newValue})),t.sourceChange&&null!==this.executionCount&&this._setDirty(this._executedCode!==this.sharedModel.getSource().trim())},ne.CodeCellModel.prototype.onOutputsChange=function(e,t){};class ce extends re.OutputAreaModel{constructor(e={}){var t,o;if(super({...e,values:[]}),null===(t=e.values)||void 0===t?void 0:t.length){const t=e.values[0];if(null===(o=t.metadata)||void 0===o?void 0:o.url){let e=t.metadata.url;e=e.substring(0,e.lastIndexOf("/")),_(e).then((e=>{e.forEach((e=>{if(!this.isDisposed){const t=this._add(e)-1;this.list.get(t).changed.connect(this._onGenericChange,this)}}))})).catch((e=>{console.error("Error fetching output:",e)}))}else e.values.forEach((e=>{if(!this.isDisposed){const t=this._add(e)-1;this.list.get(t).changed.connect(this._onGenericChange,this)}}))}}}ne.CodeCell.prototype.onStateChanged=function(e,t){switch(t.name){case"executionCount":this._updatePrompt();break;case"isDirty":e.isDirty?this.addClass(le):this.removeClass(le)}this._updatePrompt()},ne.CodeCell.prototype._updatePrompt=function(){let e;e="busy"===this._getCellExecutionStateFromAwareness()?"*":`${this.model.executionCount||""}`,this._setPrompt(e)},ne.CodeCell.prototype._getCellExecutionStateFromAwareness=function(){var e,t,o;const s=null===(e=this.parent)||void 0===e?void 0:e.parent;if(!(null===(o=null===(t=null==s?void 0:s.model)||void 0===t?void 0:t.sharedModel)||void 0===o?void 0:o.awareness))return null;const n=s.model.sharedModel.awareness.getStates();if(0===n.size)return null;let r=!1;for(const[e,t]of n)if(t&&"cell_execution_states"in t){const e=t.cell_execution_states;if(r=!0,e&&this.model.sharedModel.getId()in e)return e[this.model.sharedModel.getId()]}return r?void 0:null},ne.CodeCell.prototype.initializeState=function(){return this._setupAwarenessListener(),this},ne.CodeCell.prototype._setupAwarenessListener=function(){const e=()=>{this._updatePrompt()};this.ready.then((()=>{var t,o,s;const n=null===(t=this.parent)||void 0===t?void 0:t.parent;(null===(s=null===(o=null==n?void 0:n.model)||void 0===o?void 0:o.sharedModel)||void 0===s?void 0:s.awareness)&&(n.model.sharedModel.awareness.on("change",e),this._awarenessUpdateListener=e,this._awarenessInstance=n.model.sharedModel.awareness,this._updatePrompt())}))};const de=ne.CodeCell.prototype.dispose;ne.CodeCell.prototype.dispose=function(){this._awarenessUpdateListener&&this._awarenessInstance&&(this._awarenessInstance.off("change",this._awarenessUpdateListener),this._awarenessUpdateListener=null,this._awarenessInstance=null),de.call(this)},ne.CodeCellModel.ContentFactory.prototype.createOutputArea=function(e){return new ce(e)};class he extends r.NotebookPanel.ContentFactory{createCodeCell(e){return new ne.CodeCell(e).initializeState()}createNotebook(e){return new ie(e)}}r.NotebookActions.outputCleared.connect(((e,t)=>{var o;const{notebook:s,cell:n}=t,r=n.model.sharedModel.getId(),i=null===(o=s.model)||void 0===o?void 0:o.sharedModel.awareness,a=null==i?void 0:i.getStates();try{n.model.sharedModel.setOutputs([]),console.debug(`Cleared outputs in YDoc for cell ${r}`)}catch(e){console.error("Error clearing YDoc outputs:",e)}if(0===(null==a?void 0:a.size))return void console.log("Could not delete cell output, awareness is not present");let l=null;for(const[e,t]of a||[])t&&"file_id"in t&&(l=t.file_id);if(null!==l)try{_(`/api/outputs/${l}/${r}`,{method:"DELETE"}).then((()=>{console.debug(`Successfully cleared outputs from disk for cell ${r}`)})).catch((e=>{console.error(`Failed to clear outputs from disk for cell ${r}:`,e)}))}catch(e){console.error("Error in disk output clearing process:",e)}else console.error("No fileId found in awareness")}));const ue={id:"@jupyter-ai-contrib/server-documents:notebook-factory",description:"Provides the notebook cell factory.",provides:r.NotebookPanel.IContentFactory,requires:[se.IEditorServices],autoStart:!0,activate:(e,t)=>{const o=t.factoryService.newInlineEditor;return new he({editorFactory:o})}},ge="Autosaving is enabled, manual saves are not needed",pe={id:"@jupyter-ai-contrib/server-documents:disable-save-plugin",description:"Disables save commands and removes their keyboard shortcuts since documents are autosaved",autoStart:!0,activate:e=>{let t=0,o=0,s=0,n=0;e.restored.then((()=>{const r=(t,o)=>{if(e.commands.hasCommand(t)){const s=e.commands;s._commands&&s._commands.delete&&s._commands.delete(t),e.commands.addCommand(t,o)}},i=()=>{l.Notification.emit(ge,"info",{autoClose:2e3})};r("docmanager:save",{label:"Save (Autosaving)",caption:ge,isEnabled:()=>!0,execute:()=>(t%20==0&&i(),t++,Promise.resolve())}),r("docmanager:save-as",{label:"Save Asâ€¦ (Autosaving)",caption:ge,isEnabled:()=>!0,execute:()=>(o%20==0&&i(),o++,Promise.resolve())}),r("docmanager:save-all",{label:"Save All (Autosaving)",caption:ge,isEnabled:()=>!0,execute:()=>(s%20==0&&i(),s++,Promise.resolve())}),r("docmanager:toggle-autosave",{label:"Autosave Documents (Autosaving)",caption:ge,isEnabled:()=>!0,isToggled:()=>!0,execute:()=>(n%20==0&&i(),n++,Promise.resolve())}),console.log("Full autosave enabled, save commands disabled")}))}},_e={id:"@jupyter-ai-contrib/server-documents:plugin",description:"A JupyterLab extension that provides RTC capabilities.",autoStart:!0,optional:[n.ISettingRegistry],activate:(e,t)=>{console.log("JupyterLab extension @jupyter-ai-contrib/server-documents is activated!"),t&&t.load(_e.id).then((e=>{console.log("@jupyter-ai-contrib/server-documents settings loaded:",e.composite)})).catch((e=>{console.error("Failed to load settings for @jupyter-ai-contrib/server-documents.",e)})),_("get-example").then((e=>{console.log(e)})).catch((e=>{console.error(`The jupyter_server_documents server extension appears to be missing.\n${e}`)}))}},ve={id:"@jupyter-ai-contrib/server-documents:rtc-global-awareness",description:"Add global awareness to share working document of users.",requires:[Y.IStateDB],provides:I.IGlobalAwareness,activate:(e,t)=>{const{user:o}=e.serviceManager,s=new w.Doc,n=new C.ww(s),r=p.ServerConnection.makeSettings(),i=g.URLExt.join(r.wsUrl,"api/collaboration/room");return new U({url:i,roomID:"JupyterLab:globalAwareness",awareness:n,user:o}),t.changed.connect((async()=>{var e,o;const s=(null===(o=null===(e=(await t.toJSON())["layout-restorer:data"])||void 0===e?void 0:e.main)||void 0===o?void 0:o.current)||"";s.match(/^\w+:.+/)?n.setLocalStateField("current",s):n.setLocalStateField("current",null)})),n}};class me{createNew(e){const t=new u,o=e.content;return t.model.attachNotebook({content:o}),e.toolbar.insertAfter("kernelName","awarenessExecutionProgress",t),t}}const ye={id:"@jupyter-ai-contrib/server-documents:awareness-execution-indicator",description:"Adds a notebook execution status widget.",autoStart:!0,requires:[r.INotebookTracker,s.ILabShell,a.ITranslator,l.IToolbarWidgetRegistry],optional:[i.IStatusBar,n.ISettingRegistry],activate:(e,t,o,s,n,r,i)=>{console.log("JupyterLab extension activated: Awareness Execution Indicator"),e.docRegistry.addWidgetExtension("Notebook",new me)}},fe={id:"@jupyter-ai-contrib/server-documents:awareness-kernel-status",description:"Provides the kernel status indicator model.",autoStart:!0,requires:[i.IStatusBar],provides:l.IKernelStatusModel,optional:[l.ISessionContextDialogs,a.ITranslator,s.ILabShell],activate:(e,t,o,s,n)=>{console.log("JupyterLab extension activated: Awareness Kernel Status Indicator");const r=null!=s?s:a.nullTranslator,i=null!=o?o:new l.SessionContextDialogs({translator:r}),c=async()=>{d.model.sessionContext&&await i.selectKernel(d.model.sessionContext)},d=new J({onClick:c,onKeyDown:async e=>{if("Enter"===e.key||"Spacebar"===e.key||" "===e.key)return e.preventDefault(),e.stopPropagation(),c()}},r),h=new Set;function u(e,t){var o;const{oldValue:s,newValue:n}=t;s&&s.title.changed.disconnect(g),d.model.attachDocument(n),d.model.sessionContext=null!==(o=[...h].map((e=>e(t.newValue))).filter((e=>null!==e))[0])&&void 0!==o?o:null,n&&d.model.sessionContext&&(g(n.title),n.title.changed.connect(g))}const g=e=>{d.model.activityName=e.label};return n&&n.currentChanged.connect(u),t.registerStatusItem(fe.id,{priority:1,item:d,align:"left",rank:1,isActive:()=>!0}),{addSessionProvider:t=>{h.add(t),e.shell.currentWidget&&u(e.shell,{newValue:e.shell.currentWidget,oldValue:null})}}}},be={id:"@jupyter-ai-contrib/server-documents:backup-cell-executor",description:"Provides a backup default implementation of the notebook cell executor.",autoStart:!1,provides:r.INotebookCellExecutor,activate:()=>Object.freeze({runCell:r.runCell})},we=[R,$,j,L,ve,_e,ye,fe,ue,oe,be,pe,W]}}]);