"use strict";(self.webpackChunk_jupyter_ai_contrib_server_documents=self.webpackChunk_jupyter_ai_contrib_server_documents||[]).push([[280],{2280:(e,t,s)=>{s.r(t),s.d(t,{ChatWidgetFactory:()=>_,CommandIDs:()=>C,IActiveCellManagerToken:()=>v,IChatFactory:()=>f,IChatPanel:()=>M,ISelectionWatcherToken:()=>b,IWelcomeMessage:()=>w,LabChatContext:()=>l,LabChatModel:()=>c,LabChatModelFactory:()=>p,LabChatPanel:()=>g,WidgetConfig:()=>m,YChat:()=>o,chatFileType:()=>y,getDisplayName:()=>S});var a=s(2728),n=s(4019),i=s(4602),r=s(7262),h=s(8e3);class o extends h.YDocument{constructor(e){super(e),this.version="1.0.0",this._usersObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._users.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._users.get(s),type:"change"})}})),this._changed.emit({userChanges:t})},this._messagesObserver=e=>{const t=e.delta;this._changed.emit({messageChanges:t})},this._attachmentsObserver=e=>{const t=new Array;e.keysChanged.forEach((s=>{const a=e.changes.keys.get(s);if(a)switch(a.action){case"add":t.push({key:s,newValue:this._attachments.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:a.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:a.oldValue,newValue:this._attachments.get(s),type:"change"})}})),this._changed.emit({attachmentChanges:t})},this._metadataObserver=e=>{const t=new Array;e.changes.keys.forEach(((e,s)=>{switch(e.action){case"add":t.push({key:s,newValue:this._metadata.get(s),type:"add"});break;case"delete":t.push({key:s,oldValue:e.oldValue,type:"remove"});break;case"update":t.push({key:s,oldValue:e.oldValue,newValue:this._metadata.get(s),type:"change"})}})),this._changed.emit({metadataChanges:t})},this._users=this.ydoc.getMap("users"),this._users.observe(this._usersObserver),this._messages=this.ydoc.getArray("messages"),this._messages.observe(this._messagesObserver),this._attachments=this.ydoc.getMap("attachments"),this._attachments.observe(this._attachmentsObserver),this._metadata=this.ydoc.getMap("metadata"),this._metadata.observe(this._metadataObserver)}static create(e){return new o(e)}get id(){return this._metadata.get("id")||""}get users(){return r.JSONExt.deepCopy(this._users.toJSON())}get messages(){return r.JSONExt.deepCopy(this._messages.toJSON())}get attachments(){return r.JSONExt.deepCopy(this._attachments.toJSON())}getSource(){return{users:this._users.toJSON(),messages:this._messages.toJSON(),metadata:this._metadata.toJSON()}}setSource(e){e&&this.transact((()=>{var t,s,a;(null!==(t=e.messages)&&void 0!==t?t:[]).forEach((e=>{this._messages.push([e])}));const n=null!==(s=e.users)&&void 0!==s?s:{};Object.entries(n).forEach((([e,t])=>this._users.set(e,t)));const i=null!==(a=e.metadata)&&void 0!==a?a:{};Object.entries(i).forEach((([e,t])=>this._metadata.set(e,t)))}))}getUser(e){if(e)return this._users.get(e)}setUser(e){this.transact((()=>{"toJSON"in e&&"function"==typeof e.toJSON&&(e=e.toJSON()),this._users.set(e.username,e)}))}getMessage(e){return this._messages.get(e)}addMessage(e){this.transact((()=>{this._messages.push([e])}))}updateMessage(e,t){this.transact((()=>{this._messages.delete(e),this._messages.insert(e,[t])}))}getMessageIndex(e){return this._messages.toArray().findIndex((t=>t.id===e))}deleteMessage(e){this.transact((()=>{this._messages.delete(e)}))}getAttachment(e){return this._attachments.get(e)}setAttachment(e){const t=JSON.stringify(e);let s;for(const[e,a]of this._attachments.entries())if(JSON.stringify(a)===t){s=e;break}const a=s||r.UUID.uuid4();return this.transact((()=>{this._attachments.set(a,e)})),a}}class d{constructor(e){var t;this.username=null!==(t=null==e?void 0:e.username)&&void 0!==t?t:"user undefined",this.name=null==e?void 0:e.name,this.display_name=null==e?void 0:e.display_name,this.color=null==e?void 0:e.color,this.avatar_url=null==e?void 0:e.avatar_url,this.initials=null==e?void 0:e.initials,this.bot=!!(null==e?void 0:e.bot)||!1}get mention_name(){let e=this.display_name||this.name||this.username;return e=e.replace(/ /g,"-"),e}toJSON(){return{...this,mention_name:this.mention_name}}}class c extends a.AbstractChatModel{constructor(e){super(e),this.collaborative=!0,this.onInputChanged=(e,t)=>{if(!e||!this.config.sendTypingNotification)return;const s=this.sharedModel.awareness;null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting),s.setLocalStateField("isWriting",null==t||t),this._timeoutWriting=window.setTimeout((()=>{this._resetWritingStatus()}),1e3)},this.onMessageEditionAdded=(e,t)=>{if(null!==t){const e=(e,s)=>{this.onInputChanged(s,t.id)};t.model.valueChanged.connect(e)}},this.onAwarenessChange=()=>{const e=[],t=this.sharedModel.awareness.getStates();for(const s of t.keys()){const a=t.get(s);if(a&&a.user&&a.user.username!==this.user.username&&void 0!==a.isWriting&&!1!==a.isWriting){const t={user:a.user,messageID:!0===a.isWriting?void 0:a.isWriting};e.push(t)}}this.updateWriters(e)},this._onchange=async(e,t)=>{if(t.messageChanges){const e=t.messageChanges;let s=0;for(const t of e)if(t.retain)s+=t.retain;else if(t.insert){const e=t.insert.map((e=>{const{sender:t,attachments:s,mentions:a,...n}=e,i={...n,sender:this.sharedModel.getUser(t)||{username:"User undefined",mention_name:"User-undefined"}};if(s){const e=[];s.forEach((t=>{const s=this.sharedModel.getAttachment(t);s&&e.push(s)})),e.length&&(i.attachments=e)}const r=(null!=a?a:[]).map((e=>this.sharedModel.getUser(e)||{username:"User undefined",mention_name:"User-undefined"}));return(null==r?void 0:r.length)&&(i.mentions=r),i}));await this.messagesInserted(s,e),s+=e.length}else t.delete&&this.messagesDeleted(s,t.delete)}t.metadataChanges&&t.metadataChanges.forEach((e=>{"id"===e.key&&(this.id=e.newValue)})),t.userChanges&&t.userChanges.forEach((e=>{e.key===this._user.username&&e.newValue&&(this._user=e.newValue)}))},this.defaultKernelName="",this.defaultKernelLanguage="",this._dirty=!1,this._readOnly=!1,this._contentChanged=new i.Signal(this),this._stateChanged=new i.Signal(this),this._timeoutWriting=null,this._user=new d(e.user);const{widgetConfig:t,sharedModel:s}=e;this._sharedModel=s||o.create(),this.sharedModel.changed.connect(this._onchange,this),this.config=t.config,t.configChanged.connect(((e,t)=>{this.config=t})),this.sharedModel.awareness.on("change",this.onAwarenessChange),this.input.valueChanged.connect(((e,t)=>this.onInputChanged(t))),this.messageEditionAdded.connect(this.onMessageEditionAdded)}get user(){return this._user}get sharedModel(){return this._sharedModel}get contentChanged(){return this._contentChanged}get stateChanged(){return this._stateChanged}get dirty(){return this._dirty}set dirty(e){this._dirty=e}get readOnly(){return this._readOnly}set readOnly(e){this._readOnly=e}set id(e){super.id=e,e&&this.setReady()}dispose(){this.isDisposed||(super.dispose(),this._sharedModel.dispose(),i.Signal.clearData(this))}toString(){return JSON.stringify({},null,2)}fromString(e){}toJSON(){return JSON.parse(this.toString())}fromJSON(e){}createChatContext(){return new l({model:this})}async messagesInserted(e,t){return this.ready.then((()=>{super.messagesInserted(e,t)}))}sendMessage(e){var t;this._resetWritingStatus(),null!==this._timeoutWriting&&window.clearTimeout(this._timeoutWriting);const s={type:"msg",id:r.UUID.uuid4(),body:e.body,time:Date.now()/1e3,sender:this._user.username,raw_time:!0};this.sharedModel.getUser(this._user.username)!==this._user&&this.sharedModel.setUser(this._user);const a=null===(t=this.input.attachments)||void 0===t?void 0:t.map((e=>this.sharedModel.setAttachment(e)));(null==a?void 0:a.length)&&(s.attachments=a),this.input.clearAttachments();const n=this._buildMentionList(this.input.mentions,e.body);n.length&&(s.mentions=n),this.input.clearMentions(),this.sharedModel.addMessage(s)}clearMessages(){}updateMessage(e,t){var s;const a=this.sharedModel.getMessageIndex(e);let n=this.sharedModel.getMessage(a);if(n)n.body=t.body,n.edited=!0;else{const s=t.sender.username;n={type:"msg",id:e||r.UUID.uuid4(),body:t.body,time:t.time||Date.now()/1e3,sender:s,edited:!0}}const i=null===(s=t.attachments)||void 0===s?void 0:s.map((e=>this.sharedModel.setAttachment(e)));(null==i?void 0:i.length)?n.attachments=i:delete n.attachments;const h=this._buildMentionList(t.mentions,t.body);h.length?n.mentions=h:delete n.mentions,this.sharedModel.updateMessage(a,n)}deleteMessage(e){const t=this.sharedModel.getMessageIndex(e),s=this.sharedModel.getMessage(t);s?(s.body="",s.deleted=!0,this.sharedModel.updateMessage(t,s)):console.error("The message to delete does not exist")}_buildMentionList(e,t){if(!e)return[];const s=[];return e.forEach((e=>{if(!e.mention_name)return;const a="@"+e.mention_name;new RegExp(a).exec(t)&&(this.sharedModel.getUser(e.username)!==e&&this.sharedModel.setUser(e),s.push(e.username))})),s}_resetWritingStatus(){const e=this.sharedModel.awareness,t=e.getLocalState();null==t||delete t.isWriting,e.setLocalState(t),this._timeoutWriting=null}}class l extends a.AbstractChatContext{get users(){const e=this._model,t={};for(const s of Object.values(e.sharedModel.users))t[s.username]=new d(s);return e.sharedModel.awareness.getStates().forEach((e=>{if(!("user"in e))return;const s=e.user;if((null==s?void 0:s.username)in t)return;const a=new d(e.user);t[a.username]=a})),Array.from(Object.values(t))}}const u="jp-lab-chat-title-unread";class g extends n.DocumentWidget{constructor(e){super(e),this._unreadChanged=(e,t)=>{t.length?this.title.className.includes(u)||(this.title.className+=` ${u}`):this.title.className=this.title.className.replace(u,"")},this.addClass("jp-lab-chat-main-panel"),this.model.name=this.context.localPath,this.model.unreadChanged.connect(this._unreadChanged)}dispose(){this.model.unreadChanged.disconnect(this._unreadChanged),this.context.dispose(),this.content.dispose(),super.dispose()}get model(){return this.context.model}}class m{constructor(e){this._configChanged=new i.Signal(this),this._config=e}get config(){return this._config}set config(e){this._config={...this._config,...e},this._configChanged.emit(e)}get configChanged(){return this._configChanged}}class _ extends n.ABCWidgetFactory{constructor(e){super(e),this._themeManager=e.themeManager,this._rmRegistry=e.rmRegistry,this._chatCommandRegistry=e.chatCommandRegistry,this._attachmentOpenerRegistry=e.attachmentOpenerRegistry,this._inputToolbarFactory=e.inputToolbarFactory,this._messageFooterRegistry=e.messageFooterRegistry,this._welcomeMessage=e.welcomeMessage}createNewWidget(e){return e.rmRegistry=this._rmRegistry,e.themeManager=this._themeManager,e.chatCommandRegistry=this._chatCommandRegistry,e.attachmentOpenerRegistry=this._attachmentOpenerRegistry,e.messageFooterRegistry=this._messageFooterRegistry,e.welcomeMessage=this._welcomeMessage,this._inputToolbarFactory&&(e.inputToolbarRegistry=this._inputToolbarFactory.create()),new g({context:e,content:new a.ChatWidget(e)})}get contentProviderId(){return"rtc"}set contentProviderId(e){}}class p{constructor(e){var t,s,a;this.collaborative=!0,this._disposed=!1,this._user=e.user,this._widgetConfig=e.widgetConfig,this._commands=e.commands,this._activeCellManager=null!==(t=e.activeCellManager)&&void 0!==t?t:null,this._selectionWatcher=null!==(s=e.selectionWatcher)&&void 0!==s?s:null,this._documentManager=null!==(a=e.documentManager)&&void 0!==a?a:null}get name(){return"chat"}get contentType(){return"chat"}get fileFormat(){return"text"}get isDisposed(){return this._disposed}dispose(){this._disposed=!0}preferredLanguage(e){return""}createNew(e){return new c({...e,user:this._user,widgetConfig:this._widgetConfig,commands:this._commands,activeCellManager:this._activeCellManager,selectionWatcher:this._selectionWatcher,documentManager:this._documentManager})}}const y={name:"chat",displayName:"Chat",mimeTypes:["text/json","application/json"],extensions:[".chat"],fileFormat:"text",contentType:"chat",icon:a.chatIcon},f=new r.Token("jupyterlab-chat:IChatFactory"),C={createChat:"jupyterlab-chat:create",openChat:"jupyterlab-chat:open",createAndOpen:"jupyterlab-chat:createAndOpen",moveToSide:"jupyterlab-chat:moveToSide",markAsRead:"jupyterlab-chat:markAsRead",focusInput:"jupyterlab-chat:focusInput",renameChat:"jupyterlab-chat:renameChat"},M=new r.Token("jupyterlab-chat:IChatPanel"),v=new r.Token("jupyterlab-chat:IActiveCellManager"),b=new r.Token("jupyterlab-chat:ISelectionWatcher"),w=new r.Token("jupyterlab-chat:IWelcomeMessage");var O=s(6469);function S(e,t){const s=!t||!O.PathExt.relative(t,e).startsWith(".."),a=new RegExp(`${y.extensions[0]}$`,"g");return(s?t?O.PathExt.relative(t,e):e:"/"+e).replace(a,"")}}}]);