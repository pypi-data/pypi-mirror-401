"""Project structure setup handler.

This module serves as the entry point for the modularized project structure setup functionality.
主要功能委托给专门的模块以获得更好的组织结构。
"""

from ..config_manager import ConfigManager
from ..log_manager import performance_monitor
from .config_generator import ConfigGenerator
from .directory_creator import DirectoryCreator
from .readme_handler import ReadmeHandler
from .rust_files_handler import RustFilesHandler
from .sop_generator import SopGenerator
from .template_manager import TemplateManager


class ProjectStructureSetup:
    """Project structure setup handler - now a coordinator for specialized modules."""

    def __init__(self) -> None:
        self.config_manager = ConfigManager()
        self.directory_creator = DirectoryCreator()
        self.readme_handler = ReadmeHandler()
        self.config_generator = ConfigGenerator()
        self.sop_generator = SopGenerator()
        self.template_manager = TemplateManager()
        self.rust_files_handler = RustFilesHandler()

    @performance_monitor
    def setup(
        self, project_name: str, use_workspace: bool = True, copy_pyproject: bool = True
    ) -> None:
        """Setup project structure by coordinating specialized modules.

        Args:
            project_name: Name of the project
            use_workspace: If True, use pyproject.toml with workspace config.
                          If False, use pyproject.toml without workspace config.
            copy_pyproject: If True, copy pyproject.toml from template.
                           If False, skip pyproject.toml (will be generated by PyProjectGenerator).
        """
        # Create main project structure
        self.directory_creator.create_structure(project_name)

        # Copy project template files including .coveragerc
        self.template_manager.copy_template_files(
            use_workspace=use_workspace, copy_pyproject=copy_pyproject
        )

        # Create README.md if it doesn't exist or is empty
        from pathlib import Path

        readme_file = Path("README.md")
        should_create_readme = (
            not readme_file.exists()
            or readme_file.read_text(encoding="utf-8").strip() == ""
        )
        if should_create_readme:
            self.readme_handler.create_readme(project_name)

        # Generate SOP files for Rust-Python integration
        self.sop_generator.generate_sop_files(project_name)

        # Copy Rust example files
        self.rust_files_handler.copy_rust_files(project_name)

        # Generate configuration files in .wl directory
        self.config_generator.generate_configs()

        from .....utils.logging import log_info

        log_info("✓ Project structure created successfully")
        log_info("✓ 项目结构创建成功", lang="zh")
