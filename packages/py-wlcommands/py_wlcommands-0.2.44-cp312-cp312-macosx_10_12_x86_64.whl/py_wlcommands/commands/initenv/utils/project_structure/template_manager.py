"""Project template manager."""

import shutil
from pathlib import Path

from .....utils.logging import log_info
from ..config_manager import ConfigManager


class TemplateManager:
    """Copy project template files."""

    def __init__(self):
        self.config_manager = ConfigManager()

    def copy_template_files(
        self, use_workspace: bool = True, copy_pyproject: bool = True
    ) -> None:
        """Copy project template files including .coveragerc.

        Args:
            use_workspace: If True, use pyproject.toml with workspace config.
                          If False, use pyproject.toml without workspace config.
            copy_pyproject: If True, copy pyproject.toml from template.
                           If False, skip pyproject.toml (will be generated by PyProjectGenerator).
        """
        try:
            # Get the vendor project template directory
            vendor_project_dir = self.config_manager.get_vendor_config_path("project")
            vendor_git_dir = self.config_manager.get_vendor_config_path("git")

            template_files = [
                ".coveragerc",
                ".python-version",
            ]

            for file_name in template_files:
                src_file = vendor_project_dir / file_name
                dest_file = Path(file_name)

                # Only copy if the file doesn't exist to avoid overwriting existing files
                if src_file.exists() and not dest_file.exists():
                    shutil.copy2(src_file, dest_file)
                    log_info(f"✓ Copied {file_name} from template")
                    log_info(f"✓ 从模板复制 {file_name}", lang="zh")

            # Copy .gitignore from git vendor directory
            gitignore_src = vendor_git_dir / ".gitignore"
            gitignore_dest = Path(".gitignore")
            if gitignore_src.exists() and not gitignore_dest.exists():
                shutil.copy2(gitignore_src, gitignore_dest)
                log_info("✓ Copied .gitignore from template")
                log_info("✓ 从模板复制 .gitignore", lang="zh")

            # Handle pyproject.toml separately based on use_workspace flag and copy_pyproject flag
            if copy_pyproject and not Path("pyproject.toml").exists():
                if use_workspace:
                    pyproject_template = vendor_project_dir / "pyproject.toml"
                else:
                    pyproject_template = (
                        vendor_project_dir / "pyproject_no_workspace.toml"
                    )

                if pyproject_template.exists():
                    shutil.copy2(pyproject_template, Path("pyproject.toml"))
                    log_info("✓ Copied pyproject.toml from template")
                    log_info("✓ 从模板复制 pyproject.toml", lang="zh")
                else:
                    log_info(
                        f"Warning: pyproject.toml template not found: {pyproject_template}"
                    )
                    log_info(
                        f"警告: 未找到 pyproject.toml 模板: {pyproject_template}",
                        lang="zh",
                    )

        except Exception as e:
            log_info(f"Warning: Failed to copy project template files: {e}")
            log_info(f"警告: 复制项目模板文件失败: {e}", lang="zh")
