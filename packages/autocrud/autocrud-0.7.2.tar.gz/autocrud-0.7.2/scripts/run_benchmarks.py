import sys
import shutil
import re
from pathlib import Path

# Add examples to path to allow importing benchmark scripts
project_root = Path(__file__).resolve().parents[1]
sys.path.append(str(project_root))
sys.path.append(str(project_root / "examples"))


def run_benchmarks():
    """Run both benchmarks."""
    # We import here so that sys.path modification takes effect
    try:
        import benchmark_resource_store_perf
        import benchmark_metastore_perf
    except ImportError as e:
        print(f"Error importing benchmark scripts: {e}")
        sys.exit(1)

    print("--- Cleaning up old benchmark data ---")
    # Clean up old data files to ensure fresh run
    # for f in ["benchmark_data.json", "benchmark_resource_store_data.json"]:
    #     p = Path(f)
    #     if p.exists():
    #         print(f"Removing {p}")
    #         p.unlink()

    print("\n--- Running Resource Store Benchmark ---")
    benchmark_resource_store_perf.run_benchmark()

    print("\n--- Running Metastore Benchmark ---")
    benchmark_metastore_perf.run_benchmark()


def update_docs():
    """Collect results and update auto_routes.md."""
    # Source files generated by scripts (in CWD which is project root)
    res_md = Path("benchmark_resource_store_results.md")
    res_img = Path("benchmark_resource_store_chart.png")

    meta_md = Path("benchmark_results.md")
    meta_img = Path("benchmark_heatmap_combined.png")

    # Destination for images
    # Using 'images' folder instead of '_static' to ensure Sphinx picks them up correctly
    # and processes them as content images.
    images_dir = project_root / "docs" / "source" / "images" / "benchmark"
    images_dir.mkdir(parents=True, exist_ok=True)

    # Destination for standalone MD files
    benchmarks_dir = project_root / "docs" / "source" / "benchmarks"
    benchmarks_dir.mkdir(parents=True, exist_ok=True)

    # Destination for main doc
    doc_file = project_root / "docs" / "source" / "auto_routes.md"

    generated_docs = []

    # 1. Process Resource Store Results
    if res_md.exists():
        text = res_md.read_text()

        # Move image
        if res_img.exists():
            shutil.move(str(res_img), str(images_dir / res_img.name))
            # Update Link: ./filename.png -> /images/benchmark/filename.png
            # The MD file will live in docs/source/benchmarks/
            # Image is in docs/source/images/benchmark/
            # We use absolute path from source root (/) so it works both when included in auto_routes.md (root)
            # and when viewed standalone in benchmarks/subdir.
            text = text.replace(
                f"./{res_img.name}", f"/images/benchmark/{res_img.name}"
            )

        # Header Adjustments for "Resource Store"
        # Original: # Resource Store Benchmark Results -> #### Resource Store
        text = re.sub(
            r"^# Resource Store Benchmark Results",
            "#### Resource Store",
            text,
            flags=re.MULTILINE,
        )
        text = re.sub(r"^### ", "##### ", text, flags=re.MULTILINE)

        target_md = benchmarks_dir / "resource_store.md"
        target_md.write_text(text)
        generated_docs.append("resource_store.md")

        # Cleanup source MD
        res_md.unlink()

    # 2. Process Metastore Results
    if meta_md.exists():
        text = meta_md.read_text()

        # Move image
        if meta_img.exists():
            shutil.move(str(meta_img), str(images_dir / meta_img.name))
            text = text.replace(
                f"./{meta_img.name}", f"/images/benchmark/{meta_img.name}"
            )

        # Header Adjustments for "Meta Store"
        # Original: # MetaStore Benchmark Results -> #### Meta Store
        text = re.sub(
            r"^# MetaStore Benchmark Results",
            "#### Meta Store",
            text,
            flags=re.MULTILINE,
        )
        text = re.sub(r"^### ", "##### ", text, flags=re.MULTILINE)

        target_md = benchmarks_dir / "metastore.md"
        target_md.write_text(text)
        generated_docs.append("metastore.md")

        # Cleanup source MD
        meta_md.unlink()

    if not generated_docs:
        print("No benchmark results found to update.")
        return

    # Create content to insert: Includes
    include_content = []
    for doc in generated_docs:
        # Use MyST include directive relative to doc source root (docs/source)
        # Assuming auto_routes.md is in docs/source, the path provided to include
        # is usually relative to the file containing the include or project root.
        # MyST typically resolves paths relative to the file.
        include_content.append(f"\n```{{include}} benchmarks/{doc}\n```\n")

    # Update auto_routes.md
    original_content = doc_file.read_text()

    # Markers
    start_marker = "### ðŸ“Š Performance Benchmark"
    end_marker = "## ðŸ”’ é€²éšŽåŠŸèƒ½"

    if start_marker not in original_content:
        print(f"Warning: Start marker '{start_marker}' not found. Appending to end.")
        final_content = (
            original_content + f"\n\n{start_marker}\n\n" + "".join(include_content)
        )
    else:
        # Replace existing section
        parts = original_content.split(start_marker)
        pre_section = parts[0]

        remaining = parts[1]
        if end_marker in remaining:
            post_section_parts = remaining.split(end_marker, 1)
            post_section = post_section_parts[1]

            final_content = (
                pre_section
                + start_marker
                + "\n"
                + "".join(include_content)
                + "\n\n"
                + end_marker
                + post_section
            )
        else:
            # Try next H2
            match = re.search(r"\n## ", remaining)
            if match:
                end_idx = match.start()
                final_content = (
                    pre_section
                    + start_marker
                    + "\n"
                    + "".join(include_content)
                    + remaining[end_idx:]
                )
            else:
                final_content = (
                    pre_section + start_marker + "\n" + "".join(include_content)
                )

    doc_file.write_text(final_content)
    print(f"Updated {doc_file} with includes to: {generated_docs}")


if __name__ == "__main__":
    run_benchmarks()
    update_docs()
