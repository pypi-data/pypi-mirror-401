name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write  # allow badge workflow to update artifacts when needed
  pull-requests: write  # required for reusable workflow PR creation
  actions: read
  checks: write

jobs:
  tests:
    name: Tests (py${{ matrix.python }} - ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        python: ["3.10", "3.11", "3.12", "3.13", "3.14"]
        os: [ubuntu-latest, windows-latest, macos-latest]
    env:
      # Generate & upload coverage only for latest stable Python on Linux to reduce minutes
      COVERAGE: ${{ matrix.python == '3.14' && matrix.os == 'ubuntu-latest' }}
      PYTHONDONTWRITEBYTECODE: 1
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Install uv
        run: pip install uv

      - name: Cache uv build artifacts
        uses: actions/cache@v4
        with:
          path: ~/.cache/uv
          key: uv-${{ runner.os }}-${{ matrix.python }}-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            uv-${{ runner.os }}-

      - name: Install project (editable, with dev extras) using uv
        run: uv pip install --system -e .[dev]

      - name: Show environment
        run: |
          python -V
          uv pip list

      - name: Run tests (with coverage if selected)
        shell: bash  # Ensures bash on all OSes
        env:
          PYTEST_ADDOPTS: "-p no:cacheprovider"
        run: |
          if [ "$COVERAGE" = "true" ]; then
            echo "Running tests WITH coverage"
            pytest
          else
            echo "Running tests WITHOUT coverage"
            pytest -q --no-cov
          fi

      - name: Upload coverage artifacts
        if: env.COVERAGE == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: |
            coverage.xml
            htmlcov/
          if-no-files-found: error
          retention-days: 3

  badges:
    name: Update badges
    needs: tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write  # allow reusable workflow to update badge artifacts
      pull-requests: write  # required for creating & auto-merging PRs in badges workflow
    uses: ./.github/workflows/badges.yml
    with:
      python-version: '3.13'
    secrets: inherit

  lint:
    name: Ruff lint
    runs-on: ubuntu-latest
    permissions:
      contents: read  # lint job does not push
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - name: Install uv
        run: pip install uv
      - name: Install ruff
        run: uv pip install --system ruff
      - name: Run ruff checks
        run: ruff check .
