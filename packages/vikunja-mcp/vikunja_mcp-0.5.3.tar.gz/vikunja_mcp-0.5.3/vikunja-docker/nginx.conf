worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    keepalive_timeout 65;
    client_max_body_size 20M;

    # Gzip
    gzip on;
    gzip_types text/plain text/css application/json application/javascript;

    # Map to validate token_validated cookie presence
    # Used by OIDC callback to require token-gated registration
    # Cookie is set by factumerit-bot /auth-register endpoint
    map $cookie_token_validated $token_valid {
        ""      0;
        default 1;
    }

    # Map to detect OIDC callback (has 'code' in query string)
    # Vikunja uses same URL for start (/auth/openid/google) and callback
    # Callback has ?code=X&state=Y from OAuth provider
    map $args $is_oidc_callback {
        "~*code=" 1;
        default   0;
    }

    server {
        listen 80;
        server_name _;

        # Auth bridge connect page
        # Serves /slack-connect and /slack-connect/
        location = /slack-connect {
            rewrite ^ /slack-connect/ permanent;
        }
        location /slack-connect/ {
            alias /usr/share/nginx/html/slack-connect/;
            try_files $uri $uri/ /slack-connect/index.html;
        }

        # Matrix bot connect page
        # Serves /matrix-connect and /matrix-connect/
        location = /matrix-connect {
            rewrite ^ /matrix-connect/ permanent;
        }
        location /matrix-connect/ {
            alias /usr/share/nginx/html/matrix-connect/;
            try_files $uri $uri/ /matrix-connect/index.html;
        }

        # Block OIDC callback without token_validated cookie
        # Requires user to go through /beta-signup first (token-gated)
        # Vikunja uses /auth/openid/{provider} for both start and callback
        # Callback is detected by presence of 'code' query parameter
        # Bead: solutions-l0u9.10
        location ~ ^/auth/openid/[^/]+$ {
            # Only gate callbacks (has code param), not initial redirects
            # This allows existing users to log in while blocking new registrations
            set $block_request 0;
            if ($is_oidc_callback = 1) {
                set $block_request $token_valid;
            }
            # Invert: block_request=0 when callback without cookie
            if ($is_oidc_callback = 1) {
                set $block_request "callback";
            }
            if ($token_valid = 0) {
                set $block_request "${block_request}_nocookie";
            }
            if ($block_request = "callback_nocookie") {
                return 403 '{"code":403,"message":"Registration is invite-only. Visit factumerit.app/beta-signup first"}';
            }

            # Either not a callback, or callback with valid cookie - proxy to Vikunja
            proxy_pass http://127.0.0.1:3456;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Block direct registration - only allow via factumerit-bot with admin token
        # Defense in depth: registration tokens validated by bot, this is Layer 2
        location = /api/v1/register {
            # Check for admin token header
            if ($http_x_admin_token != "${NGINX_ADMIN_TOKEN}") {
                return 403 '{"code":403,"message":"Registration is invite-only. Get a code at factumerit.app"}';
            }

            # Valid token - proxy to Vikunja
            proxy_pass http://127.0.0.1:3456;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Proxy everything else to Vikunja
        location / {
            proxy_pass http://127.0.0.1:3456;
            proxy_http_version 1.1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket support (for live updates)
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }
    }
}
